<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# OPTIONS_GHC -cpp -Wno-incomplete-record-updates #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# OPTIONS_GHC -fmax-worker-args=12 #-}</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- The -fmax-worker-args=12 is there because the main functions</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- are strict in the OccEnv, and it turned out that with the default settting</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- some functions would unbox the OccEnv ad some would not, depending on how</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- many /other/ arguments the function has.  Inconsistent unboxing is very</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- bad for performance, so I increased the limit to allow it to unbox</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- consistently.</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

************************************************************************
*                                                                      *
\section[OccurAnal]{Occurrence analysis pass}
*                                                                      *
************************************************************************

The occurrence analyser re-typechecks a core expression, returning a new
core expression with (hopefully) improved usage information.
-}</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html"><span class="hs-identifier">GHC.Core.Opt.OccurAnal</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalysePgm"><span class="hs-identifier">occurAnalysePgm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier">occurAnalyseExpr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#zapLambdaBndrs"><span class="hs-identifier">zapLambdaBndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier">BinderSwapDecision</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier">scrutOkForBinderSwap</span></a></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Prelude.Basic.html#head"><span class="hs-identifier">head</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">init</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">last</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Prelude.Basic.html#tail"><span class="hs-identifier">tail</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier">exprIsTrivial</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#isDefaultAlt"><span class="hs-identifier">isDefaultAlt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#isExpandableApp"><span class="hs-identifier">isExpandableApp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>                          </span><span class="annot"><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-identifier">mkCastMCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier">mkTicks</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier">joinRhsArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#isOneShotBndr"><span class="hs-identifier">isOneShotBndr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#isDictId"><span class="hs-identifier">isDictId</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html"><span class="hs-identifier">GHC.Core.TyCo.FVs</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfMCo"><span class="hs-identifier">tyCoVarsOfMCo</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html#orElse"><span class="hs-identifier">orElse</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html"><span class="hs-identifier">GHC.Data.Graph.Directed</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#SCC"><span class="hs-identifier">SCC</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html#Node"><span class="hs-identifier">Node</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html#stronglyConnCompFromEdgedVerticesUniq"><span class="hs-identifier">stronglyConnCompFromEdgedVerticesUniq</span></a></span><span>
</span><span id="line-47"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html#stronglyConnCompFromEdgedVerticesUniqR"><span class="hs-identifier">stronglyConnCompFromEdgedVerticesUniqR</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html"><span class="hs-identifier">GHC.Types.Unique.FM</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Set.html"><span class="hs-identifier">GHC.Types.Unique.Set</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#argOneShots"><span class="hs-identifier">argOneShots</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#argsOneShots"><span class="hs-identifier">argsOneShots</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#isDeadEndSig"><span class="hs-identifier">isDeadEndSig</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#runRWKey"><span class="hs-identifier">runRWKey</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier">Module</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mapAccumL</span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
    occurAnalysePgm, occurAnalyseExpr
*                                                                      *
************************************************************************

Here's the externally-callable interface:
-}</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="annot"><span class="hs-comment">-- | Do occurrence analysis, and discard occurrence info returned</span></span><span>
</span><span id="line-80"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-type">occurAnalyseExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-81"></span><span id="occurAnalyseExpr"><span class="annot"><span class="annottext">occurAnalyseExpr :: CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var hs-var">occurAnalyseExpr</span></a></span></span><span> </span><span id="local-6989586621682710856"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710856"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710857"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682710857"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710857"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#initOccEnv"><span class="hs-identifier hs-var">initOccEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710856"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalysePgm"><span class="hs-identifier hs-type">occurAnalysePgm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span>         </span><span class="hs-comment">-- Used only in debug output</span><span>
</span><span id="line-86"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Active unfoldings</span><span>
</span><span id="line-87"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Active rules</span><span>
</span><span id="line-88"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Local rules for imported Ids</span><span>
</span><span id="line-89"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>
</span><span id="line-90"></span><span id="occurAnalysePgm"><span class="annot"><span class="annottext">occurAnalysePgm :: Module
-&gt; (Id -&gt; Bool)
-&gt; (Activation -&gt; Bool)
-&gt; [CoreRule]
-&gt; CoreProgram
-&gt; CoreProgram
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalysePgm"><span class="hs-identifier hs-var hs-var">occurAnalysePgm</span></a></span></span><span> </span><span id="local-6989586621682710861"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682710861"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span id="local-6989586621682710862"><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621682710862"><span class="hs-identifier hs-var">active_unf</span></a></span></span><span> </span><span id="local-6989586621682710863"><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682710863"><span class="hs-identifier hs-var">active_rule</span></a></span></span><span> </span><span id="local-6989586621682710864"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682710864"><span class="hs-identifier hs-var">imp_rules</span></a></span></span><span> </span><span id="local-6989586621682710865"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710865"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isEmptyDetails"><span class="hs-identifier hs-var">isEmptyDetails</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710867"><span class="hs-identifier hs-var">final_usage</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710868"><span class="hs-identifier hs-var">occ_anald_binds</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-comment">-- See Note [Glomming]</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; CoreProgram -&gt; CoreProgram
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Glomming in&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; JoinArity -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682710861"><span class="hs-identifier hs-var">this_mod</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710867"><span class="hs-identifier hs-var">final_usage</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710874"><span class="hs-identifier hs-var">occ_anald_glommed_binds</span></a></span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-98"></span><span>    </span><span id="local-6989586621682710875"><span class="annot"><span class="annottext">init_env :: OccEnv
</span><a href="#local-6989586621682710875"><span class="hs-identifier hs-var hs-var">init_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#initOccEnv"><span class="hs-identifier hs-var">initOccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_rule_act"><span class="hs-identifier hs-var">occ_rule_act</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682710863"><span class="hs-identifier hs-type">active_rule</span></a></span><span>
</span><span id="line-99"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_unf_act"><span class="hs-identifier hs-var">occ_unf_act</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682710862"><span class="hs-identifier hs-type">active_unf</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682710867"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710867"><span class="hs-identifier hs-var">final_usage</span></a></span></span><span> </span><span id="local-6989586621682710868"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710868"><span class="hs-identifier hs-var">occ_anald_binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; OccEnv -&gt; WithUsageDetails CoreProgram
</span><a href="#local-6989586621682710878"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710865"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710875"><span class="hs-identifier hs-var">init_env</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682710874"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710874"><span class="hs-identifier hs-var">occ_anald_glommed_binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; [(Id, CoreExpr)]
-&gt; UsageDetails
-&gt; WithUsageDetails CoreProgram
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalRecBind"><span class="hs-identifier hs-var">occAnalRecBind</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710875"><span class="hs-identifier hs-var">init_env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span>
</span><span id="line-103"></span><span>                                                    </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710881"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span><span>
</span><span id="line-104"></span><span>                                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; [(Id, CoreExpr)]
forall b. [Bind b] -&gt; [(b, Expr b)]
</span><a href="GHC.Core.html#flattenBinds"><span class="hs-identifier hs-var">flattenBinds</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710865"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>                                                    </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710883"><span class="hs-identifier hs-var">initial_uds</span></a></span><span>
</span><span id="line-106"></span><span>          </span><span class="hs-comment">-- It's crucial to re-analyse the glommed-together bindings</span><span>
</span><span id="line-107"></span><span>          </span><span class="hs-comment">-- so that we establish the right loop breakers. Otherwise</span><span>
</span><span id="line-108"></span><span>          </span><span class="hs-comment">-- we can easily create an infinite loop (#9583 is an example)</span><span>
</span><span id="line-109"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-110"></span><span>          </span><span class="hs-comment">-- Also crucial to re-analyse the /original/ bindings</span><span>
</span><span id="line-111"></span><span>          </span><span class="hs-comment">-- in case the first pass accidentally discarded as dead code</span><span>
</span><span id="line-112"></span><span>          </span><span class="hs-comment">-- a binding that was actually needed (albeit before its</span><span>
</span><span id="line-113"></span><span>          </span><span class="hs-comment">-- definition site).  #17724 threw this up.</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>    </span><span id="local-6989586621682710883"><span class="annot"><span class="annottext">initial_uds :: UsageDetails
</span><a href="#local-6989586621682710883"><span class="hs-identifier hs-var hs-var">initial_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; VarSet -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var">addManyOccs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreRule] -&gt; VarSet
</span><a href="GHC.Core.FVs.html#rulesFreeVars"><span class="hs-identifier hs-var">rulesFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682710864"><span class="hs-identifier hs-var">imp_rules</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-comment">-- The RULES declarations keep things alive!</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-comment">-- imp_rule_edges maps a top-level local binder 'f' to the</span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-comment">-- RHS free vars of any IMP-RULE, a local RULE for an imported function,</span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-comment">-- where 'f' appears on the LHS</span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-comment">--   e.g.  RULE foldr f = blah</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-comment">--         imp_rule_edges contains f :-&gt; fvs(blah)</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- We treat such RULES as extra rules for 'f'</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-comment">-- See Note [Preventing loops due to imported functions rules]</span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><a href="#local-6989586621682710881"><span class="hs-identifier hs-type">imp_rule_edges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621682710881"><span class="annot"><span class="annottext">imp_rule_edges :: ImpRuleEdges
</span><a href="#local-6989586621682710881"><span class="hs-identifier hs-var hs-var">imp_rule_edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ImpRuleEdges -&gt; ImpRuleEdges -&gt; ImpRuleEdges)
-&gt; ImpRuleEdges -&gt; [ImpRuleEdges] -&gt; ImpRuleEdges
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([(Activation, VarSet)]
 -&gt; [(Activation, VarSet)] -&gt; [(Activation, VarSet)])
-&gt; ImpRuleEdges -&gt; ImpRuleEdges -&gt; ImpRuleEdges
forall a. (a -&gt; a -&gt; a) -&gt; VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv_C"><span class="hs-identifier hs-var">plusVarEnv_C</span></a></span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)]
-&gt; [(Activation, VarSet)] -&gt; [(Activation, VarSet)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-127"></span><span>                           </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; [(Activation, VarSet)]) -&gt; VarEnv Id -&gt; ImpRuleEdges
forall a b. (a -&gt; b) -&gt; VarEnv a -&gt; VarEnv b
</span><a href="GHC.Types.Var.Env.html#mapVarEnv"><span class="hs-identifier hs-var">mapVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Activation, VarSet)] -&gt; Id -&gt; [(Activation, VarSet)]
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682710892"><span class="hs-identifier hs-var">act</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710893"><span class="hs-identifier hs-var">rhs_fvs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VarEnv Id -&gt; ImpRuleEdges) -&gt; VarEnv Id -&gt; ImpRuleEdges
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarEnv Id
forall a. UniqSet a -&gt; UniqFM a a
</span><a href="GHC.Types.Unique.Set.html#getUniqSet"><span class="hs-identifier hs-var">getUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarEnv Id) -&gt; VarSet -&gt; VarEnv Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-128"></span><span>                             </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprsFreeIds"><span class="hs-identifier hs-var">exprsFreeIds</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682710896"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#delVarSetList"><span class="hs-operator hs-var">`delVarSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682710898"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-129"></span><span>                           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_act :: CoreRule -&gt; Activation
</span><a href="GHC.Core.html#ru_act"><span class="hs-identifier hs-var">ru_act</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682710892"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682710892"><span class="hs-identifier hs-var">act</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [Id]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682710898"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682710898"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>
</span><span id="line-130"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682710896"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682710896"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rhs :: CoreRule -&gt; CoreExpr
</span><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682710904"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710904"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682710864"><span class="hs-identifier hs-var">imp_rules</span></a></span><span>
</span><span id="line-131"></span><span>                                   </span><span class="hs-comment">-- Not BuiltinRules; see Note [Plugin rules]</span><span>
</span><span id="line-132"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682710893"><span class="annot"><span class="annottext">rhs_fvs :: VarSet
</span><a href="#local-6989586621682710893"><span class="hs-identifier hs-var hs-var">rhs_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeIds"><span class="hs-identifier hs-var">exprFreeIds</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710904"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#delVarSetList"><span class="hs-operator hs-var">`delVarSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682710898"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><a href="#local-6989586621682710878"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-135"></span><span>    </span><span id="local-6989586621682710878"><span class="annot"><span class="annottext">go :: CoreProgram -&gt; OccEnv -&gt; WithUsageDetails CoreProgram
</span><a href="#local-6989586621682710878"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="annot"><span class="annottext">OccEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreProgram -&gt; WithUsageDetails CoreProgram
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710883"><span class="hs-identifier hs-var">initial_uds</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><a href="#local-6989586621682710878"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682710906"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682710906"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682710907"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710907"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682710908"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710908"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; CoreBind
-&gt; (OccEnv -&gt; WithUsageDetails CoreProgram)
-&gt; (CoreProgram -&gt; CoreProgram -&gt; CoreProgram)
-&gt; WithUsageDetails CoreProgram
forall r.
OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; CoreBind
-&gt; (OccEnv -&gt; WithUsageDetails r)
-&gt; (CoreProgram -&gt; r -&gt; r)
-&gt; WithUsageDetails r
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalBind"><span class="hs-identifier hs-var">occAnalBind</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710908"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span>
</span><span id="line-137"></span><span>                           </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710881"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682710906"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; OccEnv -&gt; WithUsageDetails CoreProgram
</span><a href="#local-6989586621682710878"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710907"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; CoreProgram -&gt; CoreProgram
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                IMP-RULES
         Local rules for imported functions
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-keyword">type</span><span> </span><span id="ImpRuleEdges"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-var">ImpRuleEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-comment">-- Mapping from a local Id 'f' to info about its IMP-RULES,</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-comment">-- i.e. /local/ rules for an imported Id that mention 'f' on the LHS</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-comment">-- We record (a) its Activation and (b) the RHS free vars</span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-comment">-- See Note [IMP-RULES: local rules for imported functions]</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#noImpRuleEdges"><span class="hs-identifier hs-type">noImpRuleEdges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a></span><span>
</span><span id="line-153"></span><span id="noImpRuleEdges"><span class="annot"><span class="annottext">noImpRuleEdges :: ImpRuleEdges
</span><a href="GHC.Core.Opt.OccurAnal.html#noImpRuleEdges"><span class="hs-identifier hs-var hs-var">noImpRuleEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#lookupImpRules"><span class="hs-identifier hs-type">lookupImpRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-156"></span><span id="lookupImpRules"><span class="annot"><span class="annottext">lookupImpRules :: ImpRuleEdges -&gt; Id -&gt; [(Activation, VarSet)]
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupImpRules"><span class="hs-identifier hs-var hs-var">lookupImpRules</span></a></span></span><span> </span><span id="local-6989586621682710912"><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710912"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span></span><span> </span><span id="local-6989586621682710913"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710913"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges -&gt; Id -&gt; Maybe [(Activation, VarSet)]
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710912"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710913"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-158"></span><span>      </span><span class="annot"><span class="annottext">Maybe [(Activation, VarSet)]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-159"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682710915"><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682710915"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682710915"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#impRulesScopeUsage"><span class="hs-identifier hs-type">impRulesScopeUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- Variable mentioned in RHS of an IMP-RULE for the bndr,</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- whether active or not</span><span>
</span><span id="line-164"></span><span id="impRulesScopeUsage"><span class="annot"><span class="annottext">impRulesScopeUsage :: [(Activation, VarSet)] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#impRulesScopeUsage"><span class="hs-identifier hs-var hs-var">impRulesScopeUsage</span></a></span></span><span> </span><span id="local-6989586621682710917"><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682710917"><span class="hs-identifier hs-var">imp_rules_info</span></a></span></span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Activation, VarSet) -&gt; UsageDetails -&gt; UsageDetails)
-&gt; UsageDetails -&gt; [(Activation, VarSet)] -&gt; UsageDetails
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">(Activation, VarSet) -&gt; UsageDetails -&gt; UsageDetails
forall {a}. (a, VarSet) -&gt; UsageDetails -&gt; UsageDetails
</span><a href="#local-6989586621682710918"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682710917"><span class="hs-identifier hs-var">imp_rules_info</span></a></span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621682710918"><span class="annot"><span class="annottext">add :: (a, VarSet) -&gt; UsageDetails -&gt; UsageDetails
</span><a href="#local-6989586621682710918"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621682710919"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710919"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682710920"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710920"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; VarSet -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var">addManyOccs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710920"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710919"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#impRulesActiveFvs"><span class="hs-identifier hs-type">impRulesActiveFvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-170"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-171"></span><span id="impRulesActiveFvs"><span class="annot"><span class="annottext">impRulesActiveFvs :: (Activation -&gt; Bool) -&gt; VarSet -&gt; [(Activation, VarSet)] -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#impRulesActiveFvs"><span class="hs-identifier hs-var hs-var">impRulesActiveFvs</span></a></span></span><span> </span><span id="local-6989586621682710922"><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682710922"><span class="hs-identifier hs-var">is_active</span></a></span></span><span> </span><span id="local-6989586621682710923"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710923"><span class="hs-identifier hs-var">bndr_set</span></a></span></span><span> </span><span id="local-6989586621682710924"><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682710924"><span class="hs-identifier hs-var">vs</span></a></span></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Activation, VarSet) -&gt; VarSet -&gt; VarSet)
-&gt; VarSet -&gt; [(Activation, VarSet)] -&gt; VarSet
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">(Activation, VarSet) -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621682710925"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682710924"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#intersectVarSet"><span class="hs-operator hs-var">`intersectVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710923"><span class="hs-identifier hs-var">bndr_set</span></a></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-174"></span><span>    </span><span id="local-6989586621682710925"><span class="annot"><span class="annottext">add :: (Activation, VarSet) -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621682710925"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682710928"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682710928"><span class="hs-identifier hs-var">act</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682710929"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710929"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682710930"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710930"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682710922"><span class="hs-identifier hs-var">is_active</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682710928"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710929"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710930"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-175"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682710930"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="hs-comment">{- Note [IMP-RULES: local rules for imported functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We quite often have
  * A /local/ rule
  * for an /imported/ function
like this:
  foo x = blah
  {-# RULE &quot;map/foo&quot; forall xs. map foo xs = xs #-}
We call them IMP-RULES.  They are important in practice, and occur a
lot in the libraries.

IMP-RULES are held in mg_rules of ModGuts, and passed in to
occurAnalysePgm.

Main Invariant:

* Throughout, we treat an IMP-RULE that mentions 'f' on its LHS
  just like a RULE for f.

Note [IMP-RULES: unavoidable loops]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this
   f = /\a. B.g a
   RULE B.g Int = 1 + f Int
Note that
  * The RULE is for an imported function.
  * f is non-recursive
Now we
can get
   f Int --&gt; B.g Int      Inlining f
         --&gt; 1 + f Int    Firing RULE
and so the simplifier goes into an infinite loop. This
would not happen if the RULE was for a local function,
because we keep track of dependencies through rules.  But
that is pretty much impossible to do for imported Ids.  Suppose
f's definition had been
   f = /\a. C.h a
where (by some long and devious process), C.h eventually inlines to
B.g.  We could only spot such loops by exhaustively following
unfoldings of C.h etc, in case we reach B.g, and hence (via the RULE)
f.

We regard this potential infinite loop as a *programmer* error.
It's up the programmer not to write silly rules like
     RULE f x = f x
and the example above is just a more complicated version.

Note [Specialising imported functions] (referred to from Specialise)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For *automatically-generated* rules, the programmer can't be
responsible for the &quot;programmer error&quot; in Note [IMP-RULES: unavoidable
loops].  In particular, consider specialising a recursive function
defined in another module.  If we specialise a recursive function B.g,
we get
  g_spec = .....(B.g Int).....
  RULE B.g Int = g_spec
Here, g_spec doesn't look recursive, but when the rule fires, it
becomes so.  And if B.g was mutually recursive, the loop might not be
as obvious as it is here.

To avoid this,
 * When specialising a function that is a loop breaker,
   give a NOINLINE pragma to the specialised function

Note [Preventing loops due to imported functions rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:
  import GHC.Base (foldr)

  {-# RULES &quot;filterList&quot; forall p. foldr (filterFB (:) p) [] = filter p #-}
  filter p xs = build (\c n -&gt; foldr (filterFB c p) n xs)
  filterFB c p = ...

  f = filter p xs

Note that filter is not a loop-breaker, so what happens is:
  f =          filter p xs
    = {inline} build (\c n -&gt; foldr (filterFB c p) n xs)
    = {inline} foldr (filterFB (:) p) [] xs
    = {RULE}   filter p xs

We are in an infinite loop.

A more elaborate example (that I actually saw in practice when I went to
mark GHC.List.filter as INLINABLE) is as follows. Say I have this module:
  {-# LANGUAGE RankNTypes #-}
  module GHCList where

  import Prelude hiding (filter)
  import GHC.Base (build)

  {-# INLINABLE filter #-}
  filter :: (a -&gt; Bool) -&gt; [a] -&gt; [a]
  filter p [] = []
  filter p (x:xs) = if p x then x : filter p xs else filter p xs

  {-# NOINLINE [0] filterFB #-}
  filterFB :: (a -&gt; b -&gt; b) -&gt; (a -&gt; Bool) -&gt; a -&gt; b -&gt; b
  filterFB c p x r | p x       = x `c` r
                   | otherwise = r

  {-# RULES
  &quot;filter&quot;     [~1] forall p xs.  filter p xs = build (\c n -&gt; foldr
  (filterFB c p) n xs)
  &quot;filterList&quot; [1]  forall p.     foldr (filterFB (:) p) [] = filter p
   #-}

Then (because RULES are applied inside INLINABLE unfoldings, but inlinings
are not), the unfolding given to &quot;filter&quot; in the interface file will be:
  filter p []     = []
  filter p (x:xs) = if p x then x : build (\c n -&gt; foldr (filterFB c p) n xs)
                           else     build (\c n -&gt; foldr (filterFB c p) n xs

Note that because this unfolding does not mention &quot;filter&quot;, filter is not
marked as a strong loop breaker. Therefore at a use site in another module:
  filter p xs
    = {inline}
      case xs of []     -&gt; []
                 (x:xs) -&gt; if p x then x : build (\c n -&gt; foldr (filterFB c p) n xs)
                                  else     build (\c n -&gt; foldr (filterFB c p) n xs)

  build (\c n -&gt; foldr (filterFB c p) n xs)
    = {inline} foldr (filterFB (:) p) [] xs
    = {RULE}   filter p xs

And we are in an infinite loop again, except that this time the loop is producing an
infinitely large *term* (an unrolling of filter) and so the simplifier finally
dies with &quot;ticks exhausted&quot;

SOLUTION: we treat the rule &quot;filterList&quot; as an extra rule for 'filterFB'
because it mentions 'filterFB' on the LHS.  This is the Main Invariant
in Note [IMP-RULES: local rules for imported functions].

So, during loop-breaker analysis:

- for each active RULE for a local function 'f' we add an edge between
  'f' and the local FVs of the rule RHS

- for each active RULE for an *imported* function we add dependency
  edges between the *local* FVS of the rule LHS and the *local* FVS of
  the rule RHS.

Even with this extra hack we aren't always going to get things
right. For example, it might be that the rule LHS mentions an imported
Id, and another module has a RULE that can rewrite that imported Id to
one of our local Ids.

Note [Plugin rules]
~~~~~~~~~~~~~~~~~~~
Conal Elliott (#11651) built a GHC plugin that added some
BuiltinRules (for imported Ids) to the mg_rules field of ModGuts, to
do some domain-specific transformations that could not be expressed
with an ordinary pattern-matching CoreRule.  But then we can't extract
the dependencies (in imp_rule_edges) from ru_rhs etc, because a
BuiltinRule doesn't have any of that stuff.

So we simply assume that BuiltinRules have no dependencies, and filter
them out from the imp_rule_edges comprehension.

Note [Glomming]
~~~~~~~~~~~~~~~
RULES for imported Ids can make something at the top refer to
something at the bottom:

        foo = ...(B.f @Int)...
        $sf = blah
        RULE:  B.f @Int = $sf

Applying this rule makes foo refer to $sf, although foo doesn't appear to
depend on $sf.  (And, as in Note [IMP-RULES: local rules for imported functions], the
dependency might be more indirect. For example, foo might mention C.t
rather than B.f, where C.t eventually inlines to B.f.)

NOTICE that this cannot happen for rules whose head is a
locally-defined function, because we accurately track dependencies
through RULES.  It only happens for rules whose head is an imported
function (B.f in the example above).

Solution:
  - When simplifying, bring all top level identifiers into
    scope at the start, ignoring the Rec/NonRec structure, so
    that when 'h' pops up in f's rhs, we find it in the in-scope set
    (as the simplifier generally expects). This happens in simplTopBinds.

  - In the occurrence analyser, if there are any out-of-scope
    occurrences that pop out of the top, which will happen after
    firing the rule:      f = \x -&gt; h x
                          h = \y -&gt; 3
    then just glom all the bindings into a single Rec, so that
    the *next* iteration of the occurrence analyser will sort
    them all out.   This part happens in occurAnalysePgm.

This is a legitimate situation where the need for glomming doesn't
point to any problems. However, when GHC is compiled with -DDEBUG, we
produce a warning addressed to the GHC developers just in case we
require glomming due to an out-of-order reference that is caused by
some earlier transformation stage misbehaving.
-}</span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Bindings
*                                                                      *
************************************************************************

Note [Recursive bindings: the grand plan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Loop breaking is surprisingly subtle.  First read the section 4 of
&quot;Secrets of the GHC inliner&quot;.  This describes our basic plan.  We
avoid infinite inlinings by choosing loop breakers, and ensuring that
a loop breaker cuts each loop.

See also Note [Inlining and hs-boot files] in GHC.Core.ToIface, which
deals with a closely related source of infinite loops.

When we come across a binding group
  Rec { x1 = r1; ...; xn = rn }
we treat it like this (occAnalRecBind):

1. Note [Forming Rec groups]
   Occurrence-analyse each right hand side, and build a
   &quot;Details&quot; for each binding to capture the results.
   Wrap the details in a LetrecNode, ready for SCC analysis.
   All this is done by makeNode.

   The edges of this graph are the &quot;scope edges&quot;.

2. Do SCC-analysis on these Nodes:
   - Each CyclicSCC will become a new Rec
   - Each AcyclicSCC will become a new NonRec

   The key property is that every free variable of a binding is
   accounted for by the scope edges, so that when we are done
   everything is still in scope.

3. For each AcyclicSCC, just make a NonRec binding.

4. For each CyclicSCC of the scope-edge SCC-analysis in (2), we
   identify suitable loop-breakers to ensure that inlining terminates.
   This is done by occAnalRec.

   To do so, form the loop-breaker graph, do SCC analysis. For each
   CyclicSCC we choose a loop breaker, delete all edges to that node,
   re-analyse the SCC, and iterate. See Note [Choosing loop breakers]
   for the details


Note [Dead code]
~~~~~~~~~~~~~~~~
Dropping dead code for a cyclic Strongly Connected Component is done
in a very simple way:

        the entire SCC is dropped if none of its binders are mentioned
        in the body; otherwise the whole thing is kept.

The key observation is that dead code elimination happens after
dependency analysis: so 'occAnalBind' processes SCCs instead of the
original term's binding groups.

Thus 'occAnalBind' does indeed drop 'f' in an example like

        letrec f = ...g...
               g = ...(...g...)...
        in
           ...g...

when 'g' no longer uses 'f' at all (eg 'f' does not occur in a RULE in
'g'). 'occAnalBind' first consumes 'CyclicSCC g' and then it consumes
'AcyclicSCC f', where 'body_usage' won't contain 'f'.

Note [Forming Rec groups]
~~~~~~~~~~~~~~~~~~~~~~~~~
The key point about the &quot;Forming Rec groups&quot; step is that it /preserves
scoping/.  If 'x' is mentioned, it had better be bound somewhere.  So if
we start with
  Rec { f = ...h...
      ; g = ...f...
      ; h = ...f... }
we can split into SCCs
  Rec { f = ...h...
      ; h = ..f... }
  NonRec { g = ...f... }

We put bindings {f = ef; g = eg } in a Rec group if &quot;f uses g&quot; and &quot;g
uses f&quot;, no matter how indirectly.  We do a SCC analysis with an edge
f -&gt; g if &quot;f mentions g&quot;. That is, g is free in:
  a) the rhs 'ef'
  b) or the RHS of a rule for f, whether active or inactive
       Note [Rules are extra RHSs]
  c) or the LHS or a rule for f, whether active or inactive
       Note [Rule dependency info]
  d) the RHS of an /active/ local IMP-RULE
       Note [IMP-RULES: local rules for imported functions]

(b) and (c) apply regardless of the activation of the RULE, because even if
the rule is inactive its free variables must be bound.  But (d) doesn't need
to worry about this because IMP-RULES are always notionally at the bottom
of the file.

  * Note [Rules are extra RHSs]
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~
    A RULE for 'f' is like an extra RHS for 'f'. That way the &quot;parent&quot;
    keeps the specialised &quot;children&quot; alive.  If the parent dies
    (because it isn't referenced any more), then the children will die
    too (unless they are already referenced directly).

    So in Example [eftInt], eftInt and eftIntFB will be put in the
    same Rec, even though their 'main' RHSs are both non-recursive.

    We must also include inactive rules, so that their free vars
    remain in scope.

  * Note [Rule dependency info]
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~
    The VarSet in a RuleInfo is used for dependency analysis in the
    occurrence analyser.  We must track free vars in *both* lhs and rhs.
    Hence use of idRuleVars, rather than idRuleRhsVars in occAnalBind.
    Why both? Consider
        x = y
        RULE f x = v+4
    Then if we substitute y for x, we'd better do so in the
    rule's LHS too, so we'd better ensure the RULE appears to mention 'x'
    as well as 'v'

  * Note [Rules are visible in their own rec group]
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    We want the rules for 'f' to be visible in f's right-hand side.
    And we'd like them to be visible in other functions in f's Rec
    group.  E.g. in Note [Specialisation rules] we want f' rule
    to be visible in both f's RHS, and fs's RHS.

    This means that we must simplify the RULEs first, before looking
    at any of the definitions.  This is done by Simplify.simplRecBind,
    when it calls addLetIdInfo.

Note [TailUsageDetails when forming Rec groups]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The `TailUsageDetails` stored in the `nd_uds` field of a `NodeDetails` is
computed by `occAnalLamTail` applied to the RHS, not `occAnalExpr`.
That is because the binding might still become a *non-recursive join point* in
the AcyclicSCC case of dependency analysis!
Hence we do the delayed `adjustTailUsage` in `occAnalRec`/`tagRecBinders` to get
a regular, adjusted UsageDetails.
See Note [Join points and unfoldings/rules] for more details on the contract.

Note [Stable unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~
None of the above stuff about RULES applies to a stable unfolding
stored in a CoreUnfolding.  The unfolding, if any, is simplified
at the same time as the regular RHS of the function (ie *not* like
Note [Rules are visible in their own rec group]), so it should be
treated *exactly* like an extra RHS.

Or, rather, when computing loop-breaker edges,
  * If f has an INLINE pragma, and it is active, we treat the
    INLINE rhs as f's rhs
  * If it's inactive, we treat f as having no rhs
  * If it has no INLINE pragma, we look at f's actual rhs


There is a danger that we'll be sub-optimal if we see this
     f = ...f...
     [INLINE f = ..no f...]
where f is recursive, but the INLINE is not. This can just about
happen with a sufficiently odd set of rules; eg

        foo :: Int -&gt; Int
        {-# INLINE [1] foo #-}
        foo x = x+1

        bar :: Int -&gt; Int
        {-# INLINE [1] bar #-}
        bar x = foo x + 1

        {-# RULES &quot;foo&quot; [~1] forall x. foo x = bar x #-}

Here the RULE makes bar recursive; but it's INLINE pragma remains
non-recursive. It's tempting to then say that 'bar' should not be
a loop breaker, but an attempt to do so goes wrong in two ways:
   a) We may get
         $df = ...$cfoo...
         $cfoo = ...$df....
         [INLINE $cfoo = ...no-$df...]
      But we want $cfoo to depend on $df explicitly so that we
      put the bindings in the right order to inline $df in $cfoo
      and perhaps break the loop altogether.  (Maybe this
   b)


Example [eftInt]
~~~~~~~~~~~~~~~
Example (from GHC.Enum):

  eftInt :: Int# -&gt; Int# -&gt; [Int]
  eftInt x y = ...(non-recursive)...

  {-# INLINE [0] eftIntFB #-}
  eftIntFB :: (Int -&gt; r -&gt; r) -&gt; r -&gt; Int# -&gt; Int# -&gt; r
  eftIntFB c n x y = ...(non-recursive)...

  {-# RULES
  &quot;eftInt&quot;  [~1] forall x y. eftInt x y = build (\ c n -&gt; eftIntFB c n x y)
  &quot;eftIntList&quot;  [1] eftIntFB  (:) [] = eftInt
   #-}

Note [Specialisation rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this group, which is typical of what SpecConstr builds:

   fs a = ....f (C a)....
   f  x = ....f (C a)....
   {-# RULE f (C a) = fs a #-}

So 'f' and 'fs' are in the same Rec group (since f refers to fs via its RULE).

But watch out!  If 'fs' is not chosen as a loop breaker, we may get an infinite loop:
  - the RULE is applied in f's RHS (see Note [Rules for recursive functions] in GHC.Core.Opt.Simplify
  - fs is inlined (say it's small)
  - now there's another opportunity to apply the RULE

This showed up when compiling Control.Concurrent.Chan.getChanContents.
Hence the transitive rule_fv_env stuff described in
Note [Rules and loop breakers].

Note [Occurrence analysis for join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider these two somewhat artificial programs (#22404)

  Program (P1)                      Program (P2)
  ------------------------------    -------------------------------------
  let v = &lt;small thunk&gt; in          let v = &lt;small thunk&gt; in
                                    join j = case v of (a,b) -&gt; a
  in case x of                      in case x of
        A -&gt; case v of (a,b) -&gt; a         A -&gt; j
        B -&gt; case v of (a,b) -&gt; a         B -&gt; j
        C -&gt; case v of (a,b) -&gt; b         C -&gt; case v of (a,b) -&gt; b
        D -&gt; []                           D -&gt; []

In (P1), `v` gets allocated, as a thunk, every time this code is executed.  But
notice that `v` occurs at most once in any case branch; the occurrence analyser
spots this and returns a OneOcc{ occ_n_br = 3 } for `v`.  Then the code in
GHC.Core.Opt.Simplify.Utils.postInlineUnconditionally inlines `v` at its three
use sites, and discards the let-binding.  That way, we avoid allocating `v` in
the A,B,C branches (though we still compute it of course), and branch D
doesn't involve &lt;small thunk&gt; at all.  This sometimes makes a Really Big
Difference.

In (P2) we have shared the common RHS of A, B, in a join point `j`.  We would
like to inline `v` in just the same way as in (P1).  But the usual strategy
for let bindings is conservative and uses `andUDs` to combine usage from j's
RHS to its body; as if `j` was called on every code path (once, albeit).  In
the case of (P2), we'll get ManyOccs for `v`.  Important optimisation lost!

Solving this problem makes the Simplifier less fragile.  For example,
the Simplifier might inline `j`, and convert (P2) into (P1)... or it might
not, depending in a perhaps-fragile way on the size of the join point.
I was motivated to implement this feature of the occurrence analyser
when trying to make optimisation join points simpler and more robust
(see e.g. #23627).

The occurrence analyser therefore has clever code that behaves just as
if you inlined `j` at all its call sites.  Here is a tricky variant
to keep in mind:

  Program (P3)
  -------------------------------
    join j = case v of (a,b) -&gt; a
    in case f v of
          A -&gt; j
          B -&gt; j
          C -&gt; []

If you mentally inline `j` you'll see that `v` is used twice on the path
through A, so it should have ManyOcc.  Bear this case in mind!

* We treat /non-recursive/ join points specially. Recursive join points are
  treated like any other letrec, as before.  Moreover, we only give this special
  treatment to /pre-existing/ non-recursive join points, not the ones that we
  discover for the first time in this sweep of the occurrence analyser.

* In occ_env, the new (occ_join_points :: IdEnv OccInfoEnv) maps
  each in-scope non-recursive join point, such as `j` above, to
  a &quot;zeroed form&quot; of its RHS's usage details. The &quot;zeroed form&quot;
    * deletes ManyOccs
    * maps a OneOcc to OneOcc{ occ_n_br = 0 }
  In our example, occ_join_points will be extended with
      [j :-&gt; [v :-&gt; OneOcc{occ_n_br=0}]]
  See addJoinPoint.

* At an occurrence of a join point, we do everything as normal, but add in the
  UsageDetails from the occ_join_points.  See mkOneOcc.

* Crucially, at the NonRec binding of the join point, in `occAnalBind`, we use
  `orUDs`, not `andUDs` to combine the usage from the RHS with the usage from
  the body.

Here are the consequences

* Because of the perhaps-surprising OneOcc{occ_n_br=0} idea of the zeroed
  form, the occ_n_br field of a OneOcc binder still counts the number of
  /actual lexical occurrences/ of the variable.  In Program P2, for example,
  `v` will end up with OneOcc{occ_n_br=2}, not occ_n_br=3.
  There are two lexical occurrences of `v`!
  (NB: `orUDs` adds occ_n_br together, so occ_n_br=1 is impossible, too.)

* In the tricky (P3) we'll get an `andUDs` of
    * OneOcc{occ_n_br=0} from the occurrences of `j`)
    * OneOcc{occ_n_br=1} from the (f v)
  These are `andUDs` together in `addOccInfo`, and hence
  `v` gets ManyOccs, just as it should.  Clever!

There are a couple of tricky wrinkles

(W1) Consider this example which shadows `j`:
          join j = rhs in
          in case x of { K j -&gt; ..j..; ... }
     Clearly when we come to the pattern `K j` we must drop the `j`
     entry in occ_join_points.

     This is done by `drop_shadowed_joins` in `addInScope`.

(W2) Consider this example which shadows `v`:
          join j = ...v...
          in case x of { K v -&gt; ..j..; ... }

     We can't make j's occurrences in the K alternative give rise to an
     occurrence of `v` (via occ_join_points), because it'll just be deleted by
     the `K v` pattern.  Yikes.  This is rare because shadowing is rare, but
     it definitely can happen.  Solution: when bringing `v` into scope at
     the `K v` pattern, chuck out of occ_join_points any elements whose
     UsageDetails mentions `v`.  Instead, just `andUDs` all that usage in
     right here.

     This requires work in two places.
     * In `preprocess_env`, we detect if the newly-bound variables intersect
       the free vars of occ_join_points.  (These free vars are conveniently
       simply the domain of the OccInfoEnv for that join point.) If so,
       we zap the entire occ_join_points.
     * In `postprcess_uds`, we add the chucked-out join points to the
       returned UsageDetails, with `andUDs`.

(W3) Consider this example, which shadows `j`, but this time in an argument
              join j = rhs
              in f (case x of { K j -&gt; ...; ... })
     We can zap the entire occ_join_points when looking at the argument,
     because `j` can't posibly occur -- it's a join point!  And the smaller
     occ_join_points is, the better.  Smaller to look up in mkOneOcc, and
     more important, less looking-up when checking (W2).

     This is done in setNonTailCtxt.  It's important /not/ to do this for
     join-point RHS's because of course `j` can occur there!

     NB: this is just about efficiency: it is always safe /not/ to zap the
     occ_join_points.

(W4) What if the join point binding has a stable unfolding, or RULES?
     They are just alternative right-hand sides, and at each call site we
     will use only one of them. So again, we can use `orUDs` to combine
     usage info from all these alternatives RHSs.

Wrinkles (W1) and (W2) are very similar to Note [Binder swap] (BS3).

Note [Finding join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~
It's the occurrence analyser's job to find bindings that we can turn into join
points, but it doesn't perform that transformation right away. Rather, it marks
the eligible bindings as part of their occurrence data, leaving it to the
simplifier (or to simpleOptPgm) to actually change the binder's 'IdDetails'.
The simplifier then eta-expands the RHS if needed and then updates the
occurrence sites. Dividing the work this way means that the occurrence analyser
still only takes one pass, yet one can always tell the difference between a
function call and a jump by looking at the occurrence (because the same pass
changes the 'IdDetails' and propagates the binders to their occurrence sites).

To track potential join points, we use the 'occ_tail' field of OccInfo. A value
of `AlwaysTailCalled n` indicates that every occurrence of the variable is a
tail call with `n` arguments (counting both value and type arguments). Otherwise
'occ_tail' will be 'NoTailCallInfo'. The tail call info flows bottom-up with the
rest of 'OccInfo' until it goes on the binder.

Note [Join arity prediction based on joinRhsArity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general, the join arity from tail occurrences of a join point (O) may be
higher or lower than the manifest join arity of the join body (M). E.g.,

  -- M &gt; O:
  let f x y = x + y              -- M = 2
  in if b then f 1 else f 2      -- O = 1
  ==&gt; { Contify for join arity 1 }
  join f x = \y -&gt; x + y
  in if b then jump f 1 else jump f 2

  -- M &lt; O
  let f = id                     -- M = 0
  in if ... then f 12 else f 13  -- O = 1
  ==&gt; { Contify for join arity 1, eta-expand f }
  join f x = id x
  in if b then jump f 12 else jump f 13

But for *recursive* let, it is crucial that both arities match up, consider

  letrec f x y = if ... then f x else True
  in f 42

Here, M=2 but O=1. If we settled for a joinrec arity of 1, the recursive jump
would not happen in a tail context! Contification is invalid here.
So indeed it is crucial to demand that M=O.

(Side note: Actually, we could be more specific: Let O1 be the join arity of
occurrences from the letrec RHS and O2 the join arity from the let body. Then
we need M=O1 and M&lt;=O2 and could simply eta-expand the RHS to match O2 later.
M=O is the specific case where we don't want to eta-expand. Neither the join
points paper nor GHC does this at the moment.)

We can capitalise on this observation and conclude that *if* f could become a
joinrec (without eta-expansion), it will have join arity M.
Now, M is just the result of 'joinRhsArity', a rather simple, local analysis.
It is also the join arity inside the 'TailUsageDetails' returned by
'occAnalLamTail', so we can predict join arity without doing any fixed-point
iteration or really doing any deep traversal of let body or RHS at all.
We check for M in the 'adjustTailUsage' call inside 'tagRecBinders'.

All this is quite apparent if you look at the contification transformation in
Fig. 5 of &quot;Compiling without Continuations&quot; (which does not account for
eta-expansion at all, mind you). The letrec case looks like this

  letrec f = /\as.\xs. L[us] in L'[es]
    ... and a bunch of conditions establishing that f only occurs
        in app heads of join arity (len as + len xs) inside us and es ...

The syntactic form `/\as.\xs. L[us]` forces M=O iff `f` occurs in `us`. However,
for non-recursive functions, this is the definition of contification from the
paper:

  let f = /\as.\xs.u in L[es]     ... conditions ...

Note that u could be a lambda itself, as we have seen. No relationship between M
and O to exploit here.

Note [Join points and unfoldings/rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   let j2 y = blah
   let j x = j2 (x+x)
       {-# INLINE [2] j #-}
   in case e of { A -&gt; j 1; B -&gt; ...; C -&gt; j 2 }

Before j is inlined, we'll have occurrences of j2 in
both j's RHS and in its stable unfolding.  We want to discover
j2 as a join point. So 'occAnalUnfolding' returns an unadjusted
'TailUsageDetails', like 'occAnalLamTail'. We adjust the usage details of the
unfolding to the actual join arity using the same 'adjustTailArity' as for
the RHS, see Note [Adjusting right-hand sides].

Same with rules. Suppose we have:

  let j :: Int -&gt; Int
      j y = 2 * y
  let k :: Int -&gt; Int -&gt; Int
      {-# RULES &quot;SPEC k 0&quot; k 0 y = j y #-}
      k x y = x + 2 * y
  in case e of { A -&gt; k 1 2; B -&gt; k 3 5; C -&gt; blah }

We identify k as a join point, and we want j to be a join point too.
Without the RULE it would be, and we don't want the RULE to mess it
up.  So provided the join-point arity of k matches the args of the
rule we can allow the tail-call info from the RHS of the rule to
propagate.

* Note that the join arity of the RHS and that of the unfolding or RULE might
  mismatch:

    let j x y = j2 (x+x)
        {-# INLINE[2] j = \x. g #-}
        {-# RULE forall x y z. j x y z = h 17 #-}
    in j 1 2

  So it is crucial that we adjust each TailUsageDetails individually
  with the actual join arity 2 here before we combine with `andUDs`.
  Here, that means losing tail call info on `g` and `h`.

* Wrinkle for Rec case: We store one TailUsageDetails in the node Details for
  RHS, unfolding and RULE combined. Clearly, if they don't agree on their join
  arity, we have to do some adjusting. We choose to adjust to the join arity
  of the RHS, because that is likely the join arity that the join point will
  have; see Note [Join arity prediction based on joinRhsArity].

  If the guess is correct, then tail calls in the RHS are preserved; a necessary
  condition for the whole binding becoming a joinrec.
  The guess can only be incorrect in the 'AcyclicSCC' case when the binding
  becomes a non-recursive join point with a different join arity. But then the
  eventual call to 'adjustTailUsage' in 'tagRecBinders'/'occAnalRec' will
  be with a different join arity and destroy unsound tail call info with
  'markNonTail'.

* Wrinkle for RULES.  Suppose the example was a bit different:
      let j :: Int -&gt; Int
          j y = 2 * y
          k :: Int -&gt; Int -&gt; Int
          {-# RULES &quot;SPEC k 0&quot; k 0 = j #-}
          k x y = x + 2 * y
      in ...
  If we eta-expanded the rule all would be well, but as it stands the
  one arg of the rule don't match the join-point arity of 2.

  Conceivably we could notice that a potential join point would have
  an &quot;undersaturated&quot; rule and account for it. This would mean we
  could make something that's been specialised a join point, for
  instance. But local bindings are rarely specialised, and being
  overly cautious about rules only costs us anything when, for some `j`:

  * Before specialisation, `j` has non-tail calls, so it can't be a join point.
  * During specialisation, `j` gets specialised and thus acquires rules.
  * Sometime afterward, the non-tail calls to `j` disappear (as dead code, say),
    and so now `j` *could* become a join point.

  This appears to be very rare in practice. TODO Perhaps we should gather
  statistics to be sure.

------------------------------------------------------------
Note [Adjusting right-hand sides]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There's a bit of a dance we need to do after analysing a lambda expression or
a right-hand side. In particular, we need to

  a) call 'markAllNonTail' *unless* the binding is for a join point, and
     the TailUsageDetails from the RHS has the right join arity; e.g.
        join j x y = case ... of
                       A -&gt; j2 p
                       B -&gt; j2 q
        in j a b
     Here we want the tail calls to j2 to be tail calls of the whole expression
  b) call 'markAllInsideLam' *unless* the binding is for a thunk, a one-shot
     lambda, or a non-recursive join point

Some examples, with how the free occurrences in e (assumed not to be a value
lambda) get marked:

                             inside lam    non-tail-called
  ------------------------------------------------------------
  let x = e                  No            Yes
  let f = \x -&gt; e            Yes           Yes
  let f = \x{OneShot} -&gt; e   No            Yes
  \x -&gt; e                    Yes           Yes
  join j x = e               No            No
  joinrec j x = e            Yes           No

There are a few other caveats; most importantly, if we're marking a binding as
'AlwaysTailCalled', it's *going* to be a join point, so we treat it as one so
that the effect cascades properly. Consequently, at the time the RHS is
analysed, we won't know what adjustments to make; thus 'occAnalLamTail' must
return the unadjusted 'TailUsageDetails', to be adjusted by 'adjustTailUsage'
once join-point-hood has been decided and eventual one-shot annotations have
been added through 'markNonRecJoinOneShots'.

It is not so simple to see that 'occAnalNonRecBind' and 'occAnalRecBind' indeed
perform a similar sequence of steps. Thus, here is an interleaving of events
of both functions, serving as a specification:

  1. Call 'occAnalLamTail' to find usage information for the RHS.
     Recursive case:     'makeNode'
     Non-recursive case: 'occAnalNonRecBind'
  2. (Analyse the binding's scope. Done in 'occAnalBind'/`occAnal Let{}`.
      Same whether recursive or not.)
  3. Call 'tagNonRecBinder' or 'tagRecBinders', which decides whether to make
     the binding a join point.
     Cyclic  Recursive case:  'mkLoopBreakerNodes'
     Acyclic Recursive case:  `occAnalRec AcyclicSCC{}`
     Non-recursive case:      'occAnalNonRecBind'
  4. Non-recursive join point: Call 'markNonRecJoinOneShots' so that e.g.,
     FloatOut sees one-shot annotations on lambdas
     Acyclic Recursive case:  `occAnalRec AcyclicSCC{}`  calls 'adjustNonRecRhs'
     Non-recursive case:      'occAnalNonRecBind'        calls 'adjustNonRecRhs'
  5. Call 'adjustTailUsage' accordingly.
     Cyclic Recursive case:   'tagRecBinders'
     Acyclic Recursive case:  'adjustNonRecRhs'
     Non-recursive case:      'adjustNonRecRhs'
-}</span><span>
</span><span id="line-956"></span><span>
</span><span id="line-957"></span><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><span id="line-958"></span><span class="hs-comment">--                 occAnalBind</span><span>
</span><span id="line-959"></span><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><span id="line-960"></span><span>
</span><span id="line-961"></span><span id="local-6989586621682710536"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalBind"><span class="hs-identifier hs-type">occAnalBind</span></a></span><span>
</span><span id="line-962"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-963"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-964"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a></span><span>
</span><span id="line-965"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span>
</span><span id="line-966"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682710536"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Scope of the bind</span><span>
</span><span id="line-967"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682710536"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682710536"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- How to combine the scope with new binds</span><span>
</span><span id="line-968"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682710536"><span class="hs-identifier hs-type">r</span></a></span></span><span>              </span><span class="hs-comment">-- Of the whole let(rec)</span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span id="occAnalBind"><span class="annot"><span class="annottext">occAnalBind :: forall r.
OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; CoreBind
-&gt; (OccEnv -&gt; WithUsageDetails r)
-&gt; (CoreProgram -&gt; r -&gt; r)
-&gt; WithUsageDetails r
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalBind"><span class="hs-identifier hs-var hs-var">occAnalBind</span></a></span></span><span> </span><span id="local-6989586621682710934"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710934"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682710935"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682710935"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682710936"><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710936"><span class="hs-identifier hs-var">ire</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682710938"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682710938"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682710939"><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails r
</span><a href="#local-6989586621682710939"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span> </span><span id="local-6989586621682710940"><span class="annot"><span class="annottext">CoreProgram -&gt; r -&gt; r
</span><a href="#local-6989586621682710940"><span class="hs-identifier hs-var">combine</span></a></span></span><span>
</span><span id="line-971"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails r) -&gt; WithUsageDetails r
forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeList"><span class="hs-identifier hs-var">addInScopeList</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710934"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Id) -&gt; [(Id, CoreExpr)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682710938"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((OccEnv -&gt; WithUsageDetails r) -&gt; WithUsageDetails r)
-&gt; (OccEnv -&gt; WithUsageDetails r) -&gt; WithUsageDetails r
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682710943"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710943"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-972"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682710944"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710944"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span> </span><span id="local-6989586621682710945"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710945"><span class="hs-identifier hs-var">body'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails r
</span><a href="#local-6989586621682710939"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710943"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-973"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682710946"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710946"><span class="hs-identifier hs-var">bind_uds</span></a></span></span><span> </span><span id="local-6989586621682710947"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710947"><span class="hs-identifier hs-var">binds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; [(Id, CoreExpr)]
-&gt; UsageDetails
-&gt; WithUsageDetails CoreProgram
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalRecBind"><span class="hs-identifier hs-var">occAnalRecBind</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710943"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682710935"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710936"><span class="hs-identifier hs-var">ire</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682710938"><span class="hs-identifier hs-var">pairs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710944"><span class="hs-identifier hs-var">body_uds</span></a></span><span>
</span><span id="line-974"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; r -&gt; WithUsageDetails r
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710946"><span class="hs-identifier hs-var">bind_uds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; r -&gt; r
</span><a href="#local-6989586621682710940"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682710947"><span class="hs-identifier hs-var">binds'</span></a></span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710945"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-975"></span><span>
</span><span id="line-976"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalBind"><span class="hs-identifier hs-var">occAnalBind</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682710948"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710948"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682710949"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682710949"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682710950"><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710950"><span class="hs-identifier hs-var">ire</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682710952"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710952"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682710953"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710953"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682710954"><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails r
</span><a href="#local-6989586621682710954"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span> </span><span id="local-6989586621682710955"><span class="annot"><span class="annottext">CoreProgram -&gt; r -&gt; r
</span><a href="#local-6989586621682710955"><span class="hs-identifier hs-var">combine</span></a></span></span><span>
</span><span id="line-977"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710952"><span class="hs-identifier hs-var">bndr</span></a></span><span>      </span><span class="hs-comment">-- A type let; we don't gather usage info</span><span>
</span><span id="line-978"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682710957"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710957"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span> </span><span id="local-6989586621682710958"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710958"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; Id -&gt; (OccEnv -&gt; WithUsageDetails r) -&gt; WithUsageDetails r
forall a.
OccEnv
-&gt; Id -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeOne"><span class="hs-identifier hs-var">addInScopeOne</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710948"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710952"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails r
</span><a href="#local-6989586621682710954"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-979"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; r -&gt; WithUsageDetails r
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710957"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; r -&gt; r
</span><a href="#local-6989586621682710955"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710952"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710953"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710958"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-980"></span><span>
</span><span id="line-981"></span><span>  </span><span class="hs-comment">-- /Existing/ non-recursive join points</span><span>
</span><span id="line-982"></span><span>  </span><span class="hs-comment">-- See Note [Occurrence analysis for join points]</span><span>
</span><span id="line-983"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682710960"><span class="annot"><span class="annottext">mb_join :: JoinPointHood
</span><a href="#local-6989586621682710960"><span class="hs-identifier hs-var">mb_join</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710952"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-984"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Analyse the RHS and /then/ the body</span><span>
</span><span id="line-985"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Analyse the rhs first, generating rhs_uds</span><span>
</span><span id="line-986"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682710963"><span class="annot"><span class="annottext">[UsageDetails]
</span><a href="#local-6989586621682710963"><span class="hs-identifier hs-var">rhs_uds_s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682710964"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710964"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682710965"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710965"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; JoinPointHood
-&gt; Id
-&gt; CoreExpr
-&gt; ([UsageDetails], Id, CoreExpr)
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalNonRecRhs"><span class="hs-identifier hs-var">occAnalNonRecRhs</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710948"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682710949"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710950"><span class="hs-identifier hs-var">ire</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682710960"><span class="hs-identifier hs-var">mb_join</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710952"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710953"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-987"></span><span>        </span><span id="local-6989586621682710967"><span class="annot"><span class="annottext">rhs_uds :: UsageDetails
</span><a href="#local-6989586621682710967"><span class="hs-identifier hs-var hs-var">rhs_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails -&gt; UsageDetails)
-&gt; [UsageDetails] -&gt; UsageDetails
forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldr1</span></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#orUDs"><span class="hs-identifier hs-var">orUDs</span></a></span><span> </span><span class="annot"><span class="annottext">[UsageDetails]
</span><a href="#local-6989586621682710963"><span class="hs-identifier hs-var">rhs_uds_s</span></a></span><span>   </span><span class="hs-comment">-- NB: orUDs.  See (W4) of</span><span>
</span><span id="line-988"></span><span>                                           </span><span class="hs-comment">-- Note [Occurrence analysis for join points]</span><span>
</span><span id="line-989"></span><span>
</span><span id="line-990"></span><span>        </span><span class="hs-comment">-- Now analyse the body, adding the join point</span><span>
</span><span id="line-991"></span><span>        </span><span class="hs-comment">-- into the environment with addJoinPoint</span><span>
</span><span id="line-992"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682710970"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710970"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682710971"><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682710971"><span class="hs-identifier hs-var">occ</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682710972"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710972"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; Id
-&gt; (OccEnv -&gt; WithUsageDetails r)
-&gt; WithUsageDetails (OccInfo, r)
forall r.
OccEnv
-&gt; Id
-&gt; (OccEnv -&gt; WithUsageDetails r)
-&gt; WithUsageDetails (OccInfo, r)
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalNonRecBody"><span class="hs-identifier hs-var">occAnalNonRecBody</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710948"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710964"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">((OccEnv -&gt; WithUsageDetails r) -&gt; WithUsageDetails (OccInfo, r))
-&gt; (OccEnv -&gt; WithUsageDetails r) -&gt; WithUsageDetails (OccInfo, r)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682710974"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710974"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-993"></span><span>                                      </span><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails r
</span><a href="#local-6989586621682710954"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; Id -&gt; UsageDetails -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#addJoinPoint"><span class="hs-identifier hs-var">addJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710974"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710964"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710967"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-994"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-995"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isDeadOcc"><span class="hs-identifier hs-var">isDeadOcc</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682710971"><span class="hs-identifier hs-var">occ</span></a></span><span>     </span><span class="hs-comment">-- Drop dead code; see Note [Dead code]</span><span>
</span><span id="line-996"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; r -&gt; WithUsageDetails r
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710970"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710972"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-997"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; r -&gt; WithUsageDetails r
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710967"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#orUDs"><span class="hs-operator hs-var">`orUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710970"><span class="hs-identifier hs-var">body_uds</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Note `orUDs`</span><span>
</span><span id="line-998"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; r -&gt; r
</span><a href="#local-6989586621682710955"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id, JoinPointHood) -&gt; Id
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag -&gt; OccInfo -&gt; Id -&gt; (Id, JoinPointHood)
</span><a href="GHC.Core.Opt.OccurAnal.html#tagNonRecBinder"><span class="hs-identifier hs-var">tagNonRecBinder</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682710949"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682710971"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710964"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710965"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-999"></span><span>                      </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710972"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1000"></span><span>
</span><span id="line-1001"></span><span>  </span><span class="hs-comment">-- The normal case, including newly-discovered join points</span><span>
</span><span id="line-1002"></span><span>  </span><span class="hs-comment">-- Analyse the body and /then/ the RHS</span><span>
</span><span id="line-1003"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682710978"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710978"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682710979"><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682710979"><span class="hs-identifier hs-var">occ</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682710980"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710980"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; Id
-&gt; (OccEnv -&gt; WithUsageDetails r)
-&gt; WithUsageDetails (OccInfo, r)
forall r.
OccEnv
-&gt; Id
-&gt; (OccEnv -&gt; WithUsageDetails r)
-&gt; WithUsageDetails (OccInfo, r)
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalNonRecBody"><span class="hs-identifier hs-var">occAnalNonRecBody</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710948"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710952"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails r
</span><a href="#local-6989586621682710954"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-1004"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isDeadOcc"><span class="hs-identifier hs-var">isDeadOcc</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682710979"><span class="hs-identifier hs-var">occ</span></a></span><span>   </span><span class="hs-comment">-- Drop dead code; see Note [Dead code]</span><span>
</span><span id="line-1005"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; r -&gt; WithUsageDetails r
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710978"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710980"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1006"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-1007"></span><span>        </span><span class="hs-comment">-- Get the join info from the *new* decision; NB: bndr is not already a JoinId</span><span>
</span><span id="line-1008"></span><span>        </span><span class="hs-comment">-- See Note [Join points and unfoldings/rules]</span><span>
</span><span id="line-1009"></span><span>        </span><span class="hs-comment">-- =&gt; join arity O of Note [Join arity prediction based on joinRhsArity]</span><span>
</span><span id="line-1010"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682710981"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710981"><span class="hs-identifier hs-var">tagged_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682710982"><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682710982"><span class="hs-identifier hs-var">mb_join</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; OccInfo -&gt; Id -&gt; (Id, JoinPointHood)
</span><a href="GHC.Core.Opt.OccurAnal.html#tagNonRecBinder"><span class="hs-identifier hs-var">tagNonRecBinder</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682710949"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682710979"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710952"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1011"></span><span>
</span><span id="line-1012"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682710983"><span class="annot"><span class="annottext">[UsageDetails]
</span><a href="#local-6989586621682710983"><span class="hs-identifier hs-var">rhs_uds_s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682710984"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710984"><span class="hs-identifier hs-var">final_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682710985"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710985"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; JoinPointHood
-&gt; Id
-&gt; CoreExpr
-&gt; ([UsageDetails], Id, CoreExpr)
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalNonRecRhs"><span class="hs-identifier hs-var">occAnalNonRecRhs</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710948"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682710949"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710950"><span class="hs-identifier hs-var">ire</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682710982"><span class="hs-identifier hs-var">mb_join</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710981"><span class="hs-identifier hs-var">tagged_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710953"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1013"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; r -&gt; WithUsageDetails r
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails -&gt; UsageDetails)
-&gt; UsageDetails -&gt; [UsageDetails] -&gt; UsageDetails
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710978"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[UsageDetails]
</span><a href="#local-6989586621682710983"><span class="hs-identifier hs-var">rhs_uds_s</span></a></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Note `andUDs`</span><span>
</span><span id="line-1014"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; r -&gt; r
</span><a href="#local-6989586621682710955"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710984"><span class="hs-identifier hs-var">final_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682710985"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710980"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1015"></span><span>
</span><span id="line-1016"></span><span class="hs-comment">-----------------</span><span>
</span><span id="line-1017"></span><span id="local-6989586621682710548"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalNonRecBody"><span class="hs-identifier hs-type">occAnalNonRecBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-1018"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682710548"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Scope of the bind</span><span>
</span><span id="line-1019"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682710548"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1020"></span><span id="occAnalNonRecBody"><span class="annot"><span class="annottext">occAnalNonRecBody :: forall r.
OccEnv
-&gt; Id
-&gt; (OccEnv -&gt; WithUsageDetails r)
-&gt; WithUsageDetails (OccInfo, r)
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalNonRecBody"><span class="hs-identifier hs-var hs-var">occAnalNonRecBody</span></a></span></span><span> </span><span id="local-6989586621682710987"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710987"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682710988"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710988"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682710989"><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails r
</span><a href="#local-6989586621682710989"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-1021"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; Id
-&gt; (OccEnv -&gt; WithUsageDetails (OccInfo, r))
-&gt; WithUsageDetails (OccInfo, r)
forall a.
OccEnv
-&gt; Id -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeOne"><span class="hs-identifier hs-var">addInScopeOne</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710987"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710988"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">((OccEnv -&gt; WithUsageDetails (OccInfo, r))
 -&gt; WithUsageDetails (OccInfo, r))
-&gt; (OccEnv -&gt; WithUsageDetails (OccInfo, r))
-&gt; WithUsageDetails (OccInfo, r)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682710990"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710990"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1022"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682710991"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710991"><span class="hs-identifier hs-var">inner_uds</span></a></span></span><span> </span><span id="local-6989586621682710992"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710992"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails r
</span><a href="#local-6989586621682710989"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710990"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1023"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621682710993"><span class="annot"><span class="annottext">occ :: OccInfo
</span><a href="#local-6989586621682710993"><span class="hs-identifier hs-var hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; Id -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupLetOccInfo"><span class="hs-identifier hs-var">lookupLetOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710991"><span class="hs-identifier hs-var">inner_uds</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710988"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1024"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; (OccInfo, r) -&gt; WithUsageDetails (OccInfo, r)
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682710991"><span class="hs-identifier hs-var">inner_uds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682710993"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682710992"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1025"></span><span>
</span><span id="line-1026"></span><span class="hs-comment">-----------------</span><span>
</span><span id="line-1027"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalNonRecRhs"><span class="hs-identifier hs-type">occAnalNonRecRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a></span><span>
</span><span id="line-1028"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPointHood"><span class="hs-identifier hs-type">JoinPointHood</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1029"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1030"></span><span id="occAnalNonRecRhs"><span class="annot"><span class="annottext">occAnalNonRecRhs :: OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; JoinPointHood
-&gt; Id
-&gt; CoreExpr
-&gt; ([UsageDetails], Id, CoreExpr)
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalNonRecRhs"><span class="hs-identifier hs-var hs-var">occAnalNonRecRhs</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682710995"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710995"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682710996"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682710996"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682710997"><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710997"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span></span><span> </span><span id="local-6989586621682710998"><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682710998"><span class="hs-identifier hs-var">mb_join</span></a></span></span><span> </span><span id="local-6989586621682710999"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682711000"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711000"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1031"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682711002"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682711003"><span class="hs-identifier hs-var">imp_rule_infos</span></a></span><span>
</span><span id="line-1032"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-comment">-- Fast path for common case of no rules. This is only worth</span><span>
</span><span id="line-1033"></span><span>     </span><span class="hs-comment">-- 0.1% perf on average, but it's also only a line or two of code</span><span>
</span><span id="line-1034"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711004"><span class="hs-identifier hs-var">adj_rhs_uds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711005"><span class="hs-identifier hs-var">adj_unf_uds</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>              </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711006"><span class="hs-identifier hs-var">final_bndr_no_rules</span></a></span><span class="hs-special">,</span><span>   </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711007"><span class="hs-identifier hs-var">final_rhs</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1035"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1036"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711004"><span class="hs-identifier hs-var">adj_rhs_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; [UsageDetails] -&gt; [UsageDetails]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711005"><span class="hs-identifier hs-var">adj_unf_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; [UsageDetails] -&gt; [UsageDetails]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[UsageDetails]
</span><a href="#local-6989586621682711008"><span class="hs-identifier hs-var">adj_rule_uds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711009"><span class="hs-identifier hs-var">final_bndr_with_rules</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711007"><span class="hs-identifier hs-var">final_rhs</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1037"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1038"></span><span>    </span><span class="hs-comment">--------- Right hand side ---------</span><span>
</span><span id="line-1039"></span><span>    </span><span class="hs-comment">-- For join points, set occ_encl to OccVanilla, via setTailCtxt.  If we have</span><span>
</span><span id="line-1040"></span><span>    </span><span class="hs-comment">--    join j = Just (f x) in ...</span><span>
</span><span id="line-1041"></span><span>    </span><span class="hs-comment">-- we do not want to float the (f x) to</span><span>
</span><span id="line-1042"></span><span>    </span><span class="hs-comment">--    let y = f x in join j = Just y in ...</span><span>
</span><span id="line-1043"></span><span>    </span><span class="hs-comment">-- That's that OccRhs would do; but there's no point because</span><span>
</span><span id="line-1044"></span><span>    </span><span class="hs-comment">-- j will never be scrutinised.</span><span>
</span><span id="line-1045"></span><span>    </span><span id="local-6989586621682711010"><span class="annot"><span class="annottext">rhs_env :: OccEnv
</span><a href="#local-6989586621682711010"><span class="hs-identifier hs-var hs-var">rhs_env</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; RecFlag -&gt; OccEncl -&gt; JoinPointHood -&gt; Id -&gt; CoreExpr -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#mkRhsOccEnv"><span class="hs-identifier hs-var">mkRhsOccEnv</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710995"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="#local-6989586621682711013"><span class="hs-identifier hs-var">rhs_ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682710998"><span class="hs-identifier hs-var">mb_join</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711000"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1046"></span><span>    </span><span id="local-6989586621682711013"><span class="annot"><span class="annottext">rhs_ctxt :: OccEncl
</span><a href="#local-6989586621682711013"><span class="hs-identifier hs-var hs-var">rhs_ctxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Id -&gt; Unfolding -&gt; OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#mkNonRecRhsCtxt"><span class="hs-identifier hs-var">mkNonRecRhsCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682710996"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711015"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-1047"></span><span>
</span><span id="line-1048"></span><span>    </span><span class="hs-comment">-- See Note [Join arity prediction based on joinRhsArity]</span><span>
</span><span id="line-1049"></span><span>    </span><span class="hs-comment">-- Match join arity O from mb_join_arity with manifest join arity M as</span><span>
</span><span id="line-1050"></span><span>    </span><span class="hs-comment">-- returned by of occAnalLamTail. It's totally OK for them to mismatch;</span><span>
</span><span id="line-1051"></span><span>    </span><span class="hs-comment">-- hence adjust the UDs from the RHS</span><span>
</span><span id="line-1052"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711004"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711004"><span class="hs-identifier hs-var">adj_rhs_uds</span></a></span></span><span> </span><span id="local-6989586621682711007"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711007"><span class="hs-identifier hs-var">final_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
-&gt; WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustNonRecRhs"><span class="hs-identifier hs-var">adjustNonRecRhs</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682710998"><span class="hs-identifier hs-var">mb_join</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr)
-&gt; WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1053"></span><span>                                </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalLamTail"><span class="hs-identifier hs-var">occAnalLamTail</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711010"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711000"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1054"></span><span>    </span><span id="local-6989586621682711009"><span class="annot"><span class="annottext">final_bndr_with_rules :: Id
</span><a href="#local-6989586621682711009"><span class="hs-identifier hs-var hs-var">final_bndr_with_rules</span></a></span></span><span>
</span><span id="line-1055"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#noBinderSwaps"><span class="hs-identifier hs-var">noBinderSwaps</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710995"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-comment">-- See Note [Unfoldings and rules]</span><span>
</span><span id="line-1056"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; RuleInfo -&gt; Id
</span><a href="GHC.Types.Id.html#setIdSpecialisation"><span class="hs-operator hs-var">`setIdSpecialisation`</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; RuleInfo
</span><a href="GHC.Core.FVs.html#mkRuleInfo"><span class="hs-identifier hs-var">mkRuleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682711021"><span class="hs-identifier hs-var">rules'</span></a></span><span>
</span><span id="line-1057"></span><span>                                 </span><span class="annot"><span class="annottext">Id -&gt; Unfolding -&gt; Id
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711023"><span class="hs-identifier hs-var">unf1</span></a></span><span>
</span><span id="line-1058"></span><span>    </span><span id="local-6989586621682711006"><span class="annot"><span class="annottext">final_bndr_no_rules :: Id
</span><a href="#local-6989586621682711006"><span class="hs-identifier hs-var hs-var">final_bndr_no_rules</span></a></span></span><span>
</span><span id="line-1059"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#noBinderSwaps"><span class="hs-identifier hs-var">noBinderSwaps</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682710995"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-comment">-- See Note [Unfoldings and rules]</span><span>
</span><span id="line-1060"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unfolding -&gt; Id
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711023"><span class="hs-identifier hs-var">unf1</span></a></span><span>
</span><span id="line-1061"></span><span>
</span><span id="line-1062"></span><span>    </span><span class="hs-comment">--------- Unfolding ---------</span><span>
</span><span id="line-1063"></span><span>    </span><span class="hs-comment">-- See Note [Join points and unfoldings/rules]</span><span>
</span><span id="line-1064"></span><span>    </span><span id="local-6989586621682711015"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682711015"><span class="hs-identifier hs-var hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1065"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span id="local-6989586621682711026"><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711026"><span class="hs-identifier hs-var">unf_tuds</span></a></span></span><span> </span><span id="local-6989586621682711023"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711023"><span class="hs-identifier hs-var">unf1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Unfolding -&gt; WithTailUsageDetails Unfolding
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalUnfolding"><span class="hs-identifier hs-var">occAnalUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711010"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711015"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-1066"></span><span>    </span><span id="local-6989586621682711005"><span class="annot"><span class="annottext">adj_unf_uds :: UsageDetails
</span><a href="#local-6989586621682711005"><span class="hs-identifier hs-var hs-var">adj_unf_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointHood -&gt; TailUsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustTailArity"><span class="hs-identifier hs-var">adjustTailArity</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682710998"><span class="hs-identifier hs-var">mb_join</span></a></span><span> </span><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711026"><span class="hs-identifier hs-var">unf_tuds</span></a></span><span>
</span><span id="line-1067"></span><span>
</span><span id="line-1068"></span><span>    </span><span class="hs-comment">--------- Rules ---------</span><span>
</span><span id="line-1069"></span><span>    </span><span class="hs-comment">-- See Note [Rules are extra RHSs] and Note [Rule dependency info]</span><span>
</span><span id="line-1070"></span><span>    </span><span class="hs-comment">-- and Note [Join points and unfoldings/rules]</span><span>
</span><span id="line-1071"></span><span>    </span><span id="local-6989586621682711002"><span class="annot"><span class="annottext">rules :: [CoreRule]
</span><a href="#local-6989586621682711002"><span class="hs-identifier hs-var hs-var">rules</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1072"></span><span>    </span><span id="local-6989586621682711030"><span class="annot"><span class="annottext">rules_w_uds :: [(CoreRule, UsageDetails, TailUsageDetails)]
</span><a href="#local-6989586621682711030"><span class="hs-identifier hs-var hs-var">rules_w_uds</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreRule -&gt; (CoreRule, UsageDetails, TailUsageDetails))
-&gt; [CoreRule] -&gt; [(CoreRule, UsageDetails, TailUsageDetails)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; CoreRule -&gt; (CoreRule, UsageDetails, TailUsageDetails)
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalRule"><span class="hs-identifier hs-var">occAnalRule</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711010"><span class="hs-identifier hs-var">rhs_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682711002"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-1073"></span><span>    </span><span id="local-6989586621682711021"><span class="annot"><span class="annottext">rules' :: [CoreRule]
</span><a href="#local-6989586621682711021"><span class="hs-identifier hs-var hs-var">rules'</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreRule, UsageDetails, TailUsageDetails) -&gt; CoreRule)
-&gt; [(CoreRule, UsageDetails, TailUsageDetails)] -&gt; [CoreRule]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CoreRule, UsageDetails, TailUsageDetails) -&gt; CoreRule
forall a b c. (a, b, c) -&gt; a
</span><a href="GHC.Utils.Misc.html#fstOf3"><span class="hs-identifier hs-var">fstOf3</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreRule, UsageDetails, TailUsageDetails)]
</span><a href="#local-6989586621682711030"><span class="hs-identifier hs-var">rules_w_uds</span></a></span><span>
</span><span id="line-1074"></span><span>    </span><span id="local-6989586621682711003"><span class="annot"><span class="annottext">imp_rule_infos :: [(Activation, VarSet)]
</span><a href="#local-6989586621682711003"><span class="hs-identifier hs-var hs-var">imp_rule_infos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges -&gt; Id -&gt; [(Activation, VarSet)]
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupImpRules"><span class="hs-identifier hs-var">lookupImpRules</span></a></span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682710997"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682710999"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1075"></span><span>    </span><span id="local-6989586621682711033"><span class="annot"><span class="annottext">imp_rule_uds :: [UsageDetails]
</span><a href="#local-6989586621682711033"><span class="hs-identifier hs-var hs-var">imp_rule_uds</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[(Activation, VarSet)] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#impRulesScopeUsage"><span class="hs-identifier hs-var">impRulesScopeUsage</span></a></span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682711003"><span class="hs-identifier hs-var">imp_rule_infos</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1076"></span><span>         </span><span class="hs-comment">-- imp_rule_uds: consider</span><span>
</span><span id="line-1077"></span><span>         </span><span class="hs-comment">--     h = ...</span><span>
</span><span id="line-1078"></span><span>         </span><span class="hs-comment">--     g = ...</span><span>
</span><span id="line-1079"></span><span>         </span><span class="hs-comment">--     RULE map g = h</span><span>
</span><span id="line-1080"></span><span>         </span><span class="hs-comment">-- Then we want to ensure that h is in scope everywhere</span><span>
</span><span id="line-1081"></span><span>         </span><span class="hs-comment">-- that g is (since the RULE might turn g into h), so</span><span>
</span><span id="line-1082"></span><span>         </span><span class="hs-comment">-- we make g mention h.</span><span>
</span><span id="line-1083"></span><span>
</span><span id="line-1084"></span><span>    </span><span class="annot"><a href="#local-6989586621682711008"><span class="hs-identifier hs-type">adj_rule_uds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1085"></span><span>    </span><span id="local-6989586621682711008"><span class="annot"><span class="annottext">adj_rule_uds :: [UsageDetails]
</span><a href="#local-6989586621682711008"><span class="hs-identifier hs-var hs-var">adj_rule_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[UsageDetails]
</span><a href="#local-6989586621682711033"><span class="hs-identifier hs-var">imp_rule_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[UsageDetails] -&gt; [UsageDetails] -&gt; [UsageDetails]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-1086"></span><span>                   </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711034"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood -&gt; TailUsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustTailArity"><span class="hs-identifier hs-var">adjustTailArity</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682710998"><span class="hs-identifier hs-var">mb_join</span></a></span><span> </span><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711035"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1087"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621682711034"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711034"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682711035"><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711035"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(CoreRule, UsageDetails, TailUsageDetails)]
</span><a href="#local-6989586621682711030"><span class="hs-identifier hs-var">rules_w_uds</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1088"></span><span>
</span><span id="line-1089"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#mkNonRecRhsCtxt"><span class="hs-identifier hs-type">mkNonRecRhsCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEncl"><span class="hs-identifier hs-type">OccEncl</span></a></span><span>
</span><span id="line-1090"></span><span class="hs-comment">-- Precondition: Id is not a join point</span><span>
</span><span id="line-1091"></span><span id="mkNonRecRhsCtxt"><span class="annot"><span class="annottext">mkNonRecRhsCtxt :: TopLevelFlag -&gt; Id -&gt; Unfolding -&gt; OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#mkNonRecRhsCtxt"><span class="hs-identifier hs-var hs-var">mkNonRecRhsCtxt</span></a></span></span><span> </span><span id="local-6989586621682711036"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711036"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682711037"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711037"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682711038"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711038"><span class="hs-identifier hs-var">unf</span></a></span></span><span>
</span><span id="line-1092"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711039"><span class="hs-identifier hs-var">certainly_inline</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a></span><span> </span><span class="hs-comment">-- See Note [Cascading inlines]</span><span>
</span><span id="line-1093"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccRhs"><span class="hs-identifier hs-var">OccRhs</span></a></span><span>
</span><span id="line-1094"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1095"></span><span>    </span><span id="local-6989586621682711039"><span class="annot"><span class="annottext">certainly_inline :: Bool
</span><a href="#local-6989586621682711039"><span class="hs-identifier hs-var hs-var">certainly_inline</span></a></span></span><span> </span><span class="hs-comment">-- See Note [Cascading inlines]</span><span>
</span><span id="line-1096"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- mkNonRecRhsCtxt is only used for non-join points, so occAnalBind</span><span>
</span><span id="line-1097"></span><span>        </span><span class="hs-comment">-- has set the OccInfo for this binder before calling occAnalNonRecRhs</span><span>
</span><span id="line-1098"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711037"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1099"></span><span>          </span><span class="annot"><a href="GHC.Types.Basic.html#OneOcc"><span class="hs-identifier hs-type">OneOcc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_in_lam :: OccInfo -&gt; InsideLam
</span><a href="GHC.Types.Basic.html#occ_in_lam"><span class="hs-identifier hs-var">occ_in_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#NotInsideLam"><span class="hs-identifier hs-var">NotInsideLam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_n_br :: OccInfo -&gt; JoinArity
</span><a href="GHC.Types.Basic.html#occ_n_br"><span class="hs-identifier hs-var">occ_n_br</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1100"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711047"><span class="hs-identifier hs-var">active</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711050"><span class="hs-identifier hs-var">stable_unf</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711051"><span class="hs-identifier hs-var">top_bottoming</span></a></span><span>
</span><span id="line-1101"></span><span>          </span><span class="annot"><span class="annottext">OccInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1102"></span><span>
</span><span id="line-1103"></span><span>    </span><span id="local-6989586621682711047"><span class="annot"><span class="annottext">active :: Bool
</span><a href="#local-6989586621682711047"><span class="hs-identifier hs-var hs-var">active</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711037"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1104"></span><span>    </span><span id="local-6989586621682711050"><span class="annot"><span class="annottext">stable_unf :: Bool
</span><a href="#local-6989586621682711050"><span class="hs-identifier hs-var hs-var">stable_unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711038"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-1105"></span><span>    </span><span id="local-6989586621682711051"><span class="annot"><span class="annottext">top_bottoming :: Bool
</span><a href="#local-6989586621682711051"><span class="hs-identifier hs-var hs-var">top_bottoming</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711036"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadEndId"><span class="hs-identifier hs-var">isDeadEndId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711037"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1106"></span><span>
</span><span id="line-1107"></span><span class="hs-comment">-----------------</span><span>
</span><span id="line-1108"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalRecBind"><span class="hs-identifier hs-type">occAnalRecBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1109"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1110"></span><span class="hs-comment">-- For a recursive group, we</span><span>
</span><span id="line-1111"></span><span class="hs-comment">--      * occ-analyse all the RHSs</span><span>
</span><span id="line-1112"></span><span class="hs-comment">--      * compute strongly-connected components</span><span>
</span><span id="line-1113"></span><span class="hs-comment">--      * feed those components to occAnalRec</span><span>
</span><span id="line-1114"></span><span class="hs-comment">-- See Note [Recursive bindings: the grand plan]</span><span>
</span><span id="line-1115"></span><span id="occAnalRecBind"><span class="annot"><span class="annottext">occAnalRecBind :: OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; [(Id, CoreExpr)]
-&gt; UsageDetails
-&gt; WithUsageDetails CoreProgram
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalRecBind"><span class="hs-identifier hs-var hs-var">occAnalRecBind</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711058"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711058"><span class="hs-identifier hs-var">rhs_env</span></a></span></span><span> </span><span id="local-6989586621682711059"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711059"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682711060"><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682711060"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span></span><span> </span><span id="local-6989586621682711061"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711061"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span id="local-6989586621682711062"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711062"><span class="hs-identifier hs-var">body_usage</span></a></span></span><span>
</span><span id="line-1116"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SCC NodeDetails
 -&gt; WithUsageDetails CoreProgram -&gt; WithUsageDetails CoreProgram)
-&gt; WithUsageDetails CoreProgram
-&gt; [SCC NodeDetails]
-&gt; WithUsageDetails CoreProgram
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv
-&gt; TopLevelFlag
-&gt; SCC NodeDetails
-&gt; WithUsageDetails CoreProgram
-&gt; WithUsageDetails CoreProgram
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalRec"><span class="hs-identifier hs-var">occAnalRec</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711058"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711059"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreProgram -&gt; WithUsageDetails CoreProgram
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711062"><span class="hs-identifier hs-var">body_usage</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SCC NodeDetails]
</span><a href="#local-6989586621682711064"><span class="hs-identifier hs-var">sccs</span></a></span><span>
</span><span id="line-1117"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1118"></span><span>    </span><span class="annot"><a href="#local-6989586621682711064"><span class="hs-identifier hs-type">sccs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#SCC"><span class="hs-identifier hs-type">SCC</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeDetails"><span class="hs-identifier hs-type">NodeDetails</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1119"></span><span>    </span><span id="local-6989586621682711064"><span class="annot"><span class="annottext">sccs :: [SCC NodeDetails]
</span><a href="#local-6989586621682711064"><span class="hs-identifier hs-var hs-var">sccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Node Unique NodeDetails] -&gt; [SCC NodeDetails]
forall key payload.
Uniquable key =&gt;
[Node key payload] -&gt; [SCC payload]
</span><a href="GHC.Data.Graph.Directed.html#stronglyConnCompFromEdgedVerticesUniq"><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniq</span></a></span><span> </span><span class="annot"><span class="annottext">[Node Unique NodeDetails]
</span><a href="#local-6989586621682711065"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-1120"></span><span>
</span><span id="line-1121"></span><span>    </span><span class="annot"><a href="#local-6989586621682711065"><span class="hs-identifier hs-type">nodes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1122"></span><span>    </span><span id="local-6989586621682711065"><span class="annot"><span class="annottext">nodes :: [Node Unique NodeDetails]
</span><a href="#local-6989586621682711065"><span class="hs-identifier hs-var hs-var">nodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Node Unique NodeDetails)
-&gt; [(Id, CoreExpr)] -&gt; [Node Unique NodeDetails]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv
-&gt; ImpRuleEdges
-&gt; VarSet
-&gt; (Id, CoreExpr)
-&gt; Node Unique NodeDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#makeNode"><span class="hs-identifier hs-var">makeNode</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711058"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682711060"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711068"><span class="hs-identifier hs-var">bndr_set</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711061"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-1123"></span><span>
</span><span id="line-1124"></span><span>    </span><span id="local-6989586621682711069"><span class="annot"><span class="annottext">bndrs :: [Id]
</span><a href="#local-6989586621682711069"><span class="hs-identifier hs-var hs-var">bndrs</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Id) -&gt; [(Id, CoreExpr)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711061"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-1125"></span><span>    </span><span id="local-6989586621682711068"><span class="annot"><span class="annottext">bndr_set :: VarSet
</span><a href="#local-6989586621682711068"><span class="hs-identifier hs-var hs-var">bndr_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711069"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1126"></span><span>
</span><span id="line-1127"></span><span class="hs-comment">-----------------------------</span><span>
</span><span id="line-1128"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalRec"><span class="hs-identifier hs-type">occAnalRec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-1129"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#SCC"><span class="hs-identifier hs-type">SCC</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeDetails"><span class="hs-identifier hs-type">NodeDetails</span></a></span><span>
</span><span id="line-1130"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1131"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1132"></span><span>
</span><span id="line-1133"></span><span class="hs-comment">-- The NonRec case is just like a Let (NonRec ...) above</span><span>
</span><span id="line-1134"></span><span id="occAnalRec"><span class="annot"><span class="annottext">occAnalRec :: OccEnv
-&gt; TopLevelFlag
-&gt; SCC NodeDetails
-&gt; WithUsageDetails CoreProgram
-&gt; WithUsageDetails CoreProgram
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalRec"><span class="hs-identifier hs-var hs-var">occAnalRec</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">OccEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711071"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711071"><span class="hs-identifier hs-var">lvl</span></a></span></span><span>
</span><span id="line-1135"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#AcyclicSCC"><span class="hs-identifier hs-type">AcyclicSCC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ND"><span class="hs-identifier hs-type">ND</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">nd_bndr :: NodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var">nd_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711075"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711075"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_rhs :: NodeDetails -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_rhs"><span class="hs-identifier hs-var">nd_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711077"><span class="annot"><span class="annottext">WithTailUsageDetails CoreExpr
</span><a href="#local-6989586621682711077"><span class="hs-identifier hs-var">wtuds</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1136"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711078"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711078"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span> </span><span id="local-6989586621682711079"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682711079"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1137"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isDeadOcc"><span class="hs-identifier hs-var">isDeadOcc</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682711080"><span class="hs-identifier hs-var">occ</span></a></span><span>  </span><span class="hs-comment">-- Check for dead code: see Note [Dead code]</span><span>
</span><span id="line-1138"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreProgram -&gt; WithUsageDetails CoreProgram
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711078"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682711079"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-1139"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1140"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711081"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711081"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711082"><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682711082"><span class="hs-identifier hs-var">mb_join</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; OccInfo -&gt; Id -&gt; (Id, JoinPointHood)
</span><a href="GHC.Core.Opt.OccurAnal.html#tagNonRecBinder"><span class="hs-identifier hs-var">tagNonRecBinder</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711071"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682711080"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711075"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1141"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711083"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711083"><span class="hs-identifier hs-var">rhs_uds'</span></a></span></span><span> </span><span id="local-6989586621682711084"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711084"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
-&gt; WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustNonRecRhs"><span class="hs-identifier hs-var">adjustNonRecRhs</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682711082"><span class="hs-identifier hs-var">mb_join</span></a></span><span> </span><span class="annot"><span class="annottext">WithTailUsageDetails CoreExpr
</span><a href="#local-6989586621682711077"><span class="hs-identifier hs-var">wtuds</span></a></span><span>
</span><span id="line-1142"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreProgram -&gt; WithUsageDetails CoreProgram
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711078"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711083"><span class="hs-identifier hs-var">rhs_uds'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1143"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711081"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711084"><span class="hs-identifier hs-var">rhs'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreProgram -&gt; CoreProgram
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682711079"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1144"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1145"></span><span>    </span><span id="local-6989586621682711080"><span class="annot"><span class="annottext">occ :: OccInfo
</span><a href="#local-6989586621682711080"><span class="hs-identifier hs-var hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; Id -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupLetOccInfo"><span class="hs-identifier hs-var">lookupLetOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711078"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711075"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1146"></span><span>
</span><span id="line-1147"></span><span class="hs-comment">-- The Rec case is the interesting one</span><span>
</span><span id="line-1148"></span><span class="hs-comment">-- See Note [Recursive bindings: the grand plan]</span><span>
</span><span id="line-1149"></span><span class="hs-comment">-- See Note [Loop breaking]</span><span>
</span><span id="line-1150"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalRec"><span class="hs-identifier hs-var">occAnalRec</span></a></span><span> </span><span id="local-6989586621682711085"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711085"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711086"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711086"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#CyclicSCC"><span class="hs-identifier hs-type">CyclicSCC</span></a></span><span> </span><span id="local-6989586621682711088"><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682711088"><span class="hs-identifier hs-var">details_s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711089"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711089"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span> </span><span id="local-6989586621682711090"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682711090"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1151"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(NodeDetails -&gt; Bool) -&gt; [NodeDetails] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">NodeDetails -&gt; Bool
</span><a href="#local-6989586621682711092"><span class="hs-identifier hs-var">needed</span></a></span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682711088"><span class="hs-identifier hs-var">details_s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1152"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Check for dead code: see Note [Dead code]</span><span>
</span><span id="line-1153"></span><span>    </span><span class="hs-comment">-- NB: Only look at body_uds, ignoring uses in the SCC</span><span>
</span><span id="line-1154"></span><span>    </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreProgram -&gt; WithUsageDetails CoreProgram
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711089"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682711090"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-1155"></span><span>
</span><span id="line-1156"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1157"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreProgram -&gt; WithUsageDetails CoreProgram
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711093"><span class="hs-identifier hs-var">final_uds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711094"><span class="hs-identifier hs-var">pairs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreProgram -&gt; CoreProgram
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682711090"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1158"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1159"></span><span>    </span><span id="local-6989586621682711095"><span class="annot"><span class="annottext">all_simple :: Bool
</span><a href="#local-6989586621682711095"><span class="hs-identifier hs-var hs-var">all_simple</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NodeDetails -&gt; Bool) -&gt; [NodeDetails] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">NodeDetails -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_simple"><span class="hs-identifier hs-var">nd_simple</span></a></span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682711088"><span class="hs-identifier hs-var">details_s</span></a></span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span>    </span><span class="annot"><a href="#local-6989586621682711092"><span class="hs-identifier hs-type">needed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeDetails"><span class="hs-identifier hs-type">NodeDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1162"></span><span>    </span><span id="local-6989586621682711092"><span class="annot"><span class="annottext">needed :: NodeDetails -&gt; Bool
</span><a href="#local-6989586621682711092"><span class="hs-identifier hs-var hs-var">needed</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ND"><span class="hs-identifier hs-type">ND</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">nd_bndr :: NodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var">nd_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711098"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711098"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711098"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711098"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarEnv LocalOcc -&gt; Bool
forall a. Id -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnv"><span class="hs-operator hs-var">`elemVarEnv`</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711102"><span class="hs-identifier hs-var">body_env</span></a></span><span>
</span><span id="line-1163"></span><span>    </span><span id="local-6989586621682711102"><span class="annot"><span class="annottext">body_env :: VarEnv LocalOcc
</span><a href="#local-6989586621682711102"><span class="hs-identifier hs-var hs-var">body_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711089"><span class="hs-identifier hs-var">body_uds</span></a></span><span>
</span><span id="line-1164"></span><span>
</span><span id="line-1165"></span><span>    </span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-1166"></span><span>    </span><span class="hs-comment">-- Make the nodes for the loop-breaker analysis</span><span>
</span><span id="line-1167"></span><span>    </span><span class="hs-comment">-- See Note [Choosing loop breakers] for loop_breaker_nodes</span><span>
</span><span id="line-1168"></span><span>    </span><span class="annot"><a href="#local-6989586621682711093"><span class="hs-identifier hs-type">final_uds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-1169"></span><span>    </span><span class="annot"><a href="#local-6989586621682711104"><span class="hs-identifier hs-type">loop_breaker_nodes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1170"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711093"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711093"><span class="hs-identifier hs-var">final_uds</span></a></span></span><span> </span><span id="local-6989586621682711104"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711104"><span class="hs-identifier hs-var">loop_breaker_nodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; TopLevelFlag
-&gt; UsageDetails
-&gt; [NodeDetails]
-&gt; WithUsageDetails [LoopBreakerNode]
</span><a href="GHC.Core.Opt.OccurAnal.html#mkLoopBreakerNodes"><span class="hs-identifier hs-var">mkLoopBreakerNodes</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711085"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711086"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711089"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682711088"><span class="hs-identifier hs-var">details_s</span></a></span><span>
</span><span id="line-1171"></span><span>
</span><span id="line-1172"></span><span>    </span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-1173"></span><span>    </span><span class="annot"><a href="#local-6989586621682711106"><span class="hs-identifier hs-type">weak_fvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-1174"></span><span>    </span><span id="local-6989586621682711106"><span class="annot"><span class="annottext">weak_fvs :: VarSet
</span><a href="#local-6989586621682711106"><span class="hs-identifier hs-var hs-var">weak_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NodeDetails -&gt; VarSet) -&gt; [NodeDetails] -&gt; VarSet
forall a. (a -&gt; VarSet) -&gt; [a] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mapUnionVarSet"><span class="hs-identifier hs-var">mapUnionVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_weak_fvs"><span class="hs-identifier hs-var">nd_weak_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682711088"><span class="hs-identifier hs-var">details_s</span></a></span><span>
</span><span id="line-1175"></span><span>
</span><span id="line-1176"></span><span>    </span><span class="hs-comment">---------------------------</span><span>
</span><span id="line-1177"></span><span>    </span><span class="hs-comment">-- Now reconstruct the cycle</span><span>
</span><span id="line-1178"></span><span>    </span><span class="annot"><a href="#local-6989586621682711094"><span class="hs-identifier hs-type">pairs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1179"></span><span>    </span><span id="local-6989586621682711094"><span class="annot"><span class="annottext">pairs :: [(Id, CoreExpr)]
</span><a href="#local-6989586621682711094"><span class="hs-identifier hs-var hs-var">pairs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711095"><span class="hs-identifier hs-var">all_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
-&gt; VarSet
-&gt; [LoopBreakerNode]
-&gt; [(Id, CoreExpr)]
-&gt; [(Id, CoreExpr)]
</span><a href="GHC.Core.Opt.OccurAnal.html#reOrderNodes"><span class="hs-identifier hs-var">reOrderNodes</span></a></span><span>   </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711106"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711104"><span class="hs-identifier hs-var">loop_breaker_nodes</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1180"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
-&gt; VarSet
-&gt; [LoopBreakerNode]
-&gt; [(Id, CoreExpr)]
-&gt; [(Id, CoreExpr)]
</span><a href="GHC.Core.Opt.OccurAnal.html#loopBreakNodes"><span class="hs-identifier hs-var">loopBreakNodes</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711106"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711104"><span class="hs-identifier hs-var">loop_breaker_nodes</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1181"></span><span>          </span><span class="hs-comment">-- In the common case when all are &quot;simple&quot; (no rules at all)</span><span>
</span><span id="line-1182"></span><span>          </span><span class="hs-comment">-- the loop_breaker_nodes will include all the scope edges</span><span>
</span><span id="line-1183"></span><span>          </span><span class="hs-comment">-- so a SCC computation would yield a single CyclicSCC result;</span><span>
</span><span id="line-1184"></span><span>          </span><span class="hs-comment">-- and reOrderNodes deals with exactly that case.</span><span>
</span><span id="line-1185"></span><span>          </span><span class="hs-comment">-- Saves a SCC analysis in a common case</span><span>
</span><span id="line-1186"></span><span>
</span><span id="line-1187"></span><span>
</span><span id="line-1188"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                Loop breaking
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-1193"></span><span>
</span><span id="line-1194"></span><span class="hs-comment">{- Note [Choosing loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In Step 4 in Note [Recursive bindings: the grand plan]), occAnalRec does
loop-breaking on each CyclicSCC of the original program:

* mkLoopBreakerNodes: Form the loop-breaker graph for that CyclicSCC

* loopBreakNodes: Do SCC analysis on it

* reOrderNodes: For each CyclicSCC, pick a loop breaker
    * Delete edges to that loop breaker
    * Do another SCC analysis on that reduced SCC
    * Repeat

To form the loop-breaker graph, we construct a new set of Nodes, the
&quot;loop-breaker nodes&quot;, with the same details but different edges, the
&quot;loop-breaker edges&quot;.  The loop-breaker nodes have both more and fewer
dependencies than the scope edges:

  More edges:
     If f calls g, and g has an active rule that mentions h then
     we add an edge from f -&gt; h.  See Note [Rules and loop breakers].

  Fewer edges: we only include dependencies
     * only on /active/ rules,
     * on rule /RHSs/ (not LHSs)

The scope edges, by contrast, must be much more inclusive.

The nd_simple flag tracks the common case when a binding has no RULES
at all, in which case the loop-breaker edges will be identical to the
scope edges.

Note that in Example [eftInt], *neither* eftInt *nor* eftIntFB is
chosen as a loop breaker, because their RHSs don't mention each other.
And indeed both can be inlined safely.

Note [inl_fvs]
~~~~~~~~~~~~~~
Note that the loop-breaker graph includes edges for occurrences in
/both/ the RHS /and/ the stable unfolding.  Consider this, which actually
occurred when compiling BooleanFormula.hs in GHC:

  Rec { lvl1 = go
      ; lvl2[StableUnf = go] = lvl1
      ; go = ...go...lvl2... }

From the point of view of infinite inlining, we need only these edges:
   lvl1 :-&gt; go
   lvl2 :-&gt; go       -- The RHS lvl1 will never be used for inlining
   go   :-&gt; go, lvl2

But the danger is that, lacking any edge to lvl1, we'll put it at the
end thus
  Rec { lvl2[ StableUnf = go] = lvl1
      ; go[LoopBreaker] = ...go...lvl2... }
      ; lvl1[Occ=Once]  = go }

And now the Simplifer will try to use PreInlineUnconditionally on lvl1
(which occurs just once), but because it is last we won't actually
substitute in lvl2.  Sigh.

To avoid this possibility, we include edges from lvl2 to /both/ its
stable unfolding /and/ its RHS.  Hence the defn of inl_fvs in
makeNode.  Maybe we could be more clever, but it's very much a corner
case.

Note [Weak loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~
There is a last nasty wrinkle.  Suppose we have

    Rec { f = f_rhs
          RULE f [] = g

          h = h_rhs
          g = h
          ...more... }

Remember that we simplify the RULES before any RHS (see Note
[Rules are visible in their own rec group] above).

So we must *not* postInlineUnconditionally 'g', even though
its RHS turns out to be trivial.  (I'm assuming that 'g' is
not chosen as a loop breaker.)  Why not?  Because then we
drop the binding for 'g', which leaves it out of scope in the
RULE!

Here's a somewhat different example of the same thing
    Rec { q = r
        ; r = ...p...
        ; p = p_rhs
          RULE p [] = q }
Here the RULE is &quot;below&quot; q, but we *still* can't postInlineUnconditionally
q, because the RULE for p is active throughout.  So the RHS of r
might rewrite to     r = ...q...
So q must remain in scope in the output program!

We &quot;solve&quot; this by:

    Make q a &quot;weak&quot; loop breaker (OccInfo = IAmLoopBreaker True)
    iff q is a mentioned in the RHS of any RULE (active on not)
    in the Rec group

Note the &quot;active or not&quot; comment; even if a RULE is inactive, we
want its RHS free vars to stay alive (#20820)!

A normal &quot;strong&quot; loop breaker has IAmLoopBreaker False.  So:

                                Inline  postInlineUnconditionally
strong   IAmLoopBreaker False    no      no
weak     IAmLoopBreaker True     yes     no
         other                   yes     yes

The **sole** reason for this kind of loop breaker is so that
postInlineUnconditionally does not fire.  Ugh.

Annoyingly, since we simplify the rules *first* we'll never inline
q into p's RULE.  That trivial binding for q will hang around until
we discard the rule.  Yuk.  But it's rare.

Note [Rules and loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we form the loop-breaker graph (Step 4 in Note [Recursive
bindings: the grand plan]), we must be careful about RULEs.

For a start, we want a loop breaker to cut every cycle, so inactive
rules play no part; we need only consider /active/ rules.
See Note [Finding rule RHS free vars]

The second point is more subtle.  A RULE is like an equation for
'f' that is *always* inlined if it is applicable.  We do *not* disable
rules for loop-breakers.  It's up to whoever makes the rules to make
sure that the rules themselves always terminate.  See Note [Rules for
recursive functions] in GHC.Core.Opt.Simplify

Hence, if
    f's RHS (or its stable unfolding if it has one) mentions g, and
    g has a RULE that mentions h, and
    h has a RULE that mentions f

then we *must* choose f to be a loop breaker.  Example: see Note
[Specialisation rules]. So our plan is this:

   Take the free variables of f's RHS, and augment it with all the
   variables reachable by a transitive sequence RULES from those
   starting points.

That is the whole reason for computing rule_fv_env in mkLoopBreakerNodes.
Wrinkles:

* We only consider /active/ rules. See Note [Finding rule RHS free vars]

* We need only consider free vars that are also binders in this Rec
  group.  See also Note [Finding rule RHS free vars]

* We only consider variables free in the *RHS* of the rule, in
  contrast to the way we build the Rec group in the first place (Note
  [Rule dependency info])

* Why &quot;transitive sequence of rules&quot;?  Because active rules apply
  unconditionally, without checking loop-breaker-ness.
 See Note [Loop breaker dependencies].

Note [Finding rule RHS free vars]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this real example from Data Parallel Haskell
     tagZero :: Array Int -&gt; Array Tag
     {-# INLINE [1] tagZeroes #-}
     tagZero xs = pmap (\x -&gt; fromBool (x==0)) xs

     {-# RULES &quot;tagZero&quot; [~1] forall xs n.
         pmap fromBool &lt;blah blah&gt; = tagZero xs #-}
So tagZero's RHS mentions pmap, and pmap's RULE mentions tagZero.
However, tagZero can only be inlined in phase 1 and later, while
the RULE is only active *before* phase 1.  So there's no problem.

To make this work, we look for the RHS free vars only for
*active* rules. That's the reason for the occ_rule_act field
of the OccEnv.

Note [loopBreakNodes]
~~~~~~~~~~~~~~~~~~~~~
loopBreakNodes is applied to the list of nodes for a cyclic strongly
connected component (there's guaranteed to be a cycle).  It returns
the same nodes, but
        a) in a better order,
        b) with some of the Ids having a IAmALoopBreaker pragma

The &quot;loop-breaker&quot; Ids are sufficient to break all cycles in the SCC.  This means
that the simplifier can guarantee not to loop provided it never records an inlining
for these no-inline guys.

Furthermore, the order of the binds is such that if we neglect dependencies
on the no-inline Ids then the binds are topologically sorted.  This means
that the simplifier will generally do a good job if it works from top bottom,
recording inlinings for any Ids which aren't marked as &quot;no-inline&quot; as it goes.
-}</span><span>
</span><span id="line-1391"></span><span>
</span><span id="line-1392"></span><span class="hs-keyword">type</span><span> </span><span id="Binding"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1393"></span><span>
</span><span id="line-1394"></span><span class="hs-comment">-- See Note [loopBreakNodes]</span><span>
</span><span id="line-1395"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#loopBreakNodes"><span class="hs-identifier hs-type">loopBreakNodes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1396"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>        </span><span class="hs-comment">-- Binders whose dependencies may be &quot;missing&quot;</span><span>
</span><span id="line-1397"></span><span>                                </span><span class="hs-comment">-- See Note [Weak loop breakers]</span><span>
</span><span id="line-1398"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1399"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Append these to the end</span><span>
</span><span id="line-1400"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1401"></span><span>
</span><span id="line-1402"></span><span class="hs-comment">-- Return the bindings sorted into a plausible order, and marked with loop breakers.</span><span>
</span><span id="line-1403"></span><span class="hs-comment">-- See Note [loopBreakNodes]</span><span>
</span><span id="line-1404"></span><span id="loopBreakNodes"><span class="annot"><span class="annottext">loopBreakNodes :: JoinArity
-&gt; VarSet
-&gt; [LoopBreakerNode]
-&gt; [(Id, CoreExpr)]
-&gt; [(Id, CoreExpr)]
</span><a href="GHC.Core.Opt.OccurAnal.html#loopBreakNodes"><span class="hs-identifier hs-var hs-var">loopBreakNodes</span></a></span></span><span> </span><span id="local-6989586621682711112"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711112"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span id="local-6989586621682711113"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711113"><span class="hs-identifier hs-var">weak_fvs</span></a></span></span><span> </span><span id="local-6989586621682711114"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711114"><span class="hs-identifier hs-var">nodes</span></a></span></span><span> </span><span id="local-6989586621682711115"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711115"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-1405"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;loopBreakNodes&quot; (ppr nodes) $</span><span>
</span><span id="line-1406"></span><span>    </span><span class="annot"><span class="annottext">[SCC LoopBreakerNode] -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621682711116"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LoopBreakerNode] -&gt; [SCC LoopBreakerNode]
forall key payload.
Uniquable key =&gt;
[Node key payload] -&gt; [SCC (Node key payload)]
</span><a href="GHC.Data.Graph.Directed.html#stronglyConnCompFromEdgedVerticesUniqR"><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniqR</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711114"><span class="hs-identifier hs-var">nodes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1407"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1408"></span><span>    </span><span id="local-6989586621682711116"><span class="annot"><span class="annottext">go :: [SCC LoopBreakerNode] -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621682711116"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711115"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-1409"></span><span>    </span><span class="annot"><a href="#local-6989586621682711116"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711117"><span class="annot"><span class="annottext">SCC LoopBreakerNode
</span><a href="#local-6989586621682711117"><span class="hs-identifier hs-var">scc</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682711118"><span class="annot"><span class="annottext">[SCC LoopBreakerNode]
</span><a href="#local-6989586621682711118"><span class="hs-identifier hs-var">sccs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SCC LoopBreakerNode -&gt; [(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621682711119"><span class="hs-identifier hs-var">loop_break_scc</span></a></span><span> </span><span class="annot"><span class="annottext">SCC LoopBreakerNode
</span><a href="#local-6989586621682711117"><span class="hs-identifier hs-var">scc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SCC LoopBreakerNode] -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621682711116"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[SCC LoopBreakerNode]
</span><a href="#local-6989586621682711118"><span class="hs-identifier hs-var">sccs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1410"></span><span>
</span><span id="line-1411"></span><span>    </span><span id="local-6989586621682711119"><span class="annot"><span class="annottext">loop_break_scc :: SCC LoopBreakerNode -&gt; [(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621682711119"><span class="hs-identifier hs-var hs-var">loop_break_scc</span></a></span></span><span> </span><span id="local-6989586621682711120"><span class="annot"><span class="annottext">SCC LoopBreakerNode
</span><a href="#local-6989586621682711120"><span class="hs-identifier hs-var">scc</span></a></span></span><span> </span><span id="local-6989586621682711121"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711121"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-1412"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SCC LoopBreakerNode
</span><a href="#local-6989586621682711120"><span class="hs-identifier hs-var">scc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1413"></span><span>          </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#AcyclicSCC"><span class="hs-identifier hs-type">AcyclicSCC</span></a></span><span> </span><span id="local-6989586621682711122"><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711122"><span class="hs-identifier hs-var">node</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; LoopBreakerNode -&gt; (Id, CoreExpr)
</span><a href="GHC.Core.Opt.OccurAnal.html#nodeBinding"><span class="hs-identifier hs-var">nodeBinding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#mk_non_loop_breaker"><span class="hs-identifier hs-var">mk_non_loop_breaker</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711113"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711122"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; [(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711121"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-1414"></span><span>          </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#CyclicSCC"><span class="hs-identifier hs-type">CyclicSCC</span></a></span><span> </span><span id="local-6989586621682711125"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711125"><span class="hs-identifier hs-var">nodes</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">JoinArity
-&gt; VarSet
-&gt; [LoopBreakerNode]
-&gt; [(Id, CoreExpr)]
-&gt; [(Id, CoreExpr)]
</span><a href="GHC.Core.Opt.OccurAnal.html#reOrderNodes"><span class="hs-identifier hs-var">reOrderNodes</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711112"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711113"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711125"><span class="hs-identifier hs-var">nodes</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711121"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-1415"></span><span>
</span><span id="line-1416"></span><span class="hs-comment">----------------------------------</span><span>
</span><span id="line-1417"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#reOrderNodes"><span class="hs-identifier hs-type">reOrderNodes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1418"></span><span>    </span><span class="hs-comment">-- Choose a loop breaker, mark it no-inline,</span><span>
</span><span id="line-1419"></span><span>    </span><span class="hs-comment">-- and call loopBreakNodes on the rest</span><span>
</span><span id="line-1420"></span><span id="reOrderNodes"><span class="annot"><span class="annottext">reOrderNodes :: JoinArity
-&gt; VarSet
-&gt; [LoopBreakerNode]
-&gt; [(Id, CoreExpr)]
-&gt; [(Id, CoreExpr)]
</span><a href="GHC.Core.Opt.OccurAnal.html#reOrderNodes"><span class="hs-identifier hs-var hs-var">reOrderNodes</span></a></span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; [(Id, CoreExpr)]
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reOrderNodes&quot;</span></span><span>
</span><span id="line-1421"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#reOrderNodes"><span class="hs-identifier hs-var">reOrderNodes</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621682711127"><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711127"><span class="hs-identifier hs-var">node</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621682711128"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711128"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; LoopBreakerNode -&gt; (Id, CoreExpr)
</span><a href="GHC.Core.Opt.OccurAnal.html#nodeBinding"><span class="hs-identifier hs-var">nodeBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#mk_loop_breaker"><span class="hs-identifier hs-var">mk_loop_breaker</span></a></span><span> </span><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711127"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; [(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711128"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-1422"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#reOrderNodes"><span class="hs-identifier hs-var">reOrderNodes</span></a></span><span> </span><span id="local-6989586621682711130"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711130"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span id="local-6989586621682711131"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711131"><span class="hs-identifier hs-var">weak_fvs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711132"><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711132"><span class="hs-identifier hs-var">node</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682711133"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711133"><span class="hs-identifier hs-var">nodes</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711134"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711134"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-1423"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;reOrderNodes&quot; (vcat [ text &quot;unchosen&quot; &lt;+&gt; ppr unchosen</span><span>
</span><span id="line-1424"></span><span>    </span><span class="hs-comment">--                               , text &quot;chosen&quot; &lt;+&gt; ppr chosen_nodes ]) $</span><span>
</span><span id="line-1425"></span><span>    </span><span class="annot"><span class="annottext">JoinArity
-&gt; VarSet
-&gt; [LoopBreakerNode]
-&gt; [(Id, CoreExpr)]
-&gt; [(Id, CoreExpr)]
</span><a href="GHC.Core.Opt.OccurAnal.html#loopBreakNodes"><span class="hs-identifier hs-var">loopBreakNodes</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711135"><span class="hs-identifier hs-var">new_depth</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711131"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711136"><span class="hs-identifier hs-var">unchosen</span></a></span><span> </span><span class="annot"><span class="annottext">([(Id, CoreExpr)] -&gt; [(Id, CoreExpr)])
-&gt; [(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1426"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LoopBreakerNode -&gt; (Id, CoreExpr))
-&gt; [LoopBreakerNode] -&gt; [(Id, CoreExpr)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; LoopBreakerNode -&gt; (Id, CoreExpr)
</span><a href="GHC.Core.Opt.OccurAnal.html#nodeBinding"><span class="hs-identifier hs-var">nodeBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#mk_loop_breaker"><span class="hs-identifier hs-var">mk_loop_breaker</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711137"><span class="hs-identifier hs-var">chosen_nodes</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; [(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682711134"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1427"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1428"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682711137"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711137"><span class="hs-identifier hs-var">chosen_nodes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711136"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711136"><span class="hs-identifier hs-var">unchosen</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; NodeScore
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; ([LoopBreakerNode], [LoopBreakerNode])
</span><a href="GHC.Core.Opt.OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var">chooseLoopBreaker</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711139"><span class="hs-identifier hs-var">approximate_lb</span></a></span><span>
</span><span id="line-1429"></span><span>                                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimpleNodeDetails -&gt; NodeScore
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_score"><span class="hs-identifier hs-var">snd_score</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopBreakerNode -&gt; SimpleNodeDetails
forall key payload. Node key payload -&gt; payload
</span><a href="GHC.Data.Graph.Directed.html#node_payload"><span class="hs-identifier hs-var">node_payload</span></a></span><span> </span><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711132"><span class="hs-identifier hs-var">node</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1430"></span><span>                                                 </span><span class="hs-special">[</span><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711132"><span class="hs-identifier hs-var">node</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711133"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-1431"></span><span>
</span><span id="line-1432"></span><span>    </span><span id="local-6989586621682711139"><span class="annot"><span class="annottext">approximate_lb :: Bool
</span><a href="#local-6989586621682711139"><span class="hs-identifier hs-var hs-var">approximate_lb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711130"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">2</span></span><span>
</span><span id="line-1433"></span><span>    </span><span id="local-6989586621682711135"><span class="annot"><span class="annottext">new_depth :: JoinArity
</span><a href="#local-6989586621682711135"><span class="hs-identifier hs-var hs-var">new_depth</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711139"><span class="hs-identifier hs-var">approximate_lb</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1434"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711130"><span class="hs-identifier hs-var">depth</span></a></span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; JoinArity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1435"></span><span>        </span><span class="hs-comment">-- After two iterations (d=0, d=1) give up</span><span>
</span><span id="line-1436"></span><span>        </span><span class="hs-comment">-- and approximate, returning to d=0</span><span>
</span><span id="line-1437"></span><span>
</span><span id="line-1438"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#nodeBinding"><span class="hs-identifier hs-type">nodeBinding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span>
</span><span id="line-1439"></span><span id="nodeBinding"><span class="annot"><span class="annottext">nodeBinding :: (Id -&gt; Id) -&gt; LoopBreakerNode -&gt; (Id, CoreExpr)
</span><a href="GHC.Core.Opt.OccurAnal.html#nodeBinding"><span class="hs-identifier hs-var hs-var">nodeBinding</span></a></span></span><span> </span><span id="local-6989586621682711143"><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="#local-6989586621682711143"><span class="hs-identifier hs-var">set_id_occ</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopBreakerNode -&gt; SimpleNodeDetails
forall key payload. Node key payload -&gt; payload
</span><a href="GHC.Data.Graph.Directed.html#node_payload"><span class="hs-identifier hs-var">node_payload</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#SND"><span class="hs-identifier hs-type">SND</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">snd_bndr :: SimpleNodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_bndr"><span class="hs-identifier hs-var">snd_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711146"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711146"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">snd_rhs :: SimpleNodeDetails -&gt; CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_rhs"><span class="hs-identifier hs-var">snd_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711148"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711148"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1440"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="#local-6989586621682711143"><span class="hs-identifier hs-var">set_id_occ</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711146"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711148"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1441"></span><span>
</span><span id="line-1442"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#mk_loop_breaker"><span class="hs-identifier hs-type">mk_loop_breaker</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-1443"></span><span id="mk_loop_breaker"><span class="annot"><span class="annottext">mk_loop_breaker :: Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#mk_loop_breaker"><span class="hs-identifier hs-var hs-var">mk_loop_breaker</span></a></span></span><span> </span><span id="local-6989586621682711149"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711149"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-1444"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711149"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; OccInfo -&gt; Id
</span><a href="GHC.Types.Id.html#setIdOccInfo"><span class="hs-operator hs-var">`setIdOccInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682711151"><span class="hs-identifier hs-var">occ'</span></a></span><span>
</span><span id="line-1445"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1446"></span><span>    </span><span id="local-6989586621682711151"><span class="annot"><span class="annottext">occ' :: OccInfo
</span><a href="#local-6989586621682711151"><span class="hs-identifier hs-var hs-var">occ'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#strongLoopBreaker"><span class="hs-identifier hs-var">strongLoopBreaker</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#occ_tail"><span class="hs-identifier hs-var">occ_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711154"><span class="hs-identifier hs-type">tail_info</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1447"></span><span>    </span><span id="local-6989586621682711154"><span class="annot"><span class="annottext">tail_info :: TailCallInfo
</span><a href="#local-6989586621682711154"><span class="hs-identifier hs-var hs-var">tail_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; TailCallInfo
</span><a href="GHC.Types.Basic.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711149"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1448"></span><span>
</span><span id="line-1449"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#mk_non_loop_breaker"><span class="hs-identifier hs-type">mk_non_loop_breaker</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-1450"></span><span class="hs-comment">-- See Note [Weak loop breakers]</span><span>
</span><span id="line-1451"></span><span id="mk_non_loop_breaker"><span class="annot"><span class="annottext">mk_non_loop_breaker :: VarSet -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#mk_non_loop_breaker"><span class="hs-identifier hs-var hs-var">mk_non_loop_breaker</span></a></span></span><span> </span><span id="local-6989586621682711156"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711156"><span class="hs-identifier hs-var">weak_fvs</span></a></span></span><span> </span><span id="local-6989586621682711157"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711157"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-1452"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711157"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711156"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OccInfo -&gt; Id
</span><a href="GHC.Types.Id.html#setIdOccInfo"><span class="hs-identifier hs-var">setIdOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711157"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682711159"><span class="hs-identifier hs-var">occ'</span></a></span><span>
</span><span id="line-1453"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711157"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1454"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1455"></span><span>    </span><span id="local-6989586621682711159"><span class="annot"><span class="annottext">occ' :: OccInfo
</span><a href="#local-6989586621682711159"><span class="hs-identifier hs-var hs-var">occ'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#weakLoopBreaker"><span class="hs-identifier hs-var">weakLoopBreaker</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#occ_tail"><span class="hs-identifier hs-var">occ_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711161"><span class="hs-identifier hs-type">tail_info</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1456"></span><span>    </span><span id="local-6989586621682711161"><span class="annot"><span class="annottext">tail_info :: TailCallInfo
</span><a href="#local-6989586621682711161"><span class="hs-identifier hs-var hs-var">tail_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; TailCallInfo
</span><a href="GHC.Types.Basic.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711157"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1457"></span><span>
</span><span id="line-1458"></span><span class="hs-comment">----------------------------------</span><span>
</span><span id="line-1459"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-type">chooseLoopBreaker</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>                </span><span class="hs-comment">-- True &lt;=&gt; Too many iterations,</span><span>
</span><span id="line-1460"></span><span>                                         </span><span class="hs-comment">--          so approximate</span><span>
</span><span id="line-1461"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a></span><span>           </span><span class="hs-comment">-- Best score so far</span><span>
</span><span id="line-1462"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Nodes with this score</span><span>
</span><span id="line-1463"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Nodes with higher scores</span><span>
</span><span id="line-1464"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Unprocessed nodes</span><span>
</span><span id="line-1465"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1466"></span><span>    </span><span class="hs-comment">-- This loop looks for the bind with the lowest score</span><span>
</span><span id="line-1467"></span><span>    </span><span class="hs-comment">-- to pick as the loop  breaker.  The rest accumulate in</span><span>
</span><span id="line-1468"></span><span id="chooseLoopBreaker"><span class="annot"><span class="annottext">chooseLoopBreaker :: Bool
-&gt; NodeScore
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; ([LoopBreakerNode], [LoopBreakerNode])
</span><a href="GHC.Core.Opt.OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var hs-var">chooseLoopBreaker</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NodeScore
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711162"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711162"><span class="hs-identifier hs-var">loop_nodes</span></a></span></span><span> </span><span id="local-6989586621682711163"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711163"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1469"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711162"><span class="hs-identifier hs-var">loop_nodes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711163"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Done</span><span>
</span><span id="line-1470"></span><span>
</span><span id="line-1471"></span><span>    </span><span class="hs-comment">-- If approximate_loop_breaker is True, we pick *all*</span><span>
</span><span id="line-1472"></span><span>    </span><span class="hs-comment">-- nodes with lowest score, else just one</span><span>
</span><span id="line-1473"></span><span>    </span><span class="hs-comment">-- See Note [Complexity of loop breaking]</span><span>
</span><span id="line-1474"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var">chooseLoopBreaker</span></a></span><span> </span><span id="local-6989586621682711164"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711164"><span class="hs-identifier hs-var">approx_lb</span></a></span></span><span> </span><span id="local-6989586621682711165"><span class="annot"><span class="annottext">NodeScore
</span><a href="#local-6989586621682711165"><span class="hs-identifier hs-var">loop_sc</span></a></span></span><span> </span><span id="local-6989586621682711166"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711166"><span class="hs-identifier hs-var">loop_nodes</span></a></span></span><span> </span><span id="local-6989586621682711167"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711167"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711168"><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711168"><span class="hs-identifier hs-var">node</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682711169"><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711169"><span class="hs-identifier hs-var">nodes</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1475"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711164"><span class="hs-identifier hs-var">approx_lb</span></a></span><span>
</span><span id="line-1476"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NodeScore -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#rank"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">NodeScore
</span><a href="#local-6989586621682711171"><span class="hs-identifier hs-var">sc</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">NodeScore -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#rank"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">NodeScore
</span><a href="#local-6989586621682711165"><span class="hs-identifier hs-var">loop_sc</span></a></span><span>
</span><span id="line-1477"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; NodeScore
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; ([LoopBreakerNode], [LoopBreakerNode])
</span><a href="GHC.Core.Opt.OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var">chooseLoopBreaker</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711164"><span class="hs-identifier hs-var">approx_lb</span></a></span><span> </span><span class="annot"><span class="annottext">NodeScore
</span><a href="#local-6989586621682711165"><span class="hs-identifier hs-var">loop_sc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711168"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">LoopBreakerNode -&gt; [LoopBreakerNode] -&gt; [LoopBreakerNode]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711166"><span class="hs-identifier hs-var">loop_nodes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711167"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711169"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-1478"></span><span>
</span><span id="line-1479"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">NodeScore
</span><a href="#local-6989586621682711171"><span class="hs-identifier hs-var">sc</span></a></span><span> </span><span class="annot"><span class="annottext">NodeScore -&gt; NodeScore -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#betterLB"><span class="hs-operator hs-var">`betterLB`</span></a></span><span> </span><span class="annot"><span class="annottext">NodeScore
</span><a href="#local-6989586621682711165"><span class="hs-identifier hs-var">loop_sc</span></a></span><span>  </span><span class="hs-comment">-- Better score so pick this new one</span><span>
</span><span id="line-1480"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; NodeScore
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; ([LoopBreakerNode], [LoopBreakerNode])
</span><a href="GHC.Core.Opt.OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var">chooseLoopBreaker</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711164"><span class="hs-identifier hs-var">approx_lb</span></a></span><span> </span><span class="annot"><span class="annottext">NodeScore
</span><a href="#local-6989586621682711171"><span class="hs-identifier hs-var">sc</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711168"><span class="hs-identifier hs-var">node</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711166"><span class="hs-identifier hs-var">loop_nodes</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode] -&gt; [LoopBreakerNode] -&gt; [LoopBreakerNode]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711167"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711169"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-1481"></span><span>
</span><span id="line-1482"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>              </span><span class="hs-comment">-- Worse score so don't pick it</span><span>
</span><span id="line-1483"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; NodeScore
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; [LoopBreakerNode]
-&gt; ([LoopBreakerNode], [LoopBreakerNode])
</span><a href="GHC.Core.Opt.OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var">chooseLoopBreaker</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711164"><span class="hs-identifier hs-var">approx_lb</span></a></span><span> </span><span class="annot"><span class="annottext">NodeScore
</span><a href="#local-6989586621682711165"><span class="hs-identifier hs-var">loop_sc</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711166"><span class="hs-identifier hs-var">loop_nodes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711168"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">LoopBreakerNode -&gt; [LoopBreakerNode] -&gt; [LoopBreakerNode]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711167"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LoopBreakerNode]
</span><a href="#local-6989586621682711169"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-1484"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1485"></span><span>    </span><span id="local-6989586621682711171"><span class="annot"><span class="annottext">sc :: NodeScore
</span><a href="#local-6989586621682711171"><span class="hs-identifier hs-var hs-var">sc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimpleNodeDetails -&gt; NodeScore
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_score"><span class="hs-identifier hs-var">snd_score</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopBreakerNode -&gt; SimpleNodeDetails
forall key payload. Node key payload -&gt; payload
</span><a href="GHC.Data.Graph.Directed.html#node_payload"><span class="hs-identifier hs-var">node_payload</span></a></span><span> </span><span class="annot"><span class="annottext">LoopBreakerNode
</span><a href="#local-6989586621682711168"><span class="hs-identifier hs-var">node</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1486"></span><span>
</span><span id="line-1487"></span><span class="hs-comment">{-
Note [Complexity of loop breaking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The loop-breaking algorithm knocks out one binder at a time, and
performs a new SCC analysis on the remaining binders.  That can
behave very badly in tightly-coupled groups of bindings; in the
worst case it can be (N**2)*log N, because it does a full SCC
on N, then N-1, then N-2 and so on.

To avoid this, we switch plans after 2 (or whatever) attempts:
  Plan A: pick one binder with the lowest score, make it
          a loop breaker, and try again
  Plan B: pick *all* binders with the lowest score, make them
          all loop breakers, and try again
Since there are only a small finite number of scores, this will
terminate in a constant number of iterations, rather than O(N)
iterations.

You might thing that it's very unlikely, but RULES make it much
more likely.  Here's a real example from #1969:
  Rec { $dm = \d.\x. op d
        {-# RULES forall d. $dm Int d  = $s$dm1
                  forall d. $dm Bool d = $s$dm2 #-}

        dInt = MkD .... opInt ...
        dInt = MkD .... opBool ...
        opInt  = $dm dInt
        opBool = $dm dBool

        $s$dm1 = \x. op dInt
        $s$dm2 = \x. op dBool }
The RULES stuff means that we can't choose $dm as a loop breaker
(Note [Choosing loop breakers]), so we must choose at least (say)
opInt *and* opBool, and so on.  The number of loop breakers is
linear in the number of instance declarations.

Note [Loop breakers and INLINE/INLINABLE pragmas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Avoid choosing a function with an INLINE pramga as the loop breaker!
If such a function is mutually-recursive with a non-INLINE thing,
then the latter should be the loop-breaker.

It's vital to distinguish between INLINE and INLINABLE (the
Bool returned by hasStableCoreUnfolding_maybe).  If we start with
   Rec { {-# INLINABLE f #-}
         f x = ...f... }
and then worker/wrapper it through strictness analysis, we'll get
   Rec { {-# INLINABLE $wf #-}
         $wf p q = let x = (p,q) in ...f...

         {-# INLINE f #-}
         f x = case x of (p,q) -&gt; $wf p q }

Now it is vital that we choose $wf as the loop breaker, so we can
inline 'f' in '$wf'.

Note [DFuns should not be loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's particularly bad to make a DFun into a loop breaker.  See
Note [How instance declarations are translated] in GHC.Tc.TyCl.Instance

We give DFuns a higher score than ordinary CONLIKE things because
if there's a choice we want the DFun to be the non-loop breaker. Eg

rec { sc = /\ a \$dC. $fBWrap (T a) ($fCT @ a $dC)

      $fCT :: forall a_afE. (Roman.C a_afE) =&gt; Roman.C (Roman.T a_afE)
      {-# DFUN #-}
      $fCT = /\a \$dC. MkD (T a) ((sc @ a $dC) |&gt; blah) ($ctoF @ a $dC)
    }

Here 'sc' (the superclass) looks CONLIKE, but we'll never get to it
if we can't unravel the DFun first.

Note [Constructor applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's really really important to inline dictionaries.  Real
example (the Enum Ordering instance from GHC.Base):

     rec     f = \ x -&gt; case d of (p,q,r) -&gt; p x
             g = \ x -&gt; case d of (p,q,r) -&gt; q x
             d = (v, f, g)

Here, f and g occur just once; but we can't inline them into d.
On the other hand we *could* simplify those case expressions if
we didn't stupidly choose d as the loop breaker.
But we won't because constructor args are marked &quot;Many&quot;.
Inlining dictionaries is really essential to unravelling
the loops in static numeric dictionaries, see GHC.Float.

Note [Closure conversion]
~~~~~~~~~~~~~~~~~~~~~~~~~
We treat (\x. C p q) as a high-score candidate in the letrec scoring algorithm.
The immediate motivation came from the result of a closure-conversion transformation
which generated code like this:

    data Clo a b = forall c. Clo (c -&gt; a -&gt; b) c

    ($:) :: Clo a b -&gt; a -&gt; b
    Clo f env $: x = f env x

    rec { plus = Clo plus1 ()

        ; plus1 _ n = Clo plus2 n

        ; plus2 Zero     n = n
        ; plus2 (Succ m) n = Succ (plus $: m $: n) }

If we inline 'plus' and 'plus1', everything unravels nicely.  But if
we choose 'plus1' as the loop breaker (which is entirely possible
otherwise), the loop does not unravel nicely.


@occAnalUnfolding@ deals with the question of bindings where the Id is marked
by an INLINE pragma.  For these we record that anything which occurs
in its RHS occurs many times.  This pessimistically assumes that this
inlined binder also occurs many times in its scope, but if it doesn't
we'll catch it next time round.  At worst this costs an extra simplifier pass.
ToDo: try using the occurrence info for the inline'd binder.

[March 97] We do the same for atomic RHSs.  Reason: see notes with loopBreakSCC.
[June 98, SLPJ]  I've undone this change; I don't understand it.  See notes with loopBreakSCC.


************************************************************************
*                                                                      *
                   Making nodes
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1617"></span><span>
</span><span id="line-1618"></span><span class="hs-comment">-- | Digraph node as constructed by 'makeNode' and consumed by 'occAnalRec'.</span><span>
</span><span id="line-1619"></span><span class="hs-comment">-- The Unique key is gotten from the Id.</span><span>
</span><span id="line-1620"></span><span class="hs-keyword">type</span><span> </span><span id="LetrecNode"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LetrecNode"><span class="hs-identifier hs-var">LetrecNode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html#Node"><span class="hs-identifier hs-type">Node</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeDetails"><span class="hs-identifier hs-type">NodeDetails</span></a></span><span>
</span><span id="line-1621"></span><span>
</span><span id="line-1622"></span><span class="annot"><span class="hs-comment">-- | Node details as consumed by 'occAnalRec'.</span></span><span>
</span><span id="line-1623"></span><span class="hs-keyword">data</span><span> </span><span id="NodeDetails"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeDetails"><span class="hs-identifier hs-var">NodeDetails</span></a></span></span><span>
</span><span id="line-1624"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ND"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ND"><span class="hs-identifier hs-var">ND</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="nd_bndr"><span class="annot"><span class="annottext">NodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var hs-var">nd_bndr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>          </span><span class="hs-comment">-- Binder</span><span>
</span><span id="line-1625"></span><span>
</span><span id="line-1626"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="nd_rhs"><span class="annot"><span class="annottext">NodeDetails -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_rhs"><span class="hs-identifier hs-var hs-var">nd_rhs</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithTailUsageDetails"><span class="hs-identifier hs-type">WithTailUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1627"></span><span>         </span><span class="hs-comment">-- ^ RHS, already occ-analysed</span><span>
</span><span id="line-1628"></span><span>         </span><span class="hs-comment">-- With TailUsageDetails from RHS, and RULES, and stable unfoldings,</span><span>
</span><span id="line-1629"></span><span>         </span><span class="hs-comment">-- ignoring phase (ie assuming all are active).</span><span>
</span><span id="line-1630"></span><span>         </span><span class="hs-comment">-- NB: Unadjusted TailUsageDetails, as if this Node becomes a</span><span>
</span><span id="line-1631"></span><span>         </span><span class="hs-comment">-- non-recursive join point!</span><span>
</span><span id="line-1632"></span><span>         </span><span class="hs-comment">-- See Note [TailUsageDetails when forming Rec groups]</span><span>
</span><span id="line-1633"></span><span>
</span><span id="line-1634"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="nd_inl"><span class="annot"><span class="annottext">NodeDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_inl"><span class="hs-identifier hs-var hs-var">nd_inl</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span>       </span><span class="hs-comment">-- Free variables of the stable unfolding and the RHS</span><span>
</span><span id="line-1635"></span><span>                                </span><span class="hs-comment">-- but excluding any RULES</span><span>
</span><span id="line-1636"></span><span>                                </span><span class="hs-comment">-- This is the IdSet that may be used if the Id is inlined</span><span>
</span><span id="line-1637"></span><span>
</span><span id="line-1638"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="nd_simple"><span class="annot"><span class="annottext">NodeDetails -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_simple"><span class="hs-identifier hs-var hs-var">nd_simple</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>      </span><span class="hs-comment">-- True iff this binding has no local RULES</span><span>
</span><span id="line-1639"></span><span>                                </span><span class="hs-comment">-- If all nodes are simple we don't need a loop-breaker</span><span>
</span><span id="line-1640"></span><span>                                </span><span class="hs-comment">-- dep-anal before reconstructing.</span><span>
</span><span id="line-1641"></span><span>
</span><span id="line-1642"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="nd_weak_fvs"><span class="annot"><span class="annottext">NodeDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_weak_fvs"><span class="hs-identifier hs-var hs-var">nd_weak_fvs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span>    </span><span class="hs-comment">-- Variables bound in this Rec group that are free</span><span>
</span><span id="line-1643"></span><span>                                 </span><span class="hs-comment">-- in the RHS of any rule (active or not) for this bndr</span><span>
</span><span id="line-1644"></span><span>                                 </span><span class="hs-comment">-- See Note [Weak loop breakers]</span><span>
</span><span id="line-1645"></span><span>
</span><span id="line-1646"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="nd_active_rule_fvs"><span class="annot"><span class="annottext">NodeDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_active_rule_fvs"><span class="hs-identifier hs-var hs-var">nd_active_rule_fvs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span>    </span><span class="hs-comment">-- Variables bound in this Rec group that are free</span><span>
</span><span id="line-1647"></span><span>                                        </span><span class="hs-comment">-- in the RHS of an active rule for this bndr</span><span>
</span><span id="line-1648"></span><span>                                        </span><span class="hs-comment">-- See Note [Rules and loop breakers]</span><span>
</span><span id="line-1649"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-1650"></span><span>
</span><span id="line-1651"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeDetails"><span class="hs-identifier hs-type">NodeDetails</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1652"></span><span>   </span><span id="local-6989586621682711200"><span class="annot"><span class="annottext">ppr :: NodeDetails -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span id="local-6989586621682711201"><span class="annot"><span class="annottext">NodeDetails
</span><a href="#local-6989586621682711201"><span class="hs-identifier hs-var">nd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ND&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span>
</span><span id="line-1653"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bndr =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var">nd_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDetails
</span><a href="#local-6989586621682711201"><span class="hs-identifier hs-var">nd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1654"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;uds =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TailUsageDetails -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711206"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-1655"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inl =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_inl"><span class="hs-identifier hs-var">nd_inl</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDetails
</span><a href="#local-6989586621682711201"><span class="hs-identifier hs-var">nd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1656"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simple =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeDetails -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_simple"><span class="hs-identifier hs-var">nd_simple</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDetails
</span><a href="#local-6989586621682711201"><span class="hs-identifier hs-var">nd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1657"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;active_rule_fvs =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_active_rule_fvs"><span class="hs-identifier hs-var">nd_active_rule_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDetails
</span><a href="#local-6989586621682711201"><span class="hs-identifier hs-var">nd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1658"></span><span>             </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1659"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-1660"></span><span>               </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span id="local-6989586621682711206"><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711206"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeDetails -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_rhs"><span class="hs-identifier hs-var">nd_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDetails
</span><a href="#local-6989586621682711201"><span class="hs-identifier hs-var">nd</span></a></span><span>
</span><span id="line-1661"></span><span>
</span><span id="line-1662"></span><span class="hs-comment">-- | Digraph with simplified and completely occurrence analysed</span><span>
</span><span id="line-1663"></span><span class="hs-comment">-- 'SimpleNodeDetails', retaining just the info we need for breaking loops.</span><span>
</span><span id="line-1664"></span><span class="hs-keyword">type</span><span> </span><span id="LoopBreakerNode"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-var">LoopBreakerNode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html#Node"><span class="hs-identifier hs-type">Node</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#SimpleNodeDetails"><span class="hs-identifier hs-type">SimpleNodeDetails</span></a></span><span>
</span><span id="line-1665"></span><span>
</span><span id="line-1666"></span><span class="annot"><span class="hs-comment">-- | Condensed variant of 'NodeDetails' needed during loop breaking.</span></span><span>
</span><span id="line-1667"></span><span class="hs-keyword">data</span><span> </span><span id="SimpleNodeDetails"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#SimpleNodeDetails"><span class="hs-identifier hs-var">SimpleNodeDetails</span></a></span></span><span>
</span><span id="line-1668"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SND"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#SND"><span class="hs-identifier hs-var">SND</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="snd_bndr"><span class="annot"><span class="annottext">SimpleNodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_bndr"><span class="hs-identifier hs-var hs-var">snd_bndr</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a></span><span>  </span><span class="hs-comment">-- OccInfo accurate</span><span>
</span><span id="line-1669"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="snd_rhs"><span class="annot"><span class="annottext">SimpleNodeDetails -&gt; CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_rhs"><span class="hs-identifier hs-var hs-var">snd_rhs</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>       </span><span class="hs-comment">-- properly occur-analysed</span><span>
</span><span id="line-1670"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="snd_score"><span class="annot"><span class="annottext">SimpleNodeDetails -&gt; NodeScore
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_score"><span class="hs-identifier hs-var hs-var">snd_score</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a></span><span>
</span><span id="line-1671"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1672"></span><span>
</span><span id="line-1673"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#SimpleNodeDetails"><span class="hs-identifier hs-type">SimpleNodeDetails</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1674"></span><span>   </span><span id="local-6989586621682711224"><span class="annot"><span class="annottext">ppr :: SimpleNodeDetails -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span id="local-6989586621682711225"><span class="annot"><span class="annottext">SimpleNodeDetails
</span><a href="#local-6989586621682711225"><span class="hs-identifier hs-var">nd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SND&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span>
</span><span id="line-1675"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bndr =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimpleNodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_bndr"><span class="hs-identifier hs-var">snd_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleNodeDetails
</span><a href="#local-6989586621682711225"><span class="hs-identifier hs-var">nd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1676"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;score =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NodeScore -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimpleNodeDetails -&gt; NodeScore
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_score"><span class="hs-identifier hs-var">snd_score</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleNodeDetails
</span><a href="#local-6989586621682711225"><span class="hs-identifier hs-var">nd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1677"></span><span>             </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1678"></span><span>
</span><span id="line-1679"></span><span class="hs-comment">-- The NodeScore is compared lexicographically;</span><span>
</span><span id="line-1680"></span><span class="hs-comment">--      e.g. lower rank wins regardless of size</span><span>
</span><span id="line-1681"></span><span class="hs-keyword">type</span><span> </span><span id="NodeScore"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeScore"><span class="hs-identifier hs-var">NodeScore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>     </span><span class="hs-comment">-- Rank: lower =&gt; more likely to be picked as loop breaker</span><span>
</span><span id="line-1682"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>     </span><span class="hs-comment">-- Size of rhs: higher =&gt; more likely to be picked as LB</span><span>
</span><span id="line-1683"></span><span>                           </span><span class="hs-comment">-- Maxes out at maxExprSize; we just use it to prioritise</span><span>
</span><span id="line-1684"></span><span>                           </span><span class="hs-comment">-- small functions</span><span>
</span><span id="line-1685"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Was it a loop breaker before?</span><span>
</span><span id="line-1686"></span><span>                           </span><span class="hs-comment">-- True =&gt; more likely to be picked</span><span>
</span><span id="line-1687"></span><span>                           </span><span class="hs-comment">-- Note [Loop breakers, node scoring, and stability]</span><span>
</span><span id="line-1688"></span><span>
</span><span id="line-1689"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#rank"><span class="hs-identifier hs-type">rank</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1690"></span><span id="rank"><span class="annot"><span class="annottext">rank :: NodeScore -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#rank"><span class="hs-identifier hs-var hs-var">rank</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711226"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711226"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711226"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1691"></span><span>
</span><span id="line-1692"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#makeNode"><span class="hs-identifier hs-type">makeNode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-1693"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a></span><span>
</span><span id="line-1694"></span><span class="hs-comment">-- See Note [Recursive bindings: the grand plan]</span><span>
</span><span id="line-1695"></span><span id="makeNode"><span class="annot"><span class="annottext">makeNode :: OccEnv
-&gt; ImpRuleEdges
-&gt; VarSet
-&gt; (Id, CoreExpr)
-&gt; Node Unique NodeDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#makeNode"><span class="hs-identifier hs-var hs-var">makeNode</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711227"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711227"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711228"><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682711228"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span></span><span> </span><span id="local-6989586621682711229"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711229"><span class="hs-identifier hs-var">bndr_set</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711230"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711230"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711231"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711231"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1696"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;makeNode&quot; (ppr bndr &lt;+&gt; ppr (sizeVarSet bndr_set)) $</span><span>
</span><span id="line-1697"></span><span>    </span><span class="annot"><a href="GHC.Data.Graph.Directed.html#DigraphNode"><span class="hs-identifier hs-type">DigraphNode</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">node_payload :: NodeDetails
</span><a href="GHC.Data.Graph.Directed.html#node_payload"><span class="hs-identifier hs-var">node_payload</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeDetails
</span><a href="#local-6989586621682711233"><span class="hs-identifier hs-var">details</span></a></span><span>
</span><span id="line-1698"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">node_key :: Unique
</span><a href="GHC.Data.Graph.Directed.html#node_key"><span class="hs-identifier hs-var">node_key</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique
</span><a href="GHC.Types.Var.html#varUnique"><span class="hs-identifier hs-var">varUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711230"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1699"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">node_dependencies :: [Unique]
</span><a href="GHC.Data.Graph.Directed.html#node_dependencies"><span class="hs-identifier hs-var">node_dependencies</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Unique]
forall elt. UniqSet elt -&gt; [Unique]
</span><a href="GHC.Types.Unique.Set.html#nonDetKeysUniqSet"><span class="hs-identifier hs-var">nonDetKeysUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711238"><span class="hs-identifier hs-var">scope_fvs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1700"></span><span>    </span><span class="hs-comment">-- It's OK to use nonDetKeysUniqSet here as stronglyConnCompFromEdgedVerticesR</span><span>
</span><span id="line-1701"></span><span>    </span><span class="hs-comment">-- is still deterministic with edges in nondeterministic order as</span><span>
</span><span id="line-1702"></span><span>    </span><span class="hs-comment">-- explained in Note [Deterministic SCC] in GHC.Data.Graph.Directed.</span><span>
</span><span id="line-1703"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1704"></span><span>    </span><span id="local-6989586621682711233"><span class="annot"><span class="annottext">details :: NodeDetails
</span><a href="#local-6989586621682711233"><span class="hs-identifier hs-var hs-var">details</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ND"><span class="hs-identifier hs-type">ND</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">nd_bndr :: Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var">nd_bndr</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711239"><span class="hs-identifier hs-var">bndr'</span></a></span><span>
</span><span id="line-1705"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_rhs :: WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_rhs"><span class="hs-identifier hs-var">nd_rhs</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailUsageDetails -&gt; CoreExpr -&gt; WithTailUsageDetails CoreExpr
forall a. TailUsageDetails -&gt; a -&gt; WithTailUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-var">WTUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; UsageDetails -&gt; TailUsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-var">TUD</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711241"><span class="hs-identifier hs-var">rhs_ja</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711242"><span class="hs-identifier hs-var">unadj_scope_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711243"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-1706"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_inl :: VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_inl"><span class="hs-identifier hs-var">nd_inl</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711244"><span class="hs-identifier hs-var">inl_fvs</span></a></span><span>
</span><span id="line-1707"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_simple :: Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_simple"><span class="hs-identifier hs-var">nd_simple</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CoreRule, UsageDetails, UsageDetails)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(CoreRule, UsageDetails, UsageDetails)]
</span><a href="#local-6989586621682711245"><span class="hs-identifier hs-var">rules_w_uds</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682711246"><span class="hs-identifier hs-var">imp_rule_info</span></a></span><span>
</span><span id="line-1708"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_weak_fvs :: VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_weak_fvs"><span class="hs-identifier hs-var">nd_weak_fvs</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711247"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span>
</span><span id="line-1709"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_active_rule_fvs :: VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_active_rule_fvs"><span class="hs-identifier hs-var">nd_active_rule_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711248"><span class="hs-identifier hs-var">active_rule_fvs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1710"></span><span>
</span><span id="line-1711"></span><span>    </span><span id="local-6989586621682711239"><span class="annot"><span class="annottext">bndr' :: Id
</span><a href="#local-6989586621682711239"><span class="hs-identifier hs-var hs-var">bndr'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#noBinderSwaps"><span class="hs-identifier hs-var">noBinderSwaps</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711227"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711230"><span class="hs-identifier hs-var">bndr</span></a></span><span>  </span><span class="hs-comment">-- See Note [Unfoldings and rules]</span><span>
</span><span id="line-1712"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711230"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unfolding -&gt; Id
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span>      </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711249"><span class="hs-identifier hs-var">unf'</span></a></span><span>
</span><span id="line-1713"></span><span>                                     </span><span class="annot"><span class="annottext">Id -&gt; RuleInfo -&gt; Id
</span><a href="GHC.Types.Id.html#setIdSpecialisation"><span class="hs-operator hs-var">`setIdSpecialisation`</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; RuleInfo
</span><a href="GHC.Core.FVs.html#mkRuleInfo"><span class="hs-identifier hs-var">mkRuleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682711250"><span class="hs-identifier hs-var">rules'</span></a></span><span>
</span><span id="line-1714"></span><span>
</span><span id="line-1715"></span><span>    </span><span class="hs-comment">-- NB: Both adj_unf_uds and adj_rule_uds have been adjusted to match the</span><span>
</span><span id="line-1716"></span><span>    </span><span class="hs-comment">--     JoinArity rhs_ja of unadj_rhs_uds.</span><span>
</span><span id="line-1717"></span><span>    </span><span id="local-6989586621682711251"><span class="annot"><span class="annottext">unadj_inl_uds :: UsageDetails
</span><a href="#local-6989586621682711251"><span class="hs-identifier hs-var hs-var">unadj_inl_uds</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711252"><span class="hs-identifier hs-var">unadj_rhs_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711253"><span class="hs-identifier hs-var">adj_unf_uds</span></a></span><span>
</span><span id="line-1718"></span><span>    </span><span id="local-6989586621682711242"><span class="annot"><span class="annottext">unadj_scope_uds :: UsageDetails
</span><a href="#local-6989586621682711242"><span class="hs-identifier hs-var hs-var">unadj_scope_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711251"><span class="hs-identifier hs-var">unadj_inl_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711254"><span class="hs-identifier hs-var">adj_rule_uds</span></a></span><span>
</span><span id="line-1719"></span><span>                   </span><span class="hs-comment">-- Note [Rules are extra RHSs]</span><span>
</span><span id="line-1720"></span><span>                   </span><span class="hs-comment">-- Note [Rule dependency info]</span><span>
</span><span id="line-1721"></span><span>    </span><span id="local-6989586621682711238"><span class="annot"><span class="annottext">scope_fvs :: VarSet
</span><a href="#local-6989586621682711238"><span class="hs-identifier hs-var hs-var">scope_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; UsageDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#udFreeVars"><span class="hs-identifier hs-var">udFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711229"><span class="hs-identifier hs-var">bndr_set</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711242"><span class="hs-identifier hs-var">unadj_scope_uds</span></a></span><span>
</span><span id="line-1722"></span><span>    </span><span class="hs-comment">-- scope_fvs: all occurrences from this binder: RHS, unfolding,</span><span>
</span><span id="line-1723"></span><span>    </span><span class="hs-comment">--            and RULES, both LHS and RHS thereof, active or inactive</span><span>
</span><span id="line-1724"></span><span>
</span><span id="line-1725"></span><span>    </span><span id="local-6989586621682711244"><span class="annot"><span class="annottext">inl_fvs :: VarSet
</span><a href="#local-6989586621682711244"><span class="hs-identifier hs-var hs-var">inl_fvs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; UsageDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#udFreeVars"><span class="hs-identifier hs-var">udFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711229"><span class="hs-identifier hs-var">bndr_set</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711251"><span class="hs-identifier hs-var">unadj_inl_uds</span></a></span><span>
</span><span id="line-1726"></span><span>    </span><span class="hs-comment">-- inl_fvs: vars that would become free if the function was inlined.</span><span>
</span><span id="line-1727"></span><span>    </span><span class="hs-comment">-- We conservatively approximate that by the free vars from the RHS</span><span>
</span><span id="line-1728"></span><span>    </span><span class="hs-comment">-- and the unfolding together.</span><span>
</span><span id="line-1729"></span><span>    </span><span class="hs-comment">-- See Note [inl_fvs]</span><span>
</span><span id="line-1730"></span><span>
</span><span id="line-1731"></span><span>
</span><span id="line-1732"></span><span>    </span><span class="hs-comment">--------- Right hand side ---------</span><span>
</span><span id="line-1733"></span><span>    </span><span class="hs-comment">-- Constructing the edges for the main Rec computation</span><span>
</span><span id="line-1734"></span><span>    </span><span class="hs-comment">-- See Note [Forming Rec groups]</span><span>
</span><span id="line-1735"></span><span>    </span><span class="hs-comment">-- and Note [TailUsageDetails when forming Rec groups]</span><span>
</span><span id="line-1736"></span><span>    </span><span class="hs-comment">-- Compared to occAnalNonRecBind, we can't yet adjust the RHS because</span><span>
</span><span id="line-1737"></span><span>    </span><span class="hs-comment">--   (a) we don't yet know the final joinpointhood. It might not become a</span><span>
</span><span id="line-1738"></span><span>    </span><span class="hs-comment">--       join point after all!</span><span>
</span><span id="line-1739"></span><span>    </span><span class="hs-comment">--   (b) we don't even know whether it stays a recursive RHS after the SCC</span><span>
</span><span id="line-1740"></span><span>    </span><span class="hs-comment">--       analysis we are about to seed! So we can't markAllInsideLam in</span><span>
</span><span id="line-1741"></span><span>    </span><span class="hs-comment">--       advance, because if it ends up as a non-recursive join point we'll</span><span>
</span><span id="line-1742"></span><span>    </span><span class="hs-comment">--       consider it as one-shot and don't need to markAllInsideLam.</span><span>
</span><span id="line-1743"></span><span>    </span><span class="hs-comment">-- Instead, do the occAnalLamTail call here and postpone adjustTailUsage</span><span>
</span><span id="line-1744"></span><span>    </span><span class="hs-comment">-- until occAnalRec. In effect, we pretend that the RHS becomes a</span><span>
</span><span id="line-1745"></span><span>    </span><span class="hs-comment">-- non-recursive join point and fix up later with adjustTailUsage.</span><span>
</span><span id="line-1746"></span><span>    </span><span id="local-6989586621682711256"><span class="annot"><span class="annottext">rhs_env :: OccEnv
</span><a href="#local-6989586621682711256"><span class="hs-identifier hs-var hs-var">rhs_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; RecFlag -&gt; OccEncl -&gt; JoinPointHood -&gt; Id -&gt; CoreExpr -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#mkRhsOccEnv"><span class="hs-identifier hs-var">mkRhsOccEnv</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711227"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a></span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccRhs"><span class="hs-identifier hs-var">OccRhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711230"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711230"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711231"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1747"></span><span>            </span><span class="hs-comment">-- If bndr isn't an /existing/ join point (so idJoinPointHood = NotJoinPoint),</span><span>
</span><span id="line-1748"></span><span>            </span><span class="hs-comment">-- it's safe to zap the occ_join_points, because they can't occur in RHS.</span><span>
</span><span id="line-1749"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-type">TUD</span></a></span><span> </span><span id="local-6989586621682711241"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711241"><span class="hs-identifier hs-var">rhs_ja</span></a></span></span><span> </span><span id="local-6989586621682711252"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711252"><span class="hs-identifier hs-var">unadj_rhs_uds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711243"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711243"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalLamTail"><span class="hs-identifier hs-var">occAnalLamTail</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711256"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711231"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1750"></span><span>      </span><span class="hs-comment">-- The corresponding call to adjustTailUsage is in occAnalRec and tagRecBinders</span><span>
</span><span id="line-1751"></span><span>
</span><span id="line-1752"></span><span>    </span><span class="hs-comment">--------- Unfolding ---------</span><span>
</span><span id="line-1753"></span><span>    </span><span class="hs-comment">-- See Note [Join points and unfoldings/rules]</span><span>
</span><span id="line-1754"></span><span>    </span><span id="local-6989586621682711258"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682711258"><span class="hs-identifier hs-var hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711230"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-comment">-- realIdUnfolding: Ignore loop-breaker-ness</span><span>
</span><span id="line-1755"></span><span>                               </span><span class="hs-comment">-- here because that is what we are setting!</span><span>
</span><span id="line-1756"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span id="local-6989586621682711260"><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711260"><span class="hs-identifier hs-var">unf_tuds</span></a></span></span><span> </span><span id="local-6989586621682711249"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711249"><span class="hs-identifier hs-var">unf'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Unfolding -&gt; WithTailUsageDetails Unfolding
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalUnfolding"><span class="hs-identifier hs-var">occAnalUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711256"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711258"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-1757"></span><span>    </span><span id="local-6989586621682711253"><span class="annot"><span class="annottext">adj_unf_uds :: UsageDetails
</span><a href="#local-6989586621682711253"><span class="hs-identifier hs-var hs-var">adj_unf_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointHood -&gt; TailUsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustTailArity"><span class="hs-identifier hs-var">adjustTailArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; JoinPointHood
</span><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-var">JoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711241"><span class="hs-identifier hs-var">rhs_ja</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711260"><span class="hs-identifier hs-var">unf_tuds</span></a></span><span>
</span><span id="line-1758"></span><span>      </span><span class="hs-comment">-- `rhs_ja` is `joinRhsArity rhs` and is the prediction for source M</span><span>
</span><span id="line-1759"></span><span>      </span><span class="hs-comment">-- of Note [Join arity prediction based on joinRhsArity]</span><span>
</span><span id="line-1760"></span><span>
</span><span id="line-1761"></span><span>    </span><span class="hs-comment">--------- IMP-RULES --------</span><span>
</span><span id="line-1762"></span><span>    </span><span id="local-6989586621682711261"><span class="annot"><span class="annottext">is_active :: Activation -&gt; Bool
</span><a href="#local-6989586621682711261"><span class="hs-identifier hs-var hs-var">is_active</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Activation -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_rule_act"><span class="hs-identifier hs-var">occ_rule_act</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711227"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1763"></span><span>    </span><span id="local-6989586621682711246"><span class="annot"><span class="annottext">imp_rule_info :: [(Activation, VarSet)]
</span><a href="#local-6989586621682711246"><span class="hs-identifier hs-var hs-var">imp_rule_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges -&gt; Id -&gt; [(Activation, VarSet)]
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupImpRules"><span class="hs-identifier hs-var">lookupImpRules</span></a></span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="#local-6989586621682711228"><span class="hs-identifier hs-var">imp_rule_edges</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711230"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1764"></span><span>    </span><span id="local-6989586621682711262"><span class="annot"><span class="annottext">imp_rule_uds :: UsageDetails
</span><a href="#local-6989586621682711262"><span class="hs-identifier hs-var hs-var">imp_rule_uds</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#impRulesScopeUsage"><span class="hs-identifier hs-var">impRulesScopeUsage</span></a></span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682711246"><span class="hs-identifier hs-var">imp_rule_info</span></a></span><span>
</span><span id="line-1765"></span><span>    </span><span id="local-6989586621682711263"><span class="annot"><span class="annottext">imp_rule_fvs :: VarSet
</span><a href="#local-6989586621682711263"><span class="hs-identifier hs-var hs-var">imp_rule_fvs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Activation -&gt; Bool) -&gt; VarSet -&gt; [(Activation, VarSet)] -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#impRulesActiveFvs"><span class="hs-identifier hs-var">impRulesActiveFvs</span></a></span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682711261"><span class="hs-identifier hs-var">is_active</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711229"><span class="hs-identifier hs-var">bndr_set</span></a></span><span> </span><span class="annot"><span class="annottext">[(Activation, VarSet)]
</span><a href="#local-6989586621682711246"><span class="hs-identifier hs-var">imp_rule_info</span></a></span><span>
</span><span id="line-1766"></span><span>
</span><span id="line-1767"></span><span>    </span><span class="hs-comment">--------- All rules --------</span><span>
</span><span id="line-1768"></span><span>    </span><span class="hs-comment">-- See Note [Join points and unfoldings/rules]</span><span>
</span><span id="line-1769"></span><span>    </span><span class="hs-comment">-- `rhs_ja` is `joinRhsArity rhs'` and is the prediction for source M</span><span>
</span><span id="line-1770"></span><span>    </span><span class="hs-comment">-- of Note [Join arity prediction based on joinRhsArity]</span><span>
</span><span id="line-1771"></span><span>    </span><span class="annot"><a href="#local-6989586621682711245"><span class="hs-identifier hs-type">rules_w_uds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1772"></span><span>    </span><span id="local-6989586621682711245"><span class="annot"><span class="annottext">rules_w_uds :: [(CoreRule, UsageDetails, UsageDetails)]
</span><a href="#local-6989586621682711245"><span class="hs-identifier hs-var hs-var">rules_w_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711264"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711265"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">JoinPointHood -&gt; TailUsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustTailArity"><span class="hs-identifier hs-var">adjustTailArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; JoinPointHood
</span><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-var">JoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711241"><span class="hs-identifier hs-var">rhs_ja</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711266"><span class="hs-identifier hs-var">rhs_wuds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1773"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682711267"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711267"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711230"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1774"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711264"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711264"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682711265"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711265"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682711266"><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682711266"><span class="hs-identifier hs-var">rhs_wuds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreRule -&gt; (CoreRule, UsageDetails, TailUsageDetails)
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalRule"><span class="hs-identifier hs-var">occAnalRule</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711256"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711267"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1775"></span><span>    </span><span id="local-6989586621682711250"><span class="annot"><span class="annottext">rules' :: [CoreRule]
</span><a href="#local-6989586621682711250"><span class="hs-identifier hs-var hs-var">rules'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreRule, UsageDetails, UsageDetails) -&gt; CoreRule)
-&gt; [(CoreRule, UsageDetails, UsageDetails)] -&gt; [CoreRule]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CoreRule, UsageDetails, UsageDetails) -&gt; CoreRule
forall a b c. (a, b, c) -&gt; a
</span><a href="GHC.Utils.Misc.html#fstOf3"><span class="hs-identifier hs-var">fstOf3</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreRule, UsageDetails, UsageDetails)]
</span><a href="#local-6989586621682711245"><span class="hs-identifier hs-var">rules_w_uds</span></a></span><span>
</span><span id="line-1776"></span><span>
</span><span id="line-1777"></span><span>    </span><span id="local-6989586621682711254"><span class="annot"><span class="annottext">adj_rule_uds :: UsageDetails
</span><a href="#local-6989586621682711254"><span class="hs-identifier hs-var hs-var">adj_rule_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreRule, UsageDetails, UsageDetails)
 -&gt; UsageDetails -&gt; UsageDetails)
-&gt; UsageDetails
-&gt; [(CoreRule, UsageDetails, UsageDetails)]
-&gt; UsageDetails
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">(CoreRule, UsageDetails, UsageDetails)
-&gt; UsageDetails -&gt; UsageDetails
forall {a}.
(a, UsageDetails, UsageDetails) -&gt; UsageDetails -&gt; UsageDetails
</span><a href="#local-6989586621682711268"><span class="hs-identifier hs-var">add_rule_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711262"><span class="hs-identifier hs-var">imp_rule_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreRule, UsageDetails, UsageDetails)]
</span><a href="#local-6989586621682711245"><span class="hs-identifier hs-var">rules_w_uds</span></a></span><span>
</span><span id="line-1778"></span><span>    </span><span id="local-6989586621682711268"><span class="annot"><span class="annottext">add_rule_uds :: (a, UsageDetails, UsageDetails) -&gt; UsageDetails -&gt; UsageDetails
</span><a href="#local-6989586621682711268"><span class="hs-identifier hs-var hs-var">add_rule_uds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711269"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711269"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711270"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711270"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711271"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711271"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711269"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711270"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711271"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-1779"></span><span>
</span><span id="line-1780"></span><span>    </span><span class="hs-comment">-------- active_rule_fvs ------------</span><span>
</span><span id="line-1781"></span><span>    </span><span id="local-6989586621682711248"><span class="annot"><span class="annottext">active_rule_fvs :: VarSet
</span><a href="#local-6989586621682711248"><span class="hs-identifier hs-var hs-var">active_rule_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreRule, UsageDetails, UsageDetails) -&gt; VarSet -&gt; VarSet)
-&gt; VarSet -&gt; [(CoreRule, UsageDetails, UsageDetails)] -&gt; VarSet
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">(CoreRule, UsageDetails, UsageDetails) -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621682711272"><span class="hs-identifier hs-var">add_active_rule</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711263"><span class="hs-identifier hs-var">imp_rule_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreRule, UsageDetails, UsageDetails)]
</span><a href="#local-6989586621682711245"><span class="hs-identifier hs-var">rules_w_uds</span></a></span><span>
</span><span id="line-1782"></span><span>    </span><span id="local-6989586621682711272"><span class="annot"><span class="annottext">add_active_rule :: (CoreRule, UsageDetails, UsageDetails) -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621682711272"><span class="hs-identifier hs-var hs-var">add_active_rule</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711273"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711273"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711274"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711274"><span class="hs-identifier hs-var">rhs_uds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711275"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711275"><span class="hs-identifier hs-var">fvs</span></a></span></span><span>
</span><span id="line-1783"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682711261"><span class="hs-identifier hs-var">is_active</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; Activation
</span><a href="GHC.Core.html#ruleActivation"><span class="hs-identifier hs-var">ruleActivation</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711273"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1784"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; UsageDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#udFreeVars"><span class="hs-identifier hs-var">udFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711229"><span class="hs-identifier hs-var">bndr_set</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711274"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711275"><span class="hs-identifier hs-var">fvs</span></a></span><span>
</span><span id="line-1785"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1786"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711275"><span class="hs-identifier hs-var">fvs</span></a></span><span>
</span><span id="line-1787"></span><span>
</span><span id="line-1788"></span><span>    </span><span class="hs-comment">-------- weak_fvs ------------</span><span>
</span><span id="line-1789"></span><span>    </span><span class="hs-comment">-- See Note [Weak loop breakers]</span><span>
</span><span id="line-1790"></span><span>    </span><span id="local-6989586621682711247"><span class="annot"><span class="annottext">weak_fvs :: VarSet
</span><a href="#local-6989586621682711247"><span class="hs-identifier hs-var hs-var">weak_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreRule, UsageDetails, UsageDetails) -&gt; VarSet -&gt; VarSet)
-&gt; VarSet -&gt; [(CoreRule, UsageDetails, UsageDetails)] -&gt; VarSet
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">(CoreRule, UsageDetails, UsageDetails) -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621682711277"><span class="hs-identifier hs-var">add_rule</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreRule, UsageDetails, UsageDetails)]
</span><a href="#local-6989586621682711245"><span class="hs-identifier hs-var">rules_w_uds</span></a></span><span>
</span><span id="line-1791"></span><span>    </span><span id="local-6989586621682711277"><span class="annot"><span class="annottext">add_rule :: (CoreRule, UsageDetails, UsageDetails) -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621682711277"><span class="hs-identifier hs-var hs-var">add_rule</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711278"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711278"><span class="hs-identifier hs-var">rhs_uds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711279"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711279"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; UsageDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#udFreeVars"><span class="hs-identifier hs-var">udFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711229"><span class="hs-identifier hs-var">bndr_set</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711278"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711279"><span class="hs-identifier hs-var">fvs</span></a></span><span>
</span><span id="line-1792"></span><span>
</span><span id="line-1793"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#mkLoopBreakerNodes"><span class="hs-identifier hs-type">mkLoopBreakerNodes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-1794"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>   </span><span class="hs-comment">-- for BODY of let</span><span>
</span><span id="line-1795"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeDetails"><span class="hs-identifier hs-type">NodeDetails</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1796"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LoopBreakerNode"><span class="hs-identifier hs-type">LoopBreakerNode</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- with OccInfo up-to-date</span><span>
</span><span id="line-1797"></span><span class="hs-comment">-- See Note [Choosing loop breakers]</span><span>
</span><span id="line-1798"></span><span class="hs-comment">-- This function primarily creates the Nodes for the</span><span>
</span><span id="line-1799"></span><span class="hs-comment">-- loop-breaker SCC analysis.  More specifically:</span><span>
</span><span id="line-1800"></span><span class="hs-comment">--   a) tag each binder with its occurrence info</span><span>
</span><span id="line-1801"></span><span class="hs-comment">--   b) add a NodeScore to each node</span><span>
</span><span id="line-1802"></span><span class="hs-comment">--   c) make a Node with the right dependency edges for</span><span>
</span><span id="line-1803"></span><span class="hs-comment">--      the loop-breaker SCC analysis</span><span>
</span><span id="line-1804"></span><span class="hs-comment">--   d) adjust each RHS's usage details according to</span><span>
</span><span id="line-1805"></span><span class="hs-comment">--      the binder's (new) shotness and join-point-hood</span><span>
</span><span id="line-1806"></span><span id="mkLoopBreakerNodes"><span class="annot"><span class="annottext">mkLoopBreakerNodes :: OccEnv
-&gt; TopLevelFlag
-&gt; UsageDetails
-&gt; [NodeDetails]
-&gt; WithUsageDetails [LoopBreakerNode]
</span><a href="GHC.Core.Opt.OccurAnal.html#mkLoopBreakerNodes"><span class="hs-identifier hs-var hs-var">mkLoopBreakerNodes</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711280"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711280"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711281"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711281"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682711282"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711282"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span> </span><span id="local-6989586621682711283"><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682711283"><span class="hs-identifier hs-var">details_s</span></a></span></span><span>
</span><span id="line-1807"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
-&gt; [LoopBreakerNode] -&gt; WithUsageDetails [LoopBreakerNode]
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711284"><span class="hs-identifier hs-var">final_uds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
-&gt; (NodeDetails -&gt; Id -&gt; LoopBreakerNode)
-&gt; [NodeDetails]
-&gt; [Id]
-&gt; [LoopBreakerNode]
forall a b c.
HasDebugCallStack =&gt;
String -&gt; (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="GHC.Utils.Misc.html#zipWithEqual"><span class="hs-identifier hs-var">zipWithEqual</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mkLoopBreakerNodes&quot;</span></span><span> </span><span class="annot"><span class="annottext">NodeDetails -&gt; Id -&gt; LoopBreakerNode
</span><a href="#local-6989586621682711286"><span class="hs-identifier hs-var">mk_lb_node</span></a></span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682711283"><span class="hs-identifier hs-var">details_s</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711287"><span class="hs-identifier hs-var">bndrs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1808"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1809"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711284"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711284"><span class="hs-identifier hs-var">final_uds</span></a></span></span><span> </span><span id="local-6989586621682711287"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711287"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; UsageDetails -&gt; [NodeDetails] -&gt; WithUsageDetails [Id]
</span><a href="GHC.Core.Opt.OccurAnal.html#tagRecBinders"><span class="hs-identifier hs-var">tagRecBinders</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682711281"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711282"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682711283"><span class="hs-identifier hs-var">details_s</span></a></span><span>
</span><span id="line-1810"></span><span>
</span><span id="line-1811"></span><span>    </span><span id="local-6989586621682711286"><span class="annot"><span class="annottext">mk_lb_node :: NodeDetails -&gt; Id -&gt; LoopBreakerNode
</span><a href="#local-6989586621682711286"><span class="hs-identifier hs-var hs-var">mk_lb_node</span></a></span></span><span> </span><span id="local-6989586621682711289"><span class="annot"><span class="annottext">nd :: NodeDetails
</span><a href="#local-6989586621682711289"><span class="hs-identifier hs-var">nd</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ND"><span class="hs-identifier hs-type">ND</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">nd_bndr :: NodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var">nd_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711290"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711290"><span class="hs-identifier hs-var">old_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_inl :: NodeDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_inl"><span class="hs-identifier hs-var">nd_inl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711291"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711291"><span class="hs-identifier hs-var">inl_fvs</span></a></span></span><span>
</span><span id="line-1812"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_rhs :: NodeDetails -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_rhs"><span class="hs-identifier hs-var">nd_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span class="annot"><span class="annottext">TailUsageDetails
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711292"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711292"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711293"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711293"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span>
</span><span id="line-1813"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html#DigraphNode"><span class="hs-identifier hs-type">DigraphNode</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">node_payload :: SimpleNodeDetails
</span><a href="GHC.Data.Graph.Directed.html#node_payload"><span class="hs-identifier hs-var">node_payload</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimpleNodeDetails
</span><a href="#local-6989586621682711294"><span class="hs-identifier hs-var">simple_nd</span></a></span><span>
</span><span id="line-1814"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">node_key :: Unique
</span><a href="GHC.Data.Graph.Directed.html#node_key"><span class="hs-identifier hs-var">node_key</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique
</span><a href="GHC.Types.Var.html#varUnique"><span class="hs-identifier hs-var">varUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711290"><span class="hs-identifier hs-var">old_bndr</span></a></span><span>
</span><span id="line-1815"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">node_dependencies :: [Unique]
</span><a href="GHC.Data.Graph.Directed.html#node_dependencies"><span class="hs-identifier hs-var">node_dependencies</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Unique]
forall elt. UniqSet elt -&gt; [Unique]
</span><a href="GHC.Types.Unique.Set.html#nonDetKeysUniqSet"><span class="hs-identifier hs-var">nonDetKeysUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711295"><span class="hs-identifier hs-var">lb_deps</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1816"></span><span>              </span><span class="hs-comment">-- It's OK to use nonDetKeysUniqSet here as</span><span>
</span><span id="line-1817"></span><span>              </span><span class="hs-comment">-- stronglyConnCompFromEdgedVerticesR is still deterministic with edges</span><span>
</span><span id="line-1818"></span><span>              </span><span class="hs-comment">-- in nondeterministic order as explained in</span><span>
</span><span id="line-1819"></span><span>              </span><span class="hs-comment">-- Note [Deterministic SCC] in GHC.Data.Graph.Directed.</span><span>
</span><span id="line-1820"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1821"></span><span>        </span><span id="local-6989586621682711294"><span class="annot"><span class="annottext">simple_nd :: SimpleNodeDetails
</span><a href="#local-6989586621682711294"><span class="hs-identifier hs-var hs-var">simple_nd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#SND"><span class="hs-identifier hs-type">SND</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">snd_bndr :: Id
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_bndr"><span class="hs-identifier hs-var">snd_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711293"><span class="hs-identifier hs-var">new_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">snd_rhs :: CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_rhs"><span class="hs-identifier hs-var">snd_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711292"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">snd_score :: NodeScore
</span><a href="GHC.Core.Opt.OccurAnal.html#snd_score"><span class="hs-identifier hs-var">snd_score</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeScore
</span><a href="#local-6989586621682711296"><span class="hs-identifier hs-var">score</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1822"></span><span>        </span><span id="local-6989586621682711296"><span class="annot"><span class="annottext">score :: NodeScore
</span><a href="#local-6989586621682711296"><span class="hs-identifier hs-var hs-var">score</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Id -&gt; VarSet -&gt; NodeDetails -&gt; NodeScore
</span><a href="GHC.Core.Opt.OccurAnal.html#nodeScore"><span class="hs-identifier hs-var">nodeScore</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711280"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711293"><span class="hs-identifier hs-var">new_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711295"><span class="hs-identifier hs-var">lb_deps</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDetails
</span><a href="#local-6989586621682711289"><span class="hs-identifier hs-var">nd</span></a></span><span>
</span><span id="line-1823"></span><span>        </span><span id="local-6989586621682711295"><span class="annot"><span class="annottext">lb_deps :: VarSet
</span><a href="#local-6989586621682711295"><span class="hs-identifier hs-var hs-var">lb_deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#extendFvs_"><span class="hs-identifier hs-var">extendFvs_</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711299"><span class="hs-identifier hs-var">rule_fv_env</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711291"><span class="hs-identifier hs-var">inl_fvs</span></a></span><span>
</span><span id="line-1824"></span><span>        </span><span class="hs-comment">-- See Note [Loop breaker dependencies]</span><span>
</span><span id="line-1825"></span><span>
</span><span id="line-1826"></span><span>    </span><span class="annot"><a href="#local-6989586621682711299"><span class="hs-identifier hs-type">rule_fv_env</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span>
</span><span id="line-1827"></span><span>    </span><span class="hs-comment">-- Maps a variable f to the variables from this group</span><span>
</span><span id="line-1828"></span><span>    </span><span class="hs-comment">--      reachable by a sequence of RULES starting with f</span><span>
</span><span id="line-1829"></span><span>    </span><span class="hs-comment">-- Domain is *subset* of bound vars (others have no rule fvs)</span><span>
</span><span id="line-1830"></span><span>    </span><span class="hs-comment">-- See Note [Finding rule RHS free vars]</span><span>
</span><span id="line-1831"></span><span>    </span><span class="hs-comment">-- Why transClosureFV?  See Note [Loop breaker dependencies]</span><span>
</span><span id="line-1832"></span><span>    </span><span id="local-6989586621682711299"><span class="annot"><span class="annottext">rule_fv_env :: VarEnv VarSet
</span><a href="#local-6989586621682711299"><span class="hs-identifier hs-var hs-var">rule_fv_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet -&gt; VarEnv VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#transClosureFV"><span class="hs-identifier hs-var">transClosureFV</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEnv VarSet -&gt; VarEnv VarSet) -&gt; VarEnv VarSet -&gt; VarEnv VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Id, VarSet)] -&gt; VarEnv VarSet
forall a. [(Id, a)] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">([(Id, VarSet)] -&gt; VarEnv VarSet)
-&gt; [(Id, VarSet)] -&gt; VarEnv VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1833"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711302"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711303"><span class="hs-identifier hs-var">rule_fvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1834"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ND"><span class="hs-identifier hs-type">ND</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">nd_bndr :: NodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var">nd_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711302"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711302"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_active_rule_fvs :: NodeDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_active_rule_fvs"><span class="hs-identifier hs-var">nd_active_rule_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711303"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711303"><span class="hs-identifier hs-var">rule_fvs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682711283"><span class="hs-identifier hs-var">details_s</span></a></span><span>
</span><span id="line-1835"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711303"><span class="hs-identifier hs-var">rule_fvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1836"></span><span>
</span><span id="line-1837"></span><span class="hs-comment">{- Note [Loop breaker dependencies]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The loop breaker dependencies of x in a recursive
group { f1 = e1; ...; fn = en } are:

- The &quot;inline free variables&quot; of f: the fi free in
  f's stable unfolding and RHS; see Note [inl_fvs]

- Any fi reachable from those inline free variables by a sequence
  of RULE rewrites.  Remember, rule rewriting is not affected
  by fi being a loop breaker, so we have to take the transitive
  closure in case f is the only possible loop breaker in the loop.

  Hence rule_fv_env.  We need only account for /active/ rules.
-}</span><span>
</span><span id="line-1852"></span><span>
</span><span id="line-1853"></span><span class="hs-comment">------------------------------------------</span><span>
</span><span id="line-1854"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#nodeScore"><span class="hs-identifier hs-type">nodeScore</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-1855"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>        </span><span class="hs-comment">-- Binder with new occ-info</span><span>
</span><span id="line-1856"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>    </span><span class="hs-comment">-- Loop-breaker dependencies</span><span>
</span><span id="line-1857"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeDetails"><span class="hs-identifier hs-type">NodeDetails</span></a></span><span>
</span><span id="line-1858"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a></span><span>
</span><span id="line-1859"></span><span id="nodeScore"><span class="annot"><span class="annottext">nodeScore :: OccEnv -&gt; Id -&gt; VarSet -&gt; NodeDetails -&gt; NodeScore
</span><a href="GHC.Core.Opt.OccurAnal.html#nodeScore"><span class="hs-identifier hs-var hs-var">nodeScore</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711305"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711305"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711306"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711306"><span class="hs-identifier hs-var">new_bndr</span></a></span></span><span> </span><span id="local-6989586621682711307"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711307"><span class="hs-identifier hs-var">lb_deps</span></a></span></span><span>
</span><span id="line-1860"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ND"><span class="hs-identifier hs-type">ND</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">nd_bndr :: NodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var">nd_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711308"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711308"><span class="hs-identifier hs-var">old_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_rhs :: NodeDetails -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_rhs"><span class="hs-identifier hs-var">nd_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span class="annot"><span class="annottext">TailUsageDetails
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711309"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711309"><span class="hs-identifier hs-var">bind_rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1861"></span><span>
</span><span id="line-1862"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711308"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- A type or coercion variable is never a loop breaker</span><span>
</span><span id="line-1863"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">100</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-1864"></span><span>
</span><span id="line-1865"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711308"><span class="hs-identifier hs-var">old_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711307"><span class="hs-identifier hs-var">lb_deps</span></a></span><span>  </span><span class="hs-comment">-- Self-recursive things are great loop breakers</span><span>
</span><span id="line-1866"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>                   </span><span class="hs-comment">-- See Note [Self-recursion and loop breakers]</span><span>
</span><span id="line-1867"></span><span>
</span><span id="line-1868"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_unf_act"><span class="hs-identifier hs-var">occ_unf_act</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711305"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711308"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- A binder whose inlining is inactive (e.g. has</span><span>
</span><span id="line-1869"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>                   </span><span class="hs-comment">-- a NOINLINE pragma) makes a great loop breaker</span><span>
</span><span id="line-1870"></span><span>
</span><span id="line-1871"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711311"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1872"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; NodeScore
</span><a href="#local-6989586621682711312"><span class="hs-identifier hs-var">mk_score</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">10</span></span><span>  </span><span class="hs-comment">-- Practically certain to be inlined</span><span>
</span><span id="line-1873"></span><span>    </span><span class="hs-comment">-- Used to have also: &amp;&amp; not (isExportedId bndr)</span><span>
</span><span id="line-1874"></span><span>    </span><span class="hs-comment">-- But I found this sometimes cost an extra iteration when we have</span><span>
</span><span id="line-1875"></span><span>    </span><span class="hs-comment">--      rec { d = (a,b); a = ...df...; b = ...df...; df = d }</span><span>
</span><span id="line-1876"></span><span>    </span><span class="hs-comment">-- where df is the exported dictionary. Then df makes a really</span><span>
</span><span id="line-1877"></span><span>    </span><span class="hs-comment">-- bad choice for loop breaker</span><span>
</span><span id="line-1878"></span><span>
</span><span id="line-1879"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#DFunUnfolding"><span class="hs-identifier hs-type">DFunUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">df_args :: Unfolding -&gt; [CoreExpr]
</span><a href="GHC.Core.html#df_args"><span class="hs-identifier hs-var">df_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711315"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711315"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711316"><span class="hs-identifier hs-var">old_unf</span></a></span><span>
</span><span id="line-1880"></span><span>    </span><span class="hs-comment">-- Never choose a DFun as a loop breaker</span><span>
</span><span id="line-1881"></span><span>    </span><span class="hs-comment">-- Note [DFuns should not be loop breakers]</span><span>
</span><span id="line-1882"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">9</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; JoinArity
forall a. [a] -&gt; JoinArity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; JoinArity
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711315"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711318"><span class="hs-identifier hs-var">is_lb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1883"></span><span>
</span><span id="line-1884"></span><span>    </span><span class="hs-comment">-- Data structures are more important than INLINE pragmas</span><span>
</span><span id="line-1885"></span><span>    </span><span class="hs-comment">-- so that dictionary/method recursion unravels</span><span>
</span><span id="line-1886"></span><span>
</span><span id="line-1887"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_guidance :: Unfolding -&gt; UnfoldingGuidance
</span><a href="GHC.Core.html#uf_guidance"><span class="hs-identifier hs-var">uf_guidance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711316"><span class="hs-identifier hs-var">old_unf</span></a></span><span>
</span><span id="line-1888"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; NodeScore
</span><a href="#local-6989586621682711312"><span class="hs-identifier hs-var">mk_score</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">6</span></span><span>
</span><span id="line-1889"></span><span>
</span><span id="line-1890"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall {b}. Expr b -&gt; Bool
</span><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711311"><span class="hs-identifier hs-var">rhs</span></a></span><span>   </span><span class="hs-comment">-- Data types help with cases:</span><span>
</span><span id="line-1891"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; NodeScore
</span><a href="#local-6989586621682711312"><span class="hs-identifier hs-var">mk_score</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">5</span></span><span>       </span><span class="hs-comment">-- Note [Constructor applications]</span><span>
</span><span id="line-1892"></span><span>
</span><span id="line-1893"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711316"><span class="hs-identifier hs-var">old_unf</span></a></span><span>
</span><span id="line-1894"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711323"><span class="hs-identifier hs-var">can_unfold</span></a></span><span>
</span><span id="line-1895"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; NodeScore
</span><a href="#local-6989586621682711312"><span class="hs-identifier hs-var">mk_score</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">3</span></span><span>
</span><span id="line-1896"></span><span>
</span><span id="line-1897"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOneOcc"><span class="hs-identifier hs-var">isOneOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711306"><span class="hs-identifier hs-var">new_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1898"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; NodeScore
</span><a href="#local-6989586621682711312"><span class="hs-identifier hs-var">mk_score</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">2</span></span><span>  </span><span class="hs-comment">-- Likely to be inlined</span><span>
</span><span id="line-1899"></span><span>
</span><span id="line-1900"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711323"><span class="hs-identifier hs-var">can_unfold</span></a></span><span>  </span><span class="hs-comment">-- The Id has some kind of unfolding</span><span>
</span><span id="line-1901"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; NodeScore
</span><a href="#local-6989586621682711312"><span class="hs-identifier hs-var">mk_score</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1902"></span><span>
</span><span id="line-1903"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1904"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711318"><span class="hs-identifier hs-var">is_lb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1905"></span><span>
</span><span id="line-1906"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1907"></span><span>    </span><span class="annot"><a href="#local-6989586621682711312"><span class="hs-identifier hs-type">mk_score</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a></span><span>
</span><span id="line-1908"></span><span>    </span><span id="local-6989586621682711312"><span class="annot"><span class="annottext">mk_score :: JoinArity -&gt; NodeScore
</span><a href="#local-6989586621682711312"><span class="hs-identifier hs-var hs-var">mk_score</span></a></span></span><span> </span><span id="local-6989586621682711325"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711325"><span class="hs-identifier hs-var">rank</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711325"><span class="hs-identifier hs-var">rank</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711326"><span class="hs-identifier hs-var">rhs_size</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711318"><span class="hs-identifier hs-var">is_lb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1909"></span><span>
</span><span id="line-1910"></span><span>    </span><span class="hs-comment">-- is_lb: see Note [Loop breakers, node scoring, and stability]</span><span>
</span><span id="line-1911"></span><span>    </span><span id="local-6989586621682711318"><span class="annot"><span class="annottext">is_lb :: Bool
</span><a href="#local-6989586621682711318"><span class="hs-identifier hs-var hs-var">is_lb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStrongLoopBreaker"><span class="hs-identifier hs-var">isStrongLoopBreaker</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711308"><span class="hs-identifier hs-var">old_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1912"></span><span>
</span><span id="line-1913"></span><span>    </span><span id="local-6989586621682711316"><span class="annot"><span class="annottext">old_unf :: Unfolding
</span><a href="#local-6989586621682711316"><span class="hs-identifier hs-var hs-var">old_unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711308"><span class="hs-identifier hs-var">old_bndr</span></a></span><span>
</span><span id="line-1914"></span><span>    </span><span id="local-6989586621682711323"><span class="annot"><span class="annottext">can_unfold :: Bool
</span><a href="#local-6989586621682711323"><span class="hs-identifier hs-var hs-var">can_unfold</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#canUnfold"><span class="hs-identifier hs-var">canUnfold</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711316"><span class="hs-identifier hs-var">old_unf</span></a></span><span>
</span><span id="line-1915"></span><span>    </span><span id="local-6989586621682711311"><span class="annot"><span class="annottext">rhs :: CoreExpr
</span><a href="#local-6989586621682711311"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711316"><span class="hs-identifier hs-var">old_unf</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1916"></span><span>                   </span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_src :: Unfolding -&gt; UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711330"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682711330"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: Unfolding -&gt; CoreExpr
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711332"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711332"><span class="hs-identifier hs-var">unf_rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1917"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682711330"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1918"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711332"><span class="hs-identifier hs-var">unf_rhs</span></a></span><span>
</span><span id="line-1919"></span><span>                   </span><span class="annot"><span class="annottext">Unfolding
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711309"><span class="hs-identifier hs-var">bind_rhs</span></a></span><span>
</span><span id="line-1920"></span><span>       </span><span class="hs-comment">-- 'bind_rhs' is irrelevant for inlining things with a stable unfolding</span><span>
</span><span id="line-1921"></span><span>    </span><span id="local-6989586621682711326"><span class="annot"><span class="annottext">rhs_size :: JoinArity
</span><a href="#local-6989586621682711326"><span class="hs-identifier hs-var hs-var">rhs_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711316"><span class="hs-identifier hs-var">old_unf</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1922"></span><span>                 </span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_guidance :: Unfolding -&gt; UnfoldingGuidance
</span><a href="GHC.Core.html#uf_guidance"><span class="hs-identifier hs-var">uf_guidance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711334"><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621682711334"><span class="hs-identifier hs-var">guidance</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1923"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfIfGoodArgs"><span class="hs-identifier hs-type">UnfIfGoodArgs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_size :: UnfoldingGuidance -&gt; JoinArity
</span><a href="GHC.Core.html#ug_size"><span class="hs-identifier hs-var">ug_size</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711337"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711337"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621682711334"><span class="hs-identifier hs-var">guidance</span></a></span><span>
</span><span id="line-1924"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711337"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-1925"></span><span>                 </span><span class="annot"><span class="annottext">Unfolding
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#cheapExprSize"><span class="hs-identifier hs-var">cheapExprSize</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711311"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1926"></span><span>
</span><span id="line-1927"></span><span>
</span><span id="line-1928"></span><span>        </span><span class="hs-comment">-- Checking for a constructor application</span><span>
</span><span id="line-1929"></span><span>        </span><span class="hs-comment">-- Cheap and cheerful; the simplifier moves casts out of the way</span><span>
</span><span id="line-1930"></span><span>        </span><span class="hs-comment">-- The lambda case is important to spot x = /\a. C (f a)</span><span>
</span><span id="line-1931"></span><span>        </span><span class="hs-comment">-- which comes up when C is a dictionary constructor and</span><span>
</span><span id="line-1932"></span><span>        </span><span class="hs-comment">-- f is a default method.</span><span>
</span><span id="line-1933"></span><span>        </span><span class="hs-comment">-- Example: the instance for Show (ST s a) in GHC.ST</span><span>
</span><span id="line-1934"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1935"></span><span>        </span><span class="hs-comment">-- However we *also* treat (\x. C p q) as a con-app-like thing,</span><span>
</span><span id="line-1936"></span><span>        </span><span class="hs-comment">--      Note [Closure conversion]</span><span>
</span><span id="line-1937"></span><span>    </span><span id="local-6989586621682711322"><span class="annot"><span class="annottext">is_con_app :: Expr b -&gt; Bool
</span><a href="#local-6989586621682711322"><span class="hs-identifier hs-var hs-var">is_con_app</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682711340"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711340"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isConLikeId"><span class="hs-identifier hs-var">isConLikeId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711340"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1938"></span><span>    </span><span class="annot"><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682711343"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682711343"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682711343"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1939"></span><span>    </span><span class="annot"><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711345"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682711345"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682711345"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1940"></span><span>    </span><span class="annot"><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711347"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682711347"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682711347"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1941"></span><span>    </span><span class="annot"><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Bind b
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711349"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682711349"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621682711349"><span class="hs-identifier hs-var">e</span></a></span><span>  </span><span class="hs-comment">-- let x = let y = blah in (a,b)</span><span>
</span><span id="line-1942"></span><span>    </span><span class="annot"><a href="#local-6989586621682711322"><span class="hs-identifier hs-var">is_con_app</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>         </span><span class="hs-comment">-- We will float the y out, so treat</span><span>
</span><span id="line-1943"></span><span>                                          </span><span class="hs-comment">-- the x-binding as a con-app (#20941)</span><span>
</span><span id="line-1944"></span><span>
</span><span id="line-1945"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#maxExprSize"><span class="hs-identifier hs-type">maxExprSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1946"></span><span id="maxExprSize"><span class="annot"><span class="annottext">maxExprSize :: JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#maxExprSize"><span class="hs-identifier hs-var hs-var">maxExprSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">20</span></span><span>  </span><span class="hs-comment">-- Rather arbitrary</span><span>
</span><span id="line-1947"></span><span>
</span><span id="line-1948"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#cheapExprSize"><span class="hs-identifier hs-type">cheapExprSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1949"></span><span class="hs-comment">-- Maxes out at maxExprSize</span><span>
</span><span id="line-1950"></span><span id="cheapExprSize"><span class="annot"><span class="annottext">cheapExprSize :: CoreExpr -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#cheapExprSize"><span class="hs-identifier hs-var hs-var">cheapExprSize</span></a></span></span><span> </span><span id="local-6989586621682711351"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711351"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-1951"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711352"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711351"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1952"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1953"></span><span>    </span><span id="local-6989586621682711352"><span class="annot"><span class="annottext">go :: JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711352"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682711361"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711361"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682711362"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711362"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711361"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#maxExprSize"><span class="hs-identifier hs-var">maxExprSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711361"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1954"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711361"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711362"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1955"></span><span>
</span><span id="line-1956"></span><span>    </span><span id="local-6989586621682711363"><span class="annot"><span class="annottext">go1 :: JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711363"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span id="local-6989586621682711364"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711364"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711364"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; JoinArity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1957"></span><span>    </span><span class="annot"><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span id="local-6989586621682711365"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711365"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711365"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; JoinArity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1958"></span><span>    </span><span class="annot"><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span id="local-6989586621682711367"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711367"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711367"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1959"></span><span>    </span><span class="annot"><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span id="local-6989586621682711369"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711369"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711369"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1960"></span><span>    </span><span class="annot"><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span id="local-6989586621682711371"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711371"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711372"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711372"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711371"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711372"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1961"></span><span>    </span><span class="annot"><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span id="local-6989586621682711373"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711373"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682711375"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711375"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711373"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711375"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1962"></span><span>    </span><span class="annot"><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span id="local-6989586621682711376"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711376"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682711377"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711377"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682711378"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711378"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711352"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711376"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711377"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711378"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1963"></span><span>    </span><span class="annot"><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span id="local-6989586621682711379"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711379"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682711380"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711380"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682711381"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711381"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1964"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711380"><span class="hs-identifier hs-var">b</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711379"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711381"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1965"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711352"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711379"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; JoinArity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711381"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1966"></span><span>    </span><span class="annot"><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span id="local-6989586621682711382"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711382"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682711383"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682711383"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682711384"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711384"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; [CoreExpr] -&gt; JoinArity
</span><a href="#local-6989586621682711385"><span class="hs-identifier hs-var">gos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711382"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711384"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBind -&gt; [CoreExpr]
forall b. Bind b -&gt; [Expr b]
</span><a href="GHC.Core.html#rhssOfBind"><span class="hs-identifier hs-var">rhssOfBind</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682711383"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1967"></span><span>    </span><span class="annot"><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span id="local-6989586621682711387"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711387"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682711389"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711389"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711390"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711390"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; [CoreExpr] -&gt; JoinArity
</span><a href="#local-6989586621682711385"><span class="hs-identifier hs-var">gos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711387"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711389"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Alt Id] -&gt; [CoreExpr]
forall b. [Alt b] -&gt; [Expr b]
</span><a href="GHC.Core.html#rhssOfAlts"><span class="hs-identifier hs-var">rhssOfAlts</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711390"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1968"></span><span>
</span><span id="line-1969"></span><span>    </span><span id="local-6989586621682711385"><span class="annot"><span class="annottext">gos :: JoinArity -&gt; [CoreExpr] -&gt; JoinArity
</span><a href="#local-6989586621682711385"><span class="hs-identifier hs-var hs-var">gos</span></a></span></span><span> </span><span id="local-6989586621682711392"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711392"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711392"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1970"></span><span>    </span><span class="annot"><a href="#local-6989586621682711385"><span class="hs-identifier hs-var">gos</span></a></span><span> </span><span id="local-6989586621682711393"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711393"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711394"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711394"><span class="hs-identifier hs-var">e</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682711395"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711395"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711393"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#maxExprSize"><span class="hs-identifier hs-var">maxExprSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711393"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1971"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; [CoreExpr] -&gt; JoinArity
</span><a href="#local-6989586621682711385"><span class="hs-identifier hs-var">gos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; JoinArity
</span><a href="#local-6989586621682711363"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711393"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711394"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711395"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-1972"></span><span>
</span><span id="line-1973"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#betterLB"><span class="hs-identifier hs-type">betterLB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1974"></span><span class="hs-comment">-- If  n1 `betterLB` n2  then choose n1 as the loop breaker</span><span>
</span><span id="line-1975"></span><span id="betterLB"><span class="annot"><span class="annottext">betterLB :: NodeScore -&gt; NodeScore -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#betterLB"><span class="hs-identifier hs-var hs-var">betterLB</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711396"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711396"><span class="hs-identifier hs-var">rank1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711397"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711397"><span class="hs-identifier hs-var">size1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711398"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711398"><span class="hs-identifier hs-var">lb1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711399"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711399"><span class="hs-identifier hs-var">rank2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711400"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711400"><span class="hs-identifier hs-var">size2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1976"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711396"><span class="hs-identifier hs-var">rank1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711399"><span class="hs-identifier hs-var">rank2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1977"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711396"><span class="hs-identifier hs-var">rank1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711399"><span class="hs-identifier hs-var">rank2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1978"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711397"><span class="hs-identifier hs-var">size1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711400"><span class="hs-identifier hs-var">size2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>   </span><span class="hs-comment">-- Make the bigger n2 into the loop breaker</span><span>
</span><span id="line-1979"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711397"><span class="hs-identifier hs-var">size1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711400"><span class="hs-identifier hs-var">size2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1980"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711398"><span class="hs-identifier hs-var">lb1</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>    </span><span class="hs-comment">-- Tie-break: if n1 was a loop breaker before, choose it</span><span>
</span><span id="line-1981"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>   </span><span class="hs-comment">-- See Note [Loop breakers, node scoring, and stability]</span><span>
</span><span id="line-1982"></span><span>
</span><span id="line-1983"></span><span class="hs-comment">{- Note [Self-recursion and loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have
   rec { f = ...f...g...
       ; g = .....f...   }
then 'f' has to be a loop breaker anyway, so we may as well choose it
right away, so that g can inline freely.

This is really just a cheap hack. Consider
   rec { f = ...g...
       ; g = ..f..h...
      ;  h = ...f....}
Here f or g are better loop breakers than h; but we might accidentally
choose h.  Finding the minimal set of loop breakers is hard.

Note [Loop breakers, node scoring, and stability]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
To choose a loop breaker, we give a NodeScore to each node in the SCC,
and pick the one with the best score (according to 'betterLB').

We need to be jolly careful (#12425, #12234) about the stability
of this choice. Suppose we have

    let rec { f = ...g...g...
            ; g = ...f...f... }
    in
    case x of
      True  -&gt; ...f..
      False -&gt; ..f...

In each iteration of the simplifier the occurrence analyser OccAnal
chooses a loop breaker. Suppose in iteration 1 it choose g as the loop
breaker. That means it is free to inline f.

Suppose that GHC decides to inline f in the branches of the case, but
(for some reason; eg it is not saturated) in the rhs of g. So we get

    let rec { f = ...g...g...
            ; g = ...f...f... }
    in
    case x of
      True  -&gt; ...g...g.....
      False -&gt; ..g..g....

Now suppose that, for some reason, in the next iteration the occurrence
analyser chooses f as the loop breaker, so it can freely inline g. And
again for some reason the simplifier inlines g at its calls in the case
branches, but not in the RHS of f. Then we get

    let rec { f = ...g...g...
            ; g = ...f...f... }
    in
    case x of
      True  -&gt; ...(...f...f...)...(...f..f..).....
      False -&gt; ..(...f...f...)...(..f..f...)....

You can see where this is going! Each iteration of the simplifier
doubles the number of calls to f or g. No wonder GHC is slow!

(In the particular example in comment:3 of #12425, f and g are the two
mutually recursive fmap instances for CondT and Result. They are both
marked INLINE which, oddly, is why they don't inline in each other's
RHS, because the call there is not saturated.)

The root cause is that we flip-flop on our choice of loop breaker. I
always thought it didn't matter, and indeed for any single iteration
to terminate, it doesn't matter. But when we iterate, it matters a
lot!!

So The Plan is this:
   If there is a tie, choose the node that
   was a loop breaker last time round

Hence the is_lb field of NodeScore
-}</span><span>
</span><span id="line-2058"></span><span>
</span><span id="line-2059"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                  Lambda groups
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-2064"></span><span>
</span><span id="line-2065"></span><span class="hs-comment">{- Note [Occurrence analysis for lambda binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For value lambdas we do a special hack.  Consider
     (\x. \y. ...x...)
If we did nothing, x is used inside the \y, so would be marked
as dangerous to dup.  But in the common case where the abstraction
is applied to two arguments this is over-pessimistic, which delays
inlining x, which forces more simplifier iterations.

So the occurrence analyser collaborates with the simplifier to treat
a /lambda-group/ specially.   A lambda-group is a contiguous run of
lambda and casts, e.g.
    Lam x (Lam y (Cast (Lam z body) co))

* Occurrence analyser: we just mark each binder in the lambda-group
  (here: x,y,z) with its occurrence info in the *body* of the
  lambda-group.  See occAnalLamTail.

* Simplifier.  The simplifier is careful when partially applying
  lambda-groups. See the call to zapLambdaBndrs in
     GHC.Core.Opt.Simplify.simplExprF1
     GHC.Core.SimpleOpt.simple_app

* Why do we take care to account for intervening casts? Answer:
  currently we don't do eta-expansion and cast-swizzling in a stable
  unfolding (see Historical-note [Eta-expansion in stable unfoldings]).
  So we can get
    f = \x. ((\y. ...x...y...) |&gt; co)
  Now, since the lambdas aren't together, the occurrence analyser will
  say that x is OnceInLam.  Now if we have a call
    (f e1 |&gt; co) e2
  we'll end up with
    let x = e1 in ...x..e2...
  and it'll take an extra iteration of the Simplifier to substitute for x.

A thought: a lambda-group is pretty much what GHC.Core.Opt.Arity.manifestArity
recognises except that the latter looks through (some) ticks.  Maybe a lambda
group should also look through (some) ticks?
-}</span><span>
</span><span id="line-2104"></span><span>
</span><span id="line-2105"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#isOneShotFun"><span class="hs-identifier hs-type">isOneShotFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2106"></span><span class="hs-comment">-- The top level lambdas, ignoring casts, of the expression</span><span>
</span><span id="line-2107"></span><span class="hs-comment">-- are all one-shot.  If there aren't any lambdas at all, this is True</span><span>
</span><span id="line-2108"></span><span id="isOneShotFun"><span class="annot"><span class="annottext">isOneShotFun :: CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isOneShotFun"><span class="hs-identifier hs-var hs-var">isOneShotFun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682711404"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711404"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682711405"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711405"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isOneShotBndr"><span class="hs-identifier hs-var">isOneShotBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711404"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isOneShotFun"><span class="hs-identifier hs-var">isOneShotFun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711405"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2109"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#isOneShotFun"><span class="hs-identifier hs-var">isOneShotFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682711406"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711406"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isOneShotFun"><span class="hs-identifier hs-var">isOneShotFun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711406"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2110"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#isOneShotFun"><span class="hs-identifier hs-var">isOneShotFun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2111"></span><span>
</span><span id="line-2112"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#zapLambdaBndrs"><span class="hs-identifier hs-type">zapLambdaBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#FullArgCount"><span class="hs-identifier hs-type">FullArgCount</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2113"></span><span class="hs-comment">-- If (\xyz. t) appears under-applied to only two arguments,</span><span>
</span><span id="line-2114"></span><span class="hs-comment">-- we must zap the occ-info on x,y, because they appear under the \z</span><span>
</span><span id="line-2115"></span><span class="hs-comment">-- See Note [Occurrence analysis for lambda binders] in GHc.Core.Opt.OccurAnal</span><span>
</span><span id="line-2116"></span><span class="hs-comment">--</span><span>
</span><span id="line-2117"></span><span class="hs-comment">-- NB: `arg_count` includes both type and value args</span><span>
</span><span id="line-2118"></span><span id="zapLambdaBndrs"><span class="annot"><span class="annottext">zapLambdaBndrs :: CoreExpr -&gt; JoinArity -&gt; CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#zapLambdaBndrs"><span class="hs-identifier hs-var hs-var">zapLambdaBndrs</span></a></span></span><span> </span><span id="local-6989586621682711408"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711408"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682711409"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711409"><span class="hs-identifier hs-var">arg_count</span></a></span></span><span>
</span><span id="line-2119"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- If the lambda is fully applied, leave it alone; if not</span><span>
</span><span id="line-2120"></span><span>    </span><span class="hs-comment">-- zap the OccInfo on the lambdas that do have arguments,</span><span>
</span><span id="line-2121"></span><span>    </span><span class="hs-comment">-- so they beta-reduce to use-many Lets rather than used-once ones.</span><span>
</span><span id="line-2122"></span><span>    </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; Maybe CoreExpr
</span><a href="#local-6989586621682711410"><span class="hs-identifier hs-var">zap</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711409"><span class="hs-identifier hs-var">arg_count</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711408"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711408"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-2123"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2124"></span><span>    </span><span class="annot"><a href="#local-6989586621682711410"><span class="hs-identifier hs-type">zap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#FullArgCount"><span class="hs-identifier hs-type">FullArgCount</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2125"></span><span>    </span><span class="hs-comment">-- Nothing =&gt; No need to change the occ-info</span><span>
</span><span id="line-2126"></span><span>    </span><span class="hs-comment">-- Just e  =&gt; Had to change</span><span>
</span><span id="line-2127"></span><span>    </span><span id="local-6989586621682711410"><span class="annot"><span class="annottext">zap :: JoinArity -&gt; CoreExpr -&gt; Maybe CoreExpr
</span><a href="#local-6989586621682711410"><span class="hs-identifier hs-var hs-var">zap</span></a></span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621682711411"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711411"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isOneShotFun"><span class="hs-identifier hs-var">isOneShotFun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711411"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-comment">-- All remaining lambdas are one-shot</span><span>
</span><span id="line-2128"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe CoreExpr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711411"><span class="hs-identifier hs-var">e</span></a></span><span>   </span><span class="hs-comment">-- in which case no need to zap</span><span>
</span><span id="line-2129"></span><span>    </span><span class="annot"><a href="#local-6989586621682711410"><span class="hs-identifier hs-var">zap</span></a></span><span> </span><span id="local-6989586621682711412"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711412"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682711413"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711413"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682711414"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711414"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682711415"><span class="annot"><a href="#local-6989586621682711415"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; Maybe CoreExpr
</span><a href="#local-6989586621682711410"><span class="hs-identifier hs-var">zap</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711412"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711413"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711415"><span class="hs-identifier hs-type">e'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711414"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2130"></span><span>    </span><span class="annot"><a href="#local-6989586621682711410"><span class="hs-identifier hs-var">zap</span></a></span><span> </span><span id="local-6989586621682711416"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711416"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682711417"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711417"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682711418"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711418"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682711419"><span class="annot"><a href="#local-6989586621682711419"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; Maybe CoreExpr
</span><a href="#local-6989586621682711410"><span class="hs-identifier hs-var">zap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711416"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; JoinArity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711418"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2131"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682711420"><span class="hs-identifier hs-type">zap_bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711417"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682711419"><span class="hs-identifier hs-type">e'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2132"></span><span>    </span><span class="annot"><a href="#local-6989586621682711410"><span class="hs-identifier hs-var">zap</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-comment">-- More arguments than lambdas</span><span>
</span><span id="line-2133"></span><span>
</span><span id="line-2134"></span><span>    </span><span id="local-6989586621682711420"><span class="annot"><span class="annottext">zap_bndr :: Id -&gt; Id
</span><a href="#local-6989586621682711420"><span class="hs-identifier hs-var hs-var">zap_bndr</span></a></span></span><span> </span><span id="local-6989586621682711421"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711421"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711421"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711421"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2135"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Types.Id.html#zapLamIdInfo"><span class="hs-identifier hs-var">zapLamIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711421"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2136"></span><span>
</span><span id="line-2137"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalLamTail"><span class="hs-identifier hs-type">occAnalLamTail</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithTailUsageDetails"><span class="hs-identifier hs-type">WithTailUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2138"></span><span class="hs-comment">-- ^ See Note [Occurrence analysis for lambda binders].</span><span>
</span><span id="line-2139"></span><span class="hs-comment">-- It does the following:</span><span>
</span><span id="line-2140"></span><span class="hs-comment">--   * Sets one-shot info on the lambda binder from the OccEnv, and</span><span>
</span><span id="line-2141"></span><span class="hs-comment">--     removes that one-shot info from the OccEnv</span><span>
</span><span id="line-2142"></span><span class="hs-comment">--   * Sets the OccEnv to OccVanilla when going under a value lambda</span><span>
</span><span id="line-2143"></span><span class="hs-comment">--   * Tags each lambda with its occurrence information</span><span>
</span><span id="line-2144"></span><span class="hs-comment">--   * Walks through casts</span><span>
</span><span id="line-2145"></span><span class="hs-comment">--   * Package up the analysed lambda with its manifest join arity</span><span>
</span><span id="line-2146"></span><span class="hs-comment">--</span><span>
</span><span id="line-2147"></span><span class="hs-comment">-- This function does /not/ do</span><span>
</span><span id="line-2148"></span><span class="hs-comment">--   markAllInsideLam or</span><span>
</span><span id="line-2149"></span><span class="hs-comment">--   markAllNonTail</span><span>
</span><span id="line-2150"></span><span class="hs-comment">-- The caller does that, via adjustTailUsage (mostly calls go through</span><span>
</span><span id="line-2151"></span><span class="hs-comment">-- adjustNonRecRhs). Every call to occAnalLamTail must ultimately call</span><span>
</span><span id="line-2152"></span><span class="hs-comment">-- adjustTailUsage to discharge the assumed join arity.</span><span>
</span><span id="line-2153"></span><span class="hs-comment">--</span><span>
</span><span id="line-2154"></span><span class="hs-comment">-- In effect, the analysis result is for a non-recursive join point with</span><span>
</span><span id="line-2155"></span><span class="hs-comment">-- manifest arity and adjustTailUsage does the fixup.</span><span>
</span><span id="line-2156"></span><span class="hs-comment">-- See Note [Adjusting right-hand sides]</span><span>
</span><span id="line-2157"></span><span id="occAnalLamTail"><span class="annot"><span class="annottext">occAnalLamTail :: OccEnv -&gt; CoreExpr -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalLamTail"><span class="hs-identifier hs-var hs-var">occAnalLamTail</span></a></span></span><span> </span><span id="local-6989586621682711423"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711423"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711424"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711424"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-2158"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711425"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711425"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621682711426"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711426"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_anal_lam_tail"><span class="hs-identifier hs-var">occ_anal_lam_tail</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711423"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711424"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2159"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TailUsageDetails -&gt; CoreExpr -&gt; WithTailUsageDetails CoreExpr
forall a. TailUsageDetails -&gt; a -&gt; WithTailUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-var">WTUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; UsageDetails -&gt; TailUsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-var">TUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; JoinArity
</span><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-var">joinRhsArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711424"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711425"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711426"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-2160"></span><span>
</span><span id="line-2161"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_anal_lam_tail"><span class="hs-identifier hs-type">occ_anal_lam_tail</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2162"></span><span class="hs-comment">-- Does not markInsideLam etc for the outmost batch of lambdas</span><span>
</span><span id="line-2163"></span><span id="occ_anal_lam_tail"><span class="annot"><span class="annottext">occ_anal_lam_tail :: OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_anal_lam_tail"><span class="hs-identifier hs-var hs-var">occ_anal_lam_tail</span></a></span></span><span> </span><span id="local-6989586621682711428"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711428"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711429"><span class="annot"><span class="annottext">expr :: CoreExpr
</span><a href="#local-6989586621682711429"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2164"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; [Id] -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="#local-6989586621682711430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711428"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711429"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2165"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2166"></span><span>    </span><span class="annot"><a href="#local-6989586621682711430"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2167"></span><span>    </span><span id="local-6989586621682711430"><span class="annot"><span class="annottext">go :: OccEnv -&gt; [Id] -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="#local-6989586621682711430"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682711431"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711431"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711432"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711432"><span class="hs-identifier hs-var">rev_bndrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682711433"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711433"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682711434"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711434"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2168"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711433"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2169"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; [Id] -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="#local-6989586621682711430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711431"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711433"><span class="hs-identifier hs-var">bndr</span></a></span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711432"><span class="hs-identifier hs-var">rev_bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711434"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2170"></span><span>              </span><span class="hs-comment">-- Important: Unlike a value binder, do not modify occ_encl</span><span>
</span><span id="line-2171"></span><span>              </span><span class="hs-comment">-- to OccVanilla, so that with a RHS like</span><span>
</span><span id="line-2172"></span><span>              </span><span class="hs-comment">--   \(@ x) -&gt; K @x (f @x)</span><span>
</span><span id="line-2173"></span><span>              </span><span class="hs-comment">-- we'll see that (K @x (f @x)) is in a OccRhs, and hence refrain</span><span>
</span><span id="line-2174"></span><span>              </span><span class="hs-comment">-- from inlining f. See the beginning of Note [Cascading inlines].</span><span>
</span><span id="line-2175"></span><span>
</span><span id="line-2176"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2177"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711435"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711435"><span class="hs-identifier hs-var">env_one_shots'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711436"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711436"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2178"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711431"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2179"></span><span>                  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711433"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2180"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621682711438"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682711438"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682711439"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711439"><span class="hs-identifier hs-var">oss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711439"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OneShotInfo -&gt; Id
</span><a href="GHC.Types.Id.html#updOneShotInfo"><span class="hs-identifier hs-var">updOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711433"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682711438"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2181"></span><span>                  </span><span class="hs-comment">-- Use updOneShotInfo, not setOneShotInfo, as pre-existing</span><span>
</span><span id="line-2182"></span><span>                  </span><span class="hs-comment">-- one-shot info might be better than what we can infer, e.g.</span><span>
</span><span id="line-2183"></span><span>                  </span><span class="hs-comment">-- due to explicit use of the magic 'oneShot' function.</span><span>
</span><span id="line-2184"></span><span>                  </span><span class="hs-comment">-- See Note [oneShot magic]</span><span>
</span><span id="line-2185"></span><span>            </span><span id="local-6989586621682711441"><span class="annot"><span class="annottext">env' :: OccEnv
</span><a href="#local-6989586621682711441"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711431"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var">occ_encl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-type">OccVanilla</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711435"><span class="hs-identifier hs-type">env_one_shots'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2186"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; [Id] -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="#local-6989586621682711430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711441"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711436"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711432"><span class="hs-identifier hs-var">rev_bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711434"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2187"></span><span>
</span><span id="line-2188"></span><span>    </span><span class="annot"><a href="#local-6989586621682711430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682711443"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711443"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711444"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711444"><span class="hs-identifier hs-var">rev_bndrs</span></a></span></span><span> </span><span id="local-6989586621682711445"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711445"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-2189"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; [Id]
-&gt; (OccEnv -&gt; WithUsageDetails CoreExpr)
-&gt; WithUsageDetails CoreExpr
forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScope"><span class="hs-identifier hs-var">addInScope</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711443"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711444"><span class="hs-identifier hs-var">rev_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">((OccEnv -&gt; WithUsageDetails CoreExpr)
 -&gt; WithUsageDetails CoreExpr)
-&gt; (OccEnv -&gt; WithUsageDetails CoreExpr)
-&gt; WithUsageDetails CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682711447"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711447"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2190"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711448"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711448"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621682711449"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711449"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_anal_lam_tail"><span class="hs-identifier hs-var">occ_anal_lam_tail</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711447"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711445"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2191"></span><span>            </span><span id="local-6989586621682711450"><span class="annot"><span class="annottext">wrap_lam :: CoreExpr -&gt; Id -&gt; CoreExpr
</span><a href="#local-6989586621682711450"><span class="hs-identifier hs-var hs-var">wrap_lam</span></a></span></span><span> </span><span id="local-6989586621682711451"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711451"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682711452"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711452"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#tagLamBinder"><span class="hs-identifier hs-var">tagLamBinder</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711448"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711452"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711451"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2192"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711448"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; [Id] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addLamCoVarOccs"><span class="hs-operator hs-var">`addLamCoVarOccs`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711444"><span class="hs-identifier hs-var">rev_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2193"></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreExpr -&gt; Id -&gt; CoreExpr) -&gt; CoreExpr -&gt; [Id] -&gt; CoreExpr
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; CoreExpr
</span><a href="#local-6989586621682711450"><span class="hs-identifier hs-var">wrap_lam</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711449"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711444"><span class="hs-identifier hs-var">rev_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2194"></span><span>
</span><span id="line-2195"></span><span class="hs-comment">-- For casts, keep going in the same lambda-group</span><span>
</span><span id="line-2196"></span><span class="hs-comment">-- See Note [Occurrence analysis for lambda binders]</span><span>
</span><span id="line-2197"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_anal_lam_tail"><span class="hs-identifier hs-var">occ_anal_lam_tail</span></a></span><span> </span><span id="local-6989586621682711456"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711456"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682711457"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711457"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682711458"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711458"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2198"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>  </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711459"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711459"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621682711460"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711460"><span class="hs-identifier hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_anal_lam_tail"><span class="hs-identifier hs-var">occ_anal_lam_tail</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711456"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711457"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2199"></span><span>         </span><span class="hs-comment">-- usage1: see Note [Gather occurrences of coercion variables]</span><span>
</span><span id="line-2200"></span><span>         </span><span id="local-6989586621682711461"><span class="annot"><span class="annottext">usage1 :: UsageDetails
</span><a href="#local-6989586621682711461"><span class="hs-identifier hs-var hs-var">usage1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; VarSet -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var">addManyOccs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711459"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionR -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#coVarsOfCo"><span class="hs-identifier hs-var">coVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711458"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2201"></span><span>
</span><span id="line-2202"></span><span>         </span><span class="hs-comment">-- usage2: see Note [Occ-anal and cast worker/wrapper]</span><span>
</span><span id="line-2203"></span><span>         </span><span id="local-6989586621682711463"><span class="annot"><span class="annottext">usage2 :: UsageDetails
</span><a href="#local-6989586621682711463"><span class="hs-identifier hs-var hs-var">usage2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711457"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2204"></span><span>                    </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isRhsEnv"><span class="hs-identifier hs-var">isRhsEnv</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711456"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllMany"><span class="hs-identifier hs-var">markAllMany</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711461"><span class="hs-identifier hs-var">usage1</span></a></span><span>
</span><span id="line-2205"></span><span>                    </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711461"><span class="hs-identifier hs-var">usage1</span></a></span><span>
</span><span id="line-2206"></span><span>
</span><span id="line-2207"></span><span>         </span><span class="hs-comment">-- usage3: you might think this was not necessary, because of</span><span>
</span><span id="line-2208"></span><span>         </span><span class="hs-comment">-- the markAllNonTail in adjustTailUsage; but not so!  For a</span><span>
</span><span id="line-2209"></span><span>         </span><span class="hs-comment">-- join point, adjustTailUsage doesn't do this; yet if there is</span><span>
</span><span id="line-2210"></span><span>         </span><span class="hs-comment">-- a cast, we must!  Also: why markAllNonTail?  See</span><span>
</span><span id="line-2211"></span><span>         </span><span class="hs-comment">-- GHC.Core.Lint: Note Note [Join points and casts]</span><span>
</span><span id="line-2212"></span><span>         </span><span id="local-6989586621682711466"><span class="annot"><span class="annottext">usage3 :: UsageDetails
</span><a href="#local-6989586621682711466"><span class="hs-identifier hs-var hs-var">usage3</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-var">markAllNonTail</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711463"><span class="hs-identifier hs-var">usage2</span></a></span><span>
</span><span id="line-2213"></span><span>
</span><span id="line-2214"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711466"><span class="hs-identifier hs-var">usage3</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoercionR -&gt; CoreExpr
forall b. Expr b -&gt; CoercionR -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711460"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711458"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2215"></span><span>
</span><span id="line-2216"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_anal_lam_tail"><span class="hs-identifier hs-var">occ_anal_lam_tail</span></a></span><span> </span><span id="local-6989586621682711468"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711468"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711469"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711469"><span class="hs-identifier hs-var">expr</span></a></span></span><span>  </span><span class="hs-comment">-- Not Lam, not Cast</span><span>
</span><span id="line-2217"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711468"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711469"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2218"></span><span>
</span><span id="line-2219"></span><span class="hs-comment">{- Note [Occ-anal and cast worker/wrapper]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider   y = e; x = y |&gt; co
If we mark y as used-once, we'll inline y into x, and the Cast
worker/wrapper transform will float it straight back out again.  See
Note [Cast worker/wrapper] in GHC.Core.Opt.Simplify.

So in this particular case we want to mark 'y' as Many.  It's very
ad-hoc, but it's also simple.  It's also what would happen if we gave
the binding for x a stable unfolding (as we usually do for wrappers, thus
      y = e
      {-# INLINE x #-}
      x = y |&gt; co
Now y appears twice -- once in x's stable unfolding, and once in x's
RHS. So it'll get a Many occ-info.  (Maybe Cast w/w should create a stable
unfolding, which would obviate this Note; but that seems a bit of a
heavyweight solution.)

We only need to this in occAnalLamTail, not occAnal, because the top leve
of a right hand side is handled by occAnalLamTail.
-}</span><span>
</span><span id="line-2240"></span><span>
</span><span id="line-2241"></span><span>
</span><span id="line-2242"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   Right hand sides
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-2247"></span><span>
</span><span id="line-2248"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalUnfolding"><span class="hs-identifier hs-type">occAnalUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2249"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-2250"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithTailUsageDetails"><span class="hs-identifier hs-type">WithTailUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-2251"></span><span class="hs-comment">-- Occurrence-analyse a stable unfolding;</span><span>
</span><span id="line-2252"></span><span class="hs-comment">-- discard a non-stable one altogether and return empty usage details.</span><span>
</span><span id="line-2253"></span><span id="occAnalUnfolding"><span class="annot"><span class="annottext">occAnalUnfolding :: OccEnv -&gt; Unfolding -&gt; WithTailUsageDetails Unfolding
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalUnfolding"><span class="hs-identifier hs-var hs-var">occAnalUnfolding</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711470"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711470"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711471"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711471"><span class="hs-identifier hs-var">unf</span></a></span></span><span>
</span><span id="line-2254"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711471"><span class="hs-identifier hs-var">unf</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2255"></span><span>      </span><span id="local-6989586621682711472"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682711472"><span class="hs-identifier hs-var">unf</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: Unfolding -&gt; CoreExpr
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711473"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711473"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_src :: Unfolding -&gt; UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711474"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682711474"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2256"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682711474"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2257"></span><span>            </span><span class="hs-keyword">let</span><span>
</span><span id="line-2258"></span><span>              </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-type">TUD</span></a></span><span> </span><span id="local-6989586621682711475"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711475"><span class="hs-identifier hs-var">rhs_ja</span></a></span></span><span> </span><span id="local-6989586621682711476"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711476"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711477"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711477"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalLamTail"><span class="hs-identifier hs-var">occAnalLamTail</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711470"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711473"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2259"></span><span>              </span><span id="local-6989586621682711478"><span class="annot"><span class="annottext">unf' :: Unfolding
</span><a href="#local-6989586621682711478"><span class="hs-identifier hs-var hs-var">unf'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711472"><span class="hs-identifier hs-var">unf</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711477"><span class="hs-identifier hs-type">rhs'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2260"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TailUsageDetails -&gt; Unfolding -&gt; WithTailUsageDetails Unfolding
forall a. TailUsageDetails -&gt; a -&gt; WithTailUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-var">WTUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; UsageDetails -&gt; TailUsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-var">TUD</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711475"><span class="hs-identifier hs-var">rhs_ja</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllMany"><span class="hs-identifier hs-var">markAllMany</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711476"><span class="hs-identifier hs-var">uds</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711478"><span class="hs-identifier hs-var">unf'</span></a></span><span>
</span><span id="line-2261"></span><span>              </span><span class="hs-comment">-- markAllMany: see Note [Occurrences in stable unfoldings]</span><span>
</span><span id="line-2262"></span><span>
</span><span id="line-2263"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TailUsageDetails -&gt; Unfolding -&gt; WithTailUsageDetails Unfolding
forall a. TailUsageDetails -&gt; a -&gt; WithTailUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-var">WTUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; UsageDetails -&gt; TailUsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-var">TUD</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711472"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-2264"></span><span>              </span><span class="hs-comment">-- For non-Stable unfoldings we leave them undisturbed, but</span><span>
</span><span id="line-2265"></span><span>              </span><span class="hs-comment">-- don't count their usage because the simplifier will discard them.</span><span>
</span><span id="line-2266"></span><span>              </span><span class="hs-comment">-- We leave them undisturbed because nodeScore uses their size info</span><span>
</span><span id="line-2267"></span><span>              </span><span class="hs-comment">-- to guide its decisions.  It's ok to leave un-substituted</span><span>
</span><span id="line-2268"></span><span>              </span><span class="hs-comment">-- expressions in the tree because all the variables that were in</span><span>
</span><span id="line-2269"></span><span>              </span><span class="hs-comment">-- scope remain in scope; there is no cloning etc.</span><span>
</span><span id="line-2270"></span><span>
</span><span id="line-2271"></span><span>      </span><span id="local-6989586621682711479"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682711479"><span class="hs-identifier hs-var">unf</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DFunUnfolding"><span class="hs-identifier hs-type">DFunUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">df_bndrs :: Unfolding -&gt; [Id]
</span><a href="GHC.Core.html#df_bndrs"><span class="hs-identifier hs-var">df_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711481"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711481"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">df_args :: Unfolding -&gt; [CoreExpr]
</span><a href="GHC.Core.html#df_args"><span class="hs-identifier hs-var">df_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711482"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711482"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2272"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711483"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711483"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span id="local-6989586621682711484"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711484"><span class="hs-identifier hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; [Id]
-&gt; (OccEnv -&gt; WithUsageDetails [CoreExpr])
-&gt; WithUsageDetails [CoreExpr]
forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeList"><span class="hs-identifier hs-var">addInScopeList</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711470"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711481"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">((OccEnv -&gt; WithUsageDetails [CoreExpr])
 -&gt; WithUsageDetails [CoreExpr])
-&gt; (OccEnv -&gt; WithUsageDetails [CoreExpr])
-&gt; WithUsageDetails [CoreExpr]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682711485"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711485"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2273"></span><span>                               </span><span class="annot"><span class="annottext">OccEnv -&gt; [CoreExpr] -&gt; WithUsageDetails [CoreExpr]
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalList"><span class="hs-identifier hs-var">occAnalList</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711485"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711482"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2274"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TailUsageDetails -&gt; Unfolding -&gt; WithTailUsageDetails Unfolding
forall a. TailUsageDetails -&gt; a -&gt; WithTailUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-var">WTUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; UsageDetails -&gt; TailUsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-var">TUD</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711483"><span class="hs-identifier hs-var">uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711479"><span class="hs-identifier hs-var">unf</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#df_args"><span class="hs-identifier hs-var">df_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711484"><span class="hs-identifier hs-type">args'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2275"></span><span>              </span><span class="hs-comment">-- No need to use tagLamBinders because we</span><span>
</span><span id="line-2276"></span><span>              </span><span class="hs-comment">-- never inline DFuns so the occ-info on binders doesn't matter</span><span>
</span><span id="line-2277"></span><span>
</span><span id="line-2278"></span><span>      </span><span id="local-6989586621682711487"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711487"><span class="hs-identifier hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TailUsageDetails -&gt; Unfolding -&gt; WithTailUsageDetails Unfolding
forall a. TailUsageDetails -&gt; a -&gt; WithTailUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-var">WTUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; UsageDetails -&gt; TailUsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-var">TUD</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682711487"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-2279"></span><span>
</span><span id="line-2280"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalRule"><span class="hs-identifier hs-type">occAnalRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2281"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span>
</span><span id="line-2282"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- Each (non-built-in) rule</span><span>
</span><span id="line-2283"></span><span>                 </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Usage details for LHS</span><span>
</span><span id="line-2284"></span><span>                 </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TailUsageDetails"><span class="hs-identifier hs-type">TailUsageDetails</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Usage details for RHS</span><span>
</span><span id="line-2285"></span><span id="occAnalRule"><span class="annot"><span class="annottext">occAnalRule :: OccEnv -&gt; CoreRule -&gt; (CoreRule, UsageDetails, TailUsageDetails)
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalRule"><span class="hs-identifier hs-var hs-var">occAnalRule</span></a></span></span><span> </span><span id="local-6989586621682711488"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711488"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711489"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621682711489"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [Id]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711490"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711490"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711491"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711491"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rhs :: CoreRule -&gt; CoreExpr
</span><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711492"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711492"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2286"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711493"><span class="hs-identifier hs-var">rule'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711494"><span class="hs-identifier hs-var">lhs_uds'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; UsageDetails -&gt; TailUsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-var">TUD</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711495"><span class="hs-identifier hs-var">rhs_ja</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711496"><span class="hs-identifier hs-var">rhs_uds'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2287"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2288"></span><span>    </span><span id="local-6989586621682711493"><span class="annot"><span class="annottext">rule' :: CoreRule
</span><a href="#local-6989586621682711493"><span class="hs-identifier hs-var hs-var">rule'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711489"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711497"><span class="hs-identifier hs-type">args'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711498"><span class="hs-identifier hs-type">rhs'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2289"></span><span>
</span><span id="line-2290"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711499"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711499"><span class="hs-identifier hs-var">lhs_uds</span></a></span></span><span> </span><span id="local-6989586621682711497"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711497"><span class="hs-identifier hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; [Id]
-&gt; (OccEnv -&gt; WithUsageDetails [CoreExpr])
-&gt; WithUsageDetails [CoreExpr]
forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeList"><span class="hs-identifier hs-var">addInScopeList</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711488"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711490"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">((OccEnv -&gt; WithUsageDetails [CoreExpr])
 -&gt; WithUsageDetails [CoreExpr])
-&gt; (OccEnv -&gt; WithUsageDetails [CoreExpr])
-&gt; WithUsageDetails [CoreExpr]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682711500"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711500"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2291"></span><span>                        </span><span class="annot"><span class="annottext">OccEnv -&gt; [CoreExpr] -&gt; WithUsageDetails [CoreExpr]
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalList"><span class="hs-identifier hs-var">occAnalList</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711500"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711491"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2292"></span><span>
</span><span id="line-2293"></span><span>    </span><span id="local-6989586621682711494"><span class="annot"><span class="annottext">lhs_uds' :: UsageDetails
</span><a href="#local-6989586621682711494"><span class="hs-identifier hs-var hs-var">lhs_uds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllManyNonTail"><span class="hs-identifier hs-var">markAllManyNonTail</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711499"><span class="hs-identifier hs-var">lhs_uds</span></a></span><span>
</span><span id="line-2294"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711502"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711502"><span class="hs-identifier hs-var">rhs_uds</span></a></span></span><span> </span><span id="local-6989586621682711498"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711498"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; [Id]
-&gt; (OccEnv -&gt; WithUsageDetails CoreExpr)
-&gt; WithUsageDetails CoreExpr
forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeList"><span class="hs-identifier hs-var">addInScopeList</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711488"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711490"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">((OccEnv -&gt; WithUsageDetails CoreExpr)
 -&gt; WithUsageDetails CoreExpr)
-&gt; (OccEnv -&gt; WithUsageDetails CoreExpr)
-&gt; WithUsageDetails CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682711503"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711503"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2295"></span><span>                       </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711503"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711492"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2296"></span><span>                          </span><span class="hs-comment">-- Note [Rules are extra RHSs]</span><span>
</span><span id="line-2297"></span><span>                          </span><span class="hs-comment">-- Note [Rule dependency info]</span><span>
</span><span id="line-2298"></span><span>    </span><span id="local-6989586621682711496"><span class="annot"><span class="annottext">rhs_uds' :: UsageDetails
</span><a href="#local-6989586621682711496"><span class="hs-identifier hs-var hs-var">rhs_uds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllMany"><span class="hs-identifier hs-var">markAllMany</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711502"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span>
</span><span id="line-2299"></span><span>    </span><span id="local-6989586621682711495"><span class="annot"><span class="annottext">rhs_ja :: JoinArity
</span><a href="#local-6989586621682711495"><span class="hs-identifier hs-var hs-var">rhs_ja</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; JoinArity
forall a. [a] -&gt; JoinArity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; JoinArity
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711491"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-comment">-- See Note [Join points and unfoldings/rules]</span><span>
</span><span id="line-2300"></span><span>
</span><span id="line-2301"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalRule"><span class="hs-identifier hs-var">occAnalRule</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711504"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711504"><span class="hs-identifier hs-var">other_rule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682711504"><span class="hs-identifier hs-var">other_rule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; UsageDetails -&gt; TailUsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-var">TUD</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2302"></span><span>
</span><span id="line-2303"></span><span class="hs-comment">{- Note [Occurrences in stable unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    f p = BIG
    {-# INLINE g #-}
    g y = not (f y)
where this is the /only/ occurrence of 'f'.  So 'g' will get a stable
unfolding.  Now suppose that g's RHS gets optimised (perhaps by a rule
or inlining f) so that it doesn't mention 'f' any more.  Now the last
remaining call to f is in g's Stable unfolding. But, even though there
is only one syntactic occurrence of f, we do /not/ want to do
preinlineUnconditionally here!

The INLINE pragma says &quot;inline exactly this RHS&quot;; perhaps the
programmer wants to expose that 'not', say. If we inline f that will make
the Stable unfoldign big, and that wasn't what the programmer wanted.

Another way to think about it: if we inlined g as-is into multiple
call sites, now there's be multiple calls to f.

Bottom line: treat all occurrences in a stable unfolding as &quot;Many&quot;.
We still leave tail call information intact, though, as to not spoil
potential join points.

Note [Unfoldings and rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Generally unfoldings and rules are already occurrence-analysed, so we
don't want to reconstruct their trees; we just want to analyse them to
find how they use their free variables.

EXCEPT if there is a binder-swap going on, in which case we do want to
produce a new tree.

So we have a fast-path that keeps the old tree if the occ_bs_env is
empty.   This just saves a bit of allocation and reconstruction; not
a big deal.

Two tricky corners:

* Dead bindings (#22761). Supose we have
    Unfolding = \x. let y = foo in x+1
  which includes a dead binding for `y`. In occAnalUnfolding we occ-anal
  the unfolding and produce /no/ occurrences of `foo` (since `y` is
  dead).  But if we discard the occ-analysed syntax tree (which we do on
  our fast path), and use the old one, we still /have/ an occurrence of
  `foo` -- and that can lead to out-of-scope variables (#22761).

  Solution: always keep occ-analysed trees in unfoldings and rules, so they
  have no dead code.  See Note [OccInfo in unfoldings and rules] in GHC.Core.

* One-shot binders. Consider
     {- f has Stable unfolding \p q -&gt; blah
        Demand on f is LC(L,C(1,!P(L)); that is, one-shot in its second ar -}
     f = \x y. blah

   Now we `mkRhsOccEnv` will build an OccEnv for f's RHS that has
          occ_one_shots = [NoOneShortInfo, OneShotLam]
   This will put OneShotLam on the \y.  And it'll put it on the \q.  But the
   noBinderSwap check will mean that we discard this new occ-anal'd unfolding
   and keep the old one, with no OneShotInfo.

   This looks a little inconsistent, but the Stable unfolding is just used for
   inlinings; OneShotInfo isn't a lot of use here.

Note [Cascading inlines]
~~~~~~~~~~~~~~~~~~~~~~~~
By default we use an OccRhs for the RHS of a binding.  This tells the
occ anal n that it's looking at an RHS, which has an effect in
occAnalApp.  In particular, for constructor applications, it makes
the arguments appear to have NoOccInfo, so that we don't inline into
them. Thus    x = f y
              k = Just x
we do not want to inline x.

But there's a problem.  Consider
     x1 = a0 : []
     x2 = a1 : x1
     x3 = a2 : x2
     g  = f x3
First time round, it looks as if x1 and x2 occur as an arg of a
let-bound constructor ==&gt; give them a many-occurrence.
But then x3 is inlined (unconditionally as it happens) and
next time round, x2 will be, and the next time round x1 will be
Result: multiple simplifier iterations.  Sigh.

So, when analysing the RHS of x3 we notice that x3 will itself
definitely inline the next time round, and so we analyse x3's rhs in
an OccVanilla context, not OccRhs.  Hence the &quot;certainly_inline&quot; stuff.

Annoyingly, we have to approximate GHC.Core.Opt.Simplify.Utils.preInlineUnconditionally.
If (a) the RHS is expandable (see isExpandableApp in occAnalApp), and
   (b) certainly_inline says &quot;yes&quot; when preInlineUnconditionally says &quot;no&quot;
then the simplifier iterates indefinitely:
        x = f y
        k = Just x   -- We decide that k is 'certainly_inline'
        v = ...k...  -- but preInlineUnconditionally doesn't inline it
inline ==&gt;
        k = Just (f y)
        v = ...k...
float ==&gt;
        x1 = f y
        k = Just x1
        v = ...k...

This is worse than the slow cascade, so we only want to say &quot;certainly_inline&quot;
if it really is certain.  Look at the note with preInlineUnconditionally
for the various clauses.  See #24582 for an example of the two getting out of sync.


************************************************************************
*                                                                      *
                Expressions
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-2418"></span><span>
</span><span id="line-2419"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalList"><span class="hs-identifier hs-type">occAnalList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2420"></span><span id="occAnalList"><span class="annot"><span class="annottext">occAnalList :: OccEnv -&gt; [CoreExpr] -&gt; WithUsageDetails [CoreExpr]
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalList"><span class="hs-identifier hs-var hs-var">occAnalList</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">OccEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; [CoreExpr] -&gt; WithUsageDetails [CoreExpr]
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2421"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalList"><span class="hs-identifier hs-var">occAnalList</span></a></span><span> </span><span id="local-6989586621682711505"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711505"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711506"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711506"><span class="hs-identifier hs-var">e</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682711507"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711507"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-2422"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711508"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711508"><span class="hs-identifier hs-var">uds1</span></a></span></span><span> </span><span id="local-6989586621682711509"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711509"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711505"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711506"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2423"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711510"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711510"><span class="hs-identifier hs-var">uds2</span></a></span></span><span> </span><span id="local-6989586621682711511"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711511"><span class="hs-identifier hs-var">es'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; [CoreExpr] -&gt; WithUsageDetails [CoreExpr]
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalList"><span class="hs-identifier hs-var">occAnalList</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711505"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711507"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-2424"></span><span>                         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; [CoreExpr] -&gt; WithUsageDetails [CoreExpr]
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711508"><span class="hs-identifier hs-var">uds1</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711510"><span class="hs-identifier hs-var">uds2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711509"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711511"><span class="hs-identifier hs-var">es'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2425"></span><span>
</span><span id="line-2426"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-type">occAnal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2427"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2428"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>       </span><span class="hs-comment">-- Gives info only about the &quot;interesting&quot; Ids</span><span>
</span><span id="line-2429"></span><span>
</span><span id="line-2430"></span><span id="occAnal"><span class="annot"><span class="annottext">occAnal :: OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var hs-var">occAnal</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">OccEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span id="local-6989586621682711512"><span class="annot"><span class="annottext">expr :: CoreExpr
</span><a href="#local-6989586621682711512"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711512"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2431"></span><span>
</span><span id="line-2432"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span id="local-6989586621682711513"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711513"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711514"><span class="annot"><span class="annottext">expr :: CoreExpr
</span><a href="#local-6989586621682711514"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; (CoreExpr, [CoreExpr], [CoreTickish])
-&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalApp"><span class="hs-identifier hs-var">occAnalApp</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711513"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711514"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2433"></span><span>    </span><span class="hs-comment">-- At one stage, I gathered the idRuleVars for the variable here too,</span><span>
</span><span id="line-2434"></span><span>    </span><span class="hs-comment">-- which in a way is the right thing to do.</span><span>
</span><span id="line-2435"></span><span>    </span><span class="hs-comment">-- But that went wrong right after specialisation, when</span><span>
</span><span id="line-2436"></span><span>    </span><span class="hs-comment">-- the *occurrences* of the overloaded function didn't have any</span><span>
</span><span id="line-2437"></span><span>    </span><span class="hs-comment">-- rules in them, so the *specialised* versions looked as if they</span><span>
</span><span id="line-2438"></span><span>    </span><span class="hs-comment">-- weren't used at all.</span><span>
</span><span id="line-2439"></span><span>
</span><span id="line-2440"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711516"><span class="annot"><span class="annottext">expr :: CoreExpr
</span><a href="#local-6989586621682711516"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682711517"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682711517"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2441"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; VarSet -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var">addManyOccs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#coVarsOfType"><span class="hs-identifier hs-var">coVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682711517"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711516"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2442"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711519"><span class="annot"><span class="annottext">expr :: CoreExpr
</span><a href="#local-6989586621682711519"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682711520"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711520"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2443"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; VarSet -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var">addManyOccs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionR -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#coVarsOfCo"><span class="hs-identifier hs-var">coVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711520"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711519"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2444"></span><span>        </span><span class="hs-comment">-- See Note [Gather occurrences of coercion variables]</span><span>
</span><span id="line-2445"></span><span>
</span><span id="line-2446"></span><span class="hs-comment">{- Note [Gather occurrences of coercion variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to gather info about what coercion variables appear, for two reasons:

1. So that we can sort them into the right place when doing dependency analysis.

2. So that we know when they are surely dead.

It is useful to know when they a coercion variable is surely dead,
when we want to discard a case-expression, in GHC.Core.Opt.Simplify.rebuildCase.
For example (#20143):

  case unsafeEqualityProof @blah of
     UnsafeRefl cv -&gt; ...no use of cv...

Here we can discard the case, since unsafeEqualityProof always terminates.
But only if the coercion variable 'cv' is unused.

Another example from #15696: we had something like
  case eq_sel d of co -&gt; ...(typeError @(...co...) &quot;urk&quot;)...
Then 'd' was substituted by a dictionary, so the expression
simpified to
  case (Coercion &lt;blah&gt;) of cv -&gt; ...(typeError @(...cv...) &quot;urk&quot;)...

We can only  drop the case altogether if 'cv' is unused, which is not
the case here.

Conclusion: we need accurate dead-ness info for CoVars.
We gather CoVar occurrences from:

  * The (Type ty) and (Coercion co) cases of occAnal

  * The type 'ty' of a lambda-binder (\(x:ty). blah)
    See addCoVarOccs

But it is not necessary to gather CoVars from the types of other binders.

* For let-binders, if the type mentions a CoVar, so will the RHS (since
  it has the same type)

* For case-alt binders, if the type mentions a CoVar, so will the scrutinee
  (since it has the same type)
-}</span><span>
</span><span id="line-2489"></span><span>
</span><span id="line-2490"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span id="local-6989586621682711521"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711521"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682711522"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682711522"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621682711523"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711523"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2491"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711524"><span class="hs-identifier hs-var">usage'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682711522"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711525"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2492"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2493"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711526"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711526"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621682711525"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711525"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711521"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711523"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2494"></span><span>
</span><span id="line-2495"></span><span>    </span><span id="local-6989586621682711524"><span class="annot"><span class="annottext">usage' :: UsageDetails
</span><a href="#local-6989586621682711524"><span class="hs-identifier hs-var hs-var">usage'</span></a></span></span><span>
</span><span id="line-2496"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682711522"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishScoping -&gt; Bool
forall (pass :: TickishPass).
GenTickish pass -&gt; TickishScoping -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishScopesLike"><span class="hs-operator hs-var">`tickishScopesLike`</span></a></span><span> </span><span class="annot"><span class="annottext">TickishScoping
</span><a href="GHC.Types.Tickish.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a></span><span>
</span><span id="line-2497"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711526"><span class="hs-identifier hs-var">usage</span></a></span><span>  </span><span class="hs-comment">-- For soft-scoped ticks (including SourceNotes) we don't want</span><span>
</span><span id="line-2498"></span><span>               </span><span class="hs-comment">-- to lose join-point-hood, so we don't mess with `usage` (#24078)</span><span>
</span><span id="line-2499"></span><span>
</span><span id="line-2500"></span><span>      </span><span class="hs-comment">-- For a non-soft tick scope, we can inline lambdas only, so we</span><span>
</span><span id="line-2501"></span><span>      </span><span class="hs-comment">-- abandon tail calls, and do markAllInsideLam too: usage_lam</span><span>
</span><span id="line-2502"></span><span>
</span><span id="line-2503"></span><span>      </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-type">Breakpoint</span></a></span><span> </span><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711530"><span class="annot"><span class="annottext">[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621682711530"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="annot"><span class="annottext">Module
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682711522"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-2504"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Never substitute for any of the Ids in a Breakpoint</span><span>
</span><span id="line-2505"></span><span>        </span><span class="annot"><span class="annottext">UsageDetails -&gt; VarSet -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var">addManyOccs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711531"><span class="hs-identifier hs-var">usage_lam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621682711530"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2506"></span><span>
</span><span id="line-2507"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2508"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711531"><span class="hs-identifier hs-var">usage_lam</span></a></span><span>
</span><span id="line-2509"></span><span>
</span><span id="line-2510"></span><span>    </span><span id="local-6989586621682711531"><span class="annot"><span class="annottext">usage_lam :: UsageDetails
</span><a href="#local-6989586621682711531"><span class="hs-identifier hs-var hs-var">usage_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-var">markAllNonTail</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllInsideLam"><span class="hs-identifier hs-var">markAllInsideLam</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711526"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2511"></span><span>
</span><span id="line-2512"></span><span>    </span><span class="hs-comment">-- TODO There may be ways to make ticks and join points play</span><span>
</span><span id="line-2513"></span><span>    </span><span class="hs-comment">-- nicer together, but right now there are problems:</span><span>
</span><span id="line-2514"></span><span>    </span><span class="hs-comment">--   let j x = ... in tick&lt;t&gt; (j 1)</span><span>
</span><span id="line-2515"></span><span>    </span><span class="hs-comment">-- Making j a join point may cause the simplifier to drop t</span><span>
</span><span id="line-2516"></span><span>    </span><span class="hs-comment">-- (if the tick is put into the continuation). So we don't</span><span>
</span><span id="line-2517"></span><span>    </span><span class="hs-comment">-- count j 1 as a tail call.</span><span>
</span><span id="line-2518"></span><span>    </span><span class="hs-comment">-- See #14242.</span><span>
</span><span id="line-2519"></span><span>
</span><span id="line-2520"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span id="local-6989586621682711533"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711533"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682711534"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711534"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682711535"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711535"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2521"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711536"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711536"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621682711537"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711537"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711533"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711534"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2522"></span><span>         </span><span id="local-6989586621682711538"><span class="annot"><span class="annottext">usage1 :: UsageDetails
</span><a href="#local-6989586621682711538"><span class="hs-identifier hs-var hs-var">usage1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; VarSet -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var">addManyOccs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711536"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionR -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#coVarsOfCo"><span class="hs-identifier hs-var">coVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711535"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2523"></span><span>             </span><span class="hs-comment">-- usage2: see Note [Gather occurrences of coercion variables]</span><span>
</span><span id="line-2524"></span><span>         </span><span id="local-6989586621682711539"><span class="annot"><span class="annottext">usage2 :: UsageDetails
</span><a href="#local-6989586621682711539"><span class="hs-identifier hs-var hs-var">usage2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-var">markAllNonTail</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711538"><span class="hs-identifier hs-var">usage1</span></a></span><span>
</span><span id="line-2525"></span><span>             </span><span class="hs-comment">-- usage3: calls inside expr aren't tail calls any more</span><span>
</span><span id="line-2526"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711539"><span class="hs-identifier hs-var">usage2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoercionR -&gt; CoreExpr
forall b. Expr b -&gt; CoercionR -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711537"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711535"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2527"></span><span>
</span><span id="line-2528"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span id="local-6989586621682711540"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711540"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711541"><span class="annot"><span class="annottext">app :: CoreExpr
</span><a href="#local-6989586621682711541"><span class="hs-identifier hs-var">app</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-2529"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; (CoreExpr, [CoreExpr], [CoreTickish])
-&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalApp"><span class="hs-identifier hs-var">occAnalApp</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711540"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool)
-&gt; CoreExpr -&gt; (CoreExpr, [CoreExpr], [CoreTickish])
forall b.
(CoreTickish -&gt; Bool)
-&gt; Expr b -&gt; (Expr b, [Expr b], [CoreTickish])
</span><a href="GHC.Core.html#collectArgsTicks"><span class="hs-identifier hs-var">collectArgsTicks</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711541"><span class="hs-identifier hs-var">app</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2530"></span><span>
</span><span id="line-2531"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span id="local-6989586621682711544"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711544"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711545"><span class="annot"><span class="annottext">expr :: CoreExpr
</span><a href="#local-6989586621682711545"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2532"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
-&gt; WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustNonRecRhs"><span class="hs-identifier hs-var">adjustNonRecRhs</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-var">NotJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr)
-&gt; WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- NotJoinPoint &lt;=&gt; markAllManyNonTail</span><span>
</span><span id="line-2533"></span><span>    </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalLamTail"><span class="hs-identifier hs-var">occAnalLamTail</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711544"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711545"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2534"></span><span>
</span><span id="line-2535"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span id="local-6989586621682711547"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711547"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682711548"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711548"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682711549"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711549"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682711550"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682711550"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682711551"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711551"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2536"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-2537"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711552"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711552"><span class="hs-identifier hs-var">scrut_usage</span></a></span></span><span> </span><span id="local-6989586621682711553"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711553"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; [Alt Id] -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#setScrutCtxt"><span class="hs-identifier hs-var">setScrutCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711547"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711551"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711548"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-2538"></span><span>
</span><span id="line-2539"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711555"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711555"><span class="hs-identifier hs-var">alts_usage</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711556"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711556"><span class="hs-identifier hs-var">tagged_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711557"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711557"><span class="hs-identifier hs-var">alts'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2540"></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; Id
-&gt; (OccEnv -&gt; WithUsageDetails (Id, [Alt Id]))
-&gt; WithUsageDetails (Id, [Alt Id])
forall a.
OccEnv
-&gt; Id -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeOne"><span class="hs-identifier hs-var">addInScopeOne</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711547"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711549"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">((OccEnv -&gt; WithUsageDetails (Id, [Alt Id]))
 -&gt; WithUsageDetails (Id, [Alt Id]))
-&gt; (OccEnv -&gt; WithUsageDetails (Id, [Alt Id]))
-&gt; WithUsageDetails (Id, [Alt Id])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682711558"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711558"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2541"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682711559"><span class="annot"><span class="annottext">alt_env :: OccEnv
</span><a href="#local-6989586621682711559"><span class="hs-identifier hs-var hs-var">alt_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; OccEnv -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#addBndrSwap"><span class="hs-identifier hs-var">addBndrSwap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711553"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711549"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">(OccEnv -&gt; OccEnv) -&gt; OccEnv -&gt; OccEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2542"></span><span>                         </span><span class="annot"><span class="annottext">OccEnv -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#setTailCtxt"><span class="hs-identifier hs-var">setTailCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711558"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">-- Kill off OccRhs</span><span>
</span><span id="line-2543"></span><span>               </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711562"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711562"><span class="hs-identifier hs-var">alts_usage</span></a></span></span><span> </span><span id="local-6989586621682711563"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711563"><span class="hs-identifier hs-var">alts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; [Alt Id] -&gt; WithUsageDetails [Alt Id]
</span><a href="#local-6989586621682711564"><span class="hs-identifier hs-var">do_alts</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711559"><span class="hs-identifier hs-var">alt_env</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711551"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2544"></span><span>               </span><span id="local-6989586621682711565"><span class="annot"><span class="annottext">tagged_bndr :: Id
</span><a href="#local-6989586621682711565"><span class="hs-identifier hs-var hs-var">tagged_bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#tagLamBinder"><span class="hs-identifier hs-var">tagLamBinder</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711562"><span class="hs-identifier hs-var">alts_usage</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711549"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2545"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; (Id, [Alt Id]) -&gt; WithUsageDetails (Id, [Alt Id])
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711562"><span class="hs-identifier hs-var">alts_usage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711565"><span class="hs-identifier hs-var">tagged_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711563"><span class="hs-identifier hs-var">alts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2546"></span><span>
</span><span id="line-2547"></span><span>      </span><span id="local-6989586621682711566"><span class="annot"><span class="annottext">total_usage :: UsageDetails
</span><a href="#local-6989586621682711566"><span class="hs-identifier hs-var hs-var">total_usage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-var">markAllNonTail</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711552"><span class="hs-identifier hs-var">scrut_usage</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711555"><span class="hs-identifier hs-var">alts_usage</span></a></span><span>
</span><span id="line-2548"></span><span>                    </span><span class="hs-comment">-- Alts can have tail calls, but the scrutinee can't</span><span>
</span><span id="line-2549"></span><span>
</span><span id="line-2550"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711566"><span class="hs-identifier hs-var">total_usage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; Type -&gt; [Alt Id] -&gt; CoreExpr
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711553"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711556"><span class="hs-identifier hs-var">tagged_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682711550"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711557"><span class="hs-identifier hs-var">alts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2551"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2552"></span><span>    </span><span class="annot"><a href="#local-6989586621682711564"><span class="hs-identifier hs-type">do_alts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2553"></span><span>    </span><span id="local-6989586621682711564"><span class="annot"><span class="annottext">do_alts :: OccEnv -&gt; [Alt Id] -&gt; WithUsageDetails [Alt Id]
</span><a href="#local-6989586621682711564"><span class="hs-identifier hs-var hs-var">do_alts</span></a></span></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; [Alt Id] -&gt; WithUsageDetails [Alt Id]
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2554"></span><span>    </span><span class="annot"><a href="#local-6989586621682711564"><span class="hs-identifier hs-var">do_alts</span></a></span><span> </span><span id="local-6989586621682711568"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711568"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711569"><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621682711569"><span class="hs-identifier hs-var">alt</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682711570"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711570"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; [Alt Id] -&gt; WithUsageDetails [Alt Id]
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711571"><span class="hs-identifier hs-var">uds1</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#orUDs"><span class="hs-operator hs-var">`orUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711572"><span class="hs-identifier hs-var">uds2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621682711573"><span class="hs-identifier hs-var">alt'</span></a></span><span class="annot"><span class="annottext">Alt Id -&gt; [Alt Id] -&gt; [Alt Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711574"><span class="hs-identifier hs-var">alts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2555"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2556"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711571"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711571"><span class="hs-identifier hs-var">uds1</span></a></span></span><span> </span><span id="local-6989586621682711573"><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621682711573"><span class="hs-identifier hs-var">alt'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Alt Id -&gt; WithUsageDetails (Alt Id)
</span><a href="#local-6989586621682711575"><span class="hs-identifier hs-var">do_alt</span></a></span><span>  </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711568"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621682711569"><span class="hs-identifier hs-var">alt</span></a></span><span>
</span><span id="line-2557"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711572"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711572"><span class="hs-identifier hs-var">uds2</span></a></span></span><span> </span><span id="local-6989586621682711574"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711574"><span class="hs-identifier hs-var">alts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; [Alt Id] -&gt; WithUsageDetails [Alt Id]
</span><a href="#local-6989586621682711564"><span class="hs-identifier hs-var">do_alts</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711568"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711570"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2558"></span><span>
</span><span id="line-2559"></span><span>    </span><span id="local-6989586621682711575"><span class="annot"><span class="annottext">do_alt :: OccEnv -&gt; Alt Id -&gt; WithUsageDetails (Alt Id)
</span><a href="#local-6989586621682711575"><span class="hs-identifier hs-var hs-var">do_alt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711576"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711576"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682711578"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682711578"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682711579"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711579"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682711580"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711580"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2560"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; [Id]
-&gt; (OccEnv -&gt; WithUsageDetails (Alt Id))
-&gt; WithUsageDetails (Alt Id)
forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeList"><span class="hs-identifier hs-var">addInScopeList</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711576"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711579"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">((OccEnv -&gt; WithUsageDetails (Alt Id))
 -&gt; WithUsageDetails (Alt Id))
-&gt; (OccEnv -&gt; WithUsageDetails (Alt Id))
-&gt; WithUsageDetails (Alt Id)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682711581"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711581"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2561"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711582"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711582"><span class="hs-identifier hs-var">rhs_usage</span></a></span></span><span> </span><span id="local-6989586621682711583"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711583"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711581"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711580"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2562"></span><span>            </span><span id="local-6989586621682711584"><span class="annot"><span class="annottext">tagged_bndrs :: [Id]
</span><a href="#local-6989586621682711584"><span class="hs-identifier hs-var hs-var">tagged_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; [Id] -&gt; [Id]
</span><a href="GHC.Core.Opt.OccurAnal.html#tagLamBinders"><span class="hs-identifier hs-var">tagLamBinders</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711582"><span class="hs-identifier hs-var">rhs_usage</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711579"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-2563"></span><span>        </span><span class="hs-keyword">in</span><span>                 </span><span class="hs-comment">-- See Note [Binders in case alternatives]</span><span>
</span><span id="line-2564"></span><span>        </span><span class="annot"><span class="annottext">UsageDetails -&gt; Alt Id -&gt; WithUsageDetails (Alt Id)
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711582"><span class="hs-identifier hs-var">rhs_usage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; CoreExpr -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682711578"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711584"><span class="hs-identifier hs-var">tagged_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711583"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2565"></span><span>
</span><span id="line-2566"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span id="local-6989586621682711586"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711586"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682711587"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682711587"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621682711588"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711588"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2567"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; CoreBind
-&gt; (OccEnv -&gt; WithUsageDetails CoreExpr)
-&gt; (CoreProgram -&gt; CoreExpr -&gt; CoreExpr)
-&gt; WithUsageDetails CoreExpr
forall r.
OccEnv
-&gt; TopLevelFlag
-&gt; ImpRuleEdges
-&gt; CoreBind
-&gt; (OccEnv -&gt; WithUsageDetails r)
-&gt; (CoreProgram -&gt; r -&gt; r)
-&gt; WithUsageDetails r
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalBind"><span class="hs-identifier hs-var">occAnalBind</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711586"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">ImpRuleEdges
</span><a href="GHC.Core.Opt.OccurAnal.html#noImpRuleEdges"><span class="hs-identifier hs-var">noImpRuleEdges</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682711587"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-2568"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682711590"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711590"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711590"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711588"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; CoreExpr -&gt; CoreExpr
forall b. [Bind b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLets"><span class="hs-identifier hs-var">mkLets</span></a></span><span>
</span><span id="line-2569"></span><span>
</span><span id="line-2570"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalArgs"><span class="hs-identifier hs-type">occAnalArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2571"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneShots"><span class="hs-identifier hs-type">OneShots</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Very commonly empty, notably prior to dmd anal</span><span>
</span><span id="line-2572"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2573"></span><span class="hs-comment">-- The `fun` argument is just an accumulating parameter,</span><span>
</span><span id="line-2574"></span><span class="hs-comment">-- the base for building the application we return</span><span>
</span><span id="line-2575"></span><span id="occAnalArgs"><span class="annot"><span class="annottext">occAnalArgs :: OccEnv
-&gt; CoreExpr
-&gt; [CoreExpr]
-&gt; [[OneShotInfo]]
-&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalArgs"><span class="hs-identifier hs-var hs-var">occAnalArgs</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711594"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711594"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711595"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711595"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682711596"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711596"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711597"><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711597"><span class="hs-identifier hs-var">one_shots</span></a></span></span><span>
</span><span id="line-2576"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
-&gt; CoreExpr
-&gt; [CoreExpr]
-&gt; [[OneShotInfo]]
-&gt; WithUsageDetails CoreExpr
</span><a href="#local-6989586621682711598"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711595"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711596"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711597"><span class="hs-identifier hs-var">one_shots</span></a></span><span>
</span><span id="line-2577"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2578"></span><span>    </span><span id="local-6989586621682711599"><span class="annot"><span class="annottext">env_args :: OccEnv
</span><a href="#local-6989586621682711599"><span class="hs-identifier hs-var hs-var">env_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEncl -&gt; OccEnv -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#setNonTailCtxt"><span class="hs-identifier hs-var">setNonTailCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="#local-6989586621682711601"><span class="hs-identifier hs-var">encl</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711594"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2579"></span><span>
</span><span id="line-2580"></span><span>    </span><span class="hs-comment">-- Make bottoming functions interesting</span><span>
</span><span id="line-2581"></span><span>    </span><span class="hs-comment">-- See Note [Bottoming function calls]</span><span>
</span><span id="line-2582"></span><span>    </span><span id="local-6989586621682711601"><span class="annot"><span class="annottext">encl :: OccEncl
</span><a href="#local-6989586621682711601"><span class="hs-identifier hs-var hs-var">encl</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682711602"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711602"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711595"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndSig"><span class="hs-identifier hs-var">isDeadEndSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711602"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccScrut"><span class="hs-identifier hs-var">OccScrut</span></a></span><span>
</span><span id="line-2583"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a></span><span>
</span><span id="line-2584"></span><span>
</span><span id="line-2585"></span><span>    </span><span id="local-6989586621682711598"><span class="annot"><span class="annottext">go :: UsageDetails
-&gt; CoreExpr
-&gt; [CoreExpr]
-&gt; [[OneShotInfo]]
-&gt; WithUsageDetails CoreExpr
</span><a href="#local-6989586621682711598"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682711605"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711605"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span id="local-6989586621682711606"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711606"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711605"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711606"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-2586"></span><span>    </span><span class="annot"><a href="#local-6989586621682711598"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682711607"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711607"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span id="local-6989586621682711608"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711608"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711609"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711609"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682711610"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711610"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711611"><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711611"><span class="hs-identifier hs-var">one_shots</span></a></span></span><span>
</span><span id="line-2587"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
-&gt; CoreExpr
-&gt; [CoreExpr]
-&gt; [[OneShotInfo]]
-&gt; WithUsageDetails CoreExpr
</span><a href="#local-6989586621682711598"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711607"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711612"><span class="hs-identifier hs-var">arg_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711608"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711613"><span class="hs-identifier hs-var">arg'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711610"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711614"><span class="hs-identifier hs-var">one_shots'</span></a></span><span>
</span><span id="line-2588"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2589"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711612"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711612"><span class="hs-identifier hs-var">arg_uds</span></a></span></span><span> </span><span id="local-6989586621682711613"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711613"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711615"><span class="hs-identifier hs-var">arg_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711609"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2590"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682711615"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711615"><span class="hs-identifier hs-var">arg_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711614"><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711614"><span class="hs-identifier hs-var">one_shots'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2591"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall {b}. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711609"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2592"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711599"><span class="hs-identifier hs-var">env_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711611"><span class="hs-identifier hs-var">one_shots</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2593"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2594"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711611"><span class="hs-identifier hs-var">one_shots</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2595"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711599"><span class="hs-identifier hs-var">env_args</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Fast path; one_shots is often empty</span><span>
</span><span id="line-2596"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621682711617"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711617"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682711618"><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711618"><span class="hs-identifier hs-var">one_shots'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; OccEnv -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#setOneShots"><span class="hs-identifier hs-var">setOneShots</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711617"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711599"><span class="hs-identifier hs-var">env_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711618"><span class="hs-identifier hs-var">one_shots'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2597"></span><span>
</span><span id="line-2598"></span><span class="hs-comment">{-
Applications are dealt with specially because we want
the &quot;build hack&quot; to work.

Note [Bottoming function calls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   let x = (a,b) in
   case p of
      A -&gt; ...(error x)..
      B -&gt; ...(ertor x)...

postInlineUnconditionally may duplicate x's binding, but sometimes it
does so only if the use site IsInteresting.  Pushing allocation into error
branches is good, so we try to make bottoming calls look interesting, by
setting occ_encl = OccScrut for such calls.

The slightly-artificial test T21128 is a good example.  It's probably
not a huge deal.

Note [Arguments of let-bound constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    f x = let y = expensive x in
          let z = (True,y) in
          (case z of {(p,q)-&gt;q}, case z of {(p,q)-&gt;q})
We feel free to duplicate the WHNF (True,y), but that means
that y may be duplicated thereby.

If we aren't careful we duplicate the (expensive x) call!
Constructors are rather like lambdas in this way.
-}</span><span>
</span><span id="line-2630"></span><span>
</span><span id="line-2631"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalApp"><span class="hs-identifier hs-type">occAnalApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2632"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Expr"><span class="hs-identifier hs-type">Expr</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Arg"><span class="hs-identifier hs-type">Arg</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2633"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Expr"><span class="hs-identifier hs-type">Expr</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2634"></span><span class="hs-comment">-- Naked variables (not applied) end up here too</span><span>
</span><span id="line-2635"></span><span id="occAnalApp"><span class="annot"><span class="annottext">occAnalApp :: OccEnv
-&gt; (CoreExpr, [CoreExpr], [CoreTickish])
-&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalApp"><span class="hs-identifier hs-var hs-var">occAnalApp</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711621"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711621"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682711622"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711622"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711623"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711623"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711624"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682711624"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2636"></span><span>  </span><span class="hs-comment">-- Account for join arity of runRW# continuation</span><span>
</span><span id="line-2637"></span><span>  </span><span class="hs-comment">-- See Note [Simplification of runRW#]</span><span>
</span><span id="line-2638"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-2639"></span><span>  </span><span class="hs-comment">-- NB: Do not be tempted to make the next (Var fun, args, tick)</span><span>
</span><span id="line-2640"></span><span>  </span><span class="hs-comment">--     equation into an 'otherwise' clause for this equation</span><span>
</span><span id="line-2641"></span><span>  </span><span class="hs-comment">--     The former has a bang-pattern to occ-anal the args, and</span><span>
</span><span id="line-2642"></span><span>  </span><span class="hs-comment">--     we don't want to occ-anal them twice in the runRW# case!</span><span>
</span><span id="line-2643"></span><span>  </span><span class="hs-comment">--     This caused #18296</span><span>
</span><span id="line-2644"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711622"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#runRWKey"><span class="hs-identifier hs-var">runRWKey</span></a></span><span>
</span><span id="line-2645"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621682711626"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711626"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711627"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711627"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711628"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711628"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711623"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2646"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711629"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711629"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621682711630"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711630"><span class="hs-identifier hs-var">arg'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
-&gt; WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustNonRecRhs"><span class="hs-identifier hs-var">adjustNonRecRhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; JoinPointHood
</span><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-var">JoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr)
-&gt; WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalLamTail"><span class="hs-identifier hs-var">occAnalLamTail</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711621"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711628"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2647"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711629"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682711624"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711622"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711626"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711627"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711630"><span class="hs-identifier hs-var">arg'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2648"></span><span>
</span><span id="line-2649"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalApp"><span class="hs-identifier hs-var">occAnalApp</span></a></span><span> </span><span id="local-6989586621682711632"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711632"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682711633"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711633"><span class="hs-identifier hs-var">fun_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711634"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711634"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711635"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682711635"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2650"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711636"><span class="hs-identifier hs-var">all_uds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682711635"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711637"><span class="hs-identifier hs-var">app'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2651"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2652"></span><span>    </span><span class="hs-comment">-- Lots of banged bindings: this is a very heavily bit of code,</span><span>
</span><span id="line-2653"></span><span>    </span><span class="hs-comment">-- so it pays not to make lots of thunks here, all of which</span><span>
</span><span id="line-2654"></span><span>    </span><span class="hs-comment">-- will ultimately be forced.</span><span>
</span><span id="line-2655"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682711638"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711638"><span class="hs-identifier hs-var">fun'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711639"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711639"><span class="hs-identifier hs-var">fun_id'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Id -&gt; (CoreExpr, Id)
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupBndrSwap"><span class="hs-identifier hs-var">lookupBndrSwap</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711632"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711633"><span class="hs-identifier hs-var">fun_id</span></a></span><span>
</span><span id="line-2656"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711641"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711641"><span class="hs-identifier hs-var">args_uds</span></a></span></span><span> </span><span id="local-6989586621682711637"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711637"><span class="hs-identifier hs-var">app'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; CoreExpr
-&gt; [CoreExpr]
-&gt; [[OneShotInfo]]
-&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalArgs"><span class="hs-identifier hs-var">occAnalArgs</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711632"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711638"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711634"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[[OneShotInfo]]
</span><a href="#local-6989586621682711642"><span class="hs-identifier hs-var">one_shots</span></a></span><span>
</span><span id="line-2657"></span><span>
</span><span id="line-2658"></span><span>    </span><span id="local-6989586621682711643"><span class="annot"><span class="annottext">fun_uds :: UsageDetails
</span><a href="#local-6989586621682711643"><span class="hs-identifier hs-var hs-var">fun_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Id -&gt; InterestingCxt -&gt; JoinArity -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#mkOneOcc"><span class="hs-identifier hs-var">mkOneOcc</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711632"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711639"><span class="hs-identifier hs-var">fun_id'</span></a></span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682711645"><span class="hs-identifier hs-var">int_cxt</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711646"><span class="hs-identifier hs-var">n_args</span></a></span><span>
</span><span id="line-2659"></span><span>       </span><span class="hs-comment">-- NB: fun_uds is computed for fun_id', not fun_id</span><span>
</span><span id="line-2660"></span><span>       </span><span class="hs-comment">-- See (BS1) in Note [The binder-swap substitution]</span><span>
</span><span id="line-2661"></span><span>
</span><span id="line-2662"></span><span>    </span><span id="local-6989586621682711636"><span class="annot"><span class="annottext">all_uds :: UsageDetails
</span><a href="#local-6989586621682711636"><span class="hs-identifier hs-var hs-var">all_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711643"><span class="hs-identifier hs-var">fun_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711647"><span class="hs-identifier hs-var">final_args_uds</span></a></span><span>
</span><span id="line-2663"></span><span>
</span><span id="line-2664"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682711647"><span class="annot"><span class="annottext">final_args_uds :: UsageDetails
</span><a href="#local-6989586621682711647"><span class="hs-identifier hs-var hs-var">final_args_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-var">markAllNonTail</span></a></span><span>                              </span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails) -&gt; UsageDetails -&gt; UsageDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2665"></span><span>                      </span><span class="annot"><span class="annottext">Bool -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllInsideLamIf"><span class="hs-identifier hs-var">markAllInsideLamIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isRhsEnv"><span class="hs-identifier hs-var">isRhsEnv</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711632"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711649"><span class="hs-identifier hs-var">is_exp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails) -&gt; UsageDetails -&gt; UsageDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2666"></span><span>                        </span><span class="hs-comment">-- isRhsEnv: see Note [OccEncl]</span><span>
</span><span id="line-2667"></span><span>                      </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711641"><span class="hs-identifier hs-var">args_uds</span></a></span><span>
</span><span id="line-2668"></span><span>       </span><span class="hs-comment">-- We mark the free vars of the argument of a constructor or PAP</span><span>
</span><span id="line-2669"></span><span>       </span><span class="hs-comment">-- as &quot;inside-lambda&quot;, if it is the RHS of a let(rec).</span><span>
</span><span id="line-2670"></span><span>       </span><span class="hs-comment">-- This means that nothing gets inlined into a constructor or PAP</span><span>
</span><span id="line-2671"></span><span>       </span><span class="hs-comment">-- argument position, which is what we want.  Typically those</span><span>
</span><span id="line-2672"></span><span>       </span><span class="hs-comment">-- constructor arguments are just variables, or trivial expressions.</span><span>
</span><span id="line-2673"></span><span>       </span><span class="hs-comment">-- We use inside-lam because it's like eta-expanding the PAP.</span><span>
</span><span id="line-2674"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-2675"></span><span>       </span><span class="hs-comment">-- This is the *whole point* of the isRhsEnv predicate</span><span>
</span><span id="line-2676"></span><span>       </span><span class="hs-comment">-- See Note [Arguments of let-bound constructors]</span><span>
</span><span id="line-2677"></span><span>
</span><span id="line-2678"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682711650"><span class="annot"><span class="annottext">n_val_args :: JoinArity
</span><a href="#local-6989586621682711650"><span class="hs-identifier hs-var hs-var">n_val_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; JoinArity
forall b. [Arg b] -&gt; JoinArity
</span><a href="GHC.Core.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711634"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2679"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682711646"><span class="annot"><span class="annottext">n_args :: JoinArity
</span><a href="#local-6989586621682711646"><span class="hs-identifier hs-var hs-var">n_args</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; JoinArity
forall a. [a] -&gt; JoinArity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; JoinArity
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711634"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2680"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682711645"><span class="annot"><span class="annottext">int_cxt :: InterestingCxt
</span><a href="#local-6989586621682711645"><span class="hs-identifier hs-var hs-var">int_cxt</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var">occ_encl</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711632"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2681"></span><span>                   </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccScrut"><span class="hs-identifier hs-var">OccScrut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="GHC.Types.Basic.html#IsInteresting"><span class="hs-identifier hs-var">IsInteresting</span></a></span><span>
</span><span id="line-2682"></span><span>                   </span><span id="local-6989586621682711653"><span class="annot"><span class="annottext">OccEncl
</span><a href="#local-6989586621682711653"><span class="hs-identifier hs-var">_other</span></a></span></span><span>   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711650"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="GHC.Types.Basic.html#IsInteresting"><span class="hs-identifier hs-var">IsInteresting</span></a></span><span>
</span><span id="line-2683"></span><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="GHC.Types.Basic.html#NotInteresting"><span class="hs-identifier hs-var">NotInteresting</span></a></span><span>
</span><span id="line-2684"></span><span>
</span><span id="line-2685"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682711649"><span class="annot"><span class="annottext">is_exp :: Bool
</span><a href="#local-6989586621682711649"><span class="hs-identifier hs-var hs-var">is_exp</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheapAppFun
</span><a href="GHC.Core.Utils.html#isExpandableApp"><span class="hs-identifier hs-var">isExpandableApp</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711633"><span class="hs-identifier hs-var">fun_id</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711650"><span class="hs-identifier hs-var">n_val_args</span></a></span><span>
</span><span id="line-2686"></span><span>        </span><span class="hs-comment">-- See Note [CONLIKE pragma] in GHC.Types.Basic</span><span>
</span><span id="line-2687"></span><span>        </span><span class="hs-comment">-- The definition of is_exp should match that in GHC.Core.Opt.Simplify.prepareRhs</span><span>
</span><span id="line-2688"></span><span>
</span><span id="line-2689"></span><span>    </span><span id="local-6989586621682711642"><span class="annot"><span class="annottext">one_shots :: [[OneShotInfo]]
</span><a href="#local-6989586621682711642"><span class="hs-identifier hs-var hs-var">one_shots</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; JoinArity -&gt; [[OneShotInfo]]
</span><a href="GHC.Types.Demand.html#argsOneShots"><span class="hs-identifier hs-var">argsOneShots</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711633"><span class="hs-identifier hs-var">fun_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711655"><span class="hs-identifier hs-var">guaranteed_val_args</span></a></span><span>
</span><span id="line-2690"></span><span>    </span><span id="local-6989586621682711655"><span class="annot"><span class="annottext">guaranteed_val_args :: JoinArity
</span><a href="#local-6989586621682711655"><span class="hs-identifier hs-var hs-var">guaranteed_val_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711650"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; JoinArity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; JoinArity
forall a. [a] -&gt; JoinArity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; JoinArity
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(OneShotInfo -&gt; Bool) -&gt; [OneShotInfo] -&gt; [OneShotInfo]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">takeWhile</span></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOneShotInfo"><span class="hs-identifier hs-var">isOneShotInfo</span></a></span><span>
</span><span id="line-2691"></span><span>                                                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711632"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2692"></span><span>        </span><span class="hs-comment">-- See Note [Sources of one-shot information], bullet point A']</span><span>
</span><span id="line-2693"></span><span>
</span><span id="line-2694"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occAnalApp"><span class="hs-identifier hs-var">occAnalApp</span></a></span><span> </span><span id="local-6989586621682711658"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711658"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711659"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711659"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711660"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711660"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711661"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682711661"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2695"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-var">markAllNonTail</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711662"><span class="hs-identifier hs-var">fun_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-operator hs-var">`andUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711663"><span class="hs-identifier hs-var">args_uds</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2696"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682711661"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711664"><span class="hs-identifier hs-var">app'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2697"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2698"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711663"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711663"><span class="hs-identifier hs-var">args_uds</span></a></span></span><span> </span><span id="local-6989586621682711664"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711664"><span class="hs-identifier hs-var">app'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; CoreExpr
-&gt; [CoreExpr]
-&gt; [[OneShotInfo]]
-&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnalArgs"><span class="hs-identifier hs-var">occAnalArgs</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711658"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711665"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711660"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2699"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711662"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711662"><span class="hs-identifier hs-var">fun_uds</span></a></span></span><span> </span><span id="local-6989586621682711665"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711665"><span class="hs-identifier hs-var">fun'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; [CoreExpr] -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#addAppCtxt"><span class="hs-identifier hs-var">addAppCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711658"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711660"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711659"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-2700"></span><span>        </span><span class="hs-comment">-- The addAppCtxt is a bit cunning.  One iteration of the simplifier</span><span>
</span><span id="line-2701"></span><span>        </span><span class="hs-comment">-- often leaves behind beta redexes like</span><span>
</span><span id="line-2702"></span><span>        </span><span class="hs-comment">--      (\x y -&gt; e) a1 a2</span><span>
</span><span id="line-2703"></span><span>        </span><span class="hs-comment">-- Here we would like to mark x,y as one-shot, and treat the whole</span><span>
</span><span id="line-2704"></span><span>        </span><span class="hs-comment">-- thing much like a let.  We do this by pushing some OneShotLam items</span><span>
</span><span id="line-2705"></span><span>        </span><span class="hs-comment">-- onto the context stack.</span><span>
</span><span id="line-2706"></span><span>
</span><span id="line-2707"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addAppCtxt"><span class="hs-identifier hs-type">addAppCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Arg"><span class="hs-identifier hs-type">Arg</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2708"></span><span id="addAppCtxt"><span class="annot"><span class="annottext">addAppCtxt :: OccEnv -&gt; [CoreExpr] -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#addAppCtxt"><span class="hs-identifier hs-var hs-var">addAppCtxt</span></a></span></span><span> </span><span id="local-6989586621682711667"><span class="annot"><span class="annottext">env :: OccEnv
</span><a href="#local-6989586621682711667"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_one_shots :: OccEnv -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711669"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711669"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711670"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711670"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-2709"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711671"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2710"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711667"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">replicate</span></span><span> </span><span class="annot"><a href="#local-6989586621682711671"><span class="hs-identifier hs-type">n_val_args</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-type">OneShotLam</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682711669"><span class="hs-identifier hs-type">ctxt</span></a></span><span>
</span><span id="line-2711"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var">occ_encl</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-type">OccVanilla</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2712"></span><span>          </span><span class="hs-comment">-- OccVanilla: the function part of the application</span><span>
</span><span id="line-2713"></span><span>          </span><span class="hs-comment">-- is no longer on OccRhs or OccScrut</span><span>
</span><span id="line-2714"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2715"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711667"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2716"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2717"></span><span>    </span><span id="local-6989586621682711671"><span class="annot"><span class="annottext">n_val_args :: JoinArity
</span><a href="#local-6989586621682711671"><span class="hs-identifier hs-var hs-var">n_val_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; JoinArity
forall b. [Arg b] -&gt; JoinArity
</span><a href="GHC.Core.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682711670"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2718"></span><span>
</span><span id="line-2719"></span><span>
</span><span id="line-2720"></span><span class="hs-comment">{-
Note [Sources of one-shot information]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The occurrence analyser obtains one-shot-lambda information from two sources:

A:  Saturated applications:  eg   f e1 .. en

    In general, given a call (f e1 .. en) we can propagate one-shot info from
    f's strictness signature into e1 .. en, but /only/ if n is enough to
    saturate the strictness signature. A strictness signature like

          f :: C(1,C(1,L))LS

    means that *if f is applied to three arguments* then it will guarantee to
    call its first argument at most once, and to call the result of that at
    most once. But if f has fewer than three arguments, all bets are off; e.g.

          map (f (\x y. expensive) e2) xs

    Here the \x y abstraction may be called many times (once for each element of
    xs) so we should not mark x and y as one-shot. But if it was

          map (f (\x y. expensive) 3 2) xs

    then the first argument of f will be called at most once.

    The one-shot info, derived from f's strictness signature, is
    computed by 'argsOneShots', called in occAnalApp.

A': Non-obviously saturated applications: eg    build (f (\x y -&gt; expensive))
    where f is as above.

    In this case, f is only manifestly applied to one argument, so it does not
    look saturated. So by the previous point, we should not use its strictness
    signature to learn about the one-shotness of \x y. But in this case we can:
    build is fully applied, so we may use its strictness signature; and from
    that we learn that build calls its argument with two arguments *at most once*.

    So there is really only one call to f, and it will have three arguments. In
    that sense, f is saturated, and we may proceed as described above.

    Hence the computation of 'guaranteed_val_args' in occAnalApp, using
    '(occ_one_shots env)'.  See also #13227, comment:9

B:  Let-bindings:  eg   let f = \c. let ... in \n -&gt; blah
                        in (build f, build f)

    Propagate one-shot info from the demand-info on 'f' to the
    lambdas in its RHS (which may not be syntactically at the top)

    This information must have come from a previous run of the demand
    analyser.

Previously, the demand analyser would *also* set the one-shot information, but
that code was buggy (see #11770), so doing it only in on place, namely here, is
saner.

Note [OneShots]
~~~~~~~~~~~~~~~
When analysing an expression, the occ_one_shots argument contains information
about how the function is being used. The length of the list indicates
how many arguments will eventually be passed to the analysed expression,
and the OneShotInfo indicates whether this application is once or multiple times.

Example:

 Context of f                occ_one_shots when analysing f

 f 1 2                       [OneShot, OneShot]
 map (f 1)                   [OneShot, NoOneShotInfo]
 build f                     [OneShot, OneShot]
 f 1 2 `seq` f 2 1           [NoOneShotInfo, OneShot]

Note [Binders in case alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    case x of y { (a,b) -&gt; f y }
We treat 'a', 'b' as dead, because they don't physically occur in the
case alternative.  (Indeed, a variable is dead iff it doesn't occur in
its scope in the output of OccAnal.)  It really helps to know when
binders are unused.  See esp the call to isDeadBinder in
Simplify.mkDupableAlt

In this example, though, the Simplifier will bring 'a' and 'b' back to
life, because it binds 'y' to (a,b) (imagine got inlined and
scrutinised y).
-}</span><span>
</span><span id="line-2807"></span><span>
</span><span id="line-2808"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                    OccEnv
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-2815"></span><span>
</span><span id="line-2816"></span><span class="hs-keyword">data</span><span> </span><span id="OccEnv"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-var">OccEnv</span></a></span></span><span>
</span><span id="line-2817"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="OccEnv"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-var">OccEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="occ_encl"><span class="annot"><span class="annottext">OccEnv -&gt; OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var hs-var">occ_encl</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEncl"><span class="hs-identifier hs-type">OccEncl</span></a></span><span>      </span><span class="hs-comment">-- Enclosing context information</span><span>
</span><span id="line-2818"></span><span>           </span><span class="hs-special">,</span><span> </span><span id="occ_one_shots"><span class="annot"><span class="annottext">OccEnv -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var hs-var">occ_one_shots</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneShots"><span class="hs-identifier hs-type">OneShots</span></a></span><span>     </span><span class="hs-comment">-- See Note [OneShots]</span><span>
</span><span id="line-2819"></span><span>           </span><span class="hs-special">,</span><span> </span><span id="occ_unf_act"><span class="annot"><span class="annottext">OccEnv -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_unf_act"><span class="hs-identifier hs-var hs-var">occ_unf_act</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>          </span><span class="hs-comment">-- Which Id unfoldings are active</span><span>
</span><span id="line-2820"></span><span>           </span><span class="hs-special">,</span><span> </span><span id="occ_rule_act"><span class="annot"><span class="annottext">OccEnv -&gt; Activation -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_rule_act"><span class="hs-identifier hs-var hs-var">occ_rule_act</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>  </span><span class="hs-comment">-- Which rules are active</span><span>
</span><span id="line-2821"></span><span>             </span><span class="hs-comment">-- See Note [Finding rule RHS free vars]</span><span>
</span><span id="line-2822"></span><span>
</span><span id="line-2823"></span><span>           </span><span class="hs-comment">-- See Note [The binder-swap substitution]</span><span>
</span><span id="line-2824"></span><span>           </span><span class="hs-comment">-- If  x :-&gt; (y, co)  is in the env,</span><span>
</span><span id="line-2825"></span><span>           </span><span class="hs-comment">-- then please replace x by (y |&gt; mco)</span><span>
</span><span id="line-2826"></span><span>           </span><span class="hs-comment">-- Invariant of course: idType x = exprType (y |&gt; mco)</span><span>
</span><span id="line-2827"></span><span>           </span><span class="hs-special">,</span><span> </span><span id="occ_bs_env"><span class="annot"><span class="annottext">OccEnv -&gt; IdEnv (Id, MCoercion)
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var hs-var">occ_bs_env</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2828"></span><span>              </span><span class="hs-comment">-- Domain is Global and Local Ids</span><span>
</span><span id="line-2829"></span><span>              </span><span class="hs-comment">-- Range is just Local Ids</span><span>
</span><span id="line-2830"></span><span>           </span><span class="hs-special">,</span><span> </span><span id="occ_bs_rng"><span class="annot"><span class="annottext">OccEnv -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_rng"><span class="hs-identifier hs-var hs-var">occ_bs_rng</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-2831"></span><span>               </span><span class="hs-comment">-- Vars (TyVars and Ids) free in the range of occ_bs_env</span><span>
</span><span id="line-2832"></span><span>
</span><span id="line-2833"></span><span>             </span><span class="hs-comment">-- Usage details of the RHS of in-scope non-recursive join points</span><span>
</span><span id="line-2834"></span><span>             </span><span class="hs-comment">-- Invariant: no Id maps to an empty OccInfoEnv</span><span>
</span><span id="line-2835"></span><span>             </span><span class="hs-comment">-- See Note [Occurrence analysis for join points]</span><span>
</span><span id="line-2836"></span><span>           </span><span class="hs-special">,</span><span> </span><span id="occ_join_points"><span class="annot"><span class="annottext">OccEnv -&gt; JoinPointInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var hs-var">occ_join_points</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#JoinPointInfo"><span class="hs-identifier hs-type">JoinPointInfo</span></a></span><span>
</span><span id="line-2837"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-2838"></span><span>
</span><span id="line-2839"></span><span class="hs-keyword">type</span><span> </span><span id="JoinPointInfo"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#JoinPointInfo"><span class="hs-identifier hs-var">JoinPointInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span>
</span><span id="line-2840"></span><span>
</span><span id="line-2841"></span><span class="hs-comment">-----------------------------</span><span>
</span><span id="line-2842"></span><span class="hs-comment">{- Note [OccEncl]
~~~~~~~~~~~~~~~~~
OccEncl is used to control whether to inline into constructor arguments.

* OccRhs: consider
     let p = &lt;blah&gt; in
     let x = Just p
     in ...case p of ...

  Here `p` occurs syntactically once, but we want to mark it as InsideLam
  to stop `p` inlining.  We want to leave the x-binding as a constructor
  applied to variables, so that the Simplifier can simplify that inner `case`.

  The OccRhs just tells occAnalApp to mark occurrences in constructor args

* OccScrut: consider (case x of ...).  Here we want to give `x` OneOcc
  with &quot;interesting context&quot; field int_cxt = True.  The OccScrut tells
  occAnalApp (which deals with lone variables too) when to set this field
  to True.
-}</span><span>
</span><span id="line-2862"></span><span>
</span><span id="line-2863"></span><span class="hs-keyword">data</span><span> </span><span id="OccEncl"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEncl"><span class="hs-identifier hs-var">OccEncl</span></a></span></span><span> </span><span class="hs-comment">-- See Note [OccEncl]</span><span>
</span><span id="line-2864"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="OccRhs"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccRhs"><span class="hs-identifier hs-var">OccRhs</span></a></span></span><span>         </span><span class="hs-comment">-- RHS of let(rec), albeit perhaps inside a type lambda</span><span>
</span><span id="line-2865"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="OccScrut"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccScrut"><span class="hs-identifier hs-var">OccScrut</span></a></span></span><span>       </span><span class="hs-comment">-- Scrutintee of a case</span><span>
</span><span id="line-2866"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="OccVanilla"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a></span></span><span>     </span><span class="hs-comment">-- Everything else</span><span>
</span><span id="line-2867"></span><span>
</span><span id="line-2868"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEncl"><span class="hs-identifier hs-type">OccEncl</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2869"></span><span>  </span><span id="local-6989586621682711684"><span class="annot"><span class="annottext">ppr :: OccEncl -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccRhs"><span class="hs-identifier hs-var">OccRhs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;occRhs&quot;</span></span><span>
</span><span id="line-2870"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccScrut"><span class="hs-identifier hs-var">OccScrut</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;occScrut&quot;</span></span><span>
</span><span id="line-2871"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;occVanilla&quot;</span></span><span>
</span><span id="line-2872"></span><span>
</span><span id="line-2873"></span><span class="hs-comment">-- See Note [OneShots]</span><span>
</span><span id="line-2874"></span><span class="hs-keyword">type</span><span> </span><span id="OneShots"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneShots"><span class="hs-identifier hs-var">OneShots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2875"></span><span>
</span><span id="line-2876"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#initOccEnv"><span class="hs-identifier hs-type">initOccEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2877"></span><span id="initOccEnv"><span class="annot"><span class="annottext">initOccEnv :: OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#initOccEnv"><span class="hs-identifier hs-var hs-var">initOccEnv</span></a></span></span><span>
</span><span id="line-2878"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_encl :: OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var">occ_encl</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a></span><span>
</span><span id="line-2879"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_one_shots :: [OneShotInfo]
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2880"></span><span>
</span><span id="line-2881"></span><span>                 </span><span class="hs-comment">-- To be conservative, we say that all</span><span>
</span><span id="line-2882"></span><span>                 </span><span class="hs-comment">-- inlines and rules are active</span><span>
</span><span id="line-2883"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_unf_act :: Id -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_unf_act"><span class="hs-identifier hs-var">occ_unf_act</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2884"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_rule_act :: Activation -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_rule_act"><span class="hs-identifier hs-var">occ_rule_act</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Activation
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2885"></span><span>
</span><span id="line-2886"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_join_points :: JoinPointInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointInfo
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-2887"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_bs_env :: IdEnv (Id, MCoercion)
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var">occ_bs_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdEnv (Id, MCoercion)
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-2888"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_bs_rng :: VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_rng"><span class="hs-identifier hs-var">occ_bs_rng</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2889"></span><span>
</span><span id="line-2890"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#noBinderSwaps"><span class="hs-identifier hs-type">noBinderSwaps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2891"></span><span id="noBinderSwaps"><span class="annot"><span class="annottext">noBinderSwaps :: OccEnv -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#noBinderSwaps"><span class="hs-identifier hs-var hs-var">noBinderSwaps</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_bs_env :: OccEnv -&gt; IdEnv (Id, MCoercion)
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var">occ_bs_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711685"><span class="annot"><span class="annottext">IdEnv (Id, MCoercion)
</span><a href="#local-6989586621682711685"><span class="hs-identifier hs-var">bs_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdEnv (Id, MCoercion) -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv (Id, MCoercion)
</span><a href="#local-6989586621682711685"><span class="hs-identifier hs-var">bs_env</span></a></span><span>
</span><span id="line-2892"></span><span>
</span><span id="line-2893"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#setScrutCtxt"><span class="hs-identifier hs-type">setScrutCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2894"></span><span id="setScrutCtxt"><span class="annot"><span class="annottext">setScrutCtxt :: OccEnv -&gt; [Alt Id] -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#setScrutCtxt"><span class="hs-identifier hs-var hs-var">setScrutCtxt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711687"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711687"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711688"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711688"><span class="hs-identifier hs-var">alts</span></a></span></span><span>
</span><span id="line-2895"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEncl -&gt; OccEnv -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#setNonTailCtxt"><span class="hs-identifier hs-var">setNonTailCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="#local-6989586621682711689"><span class="hs-identifier hs-var">encl</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711687"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2896"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2897"></span><span>    </span><span id="local-6989586621682711689"><span class="annot"><span class="annottext">encl :: OccEncl
</span><a href="#local-6989586621682711689"><span class="hs-identifier hs-var hs-var">encl</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711690"><span class="hs-identifier hs-var">interesting_alts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccScrut"><span class="hs-identifier hs-var">OccScrut</span></a></span><span>
</span><span id="line-2898"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a></span><span>
</span><span id="line-2899"></span><span>
</span><span id="line-2900"></span><span>    </span><span id="local-6989586621682711690"><span class="annot"><span class="annottext">interesting_alts :: Bool
</span><a href="#local-6989586621682711690"><span class="hs-identifier hs-var hs-var">interesting_alts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682711688"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2901"></span><span>                         </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2902"></span><span>                         </span><span class="hs-special">[</span><span id="local-6989586621682711691"><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621682711691"><span class="hs-identifier hs-var">alt</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt Id -&gt; Bool
forall b. Alt b -&gt; Bool
</span><a href="GHC.Core.Utils.html#isDefaultAlt"><span class="hs-identifier hs-var">isDefaultAlt</span></a></span><span> </span><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621682711691"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2903"></span><span>                         </span><span class="annot"><span class="annottext">[Alt Id]
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2904"></span><span>     </span><span class="hs-comment">-- 'interesting_alts' is True if the case has at least one</span><span>
</span><span id="line-2905"></span><span>     </span><span class="hs-comment">-- non-default alternative.  That in turn influences</span><span>
</span><span id="line-2906"></span><span>     </span><span class="hs-comment">-- pre/postInlineUnconditionally.  Grep for &quot;occ_int_cxt&quot;!</span><span>
</span><span id="line-2907"></span><span>
</span><span id="line-2908"></span><span class="hs-comment">{- Note [The OccEnv for a right hand side]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
How do we create the OccEnv for a RHS (in mkRhsOccEnv)?

For a non-join point binding, x = rhs

  * occ_encl: set to OccRhs; but see `mkNonRecRhsCtxt` for wrinkles

  * occ_join_points: zap them!

  * occ_one_shots: initialise from the idDemandInfo;
    see Note [Sources of one-shot information]

For a join point binding,  j x = rhs

  * occ_encl: Consider
       x = e
       join j = Just x
    We want to inline x into j right away, so we don't want to give the join point
    a OccRhs (#14137); we want OccVanilla.  It's not a huge deal, because the
    FloatIn pass knows to float into join point RHSs; and the simplifier does not
    float things out of join point RHSs.  But it's a simple, cheap thing to do.

  * occ_join_points: no need to zap.

  * occ_one_shots: we start with one-shot-info from the context, which indeed
    applies to the /body/ of the join point, after walking past the binders.
    So we add to the front a OneShotInfo for each value-binder of the join
    point: see `extendOneShotsForJoinPoint`. (Failing to account for the join-point
    binders caused #25096.)

    For the join point binders themselves, of a /non-recursive/ join point,
    we make the binder a OneShotLam.  Again see `extendOneShotsForJoinPoint`.

    These one-shot infos then get attached to the binder by `occAnalLamTail`.
-}</span><span>
</span><span id="line-2944"></span><span>
</span><span id="line-2945"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#setNonTailCtxt"><span class="hs-identifier hs-type">setNonTailCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEncl"><span class="hs-identifier hs-type">OccEncl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2946"></span><span id="setNonTailCtxt"><span class="annot"><span class="annottext">setNonTailCtxt :: OccEncl -&gt; OccEnv -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#setNonTailCtxt"><span class="hs-identifier hs-var hs-var">setNonTailCtxt</span></a></span></span><span> </span><span id="local-6989586621682711692"><span class="annot"><span class="annottext">OccEncl
</span><a href="#local-6989586621682711692"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711693"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711693"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-2947"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711693"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var">occ_encl</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711692"><span class="hs-identifier hs-type">ctxt</span></a></span><span>
</span><span id="line-2948"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2949"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#zapJoinPointInfo"><span class="hs-identifier hs-type">zapJoinPointInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711693"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2950"></span><span>
</span><span id="line-2951"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#setTailCtxt"><span class="hs-identifier hs-type">setTailCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2952"></span><span id="setTailCtxt"><span class="annot"><span class="annottext">setTailCtxt :: OccEnv -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#setTailCtxt"><span class="hs-identifier hs-var hs-var">setTailCtxt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711695"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711695"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711695"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var">occ_encl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-type">OccVanilla</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2953"></span><span>    </span><span class="hs-comment">-- Preserve occ_one_shots, occ_join points</span><span>
</span><span id="line-2954"></span><span>    </span><span class="hs-comment">-- Do not use OccRhs for the RHS of a join point (which is a tail ctxt):</span><span>
</span><span id="line-2955"></span><span>
</span><span id="line-2956"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#mkRhsOccEnv"><span class="hs-identifier hs-type">mkRhsOccEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEncl"><span class="hs-identifier hs-type">OccEncl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPointHood"><span class="hs-identifier hs-type">JoinPointHood</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-2957"></span><span class="hs-comment">-- See Note [The OccEnv for a right hand side]</span><span>
</span><span id="line-2958"></span><span class="hs-comment">-- For a join point:</span><span>
</span><span id="line-2959"></span><span class="hs-comment">--   - Keep occ_one_shots, occ_joinPoints from the context</span><span>
</span><span id="line-2960"></span><span class="hs-comment">--   - But push enough OneShotInfo onto occ_one_shots to account</span><span>
</span><span id="line-2961"></span><span class="hs-comment">--     for the join-point value binders</span><span>
</span><span id="line-2962"></span><span class="hs-comment">--   - Set occ_encl to OccVanilla</span><span>
</span><span id="line-2963"></span><span class="hs-comment">-- For non-join points</span><span>
</span><span id="line-2964"></span><span class="hs-comment">--   - Zap occ_one_shots and occ_join_points</span><span>
</span><span id="line-2965"></span><span class="hs-comment">--   - Set occ_encl to specified OccEncl</span><span>
</span><span id="line-2966"></span><span id="mkRhsOccEnv"><span class="annot"><span class="annottext">mkRhsOccEnv :: OccEnv
-&gt; RecFlag -&gt; OccEncl -&gt; JoinPointHood -&gt; Id -&gt; CoreExpr -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#mkRhsOccEnv"><span class="hs-identifier hs-var hs-var">mkRhsOccEnv</span></a></span></span><span> </span><span id="local-6989586621682711696"><span class="annot"><span class="annottext">env :: OccEnv
</span><a href="#local-6989586621682711696"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_one_shots :: OccEnv -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711697"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711697"><span class="hs-identifier hs-var">ctxt_one_shots</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_join_points :: OccEnv -&gt; JoinPointInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711698"><span class="annot"><span class="annottext">JoinPointInfo
</span><a href="#local-6989586621682711698"><span class="hs-identifier hs-var">ctxt_join_points</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2967"></span><span>            </span><span id="local-6989586621682711699"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682711699"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621682711700"><span class="annot"><span class="annottext">OccEncl
</span><a href="#local-6989586621682711700"><span class="hs-identifier hs-var">encl</span></a></span></span><span> </span><span id="local-6989586621682711701"><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682711701"><span class="hs-identifier hs-var">jp_hood</span></a></span></span><span> </span><span id="local-6989586621682711702"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711702"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682711703"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711703"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2968"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span id="local-6989586621682711704"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711704"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682711701"><span class="hs-identifier hs-var">jp_hood</span></a></span><span>
</span><span id="line-2969"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711696"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var">occ_encl</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccVanilla"><span class="hs-identifier hs-type">OccVanilla</span></a></span><span>
</span><span id="line-2970"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#extendOneShotsForJoinPoint"><span class="hs-identifier hs-type">extendOneShotsForJoinPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711699"><span class="hs-identifier hs-type">is_rec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711704"><span class="hs-identifier hs-type">join_arity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711703"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711697"><span class="hs-identifier hs-type">ctxt_one_shots</span></a></span><span>
</span><span id="line-2971"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711698"><span class="hs-identifier hs-type">ctxt_join_points</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2972"></span><span>
</span><span id="line-2973"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2974"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711696"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var">occ_encl</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711700"><span class="hs-identifier hs-type">encl</span></a></span><span>
</span><span id="line-2975"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#argOneShots"><span class="hs-identifier hs-type">argOneShots</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-type">idDemandInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711702"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2976"></span><span>                            </span><span class="hs-comment">-- argOneShots: see Note [Sources of one-shot information]</span><span>
</span><span id="line-2977"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#zapJoinPointInfo"><span class="hs-identifier hs-type">zapJoinPointInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711698"><span class="hs-identifier hs-type">ctxt_join_points</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2978"></span><span>
</span><span id="line-2979"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#zapJoinPointInfo"><span class="hs-identifier hs-type">zapJoinPointInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#JoinPointInfo"><span class="hs-identifier hs-type">JoinPointInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#JoinPointInfo"><span class="hs-identifier hs-type">JoinPointInfo</span></a></span><span>
</span><span id="line-2980"></span><span class="hs-comment">-- (zapJoinPointInfo jp_info) basically just returns emptyVarEnv (hence zapped).</span><span>
</span><span id="line-2981"></span><span class="hs-comment">-- See (W3) of Note [Occurrence analysis for join points]</span><span>
</span><span id="line-2982"></span><span class="hs-comment">--</span><span>
</span><span id="line-2983"></span><span class="hs-comment">-- Zapping improves efficiency, slightly, if you accidentally introduce a bug,</span><span>
</span><span id="line-2984"></span><span class="hs-comment">-- in which you zap [jx :-&gt; uds] and then find an occurrence of jx anyway, you</span><span>
</span><span id="line-2985"></span><span class="hs-comment">-- might lose those uds, and that might mean we don't record all occurrencs, and</span><span>
</span><span id="line-2986"></span><span class="hs-comment">-- that means we duplicate a redex....  a very nasty bug (which I encountered!).</span><span>
</span><span id="line-2987"></span><span class="hs-comment">-- Hence this DEBUG code which doesn't remove jx from the envt; it just gives it</span><span>
</span><span id="line-2988"></span><span class="hs-comment">-- emptyDetails, which in turn causes a panic in mkOneOcc. That will catch this</span><span>
</span><span id="line-2989"></span><span class="hs-comment">-- bug before it does any damage.</span><span class="hs-cpp">
#ifdef DEBUG
</span><span class="hs-identifier">zapJoinPointInfo</span><span> </span><span class="hs-identifier">jp_info</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mapVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">emptyVarEnv</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">jp_info</span><span class="hs-cpp">
#else
</span><span id="zapJoinPointInfo"><span class="annot"><span class="annottext">zapJoinPointInfo :: JoinPointInfo -&gt; JoinPointInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#zapJoinPointInfo"><span class="hs-identifier hs-var hs-var">zapJoinPointInfo</span></a></span></span><span> </span><span class="annot"><span class="annottext">JoinPointInfo
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointInfo
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-2996"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#extendOneShotsForJoinPoint"><span class="hs-identifier hs-type">extendOneShotsForJoinPoint</span></a></span><span>
</span><span id="line-2997"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2998"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2999"></span><span class="hs-comment">-- Push enough OneShortInfos on the front of ctxt_one_shots</span><span>
</span><span id="line-3000"></span><span class="hs-comment">-- to account for the value lambdas of the join point</span><span>
</span><span id="line-3001"></span><span id="extendOneShotsForJoinPoint"><span class="annot"><span class="annottext">extendOneShotsForJoinPoint :: RecFlag -&gt; JoinArity -&gt; CoreExpr -&gt; [OneShotInfo] -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.OccurAnal.html#extendOneShotsForJoinPoint"><span class="hs-identifier hs-var hs-var">extendOneShotsForJoinPoint</span></a></span></span><span> </span><span id="local-6989586621682711707"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682711707"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621682711708"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711708"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span id="local-6989586621682711709"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711709"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621682711710"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711710"><span class="hs-identifier hs-var">ctxt_one_shots</span></a></span></span><span>
</span><span id="line-3002"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; [OneShotInfo]
</span><a href="#local-6989586621682711711"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711708"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711709"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3003"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3004"></span><span>    </span><span class="hs-comment">-- For a /non-recursive/ join point we can mark all</span><span>
</span><span id="line-3005"></span><span>    </span><span class="hs-comment">-- its join-lambda as one-shot; and it's a good idea to do so</span><span>
</span><span id="line-3006"></span><span>    </span><span class="hs-comment">-- But not so for recursive ones</span><span>
</span><span id="line-3007"></span><span>    </span><span id="local-6989586621682711712"><span class="annot"><span class="annottext">os :: OneShotInfo
</span><a href="#local-6989586621682711712"><span class="hs-identifier hs-var hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682711707"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3008"></span><span>           </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span>
</span><span id="line-3009"></span><span>           </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span>
</span><span id="line-3010"></span><span>
</span><span id="line-3011"></span><span>    </span><span id="local-6989586621682711711"><span class="annot"><span class="annottext">go :: JoinArity -&gt; CoreExpr -&gt; [OneShotInfo]
</span><a href="#local-6989586621682711711"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711710"><span class="hs-identifier hs-var">ctxt_one_shots</span></a></span><span>
</span><span id="line-3012"></span><span>    </span><span class="annot"><a href="#local-6989586621682711711"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682711714"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711714"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682711715"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711715"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682711716"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711716"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3013"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711715"><span class="hs-identifier hs-var">b</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682711712"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; [OneShotInfo] -&gt; [OneShotInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; [OneShotInfo]
</span><a href="#local-6989586621682711711"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711714"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; JoinArity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711716"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3014"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>      </span><span class="annot"><span class="annottext">JoinArity -&gt; CoreExpr -&gt; [OneShotInfo]
</span><a href="#local-6989586621682711711"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711714"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; JoinArity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711716"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3015"></span><span>    </span><span class="annot"><a href="#local-6989586621682711711"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Not enough lambdas.  This can legitimately happen.</span><span>
</span><span id="line-3016"></span><span>                        </span><span class="hs-comment">-- e.g.    let j = case ... in j True</span><span>
</span><span id="line-3017"></span><span>                        </span><span class="hs-comment">-- This will become an arity-1 join point after the</span><span>
</span><span id="line-3018"></span><span>                        </span><span class="hs-comment">-- simplifier has eta-expanded it; but it may not have</span><span>
</span><span id="line-3019"></span><span>                        </span><span class="hs-comment">-- enough lambdas /yet/. (Lint checks that JoinIds do</span><span>
</span><span id="line-3020"></span><span>                        </span><span class="hs-comment">-- have enough lambdas.)</span><span>
</span><span id="line-3021"></span><span>
</span><span id="line-3022"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#setOneShots"><span class="hs-identifier hs-type">setOneShots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneShots"><span class="hs-identifier hs-type">OneShots</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-3023"></span><span id="setOneShots"><span class="annot"><span class="annottext">setOneShots :: [OneShotInfo] -&gt; OccEnv -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#setOneShots"><span class="hs-identifier hs-var hs-var">setOneShots</span></a></span></span><span> </span><span id="local-6989586621682711717"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711717"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711718"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711718"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-3024"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682711717"><span class="hs-identifier hs-var">os</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711718"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">-- Fast path for common case</span><span>
</span><span id="line-3025"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711718"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_one_shots"><span class="hs-identifier hs-var">occ_one_shots</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711717"><span class="hs-identifier hs-type">os</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3026"></span><span>
</span><span id="line-3027"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#isRhsEnv"><span class="hs-identifier hs-type">isRhsEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3028"></span><span id="isRhsEnv"><span class="annot"><span class="annottext">isRhsEnv :: OccEnv -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isRhsEnv"><span class="hs-identifier hs-var hs-var">isRhsEnv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_encl :: OccEnv -&gt; OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_encl"><span class="hs-identifier hs-var">occ_encl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711719"><span class="annot"><span class="annottext">OccEncl
</span><a href="#local-6989586621682711719"><span class="hs-identifier hs-var">cxt</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OccEncl
</span><a href="#local-6989586621682711719"><span class="hs-identifier hs-var">cxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3029"></span><span>                                          </span><span class="annot"><span class="annottext">OccEncl
</span><a href="GHC.Core.Opt.OccurAnal.html#OccRhs"><span class="hs-identifier hs-var">OccRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3030"></span><span>                                          </span><span class="annot"><span class="annottext">OccEncl
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3031"></span><span>
</span><span id="line-3032"></span><span id="local-6989586621682710540"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addInScopeList"><span class="hs-identifier hs-type">addInScopeList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3033"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682710540"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682710540"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-3034"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addInScopeList"><span class="hs-pragma hs-type">addInScopeList</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3035"></span><span id="addInScopeList"><span class="annot"><span class="annottext">addInScopeList :: forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeList"><span class="hs-identifier hs-var hs-var">addInScopeList</span></a></span></span><span> </span><span id="local-6989586621682711721"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711721"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711722"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711722"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682711723"><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails a
</span><a href="#local-6989586621682711723"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-3036"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711722"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails a
</span><a href="#local-6989586621682711723"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711721"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">-- E.g. nullary constructors in a `case`</span><span>
</span><span id="line-3037"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScope"><span class="hs-identifier hs-var">addInScope</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711721"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711722"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails a
</span><a href="#local-6989586621682711723"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-3038"></span><span>
</span><span id="line-3039"></span><span id="local-6989586621682710545"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addInScopeOne"><span class="hs-identifier hs-type">addInScopeOne</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-3040"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682710545"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682710545"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-3041"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addInScopeOne"><span class="hs-pragma hs-type">addInScopeOne</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3042"></span><span id="addInScopeOne"><span class="annot"><span class="annottext">addInScopeOne :: forall a.
OccEnv
-&gt; Id -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScopeOne"><span class="hs-identifier hs-var hs-var">addInScopeOne</span></a></span></span><span> </span><span id="local-6989586621682711724"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711724"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711725"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711725"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScope"><span class="hs-identifier hs-var">addInScope</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711724"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711725"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3043"></span><span>
</span><span id="line-3044"></span><span id="local-6989586621682711726"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addInScope"><span class="hs-identifier hs-type">addInScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3045"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711726"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711726"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-3046"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addInScope"><span class="hs-pragma hs-type">addInScope</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3047"></span><span class="hs-comment">-- This function is called a lot, so we want to inline the fast path</span><span>
</span><span id="line-3048"></span><span class="hs-comment">-- so we don't have to allocate thing_inside and call it</span><span>
</span><span id="line-3049"></span><span class="hs-comment">-- The bndrs must include TyVars as well as Ids, because of</span><span>
</span><span id="line-3050"></span><span class="hs-comment">--     (BS3) in Note [Binder swap]</span><span>
</span><span id="line-3051"></span><span class="hs-comment">-- We do not assume that the bndrs are in scope order; in fact the</span><span>
</span><span id="line-3052"></span><span class="hs-comment">-- call in occ_anal_lam_tail gives them to addInScope in /reverse/ order</span><span>
</span><span id="line-3053"></span><span>
</span><span id="line-3054"></span><span class="hs-comment">-- Fast path when the is no environment-munging to do</span><span>
</span><span id="line-3055"></span><span class="hs-comment">-- This is rather common: notably at top level, but nested too</span><span>
</span><span id="line-3056"></span><span id="addInScope"><span class="annot"><span class="annottext">addInScope :: forall a.
OccEnv
-&gt; [Id] -&gt; (OccEnv -&gt; WithUsageDetails a) -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#addInScope"><span class="hs-identifier hs-var hs-var">addInScope</span></a></span></span><span> </span><span id="local-6989586621682711727"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711727"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711728"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711728"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682711729"><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails a
</span><a href="#local-6989586621682711729"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-3057"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IdEnv (Id, MCoercion) -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; IdEnv (Id, MCoercion)
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var">occ_bs_env</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711727"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3058"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinPointInfo -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; JoinPointInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711727"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3059"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711730"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711730"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span id="local-6989586621682711731"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682711731"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails a
</span><a href="#local-6989586621682711729"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711727"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3060"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; a -&gt; WithUsageDetails a
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#delBndrsFromUDs"><span class="hs-identifier hs-var">delBndrsFromUDs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711728"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711730"><span class="hs-identifier hs-var">uds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682711731"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-3061"></span><span>
</span><span id="line-3062"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addInScope"><span class="hs-identifier hs-var">addInScope</span></a></span><span> </span><span id="local-6989586621682711733"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711733"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711734"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711734"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682711735"><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails a
</span><a href="#local-6989586621682711735"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-3063"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; a -&gt; WithUsageDetails a
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711736"><span class="hs-identifier hs-var">uds'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682711737"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-3064"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3065"></span><span>    </span><span id="local-6989586621682711738"><span class="annot"><span class="annottext">bndr_set :: VarSet
</span><a href="#local-6989586621682711738"><span class="hs-identifier hs-var hs-var">bndr_set</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711734"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3066"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682711739"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711739"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711740"><span class="annot"><span class="annottext">JoinPointInfo
</span><a href="#local-6989586621682711740"><span class="hs-identifier hs-var">bad_joins</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; VarSet -&gt; (OccEnv, JoinPointInfo)
</span><a href="GHC.Core.Opt.OccurAnal.html#preprocess_env"><span class="hs-identifier hs-var">preprocess_env</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711733"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711738"><span class="hs-identifier hs-var">bndr_set</span></a></span><span>
</span><span id="line-3067"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-type">WUD</span></a></span><span> </span><span id="local-6989586621682711742"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711742"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span id="local-6989586621682711737"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682711737"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; WithUsageDetails a
</span><a href="#local-6989586621682711735"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711739"><span class="hs-identifier hs-var">env'</span></a></span><span>
</span><span id="line-3068"></span><span>    </span><span id="local-6989586621682711736"><span class="annot"><span class="annottext">uds' :: UsageDetails
</span><a href="#local-6989586621682711736"><span class="hs-identifier hs-var hs-var">uds'</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; JoinPointInfo -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#postprocess_uds"><span class="hs-identifier hs-var">postprocess_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711734"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointInfo
</span><a href="#local-6989586621682711740"><span class="hs-identifier hs-var">bad_joins</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711742"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-3069"></span><span>
</span><span id="line-3070"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#preprocess_env"><span class="hs-identifier hs-type">preprocess_env</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#JoinPointInfo"><span class="hs-identifier hs-type">JoinPointInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3071"></span><span id="preprocess_env"><span class="annot"><span class="annottext">preprocess_env :: OccEnv -&gt; VarSet -&gt; (OccEnv, JoinPointInfo)
</span><a href="GHC.Core.Opt.OccurAnal.html#preprocess_env"><span class="hs-identifier hs-var hs-var">preprocess_env</span></a></span></span><span> </span><span id="local-6989586621682711744"><span class="annot"><span class="annottext">env :: OccEnv
</span><a href="#local-6989586621682711744"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_join_points :: OccEnv -&gt; JoinPointInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711745"><span class="annot"><span class="annottext">JoinPointInfo
</span><a href="#local-6989586621682711745"><span class="hs-identifier hs-var">join_points</span></a></span></span><span>
</span><span id="line-3072"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_bs_rng :: OccEnv -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_rng"><span class="hs-identifier hs-var">occ_bs_rng</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711746"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711746"><span class="hs-identifier hs-var">bs_rng_vars</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3073"></span><span>               </span><span id="local-6989586621682711747"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711747"><span class="hs-identifier hs-var">bndr_set</span></a></span></span><span>
</span><span id="line-3074"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711748"><span class="hs-identifier hs-var">bad_joins</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; OccEnv
</span><a href="#local-6989586621682711749"><span class="hs-identifier hs-var">drop_shadowed_swaps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; OccEnv
</span><a href="#local-6989586621682711750"><span class="hs-identifier hs-var">drop_shadowed_joins</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711744"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinPointInfo
</span><a href="#local-6989586621682711745"><span class="hs-identifier hs-var">join_points</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3075"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; OccEnv
</span><a href="#local-6989586621682711749"><span class="hs-identifier hs-var">drop_shadowed_swaps</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711744"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span>                       </span><span class="annot"><span class="annottext">JoinPointInfo
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3076"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3077"></span><span>    </span><span class="annot"><a href="#local-6989586621682711749"><span class="hs-identifier hs-type">drop_shadowed_swaps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-3078"></span><span>    </span><span class="hs-comment">-- See Note [The binder-swap substitution] (BS3)</span><span>
</span><span id="line-3079"></span><span>    </span><span id="local-6989586621682711749"><span class="annot"><span class="annottext">drop_shadowed_swaps :: OccEnv -&gt; OccEnv
</span><a href="#local-6989586621682711749"><span class="hs-identifier hs-var hs-var">drop_shadowed_swaps</span></a></span></span><span> </span><span id="local-6989586621682711751"><span class="annot"><span class="annottext">env :: OccEnv
</span><a href="#local-6989586621682711751"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_bs_env :: OccEnv -&gt; IdEnv (Id, MCoercion)
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var">occ_bs_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711752"><span class="annot"><span class="annottext">IdEnv (Id, MCoercion)
</span><a href="#local-6989586621682711752"><span class="hs-identifier hs-var">swap_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3080"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IdEnv (Id, MCoercion) -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv (Id, MCoercion)
</span><a href="#local-6989586621682711752"><span class="hs-identifier hs-var">swap_env</span></a></span><span>
</span><span id="line-3081"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711751"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3082"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711746"><span class="hs-identifier hs-var">bs_rng_vars</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-var">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711747"><span class="hs-identifier hs-var">bndr_set</span></a></span><span>
</span><span id="line-3083"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711751"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var">occ_bs_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-type">emptyVarEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_rng"><span class="hs-identifier hs-var">occ_bs_rng</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-type">emptyVarSet</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3084"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3085"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711751"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var">occ_bs_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711752"><span class="hs-identifier hs-type">swap_env</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html#minusUFM"><span class="hs-operator hs-type">`minusUFM`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711755"><span class="hs-identifier hs-type">bndr_fm</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3086"></span><span>
</span><span id="line-3087"></span><span>    </span><span class="annot"><a href="#local-6989586621682711750"><span class="hs-identifier hs-type">drop_shadowed_joins</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-3088"></span><span>    </span><span class="hs-comment">-- See Note [Occurrence analysis for join points] wrinkle2 (W1) and (W2)</span><span>
</span><span id="line-3089"></span><span>    </span><span id="local-6989586621682711750"><span class="annot"><span class="annottext">drop_shadowed_joins :: OccEnv -&gt; OccEnv
</span><a href="#local-6989586621682711750"><span class="hs-identifier hs-var hs-var">drop_shadowed_joins</span></a></span></span><span> </span><span id="local-6989586621682711756"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711756"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711756"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-type">emptyVarEnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3090"></span><span>
</span><span id="line-3091"></span><span>    </span><span class="hs-comment">-- bad_joins is true if it would be wrong to push occ_join_points inwards</span><span>
</span><span id="line-3092"></span><span>    </span><span class="hs-comment">--  (a) `bndrs` includes any of the occ_join_points</span><span>
</span><span id="line-3093"></span><span>    </span><span class="hs-comment">--  (b) `bndrs` includes any variables free in the RHSs of occ_join_points</span><span>
</span><span id="line-3094"></span><span>    </span><span class="annot"><a href="#local-6989586621682711748"><span class="hs-identifier hs-type">bad_joins</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3095"></span><span>    </span><span id="local-6989586621682711748"><span class="annot"><span class="annottext">bad_joins :: Bool
</span><a href="#local-6989586621682711748"><span class="hs-identifier hs-var hs-var">bad_joins</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; VarEnv LocalOcc -&gt; Bool -&gt; Bool)
-&gt; Bool -&gt; JoinPointInfo -&gt; Bool
forall a r. (Unique -&gt; a -&gt; r -&gt; r) -&gt; r -&gt; VarEnv a -&gt; r
</span><a href="GHC.Types.Var.Env.html#nonDetStrictFoldVarEnv_Directly"><span class="hs-identifier hs-var">nonDetStrictFoldVarEnv_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; VarEnv LocalOcc -&gt; Bool -&gt; Bool
</span><a href="#local-6989586621682711758"><span class="hs-identifier hs-var">is_bad</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">JoinPointInfo
</span><a href="#local-6989586621682711745"><span class="hs-identifier hs-var">join_points</span></a></span><span>
</span><span id="line-3096"></span><span>
</span><span id="line-3097"></span><span>    </span><span class="annot"><a href="#local-6989586621682711755"><span class="hs-identifier hs-type">bndr_fm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>
</span><span id="line-3098"></span><span>    </span><span id="local-6989586621682711755"><span class="annot"><span class="annottext">bndr_fm :: VarEnv Id
</span><a href="#local-6989586621682711755"><span class="hs-identifier hs-var hs-var">bndr_fm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarEnv Id
forall a. UniqSet a -&gt; UniqFM a a
</span><a href="GHC.Types.Unique.Set.html#getUniqSet"><span class="hs-identifier hs-var">getUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711747"><span class="hs-identifier hs-var">bndr_set</span></a></span><span>
</span><span id="line-3099"></span><span>
</span><span id="line-3100"></span><span>    </span><span class="annot"><a href="#local-6989586621682711758"><span class="hs-identifier hs-type">is_bad</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3101"></span><span>    </span><span id="local-6989586621682711758"><span class="annot"><span class="annottext">is_bad :: Unique -&gt; VarEnv LocalOcc -&gt; Bool -&gt; Bool
</span><a href="#local-6989586621682711758"><span class="hs-identifier hs-var hs-var">is_bad</span></a></span></span><span> </span><span id="local-6989586621682711759"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711759"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span id="local-6989586621682711760"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711760"><span class="hs-identifier hs-var">join_uds</span></a></span></span><span> </span><span id="local-6989586621682711761"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711761"><span class="hs-identifier hs-var">rest</span></a></span></span><span>
</span><span id="line-3102"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711759"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; VarSet -&gt; Bool
forall a. Unique -&gt; UniqSet a -&gt; Bool
</span><a href="GHC.Types.Unique.Set.html#elemUniqSet_Directly"><span class="hs-operator hs-var">`elemUniqSet_Directly`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711747"><span class="hs-identifier hs-var">bndr_set</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-3103"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarEnv Id
</span><a href="#local-6989586621682711755"><span class="hs-identifier hs-var">bndr_fm</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Id -&gt; VarEnv LocalOcc -&gt; Bool
forall {k} (key :: k) elt1 elt2.
UniqFM key elt1 -&gt; UniqFM key elt2 -&gt; Bool
</span><a href="GHC.Types.Unique.FM.html#disjointUFM"><span class="hs-operator hs-var">`disjointUFM`</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711760"><span class="hs-identifier hs-var">join_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-3104"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711761"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-3105"></span><span>
</span><span id="line-3106"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#postprocess_uds"><span class="hs-identifier hs-type">postprocess_uds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#JoinPointInfo"><span class="hs-identifier hs-type">JoinPointInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3107"></span><span id="postprocess_uds"><span class="annot"><span class="annottext">postprocess_uds :: [Id] -&gt; JoinPointInfo -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#postprocess_uds"><span class="hs-identifier hs-var hs-var">postprocess_uds</span></a></span></span><span> </span><span id="local-6989586621682711764"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711764"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682711765"><span class="annot"><span class="annottext">JoinPointInfo
</span><a href="#local-6989586621682711765"><span class="hs-identifier hs-var">bad_joins</span></a></span></span><span> </span><span id="local-6989586621682711766"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711766"><span class="hs-identifier hs-var">uds</span></a></span></span><span>
</span><span id="line-3108"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="#local-6989586621682711767"><span class="hs-identifier hs-var">add_bad_joins</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#delBndrsFromUDs"><span class="hs-identifier hs-var">delBndrsFromUDs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711764"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711766"><span class="hs-identifier hs-var">uds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3109"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3110"></span><span>    </span><span class="annot"><a href="#local-6989586621682711767"><span class="hs-identifier hs-type">add_bad_joins</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3111"></span><span>    </span><span class="hs-comment">-- Add usage info for occ_join_points that we cannot push inwards</span><span>
</span><span id="line-3112"></span><span>    </span><span class="hs-comment">-- because of shadowing</span><span>
</span><span id="line-3113"></span><span>    </span><span class="hs-comment">-- See Note [Occurrence analysis for join points] wrinkle (W2)</span><span>
</span><span id="line-3114"></span><span>    </span><span id="local-6989586621682711767"><span class="annot"><span class="annottext">add_bad_joins :: UsageDetails -&gt; UsageDetails
</span><a href="#local-6989586621682711767"><span class="hs-identifier hs-var hs-var">add_bad_joins</span></a></span></span><span> </span><span id="local-6989586621682711768"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711768"><span class="hs-identifier hs-var">uds</span></a></span></span><span>
</span><span id="line-3115"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinPointInfo -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointInfo
</span><a href="#local-6989586621682711765"><span class="hs-identifier hs-var">bad_joins</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711768"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-3116"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarEnv LocalOcc -&gt; VarEnv LocalOcc)
-&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#modifyUDEnv"><span class="hs-identifier hs-var">modifyUDEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; VarEnv LocalOcc
</span><a href="#local-6989586621682711770"><span class="hs-identifier hs-var">extend_with_bad_joins</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711768"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-3117"></span><span>
</span><span id="line-3118"></span><span>    </span><span class="annot"><a href="#local-6989586621682711770"><span class="hs-identifier hs-type">extend_with_bad_joins</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span>
</span><span id="line-3119"></span><span>    </span><span id="local-6989586621682711770"><span class="annot"><span class="annottext">extend_with_bad_joins :: VarEnv LocalOcc -&gt; VarEnv LocalOcc
</span><a href="#local-6989586621682711770"><span class="hs-identifier hs-var hs-var">extend_with_bad_joins</span></a></span></span><span> </span><span id="local-6989586621682711771"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711771"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-3120"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc)
-&gt; VarEnv LocalOcc -&gt; JoinPointInfo -&gt; VarEnv LocalOcc
forall {k} elt a (key :: k).
(Unique -&gt; elt -&gt; a -&gt; a) -&gt; a -&gt; UniqFM key elt -&gt; a
</span><a href="GHC.Types.Unique.FM.html#nonDetStrictFoldUFM_Directly"><span class="hs-identifier hs-var">nonDetStrictFoldUFM_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
</span><a href="#local-6989586621682711773"><span class="hs-identifier hs-var">add_bad_join</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711771"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointInfo
</span><a href="#local-6989586621682711765"><span class="hs-identifier hs-var">bad_joins</span></a></span><span>
</span><span id="line-3121"></span><span>
</span><span id="line-3122"></span><span>    </span><span class="annot"><a href="#local-6989586621682711773"><span class="hs-identifier hs-type">add_bad_join</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span>
</span><span id="line-3123"></span><span>    </span><span class="hs-comment">-- Behave like `andUDs` when adding in the bad_joins</span><span>
</span><span id="line-3124"></span><span>    </span><span id="local-6989586621682711773"><span class="annot"><span class="annottext">add_bad_join :: Unique -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
</span><a href="#local-6989586621682711773"><span class="hs-identifier hs-var hs-var">add_bad_join</span></a></span></span><span> </span><span id="local-6989586621682711774"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711774"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span id="local-6989586621682711775"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711775"><span class="hs-identifier hs-var">join_env</span></a></span></span><span> </span><span id="local-6989586621682711776"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711776"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-3125"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711774"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; VarEnv LocalOcc -&gt; Bool
forall a. Unique -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnvByKey"><span class="hs-operator hs-var">`elemVarEnvByKey`</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711776"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LocalOcc -&gt; LocalOcc -&gt; LocalOcc)
-&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
forall a. (a -&gt; a -&gt; a) -&gt; VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv_C"><span class="hs-identifier hs-var">plusVarEnv_C</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; LocalOcc -&gt; LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#andLocalOcc"><span class="hs-identifier hs-var">andLocalOcc</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711776"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711775"><span class="hs-identifier hs-var">join_env</span></a></span><span>
</span><span id="line-3126"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711776"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3127"></span><span>
</span><span id="line-3128"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addJoinPoint"><span class="hs-identifier hs-type">addJoinPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-3129"></span><span id="addJoinPoint"><span class="annot"><span class="annottext">addJoinPoint :: OccEnv -&gt; Id -&gt; UsageDetails -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#addJoinPoint"><span class="hs-identifier hs-var hs-var">addJoinPoint</span></a></span></span><span> </span><span id="local-6989586621682711779"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711779"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711780"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711780"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682711781"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711781"><span class="hs-identifier hs-var">rhs_uds</span></a></span></span><span>
</span><span id="line-3130"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711782"><span class="hs-identifier hs-var">zeroed_form</span></a></span><span>
</span><span id="line-3131"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711779"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3132"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3133"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711779"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-type">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711779"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682711780"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711782"><span class="hs-identifier hs-type">zeroed_form</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3134"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3135"></span><span>    </span><span id="local-6989586621682711782"><span class="annot"><span class="annottext">zeroed_form :: VarEnv LocalOcc
</span><a href="#local-6989586621682711782"><span class="hs-identifier hs-var hs-var">zeroed_form</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#mkZeroedForm"><span class="hs-identifier hs-var">mkZeroedForm</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711781"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span>
</span><span id="line-3136"></span><span>
</span><span id="line-3137"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#mkZeroedForm"><span class="hs-identifier hs-type">mkZeroedForm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span>
</span><span id="line-3138"></span><span class="hs-comment">-- See Note [Occurrence analysis for join points] for &quot;zeroed form&quot;</span><span>
</span><span id="line-3139"></span><span id="mkZeroedForm"><span class="annot"><span class="annottext">mkZeroedForm :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#mkZeroedForm"><span class="hs-identifier hs-var hs-var">mkZeroedForm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711786"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711786"><span class="hs-identifier hs-var">rhs_occs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3140"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LocalOcc -&gt; Maybe LocalOcc) -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
forall {k} elt1 elt2 (key :: k).
(elt1 -&gt; Maybe elt2) -&gt; UniqFM key elt1 -&gt; UniqFM key elt2
</span><a href="GHC.Types.Unique.FM.html#mapMaybeUFM"><span class="hs-identifier hs-var">mapMaybeUFM</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; Maybe LocalOcc
</span><a href="#local-6989586621682711788"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711786"><span class="hs-identifier hs-var">rhs_occs</span></a></span><span>
</span><span id="line-3141"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3142"></span><span>    </span><span class="annot"><a href="#local-6989586621682711788"><span class="hs-identifier hs-type">do_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span>
</span><span id="line-3143"></span><span>    </span><span id="local-6989586621682711788"><span class="annot"><span class="annottext">do_one :: LocalOcc -&gt; Maybe LocalOcc
</span><a href="#local-6989586621682711788"><span class="hs-identifier hs-var hs-var">do_one</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ManyOccL"><span class="hs-identifier hs-type">ManyOccL</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe LocalOcc
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3144"></span><span>    </span><span class="annot"><a href="#local-6989586621682711788"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span id="local-6989586621682711790"><span class="annot"><span class="annottext">occ :: LocalOcc
</span><a href="#local-6989586621682711790"><span class="hs-identifier hs-var">occ</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneOccL"><span class="hs-identifier hs-type">OneOccL</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; Maybe LocalOcc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682711790"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#lo_n_br"><span class="hs-identifier hs-var">lo_n_br</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3145"></span><span>
</span><span id="line-3146"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-3147"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#transClosureFV"><span class="hs-identifier hs-type">transClosureFV</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-3148"></span><span class="hs-comment">-- If (f,g), (g,h) are in the input, then (f,h) is in the output</span><span>
</span><span id="line-3149"></span><span class="hs-comment">--                                   as well as (f,g), (g,h)</span><span>
</span><span id="line-3150"></span><span id="transClosureFV"><span class="annot"><span class="annottext">transClosureFV :: VarEnv VarSet -&gt; VarEnv VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#transClosureFV"><span class="hs-identifier hs-var hs-var">transClosureFV</span></a></span></span><span> </span><span id="local-6989586621682711793"><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711793"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-3151"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711794"><span class="hs-identifier hs-var">no_change</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711793"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3152"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet -&gt; VarEnv VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#transClosureFV"><span class="hs-identifier hs-var">transClosureFV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Unique, VarSet)] -&gt; VarEnv VarSet
forall {k} elt (key :: k). [(Unique, elt)] -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#listToUFM_Directly"><span class="hs-identifier hs-var">listToUFM_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">[(Unique, VarSet)]
</span><a href="#local-6989586621682711796"><span class="hs-identifier hs-var">new_fv_list</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3153"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3154"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682711794"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711794"><span class="hs-identifier hs-var">no_change</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711796"><span class="annot"><span class="annottext">[(Unique, VarSet)]
</span><a href="#local-6989586621682711796"><span class="hs-identifier hs-var">new_fv_list</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; (Unique, VarSet) -&gt; (Bool, (Unique, VarSet)))
-&gt; Bool -&gt; [(Unique, VarSet)] -&gt; (Bool, [(Unique, VarSet)])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (Unique, VarSet) -&gt; (Bool, (Unique, VarSet))
</span><a href="#local-6989586621682711797"><span class="hs-identifier hs-var">bump</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarEnv VarSet -&gt; [(Unique, VarSet)]
forall {k} (key :: k) elt. UniqFM key elt -&gt; [(Unique, elt)]
</span><a href="GHC.Types.Unique.FM.html#nonDetUFMToList"><span class="hs-identifier hs-var">nonDetUFMToList</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711793"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3155"></span><span>      </span><span class="hs-comment">-- It's OK to use nonDetUFMToList here because we'll forget the</span><span>
</span><span id="line-3156"></span><span>      </span><span class="hs-comment">-- ordering by creating a new set with listToUFM</span><span>
</span><span id="line-3157"></span><span>    </span><span id="local-6989586621682711797"><span class="annot"><span class="annottext">bump :: Bool -&gt; (Unique, VarSet) -&gt; (Bool, (Unique, VarSet))
</span><a href="#local-6989586621682711797"><span class="hs-identifier hs-var hs-var">bump</span></a></span></span><span> </span><span id="local-6989586621682711799"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711799"><span class="hs-identifier hs-var">no_change</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711800"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711800"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682711801"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711801"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3158"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711802"><span class="hs-identifier hs-var">no_change_here</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711799"><span class="hs-identifier hs-var">no_change</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711800"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711801"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3159"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711800"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711803"><span class="hs-identifier hs-var">new_fvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3160"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3161"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682711803"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711803"><span class="hs-identifier hs-var">new_fvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711802"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682711802"><span class="hs-identifier hs-var">no_change_here</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet -&gt; VarSet -&gt; (VarSet, Bool)
</span><a href="GHC.Core.Opt.OccurAnal.html#extendFvs"><span class="hs-identifier hs-var">extendFvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711793"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711801"><span class="hs-identifier hs-var">fvs</span></a></span><span>
</span><span id="line-3162"></span><span>
</span><span id="line-3163"></span><span class="hs-comment">-------------</span><span>
</span><span id="line-3164"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#extendFvs_"><span class="hs-identifier hs-type">extendFvs_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-3165"></span><span id="extendFvs_"><span class="annot"><span class="annottext">extendFvs_ :: VarEnv VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#extendFvs_"><span class="hs-identifier hs-var hs-var">extendFvs_</span></a></span></span><span> </span><span id="local-6989586621682711805"><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711805"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711806"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711806"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarSet, Bool) -&gt; VarSet
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarEnv VarSet -&gt; VarSet -&gt; (VarSet, Bool)
</span><a href="GHC.Core.Opt.OccurAnal.html#extendFvs"><span class="hs-identifier hs-var">extendFvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711805"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711806"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Discard the Bool flag</span><span>
</span><span id="line-3166"></span><span>
</span><span id="line-3167"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#extendFvs"><span class="hs-identifier hs-type">extendFvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-3168"></span><span class="hs-comment">-- (extendFVs env s) returns</span><span>
</span><span id="line-3169"></span><span class="hs-comment">--     (s `union` env(s), env(s) `subset` s)</span><span>
</span><span id="line-3170"></span><span id="extendFvs"><span class="annot"><span class="annottext">extendFvs :: VarEnv VarSet -&gt; VarSet -&gt; (VarSet, Bool)
</span><a href="GHC.Core.Opt.OccurAnal.html#extendFvs"><span class="hs-identifier hs-var hs-var">extendFvs</span></a></span></span><span> </span><span id="local-6989586621682711807"><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711807"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711808"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711808"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-3171"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet -&gt; Bool
forall {k} (key :: k) elt. UniqFM key elt -&gt; Bool
</span><a href="GHC.Types.Unique.FM.html#isNullUFM"><span class="hs-identifier hs-var">isNullUFM</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711807"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3172"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711808"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-3173"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3174"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711808"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711810"><span class="hs-identifier hs-var">extras</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711810"><span class="hs-identifier hs-var">extras</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#subVarSet"><span class="hs-operator hs-var">`subVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711808"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3175"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3176"></span><span>    </span><span class="annot"><a href="#local-6989586621682711810"><span class="hs-identifier hs-type">extras</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>    </span><span class="hs-comment">-- env(s)</span><span>
</span><span id="line-3177"></span><span>    </span><span id="local-6989586621682711810"><span class="annot"><span class="annottext">extras :: VarSet
</span><a href="#local-6989586621682711810"><span class="hs-identifier hs-var hs-var">extras</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarSet -&gt; VarSet) -&gt; VarSet -&gt; VarEnv VarSet -&gt; VarSet
forall {k} elt a (key :: k).
(elt -&gt; a -&gt; a) -&gt; a -&gt; UniqFM key elt -&gt; a
</span><a href="GHC.Types.Unique.FM.html#nonDetStrictFoldUFM"><span class="hs-identifier hs-var">nonDetStrictFoldUFM</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEnv VarSet -&gt; VarSet) -&gt; VarEnv VarSet -&gt; VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3178"></span><span>      </span><span class="hs-comment">-- It's OK to use nonDetStrictFoldUFM here because unionVarSet commutes</span><span>
</span><span id="line-3179"></span><span>             </span><span class="annot"><span class="annottext">(VarSet -&gt; Id -&gt; VarSet)
-&gt; VarEnv VarSet -&gt; VarEnv Id -&gt; VarEnv VarSet
forall {k} elt1 elt2 elt3 (key :: k).
(elt1 -&gt; elt2 -&gt; elt3)
-&gt; UniqFM key elt1 -&gt; UniqFM key elt2 -&gt; UniqFM key elt3
</span><a href="GHC.Types.Unique.FM.html#intersectUFM_C"><span class="hs-identifier hs-var">intersectUFM_C</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682711814"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711814"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711814"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarEnv VarSet
</span><a href="#local-6989586621682711807"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; VarEnv Id
forall a. UniqSet a -&gt; UniqFM a a
</span><a href="GHC.Types.Unique.Set.html#getUniqSet"><span class="hs-identifier hs-var">getUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711808"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3180"></span><span>
</span><span id="line-3181"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                    Binder swap
*                                                                      *
************************************************************************

Note [Binder swap]
~~~~~~~~~~~~~~~~~~
The &quot;binder swap&quot; transformation swaps occurrence of the
scrutinee of a case for occurrences of the case-binder:

 (1)  case x of b { pi -&gt; ri }
         ==&gt;
      case x of b { pi -&gt; ri[b/x] }

 (2)  case (x |&gt; co) of b { pi -&gt; ri }
        ==&gt;
      case (x |&gt; co) of b { pi -&gt; ri[b |&gt; sym co/x] }

The substitution ri[b/x] etc is done by the occurrence analyser.
See Note [The binder-swap substitution].

There are two reasons for making this swap:

(A) It reduces the number of occurrences of the scrutinee, x.
    That in turn might reduce its occurrences to one, so we
    can inline it and save an allocation.  E.g.
      let x = factorial y in case x of b { I# v -&gt; ...x... }
    If we replace 'x' by 'b' in the alternative we get
      let x = factorial y in case x of b { I# v -&gt; ...b... }
    and now we can inline 'x', thus
      case (factorial y) of b { I# v -&gt; ...b... }

(B) The case-binder b has unfolding information; in the
    example above we know that b = I# v. That in turn allows
    nested cases to simplify.  Consider
       case x of b { I# v -&gt;
       ...(case x of b2 { I# v2 -&gt; rhs })...
    If we replace 'x' by 'b' in the alternative we get
       case x of b { I# v -&gt;
       ...(case b of b2 { I# v2 -&gt; rhs })...
    and now it is trivial to simplify the inner case:
       case x of b { I# v -&gt;
       ...(let b2 = b in rhs)...

    The same can happen even if the scrutinee is a variable
    with a cast: see Note [Case of cast]

The reason for doing these transformations /here in the occurrence
analyser/ is because it allows us to adjust the OccInfo for 'x' and
'b' as we go.

  * Suppose the only occurrences of 'x' are the scrutinee and in the
    ri; then this transformation makes it occur just once, and hence
    get inlined right away.

  * If instead the Simplifier replaces occurrences of x with
    occurrences of b, that will mess up b's occurrence info. That in
    turn might have consequences.

There is a danger though.  Consider
      let v = x +# y
      in case (f v) of w -&gt; ...v...v...
And suppose that (f v) expands to just v.  Then we'd like to
use 'w' instead of 'v' in the alternative.  But it may be too
late; we may have substituted the (cheap) x+#y for v in the
same simplifier pass that reduced (f v) to v.

I think this is just too bad.  CSE will recover some of it.

Note [The binder-swap substitution]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The binder-swap is implemented by the occ_bs_env field of OccEnv.
There are two main pieces:

* Given    case x |&gt; co of b { alts }
  we add [x :-&gt; (b, sym co)] to the occ_bs_env environment; this is
  done by addBndrSwap.

* Then, at an occurrence of a variable, we look up in the occ_bs_env
  to perform the swap. This is done by lookupBndrSwap.

Some tricky corners:

(BS1) We do the substitution before gathering occurrence info. So in
      the above example, an occurrence of x turns into an occurrence
      of b, and that's what we gather in the UsageDetails.  It's as
      if the binder-swap occurred before occurrence analysis. See
      the computation of fun_uds in occAnalApp.

(BS2) When doing a lookup in occ_bs_env, we may need to iterate,
      as you can see implemented in lookupBndrSwap.  Why?
      Consider   case x of a { 1# -&gt; e1; DEFAULT -&gt;
                 case x of b { 2# -&gt; e2; DEFAULT -&gt;
                 case x of c { 3# -&gt; e3; DEFAULT -&gt; ..x..a..b.. }}}
      At the first case addBndrSwap will extend occ_bs_env with
          [x :-&gt; a]
      At the second case we occ-anal the scrutinee 'x', which looks up
        'x in occ_bs_env, returning 'a', as it should.
      Then addBndrSwap will add [a :-&gt; b] to occ_bs_env, yielding
         occ_bs_env = [x :-&gt; a, a :-&gt; b]
      At the third case we'll again look up 'x' which returns 'a'.
      But we don't want to stop the lookup there, else we'll end up with
                 case x of a { 1# -&gt; e1; DEFAULT -&gt;
                 case a of b { 2# -&gt; e2; DEFAULT -&gt;
                 case a of c { 3# -&gt; e3; DEFAULT -&gt; ..a..b..c.. }}}
      Instead, we want iterate the lookup in addBndrSwap, to give
                 case x of a { 1# -&gt; e1; DEFAULT -&gt;
                 case a of b { 2# -&gt; e2; DEFAULT -&gt;
                 case b of c { 3# -&gt; e3; DEFAULT -&gt; ..c..c..c.. }}}
      This makes a particular difference for case-merge, which works
      only if the scrutinee is the case-binder of the immediately enclosing
      case (Note [Merge Nested Cases] in GHC.Core.Opt.Simplify.Utils
      See #19581 for the bug report that showed this up.

(BS3) We need care when shadowing.  Suppose [x :-&gt; b] is in occ_bs_env,
      and we encounter:
         (i) \x. blah
             Here we want to delete the x-binding from occ_bs_env

         (ii) \b. blah
              This is harder: we really want to delete all bindings that
              have 'b' free in the range.  That is a bit tiresome to implement,
              so we compromise.  We keep occ_bs_rng, which is the set of
              free vars of rng(occc_bs_env).  If a binder shadows any of these
              variables, we discard all of occ_bs_env.  Safe, if a bit
              brutal.  NB, however: the simplifer de-shadows the code, so the
              next time around this won't happen.

      These checks are implemented in addInScope.
      (i) is needed only for Ids, but (ii) is needed for tyvars too (#22623)
      because if occ_bs_env has [x :-&gt; ...a...] where `a` is a tyvar, we
      must not replace `x` by `...a...` under /\a. ...x..., or similarly
      under a case pattern match that binds `a`.

      An alternative would be for the occurrence analyser to do cloning as
      it goes.  In principle it could do so, but it'd make it a bit more
      complicated and there is no great benefit. The simplifer uses
      cloning to get a no-shadowing situation, the care-when-shadowing
      behaviour above isn't needed for long.

(BS4) The domain of occ_bs_env can include GlobaIds.  Eg
         case M.foo of b { alts }
      We extend occ_bs_env with [M.foo :-&gt; b].  That's fine.

(BS5) We have to apply the occ_bs_env substitution uniformly,
      including to (local) rules and unfoldings.

(BS6) We must be very careful with dictionaries.
      See Note [Care with binder-swap on dictionaries]

Note [Case of cast]
~~~~~~~~~~~~~~~~~~~
Consider        case (x `cast` co) of b { I# -&gt;
                ... (case (x `cast` co) of {...}) ...
We'd like to eliminate the inner case.  That is the motivation for
equation (2) in Note [Binder swap].  When we get to the inner case, we
inline x, cancel the casts, and away we go.

Note [Care with binder-swap on dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This Note explains why we need isDictId in scrutOkForBinderSwap.
Consider this tricky example (#21229, #21470):

  class Sing (b :: Bool) where sing :: Bool
  instance Sing 'True  where sing = True
  instance Sing 'False where sing = False

  f :: forall a. Sing a =&gt; blah

  h = \ @(a :: Bool) ($dSing :: Sing a)
      let the_co =  Main.N:Sing[0] &lt;a&gt; :: Sing a ~R# Bool
      case ($dSing |&gt; the_co) of wild
        True  -&gt; f @'True (True |&gt; sym the_co)
        False -&gt; f @a     dSing

Now do a binder-swap on the case-expression:

  h = \ @(a :: Bool) ($dSing :: Sing a)
      let the_co =  Main.N:Sing[0] &lt;a&gt; :: Sing a ~R# Bool
      case ($dSing |&gt; the_co) of wild
        True  -&gt; f @'True (True |&gt; sym the_co)
        False -&gt; f @a     (wild |&gt; sym the_co)

And now substitute `False` for `wild` (since wild=False in the False branch):

  h = \ @(a :: Bool) ($dSing :: Sing a)
      let the_co =  Main.N:Sing[0] &lt;a&gt; :: Sing a ~R# Bool
      case ($dSing |&gt; the_co) of wild
        True  -&gt; f @'True (True  |&gt; sym the_co)
        False -&gt; f @a     (False |&gt; sym the_co)

And now we have a problem.  The specialiser will specialise (f @a d)a (for all
vtypes a and dictionaries d!!) with the dictionary (False |&gt; sym the_co), using
Note [Specialising polymorphic dictionaries] in GHC.Core.Opt.Specialise.

The real problem is the binder-swap.  It swaps a dictionary variable $dSing
(of kind Constraint) for a term variable wild (of kind Type).  And that is
dangerous: a dictionary is a /singleton/ type whereas a general term variable is
not.  In this particular example, Bool is most certainly not a singleton type!

Conclusion:
  for a /dictionary variable/ do not perform
  the clever cast version of the binder-swap

Hence the subtle isDictId in scrutOkForBinderSwap.

Note [Zap case binders in proxy bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
From the original
     case x of cb(dead) { p -&gt; ...x... }
we will get
     case x of cb(live) { p -&gt; ...cb... }

Core Lint never expects to find an *occurrence* of an Id marked
as Dead, so we must zap the OccInfo on cb before making the
binding x = cb.  See #5028.

NB: the OccInfo on /occurrences/ really doesn't matter much; the simplifier
doesn't use it. So this is only to satisfy the perhaps-over-picky Lint.

-}</span><span>
</span><span id="line-3404"></span><span>
</span><span id="line-3405"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addBndrSwap"><span class="hs-identifier hs-type">addBndrSwap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span>
</span><span id="line-3406"></span><span class="hs-comment">-- See Note [The binder-swap substitution]</span><span>
</span><span id="line-3407"></span><span id="addBndrSwap"><span class="annot"><span class="annottext">addBndrSwap :: CoreExpr -&gt; Id -&gt; OccEnv -&gt; OccEnv
</span><a href="GHC.Core.Opt.OccurAnal.html#addBndrSwap"><span class="hs-identifier hs-var hs-var">addBndrSwap</span></a></span></span><span> </span><span id="local-6989586621682711816"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711816"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682711817"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711817"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span>
</span><span id="line-3408"></span><span>            </span><span id="local-6989586621682711818"><span class="annot"><span class="annottext">env :: OccEnv
</span><a href="#local-6989586621682711818"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_bs_env :: OccEnv -&gt; IdEnv (Id, MCoercion)
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var">occ_bs_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711819"><span class="annot"><span class="annottext">IdEnv (Id, MCoercion)
</span><a href="#local-6989586621682711819"><span class="hs-identifier hs-var">swap_env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_bs_rng :: OccEnv -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_rng"><span class="hs-identifier hs-var">occ_bs_rng</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711820"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711820"><span class="hs-identifier hs-var">rng_vars</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3409"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#DoBinderSwap"><span class="hs-identifier hs-type">DoBinderSwap</span></a></span><span> </span><span id="local-6989586621682711822"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711822"><span class="hs-identifier hs-var">scrut_var</span></a></span></span><span> </span><span id="local-6989586621682711823"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682711823"><span class="hs-identifier hs-var">mco</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; BinderSwapDecision
</span><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier hs-var">scrutOkForBinderSwap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711816"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-3410"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711822"><span class="hs-identifier hs-var">scrut_var</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711817"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-3411"></span><span>      </span><span class="hs-comment">-- Consider: case x of x { ... }</span><span>
</span><span id="line-3412"></span><span>      </span><span class="hs-comment">-- Do not add [x :-&gt; x] to occ_bs_env, else lookupBndrSwap will loop</span><span>
</span><span id="line-3413"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711818"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var">occ_bs_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-type">extendVarEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711819"><span class="hs-identifier hs-type">swap_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711822"><span class="hs-identifier hs-type">scrut_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682711825"><span class="hs-identifier hs-type">case_bndr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682711823"><span class="hs-identifier hs-type">mco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3414"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_rng"><span class="hs-identifier hs-var">occ_bs_rng</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711820"><span class="hs-identifier hs-type">rng_vars</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#extendVarSet"><span class="hs-operator hs-type">`extendVarSet`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711825"><span class="hs-identifier hs-type">case_bndr'</span></a></span><span>
</span><span id="line-3415"></span><span>                       </span><span class="annot"><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-type">`unionVarSet`</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfMCo"><span class="hs-identifier hs-type">tyCoVarsOfMCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711823"><span class="hs-identifier hs-type">mco</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3416"></span><span>
</span><span id="line-3417"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3418"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711818"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3419"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3420"></span><span>    </span><span id="local-6989586621682711825"><span class="annot"><span class="annottext">case_bndr' :: Id
</span><a href="#local-6989586621682711825"><span class="hs-identifier hs-var hs-var">case_bndr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Types.Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711817"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-3421"></span><span>                 </span><span class="hs-comment">-- See Note [Zap case binders in proxy bindings]</span><span>
</span><span id="line-3422"></span><span>
</span><span id="line-3423"></span><span class="annot"><span class="hs-comment">-- | See bBinderSwaOk.</span></span><span>
</span><span id="line-3424"></span><span class="hs-keyword">data</span><span> </span><span id="BinderSwapDecision"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier hs-var">BinderSwapDecision</span></a></span></span><span>
</span><span id="line-3425"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="NoBinderSwap"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NoBinderSwap"><span class="hs-identifier hs-var">NoBinderSwap</span></a></span></span><span>
</span><span id="line-3426"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DoBinderSwap"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#DoBinderSwap"><span class="hs-identifier hs-var">DoBinderSwap</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span>
</span><span id="line-3427"></span><span>
</span><span id="line-3428"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier hs-type">scrutOkForBinderSwap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier hs-type">BinderSwapDecision</span></a></span><span>
</span><span id="line-3429"></span><span class="hs-comment">-- If (scrutOkForBinderSwap e = DoBinderSwap v mco, then</span><span>
</span><span id="line-3430"></span><span class="hs-comment">--    v = e |&gt; mco</span><span>
</span><span id="line-3431"></span><span class="hs-comment">-- See Note [Case of cast]</span><span>
</span><span id="line-3432"></span><span class="hs-comment">-- See Note [Care with binder-swap on dictionaries]</span><span>
</span><span id="line-3433"></span><span class="hs-comment">--</span><span>
</span><span id="line-3434"></span><span class="hs-comment">-- We use this same function in SpecConstr, and Simplify.Iteration,</span><span>
</span><span id="line-3435"></span><span class="hs-comment">-- when something binder-swap-like is happening</span><span>
</span><span id="line-3436"></span><span id="scrutOkForBinderSwap"><span class="annot"><span class="annottext">scrutOkForBinderSwap :: CoreExpr -&gt; BinderSwapDecision
</span><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier hs-var hs-var">scrutOkForBinderSwap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682711830"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711830"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; MCoercion -&gt; BinderSwapDecision
</span><a href="GHC.Core.Opt.OccurAnal.html#DoBinderSwap"><span class="hs-identifier hs-var">DoBinderSwap</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711830"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-3437"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier hs-var">scrutOkForBinderSwap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682711832"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711832"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682711833"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711833"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3438"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isDictId"><span class="hs-identifier hs-var">isDictId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711832"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; MCoercion -&gt; BinderSwapDecision
</span><a href="GHC.Core.Opt.OccurAnal.html#DoBinderSwap"><span class="hs-identifier hs-var">DoBinderSwap</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711832"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionR -&gt; MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionR -&gt; CoercionR
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621682711833"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3439"></span><span>        </span><span class="hs-comment">-- Cast: see Note [Case of cast]</span><span>
</span><span id="line-3440"></span><span>        </span><span class="hs-comment">-- isDictId: see Note [Care with binder-swap on dictionaries]</span><span>
</span><span id="line-3441"></span><span>        </span><span class="hs-comment">-- The isDictId rejects a Constraint/Constraint binder-swap, perhaps</span><span>
</span><span id="line-3442"></span><span>        </span><span class="hs-comment">-- over-conservatively. But I have never seen one, so I'm leaving</span><span>
</span><span id="line-3443"></span><span>        </span><span class="hs-comment">-- the code as simple as possible. Losing the binder-swap in a</span><span>
</span><span id="line-3444"></span><span>        </span><span class="hs-comment">-- rare case probably has very low impact.</span><span>
</span><span id="line-3445"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier hs-var">scrutOkForBinderSwap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682711836"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711836"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; BinderSwapDecision
</span><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier hs-var">scrutOkForBinderSwap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711836"><span class="hs-identifier hs-var">e</span></a></span><span>  </span><span class="hs-comment">-- Drop ticks</span><span>
</span><span id="line-3446"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier hs-var">scrutOkForBinderSwap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BinderSwapDecision
</span><a href="GHC.Core.Opt.OccurAnal.html#NoBinderSwap"><span class="hs-identifier hs-var">NoBinderSwap</span></a></span><span>
</span><span id="line-3447"></span><span>
</span><span id="line-3448"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#lookupBndrSwap"><span class="hs-identifier hs-type">lookupBndrSwap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3449"></span><span class="hs-comment">-- See Note [The binder-swap substitution]</span><span>
</span><span id="line-3450"></span><span class="hs-comment">-- Returns an expression of the same type as Id</span><span>
</span><span id="line-3451"></span><span id="lookupBndrSwap"><span class="annot"><span class="annottext">lookupBndrSwap :: OccEnv -&gt; Id -&gt; (CoreExpr, Id)
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupBndrSwap"><span class="hs-identifier hs-var hs-var">lookupBndrSwap</span></a></span></span><span> </span><span id="local-6989586621682711837"><span class="annot"><span class="annottext">env :: OccEnv
</span><a href="#local-6989586621682711837"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_bs_env :: OccEnv -&gt; IdEnv (Id, MCoercion)
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_bs_env"><span class="hs-identifier hs-var">occ_bs_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711838"><span class="annot"><span class="annottext">IdEnv (Id, MCoercion)
</span><a href="#local-6989586621682711838"><span class="hs-identifier hs-var">bs_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span id="local-6989586621682711839"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711839"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-3452"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IdEnv (Id, MCoercion) -&gt; Id -&gt; Maybe (Id, MCoercion)
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv (Id, MCoercion)
</span><a href="#local-6989586621682711838"><span class="hs-identifier hs-var">bs_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711839"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-3453"></span><span>       </span><span class="annot"><span class="annottext">Maybe (Id, MCoercion)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711839"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711839"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-3454"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711840"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711840"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711841"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682711841"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-3455"></span><span>
</span><span id="line-3456"></span><span>    </span><span class="hs-comment">-- Why do we iterate here?</span><span>
</span><span id="line-3457"></span><span>    </span><span class="hs-comment">-- See (BS2) in Note [The binder-swap substitution]</span><span>
</span><span id="line-3458"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OccEnv -&gt; Id -&gt; (CoreExpr, Id)
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupBndrSwap"><span class="hs-identifier hs-var">lookupBndrSwap</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711837"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711840"><span class="hs-identifier hs-var">bndr1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3459"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621682711842"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711842"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682711843"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711843"><span class="hs-identifier hs-var">fun_id</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; MCoercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-identifier hs-var">mkCastMCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682711842"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682711841"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711843"><span class="hs-identifier hs-var">fun_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3460"></span><span>
</span><span id="line-3461"></span><span class="hs-comment">{- Historical note [Proxy let-bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to do the binder-swap transformation by introducing
a proxy let-binding, thus;

   case x of b { pi -&gt; ri }
      ==&gt;
   case x of b { pi -&gt; let x = b in ri }

But that had two problems:

1. If 'x' is an imported GlobalId, we'd end up with a GlobalId
   on the LHS of a let-binding which isn't allowed.  We worked
   around this for a while by &quot;localising&quot; x, but it turned
   out to be very painful #16296,

2. In CorePrep we use the occurrence analyser to do dead-code
   elimination (see Note [Dead code in CorePrep]).  But that
   occasionally led to an unlifted let-binding
       case x of b { DEFAULT -&gt; let x::Int# = b in ... }
   which disobeys one of CorePrep's output invariants (no unlifted
   let-bindings) -- see #5433.

Doing a substitution (via occ_bs_env) is much better.

Historical Note [no-case-of-case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We *used* to suppress the binder-swap in case expressions when
-fno-case-of-case is on.  Old remarks:
    &quot;This happens in the first simplifier pass,
    and enhances full laziness.  Here's the bad case:
            f = \ y -&gt; ...(case x of I# v -&gt; ...(case x of ...) ... )
    If we eliminate the inner case, we trap it inside the I# v -&gt; arm,
    which might prevent some full laziness happening.  I've seen this
    in action in spectral/cichelli/Prog.hs:
             [(m,n) | m &lt;- [1..max], n &lt;- [1..max]]
    Hence the check for NoCaseOfCase.&quot;
However, now the full-laziness pass itself reverses the binder-swap, so this
check is no longer necessary.

Historical Note [Suppressing the case binder-swap]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This old note describes a problem that is also fixed by doing the
binder-swap in OccAnal:

    There is another situation when it might make sense to suppress the
    case-expression binde-swap. If we have

        case x of w1 { DEFAULT -&gt; case x of w2 { A -&gt; e1; B -&gt; e2 }
                       ...other cases .... }

    We'll perform the binder-swap for the outer case, giving

        case x of w1 { DEFAULT -&gt; case w1 of w2 { A -&gt; e1; B -&gt; e2 }
                       ...other cases .... }

    But there is no point in doing it for the inner case, because w1 can't
    be inlined anyway.  Furthermore, doing the case-swapping involves
    zapping w2's occurrence info (see paragraphs that follow), and that
    forces us to bind w2 when doing case merging.  So we get

        case x of w1 { A -&gt; let w2 = w1 in e1
                       B -&gt; let w2 = w1 in e2
                       ...other cases .... }

    This is plain silly in the common case where w2 is dead.

    Even so, I can't see a good way to implement this idea.  I tried
    not doing the binder-swap if the scrutinee was already evaluated
    but that failed big-time:

            data T = MkT !Int

            case v of w  { MkT x -&gt;
            case x of x1 { I# y1 -&gt;
            case x of x2 { I# y2 -&gt; ...

    Notice that because MkT is strict, x is marked &quot;evaluated&quot;.  But to
    eliminate the last case, we must either make sure that x (as well as
    x1) has unfolding MkT y1.  The straightforward thing to do is to do
    the binder-swap.  So this whole note is a no-op.

It's fixed by doing the binder-swap in OccAnal because we can do the
binder-swap unconditionally and still get occurrence analysis
information right.


************************************************************************
*                                                                      *
\subsection[OccurAnal-types]{OccEnv}
*                                                                      *
************************************************************************

Note [UsageDetails and zapping]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
On many occasions, we must modify all gathered occurrence data at once. For
instance, all occurrences underneath a (non-one-shot) lambda set the
'occ_in_lam' flag to become 'True'. We could use 'mapVarEnv' to do this, but
that takes O(n) time and we will do this often---in particular, there are many
places where tail calls are not allowed, and each of these causes all variables
to get marked with 'NoTailCallInfo'.

Instead of relying on `mapVarEnv`, then, we carry three 'IdEnv's around along
with the 'OccInfoEnv'. Each of these extra environments is a &quot;zapped set&quot;
recording which variables have been zapped in some way. Zapping all occurrence
info then simply means setting the corresponding zapped set to the whole
'OccInfoEnv', a fast O(1) operation.

Note [LocalOcc]
~~~~~~~~~~~~~~~
LocalOcc is used purely internally, in the occurrence analyser.  It differs from
GHC.Types.Basic.OccInfo because it has only OneOcc and ManyOcc; it does not need
IAmDead or IAmALoopBreaker.

Note that `OneOccL` doesn't meant that it occurs /syntactially/ only once; it
means that it is /used/ only once. It might occur syntactically many times.
For example, in (case x of A -&gt; y; B -&gt; y; C -&gt; True),
* `y` is used only once
* but it occurs syntactically twice

-}</span><span>
</span><span id="line-3582"></span><span>
</span><span id="line-3583"></span><span class="hs-keyword">type</span><span> </span><span id="OccInfoEnv"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-var">OccInfoEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span>  </span><span class="hs-comment">-- A finite map from an expression's</span><span>
</span><span id="line-3584"></span><span>                                  </span><span class="hs-comment">-- free variables to their usage</span><span>
</span><span id="line-3585"></span><span>
</span><span id="line-3586"></span><span class="hs-keyword">data</span><span> </span><span id="LocalOcc"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-var">LocalOcc</span></a></span></span><span>  </span><span class="hs-comment">-- See Note [LocalOcc]</span><span>
</span><span id="line-3587"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="OneOccL"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneOccL"><span class="hs-identifier hs-var">OneOccL</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="lo_n_br"><span class="annot"><span class="annottext">LocalOcc -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_n_br"><span class="hs-identifier hs-var hs-var">lo_n_br</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Basic.html#BranchCount"><span class="hs-identifier hs-type">BranchCount</span></a></span><span>  </span><span class="hs-comment">-- Number of syntactic occurrences</span><span>
</span><span id="line-3588"></span><span>               </span><span class="hs-special">,</span><span> </span><span id="lo_tail"><span class="annot"><span class="annottext">LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_tail"><span class="hs-identifier hs-var hs-var">lo_tail</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Basic.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a></span><span>
</span><span id="line-3589"></span><span>                   </span><span class="hs-comment">-- Combining (AlwaysTailCalled 2) and (AlwaysTailCalled 3)</span><span>
</span><span id="line-3590"></span><span>                   </span><span class="hs-comment">-- gives NoTailCallInfo</span><span>
</span><span id="line-3591"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="lo_int_cxt"><span class="annot"><span class="annottext">LocalOcc -&gt; InterestingCxt
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_int_cxt"><span class="hs-identifier hs-var hs-var">lo_int_cxt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Basic.html#InterestingCxt"><span class="hs-identifier hs-type">InterestingCxt</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3592"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ManyOccL"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ManyOccL"><span class="hs-identifier hs-var">ManyOccL</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Basic.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a></span><span>
</span><span id="line-3593"></span><span>
</span><span id="line-3594"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3595"></span><span>  </span><span id="local-6989586621682711861"><span class="annot"><span class="annottext">ppr :: LocalOcc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneOccL"><span class="hs-identifier hs-type">OneOccL</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lo_n_br :: LocalOcc -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_n_br"><span class="hs-identifier hs-var">lo_n_br</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711862"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711862"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_tail :: LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_tail"><span class="hs-identifier hs-var">lo_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711863"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682711863"><span class="hs-identifier hs-var">tci</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3596"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;OneOccL&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711862"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682711863"><span class="hs-identifier hs-var">tci</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3597"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ManyOccL"><span class="hs-identifier hs-type">ManyOccL</span></a></span><span> </span><span id="local-6989586621682711865"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682711865"><span class="hs-identifier hs-var">tci</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ManyOccL&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TailCallInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682711865"><span class="hs-identifier hs-var">tci</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3598"></span><span>
</span><span id="line-3599"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#localTailCallInfo"><span class="hs-identifier hs-type">localTailCallInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a></span><span>
</span><span id="line-3600"></span><span id="localTailCallInfo"><span class="annot"><span class="annottext">localTailCallInfo :: LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#localTailCallInfo"><span class="hs-identifier hs-var hs-var">localTailCallInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneOccL"><span class="hs-identifier hs-type">OneOccL</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lo_tail :: LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_tail"><span class="hs-identifier hs-var">lo_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711867"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682711867"><span class="hs-identifier hs-var">tci</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682711867"><span class="hs-identifier hs-var">tci</span></a></span><span>
</span><span id="line-3601"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#localTailCallInfo"><span class="hs-identifier hs-var">localTailCallInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ManyOccL"><span class="hs-identifier hs-type">ManyOccL</span></a></span><span> </span><span id="local-6989586621682711868"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682711868"><span class="hs-identifier hs-var">tci</span></a></span></span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682711868"><span class="hs-identifier hs-var">tci</span></a></span><span>
</span><span id="line-3602"></span><span>
</span><span id="line-3603"></span><span class="hs-keyword">type</span><span> </span><span id="ZappedSet"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ZappedSet"><span class="hs-identifier hs-var">ZappedSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span> </span><span class="hs-comment">-- Values are ignored</span><span>
</span><span id="line-3604"></span><span>
</span><span id="line-3605"></span><span class="hs-keyword">data</span><span> </span><span id="UsageDetails"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-var">UsageDetails</span></a></span></span><span>
</span><span id="line-3606"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="UD"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-var">UD</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="ud_env"><span class="annot"><span class="annottext">UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var hs-var">ud_env</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span>
</span><span id="line-3607"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="ud_z_many"><span class="annot"><span class="annottext">UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_many"><span class="hs-identifier hs-var hs-var">ud_z_many</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ZappedSet"><span class="hs-identifier hs-type">ZappedSet</span></a></span><span>   </span><span class="hs-comment">-- apply 'markMany' to these</span><span>
</span><span id="line-3608"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="ud_z_in_lam"><span class="annot"><span class="annottext">UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_in_lam"><span class="hs-identifier hs-var hs-var">ud_z_in_lam</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ZappedSet"><span class="hs-identifier hs-type">ZappedSet</span></a></span><span>   </span><span class="hs-comment">-- apply 'markInsideLam' to these</span><span>
</span><span id="line-3609"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="ud_z_tail"><span class="annot"><span class="annottext">UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var hs-var">ud_z_tail</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ZappedSet"><span class="hs-identifier hs-type">ZappedSet</span></a></span><span>   </span><span class="hs-comment">-- zap tail-call info for these</span><span>
</span><span id="line-3610"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-3611"></span><span>  </span><span class="hs-comment">-- INVARIANT: All three zapped sets are subsets of ud_env</span><span>
</span><span id="line-3612"></span><span>
</span><span id="line-3613"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3614"></span><span>  </span><span id="local-6989586621682711893"><span class="annot"><span class="annottext">ppr :: UsageDetails -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span id="local-6989586621682711894"><span class="annot"><span class="annottext">ud :: UsageDetails
</span><a href="#local-6989586621682711894"><span class="hs-identifier hs-var">ud</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711895"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711895"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_tail :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711896"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711896"><span class="hs-identifier hs-var">z_tail</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3615"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UD&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#fsep"><span class="hs-identifier hs-var">fsep</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; [SDoc]) -&gt; [SDoc] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3616"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711899"><span class="hs-identifier hs-var">uq</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:-&gt;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; Unique -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupOccInfoByUnique"><span class="hs-identifier hs-var">lookupOccInfoByUnique</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711894"><span class="hs-identifier hs-var">ud</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711899"><span class="hs-identifier hs-var">uq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3617"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682711899"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711899"><span class="hs-identifier hs-var">uq</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LocalOcc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Unique
 -&gt; LocalOcc -&gt; [(Unique, LocalOcc)] -&gt; [(Unique, LocalOcc)])
-&gt; [(Unique, LocalOcc)] -&gt; VarEnv LocalOcc -&gt; [(Unique, LocalOcc)]
forall a r. (Unique -&gt; a -&gt; r -&gt; r) -&gt; r -&gt; VarEnv a -&gt; r
</span><a href="GHC.Types.Var.Env.html#nonDetStrictFoldVarEnv_Directly"><span class="hs-identifier hs-var">nonDetStrictFoldVarEnv_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; LocalOcc -&gt; [(Unique, LocalOcc)] -&gt; [(Unique, LocalOcc)]
</span><a href="#local-6989586621682711901"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711895"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3618"></span><span>      </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ud_z_tail&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711896"><span class="hs-identifier hs-var">z_tail</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3619"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3620"></span><span>      </span><span class="annot"><a href="#local-6989586621682711901"><span class="hs-identifier hs-type">do_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-3621"></span><span>      </span><span id="local-6989586621682711901"><span class="annot"><span class="annottext">do_one :: Unique -&gt; LocalOcc -&gt; [(Unique, LocalOcc)] -&gt; [(Unique, LocalOcc)]
</span><a href="#local-6989586621682711901"><span class="hs-identifier hs-var hs-var">do_one</span></a></span></span><span> </span><span id="local-6989586621682711904"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711904"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span id="local-6989586621682711905"><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682711905"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span id="local-6989586621682711906"><span class="annot"><span class="annottext">[(Unique, LocalOcc)]
</span><a href="#local-6989586621682711906"><span class="hs-identifier hs-var">occs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682711904"><span class="hs-identifier hs-var">uniq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682711905"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Unique, LocalOcc) -&gt; [(Unique, LocalOcc)] -&gt; [(Unique, LocalOcc)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Unique, LocalOcc)]
</span><a href="#local-6989586621682711906"><span class="hs-identifier hs-var">occs</span></a></span><span>
</span><span id="line-3622"></span><span>
</span><span id="line-3623"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-3624"></span><span class="hs-comment">-- | TailUsageDetails captures the result of applying 'occAnalLamTail'</span><span>
</span><span id="line-3625"></span><span class="hs-comment">--   to a function `\xyz.body`. The TailUsageDetails pairs together</span><span>
</span><span id="line-3626"></span><span class="hs-comment">--   * the number of lambdas (including type lambdas: a JoinArity)</span><span>
</span><span id="line-3627"></span><span class="hs-comment">--   * UsageDetails for the `body` of the lambda, unadjusted by `adjustTailUsage`.</span><span>
</span><span id="line-3628"></span><span class="hs-comment">-- If the binding turns out to be a join point with the indicated join</span><span>
</span><span id="line-3629"></span><span class="hs-comment">-- arity, this unadjusted usage details is just what we need; otherwise we</span><span>
</span><span id="line-3630"></span><span class="hs-comment">-- need to discard tail calls. That's what `adjustTailUsage` does.</span><span>
</span><span id="line-3631"></span><span class="hs-keyword">data</span><span> </span><span id="TailUsageDetails"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TailUsageDetails"><span class="hs-identifier hs-var">TailUsageDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TUD"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-var">TUD</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3632"></span><span>
</span><span id="line-3633"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TailUsageDetails"><span class="hs-identifier hs-type">TailUsageDetails</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3634"></span><span>  </span><span id="local-6989586621682711913"><span class="annot"><span class="annottext">ppr :: TailUsageDetails -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-type">TUD</span></a></span><span> </span><span id="local-6989586621682711914"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711914"><span class="hs-identifier hs-var">ja</span></a></span></span><span> </span><span id="local-6989586621682711915"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711915"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.Utils.Outputable.html#lambda"><span class="hs-identifier hs-var">lambda</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711914"><span class="hs-identifier hs-var">ja</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711915"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-3635"></span><span>
</span><span id="line-3636"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-3637"></span><span class="hs-keyword">data</span><span> </span><span id="WithUsageDetails"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-var">WithUsageDetails</span></a></span></span><span>     </span><span id="local-6989586621682710533"><span class="annot"><a href="#local-6989586621682710533"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="WUD"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span></span><span>  </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>     </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621682710533"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3638"></span><span class="hs-keyword">data</span><span> </span><span id="WithTailUsageDetails"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithTailUsageDetails"><span class="hs-identifier hs-var">WithTailUsageDetails</span></a></span></span><span> </span><span id="local-6989586621682710589"><span class="annot"><a href="#local-6989586621682710589"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="WTUD"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-var">WTUD</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TailUsageDetails"><span class="hs-identifier hs-type">TailUsageDetails</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621682710589"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3639"></span><span>
</span><span id="line-3640"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-3641"></span><span class="hs-comment">-- UsageDetails API</span><span>
</span><span id="line-3642"></span><span>
</span><span id="line-3643"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-identifier hs-type">andUDs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#orUDs"><span class="hs-identifier hs-type">orUDs</span></a></span><span>
</span><span id="line-3644"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3645"></span><span id="andUDs"><span class="annot"><span class="annottext">andUDs :: UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-identifier hs-var hs-var">andUDs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LocalOcc -&gt; LocalOcc -&gt; LocalOcc)
-&gt; UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#combineUsageDetailsWith"><span class="hs-identifier hs-var">combineUsageDetailsWith</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; LocalOcc -&gt; LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#andLocalOcc"><span class="hs-identifier hs-var">andLocalOcc</span></a></span><span>
</span><span id="line-3646"></span><span id="orUDs"><span class="annot"><span class="annottext">orUDs :: UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#orUDs"><span class="hs-identifier hs-var hs-var">orUDs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LocalOcc -&gt; LocalOcc -&gt; LocalOcc)
-&gt; UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#combineUsageDetailsWith"><span class="hs-identifier hs-var">combineUsageDetailsWith</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; LocalOcc -&gt; LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#orLocalOcc"><span class="hs-identifier hs-var">orLocalOcc</span></a></span><span>
</span><span id="line-3647"></span><span>
</span><span id="line-3648"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#mkOneOcc"><span class="hs-identifier hs-type">mkOneOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#InterestingCxt"><span class="hs-identifier hs-type">InterestingCxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3649"></span><span id="mkOneOcc"><span class="annot"><span class="annottext">mkOneOcc :: OccEnv -&gt; Id -&gt; InterestingCxt -&gt; JoinArity -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#mkOneOcc"><span class="hs-identifier hs-var hs-var">mkOneOcc</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682711919"><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711919"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682711920"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711920"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682711921"><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682711921"><span class="hs-identifier hs-var">int_cxt</span></a></span></span><span> </span><span id="local-6989586621682711922"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711922"><span class="hs-identifier hs-var">arity</span></a></span></span><span>
</span><span id="line-3650"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711920"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3651"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a></span><span>
</span><span id="line-3652"></span><span>
</span><span id="line-3653"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682711924"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711924"><span class="hs-identifier hs-var">join_uds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">JoinPointInfo -&gt; Id -&gt; Maybe (VarEnv LocalOcc)
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccEnv -&gt; JoinPointInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#occ_join_points"><span class="hs-identifier hs-var">occ_join_points</span></a></span><span> </span><span class="annot"><span class="annottext">OccEnv
</span><a href="#local-6989586621682711919"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711920"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-3654"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [Occurrence analysis for join points]</span><span>
</span><span id="line-3655"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; UsageDetails -&gt; UsageDetails
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711924"><span class="hs-identifier hs-var">join_uds</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711920"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails) -&gt; UsageDetails -&gt; UsageDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3656"></span><span>       </span><span class="hs-comment">-- We only put non-empty join-points into occ_join_points</span><span>
</span><span id="line-3657"></span><span>    </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#mkSimpleDetails"><span class="hs-identifier hs-var">mkSimpleDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; Id -&gt; LocalOcc -&gt; VarEnv LocalOcc
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711924"><span class="hs-identifier hs-var">join_uds</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711920"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682711927"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3658"></span><span>
</span><span id="line-3659"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3660"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#mkSimpleDetails"><span class="hs-identifier hs-var">mkSimpleDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; LocalOcc -&gt; VarEnv LocalOcc
forall a. Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#unitVarEnv"><span class="hs-identifier hs-var">unitVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711920"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682711927"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3661"></span><span>
</span><span id="line-3662"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3663"></span><span>    </span><span id="local-6989586621682711927"><span class="annot"><span class="annottext">occ :: LocalOcc
</span><a href="#local-6989586621682711927"><span class="hs-identifier hs-var hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneOccL"><span class="hs-identifier hs-type">OneOccL</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lo_n_br :: JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_n_br"><span class="hs-identifier hs-var">lo_n_br</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_int_cxt :: InterestingCxt
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_int_cxt"><span class="hs-identifier hs-var">lo_int_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682711921"><span class="hs-identifier hs-var">int_cxt</span></a></span><span>
</span><span id="line-3664"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_tail :: TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_tail"><span class="hs-identifier hs-var">lo_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; TailCallInfo
</span><a href="GHC.Types.Basic.html#AlwaysTailCalled"><span class="hs-identifier hs-var">AlwaysTailCalled</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682711922"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3665"></span><span>
</span><span id="line-3666"></span><span class="hs-comment">-- Add several occurrences, assumed not to be tail calls</span><span>
</span><span id="line-3667"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#add_many_occ"><span class="hs-identifier hs-type">add_many_occ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span>
</span><span id="line-3668"></span><span id="add_many_occ"><span class="annot"><span class="annottext">add_many_occ :: Id -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#add_many_occ"><span class="hs-identifier hs-var hs-var">add_many_occ</span></a></span></span><span> </span><span id="local-6989586621682711931"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711931"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682711932"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711932"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711931"><span class="hs-identifier hs-var">v</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; Id -&gt; LocalOcc -&gt; VarEnv LocalOcc
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711932"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711931"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TailCallInfo -&gt; LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ManyOccL"><span class="hs-identifier hs-var">ManyOccL</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="GHC.Types.Basic.html#NoTailCallInfo"><span class="hs-identifier hs-var">NoTailCallInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3669"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711932"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3670"></span><span>        </span><span class="hs-comment">-- Give a non-committal binder info (i.e noOccInfo) because</span><span>
</span><span id="line-3671"></span><span>        </span><span class="hs-comment">--   a) Many copies of the specialised thing can appear</span><span>
</span><span id="line-3672"></span><span>        </span><span class="hs-comment">--   b) We don't want to substitute a BIG expression inside a RULE</span><span>
</span><span id="line-3673"></span><span>        </span><span class="hs-comment">--      even if that's the only occurrence of the thing</span><span>
</span><span id="line-3674"></span><span>        </span><span class="hs-comment">--      (Same goes for INLINE.)</span><span>
</span><span id="line-3675"></span><span>
</span><span id="line-3676"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-identifier hs-type">addManyOccs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3677"></span><span id="addManyOccs"><span class="annot"><span class="annottext">addManyOccs :: UsageDetails -&gt; VarSet -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var hs-var">addManyOccs</span></a></span></span><span> </span><span id="local-6989586621682711934"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711934"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span id="local-6989586621682711935"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711935"><span class="hs-identifier hs-var">var_set</span></a></span></span><span>
</span><span id="line-3678"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711935"><span class="hs-identifier hs-var">var_set</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711934"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-3679"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711934"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711936"><span class="hs-identifier hs-type">add_to</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711934"><span class="hs-identifier hs-type">uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3680"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3681"></span><span>    </span><span id="local-6989586621682711936"><span class="annot"><span class="annottext">add_to :: VarEnv LocalOcc -&gt; VarEnv LocalOcc
</span><a href="#local-6989586621682711936"><span class="hs-identifier hs-var hs-var">add_to</span></a></span></span><span> </span><span id="local-6989586621682711937"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711937"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc)
-&gt; VarEnv LocalOcc -&gt; VarSet -&gt; VarEnv LocalOcc
forall elt a. (elt -&gt; a -&gt; a) -&gt; a -&gt; UniqSet elt -&gt; a
</span><a href="GHC.Types.Unique.Set.html#nonDetStrictFoldUniqSet"><span class="hs-identifier hs-var">nonDetStrictFoldUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#add_many_occ"><span class="hs-identifier hs-var">add_many_occ</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711937"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711935"><span class="hs-identifier hs-var">var_set</span></a></span><span>
</span><span id="line-3682"></span><span>    </span><span class="hs-comment">-- It's OK to use nonDetStrictFoldUniqSet here because add_many_occ commutes</span><span>
</span><span id="line-3683"></span><span>
</span><span id="line-3684"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#addLamCoVarOccs"><span class="hs-identifier hs-type">addLamCoVarOccs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3685"></span><span class="hs-comment">-- Add any CoVars free in the type of a lambda-binder</span><span>
</span><span id="line-3686"></span><span class="hs-comment">-- See Note [Gather occurrences of coercion variables]</span><span>
</span><span id="line-3687"></span><span id="addLamCoVarOccs"><span class="annot"><span class="annottext">addLamCoVarOccs :: UsageDetails -&gt; [Id] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addLamCoVarOccs"><span class="hs-identifier hs-var hs-var">addLamCoVarOccs</span></a></span></span><span> </span><span id="local-6989586621682711939"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711939"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span id="local-6989586621682711940"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711940"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>
</span><span id="line-3688"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; UsageDetails -&gt; UsageDetails)
-&gt; UsageDetails -&gt; [Id] -&gt; UsageDetails
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; UsageDetails -&gt; UsageDetails
</span><a href="#local-6989586621682711941"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711939"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711940"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3689"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3690"></span><span>    </span><span id="local-6989586621682711941"><span class="annot"><span class="annottext">add :: Id -&gt; UsageDetails -&gt; UsageDetails
</span><a href="#local-6989586621682711941"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span id="local-6989586621682711942"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711942"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682711943"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711943"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711943"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; VarSet -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#addManyOccs"><span class="hs-operator hs-var">`addManyOccs`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#coVarsOfType"><span class="hs-identifier hs-var">coVarsOfType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711942"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3691"></span><span>
</span><span id="line-3692"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-type">emptyDetails</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3693"></span><span id="emptyDetails"><span class="annot"><span class="annottext">emptyDetails :: UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var hs-var">emptyDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#mkSimpleDetails"><span class="hs-identifier hs-var">mkSimpleDetails</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-3694"></span><span>
</span><span id="line-3695"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#isEmptyDetails"><span class="hs-identifier hs-type">isEmptyDetails</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3696"></span><span id="isEmptyDetails"><span class="annot"><span class="annottext">isEmptyDetails :: UsageDetails -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isEmptyDetails"><span class="hs-identifier hs-var hs-var">isEmptyDetails</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711945"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711945"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711945"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3697"></span><span>
</span><span id="line-3698"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#mkSimpleDetails"><span class="hs-identifier hs-type">mkSimpleDetails</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3699"></span><span id="mkSimpleDetails"><span class="annot"><span class="annottext">mkSimpleDetails :: VarEnv LocalOcc -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#mkSimpleDetails"><span class="hs-identifier hs-var hs-var">mkSimpleDetails</span></a></span></span><span> </span><span id="local-6989586621682711946"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711946"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711946"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3700"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_many :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_many"><span class="hs-identifier hs-var">ud_z_many</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-3701"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_in_lam :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_in_lam"><span class="hs-identifier hs-var">ud_z_in_lam</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-3702"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_tail :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3703"></span><span>
</span><span id="line-3704"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#modifyUDEnv"><span class="hs-identifier hs-type">modifyUDEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3705"></span><span id="modifyUDEnv"><span class="annot"><span class="annottext">modifyUDEnv :: (VarEnv LocalOcc -&gt; VarEnv LocalOcc)
-&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#modifyUDEnv"><span class="hs-identifier hs-var hs-var">modifyUDEnv</span></a></span></span><span> </span><span id="local-6989586621682711947"><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; VarEnv LocalOcc
</span><a href="#local-6989586621682711947"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682711948"><span class="annot"><span class="annottext">uds :: UsageDetails
</span><a href="#local-6989586621682711948"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711949"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711949"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711948"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711947"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682711949"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3706"></span><span>
</span><span id="line-3707"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#delBndrsFromUDs"><span class="hs-identifier hs-type">delBndrsFromUDs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3708"></span><span class="hs-comment">-- Delete these binders from the UsageDetails</span><span>
</span><span id="line-3709"></span><span id="delBndrsFromUDs"><span class="annot"><span class="annottext">delBndrsFromUDs :: [Id] -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#delBndrsFromUDs"><span class="hs-identifier hs-var hs-var">delBndrsFromUDs</span></a></span></span><span> </span><span id="local-6989586621682711950"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711950"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711951"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711951"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_many :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_many"><span class="hs-identifier hs-var">ud_z_many</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711952"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711952"><span class="hs-identifier hs-var">z_many</span></a></span></span><span>
</span><span id="line-3710"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_in_lam :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_in_lam"><span class="hs-identifier hs-var">ud_z_in_lam</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711953"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711953"><span class="hs-identifier hs-var">z_in_lam</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_tail :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711954"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711954"><span class="hs-identifier hs-var">z_tail</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3711"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711951"><span class="hs-identifier hs-var">env</span></a></span><span>      </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; [Id] -&gt; VarEnv LocalOcc
forall a. VarEnv a -&gt; [Id] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-operator hs-var">`delVarEnvList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711950"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3712"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_many :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_many"><span class="hs-identifier hs-var">ud_z_many</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711952"><span class="hs-identifier hs-var">z_many</span></a></span><span>   </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; [Id] -&gt; VarEnv LocalOcc
forall a. VarEnv a -&gt; [Id] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-operator hs-var">`delVarEnvList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711950"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3713"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_in_lam :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_in_lam"><span class="hs-identifier hs-var">ud_z_in_lam</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711953"><span class="hs-identifier hs-var">z_in_lam</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; [Id] -&gt; VarEnv LocalOcc
forall a. VarEnv a -&gt; [Id] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-operator hs-var">`delVarEnvList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711950"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3714"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_tail :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711954"><span class="hs-identifier hs-var">z_tail</span></a></span><span>   </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; [Id] -&gt; VarEnv LocalOcc
forall a. VarEnv a -&gt; [Id] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-operator hs-var">`delVarEnvList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682711950"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3715"></span><span>
</span><span id="line-3716"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markAllMany"><span class="hs-identifier hs-type">markAllMany</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markAllInsideLam"><span class="hs-identifier hs-type">markAllInsideLam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-type">markAllNonTail</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markAllManyNonTail"><span class="hs-identifier hs-type">markAllManyNonTail</span></a></span><span>
</span><span id="line-3717"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3718"></span><span id="markAllMany"><span class="annot"><span class="annottext">markAllMany :: UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllMany"><span class="hs-identifier hs-var hs-var">markAllMany</span></a></span></span><span>      </span><span id="local-6989586621682711956"><span class="annot"><span class="annottext">ud :: UsageDetails
</span><a href="#local-6989586621682711956"><span class="hs-identifier hs-var">ud</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711957"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711957"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711956"><span class="hs-identifier hs-var">ud</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ud_z_many"><span class="hs-identifier hs-var">ud_z_many</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711957"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3719"></span><span id="markAllInsideLam"><span class="annot"><span class="annottext">markAllInsideLam :: UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllInsideLam"><span class="hs-identifier hs-var hs-var">markAllInsideLam</span></a></span></span><span> </span><span id="local-6989586621682711958"><span class="annot"><span class="annottext">ud :: UsageDetails
</span><a href="#local-6989586621682711958"><span class="hs-identifier hs-var">ud</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711959"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711959"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711958"><span class="hs-identifier hs-var">ud</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ud_z_in_lam"><span class="hs-identifier hs-var">ud_z_in_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711959"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3720"></span><span id="markAllNonTail"><span class="annot"><span class="annottext">markAllNonTail :: UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-var hs-var">markAllNonTail</span></a></span></span><span>   </span><span id="local-6989586621682711960"><span class="annot"><span class="annottext">ud :: UsageDetails
</span><a href="#local-6989586621682711960"><span class="hs-identifier hs-var">ud</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711961"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711961"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711960"><span class="hs-identifier hs-var">ud</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682711961"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3721"></span><span id="markAllManyNonTail"><span class="annot"><span class="annottext">markAllManyNonTail :: UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllManyNonTail"><span class="hs-identifier hs-var hs-var">markAllManyNonTail</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllMany"><span class="hs-identifier hs-var">markAllMany</span></a></span><span> </span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails)
-&gt; (UsageDetails -&gt; UsageDetails) -&gt; UsageDetails -&gt; UsageDetails
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-var">markAllNonTail</span></a></span><span> </span><span class="hs-comment">-- effectively sets to noOccInfo</span><span>
</span><span id="line-3722"></span><span>
</span><span id="line-3723"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markAllInsideLamIf"><span class="hs-identifier hs-type">markAllInsideLamIf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTailIf"><span class="hs-identifier hs-type">markAllNonTailIf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3724"></span><span>
</span><span id="line-3725"></span><span id="markAllInsideLamIf"><span class="annot"><span class="annottext">markAllInsideLamIf :: Bool -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllInsideLamIf"><span class="hs-identifier hs-var hs-var">markAllInsideLamIf</span></a></span></span><span>  </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span id="local-6989586621682711964"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711964"><span class="hs-identifier hs-var">ud</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllInsideLam"><span class="hs-identifier hs-var">markAllInsideLam</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711964"><span class="hs-identifier hs-var">ud</span></a></span><span>
</span><span id="line-3726"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markAllInsideLamIf"><span class="hs-identifier hs-var">markAllInsideLamIf</span></a></span><span>  </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span id="local-6989586621682711965"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711965"><span class="hs-identifier hs-var">ud</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711965"><span class="hs-identifier hs-var">ud</span></a></span><span>
</span><span id="line-3727"></span><span>
</span><span id="line-3728"></span><span id="markAllNonTailIf"><span class="annot"><span class="annottext">markAllNonTailIf :: Bool -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTailIf"><span class="hs-identifier hs-var hs-var">markAllNonTailIf</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span id="local-6989586621682711966"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711966"><span class="hs-identifier hs-var">ud</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTail"><span class="hs-identifier hs-var">markAllNonTail</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711966"><span class="hs-identifier hs-var">ud</span></a></span><span>
</span><span id="line-3729"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTailIf"><span class="hs-identifier hs-var">markAllNonTailIf</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span id="local-6989586621682711967"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711967"><span class="hs-identifier hs-var">ud</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711967"><span class="hs-identifier hs-var">ud</span></a></span><span>
</span><span id="line-3730"></span><span>
</span><span id="line-3731"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#lookupTailCallInfo"><span class="hs-identifier hs-type">lookupTailCallInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a></span><span>
</span><span id="line-3732"></span><span id="lookupTailCallInfo"><span class="annot"><span class="annottext">lookupTailCallInfo :: UsageDetails -&gt; Id -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupTailCallInfo"><span class="hs-identifier hs-var hs-var">lookupTailCallInfo</span></a></span></span><span> </span><span id="local-6989586621682711969"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711969"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span id="local-6989586621682711970"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711970"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-3733"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_z_tail :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711971"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711971"><span class="hs-identifier hs-var">z_tail</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711972"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711972"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711969"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-3734"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711970"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarEnv LocalOcc -&gt; Bool
forall a. Id -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnv"><span class="hs-operator hs-var">`elemVarEnv`</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711971"><span class="hs-identifier hs-var">z_tail</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3735"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682711973"><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682711973"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; Id -&gt; Maybe LocalOcc
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711972"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711970"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-3736"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#localTailCallInfo"><span class="hs-identifier hs-var">localTailCallInfo</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682711973"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-3737"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3738"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="GHC.Types.Basic.html#NoTailCallInfo"><span class="hs-identifier hs-var">NoTailCallInfo</span></a></span><span>
</span><span id="line-3739"></span><span>
</span><span id="line-3740"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#udFreeVars"><span class="hs-identifier hs-type">udFreeVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-3741"></span><span class="hs-comment">-- Find the subset of bndrs that are mentioned in uds</span><span>
</span><span id="line-3742"></span><span id="udFreeVars"><span class="annot"><span class="annottext">udFreeVars :: VarSet -&gt; UsageDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#udFreeVars"><span class="hs-identifier hs-var hs-var">udFreeVars</span></a></span></span><span> </span><span id="local-6989586621682711974"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711974"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711975"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711975"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarEnv LocalOcc -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#restrictFreeVars"><span class="hs-identifier hs-var">restrictFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711974"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711975"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-3743"></span><span>
</span><span id="line-3744"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#restrictFreeVars"><span class="hs-identifier hs-type">restrictFreeVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-3745"></span><span id="restrictFreeVars"><span class="annot"><span class="annottext">restrictFreeVars :: VarSet -&gt; VarEnv LocalOcc -&gt; VarSet
</span><a href="GHC.Core.Opt.OccurAnal.html#restrictFreeVars"><span class="hs-identifier hs-var hs-var">restrictFreeVars</span></a></span></span><span> </span><span id="local-6989586621682711977"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711977"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682711978"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711978"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarEnv LocalOcc -&gt; VarSet
forall key b. UniqSet key -&gt; UniqFM key b -&gt; UniqSet key
</span><a href="GHC.Types.Unique.Set.html#restrictUniqSetToUFM"><span class="hs-identifier hs-var">restrictUniqSetToUFM</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682711977"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711978"><span class="hs-identifier hs-var">fvs</span></a></span><span>
</span><span id="line-3746"></span><span>
</span><span id="line-3747"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-3748"></span><span class="hs-comment">-- Auxiliary functions for UsageDetails implementation</span><span>
</span><span id="line-3749"></span><span>
</span><span id="line-3750"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#combineUsageDetailsWith"><span class="hs-identifier hs-type">combineUsageDetailsWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3751"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3752"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#combineUsageDetailsWith"><span class="hs-pragma hs-type">combineUsageDetailsWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-3753"></span><span id="combineUsageDetailsWith"><span class="annot"><span class="annottext">combineUsageDetailsWith :: (LocalOcc -&gt; LocalOcc -&gt; LocalOcc)
-&gt; UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#combineUsageDetailsWith"><span class="hs-identifier hs-var hs-var">combineUsageDetailsWith</span></a></span></span><span> </span><span id="local-6989586621682711980"><span class="annot"><span class="annottext">LocalOcc -&gt; LocalOcc -&gt; LocalOcc
</span><a href="#local-6989586621682711980"><span class="hs-identifier hs-var">plus_occ_info</span></a></span></span><span>
</span><span id="line-3754"></span><span>    </span><span id="local-6989586621682711981"><span class="annot"><span class="annottext">uds1 :: UsageDetails
</span><a href="#local-6989586621682711981"><span class="hs-identifier hs-var">uds1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711982"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711982"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_many :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_many"><span class="hs-identifier hs-var">ud_z_many</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711983"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711983"><span class="hs-identifier hs-var">z_many1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_in_lam :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_in_lam"><span class="hs-identifier hs-var">ud_z_in_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711984"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711984"><span class="hs-identifier hs-var">z_in_lam1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_tail :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711985"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711985"><span class="hs-identifier hs-var">z_tail1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3755"></span><span>    </span><span id="local-6989586621682711986"><span class="annot"><span class="annottext">uds2 :: UsageDetails
</span><a href="#local-6989586621682711986"><span class="hs-identifier hs-var">uds2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711987"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711987"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_many :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_many"><span class="hs-identifier hs-var">ud_z_many</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711988"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711988"><span class="hs-identifier hs-var">z_many2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_in_lam :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_in_lam"><span class="hs-identifier hs-var">ud_z_in_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711989"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711989"><span class="hs-identifier hs-var">z_in_lam2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_tail :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711990"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711990"><span class="hs-identifier hs-var">z_tail2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3756"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711982"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711986"><span class="hs-identifier hs-var">uds2</span></a></span><span>
</span><span id="line-3757"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711987"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711981"><span class="hs-identifier hs-var">uds1</span></a></span><span>
</span><span id="line-3758"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3759"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LocalOcc -&gt; LocalOcc -&gt; LocalOcc)
-&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
forall a. (a -&gt; a -&gt; a) -&gt; VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv_C"><span class="hs-identifier hs-var">plusVarEnv_C</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; LocalOcc -&gt; LocalOcc
</span><a href="#local-6989586621682711980"><span class="hs-identifier hs-var">plus_occ_info</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711982"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711987"><span class="hs-identifier hs-var">env2</span></a></span><span>
</span><span id="line-3760"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_many :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_many"><span class="hs-identifier hs-var">ud_z_many</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
forall a. VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv"><span class="hs-identifier hs-var">plusVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711983"><span class="hs-identifier hs-var">z_many1</span></a></span><span>   </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711988"><span class="hs-identifier hs-var">z_many2</span></a></span><span>
</span><span id="line-3761"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_in_lam :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_in_lam"><span class="hs-identifier hs-var">ud_z_in_lam</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
forall a. VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv"><span class="hs-identifier hs-var">plusVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711984"><span class="hs-identifier hs-var">z_in_lam1</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711989"><span class="hs-identifier hs-var">z_in_lam2</span></a></span><span>
</span><span id="line-3762"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_tail :: VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; VarEnv LocalOcc -&gt; VarEnv LocalOcc
forall a. VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv"><span class="hs-identifier hs-var">plusVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711985"><span class="hs-identifier hs-var">z_tail1</span></a></span><span>   </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711990"><span class="hs-identifier hs-var">z_tail2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3763"></span><span>
</span><span id="line-3764"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#lookupLetOccInfo"><span class="hs-identifier hs-type">lookupLetOccInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a></span><span>
</span><span id="line-3765"></span><span class="hs-comment">-- Don't use locally-generated occ_info for exported (visible-elsewhere)</span><span>
</span><span id="line-3766"></span><span class="hs-comment">-- things.  Instead just give noOccInfo.</span><span>
</span><span id="line-3767"></span><span class="hs-comment">-- NB: setBinderOcc will (rightly) erase any LoopBreaker info;</span><span>
</span><span id="line-3768"></span><span class="hs-comment">--     we are about to re-generate it and it shouldn't be &quot;sticky&quot;</span><span>
</span><span id="line-3769"></span><span id="lookupLetOccInfo"><span class="annot"><span class="annottext">lookupLetOccInfo :: UsageDetails -&gt; Id -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupLetOccInfo"><span class="hs-identifier hs-var hs-var">lookupLetOccInfo</span></a></span></span><span> </span><span id="local-6989586621682711992"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711992"><span class="hs-identifier hs-var">ud</span></a></span></span><span> </span><span id="local-6989586621682711993"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711993"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-3770"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711993"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#noOccInfo"><span class="hs-identifier hs-var">noOccInfo</span></a></span><span>
</span><span id="line-3771"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; Unique -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupOccInfoByUnique"><span class="hs-identifier hs-var">lookupOccInfoByUnique</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711992"><span class="hs-identifier hs-var">ud</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unique
</span><a href="GHC.Types.Id.html#idUnique"><span class="hs-identifier hs-var">idUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711993"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3772"></span><span>
</span><span id="line-3773"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#lookupOccInfo"><span class="hs-identifier hs-type">lookupOccInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a></span><span>
</span><span id="line-3774"></span><span id="lookupOccInfo"><span class="annot"><span class="annottext">lookupOccInfo :: UsageDetails -&gt; Id -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupOccInfo"><span class="hs-identifier hs-var hs-var">lookupOccInfo</span></a></span></span><span> </span><span id="local-6989586621682711997"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711997"><span class="hs-identifier hs-var">ud</span></a></span></span><span> </span><span id="local-6989586621682711998"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711998"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; Unique -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupOccInfoByUnique"><span class="hs-identifier hs-var">lookupOccInfoByUnique</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682711997"><span class="hs-identifier hs-var">ud</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unique
</span><a href="GHC.Types.Id.html#idUnique"><span class="hs-identifier hs-var">idUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682711998"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3775"></span><span>
</span><span id="line-3776"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#lookupOccInfoByUnique"><span class="hs-identifier hs-type">lookupOccInfoByUnique</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a></span><span>
</span><span id="line-3777"></span><span id="lookupOccInfoByUnique"><span class="annot"><span class="annottext">lookupOccInfoByUnique :: UsageDetails -&gt; Unique -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupOccInfoByUnique"><span class="hs-identifier hs-var hs-var">lookupOccInfoByUnique</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UD"><span class="hs-identifier hs-type">UD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_env :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_env"><span class="hs-identifier hs-var">ud_env</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682711999"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711999"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-3778"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_many :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_many"><span class="hs-identifier hs-var">ud_z_many</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712000"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682712000"><span class="hs-identifier hs-var">z_many</span></a></span></span><span>
</span><span id="line-3779"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_in_lam :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_in_lam"><span class="hs-identifier hs-var">ud_z_in_lam</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712001"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682712001"><span class="hs-identifier hs-var">z_in_lam</span></a></span></span><span>
</span><span id="line-3780"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_z_tail :: UsageDetails -&gt; VarEnv LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ud_z_tail"><span class="hs-identifier hs-var">ud_z_tail</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712002"><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682712002"><span class="hs-identifier hs-var">z_tail</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3781"></span><span>                  </span><span id="local-6989586621682712003"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682712003"><span class="hs-identifier hs-var">uniq</span></a></span></span><span>
</span><span id="line-3782"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc -&gt; Unique -&gt; Maybe LocalOcc
forall a. VarEnv a -&gt; Unique -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv_Directly"><span class="hs-identifier hs-var">lookupVarEnv_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682711999"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682712003"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3783"></span><span>      </span><span class="annot"><span class="annottext">Maybe LocalOcc
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a></span><span>
</span><span id="line-3784"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneOccL"><span class="hs-identifier hs-type">OneOccL</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lo_n_br :: LocalOcc -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_n_br"><span class="hs-identifier hs-var">lo_n_br</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712006"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712006"><span class="hs-identifier hs-var">n_br</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_int_cxt :: LocalOcc -&gt; InterestingCxt
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_int_cxt"><span class="hs-identifier hs-var">lo_int_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712007"><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682712007"><span class="hs-identifier hs-var">int_cxt</span></a></span></span><span>
</span><span id="line-3785"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_tail :: LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_tail"><span class="hs-identifier hs-var">lo_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712008"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712008"><span class="hs-identifier hs-var">tail_info</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3786"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682712003"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; VarEnv LocalOcc -&gt; Bool
forall a. Unique -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnvByKey"><span class="hs-operator hs-var">`elemVarEnvByKey`</span></a></span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682712000"><span class="hs-identifier hs-var">z_many</span></a></span><span>
</span><span id="line-3787"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#ManyOccs"><span class="hs-identifier hs-type">ManyOccs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_tail :: TailCallInfo
</span><a href="GHC.Types.Basic.html#occ_tail"><span class="hs-identifier hs-var">occ_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo -&gt; TailCallInfo
</span><a href="#local-6989586621682712010"><span class="hs-identifier hs-var">mk_tail_info</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712008"><span class="hs-identifier hs-var">tail_info</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3788"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3789"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OneOcc"><span class="hs-identifier hs-type">OneOcc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_in_lam :: InsideLam
</span><a href="GHC.Types.Basic.html#occ_in_lam"><span class="hs-identifier hs-var">occ_in_lam</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="#local-6989586621682712011"><span class="hs-identifier hs-var">in_lam</span></a></span><span>
</span><span id="line-3790"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_n_br :: JoinArity
</span><a href="GHC.Types.Basic.html#occ_n_br"><span class="hs-identifier hs-var">occ_n_br</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712006"><span class="hs-identifier hs-var">n_br</span></a></span><span>
</span><span id="line-3791"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_int_cxt :: InterestingCxt
</span><a href="GHC.Types.Basic.html#occ_int_cxt"><span class="hs-identifier hs-var">occ_int_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682712007"><span class="hs-identifier hs-var">int_cxt</span></a></span><span>
</span><span id="line-3792"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">occ_tail :: TailCallInfo
</span><a href="GHC.Types.Basic.html#occ_tail"><span class="hs-identifier hs-var">occ_tail</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo -&gt; TailCallInfo
</span><a href="#local-6989586621682712010"><span class="hs-identifier hs-var">mk_tail_info</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712008"><span class="hs-identifier hs-var">tail_info</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3793"></span><span>         </span><span class="hs-keyword">where</span><span>
</span><span id="line-3794"></span><span>           </span><span id="local-6989586621682712011"><span class="annot"><span class="annottext">in_lam :: InsideLam
</span><a href="#local-6989586621682712011"><span class="hs-identifier hs-var hs-var">in_lam</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682712003"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; VarEnv LocalOcc -&gt; Bool
forall a. Unique -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnvByKey"><span class="hs-operator hs-var">`elemVarEnvByKey`</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682712001"><span class="hs-identifier hs-var">z_in_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#IsInsideLam"><span class="hs-identifier hs-var">IsInsideLam</span></a></span><span>
</span><span id="line-3795"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsideLam
</span><a href="GHC.Types.Basic.html#NotInsideLam"><span class="hs-identifier hs-var">NotInsideLam</span></a></span><span>
</span><span id="line-3796"></span><span>
</span><span id="line-3797"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ManyOccL"><span class="hs-identifier hs-type">ManyOccL</span></a></span><span> </span><span id="local-6989586621682712014"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712014"><span class="hs-identifier hs-var">tail_info</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#ManyOccs"><span class="hs-identifier hs-type">ManyOccs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occ_tail :: TailCallInfo
</span><a href="GHC.Types.Basic.html#occ_tail"><span class="hs-identifier hs-var">occ_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo -&gt; TailCallInfo
</span><a href="#local-6989586621682712010"><span class="hs-identifier hs-var">mk_tail_info</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712014"><span class="hs-identifier hs-var">tail_info</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3798"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3799"></span><span>    </span><span id="local-6989586621682712010"><span class="annot"><span class="annottext">mk_tail_info :: TailCallInfo -&gt; TailCallInfo
</span><a href="#local-6989586621682712010"><span class="hs-identifier hs-var hs-var">mk_tail_info</span></a></span></span><span> </span><span id="local-6989586621682712015"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712015"><span class="hs-identifier hs-var">ti</span></a></span></span><span>
</span><span id="line-3800"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682712003"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; VarEnv LocalOcc -&gt; Bool
forall a. Unique -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnvByKey"><span class="hs-operator hs-var">`elemVarEnvByKey`</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv LocalOcc
</span><a href="#local-6989586621682712002"><span class="hs-identifier hs-var">z_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="GHC.Types.Basic.html#NoTailCallInfo"><span class="hs-identifier hs-var">NoTailCallInfo</span></a></span><span>
</span><span id="line-3801"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712015"><span class="hs-identifier hs-var">ti</span></a></span><span>
</span><span id="line-3802"></span><span>
</span><span id="line-3803"></span><span>
</span><span id="line-3804"></span><span>
</span><span id="line-3805"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-3806"></span><span class="hs-comment">-- See Note [Adjusting right-hand sides]</span><span>
</span><span id="line-3807"></span><span>
</span><span id="line-3808"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#adjustNonRecRhs"><span class="hs-identifier hs-type">adjustNonRecRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPointHood"><span class="hs-identifier hs-type">JoinPointHood</span></a></span><span>
</span><span id="line-3809"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithTailUsageDetails"><span class="hs-identifier hs-type">WithTailUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-3810"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-3811"></span><span class="hs-comment">-- ^ This function concentrates shared logic between occAnalNonRecBind and the</span><span>
</span><span id="line-3812"></span><span class="hs-comment">-- AcyclicSCC case of occAnalRec.</span><span>
</span><span id="line-3813"></span><span class="hs-comment">-- It returns the adjusted rhs UsageDetails combined with the body usage</span><span>
</span><span id="line-3814"></span><span id="adjustNonRecRhs"><span class="annot"><span class="annottext">adjustNonRecRhs :: JoinPointHood
-&gt; WithTailUsageDetails CoreExpr -&gt; WithUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustNonRecRhs"><span class="hs-identifier hs-var hs-var">adjustNonRecRhs</span></a></span></span><span> </span><span id="local-6989586621682712016"><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682712016"><span class="hs-identifier hs-var">mb_join_arity</span></a></span></span><span> </span><span id="local-6989586621682712017"><span class="annot"><span class="annottext">rhs_wuds :: WithTailUsageDetails CoreExpr
</span><a href="#local-6989586621682712017"><span class="hs-identifier hs-var">rhs_wuds</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span class="annot"><span class="annottext">TailUsageDetails
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682712018"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682712018"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3815"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; CoreExpr -&gt; WithUsageDetails CoreExpr
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinPointHood -&gt; WithTailUsageDetails CoreExpr -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustTailUsage"><span class="hs-identifier hs-var">adjustTailUsage</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682712016"><span class="hs-identifier hs-var">mb_join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">WithTailUsageDetails CoreExpr
</span><a href="#local-6989586621682712017"><span class="hs-identifier hs-var">rhs_wuds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682712018"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3816"></span><span>
</span><span id="line-3817"></span><span>
</span><span id="line-3818"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#adjustTailUsage"><span class="hs-identifier hs-type">adjustTailUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPointHood"><span class="hs-identifier hs-type">JoinPointHood</span></a></span><span>
</span><span id="line-3819"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithTailUsageDetails"><span class="hs-identifier hs-type">WithTailUsageDetails</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>    </span><span class="hs-comment">-- Rhs usage, AFTER occAnalLamTail</span><span>
</span><span id="line-3820"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3821"></span><span id="adjustTailUsage"><span class="annot"><span class="annottext">adjustTailUsage :: JoinPointHood -&gt; WithTailUsageDetails CoreExpr -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustTailUsage"><span class="hs-identifier hs-var hs-var">adjustTailUsage</span></a></span></span><span> </span><span id="local-6989586621682712019"><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682712019"><span class="hs-identifier hs-var">mb_join_arity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-type">TUD</span></a></span><span> </span><span id="local-6989586621682712020"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712020"><span class="hs-identifier hs-var">rhs_ja</span></a></span></span><span> </span><span id="local-6989586621682712021"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712021"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682712022"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682712022"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3822"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- c.f. occAnal (Lam {})</span><span>
</span><span id="line-3823"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllInsideLamIf"><span class="hs-identifier hs-var">markAllInsideLamIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682712023"><span class="hs-identifier hs-var">one_shot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails) -&gt; UsageDetails -&gt; UsageDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3824"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTailIf"><span class="hs-identifier hs-var">markAllNonTailIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682712024"><span class="hs-identifier hs-var">exact_join</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails) -&gt; UsageDetails -&gt; UsageDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3825"></span><span>    </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712021"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-3826"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3827"></span><span>    </span><span id="local-6989586621682712023"><span class="annot"><span class="annottext">one_shot :: Bool
</span><a href="#local-6989586621682712023"><span class="hs-identifier hs-var hs-var">one_shot</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#isOneShotFun"><span class="hs-identifier hs-var">isOneShotFun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682712022"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3828"></span><span>    </span><span id="local-6989586621682712024"><span class="annot"><span class="annottext">exact_join :: Bool
</span><a href="#local-6989586621682712024"><span class="hs-identifier hs-var hs-var">exact_join</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682712019"><span class="hs-identifier hs-var">mb_join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood -&gt; JoinPointHood -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinPointHood
</span><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-var">JoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712020"><span class="hs-identifier hs-var">rhs_ja</span></a></span><span>
</span><span id="line-3829"></span><span>
</span><span id="line-3830"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#adjustTailArity"><span class="hs-identifier hs-type">adjustTailArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPointHood"><span class="hs-identifier hs-type">JoinPointHood</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TailUsageDetails"><span class="hs-identifier hs-type">TailUsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3831"></span><span id="adjustTailArity"><span class="annot"><span class="annottext">adjustTailArity :: JoinPointHood -&gt; TailUsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustTailArity"><span class="hs-identifier hs-var hs-var">adjustTailArity</span></a></span></span><span> </span><span id="local-6989586621682712025"><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682712025"><span class="hs-identifier hs-var">mb_rhs_ja</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#TUD"><span class="hs-identifier hs-type">TUD</span></a></span><span> </span><span id="local-6989586621682712026"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712026"><span class="hs-identifier hs-var">ja</span></a></span></span><span> </span><span id="local-6989586621682712027"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712027"><span class="hs-identifier hs-var">usage</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3832"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#markAllNonTailIf"><span class="hs-identifier hs-var">markAllNonTailIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682712025"><span class="hs-identifier hs-var">mb_rhs_ja</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood -&gt; JoinPointHood -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinPointHood
</span><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-var">JoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712026"><span class="hs-identifier hs-var">ja</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712027"><span class="hs-identifier hs-var">usage</span></a></span><span>
</span><span id="line-3833"></span><span>
</span><span id="line-3834"></span><span class="hs-keyword">type</span><span> </span><span id="IdWithOccInfo"><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-var">IdWithOccInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-3835"></span><span>
</span><span id="line-3836"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#tagLamBinders"><span class="hs-identifier hs-type">tagLamBinders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>        </span><span class="hs-comment">-- Of scope</span><span>
</span><span id="line-3837"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- Binders</span><span>
</span><span id="line-3838"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a></span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Tagged binders</span><span>
</span><span id="line-3839"></span><span id="tagLamBinders"><span class="annot"><span class="annottext">tagLamBinders :: UsageDetails -&gt; [Id] -&gt; [Id]
</span><a href="GHC.Core.Opt.OccurAnal.html#tagLamBinders"><span class="hs-identifier hs-var hs-var">tagLamBinders</span></a></span></span><span> </span><span id="local-6989586621682712028"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712028"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621682712029"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682712029"><span class="hs-identifier hs-var">binders</span></a></span></span><span>
</span><span id="line-3840"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#tagLamBinder"><span class="hs-identifier hs-var">tagLamBinder</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712028"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682712029"><span class="hs-identifier hs-var">binders</span></a></span><span>
</span><span id="line-3841"></span><span>
</span><span id="line-3842"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#tagLamBinder"><span class="hs-identifier hs-type">tagLamBinder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>       </span><span class="hs-comment">-- Of scope</span><span>
</span><span id="line-3843"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>                 </span><span class="hs-comment">-- Binder</span><span>
</span><span id="line-3844"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a></span><span>      </span><span class="hs-comment">-- Tagged binders</span><span>
</span><span id="line-3845"></span><span class="hs-comment">-- Used for lambda and case binders</span><span>
</span><span id="line-3846"></span><span class="hs-comment">-- No-op on TyVars</span><span>
</span><span id="line-3847"></span><span class="hs-comment">-- A lambda binder never has an unfolding, so no need to look for that</span><span>
</span><span id="line-3848"></span><span id="tagLamBinder"><span class="annot"><span class="annottext">tagLamBinder :: UsageDetails -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#tagLamBinder"><span class="hs-identifier hs-var hs-var">tagLamBinder</span></a></span></span><span> </span><span id="local-6989586621682712030"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712030"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621682712031"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712031"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-3849"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#setBinderOcc"><span class="hs-identifier hs-var">setBinderOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccInfo -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#markNonTail"><span class="hs-identifier hs-var">markNonTail</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712034"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712031"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3850"></span><span>      </span><span class="hs-comment">-- markNonTail: don't try to make an argument into a join point</span><span>
</span><span id="line-3851"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3852"></span><span>    </span><span id="local-6989586621682712034"><span class="annot"><span class="annottext">occ :: OccInfo
</span><a href="#local-6989586621682712034"><span class="hs-identifier hs-var hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; Id -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupOccInfo"><span class="hs-identifier hs-var">lookupOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712030"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712031"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3853"></span><span>
</span><span id="line-3854"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#tagNonRecBinder"><span class="hs-identifier hs-type">tagNonRecBinder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>           </span><span class="hs-comment">-- At top level?</span><span>
</span><span id="line-3855"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a></span><span>                </span><span class="hs-comment">-- Of scope</span><span>
</span><span id="line-3856"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span>               </span><span class="hs-comment">-- Binder</span><span>
</span><span id="line-3857"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPointHood"><span class="hs-identifier hs-type">JoinPointHood</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Tagged binder</span><span>
</span><span id="line-3858"></span><span class="hs-comment">-- No-op on TyVars</span><span>
</span><span id="line-3859"></span><span class="hs-comment">-- Precondition: OccInfo is not IAmDead</span><span>
</span><span id="line-3860"></span><span id="tagNonRecBinder"><span class="annot"><span class="annottext">tagNonRecBinder :: TopLevelFlag -&gt; OccInfo -&gt; Id -&gt; (Id, JoinPointHood)
</span><a href="GHC.Core.Opt.OccurAnal.html#tagNonRecBinder"><span class="hs-identifier hs-var hs-var">tagNonRecBinder</span></a></span></span><span> </span><span id="local-6989586621682712035"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682712035"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682712036"><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712036"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span id="local-6989586621682712037"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712037"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-3861"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Id -&gt; TailCallInfo -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#okForJoinPoint"><span class="hs-identifier hs-var">okForJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682712035"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712037"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712039"><span class="hs-identifier hs-var">tail_call_info</span></a></span><span>
</span><span id="line-3862"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#AlwaysTailCalled"><span class="hs-identifier hs-type">AlwaysTailCalled</span></a></span><span> </span><span id="local-6989586621682712040"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712040"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712039"><span class="hs-identifier hs-var">tail_call_info</span></a></span><span>
</span><span id="line-3863"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccInfo -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#setBinderOcc"><span class="hs-identifier hs-var">setBinderOcc</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712036"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712037"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span>        </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinPointHood
</span><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-var">JoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712040"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3864"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3865"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccInfo -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#setBinderOcc"><span class="hs-identifier hs-var">setBinderOcc</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712041"><span class="hs-identifier hs-var">zapped_occ</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712037"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-var">NotJoinPoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3866"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3867"></span><span>    </span><span id="local-6989586621682712039"><span class="annot"><span class="annottext">tail_call_info :: TailCallInfo
</span><a href="#local-6989586621682712039"><span class="hs-identifier hs-var hs-var">tail_call_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; TailCallInfo
</span><a href="GHC.Types.Basic.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712036"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-3868"></span><span>    </span><span id="local-6989586621682712041"><span class="annot"><span class="annottext">zapped_occ :: OccInfo
</span><a href="#local-6989586621682712041"><span class="hs-identifier hs-var hs-var">zapped_occ</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#markNonTail"><span class="hs-identifier hs-var">markNonTail</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712036"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-3869"></span><span>
</span><span id="line-3870"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#tagRecBinders"><span class="hs-identifier hs-type">tagRecBinders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>           </span><span class="hs-comment">-- At top level?</span><span>
</span><span id="line-3871"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>           </span><span class="hs-comment">-- Of body of let ONLY</span><span>
</span><span id="line-3872"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#NodeDetails"><span class="hs-identifier hs-type">NodeDetails</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3873"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WithUsageDetails"><span class="hs-identifier hs-type">WithUsageDetails</span></a></span><span>       </span><span class="hs-comment">-- Adjusted details for whole scope,</span><span>
</span><span id="line-3874"></span><span>                                        </span><span class="hs-comment">-- with binders removed</span><span>
</span><span id="line-3875"></span><span>                  </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a></span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Tagged binders</span><span>
</span><span id="line-3876"></span><span class="hs-comment">-- Substantially more complicated than non-recursive case. Need to adjust RHS</span><span>
</span><span id="line-3877"></span><span class="hs-comment">-- details *before* tagging binders (because the tags depend on the RHSes).</span><span>
</span><span id="line-3878"></span><span id="tagRecBinders"><span class="annot"><span class="annottext">tagRecBinders :: TopLevelFlag
-&gt; UsageDetails -&gt; [NodeDetails] -&gt; WithUsageDetails [Id]
</span><a href="GHC.Core.Opt.OccurAnal.html#tagRecBinders"><span class="hs-identifier hs-var hs-var">tagRecBinders</span></a></span></span><span> </span><span id="local-6989586621682712042"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682712042"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682712043"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712043"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span> </span><span id="local-6989586621682712044"><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682712044"><span class="hs-identifier hs-var">details_s</span></a></span></span><span>
</span><span id="line-3879"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-3880"></span><span>     </span><span id="local-6989586621682712045"><span class="annot"><span class="annottext">bndrs :: [Id]
</span><a href="#local-6989586621682712045"><span class="hs-identifier hs-var hs-var">bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NodeDetails -&gt; Id) -&gt; [NodeDetails] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">NodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var">nd_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682712044"><span class="hs-identifier hs-var">details_s</span></a></span><span>
</span><span id="line-3881"></span><span>
</span><span id="line-3882"></span><span>     </span><span class="hs-comment">-- 1. See Note [Join arity prediction based on joinRhsArity]</span><span>
</span><span id="line-3883"></span><span>     </span><span class="hs-comment">--    Determine possible join-point-hood of whole group, by testing for</span><span>
</span><span id="line-3884"></span><span>     </span><span class="hs-comment">--    manifest join arity M.</span><span>
</span><span id="line-3885"></span><span>     </span><span class="hs-comment">--    This (re-)asserts that makeNode had made tuds for that same arity M!</span><span>
</span><span id="line-3886"></span><span>     </span><span id="local-6989586621682712046"><span class="annot"><span class="annottext">unadj_uds :: UsageDetails
</span><a href="#local-6989586621682712046"><span class="hs-identifier hs-var hs-var">unadj_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NodeDetails -&gt; UsageDetails -&gt; UsageDetails)
-&gt; UsageDetails -&gt; [NodeDetails] -&gt; UsageDetails
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a></span><span> </span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails -&gt; UsageDetails)
-&gt; (NodeDetails -&gt; UsageDetails)
-&gt; NodeDetails
-&gt; UsageDetails
-&gt; UsageDetails
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">NodeDetails -&gt; UsageDetails
</span><a href="#local-6989586621682712047"><span class="hs-identifier hs-var">test_manifest_arity</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712043"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682712044"><span class="hs-identifier hs-var">details_s</span></a></span><span>
</span><span id="line-3887"></span><span>     </span><span id="local-6989586621682712047"><span class="annot"><span class="annottext">test_manifest_arity :: NodeDetails -&gt; UsageDetails
</span><a href="#local-6989586621682712047"><span class="hs-identifier hs-var hs-var">test_manifest_arity</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ND"><span class="hs-identifier hs-type">ND</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">nd_rhs :: NodeDetails -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_rhs"><span class="hs-identifier hs-var">nd_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#WTUD"><span class="hs-identifier hs-type">WTUD</span></a></span><span> </span><span id="local-6989586621682712048"><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682712048"><span class="hs-identifier hs-var">tuds</span></a></span></span><span> </span><span id="local-6989586621682712049"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682712049"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-3888"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointHood -&gt; TailUsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustTailArity"><span class="hs-identifier hs-var">adjustTailArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; JoinPointHood
</span><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-var">JoinPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; JoinArity
</span><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-var">joinRhsArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682712049"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TailUsageDetails
</span><a href="#local-6989586621682712048"><span class="hs-identifier hs-var">tuds</span></a></span><span>
</span><span id="line-3889"></span><span>
</span><span id="line-3890"></span><span>     </span><span id="local-6989586621682712050"><span class="annot"><span class="annottext">will_be_joins :: Bool
</span><a href="#local-6989586621682712050"><span class="hs-identifier hs-var hs-var">will_be_joins</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; UsageDetails -&gt; [Id] -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#decideRecJoinPointHood"><span class="hs-identifier hs-var">decideRecJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682712042"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712046"><span class="hs-identifier hs-var">unadj_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682712045"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3891"></span><span>
</span><span id="line-3892"></span><span>     </span><span class="annot"><a href="#local-6989586621682712052"><span class="hs-identifier hs-type">mb_join_arity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPointHood"><span class="hs-identifier hs-type">JoinPointHood</span></a></span><span>
</span><span id="line-3893"></span><span>     </span><span class="hs-comment">-- mb_join_arity: See Note [Join arity prediction based on joinRhsArity]</span><span>
</span><span id="line-3894"></span><span>     </span><span class="hs-comment">-- This is the source O</span><span>
</span><span id="line-3895"></span><span>     </span><span id="local-6989586621682712052"><span class="annot"><span class="annottext">mb_join_arity :: Id -&gt; JoinPointHood
</span><a href="#local-6989586621682712052"><span class="hs-identifier hs-var hs-var">mb_join_arity</span></a></span></span><span> </span><span id="local-6989586621682712053"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712053"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-3896"></span><span>         </span><span class="hs-comment">-- Can't use willBeJoinId_maybe here because we haven't tagged</span><span>
</span><span id="line-3897"></span><span>         </span><span class="hs-comment">-- the binder yet (the tag depends on these adjustments!)</span><span>
</span><span id="line-3898"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682712050"><span class="hs-identifier hs-var">will_be_joins</span></a></span><span>
</span><span id="line-3899"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#AlwaysTailCalled"><span class="hs-identifier hs-type">AlwaysTailCalled</span></a></span><span> </span><span id="local-6989586621682712054"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712054"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; Id -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupTailCallInfo"><span class="hs-identifier hs-var">lookupTailCallInfo</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712046"><span class="hs-identifier hs-var">unadj_uds</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712053"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3900"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinPointHood
</span><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-var">JoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712054"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-3901"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3902"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; JoinPointHood -&gt; JoinPointHood
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682712050"><span class="hs-identifier hs-var">will_be_joins</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Should be AlwaysTailCalled if</span><span>
</span><span id="line-3903"></span><span>         </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-var">NotJoinPoint</span></a></span><span>               </span><span class="hs-comment">-- we are making join points!</span><span>
</span><span id="line-3904"></span><span>
</span><span id="line-3905"></span><span>     </span><span class="hs-comment">-- 2. Adjust usage details of each RHS, taking into account the</span><span>
</span><span id="line-3906"></span><span>     </span><span class="hs-comment">--    join-point-hood decision</span><span>
</span><span id="line-3907"></span><span>     </span><span id="local-6989586621682712056"><span class="annot"><span class="annottext">rhs_udss' :: [UsageDetails]
</span><a href="#local-6989586621682712056"><span class="hs-identifier hs-var hs-var">rhs_udss'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">JoinPointHood -&gt; WithTailUsageDetails CoreExpr -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#adjustTailUsage"><span class="hs-identifier hs-var">adjustTailUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; JoinPointHood
</span><a href="#local-6989586621682712052"><span class="hs-identifier hs-var">mb_join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712057"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WithTailUsageDetails CoreExpr
</span><a href="#local-6989586621682712058"><span class="hs-identifier hs-var">rhs_wuds</span></a></span><span>
</span><span id="line-3908"></span><span>                     </span><span class="hs-comment">-- Matching occAnalLamTail in makeNode</span><span>
</span><span id="line-3909"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#ND"><span class="hs-identifier hs-type">ND</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">nd_bndr :: NodeDetails -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_bndr"><span class="hs-identifier hs-var">nd_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712057"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712057"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nd_rhs :: NodeDetails -&gt; WithTailUsageDetails CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#nd_rhs"><span class="hs-identifier hs-var">nd_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712058"><span class="annot"><span class="annottext">WithTailUsageDetails CoreExpr
</span><a href="#local-6989586621682712058"><span class="hs-identifier hs-var">rhs_wuds</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[NodeDetails]
</span><a href="#local-6989586621682712044"><span class="hs-identifier hs-var">details_s</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3910"></span><span>
</span><span id="line-3911"></span><span>     </span><span class="hs-comment">-- 3. Compute final usage details from adjusted RHS details</span><span>
</span><span id="line-3912"></span><span>     </span><span id="local-6989586621682712059"><span class="annot"><span class="annottext">adj_uds :: UsageDetails
</span><a href="#local-6989586621682712059"><span class="hs-identifier hs-var hs-var">adj_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UsageDetails -&gt; UsageDetails -&gt; UsageDetails)
-&gt; UsageDetails -&gt; [UsageDetails] -&gt; UsageDetails
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712043"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[UsageDetails]
</span><a href="#local-6989586621682712056"><span class="hs-identifier hs-var">rhs_udss'</span></a></span><span>
</span><span id="line-3913"></span><span>
</span><span id="line-3914"></span><span>     </span><span class="hs-comment">-- 4. Tag each binder with its adjusted details</span><span>
</span><span id="line-3915"></span><span>     </span><span id="local-6989586621682712060"><span class="annot"><span class="annottext">bndrs' :: [Id]
</span><a href="#local-6989586621682712060"><span class="hs-identifier hs-var hs-var">bndrs'</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#setBinderOcc"><span class="hs-identifier hs-var">setBinderOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; Id -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupLetOccInfo"><span class="hs-identifier hs-var">lookupLetOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712059"><span class="hs-identifier hs-var">adj_uds</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712061"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712061"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3916"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682712061"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712061"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682712045"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3917"></span><span>
</span><span id="line-3918"></span><span>   </span><span class="hs-keyword">in</span><span>
</span><span id="line-3919"></span><span>   </span><span class="annot"><span class="annottext">UsageDetails -&gt; [Id] -&gt; WithUsageDetails [Id]
forall a. UsageDetails -&gt; a -&gt; WithUsageDetails a
</span><a href="GHC.Core.Opt.OccurAnal.html#WUD"><span class="hs-identifier hs-var">WUD</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712059"><span class="hs-identifier hs-var">adj_uds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682712060"><span class="hs-identifier hs-var">bndrs'</span></a></span><span>
</span><span id="line-3920"></span><span>
</span><span id="line-3921"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#setBinderOcc"><span class="hs-identifier hs-type">setBinderOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span>
</span><span id="line-3922"></span><span id="setBinderOcc"><span class="annot"><span class="annottext">setBinderOcc :: OccInfo -&gt; Id -&gt; Id
</span><a href="GHC.Core.Opt.OccurAnal.html#setBinderOcc"><span class="hs-identifier hs-var hs-var">setBinderOcc</span></a></span></span><span> </span><span id="local-6989586621682712062"><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712062"><span class="hs-identifier hs-var">occ_info</span></a></span></span><span> </span><span id="local-6989586621682712063"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712063"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-3923"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712063"><span class="hs-identifier hs-var">bndr</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712063"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3924"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712062"><span class="hs-identifier hs-var">occ_info</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; OccInfo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712063"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712063"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3925"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OccInfo -&gt; Id
</span><a href="GHC.Types.Id.html#setIdOccInfo"><span class="hs-identifier hs-var">setIdOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712063"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712062"><span class="hs-identifier hs-var">occ_info</span></a></span><span>
</span><span id="line-3926"></span><span>
</span><span id="line-3927"></span><span class="hs-comment">-- | Decide whether some bindings should be made into join points or not, based</span><span>
</span><span id="line-3928"></span><span class="hs-comment">-- on its occurrences. This is</span><span>
</span><span id="line-3929"></span><span class="hs-comment">-- Returns `False` if they can't be join points. Note that it's an</span><span>
</span><span id="line-3930"></span><span class="hs-comment">-- all-or-nothing decision, as if multiple binders are given, they're</span><span>
</span><span id="line-3931"></span><span class="hs-comment">-- assumed to be mutually recursive.</span><span>
</span><span id="line-3932"></span><span class="hs-comment">--</span><span>
</span><span id="line-3933"></span><span class="hs-comment">-- It must, however, be a final decision. If we say `True` for 'f',</span><span>
</span><span id="line-3934"></span><span class="hs-comment">-- and then subsequently decide /not/ make 'f' into a join point, then</span><span>
</span><span id="line-3935"></span><span class="hs-comment">-- the decision about another binding 'g' might be invalidated if (say)</span><span>
</span><span id="line-3936"></span><span class="hs-comment">-- 'f' tail-calls 'g'.</span><span>
</span><span id="line-3937"></span><span class="hs-comment">--</span><span>
</span><span id="line-3938"></span><span class="hs-comment">-- See Note [Invariants on join points] in &quot;GHC.Core&quot;.</span><span>
</span><span id="line-3939"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#decideRecJoinPointHood"><span class="hs-identifier hs-type">decideRecJoinPointHood</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3940"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3941"></span><span id="decideRecJoinPointHood"><span class="annot"><span class="annottext">decideRecJoinPointHood :: TopLevelFlag -&gt; UsageDetails -&gt; [Id] -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#decideRecJoinPointHood"><span class="hs-identifier hs-var hs-var">decideRecJoinPointHood</span></a></span></span><span> </span><span id="local-6989586621682712064"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682712064"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682712065"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712065"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621682712066"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682712066"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>
</span><span id="line-3942"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621682712067"><span class="hs-identifier hs-var">ok</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682712066"><span class="hs-identifier hs-var">bndrs</span></a></span><span>  </span><span class="hs-comment">-- Invariant 3: Either all are join points or none are</span><span>
</span><span id="line-3943"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3944"></span><span>    </span><span id="local-6989586621682712067"><span class="annot"><span class="annottext">ok :: Id -&gt; Bool
</span><a href="#local-6989586621682712067"><span class="hs-identifier hs-var hs-var">ok</span></a></span></span><span> </span><span id="local-6989586621682712068"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712068"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Id -&gt; TailCallInfo -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#okForJoinPoint"><span class="hs-identifier hs-var">okForJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682712064"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712068"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; Id -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lookupTailCallInfo"><span class="hs-identifier hs-var">lookupTailCallInfo</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621682712065"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712068"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3945"></span><span>
</span><span id="line-3946"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#okForJoinPoint"><span class="hs-identifier hs-type">okForJoinPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3947"></span><span>    </span><span class="hs-comment">-- See Note [Invariants on join points]; invariants cited by number below.</span><span>
</span><span id="line-3948"></span><span>    </span><span class="hs-comment">-- Invariant 2 is always satisfiable by the simplifier by eta expansion.</span><span>
</span><span id="line-3949"></span><span id="okForJoinPoint"><span class="annot"><span class="annottext">okForJoinPoint :: TopLevelFlag -&gt; Id -&gt; TailCallInfo -&gt; Bool
</span><a href="GHC.Core.Opt.OccurAnal.html#okForJoinPoint"><span class="hs-identifier hs-var hs-var">okForJoinPoint</span></a></span></span><span> </span><span id="local-6989586621682712069"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682712069"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621682712070"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682712071"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712071"><span class="hs-identifier hs-var">tail_call_info</span></a></span></span><span>
</span><span id="line-3950"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span><span>        </span><span class="hs-comment">-- A current join point should still be one!</span><span>
</span><span id="line-3951"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682712073"><span class="hs-identifier hs-var">lost_join</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Lost join point&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682712074"><span class="hs-identifier hs-var">lost_join_doc</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3952"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3953"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682712075"><span class="hs-identifier hs-var">valid_join</span></a></span><span>
</span><span id="line-3954"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3955"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3956"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3957"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3958"></span><span>    </span><span id="local-6989586621682712075"><span class="annot"><span class="annottext">valid_join :: Bool
</span><a href="#local-6989586621682712075"><span class="hs-identifier hs-var hs-var">valid_join</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682712069"><span class="hs-identifier hs-var">lvl</span></a></span><span>
</span><span id="line-3959"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#AlwaysTailCalled"><span class="hs-identifier hs-type">AlwaysTailCalled</span></a></span><span> </span><span id="local-6989586621682712076"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712076"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712071"><span class="hs-identifier hs-var">tail_call_info</span></a></span><span>
</span><span id="line-3960"></span><span>
</span><span id="line-3961"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Invariant 1 as applied to LHSes of rules</span><span>
</span><span id="line-3962"></span><span>                 </span><span class="annot"><span class="annottext">(CoreRule -&gt; Bool) -&gt; [CoreRule] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; CoreRule -&gt; Bool
</span><a href="#local-6989586621682712077"><span class="hs-identifier hs-var">ok_rule</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712076"><span class="hs-identifier hs-var">arity</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3963"></span><span>
</span><span id="line-3964"></span><span>                 </span><span class="hs-comment">-- Invariant 2a: stable unfoldings</span><span>
</span><span id="line-3965"></span><span>                  </span><span class="hs-comment">-- See Note [Join points and INLINE pragmas]</span><span>
</span><span id="line-3966"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; Unfolding -&gt; Bool
</span><a href="#local-6989586621682712078"><span class="hs-identifier hs-var">ok_unfolding</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712076"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3967"></span><span>
</span><span id="line-3968"></span><span>                 </span><span class="hs-comment">-- Invariant 4: Satisfies polymorphism rule</span><span>
</span><span id="line-3969"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isValidJoinPointType"><span class="hs-identifier hs-var">isValidJoinPointType</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712076"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3970"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3971"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3972"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3973"></span><span>
</span><span id="line-3974"></span><span>    </span><span id="local-6989586621682712073"><span class="annot"><span class="annottext">lost_join :: Bool
</span><a href="#local-6989586621682712073"><span class="hs-identifier hs-var hs-var">lost_join</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span id="local-6989586621682712081"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712081"><span class="hs-identifier hs-var">ja</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3975"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682712075"><span class="hs-identifier hs-var">valid_join</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-3976"></span><span>                </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712071"><span class="hs-identifier hs-var">tail_call_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Valid join but arity differs</span><span>
</span><span id="line-3977"></span><span>                   </span><span class="annot"><a href="GHC.Types.Basic.html#AlwaysTailCalled"><span class="hs-identifier hs-type">AlwaysTailCalled</span></a></span><span> </span><span id="local-6989586621682712082"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712082"><span class="hs-identifier hs-var">ja'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712081"><span class="hs-identifier hs-var">ja</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712082"><span class="hs-identifier hs-var">ja'</span></a></span><span>
</span><span id="line-3978"></span><span>                   </span><span class="annot"><span class="annottext">TailCallInfo
</span><span class="hs-identifier">_</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-3979"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3980"></span><span>
</span><span id="line-3981"></span><span>    </span><span id="local-6989586621682712077"><span class="annot"><span class="annottext">ok_rule :: JoinArity -&gt; CoreRule -&gt; Bool
</span><a href="#local-6989586621682712077"><span class="hs-identifier hs-var hs-var">ok_rule</span></a></span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- only possible with plugin shenanigans</span><span>
</span><span id="line-3982"></span><span>    </span><span class="annot"><a href="#local-6989586621682712077"><span class="hs-identifier hs-var">ok_rule</span></a></span><span> </span><span id="local-6989586621682712084"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712084"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712085"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682712085"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3983"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682712085"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; JoinArity -&gt; Bool
forall a. [a] -&gt; JoinArity -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthIs"><span class="hs-operator hs-var">`lengthIs`</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712084"><span class="hs-identifier hs-var">join_arity</span></a></span><span>
</span><span id="line-3984"></span><span>        </span><span class="hs-comment">-- Invariant 1 as applied to LHSes of rules</span><span>
</span><span id="line-3985"></span><span>
</span><span id="line-3986"></span><span>    </span><span class="hs-comment">-- ok_unfolding returns False if we should /not/ convert a non-join-id</span><span>
</span><span id="line-3987"></span><span>    </span><span class="hs-comment">-- into a join-id, even though it is AlwaysTailCalled</span><span>
</span><span id="line-3988"></span><span>    </span><span id="local-6989586621682712078"><span class="annot"><span class="annottext">ok_unfolding :: JoinArity -&gt; Unfolding -&gt; Bool
</span><a href="#local-6989586621682712078"><span class="hs-identifier hs-var hs-var">ok_unfolding</span></a></span></span><span> </span><span id="local-6989586621682712088"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712088"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_src :: Unfolding -&gt; UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712089"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682712089"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: Unfolding -&gt; CoreExpr
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712090"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682712090"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3989"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682712089"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712088"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; JoinArity
</span><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-var">joinRhsArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682712090"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3990"></span><span>    </span><span class="annot"><a href="#local-6989586621682712078"><span class="hs-identifier hs-var">ok_unfolding</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DFunUnfolding"><span class="hs-identifier hs-type">DFunUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3991"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3992"></span><span>    </span><span class="annot"><a href="#local-6989586621682712078"><span class="hs-identifier hs-var">ok_unfolding</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-3993"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3994"></span><span>
</span><span id="line-3995"></span><span>    </span><span id="local-6989586621682712074"><span class="annot"><span class="annottext">lost_join_doc :: SDoc
</span><a href="#local-6989586621682712074"><span class="hs-identifier hs-var hs-var">lost_join_doc</span></a></span></span><span>
</span><span id="line-3996"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bndr:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3997"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712071"><span class="hs-identifier hs-var">tail_call_info</span></a></span><span>
</span><span id="line-3998"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rules:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3999"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712071"><span class="hs-identifier hs-var">tail_call_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4000"></span><span>                 </span><span class="annot"><a href="GHC.Types.Basic.html#AlwaysTailCalled"><span class="hs-identifier hs-type">AlwaysTailCalled</span></a></span><span> </span><span id="local-6989586621682712092"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712092"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-4001"></span><span>                    </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ok_unf:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; Unfolding -&gt; Bool
</span><a href="#local-6989586621682712078"><span class="hs-identifier hs-var">ok_unfolding</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712092"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4002"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ok_type:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JoinArity -&gt; Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isValidJoinPointType"><span class="hs-identifier hs-var">isValidJoinPointType</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712092"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682712070"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-4003"></span><span>                 </span><span class="annot"><span class="annottext">TailCallInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-4004"></span><span>
</span><span id="line-4005"></span><span class="hs-comment">{- Note [Join points and INLINE pragmas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f x = let g = \x. not  -- Arity 1
             {-# INLINE g #-}
         in case x of
              A -&gt; g True True
              B -&gt; g True False
              C -&gt; blah2

Here 'g' is always tail-called applied to 2 args, but the stable
unfolding captured by the INLINE pragma has arity 1.  If we try to
convert g to be a join point, its unfolding will still have arity 1
(since it is stable, and we don't meddle with stable unfoldings), and
Lint will complain (see Note [Invariants on join points], (2a), in
GHC.Core.  #13413.

Moreover, since g is going to be inlined anyway, there is no benefit
from making it a join point.

If it is recursive, and uselessly marked INLINE, this will stop us
making it a join point, which is annoying.  But occasionally
(notably in class methods; see Note [Instances and loop breakers] in
GHC.Tc.TyCl.Instance) we mark recursive things as INLINE but the recursion
unravels; so ignoring INLINE pragmas on recursive things isn't good
either.

See Invariant 2a of Note [Invariants on join points] in GHC.Core


************************************************************************
*                                                                      *
\subsection{Operations over OccInfo}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-4041"></span><span>
</span><span id="line-4042"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markNonTail"><span class="hs-identifier hs-type">markNonTail</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a></span><span>
</span><span id="line-4043"></span><span id="markNonTail"><span class="annot"><span class="annottext">markNonTail :: OccInfo -&gt; OccInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#markNonTail"><span class="hs-identifier hs-var hs-var">markNonTail</span></a></span></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a></span><span>
</span><span id="line-4044"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#markNonTail"><span class="hs-identifier hs-var">markNonTail</span></a></span><span> </span><span id="local-6989586621682712094"><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712094"><span class="hs-identifier hs-var">occ</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="#local-6989586621682712094"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#occ_tail"><span class="hs-identifier hs-var">occ_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#NoTailCallInfo"><span class="hs-identifier hs-type">NoTailCallInfo</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4045"></span><span>
</span><span id="line-4046"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#andLocalOcc"><span class="hs-identifier hs-type">andLocalOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span>
</span><span id="line-4047"></span><span id="andLocalOcc"><span class="annot"><span class="annottext">andLocalOcc :: LocalOcc -&gt; LocalOcc -&gt; LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#andLocalOcc"><span class="hs-identifier hs-var hs-var">andLocalOcc</span></a></span></span><span> </span><span id="local-6989586621682712095"><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682712095"><span class="hs-identifier hs-var">occ1</span></a></span></span><span> </span><span id="local-6989586621682712096"><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682712096"><span class="hs-identifier hs-var">occ2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo -&gt; LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#ManyOccL"><span class="hs-identifier hs-var">ManyOccL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712097"><span class="hs-identifier hs-var">tci1</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo -&gt; TailCallInfo -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#andTailCallInfo"><span class="hs-operator hs-var">`andTailCallInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712099"><span class="hs-identifier hs-var">tci2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4048"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4049"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682712097"><span class="annot"><span class="annottext">tci1 :: TailCallInfo
</span><a href="#local-6989586621682712097"><span class="hs-identifier hs-var hs-var">tci1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#localTailCallInfo"><span class="hs-identifier hs-var">localTailCallInfo</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682712095"><span class="hs-identifier hs-var">occ1</span></a></span><span>
</span><span id="line-4050"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682712099"><span class="annot"><span class="annottext">tci2 :: TailCallInfo
</span><a href="#local-6989586621682712099"><span class="hs-identifier hs-var hs-var">tci2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#localTailCallInfo"><span class="hs-identifier hs-var">localTailCallInfo</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682712096"><span class="hs-identifier hs-var">occ2</span></a></span><span>
</span><span id="line-4051"></span><span>
</span><span id="line-4052"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#orLocalOcc"><span class="hs-identifier hs-type">orLocalOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#LocalOcc"><span class="hs-identifier hs-type">LocalOcc</span></a></span><span>
</span><span id="line-4053"></span><span class="hs-comment">-- (orLocalOcc occ1 occ2) is used</span><span>
</span><span id="line-4054"></span><span class="hs-comment">-- when combining occurrence info from branches of a case</span><span>
</span><span id="line-4055"></span><span id="orLocalOcc"><span class="annot"><span class="annottext">orLocalOcc :: LocalOcc -&gt; LocalOcc -&gt; LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#orLocalOcc"><span class="hs-identifier hs-var hs-var">orLocalOcc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneOccL"><span class="hs-identifier hs-type">OneOccL</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lo_n_br :: LocalOcc -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_n_br"><span class="hs-identifier hs-var">lo_n_br</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712100"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712100"><span class="hs-identifier hs-var">nbr1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_int_cxt :: LocalOcc -&gt; InterestingCxt
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_int_cxt"><span class="hs-identifier hs-var">lo_int_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712101"><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682712101"><span class="hs-identifier hs-var">int_cxt1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_tail :: LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_tail"><span class="hs-identifier hs-var">lo_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712102"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712102"><span class="hs-identifier hs-var">tci1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-4056"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneOccL"><span class="hs-identifier hs-type">OneOccL</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lo_n_br :: LocalOcc -&gt; JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_n_br"><span class="hs-identifier hs-var">lo_n_br</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712103"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712103"><span class="hs-identifier hs-var">nbr2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_int_cxt :: LocalOcc -&gt; InterestingCxt
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_int_cxt"><span class="hs-identifier hs-var">lo_int_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712104"><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682712104"><span class="hs-identifier hs-var">int_cxt2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_tail :: LocalOcc -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_tail"><span class="hs-identifier hs-var">lo_tail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682712105"><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712105"><span class="hs-identifier hs-var">tci2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-4057"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#OneOccL"><span class="hs-identifier hs-type">OneOccL</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lo_n_br :: JoinArity
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_n_br"><span class="hs-identifier hs-var">lo_n_br</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712100"><span class="hs-identifier hs-var">nbr1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; JoinArity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712103"><span class="hs-identifier hs-var">nbr2</span></a></span><span>
</span><span id="line-4058"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_int_cxt :: InterestingCxt
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_int_cxt"><span class="hs-identifier hs-var">lo_int_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682712101"><span class="hs-identifier hs-var">int_cxt1</span></a></span><span> </span><span class="annot"><span class="annottext">InterestingCxt -&gt; InterestingCxt -&gt; InterestingCxt
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mappend`</span></span><span> </span><span class="annot"><span class="annottext">InterestingCxt
</span><a href="#local-6989586621682712104"><span class="hs-identifier hs-var">int_cxt2</span></a></span><span>
</span><span id="line-4059"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lo_tail :: TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#lo_tail"><span class="hs-identifier hs-var">lo_tail</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712102"><span class="hs-identifier hs-var">tci1</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo -&gt; TailCallInfo -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#andTailCallInfo"><span class="hs-operator hs-var">`andTailCallInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712105"><span class="hs-identifier hs-var">tci2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4060"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#orLocalOcc"><span class="hs-identifier hs-var">orLocalOcc</span></a></span><span> </span><span id="local-6989586621682712106"><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682712106"><span class="hs-identifier hs-var">occ1</span></a></span></span><span> </span><span id="local-6989586621682712107"><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682712107"><span class="hs-identifier hs-var">occ2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalOcc -&gt; LocalOcc -&gt; LocalOcc
</span><a href="GHC.Core.Opt.OccurAnal.html#andLocalOcc"><span class="hs-identifier hs-var">andLocalOcc</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682712106"><span class="hs-identifier hs-var">occ1</span></a></span><span> </span><span class="annot"><span class="annottext">LocalOcc
</span><a href="#local-6989586621682712107"><span class="hs-identifier hs-var">occ2</span></a></span><span>
</span><span id="line-4061"></span><span>
</span><span id="line-4062"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#andTailCallInfo"><span class="hs-identifier hs-type">andTailCallInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a></span><span>
</span><span id="line-4063"></span><span id="andTailCallInfo"><span class="annot"><span class="annottext">andTailCallInfo :: TailCallInfo -&gt; TailCallInfo -&gt; TailCallInfo
</span><a href="GHC.Core.Opt.OccurAnal.html#andTailCallInfo"><span class="hs-identifier hs-var hs-var">andTailCallInfo</span></a></span></span><span> </span><span id="local-6989586621682712108"><span class="annot"><span class="annottext">info :: TailCallInfo
</span><a href="#local-6989586621682712108"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#AlwaysTailCalled"><span class="hs-identifier hs-type">AlwaysTailCalled</span></a></span><span> </span><span id="local-6989586621682712109"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712109"><span class="hs-identifier hs-var">arity1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#AlwaysTailCalled"><span class="hs-identifier hs-type">AlwaysTailCalled</span></a></span><span> </span><span id="local-6989586621682712110"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712110"><span class="hs-identifier hs-var">arity2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-4064"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712109"><span class="hs-identifier hs-var">arity1</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; JoinArity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621682712110"><span class="hs-identifier hs-var">arity2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="#local-6989586621682712108"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-4065"></span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#andTailCallInfo"><span class="hs-identifier hs-var">andTailCallInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TailCallInfo
</span><a href="GHC.Types.Basic.html#NoTailCallInfo"><span class="hs-identifier hs-var">NoTailCallInfo</span></a></span><span>
</span><span id="line-4066"></span></pre></body></html>