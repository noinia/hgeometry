<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds                  #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE Rank2Types                 #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies               #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts           #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TupleSections              #-}</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- Copyright (c) 2018 Andreas Klebinger</span><span>
</span><span id="line-10"></span><span class="hs-comment">--</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html"><span class="hs-identifier">GHC.CmmToAsm.CFG</span></a></span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier">CFG</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier">CfgEdge</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier">EdgeInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier">EdgeWeight</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#TransitionSource"><span class="hs-identifier">TransitionSource</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-comment">--Modify the CFG</span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#addWeightEdge"><span class="hs-identifier">addWeightEdge</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier">addEdge</span></a></span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#delEdge"><span class="hs-identifier">delEdge</span></a></span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#addNodesBetween"><span class="hs-identifier">addNodesBetween</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#shortcutWeightMap"><span class="hs-identifier">shortcutWeightMap</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#reverseEdges"><span class="hs-identifier">reverseEdges</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#filterEdges"><span class="hs-identifier">filterEdges</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#addImmediateSuccessor"><span class="hs-identifier">addImmediateSuccessor</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#mkWeightInfo"><span class="hs-identifier">mkWeightInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#adjustEdgeWeight"><span class="hs-identifier">adjustEdgeWeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#setEdgeWeight"><span class="hs-identifier">setEdgeWeight</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-comment">--Query the CFG</span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#infoEdgeList"><span class="hs-identifier">infoEdgeList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#edgeList"><span class="hs-identifier">edgeList</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getSuccessorEdges"><span class="hs-identifier">getSuccessorEdges</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getSuccessors"><span class="hs-identifier">getSuccessors</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getSuccEdgesSorted"><span class="hs-identifier">getSuccEdgesSorted</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getEdgeInfo"><span class="hs-identifier">getEdgeInfo</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getCfgNodes"><span class="hs-identifier">getCfgNodes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#hasNode"><span class="hs-identifier">hasNode</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-comment">-- Loop Information</span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#loopMembers"><span class="hs-identifier">loopMembers</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#loopLevels"><span class="hs-identifier">loopLevels</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#loopInfo"><span class="hs-identifier">loopInfo</span></a></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-comment">--Construction/Misc</span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getCfg"><span class="hs-identifier">getCfg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getCfgProc"><span class="hs-identifier">getCfgProc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#pprEdgeWeights"><span class="hs-identifier">pprEdgeWeights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#sanityCheckCfg"><span class="hs-identifier">sanityCheckCfg</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-comment">--Find backedges and update their weight</span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#optimizeCFG"><span class="hs-identifier">optimizeCFG</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#mkGlobalWeights"><span class="hs-identifier">mkGlobalWeights</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Platform.html"><span class="hs-identifier">GHC.Platform</span></a></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html"><span class="hs-identifier">GHC.Cmm.BlockId</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Cmm.html"><span class="hs-identifier">GHC.Cmm</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cmm</span></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Cmm.Switch.html"><span class="hs-identifier">GHC.Cmm.Switch</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html"><span class="hs-identifier">GHC.Cmm.Dataflow.Label</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html"><span class="hs-identifier">GHC.Cmm.Dataflow.Block</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Graph.html"><span class="hs-identifier">GHC.Cmm.Dataflow.Graph</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html"><span class="hs-identifier">GHC.Data.Graph.Directed</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.Dominators.html"><span class="hs-identifier">GHC.CmmToAsm.CFG.Dominators</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Dom</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.Weight.html"><span class="hs-identifier">GHC.CmmToAsm.CFG.Weight</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Word64Map.Strict.html"><span class="hs-identifier">GHC.Data.Word64Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Word64Map.Internal.html#Word64Map"><span class="hs-identifier">Word64Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Word64Set.html"><span class="hs-identifier">GHC.Data.Word64Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Word64Set.Internal.html#Word64Set"><span class="hs-identifier">Word64Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Strict.html"><span class="hs-identifier">Data.IntMap.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier">IntMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntSet.html"><span class="hs-identifier">Data.IntSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntSet.Internal.html#IntSet"><span class="hs-identifier">IntSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Strict.html"><span class="hs-identifier">Data.IntMap.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IM</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Data.Word64Map.Strict.html"><span class="hs-identifier">GHC.Data.Word64Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WM</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntSet.html"><span class="hs-identifier">Data.IntSet</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IS</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Data.Word64Set.html"><span class="hs-identifier">GHC.Data.Word64Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WS</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Tree.html"><span class="hs-identifier">Data.Tree</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Bifunctor.html"><span class="hs-identifier">Data.Bifunctor</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-78"></span><span class="hs-comment">-- DEBUGGING ONLY</span><span>
</span><span id="line-79"></span><span class="hs-comment">--import GHC.Cmm.DebugBlock</span><span>
</span><span id="line-80"></span><span class="hs-comment">--import GHC.Data.OrdList</span><span>
</span><span id="line-81"></span><span class="hs-comment">--import GHC.Cmm.DebugBlock.Trace</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">sort</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nub</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">partition</span></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.STRef.Strict.html"><span class="hs-identifier">Data.STRef.Strict</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.ST.html"><span class="hs-identifier">Control.Monad.ST</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.MArray.html"><span class="hs-identifier">Data.Array.MArray</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.ST.html"><span class="hs-identifier">Data.Array.ST</span></a></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.IArray.html"><span class="hs-identifier">Data.Array.IArray</span></a></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.Unsafe.html"><span class="hs-identifier">Data.Array.Unsafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeFreeze"><span class="hs-identifier">unsafeFreeze</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html"><span class="hs-identifier">Data.Array.Base</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeRead"><span class="hs-identifier">unsafeRead</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeWrite"><span class="hs-identifier">unsafeWrite</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.UnionFind.html"><span class="hs-identifier">GHC.Data.UnionFind</span></a></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-keyword">type</span><span> </span><span id="Prob"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Prob"><span class="hs-identifier hs-var">Prob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-keyword">type</span><span> </span><span id="Edge"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-var">Edge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">type</span><span> </span><span id="Edges"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="hs-keyword">newtype</span><span> </span><span id="EdgeWeight"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-var">EdgeWeight</span></a></span></span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EdgeWeight"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-var">EdgeWeight</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="weightToDouble"><span class="annot"><span class="annottext">EdgeWeight -&gt; Double
</span><a href="GHC.CmmToAsm.CFG.html#weightToDouble"><span class="hs-identifier hs-var hs-var">weightToDouble</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682819602"><span id="local-6989586621682819606"><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
(EdgeWeight -&gt; EdgeWeight -&gt; Bool)
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; Bool) -&gt; Eq EdgeWeight
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
== :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
$c/= :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
/= :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span id="local-6989586621682819614"><span id="local-6989586621682819618"><span id="local-6989586621682819622"><span id="local-6989586621682819626"><span id="local-6989586621682819630"><span id="local-6989586621682819634"><span id="local-6989586621682819638"><span class="annot"><span class="annottext">Eq EdgeWeight
Eq EdgeWeight =&gt;
(EdgeWeight -&gt; EdgeWeight -&gt; Ordering)
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; Bool)
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; Bool)
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; Bool)
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; Bool)
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight)
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight)
-&gt; Ord EdgeWeight
EdgeWeight -&gt; EdgeWeight -&gt; Bool
EdgeWeight -&gt; EdgeWeight -&gt; Ordering
EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: EdgeWeight -&gt; EdgeWeight -&gt; Ordering
compare :: EdgeWeight -&gt; EdgeWeight -&gt; Ordering
$c&lt; :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
&lt; :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
$c&lt;= :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
&lt;= :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
$c&gt; :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
&gt; :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
$c&gt;= :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
&gt;= :: EdgeWeight -&gt; EdgeWeight -&gt; Bool
$cmax :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
max :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
$cmin :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
min :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span id="local-6989586621682819649"><span id="local-6989586621682819654"><span id="local-6989586621682819658"><span id="local-6989586621682819662"><span id="local-6989586621682819666"><span id="local-6989586621682819670"><span id="local-6989586621682819674"><span id="local-6989586621682819678"><span class="annot"><span class="annottext">Int -&gt; EdgeWeight
EdgeWeight -&gt; Int
EdgeWeight -&gt; [EdgeWeight]
EdgeWeight -&gt; EdgeWeight
EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight]
EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight]
(EdgeWeight -&gt; EdgeWeight)
-&gt; (EdgeWeight -&gt; EdgeWeight)
-&gt; (Int -&gt; EdgeWeight)
-&gt; (EdgeWeight -&gt; Int)
-&gt; (EdgeWeight -&gt; [EdgeWeight])
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight])
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight])
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight])
-&gt; Enum EdgeWeight
forall a.
(a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (Int -&gt; a)
-&gt; (a -&gt; Int)
-&gt; (a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; a -&gt; [a])
-&gt; Enum a
$csucc :: EdgeWeight -&gt; EdgeWeight
succ :: EdgeWeight -&gt; EdgeWeight
$cpred :: EdgeWeight -&gt; EdgeWeight
pred :: EdgeWeight -&gt; EdgeWeight
$ctoEnum :: Int -&gt; EdgeWeight
toEnum :: Int -&gt; EdgeWeight
$cfromEnum :: EdgeWeight -&gt; Int
fromEnum :: EdgeWeight -&gt; Int
$cenumFrom :: EdgeWeight -&gt; [EdgeWeight]
enumFrom :: EdgeWeight -&gt; [EdgeWeight]
$cenumFromThen :: EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight]
enumFromThen :: EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight]
$cenumFromTo :: EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight]
enumFromTo :: EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight]
$cenumFromThenTo :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight]
enumFromThenTo :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight -&gt; [EdgeWeight]
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Enum</span></span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span id="local-6989586621682819688"><span id="local-6989586621682819692"><span id="local-6989586621682819696"><span id="local-6989586621682819700"><span id="local-6989586621682819704"><span id="local-6989586621682819708"><span id="local-6989586621682819712"><span class="annot"><span class="annottext">Integer -&gt; EdgeWeight
EdgeWeight -&gt; EdgeWeight
EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
(EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight)
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight)
-&gt; (EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight)
-&gt; (EdgeWeight -&gt; EdgeWeight)
-&gt; (EdgeWeight -&gt; EdgeWeight)
-&gt; (EdgeWeight -&gt; EdgeWeight)
-&gt; (Integer -&gt; EdgeWeight)
-&gt; Num EdgeWeight
forall a.
(a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (Integer -&gt; a)
-&gt; Num a
$c+ :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
+ :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
$c- :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
- :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
$c* :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
* :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
$cnegate :: EdgeWeight -&gt; EdgeWeight
negate :: EdgeWeight -&gt; EdgeWeight
$cabs :: EdgeWeight -&gt; EdgeWeight
abs :: EdgeWeight -&gt; EdgeWeight
$csignum :: EdgeWeight -&gt; EdgeWeight
signum :: EdgeWeight -&gt; EdgeWeight
$cfromInteger :: Integer -&gt; EdgeWeight
fromInteger :: Integer -&gt; EdgeWeight
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Num</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span id="local-6989586621682819725"><span class="annot"><span class="annottext">Num EdgeWeight
Ord EdgeWeight
(Num EdgeWeight, Ord EdgeWeight) =&gt;
(EdgeWeight -&gt; Rational) -&gt; Real EdgeWeight
EdgeWeight -&gt; Rational
forall a. (Num a, Ord a) =&gt; (a -&gt; Rational) -&gt; Real a
$ctoRational :: EdgeWeight -&gt; Rational
toRational :: EdgeWeight -&gt; Rational
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Real</span></span></span><span class="hs-special">,</span><span id="local-6989586621682819734"><span id="local-6989586621682819738"><span id="local-6989586621682819742"><span class="annot"><span class="annottext">Num EdgeWeight
Num EdgeWeight =&gt;
(EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight)
-&gt; (EdgeWeight -&gt; EdgeWeight)
-&gt; (Rational -&gt; EdgeWeight)
-&gt; Fractional EdgeWeight
Rational -&gt; EdgeWeight
EdgeWeight -&gt; EdgeWeight
EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a.
Num a =&gt;
(a -&gt; a -&gt; a) -&gt; (a -&gt; a) -&gt; (Rational -&gt; a) -&gt; Fractional a
$c/ :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
/ :: EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
$crecip :: EdgeWeight -&gt; EdgeWeight
recip :: EdgeWeight -&gt; EdgeWeight
$cfromRational :: Rational -&gt; EdgeWeight
fromRational :: Rational -&gt; EdgeWeight
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Fractional</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621682819751"><span class="annot"><span class="annottext">ppr :: EdgeWeight -&gt; SDoc
</span><a href="#local-6989586621682819751"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span> </span><span id="local-6989586621682819753"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682819753"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#doublePrec"><span class="hs-identifier hs-var">doublePrec</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682819753"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-keyword">type</span><span> </span><span id="EdgeInfoMap"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfoMap"><span class="hs-identifier hs-var">EdgeInfoMap</span></a></span></span><span> </span><span id="local-6989586621682819756"><span class="annot"><a href="#local-6989586621682819756"><span class="hs-identifier hs-type">edgeInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819756"><span class="hs-identifier hs-type">edgeInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | A control flow graph where edges have been annotated with a weight.</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- Implemented as IntMap (IntMap \&lt;edgeData&gt;)</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- We must uphold the invariant that for each edge A -&gt; B we must have:</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- A entry B in the outer map.</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- A entry B in the map we get when looking up A.</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- Maintaining this invariant is useful as any failed lookup now indicates</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- an actual error in code which might go unnoticed for a while</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- otherwise.</span><span>
</span><span id="line-119"></span><span class="hs-keyword">type</span><span> </span><span id="CFG"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-var">CFG</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfoMap"><span class="hs-identifier hs-type">EdgeInfoMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-keyword">data</span><span> </span><span id="CfgEdge"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a></span></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CfgEdge"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a></span></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="edgeFrom"><span class="annot"><span class="annottext">CfgEdge -&gt; Label
</span><a href="GHC.CmmToAsm.CFG.html#edgeFrom"><span class="hs-identifier hs-var hs-var">edgeFrom</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="edgeTo"><span class="annot"><span class="annottext">CfgEdge -&gt; Label
</span><a href="GHC.CmmToAsm.CFG.html#edgeTo"><span class="hs-identifier hs-var hs-var">edgeTo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="edgeInfo"><span class="annot"><span class="annottext">CfgEdge -&gt; EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#edgeInfo"><span class="hs-identifier hs-var hs-var">edgeInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-comment">-- | Careful! Since we assume there is at most one edge from A to B</span><span>
</span><span id="line-129"></span><span class="hs-comment">--   the Eq instance does not consider weight.</span><span>
</span><span id="line-130"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682819763"><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-131"></span><span>  </span><span id="local-6989586621682819769"><span class="annot"><span class="annottext">== :: CfgEdge -&gt; CfgEdge -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var">(==)</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span> </span><span id="local-6989586621682819770"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819770"><span class="hs-identifier hs-var">from1</span></a></span></span><span> </span><span id="local-6989586621682819771"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819771"><span class="hs-identifier hs-var">to1</span></a></span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span> </span><span id="local-6989586621682819772"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819772"><span class="hs-identifier hs-var">from2</span></a></span></span><span> </span><span id="local-6989586621682819773"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819773"><span class="hs-identifier hs-var">to2</span></a></span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819770"><span class="hs-identifier hs-var">from1</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819772"><span class="hs-identifier hs-var">from2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819771"><span class="hs-identifier hs-var">to1</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819773"><span class="hs-identifier hs-var">to2</span></a></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="annot"><span class="hs-comment">-- | Edges are sorted ascending pointwise by weight, source and destination</span></span><span>
</span><span id="line-135"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682819779"><span id="local-6989586621682819782"><span id="local-6989586621682819785"><span id="local-6989586621682819788"><span id="local-6989586621682819791"><span id="local-6989586621682819794"><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-136"></span><span>  </span><span id="local-6989586621682819805"><span class="annot"><span class="annottext">compare :: CfgEdge -&gt; CfgEdge -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var">compare</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span> </span><span id="local-6989586621682819806"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819806"><span class="hs-identifier hs-var">from1</span></a></span></span><span> </span><span id="local-6989586621682819807"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819807"><span class="hs-identifier hs-var">to1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">edgeWeight :: EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682819810"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819810"><span class="hs-identifier hs-var">weight1</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span> </span><span id="local-6989586621682819811"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819811"><span class="hs-identifier hs-var">from2</span></a></span></span><span> </span><span id="local-6989586621682819812"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819812"><span class="hs-identifier hs-var">to2</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">edgeWeight :: EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682819813"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819813"><span class="hs-identifier hs-var">weight2</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819810"><span class="hs-identifier hs-var">weight1</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819813"><span class="hs-identifier hs-var">weight2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819810"><span class="hs-identifier hs-var">weight1</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819813"><span class="hs-identifier hs-var">weight2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819806"><span class="hs-identifier hs-var">from1</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819811"><span class="hs-identifier hs-var">from2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-139"></span><span>      </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819810"><span class="hs-identifier hs-var">weight1</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819813"><span class="hs-identifier hs-var">weight2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819806"><span class="hs-identifier hs-var">from1</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819811"><span class="hs-identifier hs-var">from2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819807"><span class="hs-identifier hs-var">to1</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819812"><span class="hs-identifier hs-var">to2</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">LT</span></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819806"><span class="hs-identifier hs-var">from1</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819811"><span class="hs-identifier hs-var">from2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819807"><span class="hs-identifier hs-var">to1</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819812"><span class="hs-identifier hs-var">to2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819810"><span class="hs-identifier hs-var">weight1</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819813"><span class="hs-identifier hs-var">weight2</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">EQ</span></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621682819828"><span class="annot"><span class="annottext">ppr :: CfgEdge -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span> </span><span id="local-6989586621682819829"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819829"><span class="hs-identifier hs-var">from1</span></a></span></span><span> </span><span id="local-6989586621682819830"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819830"><span class="hs-identifier hs-var">to1</span></a></span></span><span> </span><span id="local-6989586621682819831"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819831"><span class="hs-identifier hs-var">edgeInfo</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819829"><span class="hs-identifier hs-var">from1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-(&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819831"><span class="hs-identifier hs-var">edgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)-&gt;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819830"><span class="hs-identifier hs-var">to1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="hs-comment">-- | Can we trace back a edge to a specific Cmm Node</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- or has it been introduced during assembly codegen. We use this to maintain</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- some information which would otherwise be lost during the</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- Cmm \&lt;-&gt; asm transition.</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- See also Note [Inverting conditions]</span><span>
</span><span id="line-155"></span><span class="hs-keyword">data</span><span> </span><span id="TransitionSource"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#TransitionSource"><span class="hs-identifier hs-var">TransitionSource</span></a></span></span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CmmSource"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CmmSource"><span class="hs-identifier hs-var">CmmSource</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="trans_cmmNode"><span class="annot"><span class="annottext">TransitionSource -&gt; CmmNode O C
</span><a href="GHC.CmmToAsm.CFG.html#trans_cmmNode"><span class="hs-identifier hs-var hs-var">trans_cmmNode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Node.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#O"><span class="hs-identifier hs-type">O</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#C"><span class="hs-identifier hs-type">C</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="trans_info"><span class="annot"><span class="annottext">TransitionSource -&gt; BranchInfo
</span><a href="GHC.CmmToAsm.CFG.html#trans_info"><span class="hs-identifier hs-var hs-var">trans_info</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BranchInfo"><span class="hs-identifier hs-type">BranchInfo</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AsmCodeGen"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#AsmCodeGen"><span class="hs-identifier hs-var">AsmCodeGen</span></a></span></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682819841"><span id="local-6989586621682819850"><span class="annot"><span class="annottext">TransitionSource -&gt; TransitionSource -&gt; Bool
(TransitionSource -&gt; TransitionSource -&gt; Bool)
-&gt; (TransitionSource -&gt; TransitionSource -&gt; Bool)
-&gt; Eq TransitionSource
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: TransitionSource -&gt; TransitionSource -&gt; Bool
== :: TransitionSource -&gt; TransitionSource -&gt; Bool
$c/= :: TransitionSource -&gt; TransitionSource -&gt; Bool
/= :: TransitionSource -&gt; TransitionSource -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-keyword">data</span><span> </span><span id="BranchInfo"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BranchInfo"><span class="hs-identifier hs-var">BranchInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NoInfo"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#NoInfo"><span class="hs-identifier hs-var">NoInfo</span></a></span></span><span>         </span><span class="annot"><span class="hs-comment">-- ^ Unknown, but not heap or stack check.</span></span><span>
</span><span id="line-162"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span id="HeapStackCheck"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#HeapStackCheck"><span class="hs-identifier hs-var">HeapStackCheck</span></a></span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Heap or stack check</span></span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621682819856"><span id="local-6989586621682819860"><span class="annot"><span class="annottext">BranchInfo -&gt; BranchInfo -&gt; Bool
(BranchInfo -&gt; BranchInfo -&gt; Bool)
-&gt; (BranchInfo -&gt; BranchInfo -&gt; Bool) -&gt; Eq BranchInfo
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: BranchInfo -&gt; BranchInfo -&gt; Bool
== :: BranchInfo -&gt; BranchInfo -&gt; Bool
$c/= :: BranchInfo -&gt; BranchInfo -&gt; Bool
/= :: BranchInfo -&gt; BranchInfo -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BranchInfo"><span class="hs-identifier hs-type">BranchInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-166"></span><span>    </span><span id="local-6989586621682819866"><span class="annot"><span class="annottext">ppr :: BranchInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">BranchInfo
</span><a href="GHC.CmmToAsm.CFG.html#NoInfo"><span class="hs-identifier hs-var">NoInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;regular&quot;</span></span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">BranchInfo
</span><a href="GHC.CmmToAsm.CFG.html#HeapStackCheck"><span class="hs-identifier hs-var">HeapStackCheck</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;heap/stack&quot;</span></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#isHeapOrStackCheck"><span class="hs-identifier hs-type">isHeapOrStackCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#TransitionSource"><span class="hs-identifier hs-type">TransitionSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-170"></span><span id="isHeapOrStackCheck"><span class="annot"><span class="annottext">isHeapOrStackCheck :: TransitionSource -&gt; Bool
</span><a href="GHC.CmmToAsm.CFG.html#isHeapOrStackCheck"><span class="hs-identifier hs-var hs-var">isHeapOrStackCheck</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CmmSource"><span class="hs-identifier hs-type">CmmSource</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">trans_info :: TransitionSource -&gt; BranchInfo
</span><a href="GHC.CmmToAsm.CFG.html#trans_info"><span class="hs-identifier hs-var">trans_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchInfo
</span><a href="GHC.CmmToAsm.CFG.html#HeapStackCheck"><span class="hs-identifier hs-var">HeapStackCheck</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-171"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#isHeapOrStackCheck"><span class="hs-identifier hs-var">isHeapOrStackCheck</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionSource
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="annot"><span class="hs-comment">-- | Information about edges</span></span><span>
</span><span id="line-174"></span><span class="hs-keyword">data</span><span> </span><span id="EdgeInfo"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a></span></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EdgeInfo"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a></span></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="transitionSource"><span class="annot"><span class="annottext">EdgeInfo -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#transitionSource"><span class="hs-identifier hs-var hs-var">transitionSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#TransitionSource"><span class="hs-identifier hs-type">TransitionSource</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="edgeWeight"><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var hs-var">edgeWeight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682819870"><span id="local-6989586621682819874"><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeInfo -&gt; Bool
(EdgeInfo -&gt; EdgeInfo -&gt; Bool)
-&gt; (EdgeInfo -&gt; EdgeInfo -&gt; Bool) -&gt; Eq EdgeInfo
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: EdgeInfo -&gt; EdgeInfo -&gt; Bool
== :: EdgeInfo -&gt; EdgeInfo -&gt; Bool
$c/= :: EdgeInfo -&gt; EdgeInfo -&gt; Bool
/= :: EdgeInfo -&gt; EdgeInfo -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-181"></span><span>  </span><span id="local-6989586621682819881"><span class="annot"><span class="annottext">ppr :: EdgeInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span id="local-6989586621682819882"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819882"><span class="hs-identifier hs-var">edgeInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;weight:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819882"><span class="hs-identifier hs-var">edgeInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span class="hs-comment">-- | Convenience function, generate edge info based</span><span>
</span><span id="line-184"></span><span class="hs-comment">--   on weight not originating from cmm.</span><span>
</span><span id="line-185"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#mkWeightInfo"><span class="hs-identifier hs-type">mkWeightInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span>
</span><span id="line-186"></span><span id="mkWeightInfo"><span class="annot"><span class="annottext">mkWeightInfo :: EdgeWeight -&gt; EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#mkWeightInfo"><span class="hs-identifier hs-var hs-var">mkWeightInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransitionSource -&gt; EdgeWeight -&gt; EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#AsmCodeGen"><span class="hs-identifier hs-var">AsmCodeGen</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-comment">-- | Adjust the weight between the blocks using the given function.</span><span>
</span><span id="line-189"></span><span class="hs-comment">--   If there is no such edge returns the original map.</span><span>
</span><span id="line-190"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#adjustEdgeWeight"><span class="hs-identifier hs-type">adjustEdgeWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-192"></span><span id="adjustEdgeWeight"><span class="annot"><span class="annottext">adjustEdgeWeight :: CFG -&gt; (EdgeWeight -&gt; EdgeWeight) -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#adjustEdgeWeight"><span class="hs-identifier hs-var hs-var">adjustEdgeWeight</span></a></span></span><span> </span><span id="local-6989586621682819883"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819883"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682819884"><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682819884"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682819885"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819885"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682819886"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819886"><span class="hs-identifier hs-var">to</span></a></span></span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682819887"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819887"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; CFG -&gt; Maybe EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819885"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819886"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819883"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682819888"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819888"><span class="hs-identifier hs-var">weight</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819887"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682819889"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819889"><span class="hs-identifier hs-var">newWeight</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682819884"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819888"><span class="hs-identifier hs-var">weight</span></a></span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819885"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819886"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819887"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682819889"><span class="hs-identifier hs-type">newWeight</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819883"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819883"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="hs-comment">-- | Set the weight between the blocks to the given weight.</span><span>
</span><span id="line-200"></span><span class="hs-comment">--   If there is no such edge returns the original map.</span><span>
</span><span id="line-201"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#setEdgeWeight"><span class="hs-identifier hs-type">setEdgeWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span>
</span><span id="line-202"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-203"></span><span id="setEdgeWeight"><span class="annot"><span class="annottext">setEdgeWeight :: CFG -&gt; EdgeWeight -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#setEdgeWeight"><span class="hs-identifier hs-var hs-var">setEdgeWeight</span></a></span></span><span> </span><span id="local-6989586621682819890"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819890"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682819891"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819891"><span class="hs-identifier hs-var">weight</span></a></span></span><span> </span><span id="local-6989586621682819892"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819892"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682819893"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819893"><span class="hs-identifier hs-var">to</span></a></span></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682819894"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819894"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; CFG -&gt; Maybe EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819892"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819893"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819890"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819892"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819893"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819894"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682819891"><span class="hs-identifier hs-type">weight</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819890"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819890"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getCfgNodes"><span class="hs-identifier hs-type">getCfgNodes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-210"></span><span id="getCfgNodes"><span class="annot"><span class="annottext">getCfgNodes :: CFG -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getCfgNodes"><span class="hs-identifier hs-var hs-var">getCfgNodes</span></a></span></span><span> </span><span id="local-6989586621682819895"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819895"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><span class="annottext">CFG -&gt; [Label]
forall a. LabelMap a -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819895"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="annot"><span class="hs-comment">-- | Is this block part of this graph?</span></span><span>
</span><span id="line-214"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#hasNode"><span class="hs-identifier hs-type">hasNode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-215"></span><span id="hasNode"><span class="annot"><span class="annottext">hasNode :: CFG -&gt; Label -&gt; Bool
</span><a href="GHC.CmmToAsm.CFG.html#hasNode"><span class="hs-identifier hs-var hs-var">hasNode</span></a></span></span><span> </span><span id="local-6989586621682819897"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819897"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682819898"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819898"><span class="hs-identifier hs-var">node</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-comment">-- Check the invariant that each node must exist in the first map or not at all.</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682819900"><span class="hs-identifier hs-var">found</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; Bool) -&gt; CFG -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; LabelMap EdgeInfo -&gt; Bool
forall a. Label -&gt; LabelMap a -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819898"><span class="hs-identifier hs-var">node</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819897"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682819900"><span class="hs-identifier hs-var">found</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-220"></span><span>      </span><span id="local-6989586621682819900"><span class="annot"><span class="annottext">found :: Bool
</span><a href="#local-6989586621682819900"><span class="hs-identifier hs-var hs-var">found</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; CFG -&gt; Bool
forall a. Label -&gt; LabelMap a -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819898"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819897"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- | Check if the nodes in the cfg and the set of blocks are the same.</span><span>
</span><span id="line-225"></span><span class="hs-comment">--   In a case of a mismatch we panic and show the difference.</span><span>
</span><span id="line-226"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#sanityCheckCfg"><span class="hs-identifier hs-type">sanityCheckCfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-227"></span><span id="sanityCheckCfg"><span class="annot"><span class="annottext">sanityCheckCfg :: CFG -&gt; LabelSet -&gt; SDoc -&gt; Bool
</span><a href="GHC.CmmToAsm.CFG.html#sanityCheckCfg"><span class="hs-identifier hs-var hs-var">sanityCheckCfg</span></a></span></span><span> </span><span id="local-6989586621682819904"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819904"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682819905"><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819905"><span class="hs-identifier hs-var">blockSet</span></a></span></span><span> </span><span id="local-6989586621682819906"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682819906"><span class="hs-identifier hs-var">msg</span></a></span></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819905"><span class="hs-identifier hs-var">blockSet</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; LabelSet -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819907"><span class="hs-identifier hs-var">cfgNodes</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-231"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Block list and cfg nodes don't match&quot;</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-232"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;difference:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819909"><span class="hs-identifier hs-var">diff</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-233"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;blocks:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819905"><span class="hs-identifier hs-var">blockSet</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-234"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cfg:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; SDoc
</span><a href="GHC.CmmToAsm.CFG.html#pprEdgeWeights"><span class="hs-identifier hs-var">pprEdgeWeights</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819904"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-235"></span><span>            </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682819906"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-238"></span><span>      </span><span id="local-6989586621682819907"><span class="annot"><span class="annottext">cfgNodes :: LabelSet
</span><a href="#local-6989586621682819907"><span class="hs-identifier hs-var hs-var">cfgNodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; LabelSet) -&gt; [Label] -&gt; LabelSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819904"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-239"></span><span>      </span><span id="local-6989586621682819909"><span class="annot"><span class="annottext">diff :: LabelSet
</span><a href="#local-6989586621682819909"><span class="hs-identifier hs-var hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelSet -&gt; LabelSet -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setUnion"><span class="hs-identifier hs-var">setUnion</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819907"><span class="hs-identifier hs-var">cfgNodes</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819905"><span class="hs-identifier hs-var">blockSet</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; LabelSet -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setDifference"><span class="hs-operator hs-var">`setDifference`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelSet -&gt; LabelSet -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setIntersection"><span class="hs-identifier hs-var">setIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819907"><span class="hs-identifier hs-var">cfgNodes</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819905"><span class="hs-identifier hs-var">blockSet</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">-- | Filter the CFG with a custom function f.</span><span>
</span><span id="line-242"></span><span class="hs-comment">--   Parameters are `f from to edgeInfo`</span><span>
</span><span id="line-243"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#filterEdges"><span class="hs-identifier hs-type">filterEdges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-244"></span><span id="filterEdges"><span class="annot"><span class="annottext">filterEdges :: (Label -&gt; Label -&gt; EdgeInfo -&gt; Bool) -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#filterEdges"><span class="hs-identifier hs-var hs-var">filterEdges</span></a></span></span><span> </span><span id="local-6989586621682819915"><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; Bool
</span><a href="#local-6989586621682819915"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682819916"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819916"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">(Label -&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo) -&gt; CFG -&gt; CFG
forall a v. (Label -&gt; a -&gt; v) -&gt; LabelMap a -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapMapWithKey"><span class="hs-identifier hs-var">mapMapWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo
</span><a href="#local-6989586621682819918"><span class="hs-identifier hs-var">filterSources</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819916"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-247"></span><span>      </span><span id="local-6989586621682819918"><span class="annot"><span class="annottext">filterSources :: Label -&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo
</span><a href="#local-6989586621682819918"><span class="hs-identifier hs-var hs-var">filterSources</span></a></span></span><span> </span><span id="local-6989586621682819919"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819919"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682819920"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682819920"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>        </span><span class="annot"><span class="annottext">(Label -&gt; EdgeInfo -&gt; Bool)
-&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo
forall v. (Label -&gt; v -&gt; Bool) -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFilterWithKey"><span class="hs-identifier hs-var">mapFilterWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682819922"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819922"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682819923"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819923"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; Bool
</span><a href="#local-6989586621682819915"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819919"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819922"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682819923"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682819920"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-comment">{- Note [Updating the CFG during shortcutting]
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See Note [What is shortcutting] in the control flow optimization
code (GHC.Cmm.ContFlowOpt) for a slightly more in depth explanation on shortcutting.

In the native backend we shortcut jumps at the assembly level. (&quot;GHC.CmmToAsm&quot;)
This means we remove blocks containing only one jump from the code
and instead redirecting all jumps targeting this block to the deleted
blocks jump target.

However we want to have an accurate representation of control
flow in the CFG. So we add/remove edges accordingly to account
for the eliminated blocks and new edges.

If we shortcut A -&gt; B -&gt; C to A -&gt; C:
* We delete edges A -&gt; B and B -&gt; C
* Replacing them with the edge A -&gt; C

We also try to preserve jump weights while doing so.

Note that:
* The edge B -&gt; C can't have interesting weights since
  the block B consists of a single unconditional jump without branching.
* We delete the edge A -&gt; B and add the edge A -&gt; C.
* The edge A -&gt; B can be one of many edges originating from A so likely
  has edge weights we want to preserve.

For this reason we simply store the edge info from the original A -&gt; B
edge and apply this information to the new edge A -&gt; C.

Sometimes we have a scenario where jump target C is not represented by an
BlockId but an immediate value. I'm only aware of this happening without
tables next to code currently.

Then we go from A ---&gt; B - -&gt; IMM   to   A - -&gt; IMM where the dashed arrows
are not stored in the CFG.

In that case we simply delete the edge A -&gt; B.

In terms of implementation the native backend first builds a mapping
from blocks suitable for shortcutting to their jump targets.
Then it redirects all jump instructions to these blocks using the
built up mapping.
This function (shortcutWeightMap) takes the same mapping and
applies the mapping to the CFG in the way laid out above.

-}</span><span>
</span><span id="line-298"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#shortcutWeightMap"><span class="hs-identifier hs-type">shortcutWeightMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-299"></span><span id="shortcutWeightMap"><span class="annot"><span class="annottext">shortcutWeightMap :: LabelMap (Maybe Label) -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#shortcutWeightMap"><span class="hs-identifier hs-var hs-var">shortcutWeightMap</span></a></span></span><span> </span><span id="local-6989586621682819924"><span class="annot"><span class="annottext">LabelMap (Maybe Label)
</span><a href="#local-6989586621682819924"><span class="hs-identifier hs-var">cuts</span></a></span></span><span> </span><span id="local-6989586621682819925"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819925"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">LabelMap (Maybe Label) -&gt; Bool
forall a. LabelMap a -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#mapNull"><span class="hs-identifier hs-var">mapNull</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap (Maybe Label)
</span><a href="#local-6989586621682819924"><span class="hs-identifier hs-var">cuts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819925"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819927"><span class="hs-identifier hs-var">normalised_cfg</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-303"></span><span>      </span><span class="hs-comment">-- First take the cuts map and collapse any shortcuts, for example</span><span>
</span><span id="line-304"></span><span>      </span><span class="hs-comment">-- if the cuts map has A -&gt; B and B -&gt; C then we want to rewrite</span><span>
</span><span id="line-305"></span><span>      </span><span class="hs-comment">-- A -&gt; C and B -&gt; C directly.</span><span>
</span><span id="line-306"></span><span>      </span><span class="annot"><a href="#local-6989586621682819928"><span class="hs-identifier hs-type">normalised_cuts_st</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682819067"><span class="annot"><a href="#local-6989586621682819067"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621682819067"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>      </span><span id="local-6989586621682819928"><span class="annot"><span class="annottext">normalised_cuts_st :: forall s. ST s (LabelMap (Maybe Label))
</span><a href="#local-6989586621682819928"><span class="hs-identifier hs-var hs-var">normalised_cuts_st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-308"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682819947"><span class="annot"><a href="#local-6989586621682819947"><span class="hs-identifier hs-var">null</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">Point</span></span><span> </span><span class="annot"><span class="hs-identifier">s</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier">BlockId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Label -&gt; ST s (Point s (Maybe Label))
forall a s. a -&gt; ST s (Point s a)
</span><a href="GHC.Data.UnionFind.html#fresh"><span class="hs-identifier hs-var">fresh</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Label
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682819949"><span class="annot"><a href="#local-6989586621682819949"><span class="hs-identifier hs-var hs-var">cuts_list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap (Maybe Label) -&gt; [(Label, Maybe Label)]
forall b. LabelMap b -&gt; [(Label, b)]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap (Maybe Label)
</span><a href="#local-6989586621682819924"><span class="hs-identifier hs-var">cuts</span></a></span><span>
</span><span id="line-310"></span><span>        </span><span class="hs-comment">-- Create a unification variable for each of the nodes in a rewrite</span><span>
</span><span id="line-311"></span><span>        </span><span id="local-6989586621682819951"><span class="annot"><a href="#local-6989586621682819951"><span class="hs-identifier hs-var">cuts_vars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">traverse</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682819953"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819953"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819953"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point s (Maybe Label) -&gt; (Label, Point s (Maybe Label)))
-&gt; ST s (Point s (Maybe Label))
-&gt; ST s (Label, Point s (Maybe Label))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Label -&gt; ST s (Point s (Maybe Label))
forall a s. a -&gt; ST s (Point s a)
</span><a href="GHC.Data.UnionFind.html#fresh"><span class="hs-identifier hs-var">fresh</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Maybe Label
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819953"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682819956"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819956"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682819957"><span class="annot"><span class="annottext">Maybe Label
</span><a href="#local-6989586621682819957"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819956"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; [Label] -&gt; [Label]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; (Label -&gt; [Label]) -&gt; Maybe Label -&gt; [Label]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; [Label] -&gt; [Label]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Label
</span><a href="#local-6989586621682819957"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682819949"><span class="hs-identifier hs-type">cuts_list</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682819959"><span class="annot"><a href="#local-6989586621682819959"><span class="hs-identifier hs-var hs-var">cuts_map</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, Point s (Maybe Label))]
-&gt; LabelMap (Point s (Maybe Label))
forall v. [(Label, v)] -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, Point s (Maybe Label))]
</span><a href="#local-6989586621682819951"><span class="hs-identifier hs-var">cuts_vars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.UnionFind.html#Point"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819067"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-comment">-- Then unify according to the rewrites in the cuts map</span><span>
</span><span id="line-314"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682819962"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819962"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682819963"><span class="annot"><span class="annottext">Maybe Label
</span><a href="#local-6989586621682819963"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe (Point s (Maybe Label)) -&gt; Point s (Maybe Label)
forall a. HasDebugCallStack =&gt; String -&gt; Maybe a -&gt; a
</span><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shortcutWeightMap&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
-&gt; LabelMap (Point s (Maybe Label))
-&gt; Maybe (Point s (Maybe Label))
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819962"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap (Point s (Maybe Label))
</span><a href="#local-6989586621682819959"><span class="hs-identifier hs-var">cuts_map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>                              </span><span class="annot"><span class="annottext">Point s (Maybe Label) -&gt; Point s (Maybe Label) -&gt; ST s ()
forall s a. Point s a -&gt; Point s a -&gt; ST s ()
</span><a href="GHC.Data.UnionFind.html#union"><span class="hs-operator hs-var">`union`</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe (Point s (Maybe Label)) -&gt; Point s (Maybe Label)
forall a. HasDebugCallStack =&gt; String -&gt; Maybe a -&gt; a
</span><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shortcutWeightMap&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Point s (Maybe Label))
-&gt; (Label -&gt; Maybe (Point s (Maybe Label)))
-&gt; Maybe Label
-&gt; Maybe (Point s (Maybe Label))
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point s (Maybe Label) -&gt; Maybe (Point s (Maybe Label))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Point s (Maybe Label)
</span><a href="#local-6989586621682819947"><span class="hs-identifier hs-var">null</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Label
 -&gt; LabelMap (Point s (Maybe Label))
 -&gt; Maybe (Point s (Maybe Label)))
-&gt; LabelMap (Point s (Maybe Label))
-&gt; Label
-&gt; Maybe (Point s (Maybe Label))
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Label
-&gt; LabelMap (Point s (Maybe Label))
-&gt; Maybe (Point s (Maybe Label))
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap (Point s (Maybe Label))
</span><a href="#local-6989586621682819959"><span class="hs-identifier hs-var">cuts_map</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Label
</span><a href="#local-6989586621682819963"><span class="hs-identifier hs-var">to</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682819949"><span class="hs-identifier hs-type">cuts_list</span></a></span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-comment">-- Then recover the unique representative, which is the result of following</span><span>
</span><span id="line-317"></span><span>        </span><span class="hs-comment">-- the chain to the end.</span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="annot"><a href="GHC.Data.UnionFind.html#find"><span class="hs-identifier hs-type">find</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819959"><span class="hs-identifier hs-type">cuts_map</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>      </span><span id="local-6989586621682819970"><span class="annot"><span class="annottext">normalised_cuts :: LabelMap (Maybe Label)
</span><a href="#local-6989586621682819970"><span class="hs-identifier hs-var hs-var">normalised_cuts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall s. ST s (LabelMap (Maybe Label))) -&gt; LabelMap (Maybe Label)
forall a. (forall s. ST s a) -&gt; a
</span><span class="hs-identifier hs-var">runST</span></span><span> </span><span class="annot"><span class="annottext">ST s (LabelMap (Maybe Label))
forall s. ST s (LabelMap (Maybe Label))
</span><a href="#local-6989586621682819928"><span class="hs-identifier hs-var">normalised_cuts_st</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><a href="#local-6989586621682819972"><span class="hs-identifier hs-type">cuts_domain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-323"></span><span>      </span><span id="local-6989586621682819972"><span class="annot"><span class="annottext">cuts_domain :: LabelSet
</span><a href="#local-6989586621682819972"><span class="hs-identifier hs-var hs-var">cuts_domain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; LabelSet) -&gt; [Label] -&gt; LabelSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LabelMap (Maybe Label) -&gt; [Label]
forall a. LabelMap a -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap (Maybe Label)
</span><a href="#local-6989586621682819924"><span class="hs-identifier hs-var">cuts</span></a></span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span>      </span><span class="hs-comment">-- The CFG is shortcutted using the normalised cuts map</span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><a href="#local-6989586621682819927"><span class="hs-identifier hs-type">normalised_cfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-327"></span><span>      </span><span id="local-6989586621682819927"><span class="annot"><span class="annottext">normalised_cfg :: CFG
</span><a href="#local-6989586621682819927"><span class="hs-identifier hs-var hs-var">normalised_cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; Label -&gt; LabelMap EdgeInfo -&gt; CFG) -&gt; CFG -&gt; CFG -&gt; CFG
forall t b. (t -&gt; Label -&gt; b -&gt; t) -&gt; t -&gt; LabelMap b -&gt; t
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; Label -&gt; LabelMap EdgeInfo -&gt; CFG
</span><a href="#local-6989586621682819974"><span class="hs-identifier hs-var">update_edge</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819925"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><a href="#local-6989586621682819974"><span class="hs-identifier hs-type">update_edge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-330"></span><span>      </span><span id="local-6989586621682819974"><span class="annot"><span class="annottext">update_edge :: CFG -&gt; Label -&gt; LabelMap EdgeInfo -&gt; CFG
</span><a href="#local-6989586621682819974"><span class="hs-identifier hs-var hs-var">update_edge</span></a></span></span><span> </span><span id="local-6989586621682819976"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819976"><span class="hs-identifier hs-var">new_map</span></a></span></span><span> </span><span id="local-6989586621682819977"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819977"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682819978"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682819978"><span class="hs-identifier hs-var">edge_map</span></a></span></span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-comment">-- If the from edge is in the cuts map then delete the edge</span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelSet -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#setMember"><span class="hs-identifier hs-var">setMember</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819977"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682819972"><span class="hs-identifier hs-var">cuts_domain</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819976"><span class="hs-identifier hs-var">new_map</span></a></span><span>
</span><span id="line-333"></span><span>        </span><span class="hs-comment">-- Otherwise we are keeping the edge, but might have shortcutted some of</span><span>
</span><span id="line-334"></span><span>        </span><span class="hs-comment">-- the target nodes.</span><span>
</span><span id="line-335"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap EdgeInfo -&gt; CFG -&gt; CFG
forall v. Label -&gt; v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819977"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; Label -&gt; EdgeInfo -&gt; LabelMap EdgeInfo)
-&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo
forall t b. (t -&gt; Label -&gt; b -&gt; t) -&gt; t -&gt; LabelMap b -&gt; t
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; Label -&gt; EdgeInfo -&gt; LabelMap EdgeInfo
forall a. LabelMap a -&gt; Label -&gt; a -&gt; LabelMap a
</span><a href="#local-6989586621682819981"><span class="hs-identifier hs-var">update_from_edge</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682819978"><span class="hs-identifier hs-var">edge_map</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819976"><span class="hs-identifier hs-var">new_map</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>      </span><span id="local-6989586621682819115"><span class="annot"><a href="#local-6989586621682819981"><span class="hs-identifier hs-type">update_from_edge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819115"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682819115"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819115"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-338"></span><span>      </span><span id="local-6989586621682819981"><span class="annot"><span class="annottext">update_from_edge :: forall a. LabelMap a -&gt; Label -&gt; a -&gt; LabelMap a
</span><a href="#local-6989586621682819981"><span class="hs-identifier hs-var hs-var">update_from_edge</span></a></span></span><span> </span><span id="local-6989586621682819982"><span class="annot"><span class="annottext">LabelMap a
</span><a href="#local-6989586621682819982"><span class="hs-identifier hs-var">new_map</span></a></span></span><span> </span><span id="local-6989586621682819983"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819983"><span class="hs-identifier hs-var">to_edge</span></a></span></span><span> </span><span id="local-6989586621682819984"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682819984"><span class="hs-identifier hs-var">edge_info</span></a></span></span><span>
</span><span id="line-339"></span><span>        </span><span class="hs-comment">-- Edge is in the normalised cuts</span><span>
</span><span id="line-340"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682819985"><span class="annot"><span class="annottext">Maybe Label
</span><a href="#local-6989586621682819985"><span class="hs-identifier hs-var">new_edge</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap (Maybe Label) -&gt; Maybe (Maybe Label)
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819983"><span class="hs-identifier hs-var">to_edge</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap (Maybe Label)
</span><a href="#local-6989586621682819970"><span class="hs-identifier hs-var">normalised_cuts</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-341"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Label
</span><a href="#local-6989586621682819985"><span class="hs-identifier hs-var">new_edge</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-342"></span><span>              </span><span class="hs-comment">-- The result was Nothing, so edge is deleted</span><span>
</span><span id="line-343"></span><span>              </span><span class="annot"><span class="annottext">Maybe Label
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LabelMap a
</span><a href="#local-6989586621682819982"><span class="hs-identifier hs-var">new_map</span></a></span><span>
</span><span id="line-344"></span><span>              </span><span class="hs-comment">-- The new target for the edge, write it with the old edge_info.</span><span>
</span><span id="line-345"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682819986"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819986"><span class="hs-identifier hs-var">new_to</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Label -&gt; a -&gt; LabelMap a -&gt; LabelMap a
forall v. Label -&gt; v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819986"><span class="hs-identifier hs-var">new_to</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682819984"><span class="hs-identifier hs-var">edge_info</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap a
</span><a href="#local-6989586621682819982"><span class="hs-identifier hs-var">new_map</span></a></span><span>
</span><span id="line-346"></span><span>        </span><span class="hs-comment">-- Node wasn't in the cuts map, so just add it back</span><span>
</span><span id="line-347"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; a -&gt; LabelMap a -&gt; LabelMap a
forall v. Label -&gt; v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819983"><span class="hs-identifier hs-var">to_edge</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682819984"><span class="hs-identifier hs-var">edge_info</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap a
</span><a href="#local-6989586621682819982"><span class="hs-identifier hs-var">new_map</span></a></span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span class="hs-comment">-- | Sometimes we insert a block which should unconditionally be executed</span><span>
</span><span id="line-351"></span><span class="hs-comment">--   after a given block. This function updates the CFG for these cases.</span><span>
</span><span id="line-352"></span><span class="hs-comment">--  So we get A -&gt; B    =&gt; A -&gt; A' -&gt; B</span><span>
</span><span id="line-353"></span><span class="hs-comment">--             \                  \</span><span>
</span><span id="line-354"></span><span class="hs-comment">--              -&gt; C    =&gt;         -&gt; C</span><span>
</span><span id="line-355"></span><span class="hs-comment">--</span><span>
</span><span id="line-356"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#addImmediateSuccessor"><span class="hs-identifier hs-type">addImmediateSuccessor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.Weight.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-357"></span><span id="addImmediateSuccessor"><span class="annot"><span class="annottext">addImmediateSuccessor :: Weights -&gt; Label -&gt; Label -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addImmediateSuccessor"><span class="hs-identifier hs-var hs-var">addImmediateSuccessor</span></a></span></span><span> </span><span id="local-6989586621682819987"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682819987"><span class="hs-identifier hs-var">weights</span></a></span></span><span> </span><span id="local-6989586621682819988"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819988"><span class="hs-identifier hs-var">node</span></a></span></span><span> </span><span id="local-6989586621682819989"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819989"><span class="hs-identifier hs-var">follower</span></a></span></span><span> </span><span id="local-6989586621682819990"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819990"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; CFG
</span><a href="#local-6989586621682819991"><span class="hs-identifier hs-var">updateEdges</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; (CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeWeight -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addWeightEdge"><span class="hs-identifier hs-var">addWeightEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819988"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819989"><span class="hs-identifier hs-var">follower</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682819993"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819990"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-360"></span><span>        </span><span id="local-6989586621682819993"><span class="annot"><span class="annottext">weight :: EdgeWeight
</span><a href="#local-6989586621682819993"><span class="hs-identifier hs-var hs-var">weight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; EdgeWeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#uncondWeight"><span class="hs-identifier hs-var">uncondWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682819987"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>        </span><span id="local-6989586621682819995"><span class="annot"><span class="annottext">targets :: [(Label, EdgeInfo)]
</span><a href="#local-6989586621682819995"><span class="hs-identifier hs-var hs-var">targets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessorEdges"><span class="hs-identifier hs-var">getSuccessorEdges</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682819990"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819988"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-362"></span><span>        </span><span id="local-6989586621682819996"><span class="annot"><span class="annottext">successors :: [Label]
</span><a href="#local-6989586621682819996"><span class="hs-identifier hs-var hs-var">successors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo) -&gt; Label) -&gt; [(Label, EdgeInfo)] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo) -&gt; Label
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682819995"><span class="hs-identifier hs-var">targets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-363"></span><span>        </span><span id="local-6989586621682819991"><span class="annot"><span class="annottext">updateEdges :: CFG -&gt; CFG
</span><a href="#local-6989586621682819991"><span class="hs-identifier hs-var hs-var">updateEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; CFG
</span><a href="#local-6989586621682819998"><span class="hs-identifier hs-var">addNewSuccs</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; (CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; CFG
</span><a href="#local-6989586621682819999"><span class="hs-identifier hs-var">remOldSuccs</span></a></span><span>
</span><span id="line-364"></span><span>        </span><span id="local-6989586621682819999"><span class="annot"><span class="annottext">remOldSuccs :: CFG -&gt; CFG
</span><a href="#local-6989586621682819999"><span class="hs-identifier hs-var hs-var">remOldSuccs</span></a></span></span><span> </span><span id="local-6989586621682820000"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820000"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; Label -&gt; CFG) -&gt; CFG -&gt; [Label] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Label -&gt; CFG -&gt; CFG) -&gt; CFG -&gt; Label -&gt; CFG
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#delEdge"><span class="hs-identifier hs-var">delEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819988"><span class="hs-identifier hs-var">node</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820000"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682819996"><span class="hs-identifier hs-var">successors</span></a></span><span>
</span><span id="line-365"></span><span>        </span><span id="local-6989586621682819998"><span class="annot"><span class="annottext">addNewSuccs :: CFG -&gt; CFG
</span><a href="#local-6989586621682819998"><span class="hs-identifier hs-var hs-var">addNewSuccs</span></a></span></span><span> </span><span id="local-6989586621682820002"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820002"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-366"></span><span>          </span><span class="annot"><span class="annottext">(CFG -&gt; (Label, EdgeInfo) -&gt; CFG)
-&gt; CFG -&gt; [(Label, EdgeInfo)] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820003"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820003"><span class="hs-identifier hs-var">m'</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820004"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820004"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820005"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820005"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682819989"><span class="hs-identifier hs-var">follower</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820004"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820005"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820003"><span class="hs-identifier hs-var">m'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820002"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682819995"><span class="hs-identifier hs-var">targets</span></a></span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="annot"><span class="hs-comment">-- | Adds a new edge, overwrites existing edges if present</span></span><span>
</span><span id="line-369"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-type">addEdge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-370"></span><span id="addEdge"><span class="annot"><span class="annottext">addEdge :: Label -&gt; Label -&gt; EdgeInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-var hs-var">addEdge</span></a></span></span><span> </span><span id="local-6989586621682820006"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820006"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820007"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820007"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682820008"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820008"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621682820009"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820009"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-371"></span><span>    </span><span class="annot"><span class="annottext">(Maybe (LabelMap EdgeInfo) -&gt; Maybe (LabelMap EdgeInfo))
-&gt; Label -&gt; CFG -&gt; CFG
forall v. (Maybe v -&gt; Maybe v) -&gt; Label -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapAlter"><span class="hs-identifier hs-var">mapAlter</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (LabelMap EdgeInfo) -&gt; Maybe (LabelMap EdgeInfo)
</span><a href="#local-6989586621682820011"><span class="hs-identifier hs-var">addFromToEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820006"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-372"></span><span>    </span><span class="annot"><span class="annottext">(Maybe (LabelMap EdgeInfo) -&gt; Maybe (LabelMap EdgeInfo))
-&gt; Label -&gt; CFG -&gt; CFG
forall v. (Maybe v -&gt; Maybe v) -&gt; Label -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapAlter"><span class="hs-identifier hs-var">mapAlter</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (LabelMap EdgeInfo) -&gt; Maybe (LabelMap EdgeInfo)
forall {v}. Maybe (LabelMap v) -&gt; Maybe (LabelMap v)
</span><a href="#local-6989586621682820012"><span class="hs-identifier hs-var">addDestNode</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820007"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820009"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-374"></span><span>        </span><span class="hs-comment">-- Simply insert the edge into the edge list.</span><span>
</span><span id="line-375"></span><span>        </span><span id="local-6989586621682820011"><span class="annot"><span class="annottext">addFromToEdge :: Maybe (LabelMap EdgeInfo) -&gt; Maybe (LabelMap EdgeInfo)
</span><a href="#local-6989586621682820011"><span class="hs-identifier hs-var hs-var">addFromToEdge</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (LabelMap EdgeInfo)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo))
-&gt; LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; EdgeInfo -&gt; LabelMap EdgeInfo
forall v. Label -&gt; v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820007"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820008"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-376"></span><span>        </span><span class="annot"><a href="#local-6989586621682820011"><span class="hs-identifier hs-var">addFromToEdge</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820014"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820014"><span class="hs-identifier hs-var">wm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo))
-&gt; LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; EdgeInfo -&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo
forall v. Label -&gt; v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820007"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820008"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820014"><span class="hs-identifier hs-var">wm</span></a></span><span>
</span><span id="line-377"></span><span>        </span><span class="hs-comment">-- We must add the destination node explicitly</span><span>
</span><span id="line-378"></span><span>        </span><span id="local-6989586621682820012"><span class="annot"><span class="annottext">addDestNode :: Maybe (LabelMap v) -&gt; Maybe (LabelMap v)
</span><a href="#local-6989586621682820012"><span class="hs-identifier hs-var hs-var">addDestNode</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (LabelMap v)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap v -&gt; Maybe (LabelMap v)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(LabelMap v -&gt; Maybe (LabelMap v))
-&gt; LabelMap v -&gt; Maybe (LabelMap v)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LabelMap v
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span>
</span><span id="line-379"></span><span>        </span><span class="annot"><a href="#local-6989586621682820012"><span class="hs-identifier hs-var">addDestNode</span></a></span><span> </span><span id="local-6989586621682820015"><span class="annot"><span class="annottext">n :: Maybe (LabelMap v)
</span><a href="#local-6989586621682820015"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">LabelMap v
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (LabelMap v)
</span><a href="#local-6989586621682820015"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="hs-comment">-- | Adds a edge with the given weight to the cfg</span><span>
</span><span id="line-383"></span><span class="hs-comment">--   If there already existed an edge it is overwritten.</span><span>
</span><span id="line-384"></span><span class="hs-comment">--   `addWeightEdge from to weight cfg`</span><span>
</span><span id="line-385"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#addWeightEdge"><span class="hs-identifier hs-type">addWeightEdge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-386"></span><span id="addWeightEdge"><span class="annot"><span class="annottext">addWeightEdge :: Label -&gt; Label -&gt; EdgeWeight -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addWeightEdge"><span class="hs-identifier hs-var hs-var">addWeightEdge</span></a></span></span><span> </span><span id="local-6989586621682820016"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820016"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820017"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820017"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682820018"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820018"><span class="hs-identifier hs-var">weight</span></a></span></span><span> </span><span id="local-6989586621682820019"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820019"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820016"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820017"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#mkWeightInfo"><span class="hs-identifier hs-var">mkWeightInfo</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820018"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820019"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#delEdge"><span class="hs-identifier hs-type">delEdge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-390"></span><span id="delEdge"><span class="annot"><span class="annottext">delEdge :: Label -&gt; Label -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#delEdge"><span class="hs-identifier hs-var hs-var">delEdge</span></a></span></span><span> </span><span id="local-6989586621682820020"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820020"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820021"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820021"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682820022"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820022"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; LabelMap EdgeInfo) -&gt; Label -&gt; CFG -&gt; CFG
forall v. (v -&gt; v) -&gt; Label -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapAdjust"><span class="hs-identifier hs-var">mapAdjust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo
forall v. Label -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820021"><span class="hs-identifier hs-var">to</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820020"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820022"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="annot"><span class="hs-comment">-- | Destinations from bid ordered by weight (descending)</span></span><span>
</span><span id="line-395"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getSuccEdgesSorted"><span class="hs-identifier hs-type">getSuccEdgesSorted</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-396"></span><span id="getSuccEdgesSorted"><span class="annot"><span class="annottext">getSuccEdgesSorted :: CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccEdgesSorted"><span class="hs-identifier hs-var hs-var">getSuccEdgesSorted</span></a></span></span><span> </span><span id="local-6989586621682820025"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820025"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820026"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820026"><span class="hs-identifier hs-var">bid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820027"><span class="annot"><span class="annottext">destMap :: LabelMap EdgeInfo
</span><a href="#local-6989586621682820027"><span class="hs-identifier hs-var hs-var">destMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; Label -&gt; CFG -&gt; LabelMap EdgeInfo
forall a. a -&gt; Label -&gt; LabelMap a -&gt; a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFindWithDefault"><span class="hs-identifier hs-var">mapFindWithDefault</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820026"><span class="hs-identifier hs-var">bid</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820025"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-398"></span><span>        </span><span id="local-6989586621682820029"><span class="annot"><span class="annottext">cfgEdges :: [(Label, EdgeInfo)]
</span><a href="#local-6989586621682820029"><span class="hs-identifier hs-var hs-var">cfgEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; [(Label, EdgeInfo)]
forall b. LabelMap b -&gt; [(Label, b)]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820027"><span class="hs-identifier hs-var">destMap</span></a></span><span>
</span><span id="line-399"></span><span>        </span><span id="local-6989586621682820030"><span class="annot"><span class="annottext">sortedEdges :: [(Label, EdgeInfo)]
</span><a href="#local-6989586621682820030"><span class="hs-identifier hs-var hs-var">sortedEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo) -&gt; EdgeWeight)
-&gt; [(Label, EdgeInfo)] -&gt; [(Label, EdgeInfo)]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="annot"><span class="annottext">(EdgeWeight -&gt; EdgeWeight)
-&gt; ((Label, EdgeInfo) -&gt; EdgeWeight)
-&gt; (Label, EdgeInfo)
-&gt; EdgeWeight
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">(EdgeInfo -&gt; EdgeWeight)
-&gt; ((Label, EdgeInfo) -&gt; EdgeInfo)
-&gt; (Label, EdgeInfo)
-&gt; EdgeWeight
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo) -&gt; EdgeInfo
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820029"><span class="hs-identifier hs-var">cfgEdges</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-comment">--pprTrace &quot;getSuccEdgesSorted&quot; (ppr bid &lt;+&gt; text &quot;map:&quot; &lt;+&gt; ppr m)</span><span>
</span><span id="line-401"></span><span>        </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820030"><span class="hs-identifier hs-var">sortedEdges</span></a></span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span class="annot"><span class="hs-comment">-- | Get successors of a given node with edge weights.</span></span><span>
</span><span id="line-404"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getSuccessorEdges"><span class="hs-identifier hs-type">getSuccessorEdges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-405"></span><span id="getSuccessorEdges"><span class="annot"><span class="annottext">getSuccessorEdges :: HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessorEdges"><span class="hs-identifier hs-var hs-var">getSuccessorEdges</span></a></span></span><span> </span><span id="local-6989586621682820038"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820038"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820039"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820039"><span class="hs-identifier hs-var">bid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
-&gt; (LabelMap EdgeInfo -&gt; [(Label, EdgeInfo)])
-&gt; Maybe (LabelMap EdgeInfo)
-&gt; [(Label, EdgeInfo)]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820040"><span class="hs-identifier hs-var">lookupError</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; [(Label, EdgeInfo)]
forall b. LabelMap b -&gt; [(Label, b)]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; CFG -&gt; Maybe (LabelMap EdgeInfo)
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820039"><span class="hs-identifier hs-var">bid</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820038"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-407"></span><span>    </span><span id="local-6989586621682820040"><span class="annot"><span class="annottext">lookupError :: [(Label, EdgeInfo)]
</span><a href="#local-6989586621682820040"><span class="hs-identifier hs-var hs-var">lookupError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [(Label, EdgeInfo)]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getSuccessorEdges: Block does not exist&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; [(Label, EdgeInfo)]) -&gt; SDoc -&gt; [(Label, EdgeInfo)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-408"></span><span>                    </span><span class="annot"><span class="annottext">Label -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820039"><span class="hs-identifier hs-var">bid</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; SDoc
</span><a href="GHC.CmmToAsm.CFG.html#pprEdgeWeights"><span class="hs-identifier hs-var">pprEdgeWeights</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820038"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getEdgeInfo"><span class="hs-identifier hs-type">getEdgeInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span>
</span><span id="line-411"></span><span id="getEdgeInfo"><span class="annot"><span class="annottext">getEdgeInfo :: Label -&gt; Label -&gt; CFG -&gt; Maybe EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeInfo"><span class="hs-identifier hs-var hs-var">getEdgeInfo</span></a></span></span><span> </span><span id="local-6989586621682820041"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820041"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820042"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820042"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682820043"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820043"><span class="hs-identifier hs-var">m</span></a></span></span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820044"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820044"><span class="hs-identifier hs-var">wm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; CFG -&gt; Maybe (LabelMap EdgeInfo)
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820041"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820043"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-413"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820045"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820045"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap EdgeInfo -&gt; Maybe EdgeInfo
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820042"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820044"><span class="hs-identifier hs-var">wm</span></a></span><span>
</span><span id="line-414"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; Maybe EdgeInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(EdgeInfo -&gt; Maybe EdgeInfo) -&gt; EdgeInfo -&gt; Maybe EdgeInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820045"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe EdgeInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getEdgeWeight"><span class="hs-identifier hs-type">getEdgeWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span>
</span><span id="line-419"></span><span id="getEdgeWeight"><span class="annot"><span class="annottext">getEdgeWeight :: CFG -&gt; Label -&gt; Label -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeWeight"><span class="hs-identifier hs-var hs-var">getEdgeWeight</span></a></span></span><span> </span><span id="local-6989586621682820048"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820048"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820049"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820049"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820050"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820050"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-420"></span><span>    </span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">(EdgeInfo -&gt; EdgeWeight) -&gt; EdgeInfo -&gt; EdgeWeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe EdgeInfo -&gt; EdgeInfo
forall a. HasDebugCallStack =&gt; String -&gt; Maybe a -&gt; a
</span><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Edgeweight for nonexisting block&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe EdgeInfo -&gt; EdgeInfo) -&gt; Maybe EdgeInfo -&gt; EdgeInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-421"></span><span>                 </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; CFG -&gt; Maybe EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820049"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820050"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820048"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getTransitionSource"><span class="hs-identifier hs-type">getTransitionSource</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#TransitionSource"><span class="hs-identifier hs-type">TransitionSource</span></a></span><span>
</span><span id="line-424"></span><span id="getTransitionSource"><span class="annot"><span class="annottext">getTransitionSource :: Label -&gt; Label -&gt; CFG -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#getTransitionSource"><span class="hs-identifier hs-var hs-var">getTransitionSource</span></a></span></span><span> </span><span id="local-6989586621682820052"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820052"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820053"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820053"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682820054"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820054"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#transitionSource"><span class="hs-identifier hs-var">transitionSource</span></a></span><span> </span><span class="annot"><span class="annottext">(EdgeInfo -&gt; TransitionSource) -&gt; EdgeInfo -&gt; TransitionSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe EdgeInfo -&gt; EdgeInfo
forall a. HasDebugCallStack =&gt; String -&gt; Maybe a -&gt; a
</span><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Source info for nonexisting block&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe EdgeInfo -&gt; EdgeInfo) -&gt; Maybe EdgeInfo -&gt; EdgeInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-425"></span><span>                        </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; CFG -&gt; Maybe EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820052"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820053"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820054"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-426"></span><span>
</span><span id="line-427"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#reverseEdges"><span class="hs-identifier hs-type">reverseEdges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-428"></span><span id="reverseEdges"><span class="annot"><span class="annottext">reverseEdges :: CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#reverseEdges"><span class="hs-identifier hs-var hs-var">reverseEdges</span></a></span></span><span> </span><span id="local-6989586621682820055"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820055"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; Label -&gt; LabelMap EdgeInfo -&gt; CFG) -&gt; CFG -&gt; CFG -&gt; CFG
forall t b. (t -&gt; Label -&gt; b -&gt; t) -&gt; t -&gt; LabelMap b -&gt; t
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820056"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820056"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820057"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820057"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820058"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820058"><span class="hs-identifier hs-var">toMap</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; Label -&gt; LabelMap EdgeInfo -&gt; CFG
</span><a href="#local-6989586621682820059"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CFG -&gt; Label -&gt; CFG
</span><a href="#local-6989586621682820060"><span class="hs-identifier hs-var">addNode</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820056"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820057"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820057"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820058"><span class="hs-identifier hs-var">toMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820055"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-comment">-- We must preserve nodes without outgoing edges!</span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><a href="#local-6989586621682820060"><span class="hs-identifier hs-type">addNode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-432"></span><span>    </span><span id="local-6989586621682820060"><span class="annot"><span class="annottext">addNode :: CFG -&gt; Label -&gt; CFG
</span><a href="#local-6989586621682820060"><span class="hs-identifier hs-var hs-var">addNode</span></a></span></span><span> </span><span id="local-6989586621682820061"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820061"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820062"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820062"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo)
-&gt; Label -&gt; LabelMap EdgeInfo -&gt; CFG -&gt; CFG
forall v. (v -&gt; v -&gt; v) -&gt; Label -&gt; v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapInsertWith"><span class="hs-identifier hs-var">mapInsertWith</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo
forall v. LabelMap v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapUnion"><span class="hs-identifier hs-var">mapUnion</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820062"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820061"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-433"></span><span>    </span><span class="annot"><a href="#local-6989586621682820059"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-434"></span><span>    </span><span id="local-6989586621682820059"><span class="annot"><span class="annottext">go :: CFG -&gt; Label -&gt; LabelMap EdgeInfo -&gt; CFG
</span><a href="#local-6989586621682820059"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682820065"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820065"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820066"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820066"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820067"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820067"><span class="hs-identifier hs-var">toMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; Label -&gt; EdgeInfo -&gt; CFG)
-&gt; CFG -&gt; LabelMap EdgeInfo -&gt; CFG
forall t b. (t -&gt; Label -&gt; b -&gt; t) -&gt; t -&gt; LabelMap b -&gt; t
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820068"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820068"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820069"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820069"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682820070"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820070"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820069"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820066"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820070"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820068"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820065"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820067"><span class="hs-identifier hs-var">toMap</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span class="annot"><span class="hs-comment">-- | Returns a unordered list of all edges with info</span></span><span>
</span><span id="line-438"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#infoEdgeList"><span class="hs-identifier hs-type">infoEdgeList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-439"></span><span id="infoEdgeList"><span class="annot"><span class="annottext">infoEdgeList :: CFG -&gt; [CfgEdge]
</span><a href="GHC.CmmToAsm.CFG.html#infoEdgeList"><span class="hs-identifier hs-var hs-var">infoEdgeList</span></a></span></span><span> </span><span id="local-6989586621682820071"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820071"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-440"></span><span>    </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)] -&gt; [CfgEdge] -&gt; [CfgEdge]
</span><a href="#local-6989586621682820072"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CFG -&gt; [(Label, LabelMap EdgeInfo)]
forall b. LabelMap b -&gt; [(Label, b)]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820071"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-comment">-- We avoid foldMap to avoid thunk buildup</span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><a href="#local-6989586621682820072"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-444"></span><span>    </span><span id="local-6989586621682820072"><span class="annot"><span class="annottext">go :: [(Label, LabelMap EdgeInfo)] -&gt; [CfgEdge] -&gt; [CfgEdge]
</span><a href="#local-6989586621682820072"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621682820073"><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820073"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820073"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-445"></span><span>    </span><span class="annot"><a href="#local-6989586621682820072"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682820074"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820074"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820075"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820075"><span class="hs-identifier hs-var">toMap</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682820076"><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820076"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820077"><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820077"><span class="hs-identifier hs-var">acc</span></a></span></span><span>
</span><span id="line-446"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
-&gt; Label -&gt; [(Label, EdgeInfo)] -&gt; [CfgEdge] -&gt; [CfgEdge]
</span><a href="#local-6989586621682820078"><span class="hs-identifier hs-var">go'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820076"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820074"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; [(Label, EdgeInfo)]
forall b. LabelMap b -&gt; [(Label, b)]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820075"><span class="hs-identifier hs-var">toMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820077"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><a href="#local-6989586621682820078"><span class="hs-identifier hs-type">go'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-448"></span><span>    </span><span id="local-6989586621682820078"><span class="annot"><span class="annottext">go' :: [(Label, LabelMap EdgeInfo)]
-&gt; Label -&gt; [(Label, EdgeInfo)] -&gt; [CfgEdge] -&gt; [CfgEdge]
</span><a href="#local-6989586621682820078"><span class="hs-identifier hs-var hs-var">go'</span></a></span></span><span> </span><span id="local-6989586621682820079"><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820079"><span class="hs-identifier hs-var">froms</span></a></span></span><span> </span><span class="annot"><span class="annottext">Label
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>              </span><span id="local-6989586621682820080"><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820080"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)] -&gt; [CfgEdge] -&gt; [CfgEdge]
</span><a href="#local-6989586621682820072"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820079"><span class="hs-identifier hs-var">froms</span></a></span><span> </span><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820080"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-449"></span><span>    </span><span class="annot"><a href="#local-6989586621682820078"><span class="hs-identifier hs-var">go'</span></a></span><span> </span><span id="local-6989586621682820081"><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820081"><span class="hs-identifier hs-var">froms</span></a></span></span><span> </span><span id="local-6989586621682820082"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820082"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682820083"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820083"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820084"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820084"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682820085"><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820085"><span class="hs-identifier hs-var">tos</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820086"><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820086"><span class="hs-identifier hs-var">acc</span></a></span></span><span>
</span><span id="line-450"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
-&gt; Label -&gt; [(Label, EdgeInfo)] -&gt; [CfgEdge] -&gt; [CfgEdge]
</span><a href="#local-6989586621682820078"><span class="hs-identifier hs-var">go'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820081"><span class="hs-identifier hs-var">froms</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820082"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820085"><span class="hs-identifier hs-var">tos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; CfgEdge
</span><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820082"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820083"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820084"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">CfgEdge -&gt; [CfgEdge] -&gt; [CfgEdge]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820086"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>
</span><span id="line-452"></span><span class="annot"><span class="hs-comment">-- | Returns a unordered list of all edges without weights</span></span><span>
</span><span id="line-453"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#edgeList"><span class="hs-identifier hs-type">edgeList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-454"></span><span id="edgeList"><span class="annot"><span class="annottext">edgeList :: CFG -&gt; [Edge]
</span><a href="GHC.CmmToAsm.CFG.html#edgeList"><span class="hs-identifier hs-var hs-var">edgeList</span></a></span></span><span> </span><span id="local-6989586621682820087"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820087"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-455"></span><span>    </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)] -&gt; [Edge] -&gt; [Edge]
</span><a href="#local-6989586621682820088"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CFG -&gt; [(Label, LabelMap EdgeInfo)]
forall b. LabelMap b -&gt; [(Label, b)]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820087"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-456"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-457"></span><span>    </span><span class="hs-comment">-- We avoid foldMap to avoid thunk buildup</span><span>
</span><span id="line-458"></span><span>    </span><span class="annot"><a href="#local-6989586621682820088"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-459"></span><span>    </span><span id="local-6989586621682820088"><span class="annot"><span class="annottext">go :: [(Label, LabelMap EdgeInfo)] -&gt; [Edge] -&gt; [Edge]
</span><a href="#local-6989586621682820088"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621682820089"><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820089"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820089"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-460"></span><span>    </span><span class="annot"><a href="#local-6989586621682820088"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682820090"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820090"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820091"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820091"><span class="hs-identifier hs-var">toMap</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682820092"><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820092"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820093"><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820093"><span class="hs-identifier hs-var">acc</span></a></span></span><span>
</span><span id="line-461"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
-&gt; Label -&gt; [Label] -&gt; [Edge] -&gt; [Edge]
</span><a href="#local-6989586621682820094"><span class="hs-identifier hs-var">go'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820092"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820090"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; [Label]
forall a. LabelMap a -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820091"><span class="hs-identifier hs-var">toMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820093"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-462"></span><span>    </span><span class="annot"><a href="#local-6989586621682820094"><span class="hs-identifier hs-type">go'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-463"></span><span>    </span><span id="local-6989586621682820094"><span class="annot"><span class="annottext">go' :: [(Label, LabelMap EdgeInfo)]
-&gt; Label -&gt; [Label] -&gt; [Edge] -&gt; [Edge]
</span><a href="#local-6989586621682820094"><span class="hs-identifier hs-var hs-var">go'</span></a></span></span><span> </span><span id="local-6989586621682820095"><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820095"><span class="hs-identifier hs-var">froms</span></a></span></span><span> </span><span class="annot"><span class="annottext">Label
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>              </span><span id="local-6989586621682820096"><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820096"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)] -&gt; [Edge] -&gt; [Edge]
</span><a href="#local-6989586621682820088"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820095"><span class="hs-identifier hs-var">froms</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820096"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-464"></span><span>    </span><span class="annot"><a href="#local-6989586621682820094"><span class="hs-identifier hs-var">go'</span></a></span><span> </span><span id="local-6989586621682820097"><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820097"><span class="hs-identifier hs-var">froms</span></a></span></span><span> </span><span id="local-6989586621682820098"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820098"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820099"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820099"><span class="hs-identifier hs-var">to</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682820100"><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820100"><span class="hs-identifier hs-var">tos</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820101"><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820101"><span class="hs-identifier hs-var">acc</span></a></span></span><span>
</span><span id="line-465"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
-&gt; Label -&gt; [Label] -&gt; [Edge] -&gt; [Edge]
</span><a href="#local-6989586621682820094"><span class="hs-identifier hs-var">go'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)]
</span><a href="#local-6989586621682820097"><span class="hs-identifier hs-var">froms</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820098"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820100"><span class="hs-identifier hs-var">tos</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820098"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820099"><span class="hs-identifier hs-var">to</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Edge -&gt; [Edge] -&gt; [Edge]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820101"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span class="annot"><span class="hs-comment">-- | Get successors of a given node without edge weights.</span></span><span>
</span><span id="line-468"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getSuccessors"><span class="hs-identifier hs-type">getSuccessors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-469"></span><span id="getSuccessors"><span class="annot"><span class="annottext">getSuccessors :: HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessors"><span class="hs-identifier hs-var hs-var">getSuccessors</span></a></span></span><span> </span><span id="local-6989586621682820107"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820107"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820108"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820108"><span class="hs-identifier hs-var">bid</span></a></span></span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820109"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820109"><span class="hs-identifier hs-var">wm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; CFG -&gt; Maybe (LabelMap EdgeInfo)
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820108"><span class="hs-identifier hs-var">bid</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820107"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-471"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; [Label]
forall a. LabelMap a -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820109"><span class="hs-identifier hs-var">wm</span></a></span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820110"><span class="hs-identifier hs-var">lookupError</span></a></span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-474"></span><span>      </span><span id="local-6989586621682820110"><span class="annot"><span class="annottext">lookupError :: [Label]
</span><a href="#local-6989586621682820110"><span class="hs-identifier hs-var hs-var">lookupError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [Label]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getSuccessors: Block does not exist&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; [Label]) -&gt; SDoc -&gt; [Label]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-475"></span><span>                    </span><span class="annot"><span class="annottext">Label -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820108"><span class="hs-identifier hs-var">bid</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; SDoc
</span><a href="GHC.CmmToAsm.CFG.html#pprEdgeWeights"><span class="hs-identifier hs-var">pprEdgeWeights</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820107"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#pprEdgeWeights"><span class="hs-identifier hs-type">pprEdgeWeights</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-478"></span><span id="pprEdgeWeights"><span class="annot"><span class="annottext">pprEdgeWeights :: CFG -&gt; SDoc
</span><a href="GHC.CmmToAsm.CFG.html#pprEdgeWeights"><span class="hs-identifier hs-var hs-var">pprEdgeWeights</span></a></span></span><span> </span><span id="local-6989586621682820111"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820111"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-479"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820112"><span class="annot"><span class="annottext">edges :: [CfgEdge]
</span><a href="#local-6989586621682820112"><span class="hs-identifier hs-var hs-var">edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CfgEdge] -&gt; [CfgEdge]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">([CfgEdge] -&gt; [CfgEdge]) -&gt; [CfgEdge] -&gt; [CfgEdge]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; [CfgEdge]
</span><a href="GHC.CmmToAsm.CFG.html#infoEdgeList"><span class="hs-identifier hs-var">infoEdgeList</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820111"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-480"></span><span>        </span><span id="local-6989586621682820130"><span class="annot"><span class="annottext">printEdge :: CfgEdge -&gt; SDoc
</span><a href="#local-6989586621682820130"><span class="hs-identifier hs-var hs-var">printEdge</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span> </span><span id="local-6989586621682820131"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820131"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820132"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820132"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">edgeWeight :: EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682820133"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820133"><span class="hs-identifier hs-var">weight</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820131"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-&gt;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820132"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-482"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;[label=\&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820133"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\&quot;,weight=\&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-483"></span><span>              </span><span class="annot"><span class="annottext">EdgeWeight -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820133"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\&quot;];\n&quot;</span></span><span>
</span><span id="line-484"></span><span>        </span><span class="hs-comment">--for the case that there are no edges from/to this node.</span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-comment">--This should rarely happen but it can save a lot of time</span><span>
</span><span id="line-486"></span><span>        </span><span class="hs-comment">--to immediately see it when it does.</span><span>
</span><span id="line-487"></span><span>        </span><span id="local-6989586621682820140"><span class="annot"><span class="annottext">printNode :: a -&gt; SDoc
</span><a href="#local-6989586621682820140"><span class="hs-identifier hs-var hs-var">printNode</span></a></span></span><span> </span><span id="local-6989586621682820141"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682820141"><span class="hs-identifier hs-var">node</span></a></span></span><span>
</span><span id="line-488"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682820141"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;;\n&quot;</span></span><span>
</span><span id="line-489"></span><span>        </span><span id="local-6989586621682820142"><span class="annot"><span class="annottext">getEdgeNodes :: CfgEdge -&gt; [Label]
</span><a href="#local-6989586621682820142"><span class="hs-identifier hs-var hs-var">getEdgeNodes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span> </span><span id="local-6989586621682820143"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820143"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820144"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820144"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820143"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820144"><span class="hs-identifier hs-var">to</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-490"></span><span>        </span><span id="local-6989586621682820145"><span class="annot"><span class="annottext">edgeNodes :: LabelSet
</span><a href="#local-6989586621682820145"><span class="hs-identifier hs-var hs-var">edgeNodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; LabelSet) -&gt; [Label] -&gt; LabelSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(CfgEdge -&gt; [Label]) -&gt; [CfgEdge] -&gt; [Label]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">CfgEdge -&gt; [Label]
</span><a href="#local-6989586621682820142"><span class="hs-identifier hs-var">getEdgeNodes</span></a></span><span> </span><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820112"><span class="hs-identifier hs-var">edges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-491"></span><span>        </span><span id="local-6989586621682820146"><span class="annot"><span class="annottext">nodes :: [Label]
</span><a href="#local-6989586621682820146"><span class="hs-identifier hs-var hs-var">nodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Label -&gt; Bool) -&gt; [Label] -&gt; [Label]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820147"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820147"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (LabelSet -&gt; Bool) -&gt; LabelSet -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelSet -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#setMember"><span class="hs-identifier hs-var">setMember</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820147"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820145"><span class="hs-identifier hs-var">edgeNodes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; [Label]) -&gt; (CFG -&gt; [Label]) -&gt; CFG -&gt; [Label]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; [Label]
forall a. LabelMap a -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; [Label]) -&gt; CFG -&gt; [Label]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; Bool) -&gt; CFG -&gt; CFG
forall v. (v -&gt; Bool) -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFilter"><span class="hs-identifier hs-var">mapFilter</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; Bool
forall a. LabelMap a -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820111"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-492"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-493"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;digraph {\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-494"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc -&gt; SDoc) -&gt; SDoc -&gt; [SDoc] -&gt; SDoc
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CfgEdge -&gt; SDoc) -&gt; [CfgEdge] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CfgEdge -&gt; SDoc
</span><a href="#local-6989586621682820130"><span class="hs-identifier hs-var">printEdge</span></a></span><span> </span><span class="annot"><span class="annottext">[CfgEdge]
</span><a href="#local-6989586621682820112"><span class="hs-identifier hs-var">edges</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-495"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc -&gt; SDoc) -&gt; SDoc -&gt; [SDoc] -&gt; SDoc
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Label -&gt; SDoc) -&gt; [Label] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="#local-6989586621682820140"><span class="hs-identifier hs-var">printNode</span></a></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820146"><span class="hs-identifier hs-var">nodes</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-496"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;}\n&quot;</span></span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#updateEdgeWeight"><span class="hs-pragma hs-type">updateEdgeWeight</span></a></span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-comment">--Allows eliminating the tuple when possible</span><span>
</span><span id="line-499"></span><span class="annot"><span class="hs-comment">-- | Invariant: The edge **must** exist already in the graph.</span></span><span>
</span><span id="line-500"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#updateEdgeWeight"><span class="hs-identifier hs-type">updateEdgeWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-501"></span><span id="updateEdgeWeight"><span class="annot"><span class="annottext">updateEdgeWeight :: (EdgeWeight -&gt; EdgeWeight) -&gt; Edge -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#updateEdgeWeight"><span class="hs-identifier hs-var hs-var">updateEdgeWeight</span></a></span></span><span> </span><span id="local-6989586621682820152"><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820152"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820153"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820153"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682820154"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820154"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820155"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820155"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820156"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820156"><span class="hs-identifier hs-var">oldInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; CFG -&gt; Maybe EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820153"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820154"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820155"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682820157"><span class="annot"><span class="annottext">oldWeight :: EdgeWeight
</span><a href="#local-6989586621682820157"><span class="hs-identifier hs-var hs-var">oldWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820156"><span class="hs-identifier hs-var">oldInfo</span></a></span><span>
</span><span id="line-504"></span><span>          </span><span class="hs-glyph">!</span><span id="local-6989586621682820158"><span class="annot"><span class="annottext">newWeight :: EdgeWeight
</span><a href="#local-6989586621682820158"><span class="hs-identifier hs-var hs-var">newWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820152"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820157"><span class="hs-identifier hs-var">oldWeight</span></a></span><span>
</span><span id="line-505"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820153"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820154"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820156"><span class="hs-identifier hs-var">oldInfo</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682820158"><span class="hs-identifier hs-type">newWeight</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820155"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; CFG
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Trying to update invalid edge&quot;</span></span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span class="hs-comment">-- from to oldWeight =&gt; newWeight</span><span>
</span><span id="line-510"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#mapWeights"><span class="hs-identifier hs-type">mapWeights</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-511"></span><span id="mapWeights"><span class="annot"><span class="annottext">mapWeights :: (Label -&gt; Label -&gt; EdgeWeight -&gt; EdgeWeight) -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#mapWeights"><span class="hs-identifier hs-var hs-var">mapWeights</span></a></span></span><span> </span><span id="local-6989586621682820161"><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820161"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682820162"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820162"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-512"></span><span>  </span><span class="annot"><span class="annottext">(CFG -&gt; CfgEdge -&gt; CFG) -&gt; CFG -&gt; [CfgEdge] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820163"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820163"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a></span><span> </span><span id="local-6989586621682820164"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820164"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820165"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820165"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682820166"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820166"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-513"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820167"><span class="annot"><span class="annottext">oldWeight :: EdgeWeight
</span><a href="#local-6989586621682820167"><span class="hs-identifier hs-var hs-var">oldWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820166"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-514"></span><span>                </span><span id="local-6989586621682820168"><span class="annot"><span class="annottext">newWeight :: EdgeWeight
</span><a href="#local-6989586621682820168"><span class="hs-identifier hs-var hs-var">newWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820161"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820164"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820165"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820167"><span class="hs-identifier hs-var">oldWeight</span></a></span><span>
</span><span id="line-515"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820164"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820165"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820166"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682820168"><span class="hs-identifier hs-type">newWeight</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820163"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-516"></span><span>          </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820162"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CFG -&gt; [CfgEdge]
</span><a href="GHC.CmmToAsm.CFG.html#infoEdgeList"><span class="hs-identifier hs-var">infoEdgeList</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820162"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span class="hs-comment">-- | Insert a block in the control flow between two other blocks.</span><span>
</span><span id="line-520"></span><span class="hs-comment">-- We pass a list of tuples (A,B,C) where</span><span>
</span><span id="line-521"></span><span class="hs-comment">-- * A -&gt; C: Old edge</span><span>
</span><span id="line-522"></span><span class="hs-comment">-- * A -&gt; B -&gt; C : New Arc, where B is the new block.</span><span>
</span><span id="line-523"></span><span class="hs-comment">-- It's possible that a block has two jumps to the same block</span><span>
</span><span id="line-524"></span><span class="hs-comment">-- in the assembly code. However we still only store a single edge for</span><span>
</span><span id="line-525"></span><span class="hs-comment">-- these cases.</span><span>
</span><span id="line-526"></span><span class="hs-comment">-- We assign the old edge info to the edge A -&gt; B and assign B -&gt; C the</span><span>
</span><span id="line-527"></span><span class="hs-comment">-- weight of an unconditional jump.</span><span>
</span><span id="line-528"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#addNodesBetween"><span class="hs-identifier hs-type">addNodesBetween</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.Weight.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-529"></span><span id="addNodesBetween"><span class="annot"><span class="annottext">addNodesBetween :: Weights -&gt; CFG -&gt; [(Label, Label, Label)] -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addNodesBetween"><span class="hs-identifier hs-var hs-var">addNodesBetween</span></a></span></span><span> </span><span id="local-6989586621682820169"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820169"><span class="hs-identifier hs-var">weights</span></a></span></span><span> </span><span id="local-6989586621682820170"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820170"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820171"><span class="annot"><span class="annottext">[(Label, Label, Label)]
</span><a href="#local-6989586621682820171"><span class="hs-identifier hs-var">updates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-530"></span><span>  </span><span class="annot"><span class="annottext">(CFG -&gt; (Label, Label, Label, EdgeInfo) -&gt; CFG)
-&gt; CFG -&gt; [(Label, Label, Label, EdgeInfo)] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span>  </span><span class="annot"><span class="annottext">CFG -&gt; (Label, Label, Label, EdgeInfo) -&gt; CFG
</span><a href="#local-6989586621682820172"><span class="hs-identifier hs-var">updateWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820170"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">([(Label, Label, Label, EdgeInfo)] -&gt; CFG)
-&gt; ([(Label, Label, Label)] -&gt; [(Label, Label, Label, EdgeInfo)])
-&gt; [(Label, Label, Label)]
-&gt; CFG
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-531"></span><span>          </span><span class="annot"><span class="annottext">[(Label, Label, Label)] -&gt; [(Label, Label, Label, EdgeInfo)]
</span><a href="#local-6989586621682820173"><span class="hs-identifier hs-var">weightUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">([(Label, Label, Label)] -&gt; CFG) -&gt; [(Label, Label, Label)] -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Label, Label, Label)]
</span><a href="#local-6989586621682820171"><span class="hs-identifier hs-var">updates</span></a></span><span>
</span><span id="line-532"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-533"></span><span>      </span><span id="local-6989586621682820174"><span class="annot"><span class="annottext">weight :: EdgeWeight
</span><a href="#local-6989586621682820174"><span class="hs-identifier hs-var hs-var">weight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; EdgeWeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#uncondWeight"><span class="hs-identifier hs-var">uncondWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820169"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>      </span><span class="hs-comment">-- We might add two blocks for different jumps along a single</span><span>
</span><span id="line-535"></span><span>      </span><span class="hs-comment">-- edge. So we end up with edges:   A -&gt; B -&gt; C   ,   A -&gt; D -&gt; C</span><span>
</span><span id="line-536"></span><span>      </span><span class="hs-comment">-- in this case after applying the first update the weight for A -&gt; C</span><span>
</span><span id="line-537"></span><span>      </span><span class="hs-comment">-- is no longer available. So we calculate future weights before updates.</span><span>
</span><span id="line-538"></span><span>      </span><span id="local-6989586621682820173"><span class="annot"><span class="annottext">weightUpdates :: [(Label, Label, Label)] -&gt; [(Label, Label, Label, EdgeInfo)]
</span><a href="#local-6989586621682820173"><span class="hs-identifier hs-var hs-var">weightUpdates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Label, Label, Label) -&gt; (Label, Label, Label, EdgeInfo))
-&gt; [(Label, Label, Label)] -&gt; [(Label, Label, Label, EdgeInfo)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Label, Label, Label) -&gt; (Label, Label, Label, EdgeInfo)
</span><a href="#local-6989586621682820175"><span class="hs-identifier hs-var">getWeight</span></a></span><span>
</span><span id="line-539"></span><span>      </span><span class="annot"><a href="#local-6989586621682820175"><span class="hs-identifier hs-type">getWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-540"></span><span>      </span><span id="local-6989586621682820175"><span class="annot"><span class="annottext">getWeight :: (Label, Label, Label) -&gt; (Label, Label, Label, EdgeInfo)
</span><a href="#local-6989586621682820175"><span class="hs-identifier hs-var hs-var">getWeight</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820176"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820176"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820177"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820177"><span class="hs-identifier hs-var">between</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820178"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820178"><span class="hs-identifier hs-var">old</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820179"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820179"><span class="hs-identifier hs-var">edgeInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; CFG -&gt; Maybe EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820176"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820178"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820170"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-542"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820176"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820177"><span class="hs-identifier hs-var">between</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820178"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820179"><span class="hs-identifier hs-var">edgeInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-544"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; (Label, Label, Label, EdgeInfo)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Can't find weight for edge that should have one&quot;</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-545"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;triple&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Label, Label, Label) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820176"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820177"><span class="hs-identifier hs-var">between</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820178"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-546"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;updates&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, Label, Label)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, Label, Label)]
</span><a href="#local-6989586621682820171"><span class="hs-identifier hs-var">updates</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-547"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cfg:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; SDoc
</span><a href="GHC.CmmToAsm.CFG.html#pprEdgeWeights"><span class="hs-identifier hs-var">pprEdgeWeights</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820170"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>      </span><span class="annot"><a href="#local-6989586621682820172"><span class="hs-identifier hs-type">updateWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-549"></span><span>      </span><span id="local-6989586621682820172"><span class="annot"><span class="annottext">updateWeight :: CFG -&gt; (Label, Label, Label, EdgeInfo) -&gt; CFG
</span><a href="#local-6989586621682820172"><span class="hs-identifier hs-var hs-var">updateWeight</span></a></span></span><span> </span><span id="local-6989586621682820180"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820180"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820181"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820181"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820182"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820182"><span class="hs-identifier hs-var">between</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820183"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820183"><span class="hs-identifier hs-var">old</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820184"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820184"><span class="hs-identifier hs-var">edgeInfo</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820181"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820182"><span class="hs-identifier hs-var">between</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820184"><span class="hs-identifier hs-var">edgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; (CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-551"></span><span>          </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeWeight -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#addWeightEdge"><span class="hs-identifier hs-var">addWeightEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820182"><span class="hs-identifier hs-var">between</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820183"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820174"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; (CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-552"></span><span>          </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#delEdge"><span class="hs-identifier hs-var">delEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820181"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820183"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820180"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span class="hs-comment">{-
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~~~       Note [CFG Edge Weights]    ~~~
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  Edge weights assigned do not currently represent a specific
  cost model and rather just a ranking of which blocks should
  be placed next to each other given their connection type in
  the CFG.
  This is especially relevant if we whenever two blocks will
  jump to the same target.

                     A   B
                      \ /
                       C

  Should A or B be placed in front of C? The block layout algorithm
  decides this based on which edge (A,C)/(B,C) is heavier. So we
  make a educated guess on which branch should be preferred.

  We rank edges in this order:
  * Unconditional Control Transfer - They will always
    transfer control to their target. Unless there is a info table
    we can turn the jump into a fallthrough as well.
    We use 20k as default, so it's easy to spot if values have been
    modified but unlikely that we run into issues with overflow.
  * If branches (likely) - We assume branches marked as likely
    are taken more than 80% of the time.
    By ranking them below unconditional jumps we make sure we
    prefer the unconditional if there is a conditional and
    unconditional edge towards a block.
  * If branches (regular) - The false branch can potentially be turned
    into a fallthrough so we prefer it slightly over the true branch.
  * Unlikely branches - These can be assumed to be taken less than 20%
    of the time. So we given them one of the lowest priorities.
  * Switches - Switches at this level are implemented as jump tables
    so have a larger number of successors. So without more information
    we can only say that each individual successor is unlikely to be
    jumped to and we rank them accordingly.
  * Calls - We currently ignore calls completely:
        * By the time we return from a call there is a good chance
          that the address we return to has already been evicted from
          cache eliminating a main advantage sequential placement brings.
        * Calls always require a info table in front of their return
          address. This reduces the chance that we return to the same
          cache line further.

-}</span><span>
</span><span id="line-602"></span><span class="annot"><span class="hs-comment">-- | Generate weights for a Cmm proc based on some simple heuristics.</span></span><span>
</span><span id="line-603"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getCfgProc"><span class="hs-identifier hs-type">getCfgProc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Platform.html#Platform"><span class="hs-identifier hs-type">Platform</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.Weight.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-604"></span><span id="getCfgProc"><span class="annot"><span class="annottext">getCfgProc :: Platform -&gt; Weights -&gt; RawCmmDecl -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#getCfgProc"><span class="hs-identifier hs-var hs-var">getCfgProc</span></a></span></span><span> </span><span class="annot"><span class="annottext">Platform
</span><span class="hs-identifier">_</span></span><span>        </span><span class="annot"><span class="annottext">Weights
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmData"><span class="hs-identifier hs-type">CmmData</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span>
</span><span id="line-605"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getCfgProc"><span class="hs-identifier hs-var">getCfgProc</span></a></span><span> </span><span id="local-6989586621682820186"><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682820186"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span id="local-6989586621682820187"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820187"><span class="hs-identifier hs-var">weights</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmProc"><span class="hs-identifier hs-type">CmmProc</span></a></span><span> </span><span id="local-6989586621682820189"><span class="annot"><span class="annottext">LabelMap RawCmmStatics
</span><a href="#local-6989586621682820189"><span class="hs-identifier hs-var">_info</span></a></span></span><span> </span><span id="local-6989586621682820190"><span class="annot"><span class="annottext">CLabel
</span><a href="#local-6989586621682820190"><span class="hs-identifier hs-var">_lab</span></a></span></span><span> </span><span id="local-6989586621682820191"><span class="annot"><span class="annottext">[GlobalRegUse]
</span><a href="#local-6989586621682820191"><span class="hs-identifier hs-var">_live</span></a></span></span><span> </span><span id="local-6989586621682820192"><span class="annot"><span class="annottext">CmmGraph
</span><a href="#local-6989586621682820192"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Weights -&gt; CmmGraph -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#getCfg"><span class="hs-identifier hs-var">getCfg</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682820186"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820187"><span class="hs-identifier hs-var">weights</span></a></span><span> </span><span class="annot"><span class="annottext">CmmGraph
</span><a href="#local-6989586621682820192"><span class="hs-identifier hs-var">graph</span></a></span><span>
</span><span id="line-606"></span><span>
</span><span id="line-607"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#getCfg"><span class="hs-identifier hs-type">getCfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Platform.html#Platform"><span class="hs-identifier hs-type">Platform</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.Weight.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-608"></span><span id="getCfg"><span class="annot"><span class="annottext">getCfg :: Platform -&gt; Weights -&gt; CmmGraph -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#getCfg"><span class="hs-identifier hs-var hs-var">getCfg</span></a></span></span><span> </span><span id="local-6989586621682820193"><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682820193"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span id="local-6989586621682820194"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820194"><span class="hs-identifier hs-var">weights</span></a></span></span><span> </span><span id="local-6989586621682820195"><span class="annot"><span class="annottext">CmmGraph
</span><a href="#local-6989586621682820195"><span class="hs-identifier hs-var">graph</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-609"></span><span>  </span><span class="annot"><span class="annottext">(CFG -&gt; (Edge, EdgeInfo) -&gt; CFG)
-&gt; CFG -&gt; [(Edge, EdgeInfo)] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; (Edge, EdgeInfo) -&gt; CFG
</span><a href="#local-6989586621682820196"><span class="hs-identifier hs-var">insertEdge</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820197"><span class="hs-identifier hs-var">edgelessCfg</span></a></span><span> </span><span class="annot"><span class="annottext">([(Edge, EdgeInfo)] -&gt; CFG) -&gt; [(Edge, EdgeInfo)] -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(CmmBlock -&gt; [(Edge, EdgeInfo)])
-&gt; [CmmBlock] -&gt; [(Edge, EdgeInfo)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">CmmBlock -&gt; [(Edge, EdgeInfo)]
</span><a href="#local-6989586621682820198"><span class="hs-identifier hs-var">getBlockEdges</span></a></span><span> </span><span class="annot"><span class="annottext">[CmmBlock]
</span><a href="#local-6989586621682820199"><span class="hs-identifier hs-var">blocks</span></a></span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-611"></span><span>    </span><span class="annot"><a href="GHC.CmmToAsm.CFG.Weight.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span>
</span><span id="line-612"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uncondWeight :: Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#uncondWeight"><span class="hs-identifier hs-var">uncondWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682820201"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820201"><span class="hs-identifier hs-var">uncondWeight</span></a></span></span><span>
</span><span id="line-613"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">condBranchWeight :: Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#condBranchWeight"><span class="hs-identifier hs-var">condBranchWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682820203"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820203"><span class="hs-identifier hs-var">condBranchWeight</span></a></span></span><span>
</span><span id="line-614"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">switchWeight :: Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#switchWeight"><span class="hs-identifier hs-var">switchWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682820205"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820205"><span class="hs-identifier hs-var">switchWeight</span></a></span></span><span>
</span><span id="line-615"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">callWeight :: Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#callWeight"><span class="hs-identifier hs-var">callWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682820207"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820207"><span class="hs-identifier hs-var">callWeight</span></a></span></span><span>
</span><span id="line-616"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">likelyCondWeight :: Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#likelyCondWeight"><span class="hs-identifier hs-var">likelyCondWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682820209"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820209"><span class="hs-identifier hs-var">likelyCondWeight</span></a></span></span><span>
</span><span id="line-617"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">unlikelyCondWeight :: Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#unlikelyCondWeight"><span class="hs-identifier hs-var">unlikelyCondWeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682820211"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820211"><span class="hs-identifier hs-var">unlikelyCondWeight</span></a></span></span><span>
</span><span id="line-618"></span><span>            </span><span class="hs-comment">--  Last two are used in other places</span><span>
</span><span id="line-619"></span><span>            </span><span class="hs-comment">--, infoTablePenalty = infoTablePenalty</span><span>
</span><span id="line-620"></span><span>            </span><span class="hs-comment">--, backEdgeBonus = backEdgeBonus</span><span>
</span><span id="line-621"></span><span>            </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820194"><span class="hs-identifier hs-var">weights</span></a></span><span>
</span><span id="line-622"></span><span>    </span><span class="hs-comment">-- Explicitly add all nodes to the cfg to ensure they are part of the</span><span>
</span><span id="line-623"></span><span>    </span><span class="hs-comment">-- CFG.</span><span>
</span><span id="line-624"></span><span>    </span><span id="local-6989586621682820197"><span class="annot"><span class="annottext">edgelessCfg :: CFG
</span><a href="#local-6989586621682820197"><span class="hs-identifier hs-var hs-var">edgelessCfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, LabelMap EdgeInfo)] -&gt; CFG
forall v. [(Label, v)] -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(Label, LabelMap EdgeInfo)] -&gt; CFG)
-&gt; [(Label, LabelMap EdgeInfo)] -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; [LabelMap EdgeInfo] -&gt; [(Label, LabelMap EdgeInfo)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CmmBlock -&gt; Label) -&gt; [CmmBlock] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CmmBlock -&gt; Label
forall (x :: Extensibility). Block CmmNode C x -&gt; Label
forall (thing :: Extensibility -&gt; Extensibility -&gt; *)
       (x :: Extensibility).
NonLocal thing =&gt;
thing C x -&gt; Label
</span><a href="GHC.Cmm.Dataflow.Graph.html#entryLabel"><span class="hs-identifier hs-var">G.entryLabel</span></a></span><span> </span><span class="annot"><span class="annottext">[CmmBlock]
</span><a href="#local-6989586621682820199"><span class="hs-identifier hs-var">blocks</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; [LabelMap EdgeInfo]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span>    </span><span class="annot"><a href="#local-6989586621682820196"><span class="hs-identifier hs-type">insertEdge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-626"></span><span>    </span><span id="local-6989586621682820196"><span class="annot"><span class="annottext">insertEdge :: CFG -&gt; (Edge, EdgeInfo) -&gt; CFG
</span><a href="#local-6989586621682820196"><span class="hs-identifier hs-var hs-var">insertEdge</span></a></span></span><span> </span><span id="local-6989586621682820214"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820214"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682820215"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820215"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820216"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820216"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span id="local-6989586621682820217"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820217"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-627"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (LabelMap EdgeInfo) -&gt; Maybe (LabelMap EdgeInfo))
-&gt; Label -&gt; CFG -&gt; CFG
forall v. (Maybe v -&gt; Maybe v) -&gt; Label -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapAlter"><span class="hs-identifier hs-var">mapAlter</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (LabelMap EdgeInfo) -&gt; Maybe (LabelMap EdgeInfo)
</span><a href="#local-6989586621682820218"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820215"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820214"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-628"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-629"></span><span>          </span><span class="annot"><a href="#local-6989586621682820218"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-630"></span><span>          </span><span id="local-6989586621682820218"><span class="annot"><span class="annottext">f :: Maybe (LabelMap EdgeInfo) -&gt; Maybe (LabelMap EdgeInfo)
</span><a href="#local-6989586621682820218"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (LabelMap EdgeInfo)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo))
-&gt; LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; EdgeInfo -&gt; LabelMap EdgeInfo
forall v. Label -&gt; v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820216"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820217"><span class="hs-identifier hs-var">weight</span></a></span><span>
</span><span id="line-631"></span><span>          </span><span class="annot"><a href="#local-6989586621682820218"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820219"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820219"><span class="hs-identifier hs-var">destMap</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo))
-&gt; LabelMap EdgeInfo -&gt; Maybe (LabelMap EdgeInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; EdgeInfo -&gt; LabelMap EdgeInfo -&gt; LabelMap EdgeInfo
forall v. Label -&gt; v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820216"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820217"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820219"><span class="hs-identifier hs-var">destMap</span></a></span><span>
</span><span id="line-632"></span><span>    </span><span class="annot"><a href="#local-6989586621682820198"><span class="hs-identifier hs-type">getBlockEdges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-633"></span><span>    </span><span id="local-6989586621682820198"><span class="annot"><span class="annottext">getBlockEdges :: CmmBlock -&gt; [(Edge, EdgeInfo)]
</span><a href="#local-6989586621682820198"><span class="hs-identifier hs-var hs-var">getBlockEdges</span></a></span></span><span> </span><span id="local-6989586621682820220"><span class="annot"><span class="annottext">CmmBlock
</span><a href="#local-6989586621682820220"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-634"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CmmNode O C
</span><a href="#local-6989586621682820221"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-635"></span><span>        </span><span class="annot"><a href="GHC.Cmm.Node.html#CmmBranch"><span class="hs-identifier hs-type">CmmBranch</span></a></span><span> </span><span id="local-6989586621682820225"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820225"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820226"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820225"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820201"><span class="hs-identifier hs-var">uncondWeight</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-636"></span><span>        </span><span class="annot"><a href="GHC.Cmm.Node.html#CmmCondBranch"><span class="hs-identifier hs-type">CmmCondBranch</span></a></span><span> </span><span id="local-6989586621682820250"><span class="annot"><span class="annottext">CmmExpr
</span><a href="#local-6989586621682820250"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621682820251"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820251"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682820252"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820252"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682820253"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621682820253"><span class="hs-identifier hs-var">l</span></a></span></span><span>
</span><span id="line-637"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621682820253"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Bool -&gt; Maybe Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-638"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820254"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820252"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820203"><span class="hs-identifier hs-var">condBranchWeight</span></a></span><span class="hs-special">,</span><span>   </span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820254"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820251"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820203"><span class="hs-identifier hs-var">condBranchWeight</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-639"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621682820253"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Bool -&gt; Maybe Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-640"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820254"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820252"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820211"><span class="hs-identifier hs-var">unlikelyCondWeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820254"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820251"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820209"><span class="hs-identifier hs-var">likelyCondWeight</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-641"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621682820253"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Bool -&gt; Maybe Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-642"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820254"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820252"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820209"><span class="hs-identifier hs-var">likelyCondWeight</span></a></span><span class="hs-special">,</span><span>   </span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820254"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820251"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820211"><span class="hs-identifier hs-var">unlikelyCondWeight</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-643"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-644"></span><span>            </span><span id="local-6989586621682820255"><span class="annot"><span class="annottext">mkEdgeInfo :: Int -&gt; EdgeInfo
</span><a href="#local-6989586621682820255"><span class="hs-identifier hs-var hs-var">mkEdgeInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;Info&quot; (ppr branchInfo &lt;+&gt; ppr cond)</span><span>
</span><span id="line-645"></span><span>                         </span><span class="annot"><span class="annottext">TransitionSource -&gt; EdgeWeight -&gt; EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CmmNode O C -&gt; BranchInfo -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#CmmSource"><span class="hs-identifier hs-var">CmmSource</span></a></span><span> </span><span class="annot"><span class="annottext">CmmNode O C
</span><a href="#local-6989586621682820221"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="annot"><span class="annottext">BranchInfo
</span><a href="#local-6989586621682820256"><span class="hs-identifier hs-var">branchInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(EdgeWeight -&gt; EdgeInfo) -&gt; (Int -&gt; EdgeWeight) -&gt; Int -&gt; EdgeInfo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; EdgeWeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span>
</span><span id="line-646"></span><span>            </span><span id="local-6989586621682820254"><span class="annot"><span class="annottext">mkEdge :: Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820254"><span class="hs-identifier hs-var hs-var">mkEdge</span></a></span></span><span> </span><span id="local-6989586621682820257"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820257"><span class="hs-identifier hs-var">target</span></a></span></span><span> </span><span id="local-6989586621682820258"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820258"><span class="hs-identifier hs-var">weight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820259"><span class="hs-identifier hs-var">bid</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820257"><span class="hs-identifier hs-var">target</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; EdgeInfo
</span><a href="#local-6989586621682820255"><span class="hs-identifier hs-var">mkEdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820258"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-647"></span><span>            </span><span id="local-6989586621682820256"><span class="annot"><span class="annottext">branchInfo :: BranchInfo
</span><a href="#local-6989586621682820256"><span class="hs-identifier hs-var hs-var">branchInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-648"></span><span>              </span><span class="annot"><span class="annottext">Platform
-&gt; (BranchInfo -&gt; GlobalReg -&gt; BranchInfo)
-&gt; BranchInfo
-&gt; CmmExpr
-&gt; BranchInfo
forall b. Platform -&gt; (b -&gt; GlobalReg -&gt; b) -&gt; b -&gt; CmmExpr -&gt; b
forall r a b.
UserOfRegs r a =&gt;
Platform -&gt; (b -&gt; r -&gt; b) -&gt; b -&gt; a -&gt; b
</span><a href="GHC.Cmm.Expr.html#foldRegsUsed"><span class="hs-identifier hs-var">foldRegsUsed</span></a></span><span>
</span><span id="line-649"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Platform
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GHC.CmmToAsm.CFG.getCfg: foldRegsUsed&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820261"><span class="annot"><span class="annottext">BranchInfo
</span><a href="#local-6989586621682820261"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621682820262"><span class="annot"><span class="annottext">GlobalReg
</span><a href="#local-6989586621682820262"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GlobalReg
</span><a href="#local-6989586621682820262"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalReg -&gt; GlobalReg -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">GlobalReg
</span><a href="GHC.Cmm.Reg.html#SpLim"><span class="hs-identifier hs-var">SpLim</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">GlobalReg
</span><a href="#local-6989586621682820262"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalReg -&gt; GlobalReg -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">GlobalReg
</span><a href="GHC.Cmm.Reg.html#HpLim"><span class="hs-identifier hs-var">HpLim</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">GlobalReg
</span><a href="#local-6989586621682820262"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">GlobalReg -&gt; GlobalReg -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">GlobalReg
</span><a href="GHC.Cmm.Reg.html#BaseReg"><span class="hs-identifier hs-var">BaseReg</span></a></span><span>
</span><span id="line-651"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">BranchInfo
</span><a href="GHC.CmmToAsm.CFG.html#HeapStackCheck"><span class="hs-identifier hs-var">HeapStackCheck</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">BranchInfo
</span><a href="#local-6989586621682820261"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span>                </span><span class="annot"><span class="annottext">BranchInfo
</span><a href="GHC.CmmToAsm.CFG.html#NoInfo"><span class="hs-identifier hs-var">NoInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CmmExpr
</span><a href="#local-6989586621682820250"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-653"></span><span>
</span><span id="line-654"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Node.html#CmmSwitch"><span class="hs-identifier hs-type">CmmSwitch</span></a></span><span> </span><span id="local-6989586621682820274"><span class="annot"><span class="annottext">CmmExpr
</span><a href="#local-6989586621682820274"><span class="hs-identifier hs-var">_e</span></a></span></span><span> </span><span id="local-6989586621682820275"><span class="annot"><span class="annottext">SwitchTargets
</span><a href="#local-6989586621682820275"><span class="hs-identifier hs-var">ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-655"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820276"><span class="annot"><span class="annottext">switchTargets :: [Label]
</span><a href="#local-6989586621682820276"><span class="hs-identifier hs-var hs-var">switchTargets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwitchTargets -&gt; [Label]
</span><a href="GHC.Cmm.Switch.html#switchTargetsToList"><span class="hs-identifier hs-var">switchTargetsToList</span></a></span><span> </span><span class="annot"><span class="annottext">SwitchTargets
</span><a href="#local-6989586621682820275"><span class="hs-identifier hs-var">ids</span></a></span><span>
</span><span id="line-656"></span><span>              </span><span class="hs-comment">--Compiler performance hack - for very wide switches don't</span><span>
</span><span id="line-657"></span><span>              </span><span class="hs-comment">--consider targets for layout.</span><span>
</span><span id="line-658"></span><span>              </span><span id="local-6989586621682820278"><span class="annot"><span class="annottext">adjustedWeight :: Int
</span><a href="#local-6989586621682820278"><span class="hs-identifier hs-var hs-var">adjustedWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-659"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Label] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820276"><span class="hs-identifier hs-var">switchTargets</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820205"><span class="hs-identifier hs-var">switchWeight</span></a></span><span>
</span><span id="line-660"></span><span>          </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Label -&gt; (Edge, EdgeInfo)) -&gt; [Label] -&gt; [(Edge, EdgeInfo)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820280"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820280"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820226"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820280"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820278"><span class="hs-identifier hs-var">adjustedWeight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820276"><span class="hs-identifier hs-var">switchTargets</span></a></span><span>
</span><span id="line-661"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Node.html#CmmCall"><span class="hs-identifier hs-type">CmmCall</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cml_cont :: CmmNode O C -&gt; Maybe Label
</span><a href="GHC.Cmm.Node.html#cml_cont"><span class="hs-identifier hs-var">cml_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820285"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820285"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820226"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820285"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820207"><span class="hs-identifier hs-var">callWeight</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-662"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Node.html#CmmForeignCall"><span class="hs-identifier hs-type">CmmForeignCall</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">succ :: CmmNode O C -&gt; Label
</span><a href="GHC.Cmm.Node.html#succ"><span class="hs-identifier hs-var">Cmm.succ</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682820290"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820290"><span class="hs-identifier hs-var">cont</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820226"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820290"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820207"><span class="hs-identifier hs-var">callWeight</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-663"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Node.html#CmmCall"><span class="hs-identifier hs-type">CmmCall</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cml_cont :: CmmNode O C -&gt; Maybe Label
</span><a href="GHC.Cmm.Node.html#cml_cont"><span class="hs-identifier hs-var">cml_cont</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Label
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-664"></span><span>        </span><span id="local-6989586621682820293"><span class="annot"><span class="annottext">CmmNode O C
</span><a href="#local-6989586621682820293"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-665"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; [(Edge, EdgeInfo)] -&gt; [(Edge, EdgeInfo)]
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Foo&quot;</span></span><span> </span><span class="annot"><span class="annottext">([(Edge, EdgeInfo)] -&gt; [(Edge, EdgeInfo)])
-&gt; [(Edge, EdgeInfo)] -&gt; [(Edge, EdgeInfo)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-666"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; [(Edge, EdgeInfo)] -&gt; [(Edge, EdgeInfo)]
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unknown successor cause:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-667"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; CmmNode O C -&gt; SDoc
forall env a. OutputableP env a =&gt; env -&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#pdoc"><span class="hs-identifier hs-var">pdoc</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682820193"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">CmmNode O C
</span><a href="#local-6989586621682820221"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;=&gt;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Platform -&gt; [Label] -&gt; SDoc
forall env a. OutputableP env a =&gt; env -&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#pdoc"><span class="hs-identifier hs-var">pdoc</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621682820193"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CmmNode O C -&gt; [Label]
forall (e :: Extensibility). CmmNode e C -&gt; [Label]
forall (thing :: Extensibility -&gt; Extensibility -&gt; *)
       (e :: Extensibility).
NonLocal thing =&gt;
thing e C -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Graph.html#successors"><span class="hs-identifier hs-var">G.successors</span></a></span><span> </span><span class="annot"><span class="annottext">CmmNode O C
</span><a href="#local-6989586621682820293"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Edge, EdgeInfo)] -&gt; [(Edge, EdgeInfo)])
-&gt; [(Edge, EdgeInfo)] -&gt; [(Edge, EdgeInfo)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-668"></span><span>            </span><span class="annot"><span class="annottext">(Label -&gt; (Edge, EdgeInfo)) -&gt; [Label] -&gt; [(Edge, EdgeInfo)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820297"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820297"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820259"><span class="hs-identifier hs-var">bid</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820297"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int -&gt; EdgeInfo
</span><a href="#local-6989586621682820298"><span class="hs-identifier hs-var">mkEdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; [(Edge, EdgeInfo)]) -&gt; [Label] -&gt; [(Edge, EdgeInfo)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CmmNode O C -&gt; [Label]
forall (e :: Extensibility). CmmNode e C -&gt; [Label]
forall (thing :: Extensibility -&gt; Extensibility -&gt; *)
       (e :: Extensibility).
NonLocal thing =&gt;
thing e C -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Graph.html#successors"><span class="hs-identifier hs-var">G.successors</span></a></span><span> </span><span class="annot"><span class="annottext">CmmNode O C
</span><a href="#local-6989586621682820293"><span class="hs-identifier hs-var">other</span></a></span><span>
</span><span id="line-669"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-670"></span><span>        </span><span id="local-6989586621682820259"><span class="annot"><span class="annottext">bid :: Label
</span><a href="#local-6989586621682820259"><span class="hs-identifier hs-var hs-var">bid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CmmBlock -&gt; Label
forall (x :: Extensibility). Block CmmNode C x -&gt; Label
forall (thing :: Extensibility -&gt; Extensibility -&gt; *)
       (x :: Extensibility).
NonLocal thing =&gt;
thing C x -&gt; Label
</span><a href="GHC.Cmm.Dataflow.Graph.html#entryLabel"><span class="hs-identifier hs-var">G.entryLabel</span></a></span><span> </span><span class="annot"><span class="annottext">CmmBlock
</span><a href="#local-6989586621682820220"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-671"></span><span>        </span><span id="local-6989586621682820298"><span class="annot"><span class="annottext">mkEdgeInfo :: Int -&gt; EdgeInfo
</span><a href="#local-6989586621682820298"><span class="hs-identifier hs-var hs-var">mkEdgeInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransitionSource -&gt; EdgeWeight -&gt; EdgeInfo
</span><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CmmNode O C -&gt; BranchInfo -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#CmmSource"><span class="hs-identifier hs-var">CmmSource</span></a></span><span> </span><span class="annot"><span class="annottext">CmmNode O C
</span><a href="#local-6989586621682820221"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="annot"><span class="annottext">BranchInfo
</span><a href="GHC.CmmToAsm.CFG.html#NoInfo"><span class="hs-identifier hs-var">NoInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(EdgeWeight -&gt; EdgeInfo) -&gt; (Int -&gt; EdgeWeight) -&gt; Int -&gt; EdgeInfo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; EdgeWeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span>
</span><span id="line-672"></span><span>        </span><span id="local-6989586621682820226"><span class="annot"><span class="annottext">mkEdge :: Label -&gt; Int -&gt; (Edge, EdgeInfo)
</span><a href="#local-6989586621682820226"><span class="hs-identifier hs-var hs-var">mkEdge</span></a></span></span><span> </span><span id="local-6989586621682820299"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820299"><span class="hs-identifier hs-var">target</span></a></span></span><span> </span><span id="local-6989586621682820300"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820300"><span class="hs-identifier hs-var">weight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820259"><span class="hs-identifier hs-var">bid</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820299"><span class="hs-identifier hs-var">target</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; EdgeInfo
</span><a href="#local-6989586621682820298"><span class="hs-identifier hs-var">mkEdgeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820300"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span>        </span><span id="local-6989586621682820221"><span class="annot"><span class="annottext">branch :: CmmNode O C
</span><a href="#local-6989586621682820221"><span class="hs-identifier hs-var hs-var">branch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CmmBlock -&gt; CmmNode O C
forall (n :: Extensibility -&gt; Extensibility -&gt; *)
       (x :: Extensibility).
Block n x C -&gt; n O C
</span><a href="GHC.Cmm.Dataflow.Block.html#lastNode"><span class="hs-identifier hs-var">lastNode</span></a></span><span> </span><span class="annot"><span class="annottext">CmmBlock
</span><a href="#local-6989586621682820220"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Node.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#O"><span class="hs-identifier hs-type">O</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#C"><span class="hs-identifier hs-type">C</span></a></span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span>    </span><span id="local-6989586621682820199"><span class="annot"><span class="annottext">blocks :: [CmmBlock]
</span><a href="#local-6989586621682820199"><span class="hs-identifier hs-var hs-var">blocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CmmGraph -&gt; [CmmBlock]
</span><a href="GHC.Cmm.html#revPostorder"><span class="hs-identifier hs-var">revPostorder</span></a></span><span> </span><span class="annot"><span class="annottext">CmmGraph
</span><a href="#local-6989586621682820195"><span class="hs-identifier hs-var">graph</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-676"></span><span>
</span><span id="line-677"></span><span class="hs-comment">--Find back edges by BFS</span><span>
</span><span id="line-678"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#findBackEdges"><span class="hs-identifier hs-type">findBackEdges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span>
</span><span id="line-679"></span><span id="findBackEdges"><span class="annot"><span class="annottext">findBackEdges :: HasDebugCallStack =&gt; Label -&gt; CFG -&gt; [Edge]
</span><a href="GHC.CmmToAsm.CFG.html#findBackEdges"><span class="hs-identifier hs-var hs-var">findBackEdges</span></a></span></span><span> </span><span id="local-6989586621682820310"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820310"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span id="local-6989586621682820311"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820311"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-680"></span><span>    </span><span class="hs-comment">--pprTraceIt &quot;Backedges:&quot; $</span><span>
</span><span id="line-681"></span><span>    </span><span class="annot"><span class="annottext">((Edge, EdgeType) -&gt; Edge) -&gt; [(Edge, EdgeType)] -&gt; [Edge]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Edge, EdgeType) -&gt; Edge
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Edge, EdgeType)] -&gt; [Edge])
-&gt; ([(Edge, EdgeType)] -&gt; [(Edge, EdgeType)])
-&gt; [(Edge, EdgeType)]
-&gt; [Edge]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-682"></span><span>    </span><span class="annot"><span class="annottext">((Edge, EdgeType) -&gt; Bool)
-&gt; [(Edge, EdgeType)] -&gt; [(Edge, EdgeType)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820312"><span class="annot"><span class="annottext">(Edge, EdgeType)
</span><a href="#local-6989586621682820312"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Edge, EdgeType) -&gt; EdgeType
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Edge, EdgeType)
</span><a href="#local-6989586621682820312"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeType -&gt; EdgeType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EdgeType
</span><a href="GHC.Data.Graph.Directed.html#Backward"><span class="hs-identifier hs-var">Backward</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Edge, EdgeType)] -&gt; [Edge]) -&gt; [(Edge, EdgeType)] -&gt; [Edge]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Edge, EdgeType)]
</span><a href="#local-6989586621682820314"><span class="hs-identifier hs-var">typedEdges</span></a></span><span>
</span><span id="line-683"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-684"></span><span>    </span><span id="local-6989586621682820315"><span class="annot"><span class="annottext">edges :: [Edge]
</span><a href="#local-6989586621682820315"><span class="hs-identifier hs-var hs-var">edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; [Edge]
</span><a href="GHC.CmmToAsm.CFG.html#edgeList"><span class="hs-identifier hs-var">edgeList</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820311"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-685"></span><span>    </span><span id="local-6989586621682820316"><span class="annot"><span class="annottext">getSuccs :: Label -&gt; [Label]
</span><a href="#local-6989586621682820316"><span class="hs-identifier hs-var hs-var">getSuccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [Label]
CFG -&gt; Label -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessors"><span class="hs-identifier hs-var">getSuccessors</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820311"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-686"></span><span>    </span><span id="local-6989586621682820314"><span class="annot"><span class="annottext">typedEdges :: [(Edge, EdgeType)]
</span><a href="#local-6989586621682820314"><span class="hs-identifier hs-var hs-var">typedEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-687"></span><span>      </span><span class="annot"><span class="annottext">Label -&gt; (Label -&gt; [Label]) -&gt; [Edge] -&gt; [(Edge, EdgeType)]
forall key.
Uniquable key =&gt;
key -&gt; (key -&gt; [key]) -&gt; [(key, key)] -&gt; [((key, key), EdgeType)]
</span><a href="GHC.Data.Graph.Directed.html#classifyEdges"><span class="hs-identifier hs-var">classifyEdges</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820310"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; [Label]
</span><a href="#local-6989586621682820316"><span class="hs-identifier hs-var">getSuccs</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820315"><span class="hs-identifier hs-var">edges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><a href="GHC.Data.Graph.Directed.html#EdgeType"><span class="hs-identifier hs-type">EdgeType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-688"></span><span>
</span><span id="line-689"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#optimizeCFG"><span class="hs-identifier hs-type">optimizeCFG</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.Weight.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-690"></span><span id="optimizeCFG"><span class="annot"><span class="annottext">optimizeCFG :: Bool -&gt; Weights -&gt; RawCmmDecl -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#optimizeCFG"><span class="hs-identifier hs-var hs-var">optimizeCFG</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Weights
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmData"><span class="hs-identifier hs-type">CmmData</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820318"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820318"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820318"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-691"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#optimizeCFG"><span class="hs-identifier hs-var">optimizeCFG</span></a></span><span> </span><span id="local-6989586621682820319"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682820319"><span class="hs-identifier hs-var">doStaticPred</span></a></span></span><span> </span><span id="local-6989586621682820320"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820320"><span class="hs-identifier hs-var">weights</span></a></span></span><span> </span><span id="local-6989586621682820321"><span class="annot"><span class="annottext">proc :: RawCmmDecl
</span><a href="#local-6989586621682820321"><span class="hs-identifier hs-var">proc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmProc"><span class="hs-identifier hs-type">CmmProc</span></a></span><span> </span><span id="local-6989586621682820322"><span class="annot"><span class="annottext">LabelMap RawCmmStatics
</span><a href="#local-6989586621682820322"><span class="hs-identifier hs-var">_info</span></a></span></span><span> </span><span id="local-6989586621682820323"><span class="annot"><span class="annottext">CLabel
</span><a href="#local-6989586621682820323"><span class="hs-identifier hs-var">_lab</span></a></span></span><span> </span><span id="local-6989586621682820324"><span class="annot"><span class="annottext">[GlobalRegUse]
</span><a href="#local-6989586621682820324"><span class="hs-identifier hs-var">_live</span></a></span></span><span> </span><span id="local-6989586621682820325"><span class="annot"><span class="annottext">CmmGraph
</span><a href="#local-6989586621682820325"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820326"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820326"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-692"></span><span>  </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682820319"><span class="hs-identifier hs-var">doStaticPred</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Label -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#staticPredCfg"><span class="hs-identifier hs-var">staticPredCfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CmmGraph -&gt; Label
forall (s :: * -&gt; *) (n :: Extensibility -&gt; Extensibility -&gt; *).
GenGenCmmGraph s n -&gt; Label
</span><a href="GHC.Cmm.html#g_entry"><span class="hs-identifier hs-var">g_entry</span></a></span><span> </span><span class="annot"><span class="annottext">CmmGraph
</span><a href="#local-6989586621682820325"><span class="hs-identifier hs-var">graph</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; CFG
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-693"></span><span>    </span><span class="annot"><span class="annottext">Weights -&gt; RawCmmDecl -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#optHsPatterns"><span class="hs-identifier hs-var">optHsPatterns</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820320"><span class="hs-identifier hs-var">weights</span></a></span><span> </span><span class="annot"><span class="annottext">RawCmmDecl
</span><a href="#local-6989586621682820321"><span class="hs-identifier hs-var">proc</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820326"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-694"></span><span>
</span><span id="line-695"></span><span class="hs-comment">-- | Modify branch weights based on educated guess on</span><span>
</span><span id="line-696"></span><span class="hs-comment">-- patterns GHC tends to produce and how they affect</span><span>
</span><span id="line-697"></span><span class="hs-comment">-- performance.</span><span>
</span><span id="line-698"></span><span class="hs-comment">--</span><span>
</span><span id="line-699"></span><span class="hs-comment">-- Most importantly we penalize jumps across info tables.</span><span>
</span><span id="line-700"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#optHsPatterns"><span class="hs-identifier hs-type">optHsPatterns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.Weight.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-701"></span><span id="optHsPatterns"><span class="annot"><span class="annottext">optHsPatterns :: Weights -&gt; RawCmmDecl -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#optHsPatterns"><span class="hs-identifier hs-var hs-var">optHsPatterns</span></a></span></span><span> </span><span class="annot"><span class="annottext">Weights
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmData"><span class="hs-identifier hs-type">CmmData</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820331"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820331"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820331"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-702"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#optHsPatterns"><span class="hs-identifier hs-var">optHsPatterns</span></a></span><span> </span><span id="local-6989586621682820332"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820332"><span class="hs-identifier hs-var">weights</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.html#CmmProc"><span class="hs-identifier hs-type">CmmProc</span></a></span><span> </span><span id="local-6989586621682820333"><span class="annot"><span class="annottext">LabelMap RawCmmStatics
</span><a href="#local-6989586621682820333"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621682820334"><span class="annot"><span class="annottext">CLabel
</span><a href="#local-6989586621682820334"><span class="hs-identifier hs-var">_lab</span></a></span></span><span> </span><span id="local-6989586621682820335"><span class="annot"><span class="annottext">[GlobalRegUse]
</span><a href="#local-6989586621682820335"><span class="hs-identifier hs-var">_live</span></a></span></span><span> </span><span id="local-6989586621682820336"><span class="annot"><span class="annottext">CmmGraph
</span><a href="#local-6989586621682820336"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820337"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820337"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-703"></span><span>    </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">optHsPatterns</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-704"></span><span>    </span><span class="hs-comment">-- pprTrace &quot;Initial:&quot; (pprEdgeWeights cfg) $</span><span>
</span><span id="line-705"></span><span>    </span><span class="hs-comment">-- pprTrace &quot;Initial:&quot; (ppr $ mkGlobalWeights (g_entry graph) cfg) $</span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span>    </span><span class="hs-comment">-- pprTrace &quot;LoopInfo:&quot; (ppr $ loopInfo cfg (g_entry graph)) $</span><span>
</span><span id="line-708"></span><span>    </span><span class="annot"><span class="annottext">CFG -&gt; CFG
</span><a href="#local-6989586621682820338"><span class="hs-identifier hs-var">favourFewerPreds</span></a></span><span>  </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; (CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-709"></span><span>    </span><span class="annot"><span class="annottext">LabelMap RawCmmStatics -&gt; CFG -&gt; CFG
forall a. LabelMap a -&gt; CFG -&gt; CFG
</span><a href="#local-6989586621682820339"><span class="hs-identifier hs-var">penalizeInfoTables</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap RawCmmStatics
</span><a href="#local-6989586621682820333"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; (CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-710"></span><span>    </span><span class="annot"><span class="annottext">Label -&gt; CFG -&gt; CFG
</span><a href="#local-6989586621682820340"><span class="hs-identifier hs-var">increaseBackEdgeWeight</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CmmGraph -&gt; Label
forall (s :: * -&gt; *) (n :: Extensibility -&gt; Extensibility -&gt; *).
GenGenCmmGraph s n -&gt; Label
</span><a href="GHC.Cmm.html#g_entry"><span class="hs-identifier hs-var">g_entry</span></a></span><span> </span><span class="annot"><span class="annottext">CmmGraph
</span><a href="#local-6989586621682820336"><span class="hs-identifier hs-var">graph</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820337"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-711"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-712"></span><span>
</span><span id="line-713"></span><span>    </span><span class="hs-comment">-- Increase the weight of all backedges in the CFG</span><span>
</span><span id="line-714"></span><span>    </span><span class="hs-comment">-- this helps to make loop jumpbacks the heaviest edges</span><span>
</span><span id="line-715"></span><span>    </span><span class="annot"><a href="#local-6989586621682820340"><span class="hs-identifier hs-type">increaseBackEdgeWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-716"></span><span>    </span><span id="local-6989586621682820340"><span class="annot"><span class="annottext">increaseBackEdgeWeight :: Label -&gt; CFG -&gt; CFG
</span><a href="#local-6989586621682820340"><span class="hs-identifier hs-var hs-var">increaseBackEdgeWeight</span></a></span></span><span> </span><span id="local-6989586621682820341"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820341"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span id="local-6989586621682820342"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820342"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-717"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820343"><span class="annot"><span class="annottext">backedges :: [Edge]
</span><a href="#local-6989586621682820343"><span class="hs-identifier hs-var hs-var">backedges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Label -&gt; CFG -&gt; [Edge]
Label -&gt; CFG -&gt; [Edge]
</span><a href="GHC.CmmToAsm.CFG.html#findBackEdges"><span class="hs-identifier hs-var">findBackEdges</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820341"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820342"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-718"></span><span>            </span><span id="local-6989586621682820344"><span class="annot"><span class="annottext">update :: EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820344"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span id="local-6989586621682820345"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820345"><span class="hs-identifier hs-var">weight</span></a></span></span><span>
</span><span id="line-719"></span><span>              </span><span class="hs-comment">--Keep irrelevant edges irrelevant</span><span>
</span><span id="line-720"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820345"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0</span></span><span>
</span><span id="line-721"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-722"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820345"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; EdgeWeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#backEdgeBonus"><span class="hs-identifier hs-var">backEdgeBonus</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820332"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-723"></span><span>        </span><span class="hs-keyword">in</span><span>  </span><span class="annot"><span class="annottext">(CFG -&gt; Edge -&gt; CFG) -&gt; CFG -&gt; [Edge] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span>  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820347"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820347"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820348"><span class="annot"><span class="annottext">Edge
</span><a href="#local-6989586621682820348"><span class="hs-identifier hs-var">edge</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(EdgeWeight -&gt; EdgeWeight) -&gt; Edge -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#updateEdgeWeight"><span class="hs-identifier hs-var">updateEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820344"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Edge
</span><a href="#local-6989586621682820348"><span class="hs-identifier hs-var">edge</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820347"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span>                    </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820342"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820343"><span class="hs-identifier hs-var">backedges</span></a></span><span>
</span><span id="line-725"></span><span>
</span><span id="line-726"></span><span>    </span><span class="hs-comment">-- Since we cant fall through info tables we penalize these.</span><span>
</span><span id="line-727"></span><span>    </span><span id="local-6989586621682819187"><span class="annot"><a href="#local-6989586621682820339"><span class="hs-identifier hs-type">penalizeInfoTables</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819187"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span></span><span>
</span><span id="line-728"></span><span>    </span><span id="local-6989586621682820339"><span class="annot"><span class="annottext">penalizeInfoTables :: forall a. LabelMap a -&gt; CFG -&gt; CFG
</span><a href="#local-6989586621682820339"><span class="hs-identifier hs-var hs-var">penalizeInfoTables</span></a></span></span><span> </span><span id="local-6989586621682820352"><span class="annot"><span class="annottext">LabelMap a
</span><a href="#local-6989586621682820352"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621682820353"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820353"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-729"></span><span>        </span><span class="annot"><span class="annottext">(Label -&gt; Label -&gt; EdgeWeight -&gt; EdgeWeight) -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#mapWeights"><span class="hs-identifier hs-var">mapWeights</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820354"><span class="hs-identifier hs-var">fupdate</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820353"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-730"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-731"></span><span>        </span><span class="annot"><a href="#local-6989586621682820354"><span class="hs-identifier hs-type">fupdate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span>
</span><span id="line-732"></span><span>        </span><span id="local-6989586621682820354"><span class="annot"><span class="annottext">fupdate :: Label -&gt; Label -&gt; EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820354"><span class="hs-identifier hs-var hs-var">fupdate</span></a></span></span><span> </span><span class="annot"><span class="annottext">Label
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682820355"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820355"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682820356"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820356"><span class="hs-identifier hs-var">weight</span></a></span></span><span>
</span><span id="line-733"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap a -&gt; Bool
forall a. Label -&gt; LabelMap a -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820355"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap a
</span><a href="#local-6989586621682820352"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-734"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820356"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; EdgeWeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; EdgeWeight) -&gt; Int -&gt; EdgeWeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Weights -&gt; Int
</span><a href="GHC.CmmToAsm.CFG.Weight.html#infoTablePenalty"><span class="hs-identifier hs-var">infoTablePenalty</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621682820332"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820356"><span class="hs-identifier hs-var">weight</span></a></span><span>
</span><span id="line-736"></span><span>
</span><span id="line-737"></span><span>    </span><span class="hs-comment">-- If a block has two successors, favour the one with fewer</span><span>
</span><span id="line-738"></span><span>    </span><span class="hs-comment">-- predecessors and/or the one allowing fall through.</span><span>
</span><span id="line-739"></span><span>    </span><span class="annot"><a href="#local-6989586621682820338"><span class="hs-identifier hs-type">favourFewerPreds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-740"></span><span>    </span><span id="local-6989586621682820338"><span class="annot"><span class="annottext">favourFewerPreds :: CFG -&gt; CFG
</span><a href="#local-6989586621682820338"><span class="hs-identifier hs-var hs-var">favourFewerPreds</span></a></span></span><span> </span><span id="local-6989586621682820358"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820358"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-741"></span><span>        </span><span class="hs-keyword">let</span><span>
</span><span id="line-742"></span><span>            </span><span id="local-6989586621682820359"><span class="annot"><span class="annottext">revCfg :: CFG
</span><a href="#local-6989586621682820359"><span class="hs-identifier hs-var hs-var">revCfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-743"></span><span>              </span><span class="annot"><span class="annottext">CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#reverseEdges"><span class="hs-identifier hs-var">reverseEdges</span></a></span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; CFG) -&gt; CFG -&gt; CFG
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Label -&gt; Label -&gt; EdgeInfo -&gt; Bool) -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#filterEdges"><span class="hs-identifier hs-var">filterEdges</span></a></span><span>
</span><span id="line-744"></span><span>                              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820360"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820360"><span class="hs-identifier hs-var">_from</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Label -&gt; EdgeInfo -&gt; Bool
</span><a href="#local-6989586621682820361"><span class="hs-identifier hs-var">fallthroughTarget</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820358"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span>            </span><span id="local-6989586621682820362"><span class="annot"><span class="annottext">predCount :: Label -&gt; Int
</span><a href="#local-6989586621682820362"><span class="hs-identifier hs-var hs-var">predCount</span></a></span></span><span> </span><span id="local-6989586621682820363"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820363"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([(Label, EdgeInfo)] -&gt; Int) -&gt; [(Label, EdgeInfo)] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessorEdges"><span class="hs-identifier hs-var">getSuccessorEdges</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820359"><span class="hs-identifier hs-var">revCfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820363"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-747"></span><span>            </span><span id="local-6989586621682820364"><span class="annot"><span class="annottext">nodes :: [Label]
</span><a href="#local-6989586621682820364"><span class="hs-identifier hs-var hs-var">nodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820358"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-748"></span><span>
</span><span id="line-749"></span><span>            </span><span class="annot"><a href="#local-6989586621682820365"><span class="hs-identifier hs-type">modifiers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-750"></span><span>            </span><span id="local-6989586621682820365"><span class="annot"><span class="annottext">modifiers :: Int -&gt; Int -&gt; (EdgeWeight, EdgeWeight)
</span><a href="#local-6989586621682820365"><span class="hs-identifier hs-var hs-var">modifiers</span></a></span></span><span> </span><span id="local-6989586621682820366"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820366"><span class="hs-identifier hs-var">preds1</span></a></span></span><span> </span><span id="local-6989586621682820367"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820367"><span class="hs-identifier hs-var">preds2</span></a></span></span><span>
</span><span id="line-751"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820366"><span class="hs-identifier hs-var">preds1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span>  </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820367"><span class="hs-identifier hs-var">preds2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-752"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820366"><span class="hs-identifier hs-var">preds1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820367"><span class="hs-identifier hs-var">preds2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-753"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-754"></span><span>
</span><span id="line-755"></span><span>            </span><span class="annot"><a href="#local-6989586621682820368"><span class="hs-identifier hs-type">update</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-756"></span><span>            </span><span id="local-6989586621682820368"><span class="annot"><span class="annottext">update :: CFG -&gt; Label -&gt; CFG
</span><a href="#local-6989586621682820368"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span id="local-6989586621682820369"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820369"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820370"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820370"><span class="hs-identifier hs-var">node</span></a></span></span><span>
</span><span id="line-757"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span id="local-6989586621682820371"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820371"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820372"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820372"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><span id="local-6989586621682820373"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820373"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820374"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820374"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessorEdges"><span class="hs-identifier hs-var">getSuccessorEdges</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820369"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820370"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-758"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682820375"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820375"><span class="hs-identifier hs-var">w1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820372"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-759"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682820376"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820376"><span class="hs-identifier hs-var">w2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820374"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-760"></span><span>              </span><span class="hs-comment">--Only change the weights if there isn't already a ordering.</span><span>
</span><span id="line-761"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820375"><span class="hs-identifier hs-var">w1</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820376"><span class="hs-identifier hs-var">w2</span></a></span><span>
</span><span id="line-762"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820377"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820377"><span class="hs-identifier hs-var">mod1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820378"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820378"><span class="hs-identifier hs-var">mod2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; (EdgeWeight, EdgeWeight)
</span><a href="#local-6989586621682820365"><span class="hs-identifier hs-var">modifiers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820362"><span class="hs-identifier hs-var">predCount</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820371"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820362"><span class="hs-identifier hs-var">predCount</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820373"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-763"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820379"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820379"><span class="hs-identifier hs-var">cfg'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-764"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CFG -&gt; (EdgeWeight -&gt; EdgeWeight) -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#adjustEdgeWeight"><span class="hs-identifier hs-var">adjustEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820379"><span class="hs-identifier hs-var">cfg'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820378"><span class="hs-identifier hs-var">mod2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820370"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820373"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-765"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CFG -&gt; (EdgeWeight -&gt; EdgeWeight) -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#adjustEdgeWeight"><span class="hs-identifier hs-var">adjustEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820369"><span class="hs-identifier hs-var">cfg</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820377"><span class="hs-identifier hs-var">mod1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820370"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820371"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-767"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820369"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-768"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(CFG -&gt; Label -&gt; CFG) -&gt; CFG -&gt; [Label] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; Label -&gt; CFG
</span><a href="#local-6989586621682820368"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820358"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820364"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-769"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-770"></span><span>        </span><span class="annot"><a href="#local-6989586621682820361"><span class="hs-identifier hs-type">fallthroughTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-771"></span><span>        </span><span id="local-6989586621682820361"><span class="annot"><span class="annottext">fallthroughTarget :: Label -&gt; EdgeInfo -&gt; Bool
</span><a href="#local-6989586621682820361"><span class="hs-identifier hs-var hs-var">fallthroughTarget</span></a></span></span><span> </span><span id="local-6989586621682820380"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820380"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span> </span><span id="local-6989586621682820381"><span class="annot"><span class="annottext">TransitionSource
</span><a href="#local-6989586621682820381"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621682820382"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820382"><span class="hs-identifier hs-var">_weight</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap RawCmmStatics -&gt; Bool
forall a. Label -&gt; LabelMap a -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820380"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap RawCmmStatics
</span><a href="#local-6989586621682820333"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-773"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#AsmCodeGen"><span class="hs-identifier hs-var">AsmCodeGen</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TransitionSource
</span><a href="#local-6989586621682820381"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-774"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CmmSource"><span class="hs-identifier hs-type">CmmSource</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">trans_cmmNode :: TransitionSource -&gt; CmmNode O C
</span><a href="GHC.CmmToAsm.CFG.html#trans_cmmNode"><span class="hs-identifier hs-var">trans_cmmNode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Cmm.Node.html#CmmBranch"><span class="hs-identifier hs-type">CmmBranch</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TransitionSource
</span><a href="#local-6989586621682820381"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-775"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CmmSource"><span class="hs-identifier hs-type">CmmSource</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">trans_cmmNode :: TransitionSource -&gt; CmmNode O C
</span><a href="GHC.CmmToAsm.CFG.html#trans_cmmNode"><span class="hs-identifier hs-var">trans_cmmNode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Cmm.Node.html#CmmCondBranch"><span class="hs-identifier hs-type">CmmCondBranch</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TransitionSource
</span><a href="#local-6989586621682820381"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-776"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-777"></span><span>
</span><span id="line-778"></span><span class="annot"><span class="hs-comment">-- | Convert block-local branch weights to global weights.</span></span><span>
</span><span id="line-779"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#staticPredCfg"><span class="hs-identifier hs-type">staticPredCfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-780"></span><span id="staticPredCfg"><span class="annot"><span class="annottext">staticPredCfg :: Label -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#staticPredCfg"><span class="hs-identifier hs-var hs-var">staticPredCfg</span></a></span></span><span> </span><span id="local-6989586621682820387"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820387"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621682820388"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820388"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820389"><span class="hs-identifier hs-var">cfg'</span></a></span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-782"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelMap Double
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682820390"><span class="annot"><span class="annottext">LabelMap (LabelMap Double)
</span><a href="#local-6989586621682820390"><span class="hs-identifier hs-var">globalEdgeWeights</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">mkGlobalWeights</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-783"></span><span>                             </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
Label -&gt; CFG -&gt; (LabelMap Double, LabelMap (LabelMap Double))
Label -&gt; CFG -&gt; (LabelMap Double, LabelMap (LabelMap Double))
</span><a href="GHC.CmmToAsm.CFG.html#mkGlobalWeights"><span class="hs-identifier hs-var">mkGlobalWeights</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820387"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820388"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-784"></span><span>    </span><span id="local-6989586621682820389"><span class="annot"><span class="annottext">cfg' :: CFG
</span><a href="#local-6989586621682820389"><span class="hs-identifier hs-var hs-var">cfg'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">rewriteEdges</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-785"></span><span>            </span><span class="annot"><span class="annottext">(CFG -&gt; Label -&gt; LabelMap Double -&gt; CFG)
-&gt; CFG -&gt; LabelMap (LabelMap Double) -&gt; CFG
forall t b. (t -&gt; Label -&gt; b -&gt; t) -&gt; t -&gt; LabelMap b -&gt; t
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a></span><span>
</span><span id="line-786"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820391"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820391"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820392"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820392"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820393"><span class="annot"><span class="annottext">LabelMap Double
</span><a href="#local-6989586621682820393"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-787"></span><span>                    </span><span class="annot"><span class="annottext">(CFG -&gt; Label -&gt; Double -&gt; CFG) -&gt; CFG -&gt; LabelMap Double -&gt; CFG
forall t b. (t -&gt; Label -&gt; b -&gt; t) -&gt; t -&gt; LabelMap b -&gt; t
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a></span><span>
</span><span id="line-788"></span><span>                        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820394"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820394"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820395"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820395"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621682820396"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820396"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; EdgeWeight -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#setEdgeWeight"><span class="hs-identifier hs-var">setEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820394"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-var">EdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820396"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820392"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820395"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-789"></span><span>                        </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820391"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap Double
</span><a href="#local-6989586621682820393"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-790"></span><span>                </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820388"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-791"></span><span>                </span><span class="annot"><span class="annottext">LabelMap (LabelMap Double)
</span><a href="#local-6989586621682820390"><span class="hs-identifier hs-var">globalEdgeWeights</span></a></span><span>
</span><span id="line-792"></span><span>
</span><span id="line-793"></span><span class="hs-comment">-- | Determine loop membership of blocks based on SCC analysis</span><span>
</span><span id="line-794"></span><span class="hs-comment">--   This is faster but only gives yes/no answers.</span><span>
</span><span id="line-795"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#loopMembers"><span class="hs-identifier hs-type">loopMembers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-796"></span><span id="loopMembers"><span class="annot"><span class="annottext">loopMembers :: HasDebugCallStack =&gt; CFG -&gt; LabelMap Bool
</span><a href="GHC.CmmToAsm.CFG.html#loopMembers"><span class="hs-identifier hs-var hs-var">loopMembers</span></a></span></span><span> </span><span id="local-6989586621682820402"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820402"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-797"></span><span>    </span><span class="annot"><span class="annottext">(LabelMap Bool -&gt; SCC Label -&gt; LabelMap Bool)
-&gt; LabelMap Bool -&gt; [SCC Label] -&gt; LabelMap Bool
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SCC Label -&gt; LabelMap Bool -&gt; LabelMap Bool)
-&gt; LabelMap Bool -&gt; SCC Label -&gt; LabelMap Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">SCC Label -&gt; LabelMap Bool -&gt; LabelMap Bool
</span><a href="#local-6989586621682820403"><span class="hs-identifier hs-var">setLevel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelMap Bool
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[SCC Label]
</span><a href="#local-6989586621682820404"><span class="hs-identifier hs-var">sccs</span></a></span><span>
</span><span id="line-798"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-799"></span><span>    </span><span class="annot"><a href="#local-6989586621682820405"><span class="hs-identifier hs-type">mkNode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.Graph.Directed.html#Node"><span class="hs-identifier hs-type">Node</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>
</span><span id="line-800"></span><span>    </span><span id="local-6989586621682820405"><span class="annot"><span class="annottext">mkNode :: Label -&gt; Node Label Label
</span><a href="#local-6989586621682820405"><span class="hs-identifier hs-var hs-var">mkNode</span></a></span></span><span> </span><span id="local-6989586621682820406"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820406"><span class="hs-identifier hs-var">bid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; [Label] -&gt; Node Label Label
forall key payload. payload -&gt; key -&gt; [key] -&gt; Node key payload
</span><a href="GHC.Data.Graph.Directed.html#DigraphNode"><span class="hs-identifier hs-var">DigraphNode</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820406"><span class="hs-identifier hs-var">bid</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820406"><span class="hs-identifier hs-var">bid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [Label]
CFG -&gt; Label -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessors"><span class="hs-identifier hs-var">getSuccessors</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820402"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820406"><span class="hs-identifier hs-var">bid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-801"></span><span>    </span><span id="local-6989586621682820408"><span class="annot"><span class="annottext">nodes :: [Node Label Label]
</span><a href="#local-6989586621682820408"><span class="hs-identifier hs-var hs-var">nodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Label -&gt; Node Label Label) -&gt; [Label] -&gt; [Node Label Label]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Node Label Label
</span><a href="#local-6989586621682820405"><span class="hs-identifier hs-var">mkNode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CFG -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820402"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>
</span><span id="line-803"></span><span>    </span><span id="local-6989586621682820404"><span class="annot"><span class="annottext">sccs :: [SCC Label]
</span><a href="#local-6989586621682820404"><span class="hs-identifier hs-var hs-var">sccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Node Label Label] -&gt; [SCC Label]
forall key payload. Ord key =&gt; [Node key payload] -&gt; [SCC payload]
</span><a href="GHC.Data.Graph.Directed.html#stronglyConnCompFromEdgedVerticesOrd"><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesOrd</span></a></span><span> </span><span class="annot"><span class="annottext">[Node Label Label]
</span><a href="#local-6989586621682820408"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-804"></span><span>
</span><span id="line-805"></span><span>    </span><span class="annot"><a href="#local-6989586621682820403"><span class="hs-identifier hs-type">setLevel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#SCC"><span class="hs-identifier hs-type">SCC</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-806"></span><span>    </span><span id="local-6989586621682820403"><span class="annot"><span class="annottext">setLevel :: SCC Label -&gt; LabelMap Bool -&gt; LabelMap Bool
</span><a href="#local-6989586621682820403"><span class="hs-identifier hs-var hs-var">setLevel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#AcyclicSCC"><span class="hs-identifier hs-type">AcyclicSCC</span></a></span><span> </span><span id="local-6989586621682820411"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820411"><span class="hs-identifier hs-var">bid</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820412"><span class="annot"><span class="annottext">LabelMap Bool
</span><a href="#local-6989586621682820412"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Bool -&gt; LabelMap Bool -&gt; LabelMap Bool
forall v. Label -&gt; v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820411"><span class="hs-identifier hs-var">bid</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">LabelMap Bool
</span><a href="#local-6989586621682820412"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-807"></span><span>    </span><span class="annot"><a href="#local-6989586621682820403"><span class="hs-identifier hs-var">setLevel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Graph.html#CyclicSCC"><span class="hs-identifier hs-type">CyclicSCC</span></a></span><span> </span><span id="local-6989586621682820414"><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820414"><span class="hs-identifier hs-var">bids</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820415"><span class="annot"><span class="annottext">LabelMap Bool
</span><a href="#local-6989586621682820415"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LabelMap Bool -&gt; Label -&gt; LabelMap Bool)
-&gt; LabelMap Bool -&gt; [Label] -&gt; LabelMap Bool
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820416"><span class="annot"><span class="annottext">LabelMap Bool
</span><a href="#local-6989586621682820416"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820417"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820417"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Bool -&gt; LabelMap Bool -&gt; LabelMap Bool
forall v. Label -&gt; v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820417"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">LabelMap Bool
</span><a href="#local-6989586621682820416"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelMap Bool
</span><a href="#local-6989586621682820415"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820414"><span class="hs-identifier hs-var">bids</span></a></span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#loopLevels"><span class="hs-identifier hs-type">loopLevels</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-810"></span><span id="loopLevels"><span class="annot"><span class="annottext">loopLevels :: CFG -&gt; Label -&gt; LabelMap Int
</span><a href="GHC.CmmToAsm.CFG.html#loopLevels"><span class="hs-identifier hs-var hs-var">loopLevels</span></a></span></span><span> </span><span id="local-6989586621682820418"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820418"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820419"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820419"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopInfo -&gt; LabelMap Int
</span><a href="GHC.CmmToAsm.CFG.html#liLevels"><span class="hs-identifier hs-var">liLevels</span></a></span><span> </span><span class="annot"><span class="annottext">LoopInfo
</span><a href="#local-6989586621682820421"><span class="hs-identifier hs-var">loopInfos</span></a></span><span>
</span><span id="line-811"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-812"></span><span>      </span><span id="local-6989586621682820421"><span class="annot"><span class="annottext">loopInfos :: LoopInfo
</span><a href="#local-6989586621682820421"><span class="hs-identifier hs-var hs-var">loopInfos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; LoopInfo
CFG -&gt; Label -&gt; LoopInfo
</span><a href="GHC.CmmToAsm.CFG.html#loopInfo"><span class="hs-identifier hs-var">loopInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820418"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820419"><span class="hs-identifier hs-var">root</span></a></span><span>
</span><span id="line-813"></span><span>
</span><span id="line-814"></span><span class="hs-keyword">data</span><span> </span><span id="LoopInfo"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#LoopInfo"><span class="hs-identifier hs-var">LoopInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LoopInfo"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#LoopInfo"><span class="hs-identifier hs-var">LoopInfo</span></a></span></span><span>
</span><span id="line-815"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="liBackEdges"><span class="annot"><span class="annottext">LoopInfo -&gt; [Edge]
</span><a href="GHC.CmmToAsm.CFG.html#liBackEdges"><span class="hs-identifier hs-var hs-var">liBackEdges</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ List of back edges</span></span><span>
</span><span id="line-816"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="liLevels"><span class="annot"><span class="annottext">LoopInfo -&gt; LabelMap Int
</span><a href="GHC.CmmToAsm.CFG.html#liLevels"><span class="hs-identifier hs-var hs-var">liLevels</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ BlockId -&gt; LoopLevel mapping</span></span><span>
</span><span id="line-817"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="liLoops"><span class="annot"><span class="annottext">LoopInfo -&gt; [(Edge, LabelSet)]
</span><a href="GHC.CmmToAsm.CFG.html#liLoops"><span class="hs-identifier hs-var hs-var">liLoops</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ (backEdge, loopBody), body includes header</span></span><span>
</span><span id="line-818"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-819"></span><span>
</span><span id="line-820"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#LoopInfo"><span class="hs-identifier hs-type">LoopInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-821"></span><span>    </span><span id="local-6989586621682820433"><span class="annot"><span class="annottext">ppr :: LoopInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#LoopInfo"><span class="hs-identifier hs-type">LoopInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682820434"><span class="annot"><span class="annottext">LabelMap Int
</span><a href="#local-6989586621682820434"><span class="hs-identifier hs-var">_lvls</span></a></span></span><span> </span><span id="local-6989586621682820435"><span class="annot"><span class="annottext">[(Edge, LabelSet)]
</span><a href="#local-6989586621682820435"><span class="hs-identifier hs-var">loops</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Loops:(backEdge, bodyNodes)&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-823"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Edge, LabelSet) -&gt; SDoc) -&gt; [(Edge, LabelSet)] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Edge, LabelSet) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge, LabelSet)]
</span><a href="#local-6989586621682820435"><span class="hs-identifier hs-var">loops</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-824"></span><span>
</span><span id="line-825"></span><span class="hs-comment">{-  Note [Determining the loop body]
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    Starting with the knowledge that:
    * head dominates the loop
    * `tail` -&gt; `head` is a backedge

    We can determine all nodes by:
    * Deleting the loop head from the graph.
    * Collect all blocks which are reachable from the `tail`.

    We do so by performing bfs from the tail node towards the head.
 -}</span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span class="hs-comment">-- | Determine loop membership of blocks based on Dominator analysis.</span><span>
</span><span id="line-840"></span><span class="hs-comment">--   This is slower but gives loop levels instead of just loop membership.</span><span>
</span><span id="line-841"></span><span class="hs-comment">--   However it only detects natural loops. Irreducible control flow is not</span><span>
</span><span id="line-842"></span><span class="hs-comment">--   recognized even if it loops. But that is rare enough that we don't have</span><span>
</span><span id="line-843"></span><span class="hs-comment">--   to care about that special case.</span><span>
</span><span id="line-844"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#loopInfo"><span class="hs-identifier hs-type">loopInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#LoopInfo"><span class="hs-identifier hs-type">LoopInfo</span></a></span><span>
</span><span id="line-845"></span><span id="loopInfo"><span class="annot"><span class="annottext">loopInfo :: HasDebugCallStack =&gt; CFG -&gt; Label -&gt; LoopInfo
</span><a href="GHC.CmmToAsm.CFG.html#loopInfo"><span class="hs-identifier hs-var hs-var">loopInfo</span></a></span></span><span> </span><span id="local-6989586621682820450"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820450"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820451"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820451"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#LoopInfo"><span class="hs-identifier hs-type">LoopInfo</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">liBackEdges :: [Edge]
</span><a href="GHC.CmmToAsm.CFG.html#liBackEdges"><span class="hs-identifier hs-var">liBackEdges</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820452"><span class="hs-identifier hs-var">backEdges</span></a></span><span>
</span><span id="line-846"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">liLevels :: LabelMap Int
</span><a href="GHC.CmmToAsm.CFG.html#liLevels"><span class="hs-identifier hs-var">liLevels</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, Int)] -&gt; LabelMap Int
forall v. [(Label, v)] -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, Int)]
</span><a href="#local-6989586621682820453"><span class="hs-identifier hs-var">loopCounts</span></a></span><span>
</span><span id="line-847"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">liLoops :: [(Edge, LabelSet)]
</span><a href="GHC.CmmToAsm.CFG.html#liLoops"><span class="hs-identifier hs-var">liLoops</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Edge, LabelSet)]
</span><a href="#local-6989586621682820454"><span class="hs-identifier hs-var">loopBodies</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-848"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-849"></span><span>    </span><span id="local-6989586621682820455"><span class="annot"><span class="annottext">revCfg :: CFG
</span><a href="#local-6989586621682820455"><span class="hs-identifier hs-var hs-var">revCfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#reverseEdges"><span class="hs-identifier hs-var">reverseEdges</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820450"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-850"></span><span>
</span><span id="line-851"></span><span>    </span><span id="local-6989586621682820456"><span class="annot"><span class="annottext">graph :: LabelMap LabelSet
</span><a href="#local-6989586621682820456"><span class="hs-identifier hs-var hs-var">graph</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;CFG - loopInfo&quot; (pprEdgeWeights cfg) $</span><span>
</span><span id="line-852"></span><span>            </span><span class="annot"><span class="annottext">(LabelMap EdgeInfo -&gt; LabelSet) -&gt; CFG -&gt; LabelMap LabelSet
forall a b. (a -&gt; b) -&gt; LabelMap a -&gt; LabelMap b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Label] -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; LabelSet)
-&gt; (LabelMap EdgeInfo -&gt; [Label]) -&gt; LabelMap EdgeInfo -&gt; LabelSet
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; [Label]
forall a. LabelMap a -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820450"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-853"></span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span>    </span><span class="hs-comment">--TODO - This should be a no op: Export constructors? Use unsafeCoerce? ...</span><span>
</span><span id="line-856"></span><span>    </span><span id="local-6989586621682820457"><span class="annot"><span class="annottext">rooted :: (Word64, Word64Map Word64Set)
</span><a href="#local-6989586621682820457"><span class="hs-identifier hs-var hs-var">rooted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Word64
</span><a href="#local-6989586621682820458"><span class="hs-identifier hs-var">fromBlockId</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820451"><span class="hs-identifier hs-var">root</span></a></span><span>
</span><span id="line-857"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LabelMap Word64Set -&gt; Word64Map Word64Set
forall a. LabelMap a -&gt; Word64Map a
</span><a href="#local-6989586621682820459"><span class="hs-identifier hs-var">toWord64Map</span></a></span><span> </span><span class="annot"><span class="annottext">(LabelMap Word64Set -&gt; Word64Map Word64Set)
-&gt; LabelMap Word64Set -&gt; Word64Map Word64Set
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LabelSet -&gt; Word64Set) -&gt; LabelMap LabelSet -&gt; LabelMap Word64Set
forall a b. (a -&gt; b) -&gt; LabelMap a -&gt; LabelMap b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; Word64Set
</span><a href="#local-6989586621682820460"><span class="hs-identifier hs-var">toWord64Set</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap LabelSet
</span><a href="#local-6989586621682820456"><span class="hs-identifier hs-var">graph</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Word64Map.Internal.html#Word64Map"><span class="hs-identifier hs-type">Word64Map</span></a></span><span> </span><span class="annot"><a href="GHC.Data.Word64Set.Internal.html#Word64Set"><span class="hs-identifier hs-type">Word64Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-858"></span><span>    </span><span id="local-6989586621682820461"><span class="annot"><span class="annottext">tree :: Tree Label
</span><a href="#local-6989586621682820461"><span class="hs-identifier hs-var hs-var">tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Label) -&gt; Tree Word64 -&gt; Tree Label
forall a b. (a -&gt; b) -&gt; Tree a -&gt; Tree b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Label
</span><a href="#local-6989586621682820462"><span class="hs-identifier hs-var">toBlockId</span></a></span><span> </span><span class="annot"><span class="annottext">(Tree Word64 -&gt; Tree Label) -&gt; Tree Word64 -&gt; Tree Label
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Word64, Word64Map Word64Set) -&gt; Tree Word64
</span><a href="GHC.CmmToAsm.CFG.Dominators.html#domTree"><span class="hs-identifier hs-var">Dom.domTree</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64, Word64Map Word64Set)
</span><a href="#local-6989586621682820457"><span class="hs-identifier hs-var">rooted</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Tree.html#Tree"><span class="hs-identifier hs-type">Tree</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>
</span><span id="line-859"></span><span>
</span><span id="line-860"></span><span>    </span><span class="hs-comment">-- Map from Nodes to their dominators</span><span>
</span><span id="line-861"></span><span>    </span><span class="annot"><a href="#local-6989586621682820464"><span class="hs-identifier hs-type">domMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-862"></span><span>    </span><span id="local-6989586621682820464"><span class="annot"><span class="annottext">domMap :: LabelMap LabelSet
</span><a href="#local-6989586621682820464"><span class="hs-identifier hs-var hs-var">domMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tree Label -&gt; LabelMap LabelSet
</span><a href="#local-6989586621682820465"><span class="hs-identifier hs-var">mkDomMap</span></a></span><span> </span><span class="annot"><span class="annottext">Tree Label
</span><a href="#local-6989586621682820461"><span class="hs-identifier hs-var">tree</span></a></span><span>
</span><span id="line-863"></span><span>
</span><span id="line-864"></span><span>    </span><span id="local-6989586621682820466"><span class="annot"><span class="annottext">edges :: [Edge]
</span><a href="#local-6989586621682820466"><span class="hs-identifier hs-var hs-var">edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; [Edge]
</span><a href="GHC.CmmToAsm.CFG.html#edgeList"><span class="hs-identifier hs-var">edgeList</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820450"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-865"></span><span>    </span><span class="hs-comment">-- We can't recompute nodes from edges, there might be blocks not connected via edges.</span><span>
</span><span id="line-866"></span><span>    </span><span id="local-6989586621682820467"><span class="annot"><span class="annottext">nodes :: [Label]
</span><a href="#local-6989586621682820467"><span class="hs-identifier hs-var hs-var">nodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820450"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-867"></span><span>
</span><span id="line-868"></span><span>    </span><span class="hs-comment">-- identify back edges</span><span>
</span><span id="line-869"></span><span>    </span><span id="local-6989586621682820468"><span class="annot"><span class="annottext">isBackEdge :: Edge -&gt; Bool
</span><a href="#local-6989586621682820468"><span class="hs-identifier hs-var hs-var">isBackEdge</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820469"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820469"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820470"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820470"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820471"><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820471"><span class="hs-identifier hs-var">doms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap LabelSet -&gt; Maybe LabelSet
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820469"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap LabelSet
</span><a href="#local-6989586621682820464"><span class="hs-identifier hs-var">domMap</span></a></span><span>
</span><span id="line-871"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelSet -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#setMember"><span class="hs-identifier hs-var">setMember</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820470"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820471"><span class="hs-identifier hs-var">doms</span></a></span><span>
</span><span id="line-872"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-873"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-874"></span><span>
</span><span id="line-875"></span><span>    </span><span class="hs-comment">-- See Note [Determining the loop body]</span><span>
</span><span id="line-876"></span><span>    </span><span class="hs-comment">-- Get the loop body associated with a back edge.</span><span>
</span><span id="line-877"></span><span>    </span><span id="local-6989586621682820472"><span class="annot"><span class="annottext">findBody :: Edge -&gt; (Edge, LabelSet)
</span><a href="#local-6989586621682820472"><span class="hs-identifier hs-var hs-var">findBody</span></a></span></span><span> </span><span id="local-6989586621682820473"><span class="annot"><span class="annottext">edge :: Edge
</span><a href="#local-6989586621682820473"><span class="hs-identifier hs-var">edge</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621682820474"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820474"><span class="hs-identifier hs-var">tail</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682820475"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820475"><span class="hs-identifier hs-var">head</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-878"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Edge
</span><a href="#local-6989586621682820473"><span class="hs-identifier hs-var">edge</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelSet -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setInsert"><span class="hs-identifier hs-var">setInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820475"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="annot"><span class="annottext">(LabelSet -&gt; LabelSet) -&gt; LabelSet -&gt; LabelSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; LabelSet -&gt; LabelSet
</span><a href="#local-6989586621682820477"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setSingleton"><span class="hs-identifier hs-var">setSingleton</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820474"><span class="hs-identifier hs-var">tail</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setSingleton"><span class="hs-identifier hs-var">setSingleton</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820474"><span class="hs-identifier hs-var">tail</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-879"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-880"></span><span>        </span><span class="hs-comment">-- See Note [Determining the loop body]</span><span>
</span><span id="line-881"></span><span>
</span><span id="line-882"></span><span>
</span><span id="line-883"></span><span>        </span><span class="annot"><a href="#local-6989586621682820477"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-884"></span><span>        </span><span id="local-6989586621682820477"><span class="annot"><span class="annottext">go :: LabelSet -&gt; LabelSet -&gt; LabelSet
</span><a href="#local-6989586621682820477"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682820479"><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820479"><span class="hs-identifier hs-var">found</span></a></span></span><span> </span><span id="local-6989586621682820480"><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820480"><span class="hs-identifier hs-var">current</span></a></span></span><span>
</span><span id="line-885"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#setNull"><span class="hs-identifier hs-var">setNull</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820480"><span class="hs-identifier hs-var">current</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820479"><span class="hs-identifier hs-var">found</span></a></span><span>
</span><span id="line-886"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; LabelSet -&gt; LabelSet
</span><a href="#local-6989586621682820477"><span class="hs-identifier hs-var">go</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelSet -&gt; LabelSet -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setUnion"><span class="hs-identifier hs-var">setUnion</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820482"><span class="hs-identifier hs-var">newSuccessors</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820479"><span class="hs-identifier hs-var">found</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-887"></span><span>                            </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820482"><span class="hs-identifier hs-var">newSuccessors</span></a></span><span>
</span><span id="line-888"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-889"></span><span>            </span><span class="hs-comment">-- Really predecessors, since we use the reversed cfg.</span><span>
</span><span id="line-890"></span><span>            </span><span id="local-6989586621682820482"><span class="annot"><span class="annottext">newSuccessors :: LabelSet
</span><a href="#local-6989586621682820482"><span class="hs-identifier hs-var hs-var">newSuccessors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Label -&gt; Bool) -&gt; LabelSet -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setFilter"><span class="hs-identifier hs-var">setFilter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820484"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820484"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelSet -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#setMember"><span class="hs-identifier hs-var">setMember</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820484"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820479"><span class="hs-identifier hs-var">found</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820485"><span class="hs-identifier hs-var">successors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-891"></span><span>            </span><span id="local-6989586621682820485"><span class="annot"><span class="annottext">successors :: LabelSet
</span><a href="#local-6989586621682820485"><span class="hs-identifier hs-var hs-var">successors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelSet -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setDelete"><span class="hs-identifier hs-var">setDelete</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820475"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="annot"><span class="annottext">(LabelSet -&gt; LabelSet) -&gt; LabelSet -&gt; LabelSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[LabelSet] -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setUnions"><span class="hs-identifier hs-var">setUnions</span></a></span><span> </span><span class="annot"><span class="annottext">([LabelSet] -&gt; LabelSet) -&gt; [LabelSet] -&gt; LabelSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Label -&gt; LabelSet) -&gt; [Label] -&gt; [LabelSet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-892"></span><span>                                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820488"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820488"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820488"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820475"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setEmpty"><span class="hs-identifier hs-var">setEmpty</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [Label]
CFG -&gt; Label -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessors"><span class="hs-identifier hs-var">getSuccessors</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820455"><span class="hs-identifier hs-var">revCfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820488"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-893"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelSet -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Label.html#setElems"><span class="hs-identifier hs-var">setElems</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820480"><span class="hs-identifier hs-var">current</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-894"></span><span>
</span><span id="line-895"></span><span>    </span><span id="local-6989586621682820452"><span class="annot"><span class="annottext">backEdges :: [Edge]
</span><a href="#local-6989586621682820452"><span class="hs-identifier hs-var hs-var">backEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Edge -&gt; Bool) -&gt; [Edge] -&gt; [Edge]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Edge -&gt; Bool
</span><a href="#local-6989586621682820468"><span class="hs-identifier hs-var">isBackEdge</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820466"><span class="hs-identifier hs-var">edges</span></a></span><span>
</span><span id="line-896"></span><span>    </span><span id="local-6989586621682820454"><span class="annot"><span class="annottext">loopBodies :: [(Edge, LabelSet)]
</span><a href="#local-6989586621682820454"><span class="hs-identifier hs-var hs-var">loopBodies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Edge -&gt; (Edge, LabelSet)) -&gt; [Edge] -&gt; [(Edge, LabelSet)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Edge -&gt; (Edge, LabelSet)
</span><a href="#local-6989586621682820472"><span class="hs-identifier hs-var">findBody</span></a></span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820452"><span class="hs-identifier hs-var">backEdges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span>    </span><span class="hs-comment">-- Block b is part of n loop bodies =&gt; loop nest level of n</span><span>
</span><span id="line-899"></span><span>    </span><span id="local-6989586621682820453"><span class="annot"><span class="annottext">loopCounts :: [(Label, Int)]
</span><a href="#local-6989586621682820453"><span class="hs-identifier hs-var hs-var">loopCounts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-900"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820491"><span class="annot"><span class="annottext">bodies :: [(Label, LabelSet)]
</span><a href="#local-6989586621682820491"><span class="hs-identifier hs-var hs-var">bodies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Edge, LabelSet) -&gt; (Label, LabelSet))
-&gt; [(Edge, LabelSet)] -&gt; [(Label, LabelSet)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Edge -&gt; Label) -&gt; (Edge, LabelSet) -&gt; (Label, LabelSet)
forall a b c. (a -&gt; b) -&gt; (a, c) -&gt; (b, c)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><a href="../../base-4.21.0.0-ae91/src/Data.Bifunctor.html#first"><span class="hs-identifier hs-var">first</span></a></span><span> </span><span class="annot"><span class="annottext">Edge -&gt; Label
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Edge, LabelSet)]
</span><a href="#local-6989586621682820454"><span class="hs-identifier hs-var">loopBodies</span></a></span><span> </span><span class="hs-comment">-- [(Header, Body)]</span><span>
</span><span id="line-901"></span><span>          </span><span id="local-6989586621682820493"><span class="annot"><span class="annottext">loopCount :: Label -&gt; Int
</span><a href="#local-6989586621682820493"><span class="hs-identifier hs-var hs-var">loopCount</span></a></span></span><span> </span><span id="local-6989586621682820494"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820494"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; Int) -&gt; [Label] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; [Label]
forall a. Eq a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">nub</span></span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; [Label])
-&gt; ([(Label, LabelSet)] -&gt; [Label])
-&gt; [(Label, LabelSet)]
-&gt; [Label]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Label, LabelSet) -&gt; Label) -&gt; [(Label, LabelSet)] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Label, LabelSet) -&gt; Label
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Label, LabelSet)] -&gt; [Label])
-&gt; ([(Label, LabelSet)] -&gt; [(Label, LabelSet)])
-&gt; [(Label, LabelSet)]
-&gt; [Label]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Label, LabelSet) -&gt; Bool)
-&gt; [(Label, LabelSet)] -&gt; [(Label, LabelSet)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; LabelSet -&gt; Bool
</span><a href="GHC.Cmm.Dataflow.Label.html#setMember"><span class="hs-identifier hs-var">setMember</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820494"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(LabelSet -&gt; Bool)
-&gt; ((Label, LabelSet) -&gt; LabelSet) -&gt; (Label, LabelSet) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Label, LabelSet) -&gt; LabelSet
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Label, LabelSet)] -&gt; [Label]) -&gt; [(Label, LabelSet)] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Label, LabelSet)]
</span><a href="#local-6989586621682820491"><span class="hs-identifier hs-var">bodies</span></a></span><span>
</span><span id="line-902"></span><span>      </span><span class="hs-keyword">in</span><span>  </span><span class="annot"><span class="annottext">(Label -&gt; (Label, Int)) -&gt; [Label] -&gt; [(Label, Int)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820495"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820495"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820495"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820493"><span class="hs-identifier hs-var">loopCount</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820495"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; [(Label, Int)]) -&gt; [Label] -&gt; [(Label, Int)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820467"><span class="hs-identifier hs-var">nodes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-903"></span><span>
</span><span id="line-904"></span><span>    </span><span class="annot"><a href="#local-6989586621682820460"><span class="hs-identifier hs-type">toWord64Set</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.Word64Set.Internal.html#Word64Set"><span class="hs-identifier hs-type">Word64Set</span></a></span><span>
</span><span id="line-905"></span><span>    </span><span id="local-6989586621682820460"><span class="annot"><span class="annottext">toWord64Set :: LabelSet -&gt; Word64Set
</span><a href="#local-6989586621682820460"><span class="hs-identifier hs-var hs-var">toWord64Set</span></a></span></span><span> </span><span id="local-6989586621682820496"><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820496"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Word64] -&gt; Word64Set
</span><a href="GHC.Data.Word64Set.Internal.html#fromList"><span class="hs-identifier hs-var">WS.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Word64] -&gt; Word64Set)
-&gt; (LabelSet -&gt; [Word64]) -&gt; LabelSet -&gt; Word64Set
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Label -&gt; Word64) -&gt; [Label] -&gt; [Word64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Word64
</span><a href="#local-6989586621682820458"><span class="hs-identifier hs-var">fromBlockId</span></a></span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; [Word64])
-&gt; (LabelSet -&gt; [Label]) -&gt; LabelSet -&gt; [Word64]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Label.html#setElems"><span class="hs-identifier hs-var">setElems</span></a></span><span> </span><span class="annot"><span class="annottext">(LabelSet -&gt; Word64Set) -&gt; LabelSet -&gt; Word64Set
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820496"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-906"></span><span>    </span><span id="local-6989586621682819205"><span class="annot"><a href="#local-6989586621682820459"><span class="hs-identifier hs-type">toWord64Map</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819205"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.Word64Map.Internal.html#Word64Map"><span class="hs-identifier hs-type">Word64Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819205"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-907"></span><span>    </span><span id="local-6989586621682820459"><span class="annot"><span class="annottext">toWord64Map :: forall a. LabelMap a -&gt; Word64Map a
</span><a href="#local-6989586621682820459"><span class="hs-identifier hs-var hs-var">toWord64Map</span></a></span></span><span> </span><span id="local-6989586621682820498"><span class="annot"><span class="annottext">LabelMap a
</span><a href="#local-6989586621682820498"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Word64, a)] -&gt; Word64Map a
forall a. [(Word64, a)] -&gt; Word64Map a
</span><a href="GHC.Data.Word64Map.Strict.Internal.html#fromList"><span class="hs-identifier hs-var">WM.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(Word64, a)] -&gt; Word64Map a) -&gt; [(Word64, a)] -&gt; Word64Map a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Label, a) -&gt; (Word64, a)) -&gt; [(Label, a)] -&gt; [(Word64, a)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682820500"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820500"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820501"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682820501"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Word64
</span><a href="#local-6989586621682820458"><span class="hs-identifier hs-var">fromBlockId</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820500"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682820501"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Label, a)] -&gt; [(Word64, a)]) -&gt; [(Label, a)] -&gt; [(Word64, a)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LabelMap a -&gt; [(Label, a)]
forall b. LabelMap b -&gt; [(Label, b)]
</span><a href="GHC.Cmm.Dataflow.Label.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap a
</span><a href="#local-6989586621682820498"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-908"></span><span>
</span><span id="line-909"></span><span>    </span><span class="annot"><a href="#local-6989586621682820465"><span class="hs-identifier hs-type">mkDomMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Tree.html#Tree"><span class="hs-identifier hs-type">Tree</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-910"></span><span>    </span><span id="local-6989586621682820465"><span class="annot"><span class="annottext">mkDomMap :: Tree Label -&gt; LabelMap LabelSet
</span><a href="#local-6989586621682820465"><span class="hs-identifier hs-var hs-var">mkDomMap</span></a></span></span><span> </span><span id="local-6989586621682820502"><span class="annot"><span class="annottext">Tree Label
</span><a href="#local-6989586621682820502"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, LabelSet)] -&gt; LabelMap LabelSet
forall v. [(Label, v)] -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(Label, LabelSet)] -&gt; LabelMap LabelSet)
-&gt; [(Label, LabelSet)] -&gt; LabelMap LabelSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; Tree Label -&gt; [(Label, LabelSet)]
</span><a href="#local-6989586621682820503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setEmpty"><span class="hs-identifier hs-var">setEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Tree Label
</span><a href="#local-6989586621682820502"><span class="hs-identifier hs-var">root</span></a></span><span>
</span><span id="line-911"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-912"></span><span>        </span><span class="annot"><a href="#local-6989586621682820503"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Tree.html#Tree"><span class="hs-identifier hs-type">Tree</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-913"></span><span>        </span><span id="local-6989586621682820503"><span class="annot"><span class="annottext">go :: LabelSet -&gt; Tree Label -&gt; [(Label, LabelSet)]
</span><a href="#local-6989586621682820503"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682820504"><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820504"><span class="hs-identifier hs-var">parents</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Tree.html#Node"><span class="hs-identifier hs-type">Node</span></a></span><span> </span><span id="local-6989586621682820506"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820506"><span class="hs-identifier hs-var">lbl</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>          </span><span class="hs-glyph">=</span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820506"><span class="hs-identifier hs-var">lbl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820504"><span class="hs-identifier hs-var">parents</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-915"></span><span>        </span><span class="annot"><a href="#local-6989586621682820503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682820507"><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820507"><span class="hs-identifier hs-var">parents</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Tree.html#Node"><span class="hs-identifier hs-type">Node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682820508"><span class="annot"><span class="annottext">[Tree Label]
</span><a href="#local-6989586621682820508"><span class="hs-identifier hs-var">leaves</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-916"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820509"><span class="annot"><span class="annottext">nodes :: [Label]
</span><a href="#local-6989586621682820509"><span class="hs-identifier hs-var hs-var">nodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tree Label -&gt; Label) -&gt; [Tree Label] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Tree Label -&gt; Label
forall a. Tree a -&gt; a
</span><a href="../../containers-0.7-5a8f/src/Data.Tree.html#rootLabel"><span class="hs-identifier hs-var">rootLabel</span></a></span><span> </span><span class="annot"><span class="annottext">[Tree Label]
</span><a href="#local-6989586621682820508"><span class="hs-identifier hs-var">leaves</span></a></span><span>
</span><span id="line-917"></span><span>                </span><span id="local-6989586621682820511"><span class="annot"><span class="annottext">entries :: [(Label, LabelSet)]
</span><a href="#local-6989586621682820511"><span class="hs-identifier hs-var hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Label -&gt; (Label, LabelSet)) -&gt; [Label] -&gt; [(Label, LabelSet)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820512"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820512"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820512"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820507"><span class="hs-identifier hs-var">parents</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820509"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-918"></span><span>            </span><span class="hs-keyword">in</span><span>  </span><span class="annot"><span class="annottext">[(Label, LabelSet)]
</span><a href="#local-6989586621682820511"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, LabelSet)] -&gt; [(Label, LabelSet)] -&gt; [(Label, LabelSet)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Tree Label -&gt; [(Label, LabelSet)])
-&gt; [Tree Label] -&gt; [(Label, LabelSet)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span>
</span><span id="line-919"></span><span>                            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820513"><span class="annot"><span class="annottext">Tree Label
</span><a href="#local-6989586621682820513"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LabelSet -&gt; Tree Label -&gt; [(Label, LabelSet)]
</span><a href="#local-6989586621682820503"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; LabelSet -&gt; LabelSet
</span><a href="GHC.Cmm.Dataflow.Label.html#setInsert"><span class="hs-identifier hs-var">setInsert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tree Label -&gt; Label
forall a. Tree a -&gt; a
</span><a href="../../containers-0.7-5a8f/src/Data.Tree.html#rootLabel"><span class="hs-identifier hs-var">rootLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Tree Label
</span><a href="#local-6989586621682820513"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820507"><span class="hs-identifier hs-var">parents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tree Label
</span><a href="#local-6989586621682820513"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-920"></span><span>                            </span><span class="annot"><span class="annottext">[Tree Label]
</span><a href="#local-6989586621682820508"><span class="hs-identifier hs-var">leaves</span></a></span><span>
</span><span id="line-921"></span><span>
</span><span id="line-922"></span><span>    </span><span class="annot"><a href="#local-6989586621682820458"><span class="hs-identifier hs-type">fromBlockId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-923"></span><span>    </span><span id="local-6989586621682820458"><span class="annot"><span class="annottext">fromBlockId :: Label -&gt; Word64
</span><a href="#local-6989586621682820458"><span class="hs-identifier hs-var hs-var">fromBlockId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Word64
</span><a href="GHC.Types.Unique.html#getKey"><span class="hs-identifier hs-var">getKey</span></a></span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; Word64) -&gt; (Label -&gt; Unique) -&gt; Label -&gt; Word64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Unique
forall a. Uniquable a =&gt; a -&gt; Unique
</span><a href="GHC.Types.Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a></span><span>
</span><span id="line-924"></span><span>
</span><span id="line-925"></span><span>    </span><span class="annot"><a href="#local-6989586621682820462"><span class="hs-identifier hs-type">toBlockId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>
</span><span id="line-926"></span><span>    </span><span id="local-6989586621682820462"><span class="annot"><span class="annottext">toBlockId :: Word64 -&gt; Label
</span><a href="#local-6989586621682820462"><span class="hs-identifier hs-var hs-var">toBlockId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Label
</span><a href="GHC.Cmm.BlockId.html#mkBlockId"><span class="hs-identifier hs-var">mkBlockId</span></a></span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; Label) -&gt; (Word64 -&gt; Unique) -&gt; Word64 -&gt; Label
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Unique
</span><a href="GHC.Types.Unique.html#mkUniqueGrimily"><span class="hs-identifier hs-var">mkUniqueGrimily</span></a></span><span>
</span><span id="line-927"></span><span>
</span><span id="line-928"></span><span class="hs-comment">-- We make the CFG a Hoopl Graph, so we can reuse revPostOrder.</span><span>
</span><span id="line-929"></span><span class="hs-keyword">newtype</span><span> </span><span id="BlockNode"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BlockNode"><span class="hs-identifier hs-var">BlockNode</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682819220"><span class="annot"><a href="#local-6989586621682819220"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#Extensibility"><span class="hs-identifier hs-type">Extensibility</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682819221"><span class="annot"><a href="#local-6989586621682819221"><span class="hs-identifier hs-type">x</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#Extensibility"><span class="hs-identifier hs-type">Extensibility</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BN"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BN"><span class="hs-identifier hs-var">BN</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-930"></span><span>
</span><span id="line-931"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Graph.html#NonLocal"><span class="hs-identifier hs-type">G.NonLocal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BlockNode"><span class="hs-identifier hs-type">BlockNode</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-932"></span><span>  </span><span id="local-6989586621682820523"><span class="annot"><span class="annottext">entryLabel :: forall (x :: Extensibility). BlockNode C x -&gt; Label
</span><a href="GHC.Cmm.Dataflow.Graph.html#entryLabel"><span class="hs-identifier hs-var hs-var hs-var">entryLabel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BN"><span class="hs-identifier hs-type">BN</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820524"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820524"><span class="hs-identifier hs-var">lbl</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[Label]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820524"><span class="hs-identifier hs-var">lbl</span></a></span><span>
</span><span id="line-933"></span><span>  </span><span id="local-6989586621682820525"><span class="annot"><span class="annottext">successors :: forall (e :: Extensibility). BlockNode e C -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Graph.html#successors"><span class="hs-identifier hs-var hs-var hs-var">successors</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BN"><span class="hs-identifier hs-type">BN</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621682820526"><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820526"><span class="hs-identifier hs-var">succs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820526"><span class="hs-identifier hs-var">succs</span></a></span><span>
</span><span id="line-934"></span><span>
</span><span id="line-935"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#revPostorderFrom"><span class="hs-identifier hs-type">revPostorderFrom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-936"></span><span id="revPostorderFrom"><span class="annot"><span class="annottext">revPostorderFrom :: HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#revPostorderFrom"><span class="hs-identifier hs-var hs-var">revPostorderFrom</span></a></span></span><span> </span><span id="local-6989586621682820532"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820532"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820533"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820533"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-937"></span><span>    </span><span class="annot"><span class="annottext">(BlockNode C C -&gt; Label) -&gt; [BlockNode C C] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">BlockNode C C -&gt; Label
</span><a href="#local-6989586621682820534"><span class="hs-identifier hs-var">fromNode</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockNode C C] -&gt; [Label]) -&gt; [BlockNode C C] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LabelMap (BlockNode C C) -&gt; Label -&gt; [BlockNode C C]
forall (block :: Extensibility -&gt; Extensibility -&gt; *).
NonLocal block =&gt;
LabelMap (block C C) -&gt; Label -&gt; [block C C]
</span><a href="GHC.Cmm.Dataflow.Graph.html#revPostorderFrom"><span class="hs-identifier hs-var">G.revPostorderFrom</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap (BlockNode C C)
</span><a href="#local-6989586621682820536"><span class="hs-identifier hs-var">hooplGraph</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820533"><span class="hs-identifier hs-var">root</span></a></span><span>
</span><span id="line-938"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-939"></span><span>    </span><span id="local-6989586621682820537"><span class="annot"><span class="annottext">nodes :: [Label]
</span><a href="#local-6989586621682820537"><span class="hs-identifier hs-var hs-var">nodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820532"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-940"></span><span>    </span><span id="local-6989586621682820536"><span class="annot"><span class="annottext">hooplGraph :: LabelMap (BlockNode C C)
</span><a href="#local-6989586621682820536"><span class="hs-identifier hs-var hs-var">hooplGraph</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LabelMap (BlockNode C C) -&gt; Label -&gt; LabelMap (BlockNode C C))
-&gt; LabelMap (BlockNode C C) -&gt; [Label] -&gt; LabelMap (BlockNode C C)
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820538"><span class="annot"><span class="annottext">LabelMap (BlockNode C C)
</span><a href="#local-6989586621682820538"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820539"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820539"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Label
-&gt; BlockNode C C
-&gt; LabelMap (BlockNode C C)
-&gt; LabelMap (BlockNode C C)
forall v. Label -&gt; v -&gt; LabelMap v -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820539"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; BlockNode C C
</span><a href="#local-6989586621682820540"><span class="hs-identifier hs-var">toNode</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820539"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelMap (BlockNode C C)
</span><a href="#local-6989586621682820538"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelMap (BlockNode C C)
forall v. LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820537"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-941"></span><span>
</span><span id="line-942"></span><span>    </span><span class="annot"><a href="#local-6989586621682820534"><span class="hs-identifier hs-type">fromNode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BlockNode"><span class="hs-identifier hs-type">BlockNode</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#C"><span class="hs-identifier hs-type">C</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#C"><span class="hs-identifier hs-type">C</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>
</span><span id="line-943"></span><span>    </span><span id="local-6989586621682820534"><span class="annot"><span class="annottext">fromNode :: BlockNode C C -&gt; Label
</span><a href="#local-6989586621682820534"><span class="hs-identifier hs-var hs-var">fromNode</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BN"><span class="hs-identifier hs-type">BN</span></a></span><span> </span><span id="local-6989586621682820541"><span class="annot"><span class="annottext">(Label, [Label])
</span><a href="#local-6989586621682820541"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Label, [Label]) -&gt; Label
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Label, [Label])
</span><a href="#local-6989586621682820541"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-944"></span><span>
</span><span id="line-945"></span><span>    </span><span class="annot"><a href="#local-6989586621682820540"><span class="hs-identifier hs-type">toNode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#BlockNode"><span class="hs-identifier hs-type">BlockNode</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#C"><span class="hs-identifier hs-type">C</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Block.html#C"><span class="hs-identifier hs-type">C</span></a></span><span>
</span><span id="line-946"></span><span>    </span><span id="local-6989586621682820540"><span class="annot"><span class="annottext">toNode :: Label -&gt; BlockNode C C
</span><a href="#local-6989586621682820540"><span class="hs-identifier hs-var hs-var">toNode</span></a></span></span><span> </span><span id="local-6989586621682820542"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820542"><span class="hs-identifier hs-var">bid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-947"></span><span>        </span><span class="annot"><span class="annottext">(Label, [Label]) -&gt; BlockNode C C
forall (e :: Extensibility) (x :: Extensibility).
(Label, [Label]) -&gt; BlockNode e x
</span><a href="GHC.CmmToAsm.CFG.html#BN"><span class="hs-identifier hs-var">BN</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820542"><span class="hs-identifier hs-var">bid</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [Label]
CFG -&gt; Label -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessors"><span class="hs-identifier hs-var">getSuccessors</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820532"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">(Label -&gt; [Label]) -&gt; Label -&gt; [Label]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820542"><span class="hs-identifier hs-var">bid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span>
</span><span id="line-949"></span><span>
</span><span id="line-950"></span><span class="hs-comment">-- | We take in a CFG which has on its edges weights which are</span><span>
</span><span id="line-951"></span><span class="hs-comment">--   relative only to other edges originating from the same node.</span><span>
</span><span id="line-952"></span><span class="hs-comment">--</span><span>
</span><span id="line-953"></span><span class="hs-comment">--   We return a CFG for which each edge represents a GLOBAL weight.</span><span>
</span><span id="line-954"></span><span class="hs-comment">--   This means edge weights are comparable across the whole graph.</span><span>
</span><span id="line-955"></span><span class="hs-comment">--</span><span>
</span><span id="line-956"></span><span class="hs-comment">--   For irreducible control flow results might be imprecise, otherwise they</span><span>
</span><span id="line-957"></span><span class="hs-comment">--   are reliable.</span><span>
</span><span id="line-958"></span><span class="hs-comment">--</span><span>
</span><span id="line-959"></span><span class="hs-comment">--   The algorithm is based on the Paper</span><span>
</span><span id="line-960"></span><span class="hs-comment">--   &quot;Static Branch Prediction and Program Profile Analysis&quot; by Y Wu, JR Larus</span><span>
</span><span id="line-961"></span><span class="hs-comment">--   The only big change is that we go over the nodes in the body of loops in</span><span>
</span><span id="line-962"></span><span class="hs-comment">--   reverse post order. Which is required for diamond control flow to work probably.</span><span>
</span><span id="line-963"></span><span class="hs-comment">--</span><span>
</span><span id="line-964"></span><span class="hs-comment">--   We also apply a few prediction heuristics (based on the same paper)</span><span>
</span><span id="line-965"></span><span class="hs-comment">--</span><span>
</span><span id="line-966"></span><span class="hs-comment">--   The returned result represents frequences.</span><span>
</span><span id="line-967"></span><span class="hs-comment">--   For blocks it's the expected number of executions and</span><span>
</span><span id="line-968"></span><span class="hs-comment">--   for edges is the number of traversals.</span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#mkGlobalWeights"><span class="hs-pragma hs-type">mkGlobalWeights</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-971"></span><span class="hs-pragma">{-# SCC</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#mkGlobalWeights"><span class="hs-pragma hs-type">mkGlobalWeights</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-972"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#mkGlobalWeights"><span class="hs-identifier hs-type">mkGlobalWeights</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span id="mkGlobalWeights"><span class="annot"><span class="annottext">mkGlobalWeights :: HasDebugCallStack =&gt;
Label -&gt; CFG -&gt; (LabelMap Double, LabelMap (LabelMap Double))
</span><a href="GHC.CmmToAsm.CFG.html#mkGlobalWeights"><span class="hs-identifier hs-var hs-var">mkGlobalWeights</span></a></span></span><span> </span><span id="local-6989586621682820566"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820566"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span id="local-6989586621682820567"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820567"><span class="hs-identifier hs-var">localCfg</span></a></span></span><span>
</span><span id="line-974"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; Bool
forall a. LabelMap a -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820567"><span class="hs-identifier hs-var">localCfg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; (LabelMap Double, LabelMap (LabelMap Double))
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Error - Empty CFG&quot;</span></span><span>
</span><span id="line-975"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-976"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelMap Double
</span><a href="#local-6989586621682820568"><span class="hs-identifier hs-var">blockFreqs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LabelMap (LabelMap Double)
</span><a href="#local-6989586621682820569"><span class="hs-identifier hs-var">edgeFreqs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-977"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-978"></span><span>    </span><span class="hs-comment">-- Calculate fixpoints</span><span>
</span><span id="line-979"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682820570"><span class="annot"><span class="annottext">Array Int Double
</span><a href="#local-6989586621682820570"><span class="hs-identifier hs-var">blockFreqs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682820571"><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820571"><span class="hs-identifier hs-var">edgeFreqs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
-&gt; [(Int, Int)]
-&gt; [(Int, [Int])]
-&gt; [Int]
-&gt; (Array Int Double, IntMap (IntMap Double))
</span><a href="GHC.CmmToAsm.CFG.html#calcFreqs"><span class="hs-identifier hs-var">calcFreqs</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820573"><span class="hs-identifier hs-var">nodeProbs</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, Int)]
</span><a href="#local-6989586621682820574"><span class="hs-identifier hs-var">backEdges'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, [Int])]
</span><a href="#local-6989586621682820575"><span class="hs-identifier hs-var">bodies'</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621682820576"><span class="hs-identifier hs-var">revOrder'</span></a></span><span>
</span><span id="line-980"></span><span>    </span><span id="local-6989586621682820568"><span class="annot"><span class="annottext">blockFreqs' :: LabelMap Double
</span><a href="#local-6989586621682820568"><span class="hs-identifier hs-var hs-var">blockFreqs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, Double)] -&gt; LabelMap Double
forall v. [(Label, v)] -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(Label, Double)] -&gt; LabelMap Double)
-&gt; [(Label, Double)] -&gt; LabelMap Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Int, Double) -&gt; (Label, Double))
-&gt; [(Int, Double)] -&gt; [(Label, Double)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Label) -&gt; (Int, Double) -&gt; (Label, Double)
forall a b c. (a -&gt; b) -&gt; (a, c) -&gt; (b, c)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><a href="../../base-4.21.0.0-ae91/src/Data.Bifunctor.html#first"><span class="hs-identifier hs-var">first</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Label
</span><a href="#local-6989586621682820577"><span class="hs-identifier hs-var">fromVertex</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array Int Double -&gt; [(Int, Double)]
forall (a :: * -&gt; * -&gt; *) e i.
(IArray a e, Ix i) =&gt;
a i e -&gt; [(i, e)]
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#assocs"><span class="hs-identifier hs-var">assocs</span></a></span><span> </span><span class="annot"><span class="annottext">Array Int Double
</span><a href="#local-6989586621682820570"><span class="hs-identifier hs-var">blockFreqs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-981"></span><span>    </span><span id="local-6989586621682820569"><span class="annot"><span class="annottext">edgeFreqs' :: LabelMap (LabelMap Double)
</span><a href="#local-6989586621682820569"><span class="hs-identifier hs-var hs-var">edgeFreqs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IntMap Double -&gt; LabelMap Double)
-&gt; LabelMap (IntMap Double) -&gt; LabelMap (LabelMap Double)
forall a b. (a -&gt; b) -&gt; LabelMap a -&gt; LabelMap b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">IntMap Double -&gt; LabelMap Double
forall x. IntMap x -&gt; LabelMap x
</span><a href="#local-6989586621682820579"><span class="hs-identifier hs-var">fromVertexMap</span></a></span><span> </span><span class="annot"><span class="annottext">(LabelMap (IntMap Double) -&gt; LabelMap (LabelMap Double))
-&gt; LabelMap (IntMap Double) -&gt; LabelMap (LabelMap Double)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double) -&gt; LabelMap (IntMap Double)
forall x. IntMap x -&gt; LabelMap x
</span><a href="#local-6989586621682820579"><span class="hs-identifier hs-var">fromVertexMap</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820571"><span class="hs-identifier hs-var">edgeFreqs</span></a></span><span>
</span><span id="line-982"></span><span>
</span><span id="line-983"></span><span>    </span><span id="local-6989586621682819229"><span class="annot"><a href="#local-6989586621682820579"><span class="hs-identifier hs-type">fromVertexMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819229"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682819229"><span class="hs-identifier hs-type">x</span></a></span></span><span>
</span><span id="line-984"></span><span>    </span><span id="local-6989586621682820579"><span class="annot"><span class="annottext">fromVertexMap :: forall x. IntMap x -&gt; LabelMap x
</span><a href="#local-6989586621682820579"><span class="hs-identifier hs-var hs-var">fromVertexMap</span></a></span></span><span> </span><span id="local-6989586621682820581"><span class="annot"><span class="annottext">IntMap x
</span><a href="#local-6989586621682820581"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, x)] -&gt; LabelMap x
forall v. [(Label, v)] -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(Label, x)] -&gt; LabelMap x)
-&gt; ([(Int, x)] -&gt; [(Label, x)]) -&gt; [(Int, x)] -&gt; LabelMap x
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Int, x) -&gt; (Label, x)) -&gt; [(Int, x)] -&gt; [(Label, x)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Label) -&gt; (Int, x) -&gt; (Label, x)
forall a b c. (a -&gt; b) -&gt; (a, c) -&gt; (b, c)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><a href="../../base-4.21.0.0-ae91/src/Data.Bifunctor.html#first"><span class="hs-identifier hs-var">first</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Label
</span><a href="#local-6989586621682820577"><span class="hs-identifier hs-var">fromVertex</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Int, x)] -&gt; LabelMap x) -&gt; [(Int, x)] -&gt; LabelMap x
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntMap x -&gt; [(Int, x)]
forall a. IntMap a -&gt; [(Int, a)]
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#toList"><span class="hs-identifier hs-var">IM.toList</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap x
</span><a href="#local-6989586621682820581"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-985"></span><span>
</span><span id="line-986"></span><span>    </span><span id="local-6989586621682820583"><span class="annot"><span class="annottext">revOrder :: [Label]
</span><a href="#local-6989586621682820583"><span class="hs-identifier hs-var hs-var">revOrder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [Label]
CFG -&gt; Label -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#revPostorderFrom"><span class="hs-identifier hs-var">revPostorderFrom</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820567"><span class="hs-identifier hs-var">localCfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820566"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-987"></span><span>    </span><span id="local-6989586621682820584"><span class="annot"><span class="annottext">loopResults :: LoopInfo
</span><a href="#local-6989586621682820584"><span class="hs-identifier hs-var">loopResults</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#LoopInfo"><span class="hs-identifier hs-type">LoopInfo</span></a></span><span> </span><span id="local-6989586621682820585"><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820585"><span class="hs-identifier hs-var">backedges</span></a></span></span><span> </span><span id="local-6989586621682820586"><span class="annot"><span class="annottext">LabelMap Int
</span><a href="#local-6989586621682820586"><span class="hs-identifier hs-var">_levels</span></a></span></span><span> </span><span id="local-6989586621682820587"><span class="annot"><span class="annottext">[(Edge, LabelSet)]
</span><a href="#local-6989586621682820587"><span class="hs-identifier hs-var">bodies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; LoopInfo
CFG -&gt; Label -&gt; LoopInfo
</span><a href="GHC.CmmToAsm.CFG.html#loopInfo"><span class="hs-identifier hs-var">loopInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820567"><span class="hs-identifier hs-var">localCfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820566"><span class="hs-identifier hs-var">root</span></a></span><span>
</span><span id="line-988"></span><span>
</span><span id="line-989"></span><span>    </span><span id="local-6989586621682820576"><span class="annot"><span class="annottext">revOrder' :: [Int]
</span><a href="#local-6989586621682820576"><span class="hs-identifier hs-var hs-var">revOrder'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Label -&gt; Int) -&gt; [Label] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820588"><span class="hs-identifier hs-var">toVertex</span></a></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820583"><span class="hs-identifier hs-var">revOrder</span></a></span><span>
</span><span id="line-990"></span><span>    </span><span id="local-6989586621682820574"><span class="annot"><span class="annottext">backEdges' :: [(Int, Int)]
</span><a href="#local-6989586621682820574"><span class="hs-identifier hs-var hs-var">backEdges'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Edge -&gt; (Int, Int)) -&gt; [Edge] -&gt; [(Int, Int)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Label -&gt; Int) -&gt; (Label -&gt; Int) -&gt; Edge -&gt; (Int, Int)
forall a b c d. (a -&gt; b) -&gt; (c -&gt; d) -&gt; (a, c) -&gt; (b, d)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><a href="../../base-4.21.0.0-ae91/src/Data.Bifunctor.html#bimap"><span class="hs-identifier hs-var">bimap</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820588"><span class="hs-identifier hs-var">toVertex</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820588"><span class="hs-identifier hs-var">toVertex</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820585"><span class="hs-identifier hs-var">backedges</span></a></span><span>
</span><span id="line-991"></span><span>    </span><span id="local-6989586621682820575"><span class="annot"><span class="annottext">bodies' :: [(Int, [Int])]
</span><a href="#local-6989586621682820575"><span class="hs-identifier hs-var hs-var">bodies'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Edge, LabelSet) -&gt; (Int, [Int]))
-&gt; [(Edge, LabelSet)] -&gt; [(Int, [Int])]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Edge, LabelSet) -&gt; (Int, [Int])
forall {a}. ((a, Label), LabelSet) -&gt; (Int, [Int])
</span><a href="#local-6989586621682820590"><span class="hs-identifier hs-var">calcBody</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge, LabelSet)]
</span><a href="#local-6989586621682820587"><span class="hs-identifier hs-var">bodies</span></a></span><span>
</span><span id="line-992"></span><span>
</span><span id="line-993"></span><span>    </span><span id="local-6989586621682820591"><span class="annot"><span class="annottext">estimatedCfg :: CFG
</span><a href="#local-6989586621682820591"><span class="hs-identifier hs-var hs-var">estimatedCfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LoopInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#staticBranchPrediction"><span class="hs-identifier hs-var">staticBranchPrediction</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820566"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">LoopInfo
</span><a href="#local-6989586621682820584"><span class="hs-identifier hs-var">loopResults</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820567"><span class="hs-identifier hs-var">localCfg</span></a></span><span>
</span><span id="line-994"></span><span>    </span><span class="hs-comment">-- Normalize the weights to probabilities and apply heuristics</span><span>
</span><span id="line-995"></span><span>    </span><span id="local-6989586621682820573"><span class="annot"><span class="annottext">nodeProbs :: IntMap (IntMap Double)
</span><a href="#local-6989586621682820573"><span class="hs-identifier hs-var hs-var">nodeProbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; (Label -&gt; Int) -&gt; IntMap (IntMap Double)
</span><a href="GHC.CmmToAsm.CFG.html#cfgEdgeProbabilities"><span class="hs-identifier hs-var">cfgEdgeProbabilities</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820591"><span class="hs-identifier hs-var">estimatedCfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820588"><span class="hs-identifier hs-var">toVertex</span></a></span><span>
</span><span id="line-996"></span><span>
</span><span id="line-997"></span><span>    </span><span class="hs-comment">-- By mapping vertices to numbers in reverse post order we can bring any subset into reverse post</span><span>
</span><span id="line-998"></span><span>    </span><span class="hs-comment">-- order simply by sorting.</span><span>
</span><span id="line-999"></span><span>    </span><span class="hs-comment">-- TODO: The sort is redundant if we can guarantee that setElems returns elements ascending</span><span>
</span><span id="line-1000"></span><span>    </span><span id="local-6989586621682820590"><span class="annot"><span class="annottext">calcBody :: ((a, Label), LabelSet) -&gt; (Int, [Int])
</span><a href="#local-6989586621682820590"><span class="hs-identifier hs-var hs-var">calcBody</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820595"><span class="annot"><span class="annottext">(a, Label)
</span><a href="#local-6989586621682820595"><span class="hs-identifier hs-var">backedge</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682820596"><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820596"><span class="hs-identifier hs-var">blocks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1001"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820588"><span class="hs-identifier hs-var">toVertex</span></a></span><span> </span><span class="annot"><span class="annottext">(Label -&gt; Int) -&gt; Label -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(a, Label) -&gt; Label
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(a, Label)
</span><a href="#local-6989586621682820595"><span class="hs-identifier hs-var">backedge</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; [Int]) -&gt; ([Label] -&gt; [Int]) -&gt; [Label] -&gt; [Int]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Label -&gt; Int) -&gt; [Label] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820588"><span class="hs-identifier hs-var">toVertex</span></a></span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; [Int]) -&gt; [Label] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelSet -&gt; [Label]
</span><a href="GHC.Cmm.Dataflow.Label.html#setElems"><span class="hs-identifier hs-var">setElems</span></a></span><span> </span><span class="annot"><span class="annottext">LabelSet
</span><a href="#local-6989586621682820596"><span class="hs-identifier hs-var">blocks</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>
</span><span id="line-1003"></span><span>    </span><span id="local-6989586621682820597"><span class="annot"><span class="annottext">vertexMapping :: LabelMap Int
</span><a href="#local-6989586621682820597"><span class="hs-identifier hs-var hs-var">vertexMapping</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Label, Int)] -&gt; LabelMap Int
forall v. [(Label, v)] -&gt; LabelMap v
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(Label, Int)] -&gt; LabelMap Int) -&gt; [(Label, Int)] -&gt; LabelMap Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; [Int] -&gt; [(Label, Int)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820583"><span class="hs-identifier hs-var">revOrder</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1004"></span><span>    </span><span id="local-6989586621682820598"><span class="annot"><span class="annottext">blockMapping :: Array Int Label
</span><a href="#local-6989586621682820598"><span class="hs-identifier hs-var hs-var">blockMapping</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; [Label] -&gt; Array Int Label
forall (a :: * -&gt; * -&gt; *) e i.
(IArray a e, Ix i) =&gt;
(i, i) -&gt; [e] -&gt; a i e
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#listArray"><span class="hs-identifier hs-var">listArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">LabelMap Int -&gt; Int
forall a. LabelMap a -&gt; Int
</span><a href="GHC.Cmm.Dataflow.Label.html#mapSize"><span class="hs-identifier hs-var">mapSize</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap Int
</span><a href="#local-6989586621682820597"><span class="hs-identifier hs-var">vertexMapping</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820583"><span class="hs-identifier hs-var">revOrder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Array</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>
</span><span id="line-1005"></span><span>    </span><span class="hs-comment">-- Map from blockId to indices starting at zero</span><span>
</span><span id="line-1006"></span><span>    </span><span class="annot"><a href="#local-6989586621682820588"><span class="hs-identifier hs-type">toVertex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1007"></span><span>    </span><span id="local-6989586621682820588"><span class="annot"><span class="annottext">toVertex :: Label -&gt; Int
</span><a href="#local-6989586621682820588"><span class="hs-identifier hs-var hs-var">toVertex</span></a></span></span><span>   </span><span id="local-6989586621682820601"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820601"><span class="hs-identifier hs-var">blockId</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Int -&gt; Int
forall a. HasDebugCallStack =&gt; String -&gt; Maybe a -&gt; a
</span><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mkGlobalWeights&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Int) -&gt; Maybe Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap Int -&gt; Maybe Int
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820601"><span class="hs-identifier hs-var">blockId</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap Int
</span><a href="#local-6989586621682820597"><span class="hs-identifier hs-var">vertexMapping</span></a></span><span>
</span><span id="line-1008"></span><span>    </span><span class="hs-comment">-- Map from indices starting at zero to blockIds</span><span>
</span><span id="line-1009"></span><span>    </span><span class="annot"><a href="#local-6989586621682820577"><span class="hs-identifier hs-type">fromVertex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span>
</span><span id="line-1010"></span><span>    </span><span id="local-6989586621682820577"><span class="annot"><span class="annottext">fromVertex :: Int -&gt; Label
</span><a href="#local-6989586621682820577"><span class="hs-identifier hs-var hs-var">fromVertex</span></a></span></span><span> </span><span id="local-6989586621682820602"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820602"><span class="hs-identifier hs-var">vertex</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Array Int Label
</span><a href="#local-6989586621682820598"><span class="hs-identifier hs-var">blockMapping</span></a></span><span> </span><span class="annot"><span class="annottext">Array Int Label -&gt; Int -&gt; Label
forall (a :: * -&gt; * -&gt; *) e i.
(IArray a e, Ix i) =&gt;
a i e -&gt; i -&gt; e
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#%21"><span class="hs-operator hs-var">!</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820602"><span class="hs-identifier hs-var">vertex</span></a></span><span>
</span><span id="line-1011"></span><span>
</span><span id="line-1012"></span><span class="hs-comment">{- Note [Static Branch Prediction]
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The work here has been based on the paper
&quot;Static Branch Prediction and Program Profile Analysis&quot; by Y Wu, JR Larus.

The primary differences are that if we branch on the result of a heap
check we do not apply any of the heuristics.
The reason is simple: They look like loops in the control flow graph
but are usually never entered, and if at most once.

Currently implemented is a heuristic to predict that we do not exit
loops (lehPredicts) and one to predict that backedges are more likely
than any other edge.

The back edge case is special as it supersedes any other heuristic if it
applies.

Do NOT rely solely on nofib results for benchmarking this. I recommend at least
comparing megaparsec and container benchmarks. Nofib does not seem to have
many instances of &quot;loopy&quot; Cmm where these make a difference.

TODO:
* The paper containers more benchmarks which should be implemented.
* If we turn the likelihood on if/else branches into a probability
  instead of true/false we could implement this as a Cmm pass.
  + The complete Cmm code still exists and can be accessed by the heuristics
  + There is no chance of register allocation/codegen inserting branches/blocks
  + making the TransitionSource info wrong.
  + potential to use this information in CmmPasses.
  - Requires refactoring of all the code relying on the binary nature of likelihood.
  - Requires refactoring `loopInfo` to work on both, Cmm Graphs and the backend CFG.
-}</span><span>
</span><span id="line-1044"></span><span>
</span><span id="line-1045"></span><span class="hs-comment">-- | Combination of target node id and information about the branch</span><span>
</span><span id="line-1046"></span><span class="hs-comment">--   we are looking at.</span><span>
</span><span id="line-1047"></span><span class="hs-keyword">type</span><span> </span><span id="TargetNodeInfo"><span class="annot"><a href="GHC.CmmToAsm.CFG.html#TargetNodeInfo"><span class="hs-identifier hs-var">TargetNodeInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1048"></span><span>
</span><span id="line-1049"></span><span>
</span><span id="line-1050"></span><span class="hs-comment">-- | Update branch weights based on certain heuristics.</span><span>
</span><span id="line-1051"></span><span class="hs-comment">-- See Note [Static Branch Prediction]</span><span>
</span><span id="line-1052"></span><span class="hs-comment">-- TODO: This should be combined with optimizeCFG</span><span>
</span><span id="line-1053"></span><span class="hs-pragma">{-# SCC</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#staticBranchPrediction"><span class="hs-pragma hs-type">staticBranchPrediction</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1054"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#staticBranchPrediction"><span class="hs-identifier hs-type">staticBranchPrediction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#LoopInfo"><span class="hs-identifier hs-type">LoopInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-1055"></span><span id="staticBranchPrediction"><span class="annot"><span class="annottext">staticBranchPrediction :: Label -&gt; LoopInfo -&gt; CFG -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#staticBranchPrediction"><span class="hs-identifier hs-var hs-var">staticBranchPrediction</span></a></span></span><span> </span><span id="local-6989586621682820605"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820605"><span class="hs-identifier hs-var">_root</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#LoopInfo"><span class="hs-identifier hs-type">LoopInfo</span></a></span><span> </span><span id="local-6989586621682820606"><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820606"><span class="hs-identifier hs-var">l_backEdges</span></a></span></span><span> </span><span id="local-6989586621682820607"><span class="annot"><span class="annottext">LabelMap Int
</span><a href="#local-6989586621682820607"><span class="hs-identifier hs-var">loopLevels</span></a></span></span><span> </span><span id="local-6989586621682820608"><span class="annot"><span class="annottext">[(Edge, LabelSet)]
</span><a href="#local-6989586621682820608"><span class="hs-identifier hs-var">l_loops</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682820609"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820609"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1056"></span><span>    </span><span class="hs-comment">-- pprTrace &quot;staticEstimatesOn&quot; (ppr (cfg)) $</span><span>
</span><span id="line-1057"></span><span>    </span><span class="annot"><span class="annottext">(CFG -&gt; Label -&gt; CFG) -&gt; CFG -&gt; [Label] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; Label -&gt; CFG
</span><a href="#local-6989586621682820610"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820609"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">[Label]
</span><a href="#local-6989586621682820611"><span class="hs-identifier hs-var">nodes</span></a></span><span>
</span><span id="line-1058"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1059"></span><span>    </span><span id="local-6989586621682820611"><span class="annot"><span class="annottext">nodes :: [Label]
</span><a href="#local-6989586621682820611"><span class="hs-identifier hs-var hs-var">nodes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; [Label]
</span><a href="GHC.CmmToAsm.CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820609"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1060"></span><span>    </span><span id="local-6989586621682820612"><span class="annot"><span class="annottext">backedges :: Set Edge
</span><a href="#local-6989586621682820612"><span class="hs-identifier hs-var hs-var">backedges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Edge] -&gt; Set Edge
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">S.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Edge] -&gt; Set Edge) -&gt; [Edge] -&gt; Set Edge
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Edge]
</span><a href="#local-6989586621682820606"><span class="hs-identifier hs-var">l_backEdges</span></a></span><span>
</span><span id="line-1061"></span><span>    </span><span class="hs-comment">-- Loops keyed by their back edge</span><span>
</span><span id="line-1062"></span><span>    </span><span id="local-6989586621682820614"><span class="annot"><span class="annottext">loops :: Map Edge LabelSet
</span><a href="#local-6989586621682820614"><span class="hs-identifier hs-var hs-var">loops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Edge, LabelSet)] -&gt; Map Edge LabelSet
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../containers-0.7-5a8f/src/Data.Map.Internal.html#fromList"><span class="hs-identifier hs-var">M.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(Edge, LabelSet)] -&gt; Map Edge LabelSet)
-&gt; [(Edge, LabelSet)] -&gt; Map Edge LabelSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Edge, LabelSet)]
</span><a href="#local-6989586621682820608"><span class="hs-identifier hs-var">l_loops</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">M.Map</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a></span><span>
</span><span id="line-1063"></span><span>    </span><span id="local-6989586621682820616"><span class="annot"><span class="annottext">loopHeads :: Set Label
</span><a href="#local-6989586621682820616"><span class="hs-identifier hs-var hs-var">loopHeads</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; Set Label
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">S.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Label] -&gt; Set Label) -&gt; [Label] -&gt; Set Label
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Edge -&gt; Label) -&gt; [Edge] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Edge -&gt; Label
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([Edge] -&gt; [Label]) -&gt; [Edge] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Edge LabelSet -&gt; [Edge]
forall k a. Map k a -&gt; [k]
</span><a href="../../containers-0.7-5a8f/src/Data.Map.Internal.html#keys"><span class="hs-identifier hs-var">M.keys</span></a></span><span> </span><span class="annot"><span class="annottext">Map Edge LabelSet
</span><a href="#local-6989586621682820614"><span class="hs-identifier hs-var">loops</span></a></span><span>
</span><span id="line-1064"></span><span>
</span><span id="line-1065"></span><span>    </span><span class="annot"><a href="#local-6989586621682820610"><span class="hs-identifier hs-type">update</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-1066"></span><span>    </span><span id="local-6989586621682820610"><span class="annot"><span class="annottext">update :: CFG -&gt; Label -&gt; CFG
</span><a href="#local-6989586621682820610"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span id="local-6989586621682820618"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820618"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820619"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span></span><span>
</span><span id="line-1067"></span><span>        </span><span class="hs-comment">-- No successors, nothing to do.</span><span>
</span><span id="line-1068"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820620"><span class="hs-identifier hs-var">successors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820618"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1069"></span><span>
</span><span id="line-1070"></span><span>        </span><span class="hs-comment">-- Mix of backedges and others:</span><span>
</span><span id="line-1071"></span><span>        </span><span class="hs-comment">-- Always predict the backedges.</span><span>
</span><span id="line-1072"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Label, EdgeInfo)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820621"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820621"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820620"><span class="hs-identifier hs-var">successors</span></a></span><span>
</span><span id="line-1073"></span><span>        </span><span class="hs-comment">-- Heap/Stack checks &quot;loop&quot;, but only once.</span><span>
</span><span id="line-1074"></span><span>        </span><span class="hs-comment">-- So we simply exclude any case involving them.</span><span>
</span><span id="line-1075"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo) -&gt; Bool) -&gt; [(Label, EdgeInfo)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionSource -&gt; Bool
</span><a href="GHC.CmmToAsm.CFG.html#isHeapOrStackCheck"><span class="hs-identifier hs-var">isHeapOrStackCheck</span></a></span><span>  </span><span class="annot"><span class="annottext">(TransitionSource -&gt; Bool)
-&gt; ((Label, EdgeInfo) -&gt; TransitionSource)
-&gt; (Label, EdgeInfo)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#transitionSource"><span class="hs-identifier hs-var">transitionSource</span></a></span><span> </span><span class="annot"><span class="annottext">(EdgeInfo -&gt; TransitionSource)
-&gt; ((Label, EdgeInfo) -&gt; EdgeInfo)
-&gt; (Label, EdgeInfo)
-&gt; TransitionSource
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo) -&gt; EdgeInfo
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820620"><span class="hs-identifier hs-var">successors</span></a></span><span>
</span><span id="line-1076"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>   </span><span id="local-6989586621682820622"><span class="annot"><span class="annottext">loopChance :: [EdgeWeight]
</span><a href="#local-6989586621682820622"><span class="hs-identifier hs-var hs-var">loopChance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; [EdgeWeight]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">(EdgeWeight -&gt; [EdgeWeight]) -&gt; EdgeWeight -&gt; [EdgeWeight]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820623"><span class="hs-identifier hs-var">pred_LBH</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; EdgeWeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; EdgeWeight) -&gt; Int -&gt; EdgeWeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820621"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1077"></span><span>                </span><span id="local-6989586621682820624"><span class="annot"><span class="annottext">exitChance :: [EdgeWeight]
</span><a href="#local-6989586621682820624"><span class="hs-identifier hs-var hs-var">exitChance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; [EdgeWeight]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">(EdgeWeight -&gt; [EdgeWeight]) -&gt; EdgeWeight -&gt; [EdgeWeight]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820623"><span class="hs-identifier hs-var">pred_LBH</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; EdgeWeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Label, EdgeInfo)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820625"><span class="hs-identifier hs-var">not_m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1078"></span><span>                </span><span id="local-6989586621682820626"><span class="annot"><span class="annottext">updates :: [(Label, EdgeWeight)]
</span><a href="#local-6989586621682820626"><span class="hs-identifier hs-var hs-var">updates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; [EdgeWeight] -&gt; [(Label, EdgeWeight)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Label, EdgeInfo) -&gt; Label) -&gt; [(Label, EdgeInfo)] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo) -&gt; Label
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820621"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EdgeWeight]
</span><a href="#local-6989586621682820622"><span class="hs-identifier hs-var">loopChance</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeWeight)]
-&gt; [(Label, EdgeWeight)] -&gt; [(Label, EdgeWeight)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Label] -&gt; [EdgeWeight] -&gt; [(Label, EdgeWeight)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Label, EdgeInfo) -&gt; Label) -&gt; [(Label, EdgeInfo)] -&gt; [Label]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo) -&gt; Label
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820625"><span class="hs-identifier hs-var">not_m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EdgeWeight]
</span><a href="#local-6989586621682820624"><span class="hs-identifier hs-var">exitChance</span></a></span><span>
</span><span id="line-1079"></span><span>        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-comment">-- pprTrace &quot;mix&quot; (ppr (node,successors)) $</span><span>
</span><span id="line-1080"></span><span>            </span><span class="annot"><span class="annottext">(CFG -&gt; (Label, EdgeWeight) -&gt; CFG)
-&gt; CFG -&gt; [(Label, EdgeWeight)] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820627"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820627"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820628"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820628"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820629"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820629"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; EdgeWeight -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#setEdgeWeight"><span class="hs-identifier hs-var">setEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820627"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820629"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820628"><span class="hs-identifier hs-var">to</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820618"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeWeight)]
</span><a href="#local-6989586621682820626"><span class="hs-identifier hs-var">updates</span></a></span><span>
</span><span id="line-1081"></span><span>
</span><span id="line-1082"></span><span>        </span><span class="hs-comment">-- For (regular) non-binary branches we keep the weights from the STG -&gt; Cmm translation.</span><span>
</span><span id="line-1083"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820620"><span class="hs-identifier hs-var">successors</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-1084"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820618"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1085"></span><span>
</span><span id="line-1086"></span><span>        </span><span class="hs-comment">-- Only backedges - no need to adjust</span><span>
</span><span id="line-1087"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820621"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1088"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820618"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1089"></span><span>
</span><span id="line-1090"></span><span>        </span><span class="hs-comment">-- A regular binary branch, we can plug addition predictors in here.</span><span>
</span><span id="line-1091"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span id="local-6989586621682820630"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820630"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820631"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820631"><span class="hs-identifier hs-var">s1_info</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><span id="local-6989586621682820632"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820632"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820633"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820633"><span class="hs-identifier hs-var">s2_info</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820620"><span class="hs-identifier hs-var">successors</span></a></span><span>
</span><span id="line-1092"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo) -&gt; Bool) -&gt; [(Label, EdgeInfo)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransitionSource -&gt; Bool
</span><a href="GHC.CmmToAsm.CFG.html#isHeapOrStackCheck"><span class="hs-identifier hs-var">isHeapOrStackCheck</span></a></span><span>  </span><span class="annot"><span class="annottext">(TransitionSource -&gt; Bool)
-&gt; ((Label, EdgeInfo) -&gt; TransitionSource)
-&gt; (Label, EdgeInfo)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#transitionSource"><span class="hs-identifier hs-var">transitionSource</span></a></span><span> </span><span class="annot"><span class="annottext">(EdgeInfo -&gt; TransitionSource)
-&gt; ((Label, EdgeInfo) -&gt; EdgeInfo)
-&gt; (Label, EdgeInfo)
-&gt; TransitionSource
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo) -&gt; EdgeInfo
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820620"><span class="hs-identifier hs-var">successors</span></a></span><span>
</span><span id="line-1093"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Normalize weights to total of 1</span><span>
</span><span id="line-1094"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682820634"><span class="annot"><span class="annottext">w1 :: EdgeWeight
</span><a href="#local-6989586621682820634"><span class="hs-identifier hs-var hs-var">w1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820631"><span class="hs-identifier hs-var">s1_info</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1095"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621682820635"><span class="annot"><span class="annottext">w2 :: EdgeWeight
</span><a href="#local-6989586621682820635"><span class="hs-identifier hs-var hs-var">w2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820633"><span class="hs-identifier hs-var">s2_info</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1096"></span><span>                </span><span class="hs-comment">-- Of both weights are &lt;= 0 we set both to 0.5</span><span>
</span><span id="line-1097"></span><span>                </span><span id="local-6989586621682820636"><span class="annot"><span class="annottext">normalizeWeight :: EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820636"><span class="hs-identifier hs-var hs-var">normalizeWeight</span></a></span></span><span> </span><span id="local-6989586621682820637"><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820637"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820634"><span class="hs-identifier hs-var">w1</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820635"><span class="hs-identifier hs-var">w2</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0.5</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820637"><span class="hs-identifier hs-var">w</span></a></span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820634"><span class="hs-identifier hs-var">w1</span></a></span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820635"><span class="hs-identifier hs-var">w2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1098"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621682820638"><span class="annot"><span class="annottext">cfg' :: CFG
</span><a href="#local-6989586621682820638"><span class="hs-identifier hs-var hs-var">cfg'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; EdgeWeight -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#setEdgeWeight"><span class="hs-identifier hs-var">setEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820618"><span class="hs-identifier hs-var">cfg</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820636"><span class="hs-identifier hs-var">normalizeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820634"><span class="hs-identifier hs-var">w1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820630"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-1099"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621682820639"><span class="annot"><span class="annottext">cfg'' :: CFG
</span><a href="#local-6989586621682820639"><span class="hs-identifier hs-var hs-var">cfg''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; EdgeWeight -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#setEdgeWeight"><span class="hs-identifier hs-var">setEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820638"><span class="hs-identifier hs-var">cfg'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight
</span><a href="#local-6989586621682820636"><span class="hs-identifier hs-var">normalizeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820635"><span class="hs-identifier hs-var">w2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820632"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-1100"></span><span>
</span><span id="line-1101"></span><span>                </span><span class="hs-comment">-- Figure out which heuristics apply to these successors</span><span>
</span><span id="line-1102"></span><span>                </span><span id="local-6989586621682820640"><span class="annot"><span class="annottext">heuristics :: [Maybe Double]
</span><a href="#local-6989586621682820640"><span class="hs-identifier hs-var hs-var">heuristics</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double)
 -&gt; Maybe Double)
-&gt; [((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double]
-&gt; [Maybe Double]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double)
-&gt; ((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820630"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820631"><span class="hs-identifier hs-var">s1_info</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820632"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820633"><span class="hs-identifier hs-var">s2_info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1103"></span><span>                            </span><span class="hs-special">[</span><span class="annot"><span class="annottext">((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
</span><a href="#local-6989586621682820641"><span class="hs-identifier hs-var">lehPredicts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
forall {b} {a}. b -&gt; Maybe a
</span><a href="#local-6989586621682820642"><span class="hs-identifier hs-var">phPredicts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
</span><a href="#local-6989586621682820643"><span class="hs-identifier hs-var">ohPredicts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
forall {b} {a}. b -&gt; Maybe a
</span><a href="#local-6989586621682820644"><span class="hs-identifier hs-var">ghPredicts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
forall {b} {a}. b -&gt; Maybe a
</span><a href="#local-6989586621682820645"><span class="hs-identifier hs-var">lhhPredicts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
forall {b} {a}. b -&gt; Maybe a
</span><a href="#local-6989586621682820646"><span class="hs-identifier hs-var">chPredicts</span></a></span><span>
</span><span id="line-1104"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
forall {b} {a}. b -&gt; Maybe a
</span><a href="#local-6989586621682820647"><span class="hs-identifier hs-var">shPredicts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
forall {b} {a}. b -&gt; Maybe a
</span><a href="#local-6989586621682820648"><span class="hs-identifier hs-var">rhPredicts</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1105"></span><span>                </span><span class="hs-comment">-- Apply result of a heuristic. Argument is the likelihood</span><span>
</span><span id="line-1106"></span><span>                </span><span class="hs-comment">-- predicted for s1.</span><span>
</span><span id="line-1107"></span><span>                </span><span class="annot"><a href="#local-6989586621682820649"><span class="hs-identifier hs-type">applyHeuristic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Prob"><span class="hs-identifier hs-type">Prob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span>
</span><span id="line-1108"></span><span>                </span><span id="local-6989586621682820649"><span class="annot"><span class="annottext">applyHeuristic :: CFG -&gt; Maybe Double -&gt; CFG
</span><a href="#local-6989586621682820649"><span class="hs-identifier hs-var hs-var">applyHeuristic</span></a></span></span><span> </span><span id="local-6989586621682820650"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820650"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Double
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820650"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1109"></span><span>                </span><span class="annot"><a href="#local-6989586621682820649"><span class="hs-identifier hs-var">applyHeuristic</span></a></span><span> </span><span id="local-6989586621682820651"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820651"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820652"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820652"><span class="hs-identifier hs-var">s1_pred</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1110"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820653"><span class="hs-identifier hs-var">s1_old</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820654"><span class="hs-identifier hs-var">s2_old</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-1111"></span><span>                    </span><span class="annot"><span class="annottext">TransitionSource -&gt; Bool
</span><a href="GHC.CmmToAsm.CFG.html#isHeapOrStackCheck"><span class="hs-identifier hs-var">isHeapOrStackCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeInfo -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#transitionSource"><span class="hs-identifier hs-var">transitionSource</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820631"><span class="hs-identifier hs-var">s1_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-1112"></span><span>                    </span><span class="annot"><span class="annottext">TransitionSource -&gt; Bool
</span><a href="GHC.CmmToAsm.CFG.html#isHeapOrStackCheck"><span class="hs-identifier hs-var">isHeapOrStackCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeInfo -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#transitionSource"><span class="hs-identifier hs-var">transitionSource</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820633"><span class="hs-identifier hs-var">s2_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1113"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820651"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1114"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1115"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Predictions from heuristic</span><span>
</span><span id="line-1116"></span><span>                        </span><span id="local-6989586621682820655"><span class="annot"><span class="annottext">s1_prob :: EdgeWeight
</span><a href="#local-6989586621682820655"><span class="hs-identifier hs-var hs-var">s1_prob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-var">EdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820652"><span class="hs-identifier hs-var">s1_pred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span>
</span><span id="line-1117"></span><span>                        </span><span id="local-6989586621682820656"><span class="annot"><span class="annottext">s2_prob :: EdgeWeight
</span><a href="#local-6989586621682820656"><span class="hs-identifier hs-var hs-var">s2_prob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">1.0</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820655"><span class="hs-identifier hs-var">s1_prob</span></a></span><span>
</span><span id="line-1118"></span><span>                        </span><span class="hs-comment">-- Update</span><span>
</span><span id="line-1119"></span><span>                        </span><span id="local-6989586621682820657"><span class="annot"><span class="annottext">d :: EdgeWeight
</span><a href="#local-6989586621682820657"><span class="hs-identifier hs-var hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820653"><span class="hs-identifier hs-var">s1_old</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820655"><span class="hs-identifier hs-var">s1_prob</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820654"><span class="hs-identifier hs-var">s2_old</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820656"><span class="hs-identifier hs-var">s2_prob</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a></span><span>
</span><span id="line-1120"></span><span>                        </span><span id="local-6989586621682820658"><span class="annot"><span class="annottext">s1_prob' :: EdgeWeight
</span><a href="#local-6989586621682820658"><span class="hs-identifier hs-var hs-var">s1_prob'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820653"><span class="hs-identifier hs-var">s1_old</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820655"><span class="hs-identifier hs-var">s1_prob</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820657"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-1121"></span><span>                        </span><span class="hs-glyph">!</span><span id="local-6989586621682820659"><span class="annot"><span class="annottext">s2_prob' :: EdgeWeight
</span><a href="#local-6989586621682820659"><span class="hs-identifier hs-var hs-var">s2_prob'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820654"><span class="hs-identifier hs-var">s2_old</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820656"><span class="hs-identifier hs-var">s2_prob</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight -&gt; EdgeWeight -&gt; EdgeWeight
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820657"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-1122"></span><span>                        </span><span class="hs-glyph">!</span><span id="local-6989586621682820660"><span class="annot"><span class="annottext">cfg_s1 :: CFG
</span><a href="#local-6989586621682820660"><span class="hs-identifier hs-var hs-var">cfg_s1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; EdgeWeight -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#setEdgeWeight"><span class="hs-identifier hs-var">setEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820651"><span class="hs-identifier hs-var">cfg</span></a></span><span>    </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820658"><span class="hs-identifier hs-var">s1_prob'</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820630"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-1123"></span><span>                    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-comment">-- pprTrace &quot;Applying heuristic!&quot; (ppr (node,s1,s2) $$ ppr (s1_prob', s2_prob')) $</span><span>
</span><span id="line-1124"></span><span>                        </span><span class="annot"><span class="annottext">CFG -&gt; EdgeWeight -&gt; Label -&gt; Label -&gt; CFG
</span><a href="GHC.CmmToAsm.CFG.html#setEdgeWeight"><span class="hs-identifier hs-var">setEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820660"><span class="hs-identifier hs-var">cfg_s1</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><a href="#local-6989586621682820659"><span class="hs-identifier hs-var">s2_prob'</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820632"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-1125"></span><span>                  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1126"></span><span>                    </span><span class="hs-comment">-- Old weights</span><span>
</span><span id="line-1127"></span><span>                    </span><span id="local-6989586621682820653"><span class="annot"><span class="annottext">s1_old :: EdgeWeight
</span><a href="#local-6989586621682820653"><span class="hs-identifier hs-var hs-var">s1_old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; Label -&gt; Label -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeWeight"><span class="hs-identifier hs-var">getEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820651"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820630"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-1128"></span><span>                    </span><span id="local-6989586621682820654"><span class="annot"><span class="annottext">s2_old :: EdgeWeight
</span><a href="#local-6989586621682820654"><span class="hs-identifier hs-var hs-var">s2_old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG -&gt; Label -&gt; Label -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#getEdgeWeight"><span class="hs-identifier hs-var">getEdgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820651"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820632"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-1129"></span><span>
</span><span id="line-1130"></span><span>            </span><span class="hs-keyword">in</span><span>
</span><span id="line-1131"></span><span>            </span><span class="hs-comment">-- pprTraceIt &quot;RegularCfgResult&quot; $</span><span>
</span><span id="line-1132"></span><span>            </span><span class="annot"><span class="annottext">(CFG -&gt; Maybe Double -&gt; CFG) -&gt; CFG -&gt; [Maybe Double] -&gt; CFG
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">CFG -&gt; Maybe Double -&gt; CFG
</span><a href="#local-6989586621682820649"><span class="hs-identifier hs-var">applyHeuristic</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820639"><span class="hs-identifier hs-var">cfg''</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Double]
</span><a href="#local-6989586621682820640"><span class="hs-identifier hs-var">heuristics</span></a></span><span>
</span><span id="line-1133"></span><span>
</span><span id="line-1134"></span><span>        </span><span class="hs-comment">-- Branch on heap/stack check</span><span>
</span><span id="line-1135"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820618"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1136"></span><span>
</span><span id="line-1137"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1138"></span><span>        </span><span class="hs-comment">-- Chance that loops are taken.</span><span>
</span><span id="line-1139"></span><span>        </span><span id="local-6989586621682820623"><span class="annot"><span class="annottext">pred_LBH :: EdgeWeight
</span><a href="#local-6989586621682820623"><span class="hs-identifier hs-var hs-var">pred_LBH</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EdgeWeight
</span><span class="hs-number">0.875</span></span><span>
</span><span id="line-1140"></span><span>        </span><span class="hs-comment">-- successors</span><span>
</span><span id="line-1141"></span><span>        </span><span id="local-6989586621682820620"><span class="annot"><span class="annottext">successors :: [(Label, EdgeInfo)]
</span><a href="#local-6989586621682820620"><span class="hs-identifier hs-var hs-var">successors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
CFG -&gt; Label -&gt; [(Label, EdgeInfo)]
</span><a href="GHC.CmmToAsm.CFG.html#getSuccessorEdges"><span class="hs-identifier hs-var">getSuccessorEdges</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820618"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-1142"></span><span>        </span><span class="hs-comment">-- backedges</span><span>
</span><span id="line-1143"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682820621"><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820621"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820625"><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820625"><span class="hs-identifier hs-var">not_m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Label, EdgeInfo) -&gt; Bool)
-&gt; [(Label, EdgeInfo)]
-&gt; ([(Label, EdgeInfo)], [(Label, EdgeInfo)])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">partition</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820663"><span class="annot"><span class="annottext">(Label, EdgeInfo)
</span><a href="#local-6989586621682820663"><span class="hs-identifier hs-var">succ</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Edge -&gt; Set Edge -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#member"><span class="hs-identifier hs-var">S.member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo) -&gt; Label
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo)
</span><a href="#local-6989586621682820663"><span class="hs-identifier hs-var">succ</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set Edge
</span><a href="#local-6989586621682820612"><span class="hs-identifier hs-var">backedges</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Label, EdgeInfo)]
</span><a href="#local-6989586621682820620"><span class="hs-identifier hs-var">successors</span></a></span><span>
</span><span id="line-1144"></span><span>
</span><span id="line-1145"></span><span>        </span><span class="hs-comment">-- Heuristics return nothing if they don't say anything about this branch</span><span>
</span><span id="line-1146"></span><span>        </span><span class="hs-comment">-- or Just (prob_s1) where prob_s1 is the likelihood for s1 to be the</span><span>
</span><span id="line-1147"></span><span>        </span><span class="hs-comment">-- taken branch. s1 is the branch in the true case.</span><span>
</span><span id="line-1148"></span><span>
</span><span id="line-1149"></span><span>        </span><span class="hs-comment">-- Loop exit heuristic.</span><span>
</span><span id="line-1150"></span><span>        </span><span class="hs-comment">-- We are unlikely to leave a loop unless it's to enter another one.</span><span>
</span><span id="line-1151"></span><span>        </span><span id="local-6989586621682820667"><span class="annot"><span class="annottext">pred_LEH :: Double
</span><a href="#local-6989586621682820667"><span class="hs-identifier hs-var hs-var">pred_LEH</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.75</span></span><span>
</span><span id="line-1152"></span><span>        </span><span class="hs-comment">-- If and only if no successor is a loopheader,</span><span>
</span><span id="line-1153"></span><span>        </span><span class="hs-comment">-- then we will likely not exit the current loop body.</span><span>
</span><span id="line-1154"></span><span>        </span><span class="annot"><a href="#local-6989586621682820641"><span class="hs-identifier hs-type">lehPredicts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#TargetNodeInfo"><span class="hs-identifier hs-type">TargetNodeInfo</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#TargetNodeInfo"><span class="hs-identifier hs-type">TargetNodeInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Prob"><span class="hs-identifier hs-type">Prob</span></a></span><span>
</span><span id="line-1155"></span><span>        </span><span id="local-6989586621682820641"><span class="annot"><span class="annottext">lehPredicts :: ((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
</span><a href="#local-6989586621682820641"><span class="hs-identifier hs-var hs-var">lehPredicts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682820668"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820668"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820669"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820669"><span class="hs-identifier hs-var">_s1_info</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><span id="local-6989586621682820670"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820670"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820671"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820671"><span class="hs-identifier hs-var">_s2_info</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1156"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Set Label -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#member"><span class="hs-identifier hs-var">S.member</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820668"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">Set Label
</span><a href="#local-6989586621682820616"><span class="hs-identifier hs-var">loopHeads</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Set Label -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#member"><span class="hs-identifier hs-var">S.member</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820670"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">Set Label
</span><a href="#local-6989586621682820616"><span class="hs-identifier hs-var">loopHeads</span></a></span><span>
</span><span id="line-1157"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Double
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1158"></span><span>
</span><span id="line-1159"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1160"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">--pprTrace &quot;lehPredict:&quot; (ppr $ compare s1Level s2Level) $</span><span>
</span><span id="line-1161"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Maybe Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621682820672"><span class="hs-identifier hs-var">s1Level</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621682820673"><span class="hs-identifier hs-var">s2Level</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1162"></span><span>                </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">EQ</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Double
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1163"></span><span>                </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">LT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Double -&gt; Maybe Double
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">1</span></span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820667"><span class="hs-identifier hs-var">pred_LEH</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">--s1 exits to a shallower loop level (exits loop)</span><span>
</span><span id="line-1164"></span><span>                </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Double -&gt; Maybe Double
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820667"><span class="hs-identifier hs-var">pred_LEH</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">--s1 exits to a deeper loop level</span><span>
</span><span id="line-1165"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-1166"></span><span>                </span><span id="local-6989586621682820672"><span class="annot"><span class="annottext">s1Level :: Maybe Int
</span><a href="#local-6989586621682820672"><span class="hs-identifier hs-var hs-var">s1Level</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap Int -&gt; Maybe Int
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820668"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap Int
</span><a href="#local-6989586621682820607"><span class="hs-identifier hs-var">loopLevels</span></a></span><span>
</span><span id="line-1167"></span><span>                </span><span id="local-6989586621682820673"><span class="annot"><span class="annottext">s2Level :: Maybe Int
</span><a href="#local-6989586621682820673"><span class="hs-identifier hs-var hs-var">s2Level</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap Int -&gt; Maybe Int
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820670"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap Int
</span><a href="#local-6989586621682820607"><span class="hs-identifier hs-var">loopLevels</span></a></span><span>
</span><span id="line-1168"></span><span>
</span><span id="line-1169"></span><span>        </span><span class="hs-comment">-- Comparing to a constant is unlikely to be equal.</span><span>
</span><span id="line-1170"></span><span>        </span><span id="local-6989586621682820643"><span class="annot"><span class="annottext">ohPredicts :: ((Label, EdgeInfo), (Label, EdgeInfo)) -&gt; Maybe Double
</span><a href="#local-6989586621682820643"><span class="hs-identifier hs-var hs-var">ohPredicts</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682820674"><span class="annot"><span class="annottext">(Label, EdgeInfo)
</span><a href="#local-6989586621682820674"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820675"><span class="annot"><span class="annottext">(Label, EdgeInfo)
</span><a href="#local-6989586621682820675"><span class="hs-identifier hs-var">_s2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CmmSource"><span class="hs-identifier hs-type">CmmSource</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">trans_cmmNode :: TransitionSource -&gt; CmmNode O C
</span><a href="GHC.CmmToAsm.CFG.html#trans_cmmNode"><span class="hs-identifier hs-var">trans_cmmNode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682820676"><span class="annot"><span class="annottext">CmmNode O C
</span><a href="#local-6989586621682820676"><span class="hs-identifier hs-var">src1</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; CFG -&gt; TransitionSource
</span><a href="GHC.CmmToAsm.CFG.html#getTransitionSource"><span class="hs-identifier hs-var">getTransitionSource</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820619"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Label, EdgeInfo) -&gt; Label
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo)
</span><a href="#local-6989586621682820674"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820618"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1172"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Cmm.Node.html#CmmCondBranch"><span class="hs-identifier hs-type">CmmCondBranch</span></a></span><span> </span><span id="local-6989586621682820685"><span class="annot"><span class="annottext">CmmExpr
</span><a href="#local-6989586621682820685"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621682820686"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820686"><span class="hs-identifier hs-var">ltrue</span></a></span></span><span> </span><span id="local-6989586621682820687"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820687"><span class="hs-identifier hs-var">_lfalse</span></a></span></span><span> </span><span id="local-6989586621682820688"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621682820688"><span class="hs-identifier hs-var">likely</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CmmNode O C
</span><a href="#local-6989586621682820676"><span class="hs-identifier hs-var">src1</span></a></span><span>
</span><span id="line-1173"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621682820688"><span class="hs-identifier hs-var">likely</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Bool -&gt; Maybe Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1174"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Cmm.Expr.html#CmmMachOp"><span class="hs-identifier hs-type">CmmMachOp</span></a></span><span> </span><span id="local-6989586621682820690"><span class="annot"><span class="annottext">MachOp
</span><a href="#local-6989586621682820690"><span class="hs-identifier hs-var">mop</span></a></span></span><span> </span><span id="local-6989586621682820691"><span class="annot"><span class="annottext">[CmmExpr]
</span><a href="#local-6989586621682820691"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CmmExpr
</span><a href="#local-6989586621682820685"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-1175"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Cmm.MachOp.html#MO_Eq"><span class="hs-identifier hs-type">MO_Eq</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MachOp
</span><a href="#local-6989586621682820690"><span class="hs-identifier hs-var">mop</span></a></span><span>
</span><span id="line-1176"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CmmExpr] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CmmExpr
</span><a href="#local-6989586621682820693"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682820693"><span class="annot"><span class="annottext">x :: CmmExpr
</span><a href="#local-6989586621682820693"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Cmm.Expr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CmmExpr]
</span><a href="#local-6989586621682820691"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1177"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo) -&gt; Label
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Label, EdgeInfo)
</span><a href="#local-6989586621682820674"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">Label -&gt; Label -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820686"><span class="hs-identifier hs-var">ltrue</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Double -&gt; Maybe Double
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.3</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Double -&gt; Maybe Double
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.7</span></span><span>
</span><span id="line-1178"></span><span>
</span><span id="line-1179"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1180"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Double
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1181"></span><span>
</span><span id="line-1182"></span><span>        </span><span class="hs-comment">-- TODO: These are all the other heuristics from the paper.</span><span>
</span><span id="line-1183"></span><span>        </span><span class="hs-comment">-- Not all will apply, for now we just stub them out as Nothing.</span><span>
</span><span id="line-1184"></span><span>        </span><span id="local-6989586621682820642"><span class="annot"><span class="annottext">phPredicts :: b -&gt; Maybe a
</span><a href="#local-6989586621682820642"><span class="hs-identifier hs-var hs-var">phPredicts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; b -&gt; Maybe a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1185"></span><span>        </span><span id="local-6989586621682820644"><span class="annot"><span class="annottext">ghPredicts :: b -&gt; Maybe a
</span><a href="#local-6989586621682820644"><span class="hs-identifier hs-var hs-var">ghPredicts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; b -&gt; Maybe a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1186"></span><span>        </span><span id="local-6989586621682820645"><span class="annot"><span class="annottext">lhhPredicts :: b -&gt; Maybe a
</span><a href="#local-6989586621682820645"><span class="hs-identifier hs-var hs-var">lhhPredicts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; b -&gt; Maybe a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1187"></span><span>        </span><span id="local-6989586621682820646"><span class="annot"><span class="annottext">chPredicts :: b -&gt; Maybe a
</span><a href="#local-6989586621682820646"><span class="hs-identifier hs-var hs-var">chPredicts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; b -&gt; Maybe a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1188"></span><span>        </span><span id="local-6989586621682820647"><span class="annot"><span class="annottext">shPredicts :: b -&gt; Maybe a
</span><a href="#local-6989586621682820647"><span class="hs-identifier hs-var hs-var">shPredicts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; b -&gt; Maybe a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1189"></span><span>        </span><span id="local-6989586621682820648"><span class="annot"><span class="annottext">rhPredicts :: b -&gt; Maybe a
</span><a href="#local-6989586621682820648"><span class="hs-identifier hs-var hs-var">rhPredicts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; b -&gt; Maybe a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1190"></span><span>
</span><span id="line-1191"></span><span class="hs-comment">-- We normalize all edge weights as probabilities between 0 and 1.</span><span>
</span><span id="line-1192"></span><span class="hs-comment">-- Ignoring rounding errors all outgoing edges sum up to 1.</span><span>
</span><span id="line-1193"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#cfgEdgeProbabilities"><span class="hs-identifier hs-type">cfgEdgeProbabilities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Prob"><span class="hs-identifier hs-type">Prob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1194"></span><span id="cfgEdgeProbabilities"><span class="annot"><span class="annottext">cfgEdgeProbabilities :: CFG -&gt; (Label -&gt; Int) -&gt; IntMap (IntMap Double)
</span><a href="GHC.CmmToAsm.CFG.html#cfgEdgeProbabilities"><span class="hs-identifier hs-var hs-var">cfgEdgeProbabilities</span></a></span></span><span> </span><span id="local-6989586621682820696"><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820696"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682820697"><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820697"><span class="hs-identifier hs-var">toVertex</span></a></span></span><span>
</span><span id="line-1195"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IntMap (IntMap Double)
 -&gt; Label -&gt; LabelMap EdgeInfo -&gt; IntMap (IntMap Double))
-&gt; IntMap (IntMap Double) -&gt; CFG -&gt; IntMap (IntMap Double)
forall t b. (t -&gt; Label -&gt; b -&gt; t) -&gt; t -&gt; LabelMap b -&gt; t
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
-&gt; Label -&gt; LabelMap EdgeInfo -&gt; IntMap (IntMap Double)
</span><a href="#local-6989586621682820698"><span class="hs-identifier hs-var">foldEdges</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
forall a. IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#empty"><span class="hs-identifier hs-var">IM.empty</span></a></span><span> </span><span class="annot"><span class="annottext">CFG
</span><a href="#local-6989586621682820696"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1196"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1197"></span><span>    </span><span id="local-6989586621682820698"><span class="annot"><span class="annottext">foldEdges :: IntMap (IntMap Double)
-&gt; Label -&gt; LabelMap EdgeInfo -&gt; IntMap (IntMap Double)
</span><a href="#local-6989586621682820698"><span class="hs-identifier hs-var hs-var">foldEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820700"><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820700"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820701"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820701"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820702"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820702"><span class="hs-identifier hs-var">toMap</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; IntMap Double
-&gt; IntMap (IntMap Double)
-&gt; IntMap (IntMap Double)
forall a. Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Strict.Internal.html#insert"><span class="hs-identifier hs-var">IM.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820697"><span class="hs-identifier hs-var">toVertex</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820701"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; IntMap Double
</span><a href="#local-6989586621682820704"><span class="hs-identifier hs-var">normalize</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820702"><span class="hs-identifier hs-var">toMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820700"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1198"></span><span>
</span><span id="line-1199"></span><span>    </span><span class="annot"><a href="#local-6989586621682820704"><span class="hs-identifier hs-type">normalize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Cmm.Dataflow.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Prob"><span class="hs-identifier hs-type">Prob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1200"></span><span>    </span><span id="local-6989586621682820704"><span class="annot"><span class="annottext">normalize :: LabelMap EdgeInfo -&gt; IntMap Double
</span><a href="#local-6989586621682820704"><span class="hs-identifier hs-var hs-var">normalize</span></a></span></span><span> </span><span id="local-6989586621682820705"><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820705"><span class="hs-identifier hs-var">weightMap</span></a></span></span><span>
</span><span id="line-1201"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820706"><span class="hs-identifier hs-var">edgeCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IntMap Double -&gt; Label -&gt; EdgeInfo -&gt; IntMap Double)
-&gt; IntMap Double -&gt; LabelMap EdgeInfo -&gt; IntMap Double
forall t b. (t -&gt; Label -&gt; b -&gt; t) -&gt; t -&gt; LabelMap b -&gt; t
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820707"><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820707"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820708"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820708"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double -&gt; IntMap Double -&gt; IntMap Double
forall a. Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Strict.Internal.html#insert"><span class="hs-identifier hs-var">IM.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820697"><span class="hs-identifier hs-var">toVertex</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820708"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">1.0</span></span><span> </span><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820707"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap Double
forall a. IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#empty"><span class="hs-identifier hs-var">IM.empty</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820705"><span class="hs-identifier hs-var">weightMap</span></a></span><span>
</span><span id="line-1202"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IntMap Double -&gt; Label -&gt; EdgeInfo -&gt; IntMap Double)
-&gt; IntMap Double -&gt; LabelMap EdgeInfo -&gt; IntMap Double
forall t b. (t -&gt; Label -&gt; b -&gt; t) -&gt; t -&gt; LabelMap b -&gt; t
</span><a href="GHC.Cmm.Dataflow.Label.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820709"><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820709"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820710"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820710"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double -&gt; IntMap Double -&gt; IntMap Double
forall a. Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Strict.Internal.html#insert"><span class="hs-identifier hs-var">IM.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Int
</span><a href="#local-6989586621682820697"><span class="hs-identifier hs-var">toVertex</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820710"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Label -&gt; Double
</span><a href="#local-6989586621682820711"><span class="hs-identifier hs-var">normalWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820710"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820709"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap Double
forall a. IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#empty"><span class="hs-identifier hs-var">IM.empty</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820705"><span class="hs-identifier hs-var">weightMap</span></a></span><span>
</span><span id="line-1203"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1204"></span><span>        </span><span id="local-6989586621682820706"><span class="annot"><span class="annottext">edgeCount :: Int
</span><a href="#local-6989586621682820706"><span class="hs-identifier hs-var hs-var">edgeCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo -&gt; Int
forall a. LabelMap a -&gt; Int
</span><a href="GHC.Cmm.Dataflow.Label.html#mapSize"><span class="hs-identifier hs-var">mapSize</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820705"><span class="hs-identifier hs-var">weightMap</span></a></span><span>
</span><span id="line-1205"></span><span>        </span><span class="hs-comment">-- Negative weights are generally allowed but are mapped to zero.</span><span>
</span><span id="line-1206"></span><span>        </span><span class="hs-comment">-- We then check if there is at least one non-zero edge and if not</span><span>
</span><span id="line-1207"></span><span>        </span><span class="hs-comment">-- assign uniform weights to all branches.</span><span>
</span><span id="line-1208"></span><span>        </span><span id="local-6989586621682820712"><span class="annot"><span class="annottext">minWeight :: Double
</span><a href="#local-6989586621682820712"><span class="hs-identifier hs-var hs-var">minWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Prob"><span class="hs-identifier hs-type">Prob</span></a></span><span>
</span><span id="line-1209"></span><span>        </span><span id="local-6989586621682820713"><span class="annot"><span class="annottext">weightMap' :: LabelMap Double
</span><a href="#local-6989586621682820713"><span class="hs-identifier hs-var hs-var">weightMap'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EdgeInfo -&gt; Double) -&gt; LabelMap EdgeInfo -&gt; LabelMap Double
forall a b. (a -&gt; b) -&gt; LabelMap a -&gt; LabelMap b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820714"><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820714"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeWeight -&gt; Double
</span><a href="GHC.CmmToAsm.CFG.html#weightToDouble"><span class="hs-identifier hs-var">weightToDouble</span></a></span><span> </span><span class="annot"><span class="annottext">(EdgeWeight -&gt; Double)
-&gt; (EdgeInfo -&gt; EdgeWeight) -&gt; EdgeInfo -&gt; Double
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo -&gt; EdgeWeight
</span><a href="GHC.CmmToAsm.CFG.html#edgeWeight"><span class="hs-identifier hs-var">edgeWeight</span></a></span><span> </span><span class="annot"><span class="annottext">(EdgeInfo -&gt; Double) -&gt; EdgeInfo -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EdgeInfo
</span><a href="#local-6989586621682820714"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820712"><span class="hs-identifier hs-var">minWeight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LabelMap EdgeInfo
</span><a href="#local-6989586621682820705"><span class="hs-identifier hs-var">weightMap</span></a></span><span>
</span><span id="line-1210"></span><span>        </span><span id="local-6989586621682820715"><span class="annot"><span class="annottext">totalWeight :: Double
</span><a href="#local-6989586621682820715"><span class="hs-identifier hs-var hs-var">totalWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LabelMap Double -&gt; Double
forall a. Num a =&gt; LabelMap a -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">LabelMap Double
</span><a href="#local-6989586621682820713"><span class="hs-identifier hs-var">weightMap'</span></a></span><span>
</span><span id="line-1211"></span><span>
</span><span id="line-1212"></span><span>        </span><span class="annot"><a href="#local-6989586621682820711"><span class="hs-identifier hs-type">normalWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Cmm.BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Prob"><span class="hs-identifier hs-type">Prob</span></a></span><span>
</span><span id="line-1213"></span><span>        </span><span id="local-6989586621682820711"><span class="annot"><span class="annottext">normalWeight :: Label -&gt; Double
</span><a href="#local-6989586621682820711"><span class="hs-identifier hs-var hs-var">normalWeight</span></a></span></span><span> </span><span id="local-6989586621682820717"><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820717"><span class="hs-identifier hs-var">bid</span></a></span></span><span>
</span><span id="line-1214"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820715"><span class="hs-identifier hs-var">totalWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1215"></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">1.0</span></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820706"><span class="hs-identifier hs-var">edgeCount</span></a></span><span>
</span><span id="line-1216"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682820718"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820718"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Label -&gt; LabelMap Double -&gt; Maybe Double
forall a. Label -&gt; LabelMap a -&gt; Maybe a
</span><a href="GHC.Cmm.Dataflow.Label.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Label
</span><a href="#local-6989586621682820717"><span class="hs-identifier hs-var">bid</span></a></span><span> </span><span class="annot"><span class="annottext">LabelMap Double
</span><a href="#local-6989586621682820713"><span class="hs-identifier hs-var">weightMap'</span></a></span><span>
</span><span id="line-1217"></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820718"><span class="hs-identifier hs-var">w</span></a></span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820715"><span class="hs-identifier hs-var">totalWeight</span></a></span><span>
</span><span id="line-1218"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Double
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;impossible&quot;</span></span><span>
</span><span id="line-1219"></span><span>
</span><span id="line-1220"></span><span class="hs-comment">-- This is the fixpoint algorithm from</span><span>
</span><span id="line-1221"></span><span class="hs-comment">--   &quot;Static Branch Prediction and Program Profile Analysis&quot; by Y Wu, JR Larus</span><span>
</span><span id="line-1222"></span><span class="hs-comment">-- The adaption to Haskell is my own.</span><span>
</span><span id="line-1223"></span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#calcFreqs"><span class="hs-identifier hs-type">calcFreqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Prob"><span class="hs-identifier hs-type">Prob</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span>
</span><span id="line-1224"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Array</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="annot"><a href="GHC.CmmToAsm.CFG.html#Prob"><span class="hs-identifier hs-type">Prob</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1225"></span><span id="calcFreqs"><span class="annot"><span class="annottext">calcFreqs :: IntMap (IntMap Double)
-&gt; [(Int, Int)]
-&gt; [(Int, [Int])]
-&gt; [Int]
-&gt; (Array Int Double, IntMap (IntMap Double))
</span><a href="GHC.CmmToAsm.CFG.html#calcFreqs"><span class="hs-identifier hs-var hs-var">calcFreqs</span></a></span></span><span> </span><span id="local-6989586621682820719"><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820719"><span class="hs-identifier hs-var">graph</span></a></span></span><span> </span><span id="local-6989586621682820720"><span class="annot"><span class="annottext">[(Int, Int)]
</span><a href="#local-6989586621682820720"><span class="hs-identifier hs-var">backEdges</span></a></span></span><span> </span><span id="local-6989586621682820721"><span class="annot"><span class="annottext">[(Int, [Int])]
</span><a href="#local-6989586621682820721"><span class="hs-identifier hs-var">loops</span></a></span></span><span> </span><span id="local-6989586621682820722"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621682820722"><span class="hs-identifier hs-var">revPostOrder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall s. ST s (Array Int Double, IntMap (IntMap Double)))
-&gt; (Array Int Double, IntMap (IntMap Double))
forall a. (forall s. ST s a) -&gt; a
</span><span class="hs-identifier hs-var">runST</span></span><span> </span><span class="annot"><span class="annottext">((forall s. ST s (Array Int Double, IntMap (IntMap Double)))
 -&gt; (Array Int Double, IntMap (IntMap Double)))
-&gt; (forall s. ST s (Array Int Double, IntMap (IntMap Double)))
-&gt; (Array Int Double, IntMap (IntMap Double))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1226"></span><span>    </span><span id="local-6989586621682820822"><span id="local-6989586621682820823"><span class="annot"><a href="#local-6989586621682820823"><span class="hs-identifier hs-var">visitedNodes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; Bool -&gt; ST s (STUArray s Int Bool)
forall i. Ix i =&gt; (i, i) -&gt; Bool -&gt; ST s (STUArray s i Bool)
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
(i, i) -&gt; e -&gt; m (a i e)
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#newArray"><span class="hs-identifier hs-var">newArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820830"><span class="hs-identifier hs-var">nodeCount</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621682820822"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#STUArray"><span class="hs-identifier hs-type">STUArray</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820822"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-1227"></span><span>    </span><span id="local-6989586621682820831"><span id="local-6989586621682820832"><span class="annot"><a href="#local-6989586621682820832"><span class="hs-identifier hs-var">blockFreqs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#newArray"><span class="hs-identifier hs-type">newArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682820830"><span class="hs-identifier hs-type">nodeCount</span></a></span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-number">0.0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621682820831"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#STUArray"><span class="hs-identifier hs-type">STUArray</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820831"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-1228"></span><span>    </span><span id="local-6989586621682820839"><span class="annot"><a href="#local-6989586621682820839"><span class="hs-identifier hs-var">edgeProbs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newSTRef</span></span><span> </span><span class="annot"><a href="#local-6989586621682820719"><span class="hs-identifier hs-type">graph</span></a></span><span>
</span><span id="line-1229"></span><span>    </span><span id="local-6989586621682820841"><span class="annot"><a href="#local-6989586621682820841"><span class="hs-identifier hs-var">edgeBackProbs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newSTRef</span></span><span> </span><span class="annot"><a href="#local-6989586621682820719"><span class="hs-identifier hs-type">graph</span></a></span><span>
</span><span id="line-1230"></span><span>
</span><span id="line-1231"></span><span>    </span><span class="hs-comment">-- let traceArray a = do</span><span>
</span><span id="line-1232"></span><span>    </span><span class="hs-comment">--       vs &lt;- forM [0..nodeCount-1] $ \i -&gt; readArray a i &gt;&gt;= (\v -&gt; return (i,v))</span><span>
</span><span id="line-1233"></span><span>          </span><span class="hs-comment">-- trace (&quot;array: &quot; ++ show vs) $ return ()</span><span>
</span><span id="line-1234"></span><span>
</span><span id="line-1235"></span><span>    </span><span class="hs-keyword">let</span><span>  </span><span class="hs-comment">-- See #1600, we need to inline or unboxing makes perf worse.</span><span>
</span><span id="line-1236"></span><span>        </span><span class="hs-comment">-- {-# INLINE getFreq #-}</span><span>
</span><span id="line-1237"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621682820842"><span class="hs-pragma hs-type">visited</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1238"></span><span>        </span><span id="local-6989586621682820842"><span class="annot"><a href="#local-6989586621682820842"><span class="hs-identifier hs-var hs-var">visited</span></a></span></span><span> </span><span id="local-6989586621682820843"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820843"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool -&gt; Int -&gt; ST s Bool
forall i. Ix i =&gt; STUArray s i Bool -&gt; Int -&gt; ST s Bool
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; m e
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeRead"><span class="hs-identifier hs-var">unsafeRead</span></a></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool
</span><a href="#local-6989586621682820823"><span class="hs-identifier hs-var">visitedNodes</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820843"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1239"></span><span>        </span><span id="local-6989586621682820844"><span class="annot"><a href="#local-6989586621682820844"><span class="hs-identifier hs-var hs-var">getFreq</span></a></span></span><span> </span><span id="local-6989586621682820845"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820845"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Double -&gt; Int -&gt; ST s Double
forall i. Ix i =&gt; STUArray s i Double -&gt; Int -&gt; ST s Double
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; m e
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeRead"><span class="hs-identifier hs-var">unsafeRead</span></a></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Double
</span><a href="#local-6989586621682820832"><span class="hs-identifier hs-var">blockFreqs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820845"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1240"></span><span>        </span><span class="hs-comment">-- setFreq :: forall s. Int -&gt; Double -&gt; ST s ()</span><span>
</span><span id="line-1241"></span><span>        </span><span id="local-6989586621682820846"><span class="annot"><a href="#local-6989586621682820846"><span class="hs-identifier hs-var hs-var">setFreq</span></a></span></span><span> </span><span id="local-6989586621682820847"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820847"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682820848"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820848"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Double -&gt; Int -&gt; Double -&gt; ST s ()
forall i. Ix i =&gt; STUArray s i Double -&gt; Int -&gt; Double -&gt; ST s ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeWrite"><span class="hs-identifier hs-var">unsafeWrite</span></a></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Double
</span><a href="#local-6989586621682820832"><span class="hs-identifier hs-var">blockFreqs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820847"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820848"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1242"></span><span>        </span><span class="hs-comment">-- setVisited :: forall s. Node -&gt; ST s ()</span><span>
</span><span id="line-1243"></span><span>        </span><span id="local-6989586621682820849"><span class="annot"><a href="#local-6989586621682820849"><span class="hs-identifier hs-var hs-var">setVisited</span></a></span></span><span> </span><span id="local-6989586621682820850"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820850"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool -&gt; Int -&gt; Bool -&gt; ST s ()
forall i. Ix i =&gt; STUArray s i Bool -&gt; Int -&gt; Bool -&gt; ST s ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeWrite"><span class="hs-identifier hs-var">unsafeWrite</span></a></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool
</span><a href="#local-6989586621682820823"><span class="hs-identifier hs-var">visitedNodes</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820850"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1244"></span><span>        </span><span class="hs-comment">-- Frequency/probability that edge is taken.</span><span>
</span><span id="line-1245"></span><span>        </span><span id="local-6989586621682820857"><span class="annot"><a href="#local-6989586621682820857"><span class="hs-identifier hs-var hs-var">getProb'</span></a></span></span><span> </span><span id="local-6989586621682820858"><span class="annot"><span class="annottext">STRef s (IntMap (IntMap b))
</span><a href="#local-6989586621682820858"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621682820859"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820859"><span class="hs-identifier hs-var">b1</span></a></span></span><span> </span><span id="local-6989586621682820860"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820860"><span class="hs-identifier hs-var">b2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap b)) -&gt; ST s (IntMap (IntMap b))
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap b))
</span><a href="#local-6989586621682820858"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">ST s (IntMap (IntMap b)) -&gt; (IntMap (IntMap b) -&gt; ST s b) -&gt; ST s b
forall a b. ST s a -&gt; (a -&gt; ST s b) -&gt; ST s b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span>
</span><span id="line-1246"></span><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820862"><span class="annot"><span class="annottext">IntMap (IntMap b)
</span><a href="#local-6989586621682820862"><span class="hs-identifier hs-var">graph</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1247"></span><span>                </span><span class="annot"><span class="annottext">b -&gt; ST s b
forall a. a -&gt; ST s a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(b -&gt; ST s b)
-&gt; (Maybe (IntMap b) -&gt; b) -&gt; Maybe (IntMap b) -&gt; ST s b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-1248"></span><span>                        </span><span class="annot"><span class="annottext">b -&gt; Maybe b -&gt; b
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; b
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getFreq 1&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe b -&gt; b)
-&gt; (Maybe (IntMap b) -&gt; Maybe b) -&gt; Maybe (IntMap b) -&gt; b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-1249"></span><span>                        </span><span class="annot"><span class="annottext">Int -&gt; IntMap b -&gt; Maybe b
forall a. Int -&gt; IntMap a -&gt; Maybe a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#lookup"><span class="hs-identifier hs-var">IM.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820860"><span class="hs-identifier hs-var">b2</span></a></span><span> </span><span class="annot"><span class="annottext">(IntMap b -&gt; Maybe b)
-&gt; (Maybe (IntMap b) -&gt; IntMap b) -&gt; Maybe (IntMap b) -&gt; Maybe b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-1250"></span><span>                        </span><span class="annot"><span class="annottext">IntMap b -&gt; Maybe (IntMap b) -&gt; IntMap b
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; IntMap b
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getFreq 2&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (IntMap b) -&gt; ST s b) -&gt; Maybe (IntMap b) -&gt; ST s b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1251"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; IntMap (IntMap b) -&gt; Maybe (IntMap b)
forall a. Int -&gt; IntMap a -&gt; Maybe a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#lookup"><span class="hs-identifier hs-var">IM.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820859"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap b)
</span><a href="#local-6989586621682820862"><span class="hs-identifier hs-var">graph</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1252"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-1253"></span><span>        </span><span id="local-6989586621682820869"><span class="annot"><a href="#local-6989586621682820869"><span class="hs-identifier hs-var hs-var">setProb'</span></a></span></span><span> </span><span id="local-6989586621682820870"><span class="annot"><span class="annottext">STRef s (IntMap (IntMap a))
</span><a href="#local-6989586621682820870"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621682820871"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820871"><span class="hs-identifier hs-var">b1</span></a></span></span><span> </span><span id="local-6989586621682820872"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820872"><span class="hs-identifier hs-var">b2</span></a></span></span><span> </span><span id="local-6989586621682820873"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682820873"><span class="hs-identifier hs-var">prob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1254"></span><span>          </span><span id="local-6989586621682820874"><span class="annot"><a href="#local-6989586621682820874"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap a)) -&gt; ST s (IntMap (IntMap a))
forall s a. STRef s a -&gt; ST s a
</span><span class="hs-identifier hs-var">readSTRef</span></span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap a))
</span><a href="#local-6989586621682820870"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1255"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682820875"><span class="annot"><a href="#local-6989586621682820875"><span class="hs-identifier hs-var hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap a -&gt; Maybe (IntMap a) -&gt; IntMap a
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; IntMap a
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Foo&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (IntMap a) -&gt; IntMap a) -&gt; Maybe (IntMap a) -&gt; IntMap a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntMap (IntMap a) -&gt; Maybe (IntMap a)
forall a. Int -&gt; IntMap a -&gt; Maybe a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#lookup"><span class="hs-identifier hs-var">IM.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820871"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap a)
</span><a href="#local-6989586621682820874"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-1256"></span><span>              </span><span class="hs-glyph">!</span><span id="local-6989586621682820876"><span class="annot"><a href="#local-6989586621682820876"><span class="hs-identifier hs-var hs-var">m'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; a -&gt; IntMap a -&gt; IntMap a
forall a. Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Strict.Internal.html#insert"><span class="hs-identifier hs-var">IM.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820872"><span class="hs-identifier hs-var">b2</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682820873"><span class="hs-identifier hs-var">prob</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap a
</span><a href="#local-6989586621682820875"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1257"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">writeSTRef</span></span><span> </span><span class="annot"><a href="#local-6989586621682820870"><span class="hs-identifier hs-type">arr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Strict.Internal.html#insert"><span class="hs-identifier hs-type">IM.insert</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820871"><span class="hs-identifier hs-type">b1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820876"><span class="hs-identifier hs-type">m'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820874"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1258"></span><span>
</span><span id="line-1259"></span><span>        </span><span id="local-6989586621682820878"><span class="annot"><a href="#local-6989586621682820878"><span class="hs-identifier hs-var hs-var">getEdgeFreq</span></a></span></span><span> </span><span id="local-6989586621682820879"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820879"><span class="hs-identifier hs-var">b1</span></a></span></span><span> </span><span id="local-6989586621682820880"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820880"><span class="hs-identifier hs-var">b2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap Double)) -&gt; Int -&gt; Int -&gt; ST s Double
forall {s} {b}. STRef s (IntMap (IntMap b)) -&gt; Int -&gt; Int -&gt; ST s b
</span><a href="#local-6989586621682820857"><span class="hs-identifier hs-var">getProb'</span></a></span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap Double))
</span><a href="#local-6989586621682820839"><span class="hs-identifier hs-var">edgeProbs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820879"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820880"><span class="hs-identifier hs-var">b2</span></a></span><span>
</span><span id="line-1260"></span><span>        </span><span id="local-6989586621682820881"><span class="annot"><a href="#local-6989586621682820881"><span class="hs-identifier hs-var hs-var">setEdgeFreq</span></a></span></span><span> </span><span id="local-6989586621682820882"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820882"><span class="hs-identifier hs-var">b1</span></a></span></span><span> </span><span id="local-6989586621682820883"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820883"><span class="hs-identifier hs-var">b2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap Double)) -&gt; Int -&gt; Int -&gt; Double -&gt; ST s ()
forall {s} {a}.
STRef s (IntMap (IntMap a)) -&gt; Int -&gt; Int -&gt; a -&gt; ST s ()
</span><a href="#local-6989586621682820869"><span class="hs-identifier hs-var">setProb'</span></a></span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap Double))
</span><a href="#local-6989586621682820839"><span class="hs-identifier hs-var">edgeProbs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820882"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820883"><span class="hs-identifier hs-var">b2</span></a></span><span>
</span><span id="line-1261"></span><span>        </span><span id="local-6989586621682820884"><span class="annot"><a href="#local-6989586621682820884"><span class="hs-identifier hs-var hs-var">getProb</span></a></span></span><span> </span><span id="local-6989586621682820885"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820885"><span class="hs-identifier hs-var">b1</span></a></span></span><span> </span><span id="local-6989586621682820886"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820886"><span class="hs-identifier hs-var">b2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double -&gt; Maybe Double -&gt; Double
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Double
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getProb&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Double -&gt; Double) -&gt; Maybe Double -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1262"></span><span>            </span><span id="local-6989586621682820887"><span class="annot"><a href="#local-6989586621682820887"><span class="hs-identifier hs-var">m'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntMap (IntMap Double) -&gt; Maybe (IntMap Double)
forall a. Int -&gt; IntMap a -&gt; Maybe a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#lookup"><span class="hs-identifier hs-var">IM.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820885"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820719"><span class="hs-identifier hs-var">graph</span></a></span><span>
</span><span id="line-1263"></span><span>            </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#lookup"><span class="hs-identifier hs-type">IM.lookup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820886"><span class="hs-identifier hs-type">b2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820887"><span class="hs-identifier hs-type">m'</span></a></span><span>
</span><span id="line-1264"></span><span>
</span><span id="line-1265"></span><span>        </span><span id="local-6989586621682820888"><span class="annot"><a href="#local-6989586621682820888"><span class="hs-identifier hs-var hs-var">getBackProb</span></a></span></span><span> </span><span id="local-6989586621682820889"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820889"><span class="hs-identifier hs-var">b1</span></a></span></span><span> </span><span id="local-6989586621682820890"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820890"><span class="hs-identifier hs-var">b2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap Double)) -&gt; Int -&gt; Int -&gt; ST s Double
forall {s} {b}. STRef s (IntMap (IntMap b)) -&gt; Int -&gt; Int -&gt; ST s b
</span><a href="#local-6989586621682820857"><span class="hs-identifier hs-var">getProb'</span></a></span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap Double))
</span><a href="#local-6989586621682820841"><span class="hs-identifier hs-var">edgeBackProbs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820889"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820890"><span class="hs-identifier hs-var">b2</span></a></span><span>
</span><span id="line-1266"></span><span>        </span><span id="local-6989586621682820891"><span class="annot"><a href="#local-6989586621682820891"><span class="hs-identifier hs-var hs-var">setBackProb</span></a></span></span><span> </span><span id="local-6989586621682820892"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820892"><span class="hs-identifier hs-var">b1</span></a></span></span><span> </span><span id="local-6989586621682820893"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820893"><span class="hs-identifier hs-var">b2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap Double)) -&gt; Int -&gt; Int -&gt; Double -&gt; ST s ()
forall {s} {a}.
STRef s (IntMap (IntMap a)) -&gt; Int -&gt; Int -&gt; a -&gt; ST s ()
</span><a href="#local-6989586621682820869"><span class="hs-identifier hs-var">setProb'</span></a></span><span> </span><span class="annot"><span class="annottext">STRef s (IntMap (IntMap Double))
</span><a href="#local-6989586621682820841"><span class="hs-identifier hs-var">edgeBackProbs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820892"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820893"><span class="hs-identifier hs-var">b2</span></a></span><span>
</span><span id="line-1267"></span><span>
</span><span id="line-1268"></span><span>
</span><span id="line-1269"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- calcOutFreqs :: Node -&gt; ST s ()</span><span>
</span><span id="line-1270"></span><span>        </span><span id="local-6989586621682820894"><span class="annot"><a href="#local-6989586621682820894"><span class="hs-identifier hs-var hs-var">calcOutFreqs</span></a></span></span><span> </span><span id="local-6989586621682820895"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820895"><span class="hs-identifier hs-var">bhead</span></a></span></span><span> </span><span id="local-6989586621682820896"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820896"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1271"></span><span>          </span><span class="hs-glyph">!</span><span id="local-6989586621682820897"><span class="annot"><a href="#local-6989586621682820897"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s Double
</span><a href="#local-6989586621682820844"><span class="hs-identifier hs-var">getFreq</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820896"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-1272"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682820899"><span class="hs-identifier hs-type">successors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820896"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682820900"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820900"><span class="hs-identifier hs-var">bi</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1273"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682820901"><span class="annot"><span class="annottext">prob :: Double
</span><a href="#local-6989586621682820901"><span class="hs-identifier hs-var hs-var hs-var">prob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Double
</span><a href="#local-6989586621682820884"><span class="hs-identifier hs-var">getProb</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820896"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820900"><span class="hs-identifier hs-var">bi</span></a></span><span>
</span><span id="line-1274"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682820902"><span class="annot"><span class="annottext">succFreq :: Double
</span><a href="#local-6989586621682820902"><span class="hs-identifier hs-var hs-var hs-var">succFreq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820897"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820901"><span class="hs-identifier hs-var">prob</span></a></span><span>
</span><span id="line-1275"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Double -&gt; ST s ()
</span><a href="#local-6989586621682820881"><span class="hs-identifier hs-var">setEdgeFreq</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820896"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820900"><span class="hs-identifier hs-var">bi</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820902"><span class="hs-identifier hs-var">succFreq</span></a></span><span>
</span><span id="line-1276"></span><span>            </span><span class="hs-comment">-- traceM $ &quot;SetOut: &quot; ++ show (block, bi, f, prob, succFreq)</span><span>
</span><span id="line-1277"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; ST s () -&gt; ST s ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820900"><span class="hs-identifier hs-var">bi</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820895"><span class="hs-identifier hs-var">bhead</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ST s () -&gt; ST s ()) -&gt; ST s () -&gt; ST s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Double -&gt; ST s ()
</span><a href="#local-6989586621682820891"><span class="hs-identifier hs-var">setBackProb</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820896"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820900"><span class="hs-identifier hs-var">bi</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621682820902"><span class="hs-identifier hs-var">succFreq</span></a></span><span>
</span><span id="line-1278"></span><span>
</span><span id="line-1279"></span><span>
</span><span id="line-1280"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820904"><span class="annot"><a href="#local-6989586621682820904"><span class="hs-identifier hs-var hs-var">propFreq</span></a></span></span><span> </span><span id="local-6989586621682820905"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820905"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span id="local-6989586621682820906"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820906"><span class="hs-identifier hs-var">head</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1281"></span><span>            </span><span class="hs-comment">-- traceM (&quot;prop:&quot; ++ show (block,head))</span><span>
</span><span id="line-1282"></span><span>            </span><span class="hs-comment">-- traceShowM block</span><span>
</span><span id="line-1283"></span><span>
</span><span id="line-1284"></span><span>            </span><span class="hs-glyph">!</span><span id="local-6989586621682820907"><span class="annot"><a href="#local-6989586621682820907"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s Bool
</span><a href="#local-6989586621682820842"><span class="hs-identifier hs-var">visited</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820905"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-1285"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621682820907"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-1286"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">--Dont look at nodes twice</span><span>
</span><span id="line-1287"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621682820905"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="#local-6989586621682820906"><span class="hs-identifier hs-type">head</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-1288"></span><span>                </span><span class="annot"><a href="#local-6989586621682820846"><span class="hs-identifier hs-type">setFreq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820905"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><span class="hs-number">1.0</span></span><span> </span><span class="hs-comment">-- Loop header frequency is always 1</span><span>
</span><span id="line-1289"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1290"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820908"><span class="annot"><a href="#local-6989586621682820908"><span class="hs-identifier hs-var hs-var">preds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntSet -&gt; [Int]
</span><a href="../../containers-0.7-5a8f/src/Data.IntSet.Internal.html#elems"><span class="hs-identifier hs-var">IS.elems</span></a></span><span> </span><span class="annot"><span class="annottext">(IntSet -&gt; [Int]) -&gt; IntSet -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntSet
</span><a href="#local-6989586621682820910"><span class="hs-identifier hs-var">predecessors</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820905"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-1291"></span><span>                </span><span id="local-6989586621682820911"><span class="annot"><a href="#local-6989586621682820911"><span class="hs-identifier hs-var">irreducible</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">or</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">forM</span></span><span> </span><span class="annot"><a href="#local-6989586621682820908"><span class="hs-identifier hs-type">preds</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682820913"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820913"><span class="hs-identifier hs-var">bp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1292"></span><span>                    </span><span class="hs-glyph">!</span><span id="local-6989586621682820914"><span class="annot"><a href="#local-6989586621682820914"><span class="hs-identifier hs-var">bp_visited</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s Bool
</span><a href="#local-6989586621682820842"><span class="hs-identifier hs-var">visited</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820913"><span class="hs-identifier hs-var">bp</span></a></span><span>
</span><span id="line-1293"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820915"><span class="annot"><a href="#local-6989586621682820915"><span class="hs-identifier hs-var hs-var">bp_backedge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
</span><a href="#local-6989586621682820916"><span class="hs-identifier hs-var">isBackEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820913"><span class="hs-identifier hs-var">bp</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820905"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-1294"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621682820914"><span class="hs-identifier hs-type">bp_visited</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621682820915"><span class="hs-identifier hs-type">bp_backedge</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1295"></span><span>
</span><span id="line-1296"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621682820911"><span class="hs-identifier hs-type">irreducible</span></a></span><span>
</span><span id="line-1297"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Rare we don't care</span><span>
</span><span id="line-1298"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1299"></span><span>                    </span><span class="annot"><a href="#local-6989586621682820846"><span class="hs-identifier hs-type">setFreq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820905"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-1300"></span><span>                    </span><span class="hs-glyph">!</span><span id="local-6989586621682820917"><span class="annot"><a href="#local-6989586621682820917"><span class="hs-identifier hs-var">cycleProb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sum</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">forM</span></span><span> </span><span class="annot"><a href="#local-6989586621682820908"><span class="hs-identifier hs-type">preds</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682820918"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820918"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1301"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
</span><a href="#local-6989586621682820916"><span class="hs-identifier hs-var">isBackEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820918"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820905"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-1302"></span><span>                            </span><span class="hs-keyword">then</span><span>
</span><span id="line-1303"></span><span>                                </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; ST s Double
</span><a href="#local-6989586621682820888"><span class="hs-identifier hs-var">getBackProb</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820918"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820905"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-1304"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1305"></span><span>                                </span><span class="hs-glyph">!</span><span id="local-6989586621682820919"><span class="annot"><a href="#local-6989586621682820919"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s Double
</span><a href="#local-6989586621682820844"><span class="hs-identifier hs-var">getFreq</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820905"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-1306"></span><span>                                </span><span class="hs-glyph">!</span><span id="local-6989586621682820920"><span class="annot"><a href="#local-6989586621682820920"><span class="hs-identifier hs-var">prob</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682820878"><span class="hs-identifier hs-type">getEdgeFreq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820918"><span class="hs-identifier hs-type">pred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820905"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-1307"></span><span>                                </span><span class="annot"><a href="#local-6989586621682820846"><span class="hs-identifier hs-type">setFreq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820905"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="annot"><a href="#local-6989586621682820919"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><a href="#local-6989586621682820920"><span class="hs-identifier hs-type">prob</span></a></span><span>
</span><span id="line-1308"></span><span>                                </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1309"></span><span>                    </span><span class="hs-comment">-- traceM $ &quot;cycleProb:&quot; ++ show cycleProb</span><span>
</span><span id="line-1310"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682820927"><span class="annot"><a href="#local-6989586621682820927"><span class="hs-identifier hs-var hs-var">limit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">1</span></span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">512</span></span><span> </span><span class="hs-comment">-- Paper uses 1 - epsilon, but this works.</span><span>
</span><span id="line-1311"></span><span>                                          </span><span class="hs-comment">-- determines how large likelyhoods in loops can grow.</span><span>
</span><span id="line-1312"></span><span>                    </span><span class="hs-glyph">!</span><span id="local-6989586621682820928"><span class="annot"><a href="#local-6989586621682820928"><span class="hs-identifier hs-var">cycleProb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">min</span></span><span> </span><span class="annot"><a href="#local-6989586621682820917"><span class="hs-identifier hs-type">cycleProb</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820927"><span class="hs-identifier hs-type">limit</span></a></span><span> </span><span class="hs-comment">-- &lt;- return $ if cycleProb &gt; limit then limit else cycleProb</span><span>
</span><span id="line-1313"></span><span>                    </span><span class="hs-comment">-- traceM $ &quot;cycleProb:&quot; ++ show cycleProb</span><span>
</span><span id="line-1314"></span><span>
</span><span id="line-1315"></span><span>                    </span><span class="hs-glyph">!</span><span id="local-6989586621682820929"><span class="annot"><a href="#local-6989586621682820929"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682820844"><span class="hs-identifier hs-type">getFreq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820905"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-1316"></span><span>                    </span><span class="annot"><a href="#local-6989586621682820846"><span class="hs-identifier hs-type">setFreq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820905"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682820929"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">/</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-number">1.0</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="annot"><a href="#local-6989586621682820928"><span class="hs-identifier hs-type">cycleProb</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1317"></span><span>
</span><span id="line-1318"></span><span>            </span><span class="annot"><a href="#local-6989586621682820849"><span class="hs-identifier hs-type">setVisited</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820905"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-1319"></span><span>            </span><span class="annot"><a href="#local-6989586621682820894"><span class="hs-identifier hs-type">calcOutFreqs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820906"><span class="hs-identifier hs-type">head</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682820905"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-1320"></span><span>
</span><span id="line-1321"></span><span>    </span><span class="hs-comment">-- Loops, by nesting, inner to outer</span><span>
</span><span id="line-1322"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">forM_</span></span><span> </span><span class="annot"><a href="#local-6989586621682820721"><span class="hs-identifier hs-type">loops</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682820931"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820931"><span class="hs-identifier hs-var">head</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682820932"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621682820932"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1323"></span><span>        </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; ST s ()) -&gt; ST s ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820830"><span class="hs-identifier hs-var">nodeCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820933"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820933"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool -&gt; Int -&gt; Bool -&gt; ST s ()
forall i. Ix i =&gt; STUArray s i Bool -&gt; Int -&gt; Bool -&gt; ST s ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeWrite"><span class="hs-identifier hs-var">unsafeWrite</span></a></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool
</span><a href="#local-6989586621682820823"><span class="hs-identifier hs-var">visitedNodes</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820933"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Mark all nodes as visited.</span><span>
</span><span id="line-1324"></span><span>        </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; ST s ()) -&gt; ST s ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621682820932"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820934"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820934"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool -&gt; Int -&gt; Bool -&gt; ST s ()
forall i. Ix i =&gt; STUArray s i Bool -&gt; Int -&gt; Bool -&gt; ST s ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeWrite"><span class="hs-identifier hs-var">unsafeWrite</span></a></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool
</span><a href="#local-6989586621682820823"><span class="hs-identifier hs-var">visitedNodes</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820934"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Mark all blocks reachable from head as not visited</span><span>
</span><span id="line-1325"></span><span>        </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; ST s [()]) -&gt; ST s ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621682820932"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; ST s [()]) -&gt; ST s ()) -&gt; (Int -&gt; ST s [()]) -&gt; ST s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682820935"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820935"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; ST s [()]
</span><a href="#local-6989586621682820904"><span class="hs-identifier hs-var">propFreq</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820935"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820931"><span class="hs-identifier hs-var">head</span></a></span><span>
</span><span id="line-1326"></span><span>
</span><span id="line-1327"></span><span>    </span><span class="hs-comment">-- After dealing with all loops, deal with non-looping parts of the CFG</span><span>
</span><span id="line-1328"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">forM_</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><a href="#local-6989586621682820830"><span class="hs-identifier hs-type">nodeCount</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820936"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820936"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool -&gt; Int -&gt; Bool -&gt; ST s ()
forall i. Ix i =&gt; STUArray s i Bool -&gt; Int -&gt; Bool -&gt; ST s ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeWrite"><span class="hs-identifier hs-var">unsafeWrite</span></a></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Bool
</span><a href="#local-6989586621682820823"><span class="hs-identifier hs-var">visitedNodes</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820936"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Everything in revPostOrder is reachable</span><span>
</span><span id="line-1329"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">forM_</span></span><span> </span><span class="annot"><a href="#local-6989586621682820722"><span class="hs-identifier hs-type">revPostOrder</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682820937"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820937"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; ST s [()]
</span><a href="#local-6989586621682820904"><span class="hs-identifier hs-var">propFreq</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820937"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall a. HasCallStack =&gt; [a] -&gt; a
</span><a href="GHC.Prelude.Basic.html#head"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621682820722"><span class="hs-identifier hs-var">revPostOrder</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1330"></span><span>
</span><span id="line-1331"></span><span>    </span><span class="hs-comment">-- trace (&quot;Final freqs:&quot;) $ return ()</span><span>
</span><span id="line-1332"></span><span>    </span><span class="hs-comment">-- let freqString = pprFreqs freqs</span><span>
</span><span id="line-1333"></span><span>    </span><span class="hs-comment">-- trace (unlines freqString) $ return ()</span><span>
</span><span id="line-1334"></span><span>    </span><span class="hs-comment">-- trace (pprFre) $ return ()</span><span>
</span><span id="line-1335"></span><span>    </span><span id="local-6989586621682820939"><span class="annot"><a href="#local-6989586621682820939"><span class="hs-identifier hs-var">graph'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readSTRef</span></span><span> </span><span class="annot"><a href="#local-6989586621682820839"><span class="hs-identifier hs-type">edgeProbs</span></a></span><span>
</span><span id="line-1336"></span><span>    </span><span id="local-6989586621682820940"><span class="annot"><a href="#local-6989586621682820940"><span class="hs-identifier hs-var">freqs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="../../array-0.5.8.0-9044/src/Data.Array.Base.html#unsafeFreeze"><span class="hs-identifier hs-type">unsafeFreeze</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621682820832"><span class="hs-identifier hs-type">blockFreqs</span></a></span><span>
</span><span id="line-1337"></span><span>
</span><span id="line-1338"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682820940"><span class="hs-identifier hs-type">freqs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682820939"><span class="hs-identifier hs-type">graph'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1339"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1340"></span><span>    </span><span class="hs-comment">-- How can these lookups fail? Consider the CFG [A -&gt; B]</span><span>
</span><span id="line-1341"></span><span>    </span><span class="annot"><a href="#local-6989586621682820910"><span class="hs-identifier hs-type">predecessors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntSet.Internal.html#IntSet"><span class="hs-identifier hs-type">IS.IntSet</span></a></span><span>
</span><span id="line-1342"></span><span>    </span><span id="local-6989586621682820910"><span class="annot"><span class="annottext">predecessors :: Int -&gt; IntSet
</span><a href="#local-6989586621682820910"><span class="hs-identifier hs-var hs-var">predecessors</span></a></span></span><span> </span><span id="local-6989586621682820941"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820941"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntSet -&gt; Maybe IntSet -&gt; IntSet
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">IntSet
</span><a href="../../containers-0.7-5a8f/src/Data.IntSet.Internal.html#empty"><span class="hs-identifier hs-var">IS.empty</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe IntSet -&gt; IntSet) -&gt; Maybe IntSet -&gt; IntSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntMap IntSet -&gt; Maybe IntSet
forall a. Int -&gt; IntMap a -&gt; Maybe a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#lookup"><span class="hs-identifier hs-var">IM.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820941"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap IntSet
</span><a href="#local-6989586621682820943"><span class="hs-identifier hs-var">revGraph</span></a></span><span>
</span><span id="line-1343"></span><span>    </span><span class="annot"><a href="#local-6989586621682820899"><span class="hs-identifier hs-type">successors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span>
</span><span id="line-1344"></span><span>    </span><span id="local-6989586621682820899"><span class="annot"><span class="annottext">successors :: Int -&gt; [Int]
</span><a href="#local-6989586621682820899"><span class="hs-identifier hs-var hs-var">successors</span></a></span></span><span> </span><span id="local-6989586621682820944"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820944"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Maybe [Int] -&gt; [Int]
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Int -&gt; IntMap (IntMap Double) -&gt; [Int]
forall {a} {b}.
Outputable a =&gt;
String -&gt; a -&gt; IntMap (IntMap Double) -&gt; b
</span><a href="#local-6989586621682820945"><span class="hs-identifier hs-var">lookupError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;succ&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820944"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820719"><span class="hs-identifier hs-var">graph</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(Maybe [Int] -&gt; [Int]) -&gt; Maybe [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntMap Double -&gt; [Int]
forall a. IntMap a -&gt; [Int]
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#keys"><span class="hs-identifier hs-var">IM.keys</span></a></span><span> </span><span class="annot"><span class="annottext">(IntMap Double -&gt; [Int]) -&gt; Maybe (IntMap Double) -&gt; Maybe [Int]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntMap (IntMap Double) -&gt; Maybe (IntMap Double)
forall a. Int -&gt; IntMap a -&gt; Maybe a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#lookup"><span class="hs-identifier hs-var">IM.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820944"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820719"><span class="hs-identifier hs-var">graph</span></a></span><span>
</span><span id="line-1345"></span><span>    </span><span id="local-6989586621682820945"><span class="annot"><span class="annottext">lookupError :: String -&gt; a -&gt; IntMap (IntMap Double) -&gt; b
</span><a href="#local-6989586621682820945"><span class="hs-identifier hs-var hs-var">lookupError</span></a></span></span><span> </span><span id="local-6989586621682820963"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682820963"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621682820964"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682820964"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682820965"><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820965"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; b
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Lookup error &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682820963"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; b) -&gt; SDoc -&gt; b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1346"></span><span>                            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;node&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682820964"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-1347"></span><span>                                </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;graph&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>
</span><span id="line-1348"></span><span>                                </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Int, IntMap Double) -&gt; SDoc) -&gt; [(Int, IntMap Double)] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682820966"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820966"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682820967"><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820967"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Int, IntMap Double) -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820966"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820967"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Int, IntMap Double)] -&gt; [SDoc])
-&gt; [(Int, IntMap Double)] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double) -&gt; [(Int, IntMap Double)]
forall a. IntMap a -&gt; [(Int, a)]
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#toList"><span class="hs-identifier hs-var">IM.toList</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820965"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1349"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-1350"></span><span>
</span><span id="line-1351"></span><span>    </span><span id="local-6989586621682820830"><span class="annot"><span class="annottext">nodeCount :: Int
</span><a href="#local-6989586621682820830"><span class="hs-identifier hs-var hs-var">nodeCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IntMap Double -&gt; Int)
-&gt; Int -&gt; IntMap (IntMap Double) -&gt; Int
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; IntMap b -&gt; a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#foldl%27"><span class="hs-identifier hs-var">IM.foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820969"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820969"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span id="local-6989586621682820970"><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820970"><span class="hs-identifier hs-var">toMap</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Double -&gt; Int) -&gt; Int -&gt; IntMap Double -&gt; Int
forall a b. (a -&gt; Int -&gt; b -&gt; a) -&gt; a -&gt; IntMap b -&gt; a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#foldlWithKey%27"><span class="hs-identifier hs-var">IM.foldlWithKey'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Double -&gt; Int
</span><a href="#local-6989586621682820972"><span class="hs-identifier hs-var">countTargets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820969"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820970"><span class="hs-identifier hs-var">toMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820719"><span class="hs-identifier hs-var">graph</span></a></span><span>
</span><span id="line-1352"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1353"></span><span>        </span><span id="local-6989586621682820972"><span class="annot"><span class="annottext">countTargets :: Int -&gt; Int -&gt; Double -&gt; Int
</span><a href="#local-6989586621682820972"><span class="hs-identifier hs-var hs-var">countTargets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820973"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820973"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span id="local-6989586621682820974"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820974"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621682820975"><span class="hs-identifier hs-var">countNode</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820974"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820973"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1354"></span><span>        </span><span id="local-6989586621682820975"><span class="annot"><span class="annottext">countNode :: Int -&gt; Int
</span><a href="#local-6989586621682820975"><span class="hs-identifier hs-var hs-var">countNode</span></a></span></span><span> </span><span id="local-6989586621682820976"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820976"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntMap (IntMap Double) -&gt; Bool
forall a. Int -&gt; IntMap a -&gt; Bool
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#member"><span class="hs-identifier hs-var">IM.member</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820976"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820719"><span class="hs-identifier hs-var">graph</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1355"></span><span>
</span><span id="line-1356"></span><span>    </span><span id="local-6989586621682820916"><span class="annot"><span class="annottext">isBackEdge :: Int -&gt; Int -&gt; Bool
</span><a href="#local-6989586621682820916"><span class="hs-identifier hs-var hs-var">isBackEdge</span></a></span></span><span> </span><span id="local-6989586621682820978"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820978"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820979"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820979"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; Set (Int, Int) -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#member"><span class="hs-identifier hs-var">S.member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820978"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820979"><span class="hs-identifier hs-var">to</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set (Int, Int)
</span><a href="#local-6989586621682820980"><span class="hs-identifier hs-var">backEdgeSet</span></a></span><span>
</span><span id="line-1357"></span><span>    </span><span id="local-6989586621682820980"><span class="annot"><span class="annottext">backEdgeSet :: Set (Int, Int)
</span><a href="#local-6989586621682820980"><span class="hs-identifier hs-var hs-var">backEdgeSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Int, Int)] -&gt; Set (Int, Int)
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">S.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, Int)]
</span><a href="#local-6989586621682820720"><span class="hs-identifier hs-var">backEdges</span></a></span><span>
</span><span id="line-1358"></span><span>
</span><span id="line-1359"></span><span>    </span><span class="annot"><a href="#local-6989586621682820943"><span class="hs-identifier hs-type">revGraph</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IntMap</span></a></span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntSet.Internal.html#IntSet"><span class="hs-identifier hs-type">IntSet</span></a></span><span>
</span><span id="line-1360"></span><span>    </span><span id="local-6989586621682820943"><span class="annot"><span class="annottext">revGraph :: IntMap IntSet
</span><a href="#local-6989586621682820943"><span class="hs-identifier hs-var hs-var">revGraph</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IntMap IntSet -&gt; Int -&gt; IntMap Double -&gt; IntMap IntSet)
-&gt; IntMap IntSet -&gt; IntMap (IntMap Double) -&gt; IntMap IntSet
forall a b. (a -&gt; Int -&gt; b -&gt; a) -&gt; a -&gt; IntMap b -&gt; a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#foldlWithKey%27"><span class="hs-identifier hs-var">IM.foldlWithKey'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820981"><span class="annot"><span class="annottext">IntMap IntSet
</span><a href="#local-6989586621682820981"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820982"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820982"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820983"><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820983"><span class="hs-identifier hs-var">toMap</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntMap IntSet -&gt; Int -&gt; IntMap Double -&gt; IntMap IntSet
forall {b}. IntMap IntSet -&gt; Int -&gt; IntMap b -&gt; IntMap IntSet
</span><a href="#local-6989586621682820984"><span class="hs-identifier hs-var">addEdges</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap IntSet
</span><a href="#local-6989586621682820981"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820982"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap Double
</span><a href="#local-6989586621682820983"><span class="hs-identifier hs-var">toMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap IntSet
forall a. IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#empty"><span class="hs-identifier hs-var">IM.empty</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (IntMap Double)
</span><a href="#local-6989586621682820719"><span class="hs-identifier hs-var">graph</span></a></span><span>
</span><span id="line-1361"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1362"></span><span>            </span><span id="local-6989586621682820984"><span class="annot"><span class="annottext">addEdges :: IntMap IntSet -&gt; Int -&gt; IntMap b -&gt; IntMap IntSet
</span><a href="#local-6989586621682820984"><span class="hs-identifier hs-var hs-var">addEdges</span></a></span></span><span> </span><span id="local-6989586621682820985"><span class="annot"><span class="annottext">IntMap IntSet
</span><a href="#local-6989586621682820985"><span class="hs-identifier hs-var">m0</span></a></span></span><span> </span><span id="local-6989586621682820986"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820986"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820987"><span class="annot"><span class="annottext">IntMap b
</span><a href="#local-6989586621682820987"><span class="hs-identifier hs-var">toMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IntMap IntSet -&gt; Int -&gt; b -&gt; IntMap IntSet)
-&gt; IntMap IntSet -&gt; IntMap b -&gt; IntMap IntSet
forall a b. (a -&gt; Int -&gt; b -&gt; a) -&gt; a -&gt; IntMap b -&gt; a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#foldlWithKey%27"><span class="hs-identifier hs-var">IM.foldlWithKey'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682820988"><span class="annot"><span class="annottext">IntMap IntSet
</span><a href="#local-6989586621682820988"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682820989"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820989"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntMap IntSet -&gt; Int -&gt; Int -&gt; IntMap IntSet
</span><a href="#local-6989586621682820990"><span class="hs-identifier hs-var">addEdge</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap IntSet
</span><a href="#local-6989586621682820988"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820986"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820989"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap IntSet
</span><a href="#local-6989586621682820985"><span class="hs-identifier hs-var">m0</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap b
</span><a href="#local-6989586621682820987"><span class="hs-identifier hs-var">toMap</span></a></span><span>
</span><span id="line-1363"></span><span>            </span><span id="local-6989586621682820990"><span class="annot"><span class="annottext">addEdge :: IntMap IntSet -&gt; Int -&gt; Int -&gt; IntMap IntSet
</span><a href="#local-6989586621682820990"><span class="hs-identifier hs-var hs-var">addEdge</span></a></span></span><span> </span><span id="local-6989586621682820991"><span class="annot"><span class="annottext">IntMap IntSet
</span><a href="#local-6989586621682820991"><span class="hs-identifier hs-var">m0</span></a></span></span><span> </span><span id="local-6989586621682820992"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820992"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621682820993"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820993"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IntSet -&gt; IntSet -&gt; IntSet)
-&gt; Int -&gt; IntSet -&gt; IntMap IntSet -&gt; IntMap IntSet
forall a. (a -&gt; a -&gt; a) -&gt; Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Strict.Internal.html#insertWith"><span class="hs-identifier hs-var">IM.insertWith</span></a></span><span> </span><span class="annot"><span class="annottext">IntSet -&gt; IntSet -&gt; IntSet
</span><a href="../../containers-0.7-5a8f/src/Data.IntSet.Internal.html#union"><span class="hs-identifier hs-var">IS.union</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820993"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; IntSet
</span><a href="../../containers-0.7-5a8f/src/Data.IntSet.Internal.html#singleton"><span class="hs-identifier hs-var">IS.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682820992"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap IntSet
</span><a href="#local-6989586621682820991"><span class="hs-identifier hs-var">m0</span></a></span><span>
</span><span id="line-1364"></span></pre></body></html>