<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE MultiWayIf, RecursiveDo, TupleSections #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html"><span class="hs-identifier">GHC.Tc.Solver</span></a></span><span class="hs-special">(</span><span>
</span><span id="line-4"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#InferMode"><span class="hs-identifier">InferMode</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyInfer"><span class="hs-identifier">simplifyInfer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#findInferredDiff"><span class="hs-identifier">findInferredDiff</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#growThetaTyVars"><span class="hs-identifier">growThetaTyVars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyAmbiguityCheck"><span class="hs-identifier">simplifyAmbiguityCheck</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyDefault"><span class="hs-identifier">simplifyDefault</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyTop"><span class="hs-identifier">simplifyTop</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyTopImplic"><span class="hs-identifier">simplifyTopImplic</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyInteractive"><span class="hs-identifier">simplifyInteractive</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#solveEqualities"><span class="hs-identifier">solveEqualities</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#pushLevelAndSolveEqualities"><span class="hs-identifier">pushLevelAndSolveEqualities</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#pushLevelAndSolveEqualitiesX"><span class="hs-identifier">pushLevelAndSolveEqualitiesX</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#reportUnsolvedEqualities"><span class="hs-identifier">reportUnsolvedEqualities</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyWantedsTcM"><span class="hs-identifier">simplifyWantedsTcM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#tcCheckGivens"><span class="hs-identifier">tcCheckGivens</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#tcCheckWanteds"><span class="hs-identifier">tcCheckWanteds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#tcNormalise"><span class="hs-identifier">tcNormalise</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#captureTopConstraints"><span class="hs-identifier">captureTopConstraints</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyTopWanteds"><span class="hs-identifier">simplifyTopWanteds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span>       </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#promoteTyVarSet"><span class="hs-identifier">promoteTyVarSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyAndEmitFlatConstraints"><span class="hs-identifier">simplifyAndEmitFlatConstraints</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span>       </span><span class="hs-comment">-- For Rules we need these</span><span>
</span><span id="line-25"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier">solveWanteds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>       </span><span class="annot"><a href="GHC.Tc.Solver.html#approximateWC"><span class="hs-identifier">approximateWC</span></a></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.html"><span class="hs-identifier">GHC.Tc.Errors</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html"><span class="hs-identifier">GHC.Tc.Errors.Types</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html"><span class="hs-identifier">GHC.Tc.Types.Evidence</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html"><span class="hs-identifier">GHC.Tc.Solver.Solve</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html#solveSimpleGivens"><span class="hs-identifier">solveSimpleGivens</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html#solveSimpleWanteds"><span class="hs-identifier">solveSimpleWanteds</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html"><span class="hs-identifier">GHC.Tc.Solver.Dict</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html#makeSuperClasses"><span class="hs-identifier">makeSuperClasses</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html#solveCallStack"><span class="hs-identifier">solveCallStack</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html"><span class="hs-identifier">GHC.Tc.Solver.Rewrite</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteType"><span class="hs-identifier">rewriteType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html"><span class="hs-identifier">GHC.Tc.Utils.Unify</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html"><span class="hs-identifier">GHC.Tc.Utils.TcMType</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TcM</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TcM</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html"><span class="hs-identifier">GHC.Tc.Zonk.TcType</span></a></span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TcM</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html"><span class="hs-identifier">GHC.Tc.Solver.InertSet</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html"><span class="hs-identifier">GHC.Tc.Solver.Monad</span></a></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TcS</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html"><span class="hs-identifier">GHC.Tc.Types.Constraint</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html"><span class="hs-identifier">GHC.Tc.Types.CtLoc</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.CtLoc.html#mkGivenLoc"><span class="hs-identifier">mkGivenLoc</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html"><span class="hs-identifier">GHC.Tc.Instance.FunDeps</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html"><span class="hs-identifier">GHC.Tc.Types.Origin</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Class.html"><span class="hs-identifier">GHC.Core.Class</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html"><span class="hs-identifier">GHC.Core.Reduction</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier">Reduction</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#reductionCoercion"><span class="hs-identifier">reductionCoercion</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier">mkNomReflCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier">isReflCo</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html"><span class="hs-identifier">GHC.Core.Unify</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyKis"><span class="hs-identifier">tcMatchTyKis</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html"><span class="hs-identifier">GHC.Core.Ppr</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyConBinder"><span class="hs-identifier">TyConBinder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier">isTypeFamilyTyCon</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.DefaultEnv.html"><span class="hs-identifier">GHC.Types.DefaultEnv</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.DefaultEnv.html#ClassDefaults"><span class="hs-identifier">ClassDefaults</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.DefaultEnv.html#defaultList"><span class="hs-identifier">defaultList</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Set.html"><span class="hs-identifier">GHC.Types.Unique.Set</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Utils.html"><span class="hs-identifier">GHC.Builtin.Utils</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.TyThing.html"><span class="hs-identifier">GHC.Types.TyThing</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.TyThing.html#MonadThings"><span class="hs-identifier">MonadThings</span></a></span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.TyThing.html#lookupId"><span class="hs-identifier">lookupId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html"><span class="hs-identifier">GHC.Types.Id.Make</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#unboxedUnitExpr"><span class="hs-identifier">unboxedUnitExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Error.html"><span class="hs-identifier">GHC.Types.Error</span></a></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html"><span class="hs-identifier">GHC.Driver.DynFlags</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier">getModule</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.List.SetOps.html"><span class="hs-identifier">GHC.Data.List.SetOps</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC.LanguageExtensions</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LangExt</span></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Class.html"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.State.Strict.html"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.State.Strict.html#StateT"><span class="hs-identifier">StateT</span></a></span><span class="hs-special">(</span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.State.Strict.html#runStateT"><span class="hs-identifier">runStateT</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.State.Strict.html#put"><span class="hs-identifier">put</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">toList</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traverse_</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">partition</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">intersect</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html#nonEmpty"><span class="hs-identifier">nonEmpty</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Monoid.html"><span class="hs-identifier">Data.Monoid</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">First</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="hs-comment">{-
*********************************************************************************
*                                                                               *
*                           External interface                                  *
*                                                                               *
*********************************************************************************
-}</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span id="local-6989586621683045321"><span class="annot"><a href="GHC.Tc.Solver.html#captureTopConstraints"><span class="hs-identifier hs-type">captureTopConstraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683045321"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683045321"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- (captureTopConstraints m) runs m, and returns the type constraints it</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- generates plus the constraints produced by static forms inside.</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- If it fails with an exception, it reports any insolubles</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- (out of scope variables) before doing so</span><span>
</span><span id="line-115"></span><span class="hs-comment">--</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- captureTopConstraints is used exclusively by GHC.Tc.Module at the top</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- level of a module.</span><span>
</span><span id="line-118"></span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- Importantly, if captureTopConstraints propagates an exception, it</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- reports any insoluble constraints first, lest they be lost</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- altogether.  This is important, because solveEqualities (maybe</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- other things too) throws an exception without adding any error</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- messages; it just puts the unsolved constraints back into the</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- monad. See GHC.Tc.Utils.Monad Note [Constraints and errors]</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- #16376 is an example of what goes wrong if you don't do this.</span><span>
</span><span id="line-126"></span><span class="hs-comment">--</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- NB: the caller should bring any environments into scope before</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- calling this, so that the reportUnsolved has access to the most</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- complete GlobalRdrEnv</span><span>
</span><span id="line-130"></span><span id="captureTopConstraints"><span class="annot"><span class="annottext">captureTopConstraints :: forall a. TcM a -&gt; TcM (a, WantedConstraints)
</span><a href="GHC.Tc.Solver.html#captureTopConstraints"><span class="hs-identifier hs-var hs-var">captureTopConstraints</span></a></span></span><span> </span><span id="local-6989586621683046527"><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683046527"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046528"><span class="annot"><a href="#local-6989586621683046528"><span class="hs-identifier hs-var">static_wc_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (TcRef WantedConstraints)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TcRef a)
</span><a href="GHC.Tc.Types.TcRef.html#newTcRef"><span class="hs-identifier hs-var">TcM.newTcRef</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#emptyWC"><span class="hs-identifier hs-var">emptyWC</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-132"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046531"><span class="annot"><a href="#local-6989586621683046531"><span class="hs-identifier hs-var">mb_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046532"><span class="annot"><a href="#local-6989586621683046532"><span class="hs-identifier hs-var">lie</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#updGblEnv"><span class="hs-identifier hs-type">TcM.updGblEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683046534"><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683046534"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683046534"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#tcg_static_wc"><span class="hs-identifier hs-var">tcg_static_wc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046528"><span class="hs-identifier hs-type">static_wc_var</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-133"></span><span>                          </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#tryCaptureConstraints"><span class="hs-identifier hs-type">TcM.tryCaptureConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046527"><span class="hs-identifier hs-type">thing_inside</span></a></span><span>
</span><span id="line-134"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046537"><span class="annot"><a href="#local-6989586621683046537"><span class="hs-identifier hs-var">stWC</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">TcM.readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046528"><span class="hs-identifier hs-type">static_wc_var</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>       </span><span class="hs-comment">-- See GHC.Tc.Utils.Monad Note [Constraints and errors]</span><span>
</span><span id="line-137"></span><span>       </span><span class="hs-comment">-- If the thing_inside threw an exception, but generated some insoluble</span><span>
</span><span id="line-138"></span><span>       </span><span class="hs-comment">-- constraints, report the latter before propagating the exception</span><span>
</span><span id="line-139"></span><span>       </span><span class="hs-comment">-- Otherwise they will be lost altogether</span><span>
</span><span id="line-140"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683046531"><span class="hs-identifier hs-type">mb_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-141"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683046539"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683046539"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(a, WantedConstraints)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (a, WantedConstraints)
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683046539"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046532"><span class="hs-identifier hs-var">lie</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; WantedConstraints -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#andWC"><span class="hs-operator hs-var">`andWC`</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046537"><span class="hs-identifier hs-var">stWC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>           </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcM (Bag EvBind)
</span><a href="GHC.Tc.Solver.html#simplifyTop"><span class="hs-identifier hs-var">simplifyTop</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046532"><span class="hs-identifier hs-var">lie</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#failM"><span class="hs-identifier hs-type">failM</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-143"></span><span>                </span><span class="hs-comment">-- This call to simplifyTop is the reason</span><span>
</span><span id="line-144"></span><span>                </span><span class="hs-comment">-- this function is here instead of GHC.Tc.Utils.Monad</span><span>
</span><span id="line-145"></span><span>                </span><span class="hs-comment">-- We call simplifyTop so that it does defaulting</span><span>
</span><span id="line-146"></span><span>                </span><span class="hs-comment">-- (esp of runtime-reps) before reporting errors</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyTopImplic"><span class="hs-identifier hs-type">simplifyTopImplic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span id="simplifyTopImplic"><span class="annot"><span class="annottext">simplifyTopImplic :: Bag Implication -&gt; TcM ()
</span><a href="GHC.Tc.Solver.html#simplifyTopImplic"><span class="hs-identifier hs-var hs-var">simplifyTopImplic</span></a></span></span><span> </span><span id="local-6989586621683046542"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683046542"><span class="hs-identifier hs-var">implics</span></a></span></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046543"><span class="annot"><a href="#local-6989586621683046543"><span class="hs-identifier hs-var">empty_binds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcM (Bag EvBind)
</span><a href="GHC.Tc.Solver.html#simplifyTop"><span class="hs-identifier hs-var">simplifyTop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#mkImplicWC"><span class="hs-identifier hs-var">mkImplicWC</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683046542"><span class="hs-identifier hs-var">implics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span>       </span><span class="hs-comment">-- Since all the inputs are implications the returned bindings will be empty</span><span>
</span><span id="line-153"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#massertPpr"><span class="hs-identifier hs-type">massertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-type">isEmptyBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046543"><span class="hs-identifier hs-type">empty_binds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046543"><span class="hs-identifier hs-type">empty_binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyTop"><span class="hs-identifier hs-type">simplifyTop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBind"><span class="hs-identifier hs-type">EvBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- Simplify top-level constraints</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- Usually these will be implications,</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- but when there is nothing to quantify we don't wrap</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- in a degenerate implication, so we do that here instead</span><span>
</span><span id="line-162"></span><span id="simplifyTop"><span class="annot"><span class="annottext">simplifyTop :: WantedConstraints -&gt; TcM (Bag EvBind)
</span><a href="GHC.Tc.Solver.html#simplifyTop"><span class="hs-identifier hs-var hs-var">simplifyTop</span></a></span></span><span> </span><span id="local-6989586621683046548"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046548"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplifyTop {&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;wanted = &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046548"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-164"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621683046552"><span class="annot"><a href="#local-6989586621683046552"><span class="hs-identifier hs-var">final_wc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046553"><span class="annot"><a href="#local-6989586621683046553"><span class="hs-identifier hs-var">unsafe_ol</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046554"><span class="annot"><a href="#local-6989586621683046554"><span class="hs-identifier hs-var">binds1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (WantedConstraints, Bag DictCt)
-&gt; TcM ((WantedConstraints, Bag DictCt), EvBindMap)
forall a. TcS a -&gt; TcM (a, EvBindMap)
</span><a href="GHC.Tc.Solver.Monad.html#runTcS"><span class="hs-identifier hs-var">runTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (WantedConstraints, Bag DictCt)
 -&gt; TcM ((WantedConstraints, Bag DictCt), EvBindMap))
-&gt; TcS (WantedConstraints, Bag DictCt)
-&gt; TcM ((WantedConstraints, Bag DictCt), EvBindMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-165"></span><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046556"><span class="annot"><a href="#local-6989586621683046556"><span class="hs-identifier hs-var">final_wc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#simplifyTopWanteds"><span class="hs-identifier hs-var">simplifyTopWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046548"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-166"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046557"><span class="annot"><a href="#local-6989586621683046557"><span class="hs-identifier hs-var">unsafe_ol</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getSafeOverlapFailures"><span class="hs-identifier hs-type">getSafeOverlapFailures</span></a></span><span>
</span><span id="line-167"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683046556"><span class="hs-identifier hs-type">final_wc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683046557"><span class="hs-identifier hs-type">unsafe_ol</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-168"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;End simplifyTop }&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046560"><span class="annot"><a href="#local-6989586621683046560"><span class="hs-identifier hs-var">binds2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.html#reportUnsolved"><span class="hs-identifier hs-type">reportUnsolved</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046552"><span class="hs-identifier hs-type">final_wc</span></a></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reportUnsolved (unsafe overlapping) {&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span>
</span><span id="line-173"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-type">isEmptyBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046553"><span class="hs-identifier hs-type">unsafe_ol</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-174"></span><span>           </span><span class="hs-comment">-- grab current error messages and clear, warnAllUnsolved will</span><span>
</span><span id="line-175"></span><span>           </span><span class="hs-comment">-- update error messages which we'll grab and then restore saved</span><span>
</span><span id="line-176"></span><span>           </span><span class="hs-comment">-- messages.</span><span>
</span><span id="line-177"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046563"><span class="annot"><a href="#local-6989586621683046563"><span class="hs-identifier hs-var">errs_var</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#getErrsVar"><span class="hs-identifier hs-type">getErrsVar</span></a></span><span>
</span><span id="line-178"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046565"><span class="annot"><a href="#local-6989586621683046565"><span class="hs-identifier hs-var">saved_msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">TcM.readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046563"><span class="hs-identifier hs-type">errs_var</span></a></span><span>
</span><span id="line-179"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#writeTcRef"><span class="hs-identifier hs-type">TcM.writeTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046563"><span class="hs-identifier hs-type">errs_var</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Error.html#emptyMessages"><span class="hs-identifier hs-type">emptyMessages</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.html#warnAllUnsolved"><span class="hs-identifier hs-type">warnAllUnsolved</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#emptyWC"><span class="hs-identifier hs-type">emptyWC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CDictCan"><span class="hs-identifier hs-type">CDictCan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046553"><span class="hs-identifier hs-type">unsafe_ol</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046571"><span class="annot"><a href="#local-6989586621683046571"><span class="hs-identifier hs-var">whyUnsafe</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Error.html#getWarningMessages"><span class="hs-identifier hs-type">getWarningMessages</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#readTcRef"><span class="hs-identifier hs-type">TcM.readTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046563"><span class="hs-identifier hs-type">errs_var</span></a></span><span>
</span><span id="line-184"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.TcRef.html#writeTcRef"><span class="hs-identifier hs-type">TcM.writeTcRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046563"><span class="hs-identifier hs-type">errs_var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046565"><span class="hs-identifier hs-type">saved_msg</span></a></span><span>
</span><span id="line-185"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#recordUnsafeInfer"><span class="hs-identifier hs-type">recordUnsafeInfer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Error.html#mkMessages"><span class="hs-identifier hs-type">mkMessages</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046571"><span class="hs-identifier hs-type">whyUnsafe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-187"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;reportUnsolved (unsafe overlapping) }&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#evBindMapBinds"><span class="hs-identifier hs-type">evBindMapBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046554"><span class="hs-identifier hs-type">binds1</span></a></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-type">`unionBags`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046560"><span class="hs-identifier hs-type">binds2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span id="local-6989586621683045366"><span class="annot"><a href="GHC.Tc.Solver.html#pushLevelAndSolveEqualities"><span class="hs-identifier hs-type">pushLevelAndSolveEqualities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfoAnon"><span class="hs-identifier hs-type">SkolemInfoAnon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683045366"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683045366"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-192"></span><span class="hs-comment">-- Push level, and solve all resulting equalities</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- If there are any unsolved equalities, report them</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- and fail (in the monad)</span><span>
</span><span id="line-195"></span><span class="hs-comment">--</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- Panics if we solve any non-equality constraints.  (In runTCSEqualities</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- we use an error thunk for the evidence bindings.)</span><span>
</span><span id="line-198"></span><span id="pushLevelAndSolveEqualities"><span class="annot"><span class="annottext">pushLevelAndSolveEqualities :: forall a. SkolemInfoAnon -&gt; [TyConBinder] -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Solver.html#pushLevelAndSolveEqualities"><span class="hs-identifier hs-var hs-var">pushLevelAndSolveEqualities</span></a></span></span><span> </span><span id="local-6989586621683046581"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683046581"><span class="hs-identifier hs-var">skol_info_anon</span></a></span></span><span> </span><span id="local-6989586621683046582"><span class="annot"><span class="annottext">[TyConBinder]
</span><a href="#local-6989586621683046582"><span class="hs-identifier hs-var">tcbs</span></a></span></span><span> </span><span id="local-6989586621683046583"><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683046583"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046584"><span class="annot"><a href="#local-6989586621683046584"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046585"><span class="annot"><a href="#local-6989586621683046585"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046586"><span class="annot"><a href="#local-6989586621683046586"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcM a -&gt; TcM (TcLevel, WantedConstraints, a)
forall a. String -&gt; TcM a -&gt; TcM (TcLevel, WantedConstraints, a)
</span><a href="GHC.Tc.Solver.html#pushLevelAndSolveEqualitiesX"><span class="hs-identifier hs-var">pushLevelAndSolveEqualitiesX</span></a></span><span>
</span><span id="line-200"></span><span>                                      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pushLevelAndSolveEqualities&quot;</span></span><span> </span><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683046583"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-201"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#report_unsolved_equalities"><span class="hs-identifier hs-type">report_unsolved_equalities</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046581"><span class="hs-identifier hs-type">skol_info_anon</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#binderVars"><span class="hs-identifier hs-type">binderVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046582"><span class="hs-identifier hs-type">tcbs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683046584"><span class="hs-identifier hs-type">tclvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046585"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-202"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683046586"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span id="local-6989586621683045368"><span class="annot"><a href="GHC.Tc.Solver.html#pushLevelAndSolveEqualitiesX"><span class="hs-identifier hs-type">pushLevelAndSolveEqualitiesX</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683045368"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-205"></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683045368"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-206"></span><span class="hs-comment">-- Push the level, gather equality constraints, and then solve them.</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- Returns any remaining unsolved equalities.</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- Does not report errors.</span><span>
</span><span id="line-209"></span><span class="hs-comment">--</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- Panics if we solve any non-equality constraints.  (In runTCSEqualities</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- we use an error thunk for the evidence bindings.)</span><span>
</span><span id="line-212"></span><span id="pushLevelAndSolveEqualitiesX"><span class="annot"><span class="annottext">pushLevelAndSolveEqualitiesX :: forall a. String -&gt; TcM a -&gt; TcM (TcLevel, WantedConstraints, a)
</span><a href="GHC.Tc.Solver.html#pushLevelAndSolveEqualitiesX"><span class="hs-identifier hs-var hs-var">pushLevelAndSolveEqualitiesX</span></a></span></span><span> </span><span id="local-6989586621683046606"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683046606"><span class="hs-identifier hs-var">callsite</span></a></span></span><span> </span><span id="local-6989586621683046607"><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683046607"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pushLevelAndSolveEqualitiesX {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Called from&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683046606"><span class="hs-identifier hs-var">callsite</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046608"><span class="annot"><a href="#local-6989586621683046608"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046609"><span class="annot"><a href="#local-6989586621683046609"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046610"><span class="annot"><a href="#local-6989586621683046610"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM (WantedConstraints, a) -&gt; TcM (TcLevel, (WantedConstraints, a))
forall a. TcM a -&gt; TcM (TcLevel, a)
</span><a href="GHC.Tc.Utils.Monad.html#pushTcLevelM"><span class="hs-identifier hs-var">pushTcLevelM</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (WantedConstraints, a)
 -&gt; TcM (TcLevel, (WantedConstraints, a)))
-&gt; TcM (WantedConstraints, a)
-&gt; TcM (TcLevel, (WantedConstraints, a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-216"></span><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046612"><span class="annot"><a href="#local-6989586621683046612"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046613"><span class="annot"><a href="#local-6989586621683046613"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM a -&gt; TcM (a, WantedConstraints)
forall a. TcM a -&gt; TcM (a, WantedConstraints)
</span><a href="GHC.Tc.Utils.Monad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683046607"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-217"></span><span>                  </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046615"><span class="annot"><a href="#local-6989586621683046615"><span class="hs-identifier hs-var">wanted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#runTcSEqualities"><span class="hs-identifier hs-type">runTcSEqualities</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyTopWanteds"><span class="hs-identifier hs-type">simplifyTopWanteds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046613"><span class="hs-identifier hs-type">wanted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683046615"><span class="hs-identifier hs-type">wanted</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621683046612"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-219"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;pushLevelAndSolveEqualities }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Residual:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046609"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-220"></span><span>                                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Level:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046608"><span class="hs-identifier hs-type">tclvl</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683046608"><span class="hs-identifier hs-type">tclvl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683046609"><span class="hs-identifier hs-type">wanted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683046610"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">-- | Type-check a thing that emits only equality constraints, solving any</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- constraints we can and re-emitting constraints that we can't.</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- Use this variant only when we'll get another crack at it later</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- See Note [Failure in local type signatures]</span><span>
</span><span id="line-227"></span><span class="hs-comment">--</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- Panics if we solve any non-equality constraints.  (In runTCSEqualities</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- we use an error thunk for the evidence bindings.)</span><span>
</span><span id="line-230"></span><span id="local-6989586621683045376"><span class="annot"><a href="GHC.Tc.Solver.html#solveEqualities"><span class="hs-identifier hs-type">solveEqualities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683045376"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683045376"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-231"></span><span id="solveEqualities"><span class="annot"><span class="annottext">solveEqualities :: forall a. String -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Solver.html#solveEqualities"><span class="hs-identifier hs-var hs-var">solveEqualities</span></a></span></span><span> </span><span id="local-6989586621683046627"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683046627"><span class="hs-identifier hs-var">callsite</span></a></span></span><span> </span><span id="local-6989586621683046628"><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683046628"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;solveEqualities {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Called from&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683046627"><span class="hs-identifier hs-var">callsite</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046629"><span class="annot"><a href="#local-6989586621683046629"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046630"><span class="annot"><a href="#local-6989586621683046630"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM a -&gt; TcM (a, WantedConstraints)
forall a. TcM a -&gt; TcM (a, WantedConstraints)
</span><a href="GHC.Tc.Utils.Monad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">TcM a
</span><a href="#local-6989586621683046628"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-234"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyAndEmitFlatConstraints"><span class="hs-identifier hs-type">simplifyAndEmitFlatConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046630"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-235"></span><span>            </span><span class="hs-comment">-- simplifyAndEmitFlatConstraints fails outright unless</span><span>
</span><span id="line-236"></span><span>            </span><span class="hs-comment">--  the only unsolved constraints are soluble-looking</span><span>
</span><span id="line-237"></span><span>            </span><span class="hs-comment">--  equalities that can float out</span><span>
</span><span id="line-238"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;solveEqualities }&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span>
</span><span id="line-239"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683046629"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyAndEmitFlatConstraints"><span class="hs-identifier hs-type">simplifyAndEmitFlatConstraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- See Note [Failure in local type signatures]</span><span>
</span><span id="line-243"></span><span id="simplifyAndEmitFlatConstraints"><span class="annot"><span class="annottext">simplifyAndEmitFlatConstraints :: WantedConstraints -&gt; TcM ()
</span><a href="GHC.Tc.Solver.html#simplifyAndEmitFlatConstraints"><span class="hs-identifier hs-var hs-var">simplifyAndEmitFlatConstraints</span></a></span></span><span> </span><span id="local-6989586621683046631"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046631"><span class="hs-identifier hs-var">wanted</span></a></span></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Solve and zonk to establish the</span><span>
</span><span id="line-245"></span><span>         </span><span class="hs-comment">-- preconditions for floatKindEqualities</span><span>
</span><span id="line-246"></span><span>         </span><span id="local-6989586621683046632"><span class="annot"><a href="#local-6989586621683046632"><span class="hs-identifier hs-var">wanted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS WantedConstraints
-&gt; IOEnv (Env TcGblEnv TcLclEnv) WantedConstraints
forall a. TcS a -&gt; TcM a
</span><a href="GHC.Tc.Solver.Monad.html#runTcSEqualities"><span class="hs-identifier hs-var">runTcSEqualities</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046631"><span class="hs-identifier hs-var">wanted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046633"><span class="annot"><a href="#local-6989586621683046633"><span class="hs-identifier hs-var">wanted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-type">TcM.liftZonkM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkWC"><span class="hs-identifier hs-type">TcM.zonkWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046632"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;emitFlatConstraints {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046633"><span class="hs-identifier hs-type">wanted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#floatKindEqualities"><span class="hs-identifier hs-type">floatKindEqualities</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046633"><span class="hs-identifier hs-type">wanted</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-251"></span><span>           </span><span class="annot"><span class="annottext">Maybe (Cts, Bag DelayedError)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;emitFlatConstraints } failing&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046633"><span class="hs-identifier hs-var">wanted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>                         </span><span class="hs-comment">-- Emit the bad constraints, wrapped in an implication</span><span>
</span><span id="line-253"></span><span>                         </span><span class="hs-comment">-- See Note [Wrapping failing kind equalities]</span><span>
</span><span id="line-254"></span><span>                         </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046637"><span class="annot"><a href="#local-6989586621683046637"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM TcLevel
</span><a href="GHC.Tc.Utils.Monad.html#getTcLevel"><span class="hs-identifier hs-var">TcM.getTcLevel</span></a></span><span>
</span><span id="line-255"></span><span>                         </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046639"><span class="annot"><a href="#local-6989586621683046639"><span class="hs-identifier hs-var">implic</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#buildTvImplication"><span class="hs-identifier hs-type">buildTvImplication</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#unkSkolAnon"><span class="hs-identifier hs-type">unkSkolAnon</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#pushTcLevel"><span class="hs-identifier hs-type">pushTcLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046637"><span class="hs-identifier hs-type">tclvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683046633"><span class="hs-identifier hs-type">wanted</span></a></span><span>
</span><span id="line-256"></span><span>                                        </span><span class="hs-comment">--                  ^^^^^^   |  ^^^^^^^^^^^^^^^^^</span><span>
</span><span id="line-257"></span><span>                                        </span><span class="hs-comment">-- it's OK to use unkSkol    |  we must increase the TcLevel,</span><span>
</span><span id="line-258"></span><span>                                        </span><span class="hs-comment">-- because we don't bind     |  as explained in</span><span>
</span><span id="line-259"></span><span>                                        </span><span class="hs-comment">-- any skolem variables here |  Note [Wrapping failing kind equalities]</span><span>
</span><span id="line-260"></span><span>                         </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#emitImplication"><span class="hs-identifier hs-type">emitImplication</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046639"><span class="hs-identifier hs-type">implic</span></a></span><span>
</span><span id="line-261"></span><span>                         </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Data.IOEnv.html#failM"><span class="hs-identifier hs-type">failM</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-262"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046644"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046644"><span class="hs-identifier hs-var">simples</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046645"><span class="annot"><span class="annottext">Bag DelayedError
</span><a href="#local-6989586621683046645"><span class="hs-identifier hs-var">errs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; VarSet -&gt; TcM Bool
VarSet -&gt; TcM Bool
</span><a href="GHC.Tc.Utils.TcMType.html#promoteTyVarSet"><span class="hs-identifier hs-var">promoteTyVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cts -&gt; VarSet
</span><a href="GHC.Tc.Types.Constraint.html#tyCoVarsOfCts"><span class="hs-identifier hs-var">tyCoVarsOfCts</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046644"><span class="hs-identifier hs-var">simples</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;emitFlatConstraints }&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-265"></span><span>                      </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;simples:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046644"><span class="hs-identifier hs-type">simples</span></a></span><span>
</span><span id="line-266"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;errs:   &quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046645"><span class="hs-identifier hs-type">errs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-267"></span><span>                      </span><span class="hs-comment">-- Holes and other delayed errors don't need promotion</span><span>
</span><span id="line-268"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#emitDelayedErrors"><span class="hs-identifier hs-type">emitDelayedErrors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046645"><span class="hs-identifier hs-type">errs</span></a></span><span>
</span><span id="line-269"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#emitSimples"><span class="hs-identifier hs-type">emitSimples</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046644"><span class="hs-identifier hs-type">simples</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="annot"><a href="GHC.Tc.Solver.html#floatKindEqualities"><span class="hs-identifier hs-type">floatKindEqualities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#DelayedError"><span class="hs-identifier hs-type">DelayedError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- Float out all the constraints from the WantedConstraints,</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- Return Nothing if any constraints can't be floated (captured</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- by skolems), or if there is an insoluble constraint, or</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- IC_Telescope telescope error</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- Precondition 1: we have tried to solve the 'wanteds', both so that</span><span>
</span><span id="line-277"></span><span class="hs-comment">--    the ic_status field is set, and because solving can make constraints</span><span>
</span><span id="line-278"></span><span class="hs-comment">--    more floatable.</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- Precondition 2: the 'wanteds' are zonked, since floatKindEqualities</span><span>
</span><span id="line-280"></span><span class="hs-comment">--    is not monadic</span><span>
</span><span id="line-281"></span><span class="hs-comment">-- See Note [floatKindEqualities vs approximateWC]</span><span>
</span><span id="line-282"></span><span id="floatKindEqualities"><span class="annot"><span class="annottext">floatKindEqualities :: WantedConstraints -&gt; Maybe (Cts, Bag DelayedError)
</span><a href="GHC.Tc.Solver.html#floatKindEqualities"><span class="hs-identifier hs-var hs-var">floatKindEqualities</span></a></span></span><span> </span><span id="local-6989586621683046649"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046649"><span class="hs-identifier hs-var">wc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; WantedConstraints -&gt; Maybe (Cts, Bag DelayedError)
</span><a href="#local-6989586621683046650"><span class="hs-identifier hs-var">float_wc</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046649"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><a href="#local-6989586621683046650"><span class="hs-identifier hs-type">float_wc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#DelayedError"><span class="hs-identifier hs-type">DelayedError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>    </span><span id="local-6989586621683046650"><span class="annot"><span class="annottext">float_wc :: VarSet -&gt; WantedConstraints -&gt; Maybe (Cts, Bag DelayedError)
</span><a href="#local-6989586621683046650"><span class="hs-identifier hs-var hs-var">float_wc</span></a></span></span><span> </span><span id="local-6989586621683046653"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683046653"><span class="hs-identifier hs-var">trapping_tvs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046655"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046655"><span class="hs-identifier hs-var">simples</span></a></span></span><span>
</span><span id="line-286"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046657"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683046657"><span class="hs-identifier hs-var">implics</span></a></span></span><span>
</span><span id="line-287"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_errors :: WantedConstraints -&gt; Bag DelayedError
</span><a href="GHC.Tc.Types.Constraint.html#wc_errors"><span class="hs-identifier hs-var">wc_errors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046659"><span class="annot"><span class="annottext">Bag DelayedError
</span><a href="#local-6989586621683046659"><span class="hs-identifier hs-var">errs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Bool) -&gt; Cts -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Bool
</span><a href="#local-6989586621683046661"><span class="hs-identifier hs-var">is_floatable</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046655"><span class="hs-identifier hs-var">simples</span></a></span><span>
</span><span id="line-289"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046662"><span class="annot"><a href="#local-6989586621683046662"><span class="hs-identifier hs-var">inner_simples</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046663"><span class="annot"><a href="#local-6989586621683046663"><span class="hs-identifier hs-var">inner_errs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Implication -&gt; Maybe (Cts, Bag DelayedError))
-&gt; Bag Implication -&gt; Maybe (Cts, Bag DelayedError)
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; m (Bag b, Bag c)) -&gt; Bag a -&gt; m (Bag b, Bag c)
</span><a href="GHC.Data.Bag.html#flatMapBagPairM"><span class="hs-identifier hs-var">flatMapBagPairM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; Implication -&gt; Maybe (Cts, Bag DelayedError)
</span><a href="#local-6989586621683046665"><span class="hs-identifier hs-var">float_implic</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683046653"><span class="hs-identifier hs-var">trapping_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683046657"><span class="hs-identifier hs-var">implics</span></a></span><span>
</span><span id="line-291"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621683046655"><span class="hs-identifier hs-type">simples</span></a></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-type">`unionBags`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046662"><span class="hs-identifier hs-type">inner_simples</span></a></span><span>
</span><span id="line-292"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683046659"><span class="hs-identifier hs-type">errs</span></a></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-type">`unionBags`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046663"><span class="hs-identifier hs-type">inner_errs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-293"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-294"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Cts, Bag DelayedError)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-295"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-296"></span><span>        </span><span id="local-6989586621683046661"><span class="annot"><span class="annottext">is_floatable :: Ct -&gt; Bool
</span><a href="#local-6989586621683046661"><span class="hs-identifier hs-var hs-var">is_floatable</span></a></span></span><span> </span><span id="local-6989586621683046666"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046666"><span class="hs-identifier hs-var">ct</span></a></span></span><span>
</span><span id="line-297"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#insolubleCt"><span class="hs-identifier hs-var">insolubleCt</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046666"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-298"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; VarSet
</span><a href="GHC.Tc.Types.Constraint.html#tyCoVarsOfCt"><span class="hs-identifier hs-var">tyCoVarsOfCt</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046666"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#disjointVarSet"><span class="hs-operator hs-var">`disjointVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683046653"><span class="hs-identifier hs-var">trapping_tvs</span></a></span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><a href="#local-6989586621683046665"><span class="hs-identifier hs-type">float_implic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#DelayedError"><span class="hs-identifier hs-type">DelayedError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>    </span><span id="local-6989586621683046665"><span class="annot"><span class="annottext">float_implic :: VarSet -&gt; Implication -&gt; Maybe (Cts, Bag DelayedError)
</span><a href="#local-6989586621683046665"><span class="hs-identifier hs-var hs-var">float_implic</span></a></span></span><span> </span><span id="local-6989586621683046670"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683046670"><span class="hs-identifier hs-var">trapping_tvs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implic"><span class="hs-identifier hs-type">Implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ic_wanted :: Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046673"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046673"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_given_eqs :: Implication -&gt; HasGivenEqs
</span><a href="GHC.Tc.Types.Constraint.html#ic_given_eqs"><span class="hs-identifier hs-var">ic_given_eqs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046675"><span class="annot"><span class="annottext">HasGivenEqs
</span><a href="#local-6989586621683046675"><span class="hs-identifier hs-var">given_eqs</span></a></span></span><span>
</span><span id="line-302"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_skols :: Implication -&gt; [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#ic_skols"><span class="hs-identifier hs-var">ic_skols</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046677"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683046677"><span class="hs-identifier hs-var">skols</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_status :: Implication -&gt; ImplicStatus
</span><a href="GHC.Tc.Types.Constraint.html#ic_status"><span class="hs-identifier hs-var">ic_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046679"><span class="annot"><span class="annottext">ImplicStatus
</span><a href="#local-6989586621683046679"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ImplicStatus -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isInsolubleStatus"><span class="hs-identifier hs-var">isInsolubleStatus</span></a></span><span> </span><span class="annot"><span class="annottext">ImplicStatus
</span><a href="#local-6989586621683046679"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-304"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Cts, Bag DelayedError)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-comment">-- A short cut /plus/ we must keep track of IC_BadTelescope</span><span>
</span><span id="line-305"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-306"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046681"><span class="annot"><a href="#local-6989586621683046681"><span class="hs-identifier hs-var">simples</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046682"><span class="annot"><a href="#local-6989586621683046682"><span class="hs-identifier hs-var">holes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; WantedConstraints -&gt; Maybe (Cts, Bag DelayedError)
</span><a href="#local-6989586621683046650"><span class="hs-identifier hs-var">float_wc</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683046683"><span class="hs-identifier hs-var">new_trapping_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046673"><span class="hs-identifier hs-var">wanted</span></a></span><span>
</span><span id="line-307"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-type">isEmptyBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046681"><span class="hs-identifier hs-type">simples</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><a href="#local-6989586621683046675"><span class="hs-identifier hs-type">given_eqs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#MaybeGivenEqs"><span class="hs-identifier hs-type">MaybeGivenEqs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-308"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-309"></span><span>                 </span><span class="hs-comment">-- If there are some constraints to float out, but we can't</span><span>
</span><span id="line-310"></span><span>                 </span><span class="hs-comment">-- because we don't float out past local equalities</span><span>
</span><span id="line-311"></span><span>                 </span><span class="hs-comment">-- (c.f GHC.Tc.Solver.approximateWC), then fail</span><span>
</span><span id="line-312"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683046681"><span class="hs-identifier hs-type">simples</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683046682"><span class="hs-identifier hs-type">holes</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-313"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-314"></span><span>        </span><span id="local-6989586621683046683"><span class="annot"><span class="annottext">new_trapping_tvs :: VarSet
</span><a href="#local-6989586621683046683"><span class="hs-identifier hs-var hs-var">new_trapping_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683046670"><span class="hs-identifier hs-var">trapping_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [TcTyVar] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSetList"><span class="hs-operator hs-var">`extendVarSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683046677"><span class="hs-identifier hs-var">skols</span></a></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span class="hs-comment">{- Note [Failure in local type signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When kind checking a type signature, we like to fail fast if we can't
solve all the kind equality constraints, for two reasons:

  * A kind-bogus type signature may cause a cascade of knock-on
    errors if we let it pass

  * More seriously, we don't have a convenient term-level place to add
    deferred bindings for unsolved kind-equality constraints.  In
    earlier GHCs this led to un-filled-in coercion holes, which caused
    GHC to crash with &quot;fvProv falls into a hole&quot; See #11563, #11520,
    #11516, #11399

But what about /local/ type signatures, mentioning in-scope type
variables for which there might be 'given' equalities?  For these we
might not be able to solve all the equalities locally. Here's an
example (T15076b):

  class (a ~ b) =&gt; C a b
  data SameKind :: k -&gt; k -&gt; Type where { SK :: SameKind a b }

  bar :: forall (a :: Type) (b :: Type).
         C a b =&gt; Proxy a -&gt; Proxy b -&gt; ()
  bar _ _ = const () (undefined :: forall (x :: a) (y :: b). SameKind x y)

Consider the type signature on 'undefined'. It's ill-kinded unless
a~b.  But the superclass of (C a b) means that indeed (a~b). So all
should be well. BUT it's hard to see that when kind-checking the signature
for undefined.  We want to emit a residual (a~b) constraint, to solve
later.

Another possibility is that we might have something like
   F alpha ~ [Int]
where alpha is bound further out, which might become soluble
&quot;later&quot; when we learn more about alpha.  So we want to emit
those residual constraints.

BUT it's no good simply wrapping all unsolved constraints from
a type signature in an implication constraint to solve later. The
problem is that we are going to /use/ that signature, including
instantiate it.  Say we have
     f :: forall a.  (forall b. blah) -&gt; blah2
     f x = &lt;body&gt;
To typecheck the definition of f, we have to instantiate those
foralls.  Moreover, any unsolved kind equalities will be coercion
holes in the type.  If we naively wrap them in an implication like
     forall a. (co1:k1~k2,  forall b.  co2:k3~k4)
hoping to solve it later, we might end up filling in the holes
co1 and co2 with coercions involving 'a' and 'b' -- but by now
we've instantiated the type.  Chaos!

Moreover, the unsolved constraints might be skolem-escape things, and
if we proceed with f bound to a nonsensical type, we get a cascade of
follow-up errors. For example polykinds/T12593, T15577, and many others.

So here's the plan (see tcHsSigType):

* pushLevelAndSolveEqualitiesX: try to solve the constraints

* kindGeneraliseSome: do kind generalisation

* buildTvImplication: build an implication for the residual, unsolved
  constraint

* simplifyAndEmitFlatConstraints: try to float out every unsolved equality
  inside that implication, in the hope that it constrains only global
  type variables, not the locally-quantified ones.

  * If we fail, or find an insoluble constraint, emit the implication,
    so that the errors will be reported, and fail.

  * If we succeed in floating all the equalities, promote them and
    re-emit them as flat constraint, not wrapped at all (since they
    don't mention any of the quantified variables.

* Note that this float-and-promote step means that anonymous
  wildcards get floated to top level, as we want; see
  Note [Checking partial type signatures] in GHC.Tc.Gen.HsType.

All this is done:

* In GHC.Tc.Gen.HsType.tcHsSigType, as above

* solveEqualities. Use this when there no kind-generalisation
  step to complicate matters; then we don't need to push levels,
  and can solve the equalities immediately without needing to
  wrap it in an implication constraint.  (You'll generally see
  a kindGeneraliseNone nearby.)

* In GHC.Tc.TyCl and GHC.Tc.TyCl.Instance; see calls to
  pushLevelAndSolveEqualitiesX, followed by quantification, and
  then reportUnsolvedEqualities.

  NB: we call reportUnsolvedEqualities before zonkTcTypeToType
  because the latter does not expect to see any un-filled-in
  coercions, which will happen if we have unsolved equalities.
  By calling reportUnsolvedEqualities first, which fails after
  reporting errors, we avoid that happening.

See also #18062, #11506

Note [Wrapping failing kind equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In simplifyAndEmitFlatConstraints, if we fail to get down to simple
flat constraints we will
* re-emit the constraints so that they are reported
* fail in the monad
But there is a Terrible Danger that, if -fdefer-type-errors is on, and
we just re-emit an insoluble constraint like (* ~ (*-&gt;*)), that we'll
report only a warning and proceed with compilation.  But if we ever fail
in the monad it should be fatal; we should report an error and stop after
the type checker.  If not, chaos results: #19142.

Our solution is this:
* Even with -fdefer-type-errors, inside an implication with no place for
  value bindings (ic_binds = CoEvBindsVar), report failing equalities as
  errors.  We have to do this anyway; see GHC.Tc.Errors
  Note [Failing equalities with no evidence bindings].

* Right here in simplifyAndEmitFlatConstraints, use buildTvImplication
  to wrap the failing constraint in a degenerate implication (no
  skolems, no theta), with ic_binds = CoEvBindsVar.  This setting of
  `ic_binds` means that any failing equalities will lead to an
  error not a warning, irrespective of -fdefer-type-errors: see
  Note [Failing equalities with no evidence bindings] in GHC.Tc.Errors,
  and `maybeSwitchOffDefer` in that module.

  We still take care to bump the TcLevel of the implication.  Partly,
  that ensures that nested implications have increasing level numbers
  which seems nice.  But more specifically, suppose the outer level
  has a Given `(C ty)`, which has pending (not-yet-expanded)
  superclasses. Consider what happens when we process this implication
  constraint (which we have re-emitted) in that context:
    - in the inner implication we'll call `getPendingGivenScs`,
    - we /do not/ want to get the `(C ty)` from the outer level,
    lest we try to add an evidence term for the superclass,
    which we can't do because we have specifically set
    `ic_binds` = `CoEvBindsVar`.
    - as `getPendingGivenSCcs is careful to only get Givens from
    the /current/ level, and we bumped the `TcLevel` of the implication,
    we're OK.

  TL;DR: bump the `TcLevel` when creating the nested implication.
  If we don't we get a panic in `GHC.Tc.Utils.Monad.addTcEvBind` (#20043).


We re-emit the implication rather than reporting the errors right now,
so that the error messages are improved by other solving and defaulting.
e.g. we prefer
    Cannot match 'Type-&gt;Type' with 'Type'
to  Cannot match 'Type-&gt;Type' with 'TYPE r0'


Note [floatKindEqualities vs approximateWC]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
floatKindEqualities and approximateWC are strikingly similar to each
other, but

* floatKindEqualites tries to float /all/ equalities, and fails if
  it can't, or if any implication is insoluble.
* approximateWC just floats out any constraints
  (not just equalities) that can float; it never fails.
-}</span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span class="annot"><a href="GHC.Tc.Solver.html#reportUnsolvedEqualities"><span class="hs-identifier hs-type">reportUnsolvedEqualities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span>
</span><span id="line-484"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span class="hs-comment">-- Reports all unsolved wanteds provided; fails in the monad if there are any.</span><span>
</span><span id="line-486"></span><span class="hs-comment">--</span><span>
</span><span id="line-487"></span><span class="hs-comment">-- The provided SkolemInfo and [TcTyVar] arguments are used in an implication to</span><span>
</span><span id="line-488"></span><span class="hs-comment">-- provide skolem info for any errors.</span><span>
</span><span id="line-489"></span><span id="reportUnsolvedEqualities"><span class="annot"><span class="annottext">reportUnsolvedEqualities :: SkolemInfo -&gt; [TcTyVar] -&gt; TcLevel -&gt; WantedConstraints -&gt; TcM ()
</span><a href="GHC.Tc.Solver.html#reportUnsolvedEqualities"><span class="hs-identifier hs-var hs-var">reportUnsolvedEqualities</span></a></span></span><span> </span><span id="local-6989586621683046689"><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683046689"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683046690"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683046690"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span> </span><span id="local-6989586621683046691"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683046691"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span> </span><span id="local-6989586621683046692"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046692"><span class="hs-identifier hs-var">wanted</span></a></span></span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
-&gt; [TcTyVar] -&gt; TcLevel -&gt; WantedConstraints -&gt; TcM ()
</span><a href="GHC.Tc.Solver.html#report_unsolved_equalities"><span class="hs-identifier hs-var">report_unsolved_equalities</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SkolemInfo -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#getSkolemInfo"><span class="hs-identifier hs-var">getSkolemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683046689"><span class="hs-identifier hs-var">skol_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683046690"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683046691"><span class="hs-identifier hs-var">tclvl</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046692"><span class="hs-identifier hs-var">wanted</span></a></span><span>
</span><span id="line-491"></span><span>
</span><span id="line-492"></span><span class="annot"><a href="GHC.Tc.Solver.html#report_unsolved_equalities"><span class="hs-identifier hs-type">report_unsolved_equalities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfoAnon"><span class="hs-identifier hs-type">SkolemInfoAnon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span>
</span><span id="line-493"></span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span id="report_unsolved_equalities"><span class="annot"><span class="annottext">report_unsolved_equalities :: SkolemInfoAnon
-&gt; [TcTyVar] -&gt; TcLevel -&gt; WantedConstraints -&gt; TcM ()
</span><a href="GHC.Tc.Solver.html#report_unsolved_equalities"><span class="hs-identifier hs-var hs-var">report_unsolved_equalities</span></a></span></span><span> </span><span id="local-6989586621683046694"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683046694"><span class="hs-identifier hs-var">skol_info_anon</span></a></span></span><span> </span><span id="local-6989586621683046695"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683046695"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span> </span><span id="local-6989586621683046696"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683046696"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span> </span><span id="local-6989586621683046697"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046697"><span class="hs-identifier hs-var">wanted</span></a></span></span><span>
</span><span id="line-495"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046697"><span class="hs-identifier hs-var">wanted</span></a></span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- NB: we build an implication /even if skol_tvs is empty/,</span><span>
</span><span id="line-499"></span><span>               </span><span class="hs-comment">-- just to ensure that our level invariants hold, specifically</span><span>
</span><span id="line-500"></span><span>               </span><span class="hs-comment">-- (WantedInv).  See Note [TcLevel invariants].</span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM () -&gt; TcM ()
forall r. TcM r -&gt; TcM r
</span><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>   </span><span class="hs-comment">-- Fail</span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046700"><span class="annot"><a href="#local-6989586621683046700"><span class="hs-identifier hs-var">implic</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
-&gt; [TcTyVar] -&gt; TcLevel -&gt; WantedConstraints -&gt; TcM Implication
</span><a href="GHC.Tc.Utils.Unify.html#buildTvImplication"><span class="hs-identifier hs-var">buildTvImplication</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683046694"><span class="hs-identifier hs-var">skol_info_anon</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683046695"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683046696"><span class="hs-identifier hs-var">tclvl</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046697"><span class="hs-identifier hs-var">wanted</span></a></span><span>
</span><span id="line-503"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.html#reportAllUnsolved"><span class="hs-identifier hs-type">reportAllUnsolved</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkImplicWC"><span class="hs-identifier hs-type">mkImplicWC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#unitBag"><span class="hs-identifier hs-type">unitBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046700"><span class="hs-identifier hs-type">implic</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span class="hs-comment">-- | Simplify top-level constraints, but without reporting any unsolved</span><span>
</span><span id="line-507"></span><span class="hs-comment">-- constraints nor unsafe overlapping.</span><span>
</span><span id="line-508"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyTopWanteds"><span class="hs-identifier hs-type">simplifyTopWanteds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-509"></span><span id="simplifyTopWanteds"><span class="annot"><span class="annottext">simplifyTopWanteds :: WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#simplifyTopWanteds"><span class="hs-identifier hs-var hs-var">simplifyTopWanteds</span></a></span></span><span> </span><span id="local-6989586621683046703"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046703"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Solve the constraints</span><span>
</span><span id="line-511"></span><span>         </span><span id="local-6989586621683046704"><span class="annot"><a href="#local-6989586621683046704"><span class="hs-identifier hs-var">wc_first_go</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS WantedConstraints -&gt; TcS WantedConstraints
forall a. TcS a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#nestTcS"><span class="hs-identifier hs-var">nestTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046703"><span class="hs-identifier hs-var">wanteds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span>         </span><span class="hs-comment">-- Now try defaulting:</span><span>
</span><span id="line-514"></span><span>         </span><span class="hs-comment">-- see Note [Top-level Defaulting Plan]</span><span>
</span><span id="line-515"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#tryDefaulting"><span class="hs-identifier hs-type">tryDefaulting</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046704"><span class="hs-identifier hs-type">wc_first_go</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span class="hs-comment">--------------------------</span><span>
</span><span id="line-518"></span><span class="annot"><a href="GHC.Tc.Solver.html#tryDefaulting"><span class="hs-identifier hs-type">tryDefaulting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-519"></span><span id="tryDefaulting"><span class="annot"><span class="annottext">tryDefaulting :: WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#tryDefaulting"><span class="hs-identifier hs-var hs-var">tryDefaulting</span></a></span></span><span> </span><span id="local-6989586621683046707"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046707"><span class="hs-identifier hs-var">wc</span></a></span></span><span>
</span><span id="line-520"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046708"><span class="annot"><a href="#local-6989586621683046708"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-521"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tryDefaulting:before&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046707"><span class="hs-identifier hs-type">wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046711"><span class="annot"><a href="#local-6989586621683046711"><span class="hs-identifier hs-var">wc1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#tryTyVarDefaulting"><span class="hs-identifier hs-type">tryTyVarDefaulting</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046708"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046707"><span class="hs-identifier hs-type">wc</span></a></span><span>
</span><span id="line-523"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046713"><span class="annot"><a href="#local-6989586621683046713"><span class="hs-identifier hs-var">wc2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#tryConstraintDefaulting"><span class="hs-identifier hs-type">tryConstraintDefaulting</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046711"><span class="hs-identifier hs-type">wc1</span></a></span><span>
</span><span id="line-524"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046715"><span class="annot"><a href="#local-6989586621683046715"><span class="hs-identifier hs-var">wc3</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#tryTypeClassDefaulting"><span class="hs-identifier hs-type">tryTypeClassDefaulting</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046713"><span class="hs-identifier hs-type">wc2</span></a></span><span>
</span><span id="line-525"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046717"><span class="annot"><a href="#local-6989586621683046717"><span class="hs-identifier hs-var">wc4</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#tryUnsatisfiableGivens"><span class="hs-identifier hs-type">tryUnsatisfiableGivens</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046715"><span class="hs-identifier hs-type">wc3</span></a></span><span>
</span><span id="line-526"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tryDefaulting:after&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046717"><span class="hs-identifier hs-type">wc4</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683046717"><span class="hs-identifier hs-type">wc4</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span class="annot"><a href="GHC.Tc.Solver.html#solveAgainIf"><span class="hs-identifier hs-type">solveAgainIf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-530"></span><span class="hs-comment">-- If the Bool is true, solve the wanted constraints again</span><span>
</span><span id="line-531"></span><span class="hs-comment">-- See Note [Must simplify after defaulting]</span><span>
</span><span id="line-532"></span><span id="solveAgainIf"><span class="annot"><span class="annottext">solveAgainIf :: Bool -&gt; WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#solveAgainIf"><span class="hs-identifier hs-var hs-var">solveAgainIf</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span id="local-6989586621683046720"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046720"><span class="hs-identifier hs-var">wc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046720"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-533"></span><span class="annot"><a href="GHC.Tc.Solver.html#solveAgainIf"><span class="hs-identifier hs-var">solveAgainIf</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span id="local-6989586621683046721"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046721"><span class="hs-identifier hs-var">wc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS WantedConstraints -&gt; TcS WantedConstraints
forall a. TcS a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#nestTcS"><span class="hs-identifier hs-var">nestTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046721"><span class="hs-identifier hs-var">wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span class="hs-comment">--------------------------</span><span>
</span><span id="line-536"></span><span class="annot"><a href="GHC.Tc.Solver.html#tryTyVarDefaulting"><span class="hs-identifier hs-type">tryTyVarDefaulting</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-537"></span><span id="tryTyVarDefaulting"><span class="annot"><span class="annottext">tryTyVarDefaulting :: DynFlags -&gt; WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#tryTyVarDefaulting"><span class="hs-identifier hs-var hs-var">tryTyVarDefaulting</span></a></span></span><span> </span><span id="local-6989586621683046722"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683046722"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683046723"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046723"><span class="hs-identifier hs-var">wc</span></a></span></span><span>
</span><span id="line-538"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046723"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046723"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#insolubleWC"><span class="hs-identifier hs-var">insolubleWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046723"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_PrintExplicitRuntimeReps"><span class="hs-identifier hs-var">Opt_PrintExplicitRuntimeReps</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683046722"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-comment">-- See Note [Defaulting insolubles]</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046723"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Need to zonk first, as the WantedConstraints are not yet zonked.</span><span>
</span><span id="line-545"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046727"><span class="annot"><a href="#local-6989586621683046727"><span class="hs-identifier hs-var">free_tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; TcS [TcTyVar]
</span><a href="GHC.Tc.Solver.Monad.html#zonkTyCoVarsAndFVList"><span class="hs-identifier hs-var">TcS.zonkTyCoVarsAndFVList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#tyCoVarsOfWCList"><span class="hs-identifier hs-var">tyCoVarsOfWCList</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046723"><span class="hs-identifier hs-var">wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683046730"><span class="annot"><a href="#local-6989586621683046730"><span class="hs-identifier hs-var hs-var">defaultable_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; [TcTyVar] -&gt; [TcTyVar]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="#local-6989586621683046731"><span class="hs-identifier hs-var">can_default</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683046727"><span class="hs-identifier hs-var">free_tvs</span></a></span><span>
</span><span id="line-547"></span><span>             </span><span id="local-6989586621683046731"><span class="annot"><a href="#local-6989586621683046731"><span class="hs-identifier hs-var hs-var">can_default</span></a></span></span><span> </span><span id="local-6989586621683046732"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046732"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-548"></span><span>               </span><span class="hs-glyph">=</span><span>   </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046732"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-549"></span><span>                   </span><span class="hs-comment">-- Weed out coercion variables.</span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046732"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-552"></span><span>                   </span><span class="hs-comment">-- Weed out runtime-skolems in GHCi, which we definitely</span><span>
</span><span id="line-553"></span><span>                   </span><span class="hs-comment">-- shouldn't try to default.</span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046732"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; VarSet
</span><a href="GHC.Tc.Types.Constraint.html#nonDefaultableTyVarsOfWC"><span class="hs-identifier hs-var">nonDefaultableTyVarsOfWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046723"><span class="hs-identifier hs-var">wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>                   </span><span class="hs-comment">-- Weed out variables for which defaulting would be unhelpful,</span><span>
</span><span id="line-557"></span><span>                   </span><span class="hs-comment">-- e.g. alpha appearing in [W] alpha[conc] ~# rr[sk].</span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046737"><span class="annot"><a href="#local-6989586621683046737"><span class="hs-identifier hs-var">unification_s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#defaultTyVarTcS"><span class="hs-identifier hs-type">defaultTyVarTcS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046730"><span class="hs-identifier hs-type">defaultable_tvs</span></a></span><span> </span><span class="hs-comment">-- Has unification side effects</span><span>
</span><span id="line-560"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#solveAgainIf"><span class="hs-identifier hs-type">solveAgainIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">or</span></span><span> </span><span class="annot"><a href="#local-6989586621683046737"><span class="hs-identifier hs-type">unification_s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683046723"><span class="hs-identifier hs-type">wc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-561"></span><span>             </span><span class="hs-comment">-- solveAgainIf: see Note [Must simplify after defaulting]</span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-564"></span><span class="hs-comment">-- | If an implication contains a Given of the form @Unsatisfiable msg@,</span><span>
</span><span id="line-565"></span><span class="hs-comment">-- use it to solve all Wanteds within the implication.</span><span>
</span><span id="line-566"></span><span class="hs-comment">-- See point (C) in Note [Implementation of Unsatisfiable constraints] in GHC.Tc.Errors.</span><span>
</span><span id="line-567"></span><span class="hs-comment">--</span><span>
</span><span id="line-568"></span><span class="hs-comment">-- This does a complete walk over the implication tree.</span><span>
</span><span id="line-569"></span><span class="annot"><a href="GHC.Tc.Solver.html#tryUnsatisfiableGivens"><span class="hs-identifier hs-type">tryUnsatisfiableGivens</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-570"></span><span id="tryUnsatisfiableGivens"><span class="annot"><span class="annottext">tryUnsatisfiableGivens :: WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#tryUnsatisfiableGivens"><span class="hs-identifier hs-var hs-var">tryUnsatisfiableGivens</span></a></span></span><span> </span><span id="local-6989586621683046741"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046741"><span class="hs-identifier hs-var">wc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-571"></span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046742"><span class="annot"><a href="#local-6989586621683046742"><span class="hs-identifier hs-var">final_wc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046743"><span class="annot"><a href="#local-6989586621683046743"><span class="hs-identifier hs-var">did_work</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateT Bool TcS WantedConstraints
-&gt; Bool -&gt; TcS (WantedConstraints, Bool)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.State.Strict.html#runStateT"><span class="hs-operator hs-var">`runStateT`</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT Bool TcS WantedConstraints
 -&gt; TcS (WantedConstraints, Bool))
-&gt; StateT Bool TcS WantedConstraints
-&gt; TcS (WantedConstraints, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; StateT Bool TcS WantedConstraints
</span><a href="#local-6989586621683046744"><span class="hs-identifier hs-var">go_wc</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046741"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-572"></span><span>     </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#solveAgainIf"><span class="hs-identifier hs-type">solveAgainIf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046743"><span class="hs-identifier hs-type">did_work</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046742"><span class="hs-identifier hs-type">final_wc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-573"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-574"></span><span>    </span><span id="local-6989586621683046744"><span class="annot"><span class="annottext">go_wc :: WantedConstraints -&gt; StateT Bool TcS WantedConstraints
</span><a href="#local-6989586621683046744"><span class="hs-identifier hs-var hs-var">go_wc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046759"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046759"><span class="hs-identifier hs-var">wtds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046760"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683046760"><span class="hs-identifier hs-var">impls</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_errors :: WantedConstraints -&gt; Bag DelayedError
</span><a href="GHC.Tc.Types.Constraint.html#wc_errors"><span class="hs-identifier hs-var">wc_errors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046761"><span class="annot"><span class="annottext">Bag DelayedError
</span><a href="#local-6989586621683046761"><span class="hs-identifier hs-var">errs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683046762"><span class="annot"><a href="#local-6989586621683046762"><span class="hs-identifier hs-var">impls'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Implication -&gt; StateT Bool TcS (Maybe Implication))
-&gt; Bag Implication -&gt; StateT Bool TcS (Bag Implication)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m (Maybe b)) -&gt; Bag a -&gt; m (Bag b)
</span><a href="GHC.Data.Bag.html#mapMaybeBagM"><span class="hs-identifier hs-var">mapMaybeBagM</span></a></span><span> </span><span class="annot"><span class="annottext">Implication -&gt; StateT Bool TcS (Maybe Implication)
</span><a href="#local-6989586621683046764"><span class="hs-identifier hs-var">go_impl</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683046760"><span class="hs-identifier hs-var">impls</span></a></span><span>
</span><span id="line-576"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046759"><span class="hs-identifier hs-type">wtds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046762"><span class="hs-identifier hs-type">impls'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_errors"><span class="hs-identifier hs-var">wc_errors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046761"><span class="hs-identifier hs-type">errs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-577"></span><span>    </span><span id="local-6989586621683046764"><span class="annot"><span class="annottext">go_impl :: Implication -&gt; StateT Bool TcS (Maybe Implication)
</span><a href="#local-6989586621683046764"><span class="hs-identifier hs-var hs-var">go_impl</span></a></span></span><span> </span><span id="local-6989586621683046765"><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046765"><span class="hs-identifier hs-var">impl</span></a></span></span><span>
</span><span id="line-578"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ImplicStatus -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isSolvedStatus"><span class="hs-identifier hs-var">isSolvedStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; ImplicStatus
</span><a href="GHC.Tc.Types.Constraint.html#ic_status"><span class="hs-identifier hs-var">ic_status</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046765"><span class="hs-identifier hs-var">impl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Implication -&gt; StateT Bool TcS (Maybe Implication)
forall a. a -&gt; StateT Bool TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Implication -&gt; StateT Bool TcS (Maybe Implication))
-&gt; Maybe Implication -&gt; StateT Bool TcS (Maybe Implication)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Implication -&gt; Maybe Implication
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046765"><span class="hs-identifier hs-var">impl</span></a></span><span>
</span><span id="line-580"></span><span>      </span><span class="hs-comment">-- Is there a Given with type &quot;Unsatisfiable msg&quot;?</span><span>
</span><span id="line-581"></span><span>      </span><span class="hs-comment">-- If so, use it to solve all other Wanteds.</span><span>
</span><span id="line-582"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683046767"><span class="annot"><span class="annottext">(TcTyVar, TcType)
</span><a href="#local-6989586621683046767"><span class="hs-identifier hs-var">unsat_given</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Maybe (TcTyVar, TcType))
-&gt; [TcTyVar] -&gt; [(TcTyVar, TcType)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Maybe (TcTyVar, TcType)
</span><a href="GHC.Tc.Solver.html#unsatisfiableEv_maybe"><span class="hs-identifier hs-var">unsatisfiableEv_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#ic_given"><span class="hs-identifier hs-var">ic_given</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046765"><span class="hs-identifier hs-var">impl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; StateT Bool TcS ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.State.Strict.html#put"><span class="hs-identifier hs-var">put</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-584"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS (Maybe Implication) -&gt; StateT Bool TcS (Maybe Implication)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT Bool m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (Maybe Implication) -&gt; StateT Bool TcS (Maybe Implication))
-&gt; TcS (Maybe Implication) -&gt; StateT Bool TcS (Maybe Implication)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TcTyVar, TcType) -&gt; Implication -&gt; TcS (Maybe Implication)
</span><a href="GHC.Tc.Solver.html#solveImplicationUsingUnsatGiven"><span class="hs-identifier hs-var">solveImplicationUsingUnsatGiven</span></a></span><span> </span><span class="annot"><span class="annottext">(TcTyVar, TcType)
</span><a href="#local-6989586621683046767"><span class="hs-identifier hs-var">unsat_given</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046765"><span class="hs-identifier hs-var">impl</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-585"></span><span>      </span><span class="hs-comment">-- Otherwise, recurse.</span><span>
</span><span id="line-586"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-587"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046771"><span class="annot"><a href="#local-6989586621683046771"><span class="hs-identifier hs-var">wcs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; StateT Bool TcS WantedConstraints
</span><a href="#local-6989586621683046744"><span class="hs-identifier hs-var">go_wc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046765"><span class="hs-identifier hs-var">impl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-588"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.2-38b1/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-type">lift</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#setImplicationStatus"><span class="hs-identifier hs-type">setImplicationStatus</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621683046765"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046771"><span class="hs-identifier hs-type">wcs'</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="hs-comment">-- | Is this evidence variable the evidence for an 'Unsatisfiable' constraint?</span><span>
</span><span id="line-591"></span><span class="hs-comment">--</span><span>
</span><span id="line-592"></span><span class="hs-comment">-- If so, return the variable itself together with the error message type.</span><span>
</span><span id="line-593"></span><span class="annot"><a href="GHC.Tc.Solver.html#unsatisfiableEv_maybe"><span class="hs-identifier hs-type">unsatisfiableEv_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-594"></span><span id="unsatisfiableEv_maybe"><span class="annot"><span class="annottext">unsatisfiableEv_maybe :: TcTyVar -&gt; Maybe (TcTyVar, TcType)
</span><a href="GHC.Tc.Solver.html#unsatisfiableEv_maybe"><span class="hs-identifier hs-var hs-var">unsatisfiableEv_maybe</span></a></span></span><span> </span><span id="local-6989586621683046775"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046775"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046775"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; (TcTyVar, TcType))
-&gt; Maybe TcType -&gt; Maybe (TcTyVar, TcType)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
</span><a href="GHC.Tc.Types.Constraint.html#isUnsatisfiableCt_maybe"><span class="hs-identifier hs-var">isUnsatisfiableCt_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046775"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span class="hs-comment">-- | We have an implication with an 'Unsatisfiable' Given; use that Given to</span><span>
</span><span id="line-597"></span><span class="hs-comment">-- solve all the other Wanted constraints, including those nested within</span><span>
</span><span id="line-598"></span><span class="hs-comment">-- deeper implications.</span><span>
</span><span id="line-599"></span><span class="annot"><a href="GHC.Tc.Solver.html#solveImplicationUsingUnsatGiven"><span class="hs-identifier hs-type">solveImplicationUsingUnsatGiven</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-600"></span><span id="solveImplicationUsingUnsatGiven"><span class="annot"><span class="annottext">solveImplicationUsingUnsatGiven :: (TcTyVar, TcType) -&gt; Implication -&gt; TcS (Maybe Implication)
</span><a href="GHC.Tc.Solver.html#solveImplicationUsingUnsatGiven"><span class="hs-identifier hs-var hs-var">solveImplicationUsingUnsatGiven</span></a></span></span><span>
</span><span id="line-601"></span><span>  </span><span id="local-6989586621683046778"><span class="annot"><span class="annottext">unsat_given :: (TcTyVar, TcType)
</span><a href="#local-6989586621683046778"><span class="hs-identifier hs-var">unsat_given</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621683046779"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046779"><span class="hs-identifier hs-var">given_ev</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>  </span><span id="local-6989586621683046780"><span class="annot"><span class="annottext">impl :: Implication
</span><a href="#local-6989586621683046780"><span class="hs-identifier hs-var">impl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implic"><span class="hs-identifier hs-type">Implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ic_wanted :: Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046781"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046781"><span class="hs-identifier hs-var">wtd</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_tclvl :: Implication -&gt; TcLevel
</span><a href="GHC.Tc.Types.Constraint.html#ic_tclvl"><span class="hs-identifier hs-var">ic_tclvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046783"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683046783"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_binds :: Implication -&gt; EvBindsVar
</span><a href="GHC.Tc.Types.Constraint.html#ic_binds"><span class="hs-identifier hs-var">ic_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046785"><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621683046785"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_need_inner :: Implication -&gt; VarSet
</span><a href="GHC.Tc.Types.Constraint.html#ic_need_inner"><span class="hs-identifier hs-var">ic_need_inner</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046787"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683046787"><span class="hs-identifier hs-var">inner</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EvBindsVar -&gt; Bool
</span><a href="GHC.Tc.Types.Evidence.html#isCoEvBindsVar"><span class="hs-identifier hs-var">isCoEvBindsVar</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621683046785"><span class="hs-identifier hs-var">ev_binds_var</span></a></span><span>
</span><span id="line-604"></span><span>  </span><span class="hs-comment">-- We can't use Unsatisfiable evidence in kinds.</span><span>
</span><span id="line-605"></span><span>  </span><span class="hs-comment">-- See Note [Coercion evidence only] in GHC.Tc.Types.Evidence.</span><span>
</span><span id="line-606"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Implication -&gt; TcS (Maybe Implication)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Implication -&gt; TcS (Maybe Implication))
-&gt; Maybe Implication -&gt; TcS (Maybe Implication)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Implication -&gt; Maybe Implication
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046780"><span class="hs-identifier hs-var">impl</span></a></span><span>
</span><span id="line-607"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-608"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046789"><span class="annot"><a href="#local-6989586621683046789"><span class="hs-identifier hs-var">wcs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EvBindsVar
-&gt; TcLevel -&gt; TcS WantedConstraints -&gt; TcS WantedConstraints
forall a. EvBindsVar -&gt; TcLevel -&gt; TcS a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#nestImplicTcS"><span class="hs-identifier hs-var">nestImplicTcS</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621683046785"><span class="hs-identifier hs-var">ev_binds_var</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683046783"><span class="hs-identifier hs-var">tclvl</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS WantedConstraints -&gt; TcS WantedConstraints)
-&gt; TcS WantedConstraints -&gt; TcS WantedConstraints
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="#local-6989586621683046791"><span class="hs-identifier hs-var">go_wc</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046781"><span class="hs-identifier hs-var">wtd</span></a></span><span>
</span><span id="line-609"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#setImplicationStatus"><span class="hs-identifier hs-type">setImplicationStatus</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-610"></span><span>         </span><span class="annot"><a href="#local-6989586621683046780"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046789"><span class="hs-identifier hs-type">wcs</span></a></span><span>
</span><span id="line-611"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_need_inner"><span class="hs-identifier hs-var">ic_need_inner</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046787"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#extendVarSet"><span class="hs-operator hs-type">`extendVarSet`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046779"><span class="hs-identifier hs-type">given_ev</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-612"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-613"></span><span>    </span><span class="annot"><a href="#local-6989586621683046791"><span class="hs-identifier hs-type">go_wc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-614"></span><span>    </span><span id="local-6989586621683046791"><span class="annot"><span class="annottext">go_wc :: WantedConstraints -&gt; TcS WantedConstraints
</span><a href="#local-6989586621683046791"><span class="hs-identifier hs-var hs-var">go_wc</span></a></span></span><span> </span><span id="local-6989586621683046793"><span class="annot"><span class="annottext">wc :: WantedConstraints
</span><a href="#local-6989586621683046793"><span class="hs-identifier hs-var">wc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046794"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046794"><span class="hs-identifier hs-var">wtds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046795"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683046795"><span class="hs-identifier hs-var">impls</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; TcS ()) -&gt; Cts -&gt; TcS ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; Bag a -&gt; m ()
</span><a href="GHC.Data.Bag.html#mapBagM_"><span class="hs-identifier hs-var">mapBagM_</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; TcS ()
</span><a href="#local-6989586621683046797"><span class="hs-identifier hs-var">go_simple</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046794"><span class="hs-identifier hs-var">wtds</span></a></span><span>
</span><span id="line-616"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046798"><span class="annot"><a href="#local-6989586621683046798"><span class="hs-identifier hs-var">impls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Implication -&gt; TcS (Maybe Implication))
-&gt; Bag Implication -&gt; TcS (Bag Implication)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m (Maybe b)) -&gt; Bag a -&gt; m (Bag b)
</span><a href="GHC.Data.Bag.html#mapMaybeBagM"><span class="hs-identifier hs-var">mapMaybeBagM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TcTyVar, TcType) -&gt; Implication -&gt; TcS (Maybe Implication)
</span><a href="GHC.Tc.Solver.html#solveImplicationUsingUnsatGiven"><span class="hs-identifier hs-var">solveImplicationUsingUnsatGiven</span></a></span><span> </span><span class="annot"><span class="annottext">(TcTyVar, TcType)
</span><a href="#local-6989586621683046778"><span class="hs-identifier hs-var">unsat_given</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683046795"><span class="hs-identifier hs-var">impls</span></a></span><span>
</span><span id="line-617"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621683046793"><span class="hs-identifier hs-type">wc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-type">emptyBag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046798"><span class="hs-identifier hs-type">impls</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-618"></span><span>    </span><span class="annot"><a href="#local-6989586621683046797"><span class="hs-identifier hs-type">go_simple</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>    </span><span id="local-6989586621683046797"><span class="annot"><span class="annottext">go_simple :: Ct -&gt; TcS ()
</span><a href="#local-6989586621683046797"><span class="hs-identifier hs-var hs-var">go_simple</span></a></span></span><span> </span><span id="local-6989586621683046800"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046800"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046800"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-620"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_pred :: CtEvidence -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctev_pred"><span class="hs-identifier hs-var">ctev_pred</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046804"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046804"><span class="hs-identifier hs-var">pty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ctev_dest :: CtEvidence -&gt; TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#ctev_dest"><span class="hs-identifier hs-var">ctev_dest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046806"><span class="annot"><span class="annottext">TcEvDest
</span><a href="#local-6989586621683046806"><span class="hs-identifier hs-var">dst</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-621"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046807"><span class="annot"><a href="#local-6989586621683046807"><span class="hs-identifier hs-var">ev_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcTyVar, TcType) -&gt; TcType -&gt; TcS EvExpr
</span><a href="GHC.Tc.Solver.html#unsatisfiableEvExpr"><span class="hs-identifier hs-var">unsatisfiableEvExpr</span></a></span><span> </span><span class="annot"><span class="annottext">(TcTyVar, TcType)
</span><a href="#local-6989586621683046778"><span class="hs-identifier hs-var">unsat_given</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046804"><span class="hs-identifier hs-var">pty</span></a></span><span>
</span><span id="line-622"></span><span>              </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setWantedEvTerm"><span class="hs-identifier hs-type">setWantedEvTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046806"><span class="hs-identifier hs-type">dst</span></a></span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html#EvNonCanonical"><span class="hs-identifier hs-type">EvNonCanonical</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvExpr"><span class="hs-identifier hs-type">EvExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046807"><span class="hs-identifier hs-type">ev_expr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-623"></span><span>      </span><span class="annot"><span class="annottext">CtEvidence
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS ()
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span>
</span><span id="line-625"></span><span class="hs-comment">-- | Create an evidence expression for an arbitrary constraint using</span><span>
</span><span id="line-626"></span><span class="hs-comment">-- evidence for an &quot;Unsatisfiable&quot; Given.</span><span>
</span><span id="line-627"></span><span class="hs-comment">--</span><span>
</span><span id="line-628"></span><span class="hs-comment">-- See Note [Evidence terms from Unsatisfiable Givens]</span><span>
</span><span id="line-629"></span><span class="annot"><a href="GHC.Tc.Solver.html#unsatisfiableEvExpr"><span class="hs-identifier hs-type">unsatisfiableEvExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ErrorMsgType"><span class="hs-identifier hs-type">ErrorMsgType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvExpr"><span class="hs-identifier hs-type">EvExpr</span></a></span><span>
</span><span id="line-630"></span><span id="unsatisfiableEvExpr"><span class="annot"><span class="annottext">unsatisfiableEvExpr :: (TcTyVar, TcType) -&gt; TcType -&gt; TcS EvExpr
</span><a href="GHC.Tc.Solver.html#unsatisfiableEvExpr"><span class="hs-identifier hs-var hs-var">unsatisfiableEvExpr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046814"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046814"><span class="hs-identifier hs-var">unsat_ev</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046815"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046815"><span class="hs-identifier hs-var">given_msg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683046816"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046816"><span class="hs-identifier hs-var">wtd_ty</span></a></span></span><span>
</span><span id="line-631"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046817"><span class="annot"><a href="#local-6989586621683046817"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS Module
forall (m :: * -&gt; *). HasModule m =&gt; m Module
</span><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a></span><span>
</span><span id="line-632"></span><span>         </span><span class="hs-comment">-- If we're typechecking GHC.TypeError, return a bogus expression;</span><span>
</span><span id="line-633"></span><span>         </span><span class="hs-comment">-- it's only used for the ambiguity check, which throws the evidence away anyway.</span><span>
</span><span id="line-634"></span><span>         </span><span class="hs-comment">-- This avoids problems with circularity; where we are trying to look</span><span>
</span><span id="line-635"></span><span>         </span><span class="hs-comment">-- up the &quot;unsatisfiable&quot; Id while we are in the middle of typechecking it.</span><span>
</span><span id="line-636"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683046817"><span class="hs-identifier hs-type">mod</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#gHC_INTERNAL_TYPEERROR"><span class="hs-identifier hs-type">gHC_INTERNAL_TYPEERROR</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046814"><span class="hs-identifier hs-type">unsat_ev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-637"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046820"><span class="annot"><a href="#local-6989586621683046820"><span class="hs-identifier hs-var">unsatisfiable_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#tcLookupId"><span class="hs-identifier hs-type">tcLookupId</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#unsatisfiableIdName"><span class="hs-identifier hs-type">unsatisfiableIdName</span></a></span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span>         </span><span class="hs-comment">-- See Note [Evidence terms from Unsatisfiable Givens]</span><span>
</span><span id="line-640"></span><span>         </span><span class="hs-comment">-- for a description of what evidence term we are constructing here.</span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- (##) -=&gt; wtd_ty</span><span>
</span><span id="line-643"></span><span>             </span><span id="local-6989586621683046823"><span class="annot"><a href="#local-6989586621683046823"><span class="hs-identifier hs-var hs-var">fun_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
FunTyFlag -&gt; TcType -&gt; TcType -&gt; TcType -&gt; TcType
FunTyFlag -&gt; TcType -&gt; TcType -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkFunTy"><span class="hs-identifier hs-var">mkFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="GHC.Types.Var.html#visArgConstraintLike"><span class="hs-identifier hs-var">visArgConstraintLike</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Builtin.Types.html#unboxedUnitTy"><span class="hs-identifier hs-var">unboxedUnitTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046816"><span class="hs-identifier hs-var">wtd_ty</span></a></span><span>
</span><span id="line-644"></span><span>             </span><span id="local-6989586621683046828"><span class="annot"><a href="#local-6989586621683046828"><span class="hs-identifier hs-var hs-var">mkDictBox</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; BoxingInfo (ZonkAny 0)
forall b. TcType -&gt; BoxingInfo b
</span><a href="GHC.Builtin.Types.html#boxingDataCon"><span class="hs-identifier hs-var">boxingDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046823"><span class="hs-identifier hs-var">fun_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-645"></span><span>               </span><span class="annot"><a href="GHC.Builtin.Types.html#BI_Box"><span class="hs-identifier hs-type">BI_Box</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">bi_data_con :: forall b. BoxingInfo b -&gt; DataCon
</span><a href="GHC.Builtin.Types.html#bi_data_con"><span class="hs-identifier hs-var">bi_data_con</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046832"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683046832"><span class="hs-identifier hs-var">mkDictBox</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683046832"><span class="hs-identifier hs-var">mkDictBox</span></a></span><span>
</span><span id="line-646"></span><span>               </span><span class="annot"><span class="annottext">BoxingInfo (ZonkAny 0)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; DataCon
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unsatisfiableEvExpr: no DictBox!&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046816"><span class="hs-identifier hs-var">wtd_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-647"></span><span>             </span><span id="local-6989586621683046834"><span class="annot"><a href="#local-6989586621683046834"><span class="hs-identifier hs-var hs-var">dictBox</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; TyCon
</span><a href="GHC.Core.DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683046828"><span class="hs-identifier hs-var">mkDictBox</span></a></span><span>
</span><span id="line-648"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046836"><span class="annot"><a href="#local-6989586621683046836"><span class="hs-identifier hs-var">ev_bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#mkSysLocalM"><span class="hs-identifier hs-type">mkSysLocalM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-type">fsLit</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ct&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046823"><span class="hs-identifier hs-type">fun_ty</span></a></span><span>
</span><span id="line-649"></span><span>             </span><span class="hs-comment">-- Dict ((##) -=&gt; wtd_ty)</span><span>
</span><span id="line-650"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683046839"><span class="annot"><a href="#local-6989586621683046839"><span class="hs-identifier hs-var hs-var">scrut_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683046834"><span class="hs-identifier hs-var">dictBox</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046823"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-651"></span><span>             </span><span class="hs-comment">-- unsatisfiable @{LiftedRep} @given_msg @(Dict ((##) -=&gt; wtd_ty)) unsat_ev</span><span>
</span><span id="line-652"></span><span>             </span><span id="local-6989586621683046841"><span class="annot"><a href="#local-6989586621683046841"><span class="hs-identifier hs-var hs-var">scrut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-653"></span><span>               </span><span class="annot"><span class="annottext">EvExpr -&gt; [EvExpr] -&gt; EvExpr
</span><a href="GHC.Core.Make.html#mkCoreApps"><span class="hs-identifier hs-var">mkCoreApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; EvExpr
forall b. TcTyVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046820"><span class="hs-identifier hs-var">unsatisfiable_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-654"></span><span>                 </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; EvExpr
forall b. TcType -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Builtin.Types.html#liftedRepTy"><span class="hs-identifier hs-var">liftedRepTy</span></a></span><span>
</span><span id="line-655"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; EvExpr
forall b. TcType -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046815"><span class="hs-identifier hs-var">given_msg</span></a></span><span>
</span><span id="line-656"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; EvExpr
forall b. TcType -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046839"><span class="hs-identifier hs-var">scrut_ty</span></a></span><span>
</span><span id="line-657"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; EvExpr
forall b. TcTyVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046814"><span class="hs-identifier hs-var">unsat_ev</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-658"></span><span>             </span><span class="hs-comment">-- case scrut of { MkDictBox @((##) -=&gt; wtd_ty)) ct -&gt; ct (# #) }</span><span>
</span><span id="line-659"></span><span>             </span><span id="local-6989586621683046845"><span class="annot"><a href="#local-6989586621683046845"><span class="hs-identifier hs-var hs-var">ev_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-660"></span><span>               </span><span class="annot"><span class="annottext">EvExpr -&gt; Scaled TcType -&gt; TcType -&gt; [CoreAlt] -&gt; EvExpr
</span><a href="GHC.Core.Make.html#mkWildCase"><span class="hs-identifier hs-var">mkWildCase</span></a></span><span> </span><span class="annot"><span class="annottext">EvExpr
</span><a href="#local-6989586621683046841"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Scaled TcType
forall a. a -&gt; Scaled a
</span><a href="GHC.Core.Type.html#unrestricted"><span class="hs-identifier hs-var">unrestricted</span></a></span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; Scaled TcType) -&gt; TcType -&gt; Scaled TcType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046839"><span class="hs-identifier hs-var">scrut_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046816"><span class="hs-identifier hs-var">wtd_ty</span></a></span><span>
</span><span id="line-661"></span><span>               </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [TcTyVar] -&gt; EvExpr -&gt; CoreAlt
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683046828"><span class="hs-identifier hs-var">mkDictBox</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046836"><span class="hs-identifier hs-var">ev_bndr</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(EvExpr -&gt; CoreAlt) -&gt; EvExpr -&gt; CoreAlt
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-662"></span><span>                   </span><span class="annot"><span class="annottext">EvExpr -&gt; [EvExpr] -&gt; EvExpr
</span><a href="GHC.Core.Make.html#mkCoreApps"><span class="hs-identifier hs-var">mkCoreApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; EvExpr
forall b. TcTyVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046836"><span class="hs-identifier hs-var">ev_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EvExpr
</span><a href="GHC.Types.Id.Make.html#unboxedUnitExpr"><span class="hs-identifier hs-var">unboxedUnitExpr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-663"></span><span>               </span><span class="hs-special">]</span><span>
</span><span id="line-664"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683046845"><span class="hs-identifier hs-type">ev_expr</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span class="hs-comment">{- Note [Evidence terms from Unsatisfiable Givens]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An Unsatisfiable Given constraint, of the form [G] Unsatisfiable msg, should be
able to solve ANY Wanted constraint whatsoever.

Recall that we have

  unsatisfiable :: forall {rep} (msg :: ErrorMessage) (a :: TYPE rep)
                .  Unsatisfiable msg =&gt; a

We want to use this function, together with the evidence
[G] unsat_ev :: Unsatisfiable msg, to solve any other constraint [W] wtd_ty.

We could naively think that a valid evidence term for the Wanted might be:

  wanted_ev = unsatisfiable @{rep} @msg @wtd_ty unsat_ev

Unfortunately, this is a kind error: &quot;wtd_ty :: CONSTRAINT rep&quot;, but
&quot;unsatisfiable&quot; expects the third type argument to be of kind &quot;TYPE rep&quot;.

Instead, we use a boxing data constructor to box the constraint into a type.
In the end, we construct the following evidence for the implication:

  [G] unsat_ev :: Unsatisfiable msg
    ==&gt;
      [W] wtd_ev :: wtd_ty

  wtd_ev =
    case unsatisfiable @{LiftedRep} @msg @(Dict ((##) -=&gt; wtd_ty)) unsat_ev of
      MkDictBox ct -&gt; ct (# #)

Note that we play the same trick with the function arrow -=&gt; that we did
in order to define &quot;unsatisfiable&quot; in terms of &quot;unsatisfiableLifted&quot;, as described
in Note [The Unsatisfiable representation-polymorphism trick] in base:GHC.TypeError.
This allows us to indirectly box constraints with different representations
(such as primitive equality constraints).
-}</span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span class="annot"><span class="hs-comment">-- | A 'TcS' action which can may solve a `Ct`</span></span><span>
</span><span id="line-705"></span><span class="hs-keyword">type</span><span> </span><span id="CtDefaultingStrategy"><span class="annot"><a href="GHC.Tc.Solver.html#CtDefaultingStrategy"><span class="hs-identifier hs-var">CtDefaultingStrategy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-706"></span><span>  </span><span class="hs-comment">-- True &lt;=&gt; I solved the constraint</span><span>
</span><span id="line-707"></span><span>
</span><span id="line-708"></span><span class="hs-comment">--------------------------------</span><span>
</span><span id="line-709"></span><span class="annot"><a href="GHC.Tc.Solver.html#tryConstraintDefaulting"><span class="hs-identifier hs-type">tryConstraintDefaulting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-710"></span><span class="hs-comment">-- See Note [Overview of implicit CallStacks] in GHC.Tc.Types.Evidence</span><span>
</span><span id="line-711"></span><span id="tryConstraintDefaulting"><span class="annot"><span class="annottext">tryConstraintDefaulting :: WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#tryConstraintDefaulting"><span class="hs-identifier hs-var hs-var">tryConstraintDefaulting</span></a></span></span><span> </span><span id="local-6989586621683046850"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046850"><span class="hs-identifier hs-var">wc</span></a></span></span><span>
</span><span id="line-712"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046850"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-713"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046850"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-715"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046851"><span class="annot"><a href="#local-6989586621683046851"><span class="hs-identifier hs-var">n_unifs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046852"><span class="annot"><a href="#local-6989586621683046852"><span class="hs-identifier hs-var">better_wc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS WantedConstraints -&gt; TcS (Int, WantedConstraints)
forall a. TcS a -&gt; TcS (Int, a)
</span><a href="GHC.Tc.Solver.Monad.html#reportUnifications"><span class="hs-identifier hs-var">reportUnifications</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="#local-6989586621683046854"><span class="hs-identifier hs-var">go_wc</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046850"><span class="hs-identifier hs-var">wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-716"></span><span>         </span><span class="hs-comment">-- We may have done unifications; so solve again</span><span>
</span><span id="line-717"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#solveAgainIf"><span class="hs-identifier hs-type">solveAgainIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683046851"><span class="hs-identifier hs-type">n_unifs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683046852"><span class="hs-identifier hs-type">better_wc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-718"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-719"></span><span>    </span><span class="annot"><a href="#local-6989586621683046854"><span class="hs-identifier hs-type">go_wc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-720"></span><span>    </span><span id="local-6989586621683046854"><span class="annot"><span class="annottext">go_wc :: WantedConstraints -&gt; TcS WantedConstraints
</span><a href="#local-6989586621683046854"><span class="hs-identifier hs-var hs-var">go_wc</span></a></span></span><span> </span><span id="local-6989586621683046856"><span class="annot"><span class="annottext">wc :: WantedConstraints
</span><a href="#local-6989586621683046856"><span class="hs-identifier hs-var">wc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046857"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046857"><span class="hs-identifier hs-var">simples</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046858"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683046858"><span class="hs-identifier hs-var">implics</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-721"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046859"><span class="annot"><a href="#local-6989586621683046859"><span class="hs-identifier hs-var">mb_simples</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; TcS (Maybe Ct)) -&gt; Cts -&gt; TcS Cts
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m (Maybe b)) -&gt; Bag a -&gt; m (Bag b)
</span><a href="GHC.Data.Bag.html#mapMaybeBagM"><span class="hs-identifier hs-var">mapMaybeBagM</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; TcS (Maybe Ct)
</span><a href="#local-6989586621683046860"><span class="hs-identifier hs-var">go_simple</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046857"><span class="hs-identifier hs-var">simples</span></a></span><span>
</span><span id="line-722"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046861"><span class="annot"><a href="#local-6989586621683046861"><span class="hs-identifier hs-var">mb_implics</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#mapMaybeBagM"><span class="hs-identifier hs-type">mapMaybeBagM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046862"><span class="hs-identifier hs-type">go_implic</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046858"><span class="hs-identifier hs-type">implics</span></a></span><span>
</span><span id="line-723"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683046856"><span class="hs-identifier hs-type">wc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046859"><span class="hs-identifier hs-type">mb_simples</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046861"><span class="hs-identifier hs-type">mb_implics</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span>    </span><span class="annot"><a href="#local-6989586621683046860"><span class="hs-identifier hs-type">go_simple</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span>    </span><span id="local-6989586621683046860"><span class="annot"><span class="annottext">go_simple :: Ct -&gt; TcS (Maybe Ct)
</span><a href="#local-6989586621683046860"><span class="hs-identifier hs-var hs-var">go_simple</span></a></span></span><span> </span><span id="local-6989586621683046863"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046863"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046864"><span class="annot"><a href="#local-6989586621683046864"><span class="hs-identifier hs-var">solved</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#tryCtDefaultingStrategy"><span class="hs-identifier hs-var">tryCtDefaultingStrategy</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046863"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-727"></span><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683046864"><span class="hs-identifier hs-type">solved</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-728"></span><span>                                  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683046863"><span class="hs-identifier hs-type">ct</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-729"></span><span>
</span><span id="line-730"></span><span>    </span><span class="annot"><a href="#local-6989586621683046862"><span class="hs-identifier hs-type">go_implic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-731"></span><span>    </span><span class="hs-comment">-- The Maybe is because solving the CallStack constraint</span><span>
</span><span id="line-732"></span><span>    </span><span class="hs-comment">-- may well allow us to discard the implication entirely</span><span>
</span><span id="line-733"></span><span>    </span><span id="local-6989586621683046862"><span class="annot"><span class="annottext">go_implic :: Implication -&gt; TcS (Maybe Implication)
</span><a href="#local-6989586621683046862"><span class="hs-identifier hs-var hs-var">go_implic</span></a></span></span><span> </span><span id="local-6989586621683046866"><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046866"><span class="hs-identifier hs-var">implic</span></a></span></span><span>
</span><span id="line-734"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ImplicStatus -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isSolvedStatus"><span class="hs-identifier hs-var">isSolvedStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; ImplicStatus
</span><a href="GHC.Tc.Types.Constraint.html#ic_status"><span class="hs-identifier hs-var">ic_status</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046866"><span class="hs-identifier hs-var">implic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Implication -&gt; TcS (Maybe Implication)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; Maybe Implication
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046866"><span class="hs-identifier hs-var">implic</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Nothing to solve inside here</span><span>
</span><span id="line-736"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-737"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046867"><span class="annot"><a href="#local-6989586621683046867"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EvBindsVar -&gt; TcS WantedConstraints -&gt; TcS WantedConstraints
forall a. EvBindsVar -&gt; TcS a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindsTcS"><span class="hs-identifier hs-var">setEvBindsTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; EvBindsVar
</span><a href="GHC.Tc.Types.Constraint.html#ic_binds"><span class="hs-identifier hs-var">ic_binds</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046866"><span class="hs-identifier hs-var">implic</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcS WantedConstraints -&gt; TcS WantedConstraints)
-&gt; TcS WantedConstraints -&gt; TcS WantedConstraints
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-738"></span><span>                        </span><span class="hs-comment">-- defaultCallStack sets a binding, so</span><span>
</span><span id="line-739"></span><span>                        </span><span class="hs-comment">-- we must set the correct binding group</span><span>
</span><span id="line-740"></span><span>                        </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="#local-6989586621683046854"><span class="hs-identifier hs-var">go_wc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683046866"><span class="hs-identifier hs-var">implic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#setImplicationStatus"><span class="hs-identifier hs-type">setImplicationStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683046866"><span class="hs-identifier hs-type">implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683046867"><span class="hs-identifier hs-type">wanteds</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span class="annot"><a href="GHC.Tc.Solver.html#tryCtDefaultingStrategy"><span class="hs-identifier hs-type">tryCtDefaultingStrategy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#CtDefaultingStrategy"><span class="hs-identifier hs-type">CtDefaultingStrategy</span></a></span><span>
</span><span id="line-744"></span><span class="hs-comment">-- The composition of all the CtDefaultingStrategies we want</span><span>
</span><span id="line-745"></span><span id="tryCtDefaultingStrategy"><span class="annot"><span class="annottext">tryCtDefaultingStrategy :: CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#tryCtDefaultingStrategy"><span class="hs-identifier hs-var hs-var">tryCtDefaultingStrategy</span></a></span></span><span>
</span><span id="line-746"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CtDefaultingStrategy
 -&gt; CtDefaultingStrategy -&gt; CtDefaultingStrategy)
-&gt; [CtDefaultingStrategy] -&gt; CtDefaultingStrategy
forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldr1</span></span><span> </span><span class="annot"><span class="annottext">CtDefaultingStrategy
-&gt; CtDefaultingStrategy -&gt; CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#combineStrategies"><span class="hs-identifier hs-var">combineStrategies</span></a></span><span>
</span><span id="line-747"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#defaultCallStack"><span class="hs-identifier hs-var">defaultCallStack</span></a></span><span>
</span><span id="line-748"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#defaultExceptionContext"><span class="hs-identifier hs-var">defaultExceptionContext</span></a></span><span>
</span><span id="line-749"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#defaultEquality"><span class="hs-identifier hs-var">defaultEquality</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-750"></span><span>
</span><span id="line-751"></span><span class="annot"><span class="hs-comment">-- | Default @ExceptionContext@ constraints to @emptyExceptionContext@.</span></span><span>
</span><span id="line-752"></span><span class="annot"><a href="GHC.Tc.Solver.html#defaultExceptionContext"><span class="hs-identifier hs-type">defaultExceptionContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#CtDefaultingStrategy"><span class="hs-identifier hs-type">CtDefaultingStrategy</span></a></span><span>
</span><span id="line-753"></span><span id="defaultExceptionContext"><span class="annot"><span class="annottext">defaultExceptionContext :: CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#defaultExceptionContext"><span class="hs-identifier hs-var hs-var">defaultExceptionContext</span></a></span></span><span> </span><span id="local-6989586621683046874"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046874"><span class="hs-identifier hs-var">ct</span></a></span></span><span>
</span><span id="line-754"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621683046876"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683046876"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683046877"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683046877"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046874"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe FastString -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [TcType] -&gt; Maybe FastString
</span><a href="GHC.Core.Predicate.html#isExceptionContextPred"><span class="hs-identifier hs-var">isExceptionContextPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683046876"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683046877"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-756"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#warnTcS"><span class="hs-identifier hs-var">warnTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcS ()) -&gt; TcRnMessage -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnDefaultedExceptionContext"><span class="hs-identifier hs-var">TcRnDefaultedExceptionContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctLoc"><span class="hs-identifier hs-var">ctLoc</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046874"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046884"><span class="annot"><a href="#local-6989586621683046884"><span class="hs-identifier hs-var">empty_ec_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TcS TcTyVar
forall (m :: * -&gt; *). MonadThings m =&gt; Name -&gt; m TcTyVar
</span><a href="GHC.Types.TyThing.html#lookupId"><span class="hs-identifier hs-var">lookupId</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#emptyExceptionContextName"><span class="hs-identifier hs-var">emptyExceptionContextName</span></a></span><span>
</span><span id="line-758"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683046886"><span class="annot"><a href="#local-6989586621683046886"><span class="hs-identifier hs-var hs-var">ev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046874"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-759"></span><span>             </span><span id="local-6989586621683046887"><span class="annot"><a href="#local-6989586621683046887"><span class="hs-identifier hs-var hs-var">ev_tm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EvExpr -&gt; TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#mkEvCast"><span class="hs-identifier hs-var">mkEvCast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; EvExpr
forall b. TcTyVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046884"><span class="hs-identifier hs-var">empty_ec_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TcCoercion
</span><a href="GHC.Tc.Types.Evidence.html#wrapIP"><span class="hs-identifier hs-var">wrapIP</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621683046886"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-760"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-type">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046886"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html#EvCanonical"><span class="hs-identifier hs-type">EvCanonical</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046887"><span class="hs-identifier hs-type">ev_tm</span></a></span><span>
</span><span id="line-761"></span><span>         </span><span class="hs-comment">-- EvCanonical: see Note [CallStack and ExecptionContext hack]</span><span>
</span><span id="line-762"></span><span>         </span><span class="hs-comment">--              in GHC.Tc.Solver.Dict</span><span>
</span><span id="line-763"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-764"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-765"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-766"></span><span>
</span><span id="line-767"></span><span class="hs-comment">-- | Default any remaining @CallStack@ constraints to empty @CallStack@s.</span><span>
</span><span id="line-768"></span><span class="hs-comment">-- See Note [Overview of implicit CallStacks] in GHC.Tc.Types.Evidence</span><span>
</span><span id="line-769"></span><span class="annot"><a href="GHC.Tc.Solver.html#defaultCallStack"><span class="hs-identifier hs-type">defaultCallStack</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#CtDefaultingStrategy"><span class="hs-identifier hs-type">CtDefaultingStrategy</span></a></span><span>
</span><span id="line-770"></span><span id="defaultCallStack"><span class="annot"><span class="annottext">defaultCallStack :: CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#defaultCallStack"><span class="hs-identifier hs-var hs-var">defaultCallStack</span></a></span></span><span> </span><span id="local-6989586621683046893"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046893"><span class="hs-identifier hs-var">ct</span></a></span></span><span>
</span><span id="line-771"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621683046894"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683046894"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683046895"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683046895"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046893"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe FastString -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [TcType] -&gt; Maybe FastString
</span><a href="GHC.Core.Predicate.html#isCallStackPred"><span class="hs-identifier hs-var">isCallStackPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683046894"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683046895"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvCallStack -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Dict.html#solveCallStack"><span class="hs-identifier hs-var">solveCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046893"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EvCallStack
</span><a href="GHC.Tc.Types.Evidence.html#EvCsEmpty"><span class="hs-identifier hs-var">EvCsEmpty</span></a></span><span>
</span><span id="line-774"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-775"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-776"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-777"></span><span>
</span><span id="line-778"></span><span class="annot"><a href="GHC.Tc.Solver.html#defaultEquality"><span class="hs-identifier hs-type">defaultEquality</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#CtDefaultingStrategy"><span class="hs-identifier hs-type">CtDefaultingStrategy</span></a></span><span>
</span><span id="line-779"></span><span class="hs-comment">-- See Note [Defaulting equalities]</span><span>
</span><span id="line-780"></span><span id="defaultEquality"><span class="annot"><span class="annottext">defaultEquality :: CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#defaultEquality"><span class="hs-identifier hs-var hs-var">defaultEquality</span></a></span></span><span> </span><span id="local-6989586621683046898"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046898"><span class="hs-identifier hs-var">ct</span></a></span></span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span id="local-6989586621683046901"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046901"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683046902"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046902"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046898"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-782"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Remember: `ct` may not be zonked;</span><span>
</span><span id="line-783"></span><span>         </span><span class="hs-comment">-- see (DE3) in Note [Defaulting equalities]</span><span>
</span><span id="line-784"></span><span>         </span><span id="local-6989586621683046903"><span class="annot"><a href="#local-6989586621683046903"><span class="hs-identifier hs-var">z_ty1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcS TcType
</span><a href="GHC.Tc.Solver.Monad.html#zonkTcType"><span class="hs-identifier hs-var">TcS.zonkTcType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046901"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-785"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046905"><span class="annot"><a href="#local-6989586621683046905"><span class="hs-identifier hs-var">z_ty2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#zonkTcType"><span class="hs-identifier hs-type">TcS.zonkTcType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046902"><span class="hs-identifier hs-type">ty2</span></a></span><span>
</span><span id="line-786"></span><span>
</span><span id="line-787"></span><span>       </span><span class="hs-comment">-- Now see if either LHS or RHS is a bare type variable</span><span>
</span><span id="line-788"></span><span>       </span><span class="hs-comment">-- You might think the type variable will only be on the LHS</span><span>
</span><span id="line-789"></span><span>       </span><span class="hs-comment">-- but with a type function we might get   F t1 ~ alpha</span><span>
</span><span id="line-790"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-type">getTyVar_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046903"><span class="hs-identifier hs-type">z_ty1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-type">getTyVar_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046905"><span class="hs-identifier hs-type">z_ty2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-791"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683046907"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046907"><span class="hs-identifier hs-var">z_tv1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe TcTyVar
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcS Bool
</span><a href="#local-6989586621683046908"><span class="hs-identifier hs-var">try_default_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046907"><span class="hs-identifier hs-var">z_tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046905"><span class="hs-identifier hs-var">z_ty2</span></a></span><span>
</span><span id="line-792"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe TcTyVar
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683046909"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046909"><span class="hs-identifier hs-var">z_tv2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcS Bool
</span><a href="#local-6989586621683046908"><span class="hs-identifier hs-var">try_default_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046909"><span class="hs-identifier hs-var">z_tv2</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046903"><span class="hs-identifier hs-var">z_ty1</span></a></span><span>
</span><span id="line-793"></span><span>           </span><span class="annot"><span class="annottext">(Maybe TcTyVar, Maybe TcTyVar)
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-795"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-796"></span><span>
</span><span id="line-797"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-798"></span><span>    </span><span id="local-6989586621683046908"><span class="annot"><span class="annottext">try_default_tv :: TcTyVar -&gt; TcType -&gt; TcS Bool
</span><a href="#local-6989586621683046908"><span class="hs-identifier hs-var hs-var">try_default_tv</span></a></span></span><span> </span><span id="local-6989586621683046910"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046910"><span class="hs-identifier hs-var">lhs_tv</span></a></span></span><span> </span><span id="local-6989586621683046911"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span>
</span><span id="line-799"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#MetaTv"><span class="hs-identifier hs-type">MetaTv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mtv_info :: TcTyVarDetails -&gt; MetaInfo
</span><a href="GHC.Tc.Utils.TcType.html#mtv_info"><span class="hs-identifier hs-var">mtv_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046914"><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683046914"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mtv_tclvl :: TcTyVarDetails -&gt; TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#mtv_tclvl"><span class="hs-identifier hs-var">mtv_tclvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683046916"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683046916"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcTyVarDetails
</span><a href="GHC.Types.Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046910"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-800"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046910"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-801"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.Unify.html#checkTopShape"><span class="hs-identifier hs-var">checkTopShape</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683046914"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-802"></span><span>      </span><span class="hs-comment">-- Do not test for touchability of lhs_tv; that is the whole point!</span><span>
</span><span id="line-803"></span><span>      </span><span class="hs-comment">-- See (DE2) in Note [Defaulting equalities]</span><span>
</span><span id="line-804"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defaultEquality 1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046910"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>
</span><span id="line-806"></span><span>           </span><span class="hs-comment">-- checkTyEqRhs: check that we can in fact unify lhs_tv := rhs_ty</span><span>
</span><span id="line-807"></span><span>           </span><span class="hs-comment">-- See Note [Defaulting equalities]</span><span>
</span><span id="line-808"></span><span>           </span><span class="hs-comment">--   LC_Promote: promote deeper unification variables (DE4)</span><span>
</span><span id="line-809"></span><span>           </span><span class="hs-comment">--   LC_Promote True: ...including under type families (DE5)</span><span>
</span><span id="line-810"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621683046923"><span class="hs-identifier hs-type">flags</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TyEqFlags"><span class="hs-identifier hs-type">TyEqFlags</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-811"></span><span>                 </span><span id="local-6989586621683046923"><span class="annot"><span class="annottext">flags :: TyEqFlags ()
</span><a href="#local-6989586621683046923"><span class="hs-identifier hs-var hs-var hs-var">flags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#TEF"><span class="hs-identifier hs-type">TEF</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tef_foralls :: Bool
</span><a href="GHC.Tc.Utils.Unify.html#tef_foralls"><span class="hs-identifier hs-var">tef_foralls</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-812"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_fam_app :: TyEqFamApp ()
</span><a href="GHC.Tc.Utils.Unify.html#tef_fam_app"><span class="hs-identifier hs-var">tef_fam_app</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyEqFamApp ()
forall a. TyEqFamApp a
</span><a href="GHC.Tc.Utils.Unify.html#TEFA_Recurse"><span class="hs-identifier hs-var">TEFA_Recurse</span></a></span><span>
</span><span id="line-813"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_lhs :: CanEqLHS
</span><a href="GHC.Tc.Utils.Unify.html#tef_lhs"><span class="hs-identifier hs-var">tef_lhs</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-var">TyVarLHS</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046910"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span>
</span><span id="line-814"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_unifying :: AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#tef_unifying"><span class="hs-identifier hs-var">tef_unifying</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetaInfo -&gt; TcLevel -&gt; LevelCheck -&gt; AreUnifying
</span><a href="GHC.Tc.Utils.Unify.html#Unifying"><span class="hs-identifier hs-var">Unifying</span></a></span><span> </span><span class="annot"><span class="annottext">MetaInfo
</span><a href="#local-6989586621683046914"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683046916"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; LevelCheck
</span><a href="GHC.Tc.Utils.Unify.html#LC_Promote"><span class="hs-identifier hs-var">LC_Promote</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tef_occurs :: CheckTyEqProblem
</span><a href="GHC.Tc.Utils.Unify.html#tef_occurs"><span class="hs-identifier hs-var">tef_occurs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckTyEqProblem
</span><a href="GHC.Tc.Types.Constraint.html#cteInsolubleOccurs"><span class="hs-identifier hs-var">cteInsolubleOccurs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-816"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046935"><span class="annot"><a href="#local-6989586621683046935"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">PuResult</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier">Reduction</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM (PuResult () Reduction) -&gt; TcS (PuResult () Reduction)
forall a. TcM a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyEqFlags () -&gt; TcType -&gt; TcM (PuResult () Reduction)
forall a. TyEqFlags a -&gt; TcType -&gt; TcM (PuResult a Reduction)
</span><a href="GHC.Tc.Utils.Unify.html#checkTyEqRhs"><span class="hs-identifier hs-var">checkTyEqRhs</span></a></span><span> </span><span class="annot"><span class="annottext">TyEqFlags ()
</span><a href="#local-6989586621683046923"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span>
</span><span id="line-818"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683046935"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-819"></span><span>               </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuFail"><span class="hs-identifier hs-type">PuFail</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcS Bool
</span><a href="#local-6989586621683046939"><span class="hs-identifier hs-var">cant_default_tv</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkTyEqRhs&quot;</span></span><span>
</span><span id="line-820"></span><span>               </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#PuOK"><span class="hs-identifier hs-type">PuOK</span></a></span><span> </span><span class="annot"><span class="annottext">Bag ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683046941"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683046941"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; TcS Bool -&gt; TcS Bool
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcCoercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduction -&gt; TcCoercion
</span><a href="GHC.Core.Reduction.html#reductionCoercion"><span class="hs-identifier hs-var">reductionCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683046941"><span class="hs-identifier hs-var">redn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduction -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621683046941"><span class="hs-identifier hs-var">redn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcS Bool -&gt; TcS Bool) -&gt; TcS Bool -&gt; TcS Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-821"></span><span>                               </span><span class="hs-comment">-- With TEFA_Recurse we never get any reductions</span><span>
</span><span id="line-822"></span><span>                              </span><span class="annot"><span class="annottext">TcS Bool
</span><a href="#local-6989586621683046943"><span class="hs-identifier hs-var">default_tv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-823"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-824"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcS Bool
</span><a href="#local-6989586621683046939"><span class="hs-identifier hs-var">cant_default_tv</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fall through&quot;</span></span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-827"></span><span>        </span><span id="local-6989586621683046939"><span class="annot"><span class="annottext">cant_default_tv :: String -&gt; TcS Bool
</span><a href="#local-6989586621683046939"><span class="hs-identifier hs-var hs-var">cant_default_tv</span></a></span></span><span> </span><span id="local-6989586621683046944"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683046944"><span class="hs-identifier hs-var">msg</span></a></span></span><span>
</span><span id="line-828"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defaultEquality fails: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683046944"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-829"></span><span>                 </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046910"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'~'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>  </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-830"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046910"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-831"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType
TcType -&gt; TcType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-832"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-833"></span><span>
</span><span id="line-834"></span><span>        </span><span class="hs-comment">-- All tests passed: do the unification</span><span>
</span><span id="line-835"></span><span>        </span><span id="local-6989586621683046943"><span class="annot"><span class="annottext">default_tv :: TcS Bool
</span><a href="#local-6989586621683046943"><span class="hs-identifier hs-var hs-var">default_tv</span></a></span></span><span>
</span><span id="line-836"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defaultEquality success:&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-837"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683046910"><span class="hs-identifier hs-var">lhs_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>  </span><span class="hs-comment">-- NB: unifyTyVar adds to the</span><span>
</span><span id="line-838"></span><span>                                           </span><span class="hs-comment">-- TcS unification counter</span><span>
</span><span id="line-839"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CanonicalEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046898"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CanonicalEvidence
</span><a href="GHC.Core.InstEnv.html#EvCanonical"><span class="hs-identifier hs-var">EvCanonical</span></a></span><span> </span><span class="annot"><span class="annottext">(EvTerm -&gt; TcS ()) -&gt; EvTerm -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-840"></span><span>                 </span><span class="annot"><span class="annottext">TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-var">evCoercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046911"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-841"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-842"></span><span>
</span><span id="line-843"></span><span class="annot"><a href="GHC.Tc.Solver.html#combineStrategies"><span class="hs-identifier hs-type">combineStrategies</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#CtDefaultingStrategy"><span class="hs-identifier hs-type">CtDefaultingStrategy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#CtDefaultingStrategy"><span class="hs-identifier hs-type">CtDefaultingStrategy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#CtDefaultingStrategy"><span class="hs-identifier hs-type">CtDefaultingStrategy</span></a></span><span>
</span><span id="line-844"></span><span id="combineStrategies"><span class="annot"><span class="annottext">combineStrategies :: CtDefaultingStrategy
-&gt; CtDefaultingStrategy -&gt; CtDefaultingStrategy
</span><a href="GHC.Tc.Solver.html#combineStrategies"><span class="hs-identifier hs-var hs-var">combineStrategies</span></a></span></span><span> </span><span id="local-6989586621683046948"><span class="annot"><span class="annottext">CtDefaultingStrategy
</span><a href="#local-6989586621683046948"><span class="hs-identifier hs-var">default1</span></a></span></span><span> </span><span id="local-6989586621683046949"><span class="annot"><span class="annottext">CtDefaultingStrategy
</span><a href="#local-6989586621683046949"><span class="hs-identifier hs-var">default2</span></a></span></span><span> </span><span id="local-6989586621683046950"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046950"><span class="hs-identifier hs-var">ct</span></a></span></span><span>
</span><span id="line-845"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046951"><span class="annot"><a href="#local-6989586621683046951"><span class="hs-identifier hs-var">solved</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtDefaultingStrategy
</span><a href="#local-6989586621683046948"><span class="hs-identifier hs-var">default1</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046950"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-846"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683046951"><span class="hs-identifier hs-type">solved</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-847"></span><span>           </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-comment">-- default1 solved it!</span><span>
</span><span id="line-848"></span><span>           </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtDefaultingStrategy
</span><a href="#local-6989586621683046949"><span class="hs-identifier hs-var">default2</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683046950"><span class="hs-identifier hs-var">ct</span></a></span><span>  </span><span class="hs-comment">-- default1 failed, try default2</span><span>
</span><span id="line-849"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-850"></span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span class="hs-comment">{- Note [When to do type-class defaulting]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In GHC 7.6 and 7.8.2, we did type-class defaulting only if insolubleWC
was false, on the grounds that defaulting can't help solve insoluble
constraints.  But if we *don't* do defaulting we may report a whole
lot of errors that would be solved by defaulting; these errors are
quite spurious because fixing the single insoluble error means that
defaulting happens again, which makes all the other errors go away.
This is jolly confusing: #9033.

So it seems better to always do type-class defaulting.

However, always doing defaulting does mean that we'll do it in
situations like this (#5934):
   run :: (forall s. GenST s) -&gt; Int
   run = fromInteger 0
We don't unify the return type of fromInteger with the given function
type, because the latter involves foralls.  So we're left with
    (Num alpha, alpha ~ (forall s. GenST s) -&gt; Int)
Now we do defaulting, get alpha := Integer, and report that we can't
match Integer with (forall s. GenST s) -&gt; Int.  That's not totally
stupid, but perhaps a little strange.

Another potential alternative would be to suppress *all* non-insoluble
errors if there are *any* insoluble errors, anywhere, but that seems
too drastic.

Note [Defaulting equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f :: forall a. (forall t. (F t ~ Int) =&gt; a -&gt; Int) -&gt; Int

  g :: Int
  g = f id

We'll typecheck
  id :: forall t. (F t ~ Int) =&gt; alpha[1] -&gt; Int
where the `alpha[1]` comes from instantiating `f`. So we'll end up
with the implication constraint
   forall[2] t. (F t ~ Int) =&gt; alpha[1] ~ Int
And that can't be solved because `alpha` is untouchable under the
equality (F t ~ Int).

This is tiresome, and gave rise to user complaints: #25125 and #25029.
Moreover, in this case there is no good reason not to unify alpha:=Int.
Doing so solves the constraint, and since `alpha` is not otherwise
constrained, it does no harm.  So the new plan is this:

  * For the Wanted constraint
        [W] alpha ~ ty
    if the only reason for not unifying is untouchability, then during
    top-level defaulting, go ahead and unify

In top-level defaulting, we already do several other somewhat-ad-hoc,
but terribly convenient, unifications. This is just one more.

Wrinkles:

(DE1) Note carefully that this does not threaten principal types.
  The original worry about unifying untouchable type variables was this:

     data T a where
       T1 :: T Bool
     f x = case x of T1 -&gt; True

  Should we infer f :: T a -&gt; Bool, or f :: T a -&gt; a.  Both are valid, but
  neither is more general than the other

(DE2) We still can't unify if there is a skolem-escape check, or an occurs check,
  or it it'd mean unifying a TyVarTv with a non-tyvar.  It's only the
  &quot;untouchability test&quot; that we lift.  We can lift it by saying that the innermost
  given equality is at top level.

(DE3) The contraint we are looking at may not be fully zonked; for example,
  an earlier defaulting might have affected it. So we zonk-on-the fly in
  `defaultEquality`.

(DE4) Promotion. Suppose we see  alpha[2] := Maybe beta[4].  We want to promote
  beta[4] to level 2 and unify alpha[2] := Maybe beta'[2].  This is done by
  checkTyEqRhs.

(DE5) Promotion. Suppose we see  alpha[2] := F beta[4], where F is a type
  family. Then we still want to promote beta to beta'[2], and unify. This is
  unusual: more commonly, we don't promote unification variables under a
  type family.  But here we want to.  (This mattered in #25251.)

  Hence the Bool flag on LC_Promote, and its use in `tef_unifying` in
  `defaultEquality`.

Note [Must simplify after defaulting]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We may have a deeply buried constraint
    (t:*) ~ (a:Open)
which we couldn't solve because of the kind incompatibility, and 'a' is free.
Then when we default 'a' we can solve the constraint.  And we want to do
that before starting in on type classes.  We MUST do it before reporting
errors, because it isn't an error!  #7967 was due to this.

Note [Top-level Defaulting Plan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have considered two design choices for where/when to apply defaulting.
   (i) Do it in SimplCheck mode only /whenever/ you try to solve some
       simple constraints, maybe deep inside the context of implications.
       This used to be the case in GHC 7.4.1.
   (ii) Do it in a tight loop at simplifyTop, once all other constraints have
        finished. This is the current story.

Option (i) had many disadvantages:
   a) Firstly, it was deep inside the actual solver.
   b) Secondly, it was dependent on the context (Infer a type signature,
      or Check a type signature, or Interactive) since we did not want
      to always start defaulting when inferring (though there is an exception to
      this, see Note [Default while Inferring]).
   c) It plainly did not work. Consider typecheck/should_compile/DfltProb2.hs:
          f :: Int -&gt; Bool
          f x = const True (\y -&gt; let w :: a -&gt; a
                                      w a = const a (y+1)
                                  in w y)
      We will get an implication constraint (for beta the type of y):
               [untch=beta] forall a. 0 =&gt; Num beta
      which we really cannot default /while solving/ the implication, since beta is
      untouchable.

Instead our new defaulting story is to pull defaulting out of the solver loop and
go with option (ii), implemented at SimplifyTop. Namely:
     - First, have a go at solving the residual constraint of the whole
       program
     - Try to approximate it with a simple constraint
     - Figure out derived defaulting equations for that simple constraint
     - Go round the loop again if you did manage to get some equations

Now, that has to do with class defaulting. However there exists type variable /kind/
defaulting. Again this is done at the top-level and the plan is:
     - At the top-level, once you had a go at solving the constraint, do
       figure out /all/ the touchable unification variables of the wanted constraints.
     - Apply defaulting to their kinds

More details in Note [DefaultTyVar].

Note [Safe Haskell Overlapping Instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In Safe Haskell, we apply an extra restriction to overlapping instances. The
motive is to prevent untrusted code provided by a third-party, changing the
behavior of trusted code through type-classes. This is due to the global and
implicit nature of type-classes that can hide the source of the dictionary.

Another way to state this is: if a module M compiles without importing another
module N, changing M to import N shouldn't change the behavior of M.

Overlapping instances with type-classes can violate this principle. However,
overlapping instances aren't always unsafe. They are just unsafe when the most
selected dictionary comes from untrusted code (code compiled with -XSafe) and
overlaps instances provided by other modules.

In particular, in Safe Haskell at a call site with overlapping instances, we
apply the following rule to determine if it is a 'unsafe' overlap:

 1) Most specific instance, I1, defined in an `-XSafe` compiled module.
 2) I1 is an orphan instance or a MPTC.
 3) At least one overlapped instance, Ix, is both:
    A) from a different module than I1
    B) Ix is not marked `OVERLAPPABLE`

This is a slightly involved heuristic, but captures the situation of an
imported module N changing the behavior of existing code. For example, if
condition (2) isn't violated, then the module author M must depend either on a
type-class or type defined in N.

Secondly, when should these heuristics be enforced? We enforced them when the
type-class method call site is in a module marked `-XSafe` or `-XTrustworthy`.
This allows `-XUnsafe` modules to operate without restriction, and for Safe
Haskell inference to infer modules with unsafe overlaps as unsafe.

One alternative design would be to also consider if an instance was imported as
a `safe` import or not and only apply the restriction to instances imported
safely. However, since instances are global and can be imported through more
than one path, this alternative doesn't work.

Note [Safe Haskell Overlapping Instances Implementation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
How is this implemented? It's complicated! So we'll step through it all:

 1) `InstEnv.lookupInstEnv` -- Performs instance resolution, so this is where
    we check if a particular type-class method call is safe or unsafe. We do this
    through the return type, `ClsInstLookupResult`, where the last parameter is a
    list of instances that are unsafe to overlap. When the method call is safe,
    the list is null.

 2) `GHC.Tc.Solver.Dict.matchClassInst` -- This module drives the instance resolution
    / dictionary generation. The return type is `ClsInstResult`, which either
    says no instance matched, or one found, and if it was a safe or unsafe
    overlap.

 3) `GHC.Tc.Solver.Dict.tryInstances` -- Takes a dictionary / class constraint and
     tries to resolve it by calling (in part) `matchClassInst`. The resolving
     mechanism has a work list (of constraints) that it process one at a time. If
     the constraint can't be resolved, it's added to an inert set. When compiling
     an `-XSafe` or `-XTrustworthy` module, we follow this approach as we know
     compilation should fail. These are handled as normal constraint resolution
     failures from here-on (see step 6).

     Otherwise, we may be inferring safety (or using `-Wunsafe`), and
     compilation should succeed, but print warnings and/or mark the compiled module
     as `-XUnsafe`. In this case, we call `insertSafeOverlapFailureTcS` which adds
     the unsafe (but resolved!) constraint to the `inert_safehask` field of
     `InertCans`.

 4) `GHC.Tc.Solver.simplifyTop`:
       * Call simplifyTopWanteds, the top-level function for driving the simplifier for
         constraint resolution.

       * Once finished, call `getSafeOverlapFailures` to retrieve the
         list of overlapping instances that were successfully resolved,
         but unsafe. Remember, this is only applicable for generating warnings
         (`-Wunsafe`) or inferring a module unsafe. `-XSafe` and `-XTrustworthy`
         cause compilation failure by not resolving the unsafe constraint at all.

       * For unresolved constraints (all types), call `GHC.Tc.Errors.reportUnsolved`,
         while for resolved but unsafe overlapping dictionary constraints, call
         `GHC.Tc.Errors.warnAllUnsolved`. Both functions convert constraints into a
         warning message for the user.

       * In the case of `warnAllUnsolved` for resolved, but unsafe
         dictionary constraints, we collect the generated warning
         message (pop it) and call `GHC.Tc.Utils.Monad.recordUnsafeInfer` to
         mark the module we are compiling as unsafe, passing the
         warning message along as the reason.

 5) `GHC.Tc.Errors.*Unsolved` -- Generates error messages for constraints by
    actually calling `InstEnv.lookupInstEnv` again! Yes, confusing, but all we
    know is the constraint that is unresolved or unsafe. For dictionary, all we
    know is that we need a dictionary of type C, but not what instances are
    available and how they overlap. So we once again call `lookupInstEnv` to
    figure that out so we can generate a helpful error message.

 6) `GHC.Tc.Utils.Monad.recordUnsafeInfer` -- Save the unsafe result and reason in
      IORefs called `tcg_safe_infer` and `tcg_safe_infer_reason`.

 7) `GHC.Driver.Main.tcRnModule'` -- Reads `tcg_safe_infer` after type-checking, calling
    `GHC.Driver.Main.markUnsafeInfer` (passing the reason along) when safe-inference
    failed.

Note [No defaulting in the ambiguity check]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When simplifying constraints for the ambiguity check, we use
solveWanteds, not simplifyTopWanteds, so that we do no defaulting.
#11947 was an example:
   f :: Num a =&gt; Int -&gt; Int
This is ambiguous of course, but we don't want to default the
(Num alpha) constraint to (Num Int)!  Doing so gives a defaulting
warning, but no error.

Note [Defaulting insolubles]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a set of wanteds is insoluble, we have no hope of accepting the
program. Yet we do not stop constraint solving, etc., because we may
simplify the wanteds to produce better error messages. So, once
we have an insoluble constraint, everything we do is just about producing
helpful error messages.

Should we default in this case or not? Let's look at an example (tcfail004):

  (f,g) = (1,2,3)

With defaulting, we get a conflict between (a0,b0) and (Integer,Integer,Integer).
Without defaulting, we get a conflict between (a0,b0) and (a1,b1,c1). I (Richard)
find the latter more helpful. Several other test cases (e.g. tcfail005) suggest
similarly. So: we should not do class defaulting with insolubles.

On the other hand, RuntimeRep-defaulting is different. Witness tcfail078:

  f :: Integer i =&gt; i
  f =               0

Without RuntimeRep-defaulting, we GHC suggests that Integer should have kind
TYPE r0 -&gt; Constraint and then complains that r0 is actually untouchable
(presumably, because it can't be sure if `Integer i` entails an equality).
If we default, we are told of a clash between (* -&gt; Constraint) and Constraint.
The latter seems far better, suggesting we *should* do RuntimeRep-defaulting
even on insolubles.

But, evidently, not always. Witness UnliftedNewtypesInfinite:

  newtype Foo = FooC (# Int#, Foo #)

This should fail with an occurs-check error on the kind of Foo (with -XUnliftedNewtypes).
If we default RuntimeRep-vars, we get

  Expecting a lifted type, but &#8216;(# Int#, Foo #)&#8217; is unlifted

which is just plain wrong.

Another situation in which we don't want to default involves concrete metavariables.

In equalities such as   alpha[conc] ~# rr[sk]  ,  alpha[conc] ~# RR beta[tau]
for a type family RR (all at kind RuntimeRep), we would prefer to report a
representation-polymorphism error rather than default alpha and get error:

  Could not unify `rr` with `Lifted` / Could not unify `RR b0` with `Lifted`

which is very confusing. For this reason, we weed out the concrete
metavariables participating in such equalities in nonDefaultableTyVarsOfWC.
Just looking at insolublity is not enough, as `alpha[conc] ~# RR beta[tau]` could
become soluble after defaulting beta (see also #21430).

Conclusion: we should do RuntimeRep-defaulting on insolubles only when the
user does not want to hear about RuntimeRep stuff -- that is, when
-fprint-explicit-runtime-reps is not set.
However, we must still take care not to default concrete type variables
participating in an equality with a non-concrete type, as seen in the
last example above.
-}</span><span>
</span><span id="line-1164"></span><span>
</span><span id="line-1165"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-1166"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyAmbiguityCheck"><span class="hs-identifier hs-type">simplifyAmbiguityCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1167"></span><span id="simplifyAmbiguityCheck"><span class="annot"><span class="annottext">simplifyAmbiguityCheck :: TcType -&gt; WantedConstraints -&gt; TcM ()
</span><a href="GHC.Tc.Solver.html#simplifyAmbiguityCheck"><span class="hs-identifier hs-var hs-var">simplifyAmbiguityCheck</span></a></span></span><span> </span><span id="local-6989586621683046952"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046952"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621683046953"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046953"><span class="hs-identifier hs-var">wc</span></a></span></span><span>
</span><span id="line-1168"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplifyAmbiguityCheck {&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1169"></span><span>         </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;type = &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046952"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;wanted = &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046953"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-1170"></span><span>
</span><span id="line-1171"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046954"><span class="annot"><a href="#local-6989586621683046954"><span class="hs-identifier hs-var">final_wc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS WantedConstraints -&gt; TcM (WantedConstraints, EvBindMap)
forall a. TcS a -&gt; TcM (a, EvBindMap)
</span><a href="GHC.Tc.Solver.Monad.html#runTcS"><span class="hs-identifier hs-var">runTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS WantedConstraints -&gt; TcM (WantedConstraints, EvBindMap))
-&gt; TcS WantedConstraints -&gt; TcM (WantedConstraints, EvBindMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046955"><span class="annot"><a href="#local-6989586621683046955"><span class="hs-identifier hs-var">wc1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046953"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-1172"></span><span>                                      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#tryUnsatisfiableGivens"><span class="hs-identifier hs-type">tryUnsatisfiableGivens</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046955"><span class="hs-identifier hs-type">wc1</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1173"></span><span>             </span><span class="hs-comment">-- NB: no defaulting!  See Note [No defaulting in the ambiguity check]</span><span>
</span><span id="line-1174"></span><span>             </span><span class="hs-comment">-- Note: we do still use Unsatisfiable Givens to solve Wanteds,</span><span>
</span><span id="line-1175"></span><span>             </span><span class="hs-comment">-- see Wrinkle [Ambiguity] under point (C) of</span><span>
</span><span id="line-1176"></span><span>             </span><span class="hs-comment">-- Note [Implementation of Unsatisfiable constraints] in GHC.Tc.Errors.</span><span>
</span><span id="line-1177"></span><span>
</span><span id="line-1178"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#discardResult"><span class="hs-identifier hs-type">discardResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Errors.html#reportUnsolved"><span class="hs-identifier hs-type">reportUnsolved</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046954"><span class="hs-identifier hs-type">final_wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1179"></span><span>
</span><span id="line-1180"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;End simplifyAmbiguityCheck }&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1181"></span><span>
</span><span id="line-1182"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-1183"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyInteractive"><span class="hs-identifier hs-type">simplifyInteractive</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBind"><span class="hs-identifier hs-type">EvBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1184"></span><span id="simplifyInteractive"><span class="annot"><span class="annottext">simplifyInteractive :: WantedConstraints -&gt; TcM (Bag EvBind)
</span><a href="GHC.Tc.Solver.html#simplifyInteractive"><span class="hs-identifier hs-var hs-var">simplifyInteractive</span></a></span></span><span> </span><span id="local-6989586621683046957"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046957"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>
</span><span id="line-1185"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplifyInteractive&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">TcM () -&gt; TcM (Bag EvBind) -&gt; TcM (Bag EvBind)
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span>
</span><span id="line-1186"></span><span>    </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcM (Bag EvBind)
</span><a href="GHC.Tc.Solver.html#simplifyTop"><span class="hs-identifier hs-var">simplifyTop</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683046957"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-1187"></span><span>
</span><span id="line-1188"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-1189"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyDefault"><span class="hs-identifier hs-type">simplifyDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span>    </span><span class="hs-comment">-- Wanted; has no type variables in it</span><span>
</span><span id="line-1190"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>     </span><span class="hs-comment">-- Return if the constraint is soluble</span><span>
</span><span id="line-1191"></span><span id="simplifyDefault"><span class="annot"><span class="annottext">simplifyDefault :: [TcType] -&gt; TcM Bool
</span><a href="GHC.Tc.Solver.html#simplifyDefault"><span class="hs-identifier hs-var hs-var">simplifyDefault</span></a></span></span><span> </span><span id="local-6989586621683046959"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683046959"><span class="hs-identifier hs-var">theta</span></a></span></span><span>
</span><span id="line-1192"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplifyDefault&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-1193"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046960"><span class="annot"><a href="#local-6989586621683046960"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; [TcType] -&gt; TcM [CtEvidence]
</span><a href="GHC.Tc.Utils.TcMType.html#newWanteds"><span class="hs-identifier hs-var">newWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#DefaultOrigin"><span class="hs-identifier hs-var">DefaultOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683046959"><span class="hs-identifier hs-var">theta</span></a></span><span>
</span><span id="line-1194"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046963"><span class="annot"><a href="#local-6989586621683046963"><span class="hs-identifier hs-var">unsolved</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#runTcS"><span class="hs-identifier hs-type">runTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-type">solveWanteds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkSimpleWC"><span class="hs-identifier hs-type">mkSimpleWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046960"><span class="hs-identifier hs-type">wanteds</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1195"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-type">isEmptyWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046963"><span class="hs-identifier hs-type">unsolved</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1196"></span><span>
</span><span id="line-1197"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-1198"></span><span class="hs-comment">{- Note [Pattern match warnings with insoluble Givens]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A pattern match on a GADT can introduce new type-level information, which needs
to be analysed in order to get the expected pattern match warnings.

For example:

&gt; type IsBool :: Type -&gt; Constraint
&gt; type family IsBool a where
&gt;   IsBool Bool = ()
&gt;   IsBool b    = b ~ Bool
&gt;
&gt; data T a where
&gt;   MkTInt  :: Int -&gt; T Int
&gt;   MkTBool :: IsBool b =&gt; b -&gt; T b
&gt;
&gt; f :: T Int -&gt; Int
&gt; f (MkTInt i) = i

The pattern matching performed by `f` is complete: we can't ever call
`f (MkTBool b)`, as type-checking that application would require producing
evidence for `Int ~ Bool`, which can't be done.

The pattern match checker uses `tcCheckGivens` to accumulate all the Given
constraints, and relies on `tcCheckGivens` to return Nothing if the
Givens become insoluble.   `tcCheckGivens` in turn relies on `insolubleCt`
to identify these insoluble constraints.  So the precise definition of
`insolubleCt` has a big effect on pattern match overlap warnings.

To detect this situation, we check whether there are any insoluble Given
constraints. In the example above, the insoluble constraint was an
equality constraint, but it is also important to detect custom type errors:

&gt; type NotInt :: Type -&gt; Constraint
&gt; type family NotInt a where
&gt;   NotInt Int = TypeError (Text &quot;That's Int, silly.&quot;)
&gt;   NotInt _   = ()
&gt;
&gt; data R a where
&gt;   MkT1 :: a -&gt; R a
&gt;   MkT2 :: NotInt a =&gt; R a
&gt;
&gt; foo :: R Int -&gt; Int
&gt; foo (MkT1 x) = x

To see that we can't call `foo (MkT2)`, we must detect that `NotInt Int` is insoluble
because it is a custom type error.
Failing to do so proved quite inconvenient for users, as evidence by the
tickets #11503 #14141 #16377 #20180.
Test cases: T11503, T14141.

Examples of constraints that tcCheckGivens considers insoluble:
  - Int ~ Bool,
  - Coercible Float Word,
  - TypeError msg.

Non-examples:
  - constraints which we know aren't satisfied,
    e.g. Show (Int -&gt; Int) when no such instance is in scope,
  - Eq (TypeError msg),
  - C (Int ~ Bool), with @class C (c :: Constraint)@.
-}</span><span>
</span><span id="line-1260"></span><span>
</span><span id="line-1261"></span><span class="annot"><a href="GHC.Tc.Solver.html#tcCheckGivens"><span class="hs-identifier hs-type">tcCheckGivens</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1262"></span><span class="hs-comment">-- ^ Return (Just new_inerts) if the Givens are satisfiable, Nothing if definitely</span><span>
</span><span id="line-1263"></span><span class="hs-comment">-- contradictory.</span><span>
</span><span id="line-1264"></span><span class="hs-comment">--</span><span>
</span><span id="line-1265"></span><span class="hs-comment">-- See Note [Pattern match warnings with insoluble Givens] above.</span><span>
</span><span id="line-1266"></span><span id="tcCheckGivens"><span class="annot"><span class="annottext">tcCheckGivens :: InertSet -&gt; Bag TcTyVar -&gt; TcM (Maybe InertSet)
</span><a href="GHC.Tc.Solver.html#tcCheckGivens"><span class="hs-identifier hs-var hs-var">tcCheckGivens</span></a></span></span><span> </span><span id="local-6989586621683046965"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621683046965"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621683046966"><span class="annot"><span class="annottext">Bag TcTyVar
</span><a href="#local-6989586621683046966"><span class="hs-identifier hs-var">given_ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1267"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621683046967"><span class="annot"><a href="#local-6989586621683046967"><span class="hs-identifier hs-var">sat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046968"><span class="annot"><a href="#local-6989586621683046968"><span class="hs-identifier hs-var">new_inerts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertSet -&gt; TcS Bool -&gt; TcM (Bool, InertSet)
forall a. InertSet -&gt; TcS a -&gt; TcM (a, InertSet)
</span><a href="GHC.Tc.Solver.Monad.html#runTcSInerts"><span class="hs-identifier hs-var">runTcSInerts</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621683046965"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS Bool -&gt; TcM (Bool, InertSet))
-&gt; TcS Bool -&gt; TcM (Bool, InertSet)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1268"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkGivens {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InertSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621683046965"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bag TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bag TcTyVar
</span><a href="#local-6989586621683046966"><span class="hs-identifier hs-var">given_ids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1269"></span><span>    </span><span id="local-6989586621683046970"><span class="annot"><a href="#local-6989586621683046970"><span class="hs-identifier hs-var">lcl_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS TcLclEnv
</span><a href="GHC.Tc.Solver.Monad.html#getLclEnv"><span class="hs-identifier hs-var">TcS.getLclEnv</span></a></span><span>
</span><span id="line-1270"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683046972"><span class="annot"><a href="#local-6989586621683046972"><span class="hs-identifier hs-var hs-var">given_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; SkolemInfoAnon -&gt; CtLocEnv -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#mkGivenLoc"><span class="hs-identifier hs-var">mkGivenLoc</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#topTcLevel"><span class="hs-identifier hs-var">topTcLevel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SkolemInfo -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#getSkolemInfo"><span class="hs-identifier hs-var">getSkolemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfo
HasDebugCallStack =&gt; SkolemInfo
</span><a href="GHC.Tc.Types.Origin.html#unkSkol"><span class="hs-identifier hs-var">unkSkol</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcLclEnv -&gt; CtLocEnv
</span><a href="GHC.Tc.Utils.Monad.html#mkCtLocEnv"><span class="hs-identifier hs-var">mkCtLocEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLclEnv
</span><a href="#local-6989586621683046970"><span class="hs-identifier hs-var">lcl_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1271"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683046976"><span class="annot"><a href="#local-6989586621683046976"><span class="hs-identifier hs-var hs-var">given_cts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; [TcTyVar] -&gt; [Ct]
</span><a href="GHC.Tc.Types.Constraint.html#mkGivens"><span class="hs-identifier hs-var">mkGivens</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683046972"><span class="hs-identifier hs-var">given_loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag TcTyVar -&gt; [TcTyVar]
forall a. Bag a -&gt; [a]
</span><a href="GHC.Data.Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a></span><span> </span><span class="annot"><span class="annottext">Bag TcTyVar
</span><a href="#local-6989586621683046966"><span class="hs-identifier hs-var">given_ids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1272"></span><span>    </span><span class="hs-comment">-- See Note [Superclasses and satisfiability]</span><span>
</span><span id="line-1273"></span><span>    </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html#solveSimpleGivens"><span class="hs-identifier hs-type">solveSimpleGivens</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046976"><span class="hs-identifier hs-type">given_cts</span></a></span><span>
</span><span id="line-1274"></span><span>    </span><span id="local-6989586621683046979"><span class="annot"><a href="#local-6989586621683046979"><span class="hs-identifier hs-var">insols</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getInertInsols"><span class="hs-identifier hs-type">getInertInsols</span></a></span><span>
</span><span id="line-1275"></span><span>    </span><span id="local-6989586621683046981"><span class="annot"><a href="#local-6989586621683046981"><span class="hs-identifier hs-var">insols</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683046982"><span class="hs-identifier hs-type">try_harder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046979"><span class="hs-identifier hs-type">insols</span></a></span><span>
</span><span id="line-1276"></span><span>    </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;checkGivens }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046981"><span class="hs-identifier hs-type">insols</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1277"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-type">isEmptyBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046981"><span class="hs-identifier hs-type">insols</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1278"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683046967"><span class="hs-identifier hs-type">sat</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683046968"><span class="hs-identifier hs-type">new_inerts</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-1279"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1280"></span><span>    </span><span class="annot"><a href="#local-6989586621683046982"><span class="hs-identifier hs-type">try_harder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Cts"><span class="hs-identifier hs-type">Cts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Cts"><span class="hs-identifier hs-type">Cts</span></a></span><span>
</span><span id="line-1281"></span><span>    </span><span class="hs-comment">-- Maybe we have to search up the superclass chain to find</span><span>
</span><span id="line-1282"></span><span>    </span><span class="hs-comment">-- an unsatisfiable constraint.  Example: pmcheck/T3927b.</span><span>
</span><span id="line-1283"></span><span>    </span><span class="hs-comment">-- At the moment we try just once</span><span>
</span><span id="line-1284"></span><span>    </span><span id="local-6989586621683046982"><span class="annot"><span class="annottext">try_harder :: Cts -&gt; TcS Cts
</span><a href="#local-6989586621683046982"><span class="hs-identifier hs-var hs-var">try_harder</span></a></span></span><span> </span><span id="local-6989586621683046983"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046983"><span class="hs-identifier hs-var">insols</span></a></span></span><span>
</span><span id="line-1285"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cts -&gt; Bool
forall a. Bag a -&gt; Bool
</span><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046983"><span class="hs-identifier hs-var">insols</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- We've found that it's definitely unsatisfiable</span><span>
</span><span id="line-1286"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; TcS Cts
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683046983"><span class="hs-identifier hs-var">insols</span></a></span><span>             </span><span class="hs-comment">-- Hurrah -- stop now.</span><span>
</span><span id="line-1287"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1288"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046984"><span class="annot"><a href="#local-6989586621683046984"><span class="hs-identifier hs-var">pending_given</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS [Ct]
</span><a href="GHC.Tc.Solver.Monad.html#getPendingGivenScs"><span class="hs-identifier hs-var">getPendingGivenScs</span></a></span><span>
</span><span id="line-1289"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683046986"><span class="annot"><a href="#local-6989586621683046986"><span class="hs-identifier hs-var">new_given</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html#makeSuperClasses"><span class="hs-identifier hs-type">makeSuperClasses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046984"><span class="hs-identifier hs-type">pending_given</span></a></span><span>
</span><span id="line-1290"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html#solveSimpleGivens"><span class="hs-identifier hs-type">solveSimpleGivens</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046986"><span class="hs-identifier hs-type">new_given</span></a></span><span>
</span><span id="line-1291"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getInertInsols"><span class="hs-identifier hs-type">getInertInsols</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1292"></span><span>
</span><span id="line-1293"></span><span class="annot"><a href="GHC.Tc.Solver.html#tcCheckWanteds"><span class="hs-identifier hs-type">tcCheckWanteds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1294"></span><span class="annot"><span class="hs-comment">-- ^ Return True if the Wanteds are soluble, False if not</span></span><span>
</span><span id="line-1295"></span><span id="tcCheckWanteds"><span class="annot"><span class="annottext">tcCheckWanteds :: InertSet -&gt; [TcType] -&gt; TcM Bool
</span><a href="GHC.Tc.Solver.html#tcCheckWanteds"><span class="hs-identifier hs-var hs-var">tcCheckWanteds</span></a></span></span><span> </span><span id="local-6989586621683046987"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621683046987"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621683046988"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683046988"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1296"></span><span>  </span><span id="local-6989586621683046989"><span class="annot"><a href="#local-6989586621683046989"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; [TcType] -&gt; TcM [CtEvidence]
</span><a href="GHC.Tc.Utils.TcMType.html#newWanteds"><span class="hs-identifier hs-var">newWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#PatCheckOrigin"><span class="hs-identifier hs-var">PatCheckOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683046988"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-1297"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621683046991"><span class="annot"><a href="#local-6989586621683046991"><span class="hs-identifier hs-var">sat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683046992"><span class="annot"><a href="#local-6989586621683046992"><span class="hs-identifier hs-var">_new_inerts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#runTcSInerts"><span class="hs-identifier hs-type">runTcSInerts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046987"><span class="hs-identifier hs-type">inerts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1298"></span><span>    </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;checkWanteds {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046987"><span class="hs-identifier hs-type">inerts</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046988"><span class="hs-identifier hs-type">wanteds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1299"></span><span>    </span><span class="hs-comment">-- See Note [Superclasses and satisfiability]</span><span>
</span><span id="line-1300"></span><span>    </span><span id="local-6989586621683046993"><span class="annot"><a href="#local-6989586621683046993"><span class="hs-identifier hs-var">wcs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-type">solveWanteds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkSimpleWC"><span class="hs-identifier hs-type">mkSimpleWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046989"><span class="hs-identifier hs-type">cts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1301"></span><span>    </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;checkWanteds }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046993"><span class="hs-identifier hs-type">wcs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1302"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#isSolvedWC"><span class="hs-identifier hs-type">isSolvedWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046993"><span class="hs-identifier hs-type">wcs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1303"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683046991"><span class="hs-identifier hs-type">sat</span></a></span><span>
</span><span id="line-1304"></span><span>
</span><span id="line-1305"></span><span class="hs-comment">-- | Normalise a type as much as possible using the given constraints.</span><span>
</span><span id="line-1306"></span><span class="hs-comment">-- See @Note [tcNormalise]@.</span><span>
</span><span id="line-1307"></span><span class="annot"><a href="GHC.Tc.Solver.html#tcNormalise"><span class="hs-identifier hs-type">tcNormalise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-1308"></span><span id="tcNormalise"><span class="annot"><span class="annottext">tcNormalise :: InertSet -&gt; TcType -&gt; TcM TcType
</span><a href="GHC.Tc.Solver.html#tcNormalise"><span class="hs-identifier hs-var hs-var">tcNormalise</span></a></span></span><span> </span><span id="local-6989586621683046995"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621683046995"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621683046996"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683046996"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1309"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683046997"><span class="annot"><a href="#local-6989586621683046997"><span class="hs-identifier hs-var">norm_loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; Maybe TypeOrKind -&gt; TcM CtLoc
</span><a href="GHC.Tc.Utils.Monad.html#getCtLocM"><span class="hs-identifier hs-var">getCtLocM</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#PatCheckOrigin"><span class="hs-identifier hs-var">PatCheckOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TypeOrKind
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1310"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683046999"><span class="annot"><a href="#local-6989586621683046999"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047000"><span class="annot"><a href="#local-6989586621683047000"><span class="hs-identifier hs-var">_new_inerts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#runTcSInerts"><span class="hs-identifier hs-type">runTcSInerts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046995"><span class="hs-identifier hs-type">inerts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1311"></span><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tcNormalise {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046995"><span class="hs-identifier hs-type">inerts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1312"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047001"><span class="annot"><a href="#local-6989586621683047001"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteType"><span class="hs-identifier hs-type">rewriteType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046997"><span class="hs-identifier hs-type">norm_loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683046996"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-1313"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tcNormalise }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047001"><span class="hs-identifier hs-type">ty'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1314"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621683047001"><span class="hs-identifier hs-type">ty'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1315"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683046999"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1316"></span><span>
</span><span id="line-1317"></span><span class="hs-comment">{- Note [Superclasses and satisfiability]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Expand superclasses before starting, because (Int ~ Bool), has
(Int ~~ Bool) as a superclass, which in turn has (Int ~N# Bool)
as a superclass, and it's the latter that is insoluble.  See
Note [The equality types story] in GHC.Builtin.Types.Prim.

If we fail to prove unsatisfiability we (arbitrarily) try just once to
find superclasses, using try_harder.  Reason: we might have a type
signature
   f :: F op (Implements push) =&gt; ..
where F is a type function.  This happened in #3972.

We could do more than once but we'd have to have /some/ limit: in the
the recursive case, we would go on forever in the common case where
the constraints /are/ satisfiable (#10592 comment:12!).

For straightforward situations without type functions the try_harder
step does nothing.

Note [tcNormalise]
~~~~~~~~~~~~~~~~~~
tcNormalise is a rather atypical entrypoint to the constraint solver. Whereas
most invocations of the constraint solver are intended to simplify a set of
constraints or to decide if a particular set of constraints is satisfiable,
the purpose of tcNormalise is to take a type, plus some locally solved
constraints in the form of an InertSet, and normalise the type as much as
possible with respect to those constraints.

It does *not* reduce type or data family applications or look through newtypes.

Why is this useful? As one example, when coverage-checking an EmptyCase
expression, it's possible that the type of the scrutinee will only reduce
if some local equalities are solved for. See &quot;Wrinkle: Local equalities&quot;
in Note [Type normalisation] in &quot;GHC.HsToCore.Pmc&quot;.

To accomplish its stated goal, tcNormalise first initialises the solver monad
with the given InertCans, then uses rewriteType to simplify the desired type
with respect to the Givens in the InertCans.

***********************************************************************************
*                                                                                 *
*                            Inference
*                                                                                 *
***********************************************************************************

Note [Inferring the type of a let-bound variable]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f x = rhs

To infer f's type we do the following:
 * Gather the constraints for the RHS with ambient level *one more than*
   the current one.  This is done by the call
        pushLevelAndCaptureConstraints (tcMonoBinds...)
   in GHC.Tc.Gen.Bind.tcPolyInfer

 * Call simplifyInfer to simplify the constraints and decide what to
   quantify over. We pass in the level used for the RHS constraints,
   here called rhs_tclvl.

This ensures that the implication constraint we generate, if any,
has a strictly-increased level compared to the ambient level outside
the let binding.

Note [Inferring principal types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We don't always infer principal types. For instance, the inferred type for

&gt; f x = show [x]

is

&gt; f :: Show a =&gt; a -&gt; String

This is not the most general type if we allow flexible contexts.
Indeed, if we try to write the following

&gt; g :: Show [a] =&gt; a -&gt; String
&gt; g x = f x

we get the error:

  * Could not deduce (Show a) arising from a use of `f'
    from the context: Show [a]

Though replacing f x in the right-hand side of g with the definition
of f x works, the call to f x does not. This is the hallmark of
unprincip{led,al} types.

Another example:

&gt; class C a
&gt; class D a where
&gt;   d :: a
&gt; instance C a =&gt; D a where
&gt;   d = undefined
&gt; h _ = d   -- argument is to avoid the monomorphism restriction

The inferred type for h is

&gt; h :: C a =&gt; t -&gt; a

even though

&gt; h :: D a =&gt; t -&gt; a

is more general.

The fix is easy: don't simplify constraints before inferring a type.
That is, have the inferred type quantify over all constraints that arise
in a definition's right-hand side, even if they are simplifiable.
Unfortunately, this would yield all manner of unwieldy types,
and so we won't do so.
-}</span><span>
</span><span id="line-1432"></span><span>
</span><span id="line-1433"></span><span class="annot"><span class="hs-comment">-- | How should we choose which constraints to quantify over?</span></span><span>
</span><span id="line-1434"></span><span class="hs-keyword">data</span><span> </span><span id="InferMode"><span class="annot"><a href="GHC.Tc.Solver.html#InferMode"><span class="hs-identifier hs-var">InferMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ApplyMR"><span class="annot"><a href="GHC.Tc.Solver.html#ApplyMR"><span class="hs-identifier hs-var">ApplyMR</span></a></span></span><span>          </span><span class="hs-comment">-- ^ Apply the monomorphism restriction,</span><span>
</span><span id="line-1435"></span><span>                                  </span><span class="hs-comment">-- never quantifying over any constraints</span><span>
</span><span id="line-1436"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span id="EagerDefaulting"><span class="annot"><a href="GHC.Tc.Solver.html#EagerDefaulting"><span class="hs-identifier hs-var">EagerDefaulting</span></a></span></span><span>  </span><span class="hs-comment">-- ^ See Note [TcRnExprMode] in &quot;GHC.Tc.Module&quot;,</span><span>
</span><span id="line-1437"></span><span>                                  </span><span class="hs-comment">-- the :type +d case; this mode refuses</span><span>
</span><span id="line-1438"></span><span>                                  </span><span class="hs-comment">-- to quantify over any defaultable constraint</span><span>
</span><span id="line-1439"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span id="NoRestrictions"><span class="annot"><a href="GHC.Tc.Solver.html#NoRestrictions"><span class="hs-identifier hs-var">NoRestrictions</span></a></span></span><span>   </span><span class="hs-comment">-- ^ Quantify over any constraint that</span><span>
</span><span id="line-1440"></span><span>                                  </span><span class="hs-comment">-- satisfies pickQuantifiablePreds</span><span>
</span><span id="line-1441"></span><span>
</span><span id="line-1442"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#InferMode"><span class="hs-identifier hs-type">InferMode</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1443"></span><span>  </span><span id="local-6989586621683047010"><span class="annot"><span class="annottext">ppr :: InferMode -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">InferMode
</span><a href="GHC.Tc.Solver.html#ApplyMR"><span class="hs-identifier hs-var">ApplyMR</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ApplyMR&quot;</span></span><span>
</span><span id="line-1444"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InferMode
</span><a href="GHC.Tc.Solver.html#EagerDefaulting"><span class="hs-identifier hs-var">EagerDefaulting</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;EagerDefaulting&quot;</span></span><span>
</span><span id="line-1445"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InferMode
</span><a href="GHC.Tc.Solver.html#NoRestrictions"><span class="hs-identifier hs-var">NoRestrictions</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;NoRestrictions&quot;</span></span><span>
</span><span id="line-1446"></span><span>
</span><span id="line-1447"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyInfer"><span class="hs-identifier hs-type">simplifyInfer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span>               </span><span class="hs-comment">-- Used when generating the constraints</span><span>
</span><span id="line-1448"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#InferMode"><span class="hs-identifier hs-type">InferMode</span></a></span><span>
</span><span id="line-1449"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TcIdSigInst"><span class="hs-identifier hs-type">TcIdSigInst</span></a></span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Any signatures (possibly partial)</span><span>
</span><span id="line-1450"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Variables to be generalised,</span><span>
</span><span id="line-1451"></span><span>                                       </span><span class="hs-comment">-- and their tau-types</span><span>
</span><span id="line-1452"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-1453"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Quantify over these type variables</span><span>
</span><span id="line-1454"></span><span>                      </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- ... and these constraints (fully zonked)</span><span>
</span><span id="line-1455"></span><span>                      </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcEvBinds"><span class="hs-identifier hs-type">TcEvBinds</span></a></span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- ... binding these evidence variables</span><span>
</span><span id="line-1456"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- True &lt;=&gt; the residual constraints are insoluble</span><span>
</span><span id="line-1457"></span><span>
</span><span id="line-1458"></span><span id="simplifyInfer"><span class="annot"><span class="annottext">simplifyInfer :: TcLevel
-&gt; InferMode
-&gt; [TcIdSigInst]
-&gt; [(Name, TcType)]
-&gt; WantedConstraints
-&gt; TcM ([TcTyVar], [TcTyVar], TcEvBinds, Bool)
</span><a href="GHC.Tc.Solver.html#simplifyInfer"><span class="hs-identifier hs-var hs-var">simplifyInfer</span></a></span></span><span> </span><span id="local-6989586621683047012"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047012"><span class="hs-identifier hs-var">rhs_tclvl</span></a></span></span><span> </span><span id="local-6989586621683047013"><span class="annot"><span class="annottext">InferMode
</span><a href="#local-6989586621683047013"><span class="hs-identifier hs-var">infer_mode</span></a></span></span><span> </span><span id="local-6989586621683047014"><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047014"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span id="local-6989586621683047015"><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047015"><span class="hs-identifier hs-var">name_taus</span></a></span></span><span> </span><span id="local-6989586621683047016"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047016"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>
</span><span id="line-1459"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047016"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-1460"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- When quantifying, we want to preserve any order of variables as they</span><span>
</span><span id="line-1461"></span><span>          </span><span class="hs-comment">-- appear in partial signatures. cf. decideQuantifiedTyVars</span><span>
</span><span id="line-1462"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047017"><span class="annot"><span class="annottext">psig_tv_tys :: [TcType]
</span><a href="#local-6989586621683047017"><span class="hs-identifier hs-var hs-var hs-var">psig_tv_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047019"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683047020"><span class="annot"><span class="annottext">TcIdSigInst
</span><a href="#local-6989586621683047020"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047021"><span class="hs-identifier hs-var">partial_sigs</span></a></span><span>
</span><span id="line-1463"></span><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621683047019"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047019"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="annot"><span class="annottext">Specificity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcIdSigInst -&gt; [(Name, InvisTVBinder)]
</span><a href="GHC.Tc.Types.BasicTypes.html#sig_inst_skols"><span class="hs-identifier hs-var">sig_inst_skols</span></a></span><span> </span><span class="annot"><span class="annottext">TcIdSigInst
</span><a href="#local-6989586621683047020"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1464"></span><span>              </span><span id="local-6989586621683047024"><span class="annot"><span class="annottext">psig_theta :: [TcType]
</span><a href="#local-6989586621683047024"><span class="hs-identifier hs-var hs-var hs-var">psig_theta</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047025"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683047026"><span class="annot"><span class="annottext">TcIdSigInst
</span><a href="#local-6989586621683047026"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047021"><span class="hs-identifier hs-var">partial_sigs</span></a></span><span>
</span><span id="line-1465"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047025"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047025"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcIdSigInst -&gt; [TcType]
</span><a href="GHC.Tc.Types.BasicTypes.html#sig_inst_theta"><span class="hs-identifier hs-var">sig_inst_theta</span></a></span><span> </span><span class="annot"><span class="annottext">TcIdSigInst
</span><a href="#local-6989586621683047026"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1466"></span><span>
</span><span id="line-1467"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047028"><span class="annot"><a href="#local-6989586621683047028"><span class="hs-identifier hs-var">dep_vars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; TcM CandidatesQTvs
</span><a href="GHC.Tc.Utils.TcMType.html#candidateQTyVarsOfTypes"><span class="hs-identifier hs-var">candidateQTyVarsOfTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047017"><span class="hs-identifier hs-var">psig_tv_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; [TcType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047024"><span class="hs-identifier hs-var">psig_theta</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; [TcType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">((Name, TcType) -&gt; TcType) -&gt; [(Name, TcType)] -&gt; [TcType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, TcType) -&gt; TcType
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047015"><span class="hs-identifier hs-var">name_taus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1468"></span><span>
</span><span id="line-1469"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047031"><span class="annot"><a href="#local-6989586621683047031"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#mkSkolemInfo"><span class="hs-identifier hs-type">mkSkolemInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InferSkol"><span class="hs-identifier hs-type">InferSkol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047015"><span class="hs-identifier hs-type">name_taus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1470"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047034"><span class="annot"><a href="#local-6989586621683047034"><span class="hs-identifier hs-var">qtkvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#quantifyTyVars"><span class="hs-identifier hs-type">quantifyTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047031"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#DefaultNonStandardTyVars"><span class="hs-identifier hs-type">DefaultNonStandardTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047028"><span class="hs-identifier hs-type">dep_vars</span></a></span><span>
</span><span id="line-1471"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;simplifyInfer: empty WC&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047015"><span class="hs-identifier hs-type">name_taus</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047034"><span class="hs-identifier hs-type">qtkvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1472"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047034"><span class="hs-identifier hs-type">qtkvs</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#emptyTcEvBinds"><span class="hs-identifier hs-type">emptyTcEvBinds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1473"></span><span>
</span><span id="line-1474"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1475"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplifyInfer {&quot;</span></span><span>  </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-1476"></span><span>             </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sigs =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TcIdSigInst] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047014"><span class="hs-identifier hs-var">sigs</span></a></span><span>
</span><span id="line-1477"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;binds =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, TcType)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047015"><span class="hs-identifier hs-var">name_taus</span></a></span><span>
</span><span id="line-1478"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rhs_tclvl =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047012"><span class="hs-identifier hs-var">rhs_tclvl</span></a></span><span>
</span><span id="line-1479"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;infer_mode =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">InferMode -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InferMode
</span><a href="#local-6989586621683047013"><span class="hs-identifier hs-var">infer_mode</span></a></span><span>
</span><span id="line-1480"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(unzonked) wanted =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047016"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-1481"></span><span>             </span><span class="hs-special">]</span><span>
</span><span id="line-1482"></span><span>
</span><span id="line-1483"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047038"><span class="annot"><span class="annottext">psig_theta :: [TcType]
</span><a href="#local-6989586621683047038"><span class="hs-identifier hs-var hs-var hs-var">psig_theta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcIdSigInst -&gt; [TcType]) -&gt; [TcIdSigInst] -&gt; [TcType]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">TcIdSigInst -&gt; [TcType]
</span><a href="GHC.Tc.Types.BasicTypes.html#sig_inst_theta"><span class="hs-identifier hs-var">sig_inst_theta</span></a></span><span> </span><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047021"><span class="hs-identifier hs-var">partial_sigs</span></a></span><span>
</span><span id="line-1484"></span><span>
</span><span id="line-1485"></span><span>       </span><span class="hs-comment">-- First do full-blown solving</span><span>
</span><span id="line-1486"></span><span>       </span><span class="hs-comment">-- NB: we must gather up all the bindings from doing</span><span>
</span><span id="line-1487"></span><span>       </span><span class="hs-comment">-- this solving; hence (runTcSWithEvBinds ev_binds_var).</span><span>
</span><span id="line-1488"></span><span>       </span><span class="hs-comment">-- And note that since there are nested implications,</span><span>
</span><span id="line-1489"></span><span>       </span><span class="hs-comment">-- calling solveWanteds will side-effect their evidence</span><span>
</span><span id="line-1490"></span><span>       </span><span class="hs-comment">-- bindings, so we can't just revert to the input</span><span>
</span><span id="line-1491"></span><span>       </span><span class="hs-comment">-- constraint.</span><span>
</span><span id="line-1492"></span><span>
</span><span id="line-1493"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047040"><span class="annot"><a href="#local-6989586621683047040"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM EvBindsVar
</span><a href="GHC.Tc.Utils.Monad.html#newTcEvBinds"><span class="hs-identifier hs-var">TcM.newTcEvBinds</span></a></span><span>
</span><span id="line-1494"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047042"><span class="annot"><a href="#local-6989586621683047042"><span class="hs-identifier hs-var">psig_evs</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newWanteds"><span class="hs-identifier hs-type">newWanteds</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#AnnOrigin"><span class="hs-identifier hs-type">AnnOrigin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047038"><span class="hs-identifier hs-type">psig_theta</span></a></span><span>
</span><span id="line-1495"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047044"><span class="annot"><a href="#local-6989586621683047044"><span class="hs-identifier hs-var">wanted_transformed</span></a></span></span><span>
</span><span id="line-1496"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setTcLevel"><span class="hs-identifier hs-type">setTcLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047012"><span class="hs-identifier hs-type">rhs_tclvl</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1497"></span><span>               </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#runTcSWithEvBinds"><span class="hs-identifier hs-type">runTcSWithEvBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047040"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1498"></span><span>               </span><span class="annot"><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-type">solveWanteds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkSimpleWC"><span class="hs-identifier hs-type">mkSimpleWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047042"><span class="hs-identifier hs-type">psig_evs</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#andWC"><span class="hs-operator hs-type">`andWC`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047016"><span class="hs-identifier hs-type">wanteds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1499"></span><span>               </span><span class="hs-comment">-- psig_evs : see Note [Add signature contexts as wanteds]</span><span>
</span><span id="line-1500"></span><span>               </span><span class="hs-comment">-- See Note [Inferring principal types]</span><span>
</span><span id="line-1501"></span><span>
</span><span id="line-1502"></span><span>       </span><span class="hs-comment">-- Find quant_pred_candidates, the predicates that</span><span>
</span><span id="line-1503"></span><span>       </span><span class="hs-comment">-- we'll consider quantifying over</span><span>
</span><span id="line-1504"></span><span>       </span><span class="hs-comment">-- NB1: wanted_transformed does not include anything provable from</span><span>
</span><span id="line-1505"></span><span>       </span><span class="hs-comment">--      the psig_theta; it's just the extra bit</span><span>
</span><span id="line-1506"></span><span>       </span><span class="hs-comment">-- NB2: We do not do any defaulting when inferring a type, this can lead</span><span>
</span><span id="line-1507"></span><span>       </span><span class="hs-comment">--      to less polymorphic types, see Note [Default while Inferring]</span><span>
</span><span id="line-1508"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047047"><span class="annot"><a href="#local-6989586621683047047"><span class="hs-identifier hs-var">wanted_transformed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-type">TcM.liftZonkM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkWC"><span class="hs-identifier hs-type">TcM.zonkWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047044"><span class="hs-identifier hs-type">wanted_transformed</span></a></span><span>
</span><span id="line-1509"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047048"><span class="annot"><a href="#local-6989586621683047048"><span class="hs-identifier hs-var hs-var">definite_error</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#insolubleWC"><span class="hs-identifier hs-var">insolubleWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047047"><span class="hs-identifier hs-var">wanted_transformed</span></a></span><span>
</span><span id="line-1510"></span><span>                              </span><span class="hs-comment">-- See Note [Quantification with errors]</span><span>
</span><span id="line-1511"></span><span>             </span><span id="local-6989586621683047049"><span class="annot"><a href="#local-6989586621683047049"><span class="hs-identifier hs-var hs-var">quant_pred_candidates</span></a></span></span><span>
</span><span id="line-1512"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047048"><span class="hs-identifier hs-var">definite_error</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1513"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; [TcType]
</span><a href="GHC.Tc.Types.Constraint.html#ctsPreds"><span class="hs-identifier hs-var">ctsPreds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Solver.html#approximateWC"><span class="hs-identifier hs-var">approximateWC</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047047"><span class="hs-identifier hs-var">wanted_transformed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1514"></span><span>
</span><span id="line-1515"></span><span>       </span><span class="hs-comment">-- Decide what type variables and constraints to quantify</span><span>
</span><span id="line-1516"></span><span>       </span><span class="hs-comment">-- NB: quant_pred_candidates is already fully zonked</span><span>
</span><span id="line-1517"></span><span>       </span><span class="hs-comment">-- NB: bound_theta are constraints we want to quantify over,</span><span>
</span><span id="line-1518"></span><span>       </span><span class="hs-comment">--     including the psig_theta, which we always quantify over</span><span>
</span><span id="line-1519"></span><span>       </span><span class="hs-comment">-- NB: bound_theta are fully zonked</span><span>
</span><span id="line-1520"></span><span>       </span><span class="hs-comment">-- rec {..}: see Note [Keeping SkolemInfo inside a SkolemTv]</span><span>
</span><span id="line-1521"></span><span>       </span><span class="hs-comment">--           in GHC.Tc.Utils.TcType</span><span>
</span><span id="line-1522"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">rec</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047051"><span class="annot"><a href="#local-6989586621683047051"><span class="hs-identifier hs-var">qtvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047052"><span class="annot"><a href="#local-6989586621683047052"><span class="hs-identifier hs-var">bound_theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047053"><span class="annot"><a href="#local-6989586621683047053"><span class="hs-identifier hs-var">co_vars</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#decideQuantification"><span class="hs-identifier hs-type">decideQuantification</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047055"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047013"><span class="hs-identifier hs-type">infer_mode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047012"><span class="hs-identifier hs-type">rhs_tclvl</span></a></span><span>
</span><span id="line-1523"></span><span>                                                     </span><span class="annot"><a href="#local-6989586621683047015"><span class="hs-identifier hs-type">name_taus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047021"><span class="hs-identifier hs-type">partial_sigs</span></a></span><span>
</span><span id="line-1524"></span><span>                                                     </span><span class="annot"><a href="#local-6989586621683047049"><span class="hs-identifier hs-type">quant_pred_candidates</span></a></span><span>
</span><span id="line-1525"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047056"><span class="annot"><a href="#local-6989586621683047056"><span class="hs-identifier hs-var">bound_theta_vars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newEvVar"><span class="hs-identifier hs-type">TcM.newEvVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047052"><span class="hs-identifier hs-type">bound_theta</span></a></span><span>
</span><span id="line-1526"></span><span>
</span><span id="line-1527"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047058"><span class="annot"><a href="#local-6989586621683047058"><span class="hs-identifier hs-var hs-var">full_theta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; TcType) -&gt; [TcTyVar] -&gt; [TcType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047056"><span class="hs-identifier hs-var">bound_theta_vars</span></a></span><span>
</span><span id="line-1528"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047055"><span class="annot"><a href="#local-6989586621683047055"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#mkSkolemInfo"><span class="hs-identifier hs-type">mkSkolemInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InferSkol"><span class="hs-identifier hs-type">InferSkol</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047059"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#mkPhiTy"><span class="hs-identifier hs-type">mkPhiTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047058"><span class="hs-identifier hs-type">full_theta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047061"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1529"></span><span>                                                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047059"><span class="annot"><a href="#local-6989586621683047059"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047061"><span class="annot"><a href="#local-6989586621683047061"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683047015"><span class="hs-identifier hs-type">name_taus</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1530"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1531"></span><span>
</span><span id="line-1532"></span><span>
</span><span id="line-1533"></span><span>       </span><span class="hs-comment">-- Now emit the residual constraint</span><span>
</span><span id="line-1534"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#emitResidualConstraints"><span class="hs-identifier hs-type">emitResidualConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047012"><span class="hs-identifier hs-type">rhs_tclvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047040"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span>
</span><span id="line-1535"></span><span>                                 </span><span class="annot"><a href="#local-6989586621683047015"><span class="hs-identifier hs-type">name_taus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047053"><span class="hs-identifier hs-type">co_vars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047051"><span class="hs-identifier hs-type">qtvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047056"><span class="hs-identifier hs-type">bound_theta_vars</span></a></span><span>
</span><span id="line-1536"></span><span>                                 </span><span class="annot"><a href="#local-6989586621683047047"><span class="hs-identifier hs-type">wanted_transformed</span></a></span><span>
</span><span id="line-1537"></span><span>
</span><span id="line-1538"></span><span>         </span><span class="hs-comment">-- All done!</span><span>
</span><span id="line-1539"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;} simplifyInfer/produced residual implication for quantification&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1540"></span><span>         </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;quant_pred_candidates =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047049"><span class="hs-identifier hs-type">quant_pred_candidates</span></a></span><span>
</span><span id="line-1541"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;psig_theta =&quot;</span></span><span>     </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047038"><span class="hs-identifier hs-type">psig_theta</span></a></span><span>
</span><span id="line-1542"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;bound_theta =&quot;</span></span><span>    </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html#pprCoreBinders"><span class="hs-identifier hs-type">pprCoreBinders</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047056"><span class="hs-identifier hs-type">bound_theta_vars</span></a></span><span>
</span><span id="line-1543"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;qtvs =&quot;</span></span><span>           </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047051"><span class="hs-identifier hs-type">qtvs</span></a></span><span>
</span><span id="line-1544"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;definite_error =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047048"><span class="hs-identifier hs-type">definite_error</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1545"></span><span>
</span><span id="line-1546"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621683047051"><span class="hs-identifier hs-type">qtvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047056"><span class="hs-identifier hs-type">bound_theta_vars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#TcEvBinds"><span class="hs-identifier hs-type">TcEvBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047040"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047048"><span class="hs-identifier hs-type">definite_error</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1547"></span><span>         </span><span class="hs-comment">-- NB: bound_theta_vars must be fully zonked</span><span>
</span><span id="line-1548"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1549"></span><span>    </span><span id="local-6989586621683047021"><span class="annot"><span class="annottext">partial_sigs :: [TcIdSigInst]
</span><a href="#local-6989586621683047021"><span class="hs-identifier hs-var hs-var">partial_sigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcIdSigInst -&gt; Bool) -&gt; [TcIdSigInst] -&gt; [TcIdSigInst]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">TcIdSigInst -&gt; Bool
</span><a href="GHC.Tc.Types.BasicTypes.html#isPartialSig"><span class="hs-identifier hs-var">isPartialSig</span></a></span><span> </span><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047014"><span class="hs-identifier hs-var">sigs</span></a></span><span>
</span><span id="line-1550"></span><span>
</span><span id="line-1551"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-1552"></span><span class="annot"><a href="GHC.Tc.Solver.html#emitResidualConstraints"><span class="hs-identifier hs-type">emitResidualConstraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBindsVar"><span class="hs-identifier hs-type">EvBindsVar</span></a></span><span>
</span><span id="line-1553"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1554"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#CoVarSet"><span class="hs-identifier hs-type">CoVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1555"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1556"></span><span class="hs-comment">-- Emit the remaining constraints from the RHS.</span><span>
</span><span id="line-1557"></span><span id="emitResidualConstraints"><span class="annot"><span class="annottext">emitResidualConstraints :: TcLevel
-&gt; EvBindsVar
-&gt; [(Name, TcType)]
-&gt; VarSet
-&gt; [TcTyVar]
-&gt; [TcTyVar]
-&gt; WantedConstraints
-&gt; TcM ()
</span><a href="GHC.Tc.Solver.html#emitResidualConstraints"><span class="hs-identifier hs-var hs-var">emitResidualConstraints</span></a></span></span><span> </span><span id="local-6989586621683047067"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047067"><span class="hs-identifier hs-var">rhs_tclvl</span></a></span></span><span> </span><span id="local-6989586621683047068"><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621683047068"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span>
</span><span id="line-1558"></span><span>                        </span><span id="local-6989586621683047069"><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047069"><span class="hs-identifier hs-var">name_taus</span></a></span></span><span> </span><span id="local-6989586621683047070"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047070"><span class="hs-identifier hs-var">co_vars</span></a></span></span><span> </span><span id="local-6989586621683047071"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047071"><span class="hs-identifier hs-var">qtvs</span></a></span></span><span> </span><span id="local-6989586621683047072"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047072"><span class="hs-identifier hs-var">full_theta_vars</span></a></span></span><span> </span><span id="local-6989586621683047073"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047073"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>
</span><span id="line-1559"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047073"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-1560"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1561"></span><span>
</span><span id="line-1562"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1563"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047074"><span class="annot"><a href="#local-6989586621683047074"><span class="hs-identifier hs-var">wanted_simple</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM Cts -&gt; TcM Cts
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">TcM.liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM Cts -&gt; TcM Cts) -&gt; ZonkM Cts -&gt; TcM Cts
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cts -&gt; ZonkM Cts
</span><a href="GHC.Tc.Zonk.TcType.html#zonkSimples"><span class="hs-identifier hs-var">TcM.zonkSimples</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047073"><span class="hs-identifier hs-var">wanteds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1564"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047076"><span class="annot"><a href="#local-6989586621683047076"><span class="hs-identifier hs-var">outer_simple</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047077"><span class="annot"><a href="#local-6989586621683047077"><span class="hs-identifier hs-var">inner_simple</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#partitionBag"><span class="hs-identifier hs-type">partitionBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047079"><span class="hs-identifier hs-type">is_mono</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047074"><span class="hs-identifier hs-type">wanted_simple</span></a></span><span>
</span><span id="line-1565"></span><span>             </span><span id="local-6989586621683047079"><span class="annot"><a href="#local-6989586621683047079"><span class="hs-identifier hs-var hs-var">is_mono</span></a></span></span><span> </span><span id="local-6989586621683047080"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047080"><span class="hs-identifier hs-var">ct</span></a></span></span><span>
</span><span id="line-1566"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683047081"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047081"><span class="hs-identifier hs-var">ct_ev_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Maybe TcTyVar
</span><a href="GHC.Tc.Types.Constraint.html#wantedEvId_maybe"><span class="hs-identifier hs-var">wantedEvId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047080"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-1567"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047081"><span class="hs-identifier hs-var">ct_ev_id</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047070"><span class="hs-identifier hs-var">co_vars</span></a></span><span>
</span><span id="line-1568"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1569"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1570"></span><span>             </span><span class="hs-comment">-- Reason for the partition:</span><span>
</span><span id="line-1571"></span><span>             </span><span class="hs-comment">-- see Note [Emitting the residual implication in simplifyInfer]</span><span>
</span><span id="line-1572"></span><span>
</span><span id="line-1573"></span><span class="hs-comment">-- Already done by defaultTyVarsAndSimplify</span><span>
</span><span id="line-1574"></span><span class="hs-comment">--      ; _ &lt;- TcM.promoteTyVarSet (tyCoVarsOfCts outer_simple)</span><span>
</span><span id="line-1575"></span><span>
</span><span id="line-1576"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047083"><span class="annot"><a href="#local-6989586621683047083"><span class="hs-identifier hs-var hs-var">inner_wanted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047073"><span class="hs-identifier hs-var">wanteds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047077"><span class="hs-identifier hs-type">inner_simple</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1577"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047084"><span class="annot"><a href="#local-6989586621683047084"><span class="hs-identifier hs-var">implics</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-type">isEmptyWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047083"><span class="hs-identifier hs-type">inner_wanted</span></a></span><span>
</span><span id="line-1578"></span><span>                     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-type">emptyBag</span></a></span><span>
</span><span id="line-1579"></span><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683047085"><span class="annot"><a href="#local-6989586621683047085"><span class="hs-identifier hs-var">implic1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newImplication"><span class="hs-identifier hs-type">newImplication</span></a></span><span>
</span><span id="line-1580"></span><span>                             </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#unitBag"><span class="hs-identifier hs-type">unitBag</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1581"></span><span>                                      </span><span class="annot"><a href="#local-6989586621683047085"><span class="hs-identifier hs-type">implic1</span></a></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_tclvl"><span class="hs-identifier hs-var">ic_tclvl</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047067"><span class="hs-identifier hs-type">rhs_tclvl</span></a></span><span>
</span><span id="line-1582"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_skols"><span class="hs-identifier hs-var">ic_skols</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047071"><span class="hs-identifier hs-type">qtvs</span></a></span><span>
</span><span id="line-1583"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_given"><span class="hs-identifier hs-var">ic_given</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047072"><span class="hs-identifier hs-type">full_theta_vars</span></a></span><span>
</span><span id="line-1584"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047083"><span class="hs-identifier hs-type">inner_wanted</span></a></span><span>
</span><span id="line-1585"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_binds"><span class="hs-identifier hs-var">ic_binds</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047068"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span>
</span><span id="line-1586"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_given_eqs"><span class="hs-identifier hs-var">ic_given_eqs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#MaybeGivenEqs"><span class="hs-identifier hs-type">MaybeGivenEqs</span></a></span><span>
</span><span id="line-1587"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_info"><span class="hs-identifier hs-var">ic_info</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047088"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1588"></span><span>
</span><span id="line-1589"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#emitConstraints"><span class="hs-identifier hs-type">emitConstraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#emptyWC"><span class="hs-identifier hs-type">emptyWC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047076"><span class="hs-identifier hs-type">outer_simple</span></a></span><span>
</span><span id="line-1590"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047084"><span class="hs-identifier hs-type">implics</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1591"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1592"></span><span>    </span><span id="local-6989586621683047090"><span class="annot"><span class="annottext">full_theta :: [TcType]
</span><a href="#local-6989586621683047090"><span class="hs-identifier hs-var hs-var">full_theta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; TcType) -&gt; [TcTyVar] -&gt; [TcType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047072"><span class="hs-identifier hs-var">full_theta_vars</span></a></span><span>
</span><span id="line-1593"></span><span>    </span><span id="local-6989586621683047088"><span class="annot"><span class="annottext">skol_info :: SkolemInfoAnon
</span><a href="#local-6989586621683047088"><span class="hs-identifier hs-var hs-var">skol_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, TcType)] -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#InferSkol"><span class="hs-identifier hs-var">InferSkol</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683047091"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; TcType -&gt; TcType
HasDebugCallStack =&gt; [TcType] -&gt; TcType -&gt; TcType
</span><a href="GHC.Tc.Utils.TcType.html#mkPhiTy"><span class="hs-identifier hs-var">mkPhiTy</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047090"><span class="hs-identifier hs-var">full_theta</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047092"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1594"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047091"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683047091"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047092"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047092"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047069"><span class="hs-identifier hs-var">name_taus</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1595"></span><span>    </span><span class="hs-comment">-- We don't add the quantified variables here, because they are</span><span>
</span><span id="line-1596"></span><span>    </span><span class="hs-comment">-- also bound in ic_skols and we want them to be tidied</span><span>
</span><span id="line-1597"></span><span>    </span><span class="hs-comment">-- uniformly.</span><span>
</span><span id="line-1598"></span><span>
</span><span id="line-1599"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-1600"></span><span class="annot"><a href="GHC.Tc.Solver.html#findInferredDiff"><span class="hs-identifier hs-type">findInferredDiff</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a></span><span>
</span><span id="line-1601"></span><span class="hs-comment">-- Given a partial type signature f :: (C a, D a, _) =&gt; blah</span><span>
</span><span id="line-1602"></span><span class="hs-comment">-- and the inferred constraints (X a, D a, Y a, C a)</span><span>
</span><span id="line-1603"></span><span class="hs-comment">-- compute the difference, which is what will fill in the &quot;_&quot; underscore,</span><span>
</span><span id="line-1604"></span><span class="hs-comment">-- In this case the diff is (X a, Y a).</span><span>
</span><span id="line-1605"></span><span id="findInferredDiff"><span class="annot"><span class="annottext">findInferredDiff :: [TcType] -&gt; [TcType] -&gt; TcM [TcType]
</span><a href="GHC.Tc.Solver.html#findInferredDiff"><span class="hs-identifier hs-var hs-var">findInferredDiff</span></a></span></span><span> </span><span id="local-6989586621683047094"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047094"><span class="hs-identifier hs-var">annotated_theta</span></a></span></span><span> </span><span id="local-6989586621683047095"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047095"><span class="hs-identifier hs-var">inferred_theta</span></a></span></span><span>
</span><span id="line-1606"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047094"><span class="hs-identifier hs-var">annotated_theta</span></a></span><span>   </span><span class="hs-comment">-- Short cut the common case when the user didn't</span><span>
</span><span id="line-1607"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; TcM [TcType]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047095"><span class="hs-identifier hs-var">inferred_theta</span></a></span><span>  </span><span class="hs-comment">-- write any constraints in the partial signature</span><span>
</span><span id="line-1608"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1609"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcM [TcType] -&gt; TcM [TcType]
forall r. TcM r -&gt; TcM r
</span><a href="GHC.Tc.Utils.Monad.html#pushTcLevelM_"><span class="hs-identifier hs-var">pushTcLevelM_</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM [TcType] -&gt; TcM [TcType]) -&gt; TcM [TcType] -&gt; TcM [TcType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1610"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047098"><span class="annot"><a href="#local-6989586621683047098"><span class="hs-identifier hs-var">lcl_env</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf TcGblEnv TcLclEnv TcLclEnv
forall gbl lcl. TcRnIf gbl lcl lcl
</span><a href="GHC.Tc.Utils.Monad.html#getLclEnv"><span class="hs-identifier hs-var">TcM.getLclEnv</span></a></span><span>
</span><span id="line-1611"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047100"><span class="annot"><a href="#local-6989586621683047100"><span class="hs-identifier hs-var">given_ids</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newEvVar"><span class="hs-identifier hs-type">TcM.newEvVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047094"><span class="hs-identifier hs-type">annotated_theta</span></a></span><span>
</span><span id="line-1612"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047101"><span class="annot"><a href="#local-6989586621683047101"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#newWanteds"><span class="hs-identifier hs-type">newWanteds</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#AnnOrigin"><span class="hs-identifier hs-type">AnnOrigin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047095"><span class="hs-identifier hs-type">inferred_theta</span></a></span><span>
</span><span id="line-1613"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047102"><span class="annot"><a href="#local-6989586621683047102"><span class="hs-identifier hs-var hs-var">given_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; SkolemInfoAnon -&gt; CtLocEnv -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#mkGivenLoc"><span class="hs-identifier hs-var">mkGivenLoc</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="GHC.Tc.Utils.TcType.html#topTcLevel"><span class="hs-identifier hs-var">topTcLevel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SkolemInfo -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#getSkolemInfo"><span class="hs-identifier hs-var">getSkolemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfo
HasDebugCallStack =&gt; SkolemInfo
</span><a href="GHC.Tc.Types.Origin.html#unkSkol"><span class="hs-identifier hs-var">unkSkol</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcLclEnv -&gt; CtLocEnv
</span><a href="GHC.Tc.Utils.Monad.html#mkCtLocEnv"><span class="hs-identifier hs-var">mkCtLocEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLclEnv
</span><a href="#local-6989586621683047098"><span class="hs-identifier hs-var">lcl_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1614"></span><span>             </span><span id="local-6989586621683047103"><span class="annot"><a href="#local-6989586621683047103"><span class="hs-identifier hs-var hs-var">given_cts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; [TcTyVar] -&gt; [Ct]
</span><a href="GHC.Tc.Types.Constraint.html#mkGivens"><span class="hs-identifier hs-var">mkGivens</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683047102"><span class="hs-identifier hs-var">given_loc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047100"><span class="hs-identifier hs-var">given_ids</span></a></span><span>
</span><span id="line-1615"></span><span>
</span><span id="line-1616"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047104"><span class="annot"><a href="#local-6989586621683047104"><span class="hs-identifier hs-var">residual</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#runTcS"><span class="hs-identifier hs-type">runTcS</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1617"></span><span>                          </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html#solveSimpleGivens"><span class="hs-identifier hs-type">solveSimpleGivens</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047103"><span class="hs-identifier hs-type">given_cts</span></a></span><span>
</span><span id="line-1618"></span><span>                             </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html#solveSimpleWanteds"><span class="hs-identifier hs-type">solveSimpleWanteds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#listToBag"><span class="hs-identifier hs-type">listToBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkNonCanonical"><span class="hs-identifier hs-type">mkNonCanonical</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047101"><span class="hs-identifier hs-type">wanteds</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1619"></span><span>         </span><span class="hs-comment">-- NB: There are no meta tyvars fromn this level annotated_theta</span><span>
</span><span id="line-1620"></span><span>         </span><span class="hs-comment">-- because we have either promoted them or unified them</span><span>
</span><span id="line-1621"></span><span>         </span><span class="hs-comment">-- See `Note [Quantification and partial signatures]` Wrinkle 2</span><span>
</span><span id="line-1622"></span><span>
</span><span id="line-1623"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047107"><span class="hs-identifier hs-type">box_pred</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-type">ctPred</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1624"></span><span>                 </span><span class="annot"><a href="GHC.Data.Bag.html#bagToList"><span class="hs-identifier hs-type">bagToList</span></a></span><span>               </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1625"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047104"><span class="hs-identifier hs-type">residual</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1626"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1627"></span><span>     </span><span class="annot"><a href="#local-6989586621683047107"><span class="hs-identifier hs-type">box_pred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span>
</span><span id="line-1628"></span><span>     </span><span id="local-6989586621683047107"><span class="annot"><span class="annottext">box_pred :: TcType -&gt; TcType
</span><a href="#local-6989586621683047107"><span class="hs-identifier hs-var hs-var">box_pred</span></a></span></span><span> </span><span id="local-6989586621683047109"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047109"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047109"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1629"></span><span>                        </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span id="local-6989586621683047110"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683047110"><span class="hs-identifier hs-var">rel</span></a></span></span><span> </span><span id="local-6989586621683047111"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047111"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683047112"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047112"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-1630"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047113"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047113"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683047114"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047114"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; TcType -&gt; TcType -&gt; Maybe (Class, [TcType])
</span><a href="GHC.Tc.Utils.TcType.html#boxEqPred"><span class="hs-identifier hs-var">boxEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683047110"><span class="hs-identifier hs-var">rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047111"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047112"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1631"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047113"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047114"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1632"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1633"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcType
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;findInferredDiff&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047109"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1634"></span><span>                        </span><span id="local-6989586621683047117"><span class="annot"><span class="annottext">Pred
</span><a href="#local-6989586621683047117"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047109"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-1635"></span><span>
</span><span id="line-1636"></span><span class="hs-comment">{- Note [Emitting the residual implication in simplifyInfer]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f = e
where f's type is inferred to be something like (a, Proxy k (Int |&gt; co))
and we have an as-yet-unsolved, or perhaps insoluble, constraint
   [W] co :: Type ~ k
We can't form types like (forall co. blah), so we can't generalise over
the coercion variable, and hence we can't generalise over things free in
its kind, in the case 'k'.  But we can still generalise over 'a'.  So
we'll generalise to
   f :: forall a. (a, Proxy k (Int |&gt; co))
Now we do NOT want to form the residual implication constraint
   forall a. [W] co :: Type ~ k
because then co's eventual binding (which will be a value binding if we
use -fdefer-type-errors) won't scope over the entire binding for 'f' (whose
type mentions 'co').  Instead, just as we don't generalise over 'co', we
should not bury its constraint inside the implication.  Instead, we must
put it outside.

That is the reason for the partitionBag in emitResidualConstraints,
which takes the CoVars free in the inferred type, and pulls their
constraints out.  (NB: this set of CoVars should be closed-over-kinds.)

All rather subtle; see #14584.

Note [Add signature contexts as wanteds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (#11016):
  f2 :: (?x :: Int) =&gt; _
  f2 = ?x

or this
  class C a b | a -&gt; b
  g :: C p q =&gt; p -&gt; q
  f3 :: C Int b =&gt; _
  f3 = g (3::Int)

We'll use plan InferGen because there are holes in the type.  But:
 * For f2 we want to have the (?x :: Int) constraint floating around
   so that the functional dependencies kick in.  Otherwise the
   occurrence of ?x on the RHS produces constraint (?x :: alpha), and
   we won't unify alpha:=Int.

 * For f3 want the (C Int b) constraint from the partial signature
   to meet the (C Int beta) constraint we get from the call to g; again,
   fundeps

Solution: in simplifyInfer, we add the constraints from the signature
as extra Wanteds.

Why Wanteds?  Wouldn't it be neater to treat them as Givens?  Alas
that would mess up (GivenInv) in Note [TcLevel invariants].  Consider
    f :: (Eq a, _) =&gt; blah1
    f = ....g...
    g :: (Eq b, _) =&gt; blah2
    g = ...f...

Then we have two psig_theta constraints (Eq a[tv], Eq b[tv]), both with
TyVarTvs inside.  Ultimately a[tv] := b[tv], but only when we've solved
all those constraints.  And both have level 1, so we can't put them as
Givens when solving at level 1.

Best to treat them as Wanteds.

But see also #20076, which would be solved if they were Givens.


************************************************************************
*                                                                      *
                Quantification
*                                                                      *
************************************************************************

Note [Deciding quantification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the monomorphism restriction does not apply, then we quantify as follows:

* Step 1: decidePromotedTyVars.
  Take the global tyvars, and &quot;grow&quot; them using functional dependencies
     E.g.  if x:alpha is in the environment, and alpha ~ [beta] (which can
          happen because alpha is untouchable here) then do not quantify over
          beta, because alpha fixes beta, and beta is effectively free in
          the environment too; this logic extends to general fundeps, not
          just equalities

  We also account for the monomorphism restriction; if it applies,
  add the free vars of all the constraints.

  Result is mono_tvs; we will promote all of these to the outer levek,
  and certainly not quantify over them.

* Step 2: defaultTyVarsAndSimplify.
  Default any non-promoted tyvars (i.e ones that are definitely
  not going to become further constrained), and re-simplify the
  candidate constraints.

  Motivation for re-simplification (#7857): imagine we have a
  constraint (C (a-&gt;b)), where 'a :: TYPE l1' and 'b :: TYPE l2' are
  not free in the envt, and instance forall (a::*) (b::*). (C a) =&gt; C
  (a -&gt; b) The instance doesn't match while l1,l2 are polymorphic, but
  it will match when we default them to LiftedRep.

  This is all very tiresome.

  This step also promotes the mono_tvs from Step 1. See
  Note [Promote monomorphic tyvars]. In fact, the *only*
  use of the mono_tvs from Step 1 is to promote them here.
  This promotion effectively stops us from quantifying over them
  later, in Step 3. Because the actual variables to quantify
  over are determined in Step 3 (not in Step 1), it is OK for
  the mono_tvs to be missing some variables free in the
  environment. This is why removing the psig_qtvs is OK in
  decidePromotedTyVars. Test case for this scenario: T14479.

* Step 3: decideQuantifiedTyVars.
  Decide which variables to quantify over, as follows:

  - Take the free vars of the partial-type-signature types and constraints,
    and the tau-type (zonked_tau_tvs), and then &quot;grow&quot;
    them using all the constraints.  These are grown_tcvs.
    See Note [growThetaTyVars vs closeWrtFunDeps].

  - Use quantifyTyVars to quantify over the free variables of all the types
    involved, but only those in the grown_tcvs.

  Result is qtvs.

* Step 4: Filter the constraints using pickQuantifiablePreds and the
  qtvs. We have to zonk the constraints first, so they &quot;see&quot; the
  freshly created skolems.

Note [Unconditionally resimplify constraints when quantifying]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During quantification (in defaultTyVarsAndSimplify, specifically), we re-invoke
the solver to simplify the constraints before quantifying them. We do this for
two reasons, enumerated below. We could, in theory, detect when either of these
cases apply and simplify only then, but collecting this information is bothersome,
and simplifying redundantly causes no real harm. Note that this code path
happens only for definitions
  * without a type signature
  * when -XMonoLocalBinds does not apply
  * with unsolved constraints
and so the performance cost will be small.

1. Defaulting

Defaulting the variables handled by defaultTyVar may unlock instance simplifications.
Example (typecheck/should_compile/T20584b):

  with (t :: Double) (u :: String) = printf &quot;...&quot; t u

We know the types of t and u, but we do not know the return type of `with`. So, we
assume `with :: alpha`, where `alpha :: TYPE rho`. The type of printf is
  printf :: PrintfType r =&gt; String -&gt; r
The occurrence of printf is instantiated with a fresh var beta. We then get
  beta := Double -&gt; String -&gt; alpha
and
  [W] PrintfType (Double -&gt; String -&gt; alpha)

Module Text.Printf exports
  instance (PrintfArg a, PrintfType r) =&gt; PrintfType (a -&gt; r)
and it looks like that instance should apply.

But I have elided some key details: (-&gt;) is polymorphic over multiplicity and
runtime representation. Here it is in full glory:
  [W] PrintfType ((Double :: Type) %m1 -&gt; (String :: Type) %m2 -&gt; (alpha :: TYPE rho))
  instance (PrintfArg a, PrintfType r) =&gt; PrintfType ((a :: Type) %Many -&gt; (r :: Type))

Because we do not know that m1 is Many, we cannot use the instance. (Perhaps a better instance
would have an explicit equality constraint to the left of =&gt;, but that's not what we have.)
Then, in defaultTyVarsAndSimplify, we get m1 := Many, m2 := Many, and rho := LiftedRep.
Yet it's too late to simplify the quantified constraint, and thus GHC infers
  wait :: PrintfType (Double -&gt; String -&gt; t) =&gt; Double -&gt; String -&gt; t
which is silly. Simplifying again after defaulting solves this problem.

2. Interacting functional dependencies

Suppose we have

  class C a b | a -&gt; b

and we are running simplifyInfer over

  forall[2] x. () =&gt; [W] C a beta1[1]
  forall[2] y. () =&gt; [W] C a beta2[1]

These are two implication constraints, both of which contain a
wanted for the class C. Neither constraint mentions the bound
skolem. We might imagine that these constraints could thus float
out of their implications and then interact, causing beta1 to unify
with beta2, but constraints do not currently float out of implications.

Unifying the beta1 and beta2 is important. Without doing so, then we might
infer a type like (C a b1, C a b2) =&gt; a -&gt; a, which will fail to pass the
ambiguity check, which will say (rightly) that it cannot unify b1 with b2, as
required by the fundep interactions. This happens in the parsec library, and
in test case typecheck/should_compile/FloatFDs.

If we re-simplify, however, the two fundep constraints will interact, causing
a unification between beta1 and beta2, and all will be well. The key step
is that this simplification happens *after* the call to approximateWC in
simplifyInfer.

-}</span><span>
</span><span id="line-1841"></span><span>
</span><span id="line-1842"></span><span class="annot"><a href="GHC.Tc.Solver.html#decideQuantification"><span class="hs-identifier hs-type">decideQuantification</span></a></span><span>
</span><span id="line-1843"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a></span><span>
</span><span id="line-1844"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#InferMode"><span class="hs-identifier hs-type">InferMode</span></a></span><span>
</span><span id="line-1845"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span>
</span><span id="line-1846"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Variables to be generalised</span><span>
</span><span id="line-1847"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TcIdSigInst"><span class="hs-identifier hs-type">TcIdSigInst</span></a></span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Partial type signatures (if any)</span><span>
</span><span id="line-1848"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- Candidate theta; already zonked</span><span>
</span><span id="line-1849"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Quantify over these (skolems)</span><span>
</span><span id="line-1850"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- and this context (fully zonked)</span><span>
</span><span id="line-1851"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#CoVarSet"><span class="hs-identifier hs-type">CoVarSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1852"></span><span class="hs-comment">-- See Note [Deciding quantification]</span><span>
</span><span id="line-1853"></span><span id="decideQuantification"><span class="annot"><span class="annottext">decideQuantification :: SkolemInfo
-&gt; InferMode
-&gt; TcLevel
-&gt; [(Name, TcType)]
-&gt; [TcIdSigInst]
-&gt; [TcType]
-&gt; TcM ([TcTyVar], [TcType], VarSet)
</span><a href="GHC.Tc.Solver.html#decideQuantification"><span class="hs-identifier hs-var hs-var">decideQuantification</span></a></span></span><span> </span><span id="local-6989586621683047118"><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683047118"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683047119"><span class="annot"><span class="annottext">InferMode
</span><a href="#local-6989586621683047119"><span class="hs-identifier hs-var">infer_mode</span></a></span></span><span> </span><span id="local-6989586621683047120"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047120"><span class="hs-identifier hs-var">rhs_tclvl</span></a></span></span><span> </span><span id="local-6989586621683047121"><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047121"><span class="hs-identifier hs-var">name_taus</span></a></span></span><span> </span><span id="local-6989586621683047122"><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047122"><span class="hs-identifier hs-var">psigs</span></a></span></span><span> </span><span id="local-6989586621683047123"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047123"><span class="hs-identifier hs-var">candidates</span></a></span></span><span>
</span><span id="line-1854"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Step 1: find the mono_tvs</span><span>
</span><span id="line-1855"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047124"><span class="annot"><a href="#local-6989586621683047124"><span class="hs-identifier hs-var">candidates</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047125"><span class="annot"><a href="#local-6989586621683047125"><span class="hs-identifier hs-var">co_vars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047126"><span class="annot"><a href="#local-6989586621683047126"><span class="hs-identifier hs-var">mono_tvs0</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1856"></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferMode
-&gt; [(Name, TcType)]
-&gt; [TcIdSigInst]
-&gt; [TcType]
-&gt; TcM ([TcType], VarSet, VarSet)
</span><a href="GHC.Tc.Solver.html#decidePromotedTyVars"><span class="hs-identifier hs-var">decidePromotedTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">InferMode
</span><a href="#local-6989586621683047119"><span class="hs-identifier hs-var">infer_mode</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047121"><span class="hs-identifier hs-var">name_taus</span></a></span><span> </span><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047122"><span class="hs-identifier hs-var">psigs</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047123"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-1857"></span><span>
</span><span id="line-1858"></span><span>       </span><span class="hs-comment">-- Step 2: default any non-mono tyvars, and re-simplify</span><span>
</span><span id="line-1859"></span><span>       </span><span class="hs-comment">-- This step may do some unification, but result candidates is zonked</span><span>
</span><span id="line-1860"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047128"><span class="annot"><a href="#local-6989586621683047128"><span class="hs-identifier hs-var">candidates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#defaultTyVarsAndSimplify"><span class="hs-identifier hs-type">defaultTyVarsAndSimplify</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047120"><span class="hs-identifier hs-type">rhs_tclvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047124"><span class="hs-identifier hs-type">candidates</span></a></span><span>
</span><span id="line-1861"></span><span>
</span><span id="line-1862"></span><span>       </span><span class="hs-comment">-- Step 3: decide which kind/type variables to quantify over</span><span>
</span><span id="line-1863"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047130"><span class="annot"><a href="#local-6989586621683047130"><span class="hs-identifier hs-var">qtvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#decideQuantifiedTyVars"><span class="hs-identifier hs-type">decideQuantifiedTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047118"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047121"><span class="hs-identifier hs-type">name_taus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047122"><span class="hs-identifier hs-type">psigs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047128"><span class="hs-identifier hs-type">candidates</span></a></span><span>
</span><span id="line-1864"></span><span>
</span><span id="line-1865"></span><span>       </span><span class="hs-comment">-- Step 4: choose which of the remaining candidate</span><span>
</span><span id="line-1866"></span><span>       </span><span class="hs-comment">--         predicates to actually quantify over</span><span>
</span><span id="line-1867"></span><span>       </span><span class="hs-comment">-- NB: decideQuantifiedTyVars turned some meta tyvars</span><span>
</span><span id="line-1868"></span><span>       </span><span class="hs-comment">-- into quantified skolems, so we have to zonk again</span><span>
</span><span id="line-1869"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047132"><span class="annot"><a href="#local-6989586621683047132"><span class="hs-identifier hs-var">candidates</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047133"><span class="annot"><a href="#local-6989586621683047133"><span class="hs-identifier hs-var">psig_theta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-type">TcM.liftZonkM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1870"></span><span>          </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047134"><span class="annot"><a href="#local-6989586621683047134"><span class="hs-identifier hs-var">candidates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkTcTypes"><span class="hs-identifier hs-type">TcM.zonkTcTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047128"><span class="hs-identifier hs-type">candidates</span></a></span><span>
</span><span id="line-1871"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047136"><span class="annot"><a href="#local-6989586621683047136"><span class="hs-identifier hs-var">psig_theta</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkTcTypes"><span class="hs-identifier hs-type">TcM.zonkTcTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">concatMap</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#sig_inst_theta"><span class="hs-identifier hs-var">sig_inst_theta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047122"><span class="hs-identifier hs-type">psigs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1872"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047134"><span class="hs-identifier hs-type">candidates</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047136"><span class="hs-identifier hs-type">psig_theta</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1873"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047137"><span class="annot"><a href="#local-6989586621683047137"><span class="hs-identifier hs-var">min_theta</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#pickQuantifiablePreds"><span class="hs-identifier hs-type">pickQuantifiablePreds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-type">mkVarSet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047130"><span class="hs-identifier hs-type">qtvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683047126"><span class="hs-identifier hs-type">mono_tvs0</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047132"><span class="hs-identifier hs-type">candidates</span></a></span><span>
</span><span id="line-1874"></span><span>
</span><span id="line-1875"></span><span>       </span><span class="hs-comment">-- Take account of partial type signatures</span><span>
</span><span id="line-1876"></span><span>       </span><span class="hs-comment">-- See Note [Constraints in partial type signatures]</span><span>
</span><span id="line-1877"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047140"><span class="annot"><a href="#local-6989586621683047140"><span class="hs-identifier hs-var hs-var">min_psig_theta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcType) -&gt; [TcType] -&gt; [TcType]
forall a. (a -&gt; TcType) -&gt; [a] -&gt; [a]
</span><a href="GHC.Tc.Utils.TcType.html#mkMinimalBySCs"><span class="hs-identifier hs-var">mkMinimalBySCs</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; TcType
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047133"><span class="hs-identifier hs-var">psig_theta</span></a></span><span>
</span><span id="line-1878"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047143"><span class="annot"><a href="#local-6989586621683047143"><span class="hs-identifier hs-var">theta</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span>
</span><span id="line-1879"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683047122"><span class="hs-identifier hs-type">psigs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683047137"><span class="hs-identifier hs-type">min_theta</span></a></span><span>                 </span><span class="hs-comment">-- Case (P3)</span><span>
</span><span id="line-1880"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">all</span></span><span> </span><span class="annot"><a href="#local-6989586621683047144"><span class="hs-identifier hs-type">has_extra_constraints_wildcard</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047122"><span class="hs-identifier hs-type">psigs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Case (P2)</span><span>
</span><span id="line-1881"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683047140"><span class="hs-identifier hs-type">min_psig_theta</span></a></span><span>
</span><span id="line-1882"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span>                                      </span><span class="hs-comment">-- Case (P1)</span><span>
</span><span id="line-1883"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047145"><span class="annot"><a href="#local-6989586621683047145"><span class="hs-identifier hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#findInferredDiff"><span class="hs-identifier hs-type">findInferredDiff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047140"><span class="hs-identifier hs-type">min_psig_theta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047137"><span class="hs-identifier hs-type">min_theta</span></a></span><span>
</span><span id="line-1884"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047140"><span class="hs-identifier hs-type">min_psig_theta</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683047145"><span class="hs-identifier hs-type">diff</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1885"></span><span>
</span><span id="line-1886"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;decideQuantification&quot;</span></span><span>
</span><span id="line-1887"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;infer_mode:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047119"><span class="hs-identifier hs-type">infer_mode</span></a></span><span>
</span><span id="line-1888"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;candidates:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047132"><span class="hs-identifier hs-type">candidates</span></a></span><span>
</span><span id="line-1889"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;psig_theta:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047133"><span class="hs-identifier hs-type">psig_theta</span></a></span><span>
</span><span id="line-1890"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;co_vars:&quot;</span></span><span>    </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047125"><span class="hs-identifier hs-type">co_vars</span></a></span><span>
</span><span id="line-1891"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;qtvs:&quot;</span></span><span>       </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047130"><span class="hs-identifier hs-type">qtvs</span></a></span><span>
</span><span id="line-1892"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;theta:&quot;</span></span><span>      </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047143"><span class="hs-identifier hs-type">theta</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1893"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047130"><span class="hs-identifier hs-type">qtvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047143"><span class="hs-identifier hs-type">theta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047125"><span class="hs-identifier hs-type">co_vars</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1894"></span><span>
</span><span id="line-1895"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1896"></span><span>    </span><span id="local-6989586621683047144"><span class="annot"><span class="annottext">has_extra_constraints_wildcard :: TcIdSigInst -&gt; Bool
</span><a href="#local-6989586621683047144"><span class="hs-identifier hs-var hs-var">has_extra_constraints_wildcard</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TISI"><span class="hs-identifier hs-type">TISI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sig_inst_wcx :: TcIdSigInst -&gt; Maybe TcType
</span><a href="GHC.Tc.Types.BasicTypes.html#sig_inst_wcx"><span class="hs-identifier hs-var">sig_inst_wcx</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1897"></span><span>    </span><span class="annot"><a href="#local-6989586621683047144"><span class="hs-identifier hs-var">has_extra_constraints_wildcard</span></a></span><span> </span><span class="annot"><span class="annottext">TcIdSigInst
</span><span class="hs-identifier">_</span></span><span>                                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1898"></span><span>
</span><span id="line-1899"></span><span class="hs-comment">{- Note [Constraints in partial type signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have decided to quantify over min_theta, say (Eq a, C a, Ix a).
Then we distinguish three cases:

(P1) No partial type signatures: just quantify over min_theta

(P2) Partial type signatures with no extra_constraints wildcard:
      e.g.   f :: (Eq a, C a) =&gt; a -&gt; _
     Quantify over psig_theta: the user has explicitly specified the
     entire context.

     That may mean we have an unsolved residual constraint (Ix a) arising
     from the RHS of the function. But so be it: the user said (Eq a, C a).

(P3) Partial type signature with an extra_constraints wildcard.
      e.g.   f :: (Eq a, C a, _) =&gt; a -&gt; a
    Quantify over (psig_theta ++ diff)
      where diff = min_theta - psig_theta, using findInferredDiff.
    In our example, diff = Ix a

Some rationale and observations

* See Note [When the MR applies] in GHC.Tc.Gen.Bind.

* We always want to quantify over psig_theta (if present).  The user specified
  it!  And pickQuantifiableCandidates might have dropped some
  e.g. CallStack constraints.  c.f #14658
       equalities (a ~ Bool)

* In case (P3) we ask that /all/ the signatures have an extra-constraints
  wildcard.  It's a bit arbitrary; not clear what the &quot;right&quot; thing is.

* In (P2) we encounter #20076:
     f :: Eq [a] =&gt; a -&gt; _
     f x = [x] == [x]
  From the RHS we get [W] Eq [a].  We simplify those Wanteds in simplifyInfer,
  to get (Eq a).  But then we quantify over the user-specified (Eq [a]), leaving
  a residual implication constraint (forall a. Eq [a] =&gt; [W] Eq a), which is
  insoluble.  Idea: in simplifyInfer we could put the /un-simplified/ constraints
  in the residual -- at least in the case like #20076 where the partial signature
  fully specifies the final constraint. Maybe: a battle for another day.

* It's helpful to use the same &quot;find difference&quot; algorithm, `findInferredDiff`,
  here as we use in GHC.Tc.Gen.Bind.chooseInferredQuantifiers (#20921)

  At least for single functions we would like to quantify f over precisely the
  same theta as &lt;quant-theta&gt;, so that we get to take the short-cut path in
  `GHC.Tc.Gen.Bind.mkExport`, and avoid calling `tcSubTypeSigma` for impedance
  matching. Why avoid?  Because it falls over for ambiguous types (#20921).

  We can get precisely the same theta by using the same algorithm,
  `findInferredDiff`.

* All of this goes wrong if we have (a) mutual recursion, (b) multiple
  partial type signatures, (c) with different constraints, and (d)
  ambiguous types.  Something like
    f :: forall a. Eq a =&gt; F a -&gt; _
    f x = (undefined :: a) == g x undefined
    g :: forall b. Show b =&gt; F b -&gt; _ -&gt; b
    g x y = let _ = (f y, show x) in x
  But that's a battle for another day.
-}</span><span>
</span><span id="line-1962"></span><span>
</span><span id="line-1963"></span><span class="annot"><a href="GHC.Tc.Solver.html#decidePromotedTyVars"><span class="hs-identifier hs-type">decidePromotedTyVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#InferMode"><span class="hs-identifier hs-type">InferMode</span></a></span><span>
</span><span id="line-1964"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1965"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TcIdSigInst"><span class="hs-identifier hs-type">TcIdSigInst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1966"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1967"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#CoVarSet"><span class="hs-identifier hs-type">CoVarSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTyVarSet"><span class="hs-identifier hs-type">TcTyVarSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1968"></span><span class="hs-comment">-- We are about to generalise over type variables at level N</span><span>
</span><span id="line-1969"></span><span class="hs-comment">-- Each must be either</span><span>
</span><span id="line-1970"></span><span class="hs-comment">--    (P) promoted</span><span>
</span><span id="line-1971"></span><span class="hs-comment">--    (D) defaulted</span><span>
</span><span id="line-1972"></span><span class="hs-comment">--    (Q) quantified</span><span>
</span><span id="line-1973"></span><span class="hs-comment">-- This function finds (P), the type variables that we are going to promote:</span><span>
</span><span id="line-1974"></span><span class="hs-comment">--   (a) Mentioned in a constraint we can't generalise (the MR)</span><span>
</span><span id="line-1975"></span><span class="hs-comment">--   (b) Mentioned in the kind of a CoVar; we can't quantify over a CoVar,</span><span>
</span><span id="line-1976"></span><span class="hs-comment">--       so we must not quantify over a type variable free in its kind</span><span>
</span><span id="line-1977"></span><span class="hs-comment">--   (c) Connected by an equality or fundep to</span><span>
</span><span id="line-1978"></span><span class="hs-comment">--          * a type variable at level &lt; N, or</span><span>
</span><span id="line-1979"></span><span class="hs-comment">--          * A tyvar subject to (a), (b) or (c)</span><span>
</span><span id="line-1980"></span><span class="hs-comment">-- Having found all such level-N tyvars that we can't generalise,</span><span>
</span><span id="line-1981"></span><span class="hs-comment">-- promote them, to eliminate them from further consideration.</span><span>
</span><span id="line-1982"></span><span class="hs-comment">--</span><span>
</span><span id="line-1983"></span><span class="hs-comment">-- Also return CoVars that appear free in the final quantified types</span><span>
</span><span id="line-1984"></span><span class="hs-comment">--   we can't quantify over these, and we must make sure they are in scope</span><span>
</span><span id="line-1985"></span><span id="decidePromotedTyVars"><span class="annot"><span class="annottext">decidePromotedTyVars :: InferMode
-&gt; [(Name, TcType)]
-&gt; [TcIdSigInst]
-&gt; [TcType]
-&gt; TcM ([TcType], VarSet, VarSet)
</span><a href="GHC.Tc.Solver.html#decidePromotedTyVars"><span class="hs-identifier hs-var hs-var">decidePromotedTyVars</span></a></span></span><span> </span><span id="local-6989586621683047149"><span class="annot"><span class="annottext">InferMode
</span><a href="#local-6989586621683047149"><span class="hs-identifier hs-var">infer_mode</span></a></span></span><span> </span><span id="local-6989586621683047150"><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047150"><span class="hs-identifier hs-var">name_taus</span></a></span></span><span> </span><span id="local-6989586621683047151"><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047151"><span class="hs-identifier hs-var">psigs</span></a></span></span><span> </span><span id="local-6989586621683047152"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047152"><span class="hs-identifier hs-var">candidates</span></a></span></span><span>
</span><span id="line-1986"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047153"><span class="annot"><a href="#local-6989586621683047153"><span class="hs-identifier hs-var">tc_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM TcLevel
</span><a href="GHC.Tc.Utils.Monad.html#getTcLevel"><span class="hs-identifier hs-var">TcM.getTcLevel</span></a></span><span>
</span><span id="line-1987"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047154"><span class="annot"><a href="#local-6989586621683047154"><span class="hs-identifier hs-var">no_quant</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047155"><span class="annot"><a href="#local-6989586621683047155"><span class="hs-identifier hs-var">maybe_quant</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683047156"><span class="hs-identifier hs-type">pick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047149"><span class="hs-identifier hs-type">infer_mode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047152"><span class="hs-identifier hs-type">candidates</span></a></span><span>
</span><span id="line-1988"></span><span>
</span><span id="line-1989"></span><span>       </span><span class="hs-comment">-- If possible, we quantify over partial-sig qtvs, so they are</span><span>
</span><span id="line-1990"></span><span>       </span><span class="hs-comment">-- not mono. Need to zonk them because they are meta-tyvar TyVarTvs</span><span>
</span><span id="line-1991"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047157"><span class="annot"><a href="#local-6989586621683047157"><span class="hs-identifier hs-var">psig_qtvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047158"><span class="annot"><a href="#local-6989586621683047158"><span class="hs-identifier hs-var">psig_theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047159"><span class="annot"><a href="#local-6989586621683047159"><span class="hs-identifier hs-var">taus</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-type">TcM.liftZonkM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1992"></span><span>          </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047160"><span class="annot"><a href="#local-6989586621683047160"><span class="hs-identifier hs-var">psig_qtvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkTcTyVarsToTcTyVars"><span class="hs-identifier hs-type">zonkTcTyVarsToTcTyVars</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#binderVars"><span class="hs-identifier hs-type">binderVars</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1993"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">snd</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#sig_inst_skols"><span class="hs-identifier hs-var">sig_inst_skols</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683047151"><span class="hs-identifier hs-type">psigs</span></a></span><span>
</span><span id="line-1994"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047162"><span class="annot"><a href="#local-6989586621683047162"><span class="hs-identifier hs-var">psig_theta</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkTcType"><span class="hs-identifier hs-type">TcM.zonkTcType</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1995"></span><span>                             </span><span class="annot"><span class="hs-identifier hs-type">concatMap</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#sig_inst_theta"><span class="hs-identifier hs-var">sig_inst_theta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047151"><span class="hs-identifier hs-type">psigs</span></a></span><span>
</span><span id="line-1996"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047164"><span class="annot"><a href="#local-6989586621683047164"><span class="hs-identifier hs-var">taus</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkTcType"><span class="hs-identifier hs-type">TcM.zonkTcType</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683047150"><span class="hs-identifier hs-type">name_taus</span></a></span><span>
</span><span id="line-1997"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047160"><span class="hs-identifier hs-type">psig_qtvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047162"><span class="hs-identifier hs-type">psig_theta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047164"><span class="hs-identifier hs-type">taus</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1998"></span><span>
</span><span id="line-1999"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047165"><span class="annot"><a href="#local-6989586621683047165"><span class="hs-identifier hs-var hs-var">psig_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; [TcType]
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047157"><span class="hs-identifier hs-var">psig_qtvs</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; [TcType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047158"><span class="hs-identifier hs-var">psig_theta</span></a></span><span>
</span><span id="line-2000"></span><span>
</span><span id="line-2001"></span><span>             </span><span class="hs-comment">-- (b) The co_var_tvs are tvs mentioned in the types of covars or</span><span>
</span><span id="line-2002"></span><span>             </span><span class="hs-comment">-- coercion holes. We can't quantify over these covars, so we</span><span>
</span><span id="line-2003"></span><span>             </span><span class="hs-comment">-- must include the variable in their types in the mono_tvs.</span><span>
</span><span id="line-2004"></span><span>             </span><span class="hs-comment">-- E.g.  If we can't quantify over co :: k~Type, then we can't</span><span>
</span><span id="line-2005"></span><span>             </span><span class="hs-comment">--       quantify over k either!  Hence closeOverKinds</span><span>
</span><span id="line-2006"></span><span>             </span><span class="hs-comment">-- Recall that coVarsOfTypes also returns coercion holes</span><span>
</span><span id="line-2007"></span><span>             </span><span id="local-6989586621683047167"><span class="annot"><a href="#local-6989586621683047167"><span class="hs-identifier hs-var hs-var">co_vars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#coVarsOfTypes"><span class="hs-identifier hs-var">coVarsOfTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047165"><span class="hs-identifier hs-var">psig_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; [TcType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047159"><span class="hs-identifier hs-var">taus</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; [TcType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047152"><span class="hs-identifier hs-var">candidates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2008"></span><span>             </span><span id="local-6989586621683047169"><span class="annot"><a href="#local-6989586621683047169"><span class="hs-identifier hs-var hs-var">co_var_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#closeOverKinds"><span class="hs-identifier hs-var">closeOverKinds</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047167"><span class="hs-identifier hs-var">co_vars</span></a></span><span>
</span><span id="line-2009"></span><span>
</span><span id="line-2010"></span><span>             </span><span id="local-6989586621683047171"><span class="annot"><a href="#local-6989586621683047171"><span class="hs-identifier hs-var hs-var">mono_tvs0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (TcTyVar -&gt; Bool) -&gt; TcTyVar -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcMType.html#isQuantifiableTv"><span class="hs-identifier hs-var">isQuantifiableTv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047153"><span class="hs-identifier hs-var">tc_lvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarSet) -&gt; VarSet -&gt; VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2011"></span><span>                         </span><span class="annot"><span class="annottext">[TcType] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047152"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-2012"></span><span>               </span><span class="hs-comment">-- We need to grab all the non-quantifiable tyvars in the</span><span>
</span><span id="line-2013"></span><span>               </span><span class="hs-comment">-- types so that we can grow this set to find other</span><span>
</span><span id="line-2014"></span><span>               </span><span class="hs-comment">-- non-quantifiable tyvars. This can happen with something like</span><span>
</span><span id="line-2015"></span><span>               </span><span class="hs-comment">--    f x y = ...</span><span>
</span><span id="line-2016"></span><span>               </span><span class="hs-comment">--      where z = x 3</span><span>
</span><span id="line-2017"></span><span>               </span><span class="hs-comment">-- The body of z tries to unify the type of x (call it alpha[1])</span><span>
</span><span id="line-2018"></span><span>               </span><span class="hs-comment">-- with (beta[2] -&gt; gamma[2]). This unification fails because</span><span>
</span><span id="line-2019"></span><span>               </span><span class="hs-comment">-- alpha is untouchable, leaving [W] alpha[1] ~ (beta[2] -&gt; gamma[2]).</span><span>
</span><span id="line-2020"></span><span>               </span><span class="hs-comment">-- We need to know not to quantify over beta or gamma, because they</span><span>
</span><span id="line-2021"></span><span>               </span><span class="hs-comment">-- are in the equality constraint with alpha. Actual test case:</span><span>
</span><span id="line-2022"></span><span>               </span><span class="hs-comment">-- typecheck/should_compile/tc213</span><span>
</span><span id="line-2023"></span><span>
</span><span id="line-2024"></span><span>             </span><span id="local-6989586621683047175"><span class="annot"><a href="#local-6989586621683047175"><span class="hs-identifier hs-var hs-var">mono_tvs1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047171"><span class="hs-identifier hs-var">mono_tvs0</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047169"><span class="hs-identifier hs-var">co_var_tvs</span></a></span><span>
</span><span id="line-2025"></span><span>
</span><span id="line-2026"></span><span>               </span><span class="hs-comment">-- mono_tvs1 is now the set of variables from an outer scope</span><span>
</span><span id="line-2027"></span><span>               </span><span class="hs-comment">-- (that's mono_tvs0) and the set of covars, closed over kinds.</span><span>
</span><span id="line-2028"></span><span>               </span><span class="hs-comment">-- Given this set of variables we know we will not quantify,</span><span>
</span><span id="line-2029"></span><span>               </span><span class="hs-comment">-- we want to find any other variables that are determined by this</span><span>
</span><span id="line-2030"></span><span>               </span><span class="hs-comment">-- set, by functional dependencies or equalities. We thus use</span><span>
</span><span id="line-2031"></span><span>               </span><span class="hs-comment">-- closeWrtFunDeps to find all further variables determined by this root</span><span>
</span><span id="line-2032"></span><span>               </span><span class="hs-comment">-- set. See Note [growThetaTyVars vs closeWrtFunDeps]</span><span>
</span><span id="line-2033"></span><span>
</span><span id="line-2034"></span><span>             </span><span id="local-6989586621683047177"><span class="annot"><a href="#local-6989586621683047177"><span class="hs-identifier hs-var hs-var">non_ip_candidates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; Bool) -&gt; [TcType] -&gt; [TcType]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isIPLikePred"><span class="hs-identifier hs-var">isIPLikePred</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047152"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-2035"></span><span>               </span><span class="hs-comment">-- implicit params don't really determine a type variable</span><span>
</span><span id="line-2036"></span><span>               </span><span class="hs-comment">-- (that is, we might have IP &quot;c&quot; Bool and IP &quot;c&quot; Int in different</span><span>
</span><span id="line-2037"></span><span>               </span><span class="hs-comment">-- places within the same program), and</span><span>
</span><span id="line-2038"></span><span>               </span><span class="hs-comment">-- skipping this causes implicit params to monomorphise too many</span><span>
</span><span id="line-2039"></span><span>               </span><span class="hs-comment">-- variables; see Note [Inheriting implicit parameters] in GHC.Tc.Solver.</span><span>
</span><span id="line-2040"></span><span>               </span><span class="hs-comment">-- Skipping causes typecheck/should_compile/tc219 to fail.</span><span>
</span><span id="line-2041"></span><span>
</span><span id="line-2042"></span><span>             </span><span id="local-6989586621683047180"><span class="annot"><a href="#local-6989586621683047180"><span class="hs-identifier hs-var hs-var">mono_tvs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Tc.Instance.FunDeps.html#closeWrtFunDeps"><span class="hs-identifier hs-var">closeWrtFunDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047177"><span class="hs-identifier hs-var">non_ip_candidates</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047175"><span class="hs-identifier hs-var">mono_tvs1</span></a></span><span>
</span><span id="line-2043"></span><span>               </span><span class="hs-comment">-- mono_tvs2 now contains any variable determined by the &quot;root</span><span>
</span><span id="line-2044"></span><span>               </span><span class="hs-comment">-- set&quot; of monomorphic tyvars in mono_tvs1.</span><span>
</span><span id="line-2045"></span><span>
</span><span id="line-2046"></span><span>             </span><span id="local-6989586621683047182"><span class="annot"><a href="#local-6989586621683047182"><span class="hs-identifier hs-var hs-var">constrained_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcLevel -&gt; TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcMType.html#isQuantifiableTv"><span class="hs-identifier hs-var">isQuantifiableTv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047153"><span class="hs-identifier hs-var">tc_lvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarSet) -&gt; VarSet -&gt; VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2047"></span><span>                               </span><span class="annot"><span class="annottext">[TcType] -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Tc.Instance.FunDeps.html#closeWrtFunDeps"><span class="hs-identifier hs-var">closeWrtFunDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047177"><span class="hs-identifier hs-var">non_ip_candidates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcType] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047154"><span class="hs-identifier hs-var">no_quant</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2048"></span><span>                                </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#minusVarSet"><span class="hs-operator hs-var">`minusVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047180"><span class="hs-identifier hs-var">mono_tvs2</span></a></span><span>
</span><span id="line-2049"></span><span>             </span><span class="hs-comment">-- constrained_tvs: the tyvars that we are not going to</span><span>
</span><span id="line-2050"></span><span>             </span><span class="hs-comment">-- quantify /solely/ because of the monomorphism restriction</span><span>
</span><span id="line-2051"></span><span>             </span><span class="hs-comment">--</span><span>
</span><span id="line-2052"></span><span>             </span><span class="hs-comment">-- (`minusVarSet` mono_tvs2): a type variable is only</span><span>
</span><span id="line-2053"></span><span>             </span><span class="hs-comment">--   &quot;constrained&quot; (so that the MR bites) if it is not</span><span>
</span><span id="line-2054"></span><span>             </span><span class="hs-comment">--   free in the environment (#13785) or is determined</span><span>
</span><span id="line-2055"></span><span>             </span><span class="hs-comment">--   by some variable that is free in the env't</span><span>
</span><span id="line-2056"></span><span>
</span><span id="line-2057"></span><span>             </span><span id="local-6989586621683047184"><span class="annot"><a href="#local-6989586621683047184"><span class="hs-identifier hs-var hs-var">mono_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047180"><span class="hs-identifier hs-var">mono_tvs2</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047182"><span class="hs-identifier hs-var">constrained_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2058"></span><span>                        </span><span class="annot"><span class="annottext">VarSet -&gt; [TcTyVar] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#delVarSetList"><span class="hs-operator hs-var">`delVarSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047157"><span class="hs-identifier hs-var">psig_qtvs</span></a></span><span>
</span><span id="line-2059"></span><span>             </span><span class="hs-comment">-- (`delVarSetList` psig_qtvs): if the user has explicitly</span><span>
</span><span id="line-2060"></span><span>             </span><span class="hs-comment">--   asked for quantification, then that request &quot;wins&quot;</span><span>
</span><span id="line-2061"></span><span>             </span><span class="hs-comment">--   over the MR.</span><span>
</span><span id="line-2062"></span><span>             </span><span class="hs-comment">--</span><span>
</span><span id="line-2063"></span><span>             </span><span class="hs-comment">-- What if a psig variable is also free in the environment</span><span>
</span><span id="line-2064"></span><span>             </span><span class="hs-comment">-- (i.e. says &quot;no&quot; to isQuantifiableTv)? That's OK: explanation</span><span>
</span><span id="line-2065"></span><span>             </span><span class="hs-comment">-- in Step 2 of Note [Deciding quantification].</span><span>
</span><span id="line-2066"></span><span>
</span><span id="line-2067"></span><span>           </span><span class="hs-comment">-- Warn about the monomorphism restriction</span><span>
</span><span id="line-2068"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683047149"><span class="hs-identifier hs-type">infer_mode</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">InferMode
</span><a href="GHC.Tc.Solver.html#ApplyMR"><span class="hs-identifier hs-var">ApplyMR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">InferMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2069"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047186"><span class="annot"><a href="#local-6989586621683047186"><span class="hs-identifier hs-var hs-var">dia</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnMonomorphicBindings"><span class="hs-identifier hs-var">TcRnMonomorphicBindings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, TcType) -&gt; Name) -&gt; [(Name, TcType)] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, TcType) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047150"><span class="hs-identifier hs-var">name_taus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2070"></span><span>           </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#diagnosticTc"><span class="hs-identifier hs-type">diagnosticTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047182"><span class="hs-identifier hs-type">constrained_tvs</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-type">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-type">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047159"><span class="hs-identifier hs-type">taus</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683047186"><span class="hs-identifier hs-type">dia</span></a></span><span>
</span><span id="line-2071"></span><span>
</span><span id="line-2072"></span><span>       </span><span class="hs-comment">-- Promote the mono_tvs: see Note [Promote monomorphic tyvars]</span><span>
</span><span id="line-2073"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#promoteTyVarSet"><span class="hs-identifier hs-type">promoteTyVarSet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047184"><span class="hs-identifier hs-type">mono_tvs</span></a></span><span>
</span><span id="line-2074"></span><span>
</span><span id="line-2075"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;decidePromotedTyVars&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span>
</span><span id="line-2076"></span><span>           </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;infer_mode =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047149"><span class="hs-identifier hs-type">infer_mode</span></a></span><span>
</span><span id="line-2077"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;psigs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047151"><span class="hs-identifier hs-type">psigs</span></a></span><span>
</span><span id="line-2078"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;psig_qtvs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047157"><span class="hs-identifier hs-type">psig_qtvs</span></a></span><span>
</span><span id="line-2079"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;mono_tvs0 =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047171"><span class="hs-identifier hs-type">mono_tvs0</span></a></span><span>
</span><span id="line-2080"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;no_quant =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047154"><span class="hs-identifier hs-type">no_quant</span></a></span><span>
</span><span id="line-2081"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;maybe_quant =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047155"><span class="hs-identifier hs-type">maybe_quant</span></a></span><span>
</span><span id="line-2082"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;mono_tvs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047184"><span class="hs-identifier hs-type">mono_tvs</span></a></span><span>
</span><span id="line-2083"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;co_vars =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047167"><span class="hs-identifier hs-type">co_vars</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2084"></span><span>
</span><span id="line-2085"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047155"><span class="hs-identifier hs-type">maybe_quant</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047167"><span class="hs-identifier hs-type">co_vars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047171"><span class="hs-identifier hs-type">mono_tvs0</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2086"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2087"></span><span>    </span><span class="annot"><a href="#local-6989586621683047156"><span class="hs-identifier hs-type">pick</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#InferMode"><span class="hs-identifier hs-type">InferMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2088"></span><span>    </span><span class="hs-comment">-- Split the candidates into ones we definitely</span><span>
</span><span id="line-2089"></span><span>    </span><span class="hs-comment">-- won't quantify, and ones that we might</span><span>
</span><span id="line-2090"></span><span>    </span><span id="local-6989586621683047156"><span class="annot"><span class="annottext">pick :: InferMode -&gt; [TcType] -&gt; TcM ([TcType], [TcType])
</span><a href="#local-6989586621683047156"><span class="hs-identifier hs-var hs-var">pick</span></a></span></span><span> </span><span class="annot"><span class="annottext">InferMode
</span><a href="GHC.Tc.Solver.html#ApplyMR"><span class="hs-identifier hs-var">ApplyMR</span></a></span><span>         </span><span id="local-6989586621683047191"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047191"><span class="hs-identifier hs-var">cand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([TcType], [TcType]) -&gt; TcM ([TcType], [TcType])
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047191"><span class="hs-identifier hs-var">cand</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2091"></span><span>    </span><span class="annot"><a href="#local-6989586621683047156"><span class="hs-identifier hs-var">pick</span></a></span><span> </span><span class="annot"><span class="annottext">InferMode
</span><a href="GHC.Tc.Solver.html#NoRestrictions"><span class="hs-identifier hs-var">NoRestrictions</span></a></span><span>  </span><span id="local-6989586621683047192"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047192"><span class="hs-identifier hs-var">cand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([TcType], [TcType]) -&gt; TcM ([TcType], [TcType])
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047192"><span class="hs-identifier hs-var">cand</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2092"></span><span>    </span><span class="annot"><a href="#local-6989586621683047156"><span class="hs-identifier hs-var">pick</span></a></span><span> </span><span class="annot"><span class="annottext">InferMode
</span><a href="GHC.Tc.Solver.html#EagerDefaulting"><span class="hs-identifier hs-var">EagerDefaulting</span></a></span><span> </span><span id="local-6989586621683047193"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047193"><span class="hs-identifier hs-var">cand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047194"><span class="annot"><a href="#local-6989586621683047194"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcM Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.OverloadedStrings</span></span><span>
</span><span id="line-2093"></span><span>                                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">partition</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047197"><span class="hs-identifier hs-type">is_int_ct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047194"><span class="hs-identifier hs-type">os</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683047193"><span class="hs-identifier hs-type">cand</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2094"></span><span>
</span><span id="line-2095"></span><span>    </span><span class="hs-comment">-- is_int_ct returns True for a constraint we should /not/ quantify</span><span>
</span><span id="line-2096"></span><span>    </span><span class="hs-comment">-- For EagerDefaulting, do not quantify over</span><span>
</span><span id="line-2097"></span><span>    </span><span class="hs-comment">-- over any interactive class constraint</span><span>
</span><span id="line-2098"></span><span>    </span><span id="local-6989586621683047197"><span class="annot"><span class="annottext">is_int_ct :: Bool -&gt; TcType -&gt; Bool
</span><a href="#local-6989586621683047197"><span class="hs-identifier hs-var hs-var">is_int_ct</span></a></span></span><span> </span><span id="local-6989586621683047198"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047198"><span class="hs-identifier hs-var">ovl_strings</span></a></span></span><span> </span><span id="local-6989586621683047199"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047199"><span class="hs-identifier hs-var">pred</span></a></span></span><span>
</span><span id="line-2099"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047199"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2100"></span><span>           </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621683047200"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047200"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Class -&gt; Bool
</span><a href="GHC.Tc.Solver.html#isInteractiveClass"><span class="hs-identifier hs-var">isInteractiveClass</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047198"><span class="hs-identifier hs-var">ovl_strings</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047200"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-2101"></span><span>           </span><span class="annot"><span class="annottext">Pred
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2102"></span><span>
</span><span id="line-2103"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-2104"></span><span class="annot"><a href="GHC.Tc.Solver.html#defaultTyVarsAndSimplify"><span class="hs-identifier hs-type">defaultTyVarsAndSimplify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a></span><span>
</span><span id="line-2105"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- Assumed zonked</span><span>
</span><span id="line-2106"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Guaranteed zonked</span><span>
</span><span id="line-2107"></span><span class="hs-comment">-- Default any tyvar free in the constraints;</span><span>
</span><span id="line-2108"></span><span class="hs-comment">-- and re-simplify in case the defaulting allows further simplification</span><span>
</span><span id="line-2109"></span><span id="defaultTyVarsAndSimplify"><span class="annot"><span class="annottext">defaultTyVarsAndSimplify :: TcLevel -&gt; [TcType] -&gt; TcM [TcType]
</span><a href="GHC.Tc.Solver.html#defaultTyVarsAndSimplify"><span class="hs-identifier hs-var hs-var">defaultTyVarsAndSimplify</span></a></span></span><span> </span><span id="local-6989586621683047202"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047202"><span class="hs-identifier hs-var">rhs_tclvl</span></a></span></span><span> </span><span id="local-6989586621683047203"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047203"><span class="hs-identifier hs-var">candidates</span></a></span></span><span>
</span><span id="line-2110"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- Default any kind/levity vars</span><span>
</span><span id="line-2111"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#DV"><span class="hs-identifier hs-type">DV</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#dv_kvs"><span class="hs-identifier hs-var">dv_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047206"><span class="annot"><a href="#local-6989586621683047206"><span class="hs-identifier hs-var">cand_kvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#dv_tvs"><span class="hs-identifier hs-var">dv_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047208"><span class="annot"><a href="#local-6989586621683047208"><span class="hs-identifier hs-var">cand_tvs</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-2112"></span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; TcM CandidatesQTvs
</span><a href="GHC.Tc.Utils.TcMType.html#candidateQTyVarsOfTypes"><span class="hs-identifier hs-var">candidateQTyVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047203"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-2113"></span><span>         </span><span class="hs-comment">-- NB1: decidePromotedTyVars has promoted any type variable fixed by the</span><span>
</span><span id="line-2114"></span><span>         </span><span class="hs-comment">--      type envt, so they won't be chosen by candidateQTyVarsOfTypes</span><span>
</span><span id="line-2115"></span><span>         </span><span class="hs-comment">-- NB2: Defaulting for variables free in tau_tys is done later, by quantifyTyVars</span><span>
</span><span id="line-2116"></span><span>         </span><span class="hs-comment">--      Hence looking only at 'candidates'</span><span>
</span><span id="line-2117"></span><span>         </span><span class="hs-comment">-- NB3: Any covars should already be handled by</span><span>
</span><span id="line-2118"></span><span>         </span><span class="hs-comment">--      the logic in decidePromotedTyVars, which looks at</span><span>
</span><span id="line-2119"></span><span>         </span><span class="hs-comment">--      the constraints generated</span><span>
</span><span id="line-2120"></span><span>
</span><span id="line-2121"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047209"><span class="annot"><a href="#local-6989586621683047209"><span class="hs-identifier hs-var">poly_kinds</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-type">xoptM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LangExt.PolyKinds</span></span><span>
</span><span id="line-2122"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047211"><span class="annot"><a href="#local-6989586621683047211"><span class="hs-identifier hs-var hs-var">default_kv</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047209"><span class="hs-identifier hs-var">poly_kinds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcM Bool
</span><a href="#local-6989586621683047212"><span class="hs-identifier hs-var">default_tv</span></a></span><span>
</span><span id="line-2123"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DefaultingStrategy -&gt; TcTyVar -&gt; TcM Bool
</span><a href="GHC.Tc.Utils.TcMType.html#defaultTyVar"><span class="hs-identifier hs-var">defaultTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultingStrategy
</span><a href="GHC.Types.Basic.html#DefaultKindVars"><span class="hs-identifier hs-var">DefaultKindVars</span></a></span><span>
</span><span id="line-2124"></span><span>             </span><span id="local-6989586621683047212"><span class="annot"><a href="#local-6989586621683047212"><span class="hs-identifier hs-var hs-var">default_tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DefaultingStrategy -&gt; TcTyVar -&gt; TcM Bool
</span><a href="GHC.Tc.Utils.TcMType.html#defaultTyVar"><span class="hs-identifier hs-var">defaultTyVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonStandardDefaultingStrategy -&gt; DefaultingStrategy
</span><a href="GHC.Types.Basic.html#NonStandardDefaulting"><span class="hs-identifier hs-var">NonStandardDefaulting</span></a></span><span> </span><span class="annot"><span class="annottext">NonStandardDefaultingStrategy
</span><a href="GHC.Types.Basic.html#DefaultNonStandardTyVars"><span class="hs-identifier hs-var">DefaultNonStandardTyVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2125"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="annot"><a href="#local-6989586621683047211"><span class="hs-identifier hs-type">default_kv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Set.html#dVarSetElems"><span class="hs-identifier hs-type">dVarSetElems</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047206"><span class="hs-identifier hs-type">cand_kvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2126"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="annot"><a href="#local-6989586621683047212"><span class="hs-identifier hs-type">default_tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Set.html#dVarSetElems"><span class="hs-identifier hs-type">dVarSetElems</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047208"><span class="hs-identifier hs-type">cand_tvs</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#minusDVarSet"><span class="hs-operator hs-type">`minusDVarSet`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047206"><span class="hs-identifier hs-type">cand_kvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2127"></span><span>
</span><span id="line-2128"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621683047219"><span class="hs-identifier hs-type">simplify_cand</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047203"><span class="hs-identifier hs-type">candidates</span></a></span><span>
</span><span id="line-2129"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2130"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2131"></span><span>    </span><span class="hs-comment">-- See Note [Unconditionally resimplify constraints when quantifying]</span><span>
</span><span id="line-2132"></span><span>    </span><span id="local-6989586621683047219"><span class="annot"><span class="annottext">simplify_cand :: [TcType] -&gt; TcM [TcType]
</span><a href="#local-6989586621683047219"><span class="hs-identifier hs-var hs-var">simplify_cand</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; TcM [TcType]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Fast path</span><span>
</span><span id="line-2133"></span><span>    </span><span class="annot"><a href="#local-6989586621683047219"><span class="hs-identifier hs-var">simplify_cand</span></a></span><span> </span><span id="local-6989586621683047220"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047220"><span class="hs-identifier hs-var">candidates</span></a></span></span><span>
</span><span id="line-2134"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047221"><span class="annot"><a href="#local-6989586621683047221"><span class="hs-identifier hs-var">clone_wanteds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; [TcType] -&gt; TcM [CtEvidence]
</span><a href="GHC.Tc.Utils.TcMType.html#newWanteds"><span class="hs-identifier hs-var">newWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#DefaultOrigin"><span class="hs-identifier hs-var">DefaultOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047220"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-2135"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047222"><span class="annot"><a href="#local-6989586621683047222"><span class="hs-identifier hs-var">simples</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#setTcLevel"><span class="hs-identifier hs-type">setTcLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047202"><span class="hs-identifier hs-type">rhs_tclvl</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2136"></span><span>                                           </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyWantedsTcM"><span class="hs-identifier hs-type">simplifyWantedsTcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047221"><span class="hs-identifier hs-type">clone_wanteds</span></a></span><span>
</span><span id="line-2137"></span><span>              </span><span class="hs-comment">-- Discard evidence; simples is fully zonked</span><span>
</span><span id="line-2138"></span><span>
</span><span id="line-2139"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047223"><span class="annot"><a href="#local-6989586621683047223"><span class="hs-identifier hs-var hs-var">new_candidates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; [TcType]
</span><a href="GHC.Tc.Types.Constraint.html#ctsPreds"><span class="hs-identifier hs-var">ctsPreds</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047222"><span class="hs-identifier hs-var">simples</span></a></span><span>
</span><span id="line-2140"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Simplified after defaulting&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2141"></span><span>                      </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Before:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047220"><span class="hs-identifier hs-type">candidates</span></a></span><span>
</span><span id="line-2142"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;After:&quot;</span></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047223"><span class="hs-identifier hs-type">new_candidates</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2143"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683047223"><span class="hs-identifier hs-type">new_candidates</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2144"></span><span>
</span><span id="line-2145"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-2146"></span><span class="annot"><a href="GHC.Tc.Solver.html#decideQuantifiedTyVars"><span class="hs-identifier hs-type">decideQuantifiedTyVars</span></a></span><span>
</span><span id="line-2147"></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a></span><span>
</span><span id="line-2148"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Annotated theta and (name,tau) pairs</span><span>
</span><span id="line-2149"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#TcIdSigInst"><span class="hs-identifier hs-type">TcIdSigInst</span></a></span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Partial signatures</span><span>
</span><span id="line-2150"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Candidates, zonked</span><span>
</span><span id="line-2151"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2152"></span><span class="hs-comment">-- Fix what tyvars we are going to quantify over, and quantify them</span><span>
</span><span id="line-2153"></span><span id="decideQuantifiedTyVars"><span class="annot"><span class="annottext">decideQuantifiedTyVars :: SkolemInfo
-&gt; [(Name, TcType)] -&gt; [TcIdSigInst] -&gt; [TcType] -&gt; TcM [TcTyVar]
</span><a href="GHC.Tc.Solver.html#decideQuantifiedTyVars"><span class="hs-identifier hs-var hs-var">decideQuantifiedTyVars</span></a></span></span><span> </span><span id="local-6989586621683047225"><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621683047225"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span> </span><span id="local-6989586621683047226"><span class="annot"><span class="annottext">[(Name, TcType)]
</span><a href="#local-6989586621683047226"><span class="hs-identifier hs-var">name_taus</span></a></span></span><span> </span><span id="local-6989586621683047227"><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047227"><span class="hs-identifier hs-var">psigs</span></a></span></span><span> </span><span id="local-6989586621683047228"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047228"><span class="hs-identifier hs-var">candidates</span></a></span></span><span>
</span><span id="line-2154"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>     </span><span class="hs-comment">-- Why psig_tys? We try to quantify over everything free in here</span><span>
</span><span id="line-2155"></span><span>             </span><span class="hs-comment">-- See Note [Quantification and partial signatures]</span><span>
</span><span id="line-2156"></span><span>             </span><span class="hs-comment">--     Wrinkles 2 and 3</span><span>
</span><span id="line-2157"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047229"><span class="annot"><a href="#local-6989586621683047229"><span class="hs-identifier hs-var">psig_tv_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047230"><span class="annot"><a href="#local-6989586621683047230"><span class="hs-identifier hs-var">psig_theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047231"><span class="annot"><a href="#local-6989586621683047231"><span class="hs-identifier hs-var">tau_tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM ([TcType], [TcType], [TcType])
-&gt; TcM ([TcType], [TcType], [TcType])
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">TcM.liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM ([TcType], [TcType], [TcType])
 -&gt; TcM ([TcType], [TcType], [TcType]))
-&gt; ZonkM ([TcType], [TcType], [TcType])
-&gt; TcM ([TcType], [TcType], [TcType])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2158"></span><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047232"><span class="annot"><a href="#local-6989586621683047232"><span class="hs-identifier hs-var">psig_tv_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; ZonkM TcType) -&gt; [TcTyVar] -&gt; ZonkM [TcType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; ZonkM TcType
</span><a href="GHC.Tc.Zonk.TcType.html#zonkTcTyVar"><span class="hs-identifier hs-var">TcM.zonkTcTyVar</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047234"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683047235"><span class="annot"><span class="annottext">TcIdSigInst
</span><a href="#local-6989586621683047235"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcIdSigInst]
</span><a href="#local-6989586621683047227"><span class="hs-identifier hs-var">psigs</span></a></span><span>
</span><span id="line-2159"></span><span>                                                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621683047234"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047234"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="annot"><span class="annottext">Specificity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcIdSigInst -&gt; [(Name, InvisTVBinder)]
</span><a href="GHC.Tc.Types.BasicTypes.html#sig_inst_skols"><span class="hs-identifier hs-var">sig_inst_skols</span></a></span><span> </span><span class="annot"><span class="annottext">TcIdSigInst
</span><a href="#local-6989586621683047235"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2160"></span><span>            </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047236"><span class="annot"><a href="#local-6989586621683047236"><span class="hs-identifier hs-var">psig_theta</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkTcType"><span class="hs-identifier hs-type">TcM.zonkTcType</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="#local-6989586621683047237"><span class="hs-identifier hs-type">pred</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683047238"><span class="annot"><a href="#local-6989586621683047238"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683047227"><span class="hs-identifier hs-type">psigs</span></a></span><span>
</span><span id="line-2161"></span><span>                                                        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047237"><span class="annot"><a href="#local-6989586621683047237"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Types.BasicTypes.html#sig_inst_theta"><span class="hs-identifier hs-var">sig_inst_theta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047238"><span class="hs-identifier hs-type">sig</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2162"></span><span>            </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047239"><span class="annot"><a href="#local-6989586621683047239"><span class="hs-identifier hs-var">tau_tys</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkTcType"><span class="hs-identifier hs-type">TcM.zonkTcType</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683047226"><span class="hs-identifier hs-type">name_taus</span></a></span><span>
</span><span id="line-2163"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047232"><span class="hs-identifier hs-type">psig_tv_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047236"><span class="hs-identifier hs-type">psig_theta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047239"><span class="hs-identifier hs-type">tau_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2164"></span><span>
</span><span id="line-2165"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Try to quantify over variables free in these types</span><span>
</span><span id="line-2166"></span><span>             </span><span id="local-6989586621683047240"><span class="annot"><a href="#local-6989586621683047240"><span class="hs-identifier hs-var hs-var">psig_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047229"><span class="hs-identifier hs-var">psig_tv_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; [TcType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047230"><span class="hs-identifier hs-var">psig_theta</span></a></span><span>
</span><span id="line-2167"></span><span>             </span><span id="local-6989586621683047241"><span class="annot"><a href="#local-6989586621683047241"><span class="hs-identifier hs-var hs-var">seed_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047240"><span class="hs-identifier hs-var">psig_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; [TcType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047231"><span class="hs-identifier hs-var">tau_tys</span></a></span><span>
</span><span id="line-2168"></span><span>
</span><span id="line-2169"></span><span>             </span><span class="hs-comment">-- Now &quot;grow&quot; those seeds to find ones reachable via 'candidates'</span><span>
</span><span id="line-2170"></span><span>             </span><span class="hs-comment">-- See Note [growThetaTyVars vs closeWrtFunDeps]</span><span>
</span><span id="line-2171"></span><span>             </span><span id="local-6989586621683047242"><span class="annot"><a href="#local-6989586621683047242"><span class="hs-identifier hs-var hs-var">grown_tcvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Tc.Solver.html#growThetaTyVars"><span class="hs-identifier hs-var">growThetaTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047228"><span class="hs-identifier hs-var">candidates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcType] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047241"><span class="hs-identifier hs-var">seed_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2172"></span><span>
</span><span id="line-2173"></span><span>       </span><span class="hs-comment">-- Now we have to classify them into kind variables and type variables</span><span>
</span><span id="line-2174"></span><span>       </span><span class="hs-comment">-- (sigh) just for the benefit of -XNoPolyKinds; see quantifyTyVars</span><span>
</span><span id="line-2175"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-2176"></span><span>       </span><span class="hs-comment">-- Keep the psig_tys first, so that candidateQTyVarsOfTypes produces</span><span>
</span><span id="line-2177"></span><span>       </span><span class="hs-comment">-- them in that order, so that the final qtvs quantifies in the same</span><span>
</span><span id="line-2178"></span><span>       </span><span class="hs-comment">-- order as the partial signatures do (#13524)</span><span>
</span><span id="line-2179"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047243"><span class="annot"><a href="#local-6989586621683047243"><span class="hs-identifier hs-var">dv</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#DV"><span class="hs-identifier hs-type">DV</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#dv_kvs"><span class="hs-identifier hs-var">dv_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047244"><span class="annot"><a href="#local-6989586621683047244"><span class="hs-identifier hs-var">cand_kvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#dv_tvs"><span class="hs-identifier hs-var">dv_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047245"><span class="annot"><a href="#local-6989586621683047245"><span class="hs-identifier hs-var">cand_tvs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#candidateQTyVarsOfTypes"><span class="hs-identifier hs-type">candidateQTyVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2180"></span><span>                                                         </span><span class="annot"><a href="#local-6989586621683047240"><span class="hs-identifier hs-type">psig_tys</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683047228"><span class="hs-identifier hs-type">candidates</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683047231"><span class="hs-identifier hs-type">tau_tys</span></a></span><span>
</span><span id="line-2181"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047246"><span class="annot"><a href="#local-6989586621683047246"><span class="hs-identifier hs-var hs-var">pick</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DTyVarSet -&gt; VarSet -&gt; DTyVarSet
</span><a href="GHC.Types.Var.Set.html#dVarSetIntersectVarSet"><span class="hs-operator hs-var">`dVarSetIntersectVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047242"><span class="hs-identifier hs-var">grown_tcvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2182"></span><span>             </span><span id="local-6989586621683047248"><span class="annot"><a href="#local-6989586621683047248"><span class="hs-identifier hs-var hs-var">dvs_plus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CandidatesQTvs
</span><a href="#local-6989586621683047243"><span class="hs-identifier hs-var">dv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#dv_kvs"><span class="hs-identifier hs-var">dv_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047246"><span class="hs-identifier hs-type">pick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047244"><span class="hs-identifier hs-type">cand_kvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#dv_tvs"><span class="hs-identifier hs-var">dv_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047246"><span class="hs-identifier hs-type">pick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047245"><span class="hs-identifier hs-type">cand_tvs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2183"></span><span>
</span><span id="line-2184"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;decideQuantifiedTyVars&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span>
</span><span id="line-2185"></span><span>           </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tau_tys =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047231"><span class="hs-identifier hs-type">tau_tys</span></a></span><span>
</span><span id="line-2186"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;candidates =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047228"><span class="hs-identifier hs-type">candidates</span></a></span><span>
</span><span id="line-2187"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;cand_kvs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047244"><span class="hs-identifier hs-type">cand_kvs</span></a></span><span>
</span><span id="line-2188"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;cand_tvs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047245"><span class="hs-identifier hs-type">cand_tvs</span></a></span><span>
</span><span id="line-2189"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tau_tys =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047231"><span class="hs-identifier hs-type">tau_tys</span></a></span><span>
</span><span id="line-2190"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;seed_tys =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047241"><span class="hs-identifier hs-type">seed_tys</span></a></span><span>
</span><span id="line-2191"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;seed_tcvs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-type">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047241"><span class="hs-identifier hs-type">seed_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2192"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;grown_tcvs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047242"><span class="hs-identifier hs-type">grown_tcvs</span></a></span><span>
</span><span id="line-2193"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;dvs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047248"><span class="hs-identifier hs-type">dvs_plus</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2194"></span><span>
</span><span id="line-2195"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#quantifyTyVars"><span class="hs-identifier hs-type">quantifyTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047225"><span class="hs-identifier hs-type">skol_info</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#DefaultNonStandardTyVars"><span class="hs-identifier hs-type">DefaultNonStandardTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047248"><span class="hs-identifier hs-type">dvs_plus</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2196"></span><span>
</span><span id="line-2197"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-2198"></span><span class="hs-comment">-- | When inferring types, should we quantify over a given predicate?</span><span>
</span><span id="line-2199"></span><span class="hs-comment">-- See Note [pickQuantifiablePreds]</span><span>
</span><span id="line-2200"></span><span class="annot"><a href="GHC.Tc.Solver.html#pickQuantifiablePreds"><span class="hs-identifier hs-type">pickQuantifiablePreds</span></a></span><span>
</span><span id="line-2201"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a></span><span>           </span><span class="hs-comment">-- Quantifying over these</span><span>
</span><span id="line-2202"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTyVarSet"><span class="hs-identifier hs-type">TcTyVarSet</span></a></span><span>         </span><span class="hs-comment">-- mono_tvs0: variables mentioned a candidate</span><span>
</span><span id="line-2203"></span><span>                        </span><span class="hs-comment">--   constraint that come from some outer level</span><span>
</span><span id="line-2204"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a></span><span>        </span><span class="hs-comment">-- Proposed constraints to quantify</span><span>
</span><span id="line-2205"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a></span><span>    </span><span class="hs-comment">-- A subset that we can actually quantify</span><span>
</span><span id="line-2206"></span><span class="hs-comment">-- This function decides whether a particular constraint should be</span><span>
</span><span id="line-2207"></span><span class="hs-comment">-- quantified over, given the type variables that are being quantified</span><span>
</span><span id="line-2208"></span><span id="pickQuantifiablePreds"><span class="annot"><span class="annottext">pickQuantifiablePreds :: VarSet -&gt; VarSet -&gt; [TcType] -&gt; TcM [TcType]
</span><a href="GHC.Tc.Solver.html#pickQuantifiablePreds"><span class="hs-identifier hs-var hs-var">pickQuantifiablePreds</span></a></span></span><span> </span><span id="local-6989586621683047250"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047250"><span class="hs-identifier hs-var">qtvs</span></a></span></span><span> </span><span id="local-6989586621683047251"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047251"><span class="hs-identifier hs-var">mono_tvs0</span></a></span></span><span> </span><span id="local-6989586621683047252"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047252"><span class="hs-identifier hs-var">theta</span></a></span></span><span>
</span><span id="line-2209"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047253"><span class="annot"><a href="#local-6989586621683047253"><span class="hs-identifier hs-var">tc_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM TcLevel
</span><a href="GHC.Tc.Utils.Monad.html#getTcLevel"><span class="hs-identifier hs-var">TcM.getTcLevel</span></a></span><span>
</span><span id="line-2210"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047254"><span class="annot"><a href="#local-6989586621683047254"><span class="hs-identifier hs-var hs-var">is_nested</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcLevel -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isTopTcLevel"><span class="hs-identifier hs-var">isTopTcLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047253"><span class="hs-identifier hs-var">tc_lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2211"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#mkMinimalBySCs"><span class="hs-identifier hs-type">mkMinimalBySCs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">id</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>  </span><span class="hs-comment">-- See Note [Minimize by Superclasses]</span><span>
</span><span id="line-2212"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047256"><span class="hs-identifier hs-type">pick_me</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047254"><span class="hs-identifier hs-type">is_nested</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683047252"><span class="hs-identifier hs-type">theta</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2213"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2214"></span><span>    </span><span id="local-6989586621683047256"><span class="annot"><span class="annottext">pick_me :: Bool -&gt; TcType -&gt; Maybe TcType
</span><a href="#local-6989586621683047256"><span class="hs-identifier hs-var hs-var">pick_me</span></a></span></span><span> </span><span id="local-6989586621683047257"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047257"><span class="hs-identifier hs-var">is_nested</span></a></span></span><span> </span><span id="local-6989586621683047258"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047258"><span class="hs-identifier hs-var">pred</span></a></span></span><span>
</span><span id="line-2215"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047259"><span class="annot"><span class="annottext">pred_tvs :: VarSet
</span><a href="#local-6989586621683047259"><span class="hs-identifier hs-var hs-var">pred_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047258"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2216"></span><span>            </span><span id="local-6989586621683047261"><span class="annot"><span class="annottext">mentions_qtvs :: Bool
</span><a href="#local-6989586621683047261"><span class="hs-identifier hs-var hs-var">mentions_qtvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047259"><span class="hs-identifier hs-var">pred_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-var">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047250"><span class="hs-identifier hs-var">qtvs</span></a></span><span>
</span><span id="line-2217"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047258"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2218"></span><span>
</span><span id="line-2219"></span><span>          </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621683047262"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047262"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683047263"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047263"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-2220"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [TcType] -&gt; Maybe FastString
</span><a href="GHC.Core.Predicate.html#isCallStackPred"><span class="hs-identifier hs-var">isCallStackPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047262"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047263"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2221"></span><span>              </span><span class="hs-comment">-- NEVER infer a CallStack constraint.  Otherwise we let</span><span>
</span><span id="line-2222"></span><span>              </span><span class="hs-comment">-- the constraints bubble up to be solved from the outer</span><span>
</span><span id="line-2223"></span><span>              </span><span class="hs-comment">-- context, or be defaulted when we reach the top-level.</span><span>
</span><span id="line-2224"></span><span>              </span><span class="hs-comment">-- See Note [Overview of implicit CallStacks] in GHC.Tc.Types.Evidence</span><span>
</span><span id="line-2225"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TcType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2226"></span><span>
</span><span id="line-2227"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isIPClass"><span class="hs-identifier hs-var">isIPClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047262"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-2228"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047258"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-comment">-- See Note [Inheriting implicit parameters]</span><span>
</span><span id="line-2229"></span><span>
</span><span id="line-2230"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047261"><span class="hs-identifier hs-var">mentions_qtvs</span></a></span><span>
</span><span id="line-2231"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TcType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-comment">-- Don't quantify over predicates that don't</span><span>
</span><span id="line-2232"></span><span>                         </span><span class="hs-comment">-- mention any of the quantified type variables</span><span>
</span><span id="line-2233"></span><span>
</span><span id="line-2234"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047257"><span class="hs-identifier hs-var">is_nested</span></a></span><span>
</span><span id="line-2235"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047258"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2236"></span><span>
</span><span id="line-2237"></span><span>            </span><span class="hs-comment">-- From here on, we are thinking about top-level defns only</span><span>
</span><span id="line-2238"></span><span>
</span><span id="line-2239"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047259"><span class="hs-identifier hs-var">pred_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#subVarSet"><span class="hs-operator hs-var">`subVarSet`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047250"><span class="hs-identifier hs-var">qtvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047251"><span class="hs-identifier hs-var">mono_tvs0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2240"></span><span>              </span><span class="hs-comment">-- See Note [Do not quantify over constraints that determine a variable]</span><span>
</span><span id="line-2241"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047258"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2242"></span><span>
</span><span id="line-2243"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2244"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TcType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2245"></span><span>
</span><span id="line-2246"></span><span>          </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span id="local-6989586621683047266"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683047266"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621683047267"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047267"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683047268"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047268"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-2247"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047261"><span class="hs-identifier hs-var">mentions_qtvs</span></a></span><span>
</span><span id="line-2248"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; TcType -&gt; TcType -&gt; Bool
</span><a href="#local-6989586621683047269"><span class="hs-identifier hs-var">quantify_equality</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683047266"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047267"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047268"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2249"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047270"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047270"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047271"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047271"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; TcType -&gt; TcType -&gt; Maybe (Class, [TcType])
</span><a href="GHC.Tc.Utils.TcType.html#boxEqPred"><span class="hs-identifier hs-var">boxEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621683047266"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047267"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047268"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2250"></span><span>              </span><span class="hs-comment">-- boxEqPred: See Note [Lift equality constraints when quantifying]</span><span>
</span><span id="line-2251"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [TcType] -&gt; TcType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047270"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047271"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2252"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2253"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TcType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2254"></span><span>
</span><span id="line-2255"></span><span>          </span><span class="annot"><a href="GHC.Core.Predicate.html#IrredPred"><span class="hs-identifier hs-type">IrredPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047261"><span class="hs-identifier hs-var">mentions_qtvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047258"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2256"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TcType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2257"></span><span>
</span><span id="line-2258"></span><span>          </span><span class="annot"><a href="GHC.Core.Predicate.html#ForAllPred"><span class="hs-identifier hs-type">ForAllPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TcType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2259"></span><span>
</span><span id="line-2260"></span><span>    </span><span class="hs-comment">-- See Note [Quantifying over equality constraints]</span><span>
</span><span id="line-2261"></span><span>    </span><span id="local-6989586621683047269"><span class="annot"><span class="annottext">quantify_equality :: EqRel -&gt; TcType -&gt; TcType -&gt; Bool
</span><a href="#local-6989586621683047269"><span class="hs-identifier hs-var hs-var">quantify_equality</span></a></span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span>  </span><span id="local-6989586621683047274"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047274"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683047275"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047275"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683047276"><span class="hs-identifier hs-var">quant_fun</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047274"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683047276"><span class="hs-identifier hs-var">quant_fun</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047275"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2262"></span><span>    </span><span class="annot"><a href="#local-6989586621683047269"><span class="hs-identifier hs-var">quantify_equality</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2263"></span><span>
</span><span id="line-2264"></span><span>    </span><span id="local-6989586621683047276"><span class="annot"><span class="annottext">quant_fun :: TcType -&gt; Bool
</span><a href="#local-6989586621683047276"><span class="hs-identifier hs-var hs-var">quant_fun</span></a></span></span><span> </span><span id="local-6989586621683047279"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047279"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2265"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; Maybe (TyCon, [TcType])
TcType -&gt; Maybe (TyCon, [TcType])
</span><a href="GHC.Core.Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047279"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2266"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047281"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683047281"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047282"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047282"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683047281"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2267"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047282"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-var">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047250"><span class="hs-identifier hs-var">qtvs</span></a></span><span>
</span><span id="line-2268"></span><span>          </span><span class="annot"><span class="annottext">Maybe (TyCon, [TcType])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2269"></span><span>
</span><span id="line-2270"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-2271"></span><span class="annot"><a href="GHC.Tc.Solver.html#growThetaTyVars"><span class="hs-identifier hs-type">growThetaTyVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a></span><span>
</span><span id="line-2272"></span><span class="hs-comment">-- See Note [growThetaTyVars vs closeWrtFunDeps]</span><span>
</span><span id="line-2273"></span><span id="growThetaTyVars"><span class="annot"><span class="annottext">growThetaTyVars :: [TcType] -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Tc.Solver.html#growThetaTyVars"><span class="hs-identifier hs-var hs-var">growThetaTyVars</span></a></span></span><span> </span><span id="local-6989586621683047284"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047284"><span class="hs-identifier hs-var">theta</span></a></span></span><span> </span><span id="local-6989586621683047285"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047285"><span class="hs-identifier hs-var">tcvs</span></a></span></span><span>
</span><span id="line-2274"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047284"><span class="hs-identifier hs-var">theta</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047285"><span class="hs-identifier hs-var">tcvs</span></a></span><span>
</span><span id="line-2275"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarSet) -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#transCloVarSet"><span class="hs-identifier hs-var">transCloVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet
</span><a href="#local-6989586621683047287"><span class="hs-identifier hs-var">mk_next</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047288"><span class="hs-identifier hs-var">seed_tcvs</span></a></span><span>
</span><span id="line-2276"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2277"></span><span>    </span><span id="local-6989586621683047288"><span class="annot"><span class="annottext">seed_tcvs :: VarSet
</span><a href="#local-6989586621683047288"><span class="hs-identifier hs-var hs-var">seed_tcvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047285"><span class="hs-identifier hs-var">tcvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047289"><span class="hs-identifier hs-var">ips</span></a></span><span>
</span><span id="line-2278"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683047289"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047289"><span class="hs-identifier hs-var">ips</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047290"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047290"><span class="hs-identifier hs-var">non_ips</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; Bool) -&gt; [TcType] -&gt; ([TcType], [TcType])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">partition</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isIPLikePred"><span class="hs-identifier hs-var">isIPLikePred</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047284"><span class="hs-identifier hs-var">theta</span></a></span><span>
</span><span id="line-2279"></span><span>                         </span><span class="hs-comment">-- See Note [Inheriting implicit parameters]</span><span>
</span><span id="line-2280"></span><span>
</span><span id="line-2281"></span><span>    </span><span class="annot"><a href="#local-6989586621683047287"><span class="hs-identifier hs-type">mk_next</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-comment">-- Maps current set to newly-grown ones</span><span>
</span><span id="line-2282"></span><span>    </span><span id="local-6989586621683047287"><span class="annot"><span class="annottext">mk_next :: VarSet -&gt; VarSet
</span><a href="#local-6989586621683047287"><span class="hs-identifier hs-var hs-var">mk_next</span></a></span></span><span> </span><span id="local-6989586621683047291"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047291"><span class="hs-identifier hs-var">so_far</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; VarSet -&gt; VarSet) -&gt; VarSet -&gt; [TcType] -&gt; VarSet
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; TcType -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621683047293"><span class="hs-identifier hs-var">grow_one</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047291"><span class="hs-identifier hs-var">so_far</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047290"><span class="hs-identifier hs-var">non_ips</span></a></span><span>
</span><span id="line-2283"></span><span>    </span><span id="local-6989586621683047293"><span class="annot"><span class="annottext">grow_one :: VarSet -&gt; TcType -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621683047293"><span class="hs-identifier hs-var hs-var">grow_one</span></a></span></span><span> </span><span id="local-6989586621683047294"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047294"><span class="hs-identifier hs-var">so_far</span></a></span></span><span> </span><span id="local-6989586621683047295"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047295"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span id="local-6989586621683047296"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047296"><span class="hs-identifier hs-var">tcvs</span></a></span></span><span>
</span><span id="line-2284"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047297"><span class="hs-identifier hs-var">pred_tcvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-var">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047294"><span class="hs-identifier hs-var">so_far</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047296"><span class="hs-identifier hs-var">tcvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047297"><span class="hs-identifier hs-var">pred_tcvs</span></a></span><span>
</span><span id="line-2285"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047296"><span class="hs-identifier hs-var">tcvs</span></a></span><span>
</span><span id="line-2286"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-2287"></span><span>         </span><span id="local-6989586621683047297"><span class="annot"><span class="annottext">pred_tcvs :: VarSet
</span><a href="#local-6989586621683047297"><span class="hs-identifier hs-var hs-var">pred_tcvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047295"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2288"></span><span>
</span><span id="line-2289"></span><span>
</span><span id="line-2290"></span><span class="hs-comment">{- Note [Promote monomorphic tyvars]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Promote any type variables that are free in the environment.  Eg
   f :: forall qtvs. bound_theta =&gt; zonked_tau
The free vars of f's type become free in the envt, and hence will show
up whenever 'f' is called.  They may currently at rhs_tclvl, but they
had better be unifiable at the outer_tclvl!  Example: envt mentions
alpha[1]
           tau_ty = beta[2] -&gt; beta[2]
           constraints = alpha ~ [beta]
we don't quantify over beta (since it is fixed by envt)
so we must promote it!  The inferred type is just
  f :: beta -&gt; beta

NB: promoteTyVarSet ignores coercion variables

Note [pickQuantifiablePreds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When pickQuantifiablePreds is called we have decided what type
variables to quantify over, `qtvs`. The only quesion is: which of the
unsolved candidate predicates should we quantify over?  Call them
`picked_theta`.

Note that will leave behind a residual implication
     forall qtvs. picked_theta =&gt; unsolved_constraints
For the members of unsolved_constraints that we select for picked_theta
it is easy to solve, by identity.  For the others we just hope that
we can solve them.

So which of the candidates should we pick to quantify over?  In some
situations we distinguish top-level from nested bindings.  The point
about nested binding is that
 (a) the types may mention type variables free in the environment
 (b) all of the call sites are statically visible, reducing the
     worries about &quot;spooky action at a distance&quot;.

First, never pick a constraint that doesn't mention any of the quantified
variables `qtvs`.  Picking such a constraint essentially moves the solving of
the constraint from this function definition to call sites.  But because the
constraint mentions no quantified variables, call sites have no advantage
over the definition site. Well, not quite: there could be new constraints
brought into scope by a pattern-match against a constrained (e.g. GADT)
constructor.  Example

      data T a where { T1 :: T1 Bool; ... }

      f :: forall a. a -&gt; T a -&gt; blah
      f x t = let g y = x&amp;&amp;y    -- This needs a~Bool
            in case t of
                  T1 -&gt; g True
                  ....

At g's call site we have `a~Bool`, so we /could/ infer
     g :: forall . (a~Bool) =&gt; Bool -&gt; Bool  -- qtvs = {}

This is all very contrived, and probably just postponse type errors to
the call site.  If that's what you want, write a type signature.

Actually, implicit parameters is an exception to the &quot;no quantified vars&quot;
rule (see Note [Inheriting implicit parameters]) so we can't actually
simply test this case first.

Now we consider the different sorts of constraints:

* For ClassPred constraints:

  * Never pick a CallStack constraint.
    See Note [Overview of implicit CallStacks]

  * Always pick an implicit-parameter constraint.
    Note [Inheriting implicit parameters]

  * For /top-level/ class constraints see
    Note [Do not quantify over constraints that determine a variable]

* For EqPred constraints see Note [Quantifying over equality constraints]

* For IrredPred constraints, we allow anything that mentions the quantified
  type variables.

* A ForAllPred should not appear: the candidates come from approximateWC.

Notice that we do /not/ consult -XFlexibleContexts here.  For example,
we allow `pickQuantifiablePreds` to quantify over a constraint like
`Num [a]`; then if we don't have `-XFlexibleContexts` we'll get an
error from `checkValidType` but (critically) it includes the helpful
suggestion of adding `-XFlexibleContexts`.  See #10608, #10351.

Note [Lift equality constraints when quantifying]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We can't quantify over a constraint (t1 ~# t2) because that isn't a
predicate type; see Note [Types for coercions, predicates, and evidence]
in GHC.Core.TyCo.Rep.

So we have to 'lift' it to (t1 ~ t2).  Similarly (~R#) must be lifted
to Coercible.

This tiresome lifting is the reason that pick_me (in
pickQuantifiablePreds) returns a Maybe rather than a Bool.

Note [Inheriting implicit parameters]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this:

        f x = (x::Int) + ?y

where f is *not* a top-level binding.
From the RHS of f we'll get the constraint (?y::Int).
There are two types we might infer for f:

        f :: Int -&gt; Int

(so we get ?y from the context of f's definition), or

        f :: (?y::Int) =&gt; Int -&gt; Int

At first you might think the first was better, because then
?y behaves like a free variable of the definition, rather than
having to be passed at each call site.  But of course, the WHOLE
IDEA is that ?y should be passed at each call site (that's what
dynamic binding means) so we'd better infer the second.

BOTTOM LINE: when *inferring types* you must quantify over implicit
parameters, *even if* they don't mention the bound type variables.
Reason: because implicit parameters, uniquely, have local instance
declarations. See pickQuantifiablePreds.

Note [Quantifying over equality constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Should we quantify over an equality constraint (s ~ t)
in pickQuantifiablePreds?

* It is always /sound/ to quantify over a constraint -- those
  quantified constraints will need to be proved at each call site.

* We definitely don't want to quantify over (Maybe a ~ Bool), to get
     f :: forall a. (Maybe a ~ Bool) =&gt; blah
  That simply postpones a type error from the function definition site to
  its call site.  Fortunately we have already filtered out insoluble
  constraints: see `definite_error` in `simplifyInfer`.

* What about (a ~ T alpha b), where we are about to quantify alpha, `a` and
  `b` are in-scope skolems, and `T` is a data type.  It's pretty unlikely
  that this will be soluble at a call site, so we don't quantify over it.

* What about `(F beta ~ Int)` where we are going to quantify `beta`?
  Should we quantify over the (F beta ~ Int), to get
     f :: forall b. (F b ~ Int) =&gt; blah
  Aha!  Perhaps yes, because at the call site we will instantiate `b`, and
  perhaps we have `instance F Bool = Int`. So we *do* quantify over a
  type-family equality where the arguments mention the quantified variables.

This is all a bit ad-hoc.

Note [Do not quantify over constraints that determine a variable]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (typecheck/should_compile/tc231), where we're trying to infer
the type of a top-level declaration. We have
  class Zork s a b | a -&gt; b
and the candidate constraint at the end of simplifyInfer is
  [W] Zork alpha[1] (Z [Char]) beta[1]
We definitely want to quantify over `alpha` (which is mentioned in the
tau-type).

But we do *not* want to quantify over `beta`: it is determined by the
functional dependency on Zork: note that the second argument to Zork
in the Wanted is a variable-free `Z [Char]`.  Quantifying over it
would be &quot;Henry Ford polymorphism&quot;.  (Presumably we don't have an
instance in scope that tells us what `beta` actually is.)  Instead
we promote `beta[1]` to `beta[0]`, in `decidePromotedTyVars`.

The question here: do we want to quantify over the constraint, to
give the type
   forall a. Zork a (Z [Char]) beta[0] =&gt; blah
Definitely not.  Since we're not quantifying over beta, it has been
promoted; and then will be zapped to Any in the final zonk.  So we end
up with a (perhaps exported) type involving
  forall a. Zork a (Z [Char]) Any =&gt; blah
No no no:

  Key principle: we never want to show the programmer
                 a type with `Any` in it.

What we really want (to catch the Zork example) is this:

   Quantify over the constraint only if all its free variables are
   (a) quantified, or
   (b) appears in the type of something in the environment (mono_tvs0).

To understand (b) consider

  class C a b where { op :: a -&gt; b -&gt; () }

  mr = 3                      -- mr :: alpha
  f1 x = op x mr              -- f1 :: forall b. b -&gt; (), plus [W] C b alpha
  intify = mr + (4 :: Int)

In `f1` should we quantify over that `(C b alpha)`?  Answer: since `alpha`
is free in the type envt, yes we should.  After all, if we'd typechecked
`intify` first, we'd have set `alpha := Int`, and /then/ we'd certainly
quantify.  The delicate Zork situation applies when beta is completely
unconstrained (not free in the environment) -- except by the fundep.

Another way to put it: let's say `alpha` is in `mono_tvs0`. It must be that
some variable `x` has `alpha` free in its type. If we are at top-level (and we
are, because nested decls don't go through this path all), then `x` must also
be at top-level. And, by induction, `x` will not have Any in its type when all
is said and done. The induction is well-founded because, if `x` is mutually
recursive with the definition at hand, then their constraints get processed
together (or `x` has a type signature, in which case the type doesn't have
`Any`). So the key thing is that we must not introduce a new top-level
unconstrained variable here.

However this regrettably-subtle reasoning is needed only for /top-level/
declarations.  For /nested/ decls we can see all the calls, so we'll
instantiate that quantifed `Zork a (Z [Char]) beta` constraint at call sites,
and either solve it or not (probably not).  We won't be left with a
still-callable function with Any in its type.  So for nested definitions we
don't make this tricky test.

Historical note: we had a different, and more complicated test
before, but it was utterly wrong: #23199.

Note [Quantification and partial signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When choosing type variables to quantify, the basic plan is to
quantify over all type variables that are
 * free in the tau_tvs, and
 * not forced to be monomorphic (mono_tvs),
   for example by being free in the environment.

However, in the case of a partial type signature, we are doing inference
*in the presence of a type signature*. For example:
   f :: _ -&gt; a
   f x = ...
or
   g :: (Eq _a) =&gt; _b -&gt; _b
In both cases we use plan InferGen, and hence call simplifyInfer.  But
those 'a' variables are skolems (actually TyVarTvs), and we should be
sure to quantify over them.  This leads to several wrinkles:

* Wrinkle 1.  In the case of a type error
     f :: _ -&gt; Maybe a
     f x = True &amp;&amp; x
  The inferred type of 'f' is f :: Bool -&gt; Bool, but there's a
  left-over error of form (Maybe a ~ Bool).  The error-reporting
  machine expects to find a binding site for the skolem 'a', so we
  add it to the quantified tyvars.

* Wrinkle 2.  Consider the partial type signature
     f :: (Eq _) =&gt; Int -&gt; Int
     f x = x
  In normal cases that makes sense; e.g.
     g :: Eq _a =&gt; _a -&gt; _a
     g x = x
  where the signature makes the type less general than it could
  be. But for 'f' we must therefore quantify over the user-annotated
  constraints, to get
     f :: forall a. Eq a =&gt; Int -&gt; Int
  (thereby correctly triggering an ambiguity error later).  If we don't
  we'll end up with a strange open type
     f :: Eq alpha =&gt; Int -&gt; Int
  which isn't ambiguous but is still very wrong.

  Bottom line: Try to quantify over any variable free in psig_theta,
  just like the tau-part of the type.

* Wrinkle 3 (#13482). Also consider
    f :: forall a. _ =&gt; Int -&gt; Int
    f x = if (undefined :: a) == undefined then x else 0
  Here we get an (Eq a) constraint, but it's not mentioned in the
  psig_theta nor the type of 'f'.  But we still want to quantify
  over 'a' even if the monomorphism restriction is on.

* Wrinkle 4 (#14479)
    foo :: Num a =&gt; a -&gt; a
    foo xxx = g xxx
      where
        g :: forall b. Num b =&gt; _ -&gt; b
        g y = xxx + y

  In the signature for 'g', we cannot quantify over 'b' because it turns out to
  get unified with 'a', which is free in g's environment.  So we carefully
  refrain from bogusly quantifying, in GHC.Tc.Solver.decidePromotedTyVars.  We
  report the error later, in GHC.Tc.Gen.Bind.chooseInferredQuantifiers.

Note [growThetaTyVars vs closeWrtFunDeps]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
GHC has two functions, growThetaTyVars and closeWrtFunDeps, both with
the same type and similar behavior. This Note outlines the differences
and why we use one or the other.

Both functions take a list of constraints. We will call these the
*candidates*.

closeWrtFunDeps takes a set of &quot;determined&quot; type variables and finds the
closure of that set with respect to the functional dependencies
within the class constraints in the set of candidates. So, if we
have

  class C a b | a -&gt; b
  class D a b   -- no fundep
  candidates = {C (Maybe a) (Either b c), D (Maybe a) (Either d e)}

then closeWrtFunDeps {a} will return the set {a,b,c}.
This is because, if `a` is determined, then `b` and `c` are, too,
by functional dependency. closeWrtFunDeps called with any seed set not including
`a` will just return its argument, as only `a` determines any other
type variable (in this example).

growThetaTyVars operates similarly, but it behaves as if every
constraint has a functional dependency among all its arguments.
So, continuing our example, growThetaTyVars {a} will return
{a,b,c,d,e}. Put another way, growThetaTyVars grows the set of
variables to include all variables that are mentioned in the same
constraint (transitively).

We use closeWrtFunDeps in places where we need to know which variables are
*always* determined by some seed set. This includes
  * when determining the mono-tyvars in decidePromotedTyVars. If `a`
    is going to be monomorphic, we need b and c to be also: they
    are determined by the choice for `a`.
  * when checking instance coverage, in
    GHC.Tc.Instance.FunDeps.checkInstCoverage

On the other hand, we use growThetaTyVars where we need to know
which variables *might* be determined by some seed set. This includes
  * deciding quantification (GHC.Tc.Gen.Bind.chooseInferredQuantifiers
    and decideQuantifiedTyVars
How can `a` determine (say) `d` in the example above without a fundep?
Suppose we have
  instance (b ~ a, c ~ a) =&gt; D (Maybe [a]) (Either b c)
Now, if `a` turns out to be a list, it really does determine b and c.
The danger in overdoing quantification is the creation of an ambiguous
type signature, but this is conveniently caught in the validity checker.

Note [Quantification with errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we find that the RHS of the definition has some absolutely-insoluble
constraints (including especially &quot;variable not in scope&quot;), we

* Abandon all attempts to find a context to quantify over,
  and instead make the function fully-polymorphic in whatever
  type we have found

* Return a flag from simplifyInfer, indicating that we found an
  insoluble constraint.  This flag is used to suppress the ambiguity
  check for the inferred type, which may well be bogus, and which
  tends to obscure the real error.  This fix feels a bit clunky,
  but I failed to come up with anything better.

Reasons:
    - Avoid downstream errors
    - Do not perform an ambiguity test on a bogus type, which might well
      fail spuriously, thereby obfuscating the original insoluble error.
      #14000 is an example

I tried an alternative approach: simply failM, after emitting the
residual implication constraint; the exception will be caught in
GHC.Tc.Gen.Bind.tcPolyBinds, which gives all the binders in the group the type
(forall a. a).  But that didn't work with -fdefer-type-errors, because
the recovery from failM emits no code at all, so there is no function
to run!   But -fdefer-type-errors aspires to produce a runnable program.

Note [Default while Inferring]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Our current plan is that defaulting only happens at simplifyTop and
not simplifyInfer.  This may lead to some insoluble deferred constraints.
Example:

instance D g =&gt; C g Int b

constraint inferred = (forall b. 0 =&gt; C gamma alpha b) /\ Num alpha
type inferred       = gamma -&gt; gamma

Now, if we try to default (alpha := Int) we will be able to refine the implication to
  (forall b. 0 =&gt; C gamma Int b)
which can then be simplified further to
  (forall b. 0 =&gt; D gamma)
Finally, we /can/ approximate this implication with (D gamma) and infer the quantified
type:  forall g. D g =&gt; g -&gt; g

Instead what will currently happen is that we will get a quantified type
(forall g. g -&gt; g) and an implication:
       forall g. 0 =&gt; (forall b. 0 =&gt; C g alpha b) /\ Num alpha

Which, even if the simplifyTop defaults (alpha := Int) we will still be left with an
unsolvable implication:
       forall g. 0 =&gt; (forall b. 0 =&gt; D g)

The concrete example would be:
       h :: C g a s =&gt; g -&gt; a -&gt; ST s a
       f (x::gamma) = (\_ -&gt; x) (runST (h x (undefined::alpha)) + 1)

But it is quite tedious to do defaulting and resolve the implication constraints, and
we have not observed code breaking because of the lack of defaulting in inference, so
we don't do it for now.



Note [Minimize by Superclasses]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we quantify over a constraint, in simplifyInfer we need to
quantify over a constraint that is minimal in some sense: For
instance, if the final wanted constraint is (Eq alpha, Ord alpha),
we'd like to quantify over Ord alpha, because we can just get Eq alpha
from superclass selection from Ord alpha. This minimization is what
mkMinimalBySCs does. Then, simplifyInfer uses the minimal constraint
to check the original wanted.


Note [Avoid unnecessary constraint simplification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    -------- NB NB NB (Jun 12) -------------
    This note not longer applies; see the notes with #4361.
    But I'm leaving it in here so we remember the issue.)
    ----------------------------------------
When inferring the type of a let-binding, with simplifyInfer,
try to avoid unnecessarily simplifying class constraints.
Doing so aids sharing, but it also helps with delicate
situations like

   instance C t =&gt; C [t] where ..

   f :: C [t] =&gt; ....
   f x = let g y = ...(constraint C [t])...
         in ...
When inferring a type for 'g', we don't want to apply the
instance decl, because then we can't satisfy (C t).  So we
just notice that g isn't quantified over 't' and partition
the constraints before simplifying.

This only half-works, but then let-generalisation only half-works.

*********************************************************************************
*                                                                                 *
*                                 Main Simplifier                                 *
*                                                                                 *
***********************************************************************************

-}</span><span>
</span><span id="line-2731"></span><span>
</span><span id="line-2732"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyWantedsTcM"><span class="hs-identifier hs-type">simplifyWantedsTcM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-2733"></span><span class="hs-comment">-- Solve the specified Wanted constraints</span><span>
</span><span id="line-2734"></span><span class="hs-comment">-- Discard the evidence binds</span><span>
</span><span id="line-2735"></span><span class="hs-comment">-- Postcondition: fully zonked</span><span>
</span><span id="line-2736"></span><span id="simplifyWantedsTcM"><span class="annot"><span class="annottext">simplifyWantedsTcM :: [CtEvidence] -&gt; IOEnv (Env TcGblEnv TcLclEnv) WantedConstraints
</span><a href="GHC.Tc.Solver.html#simplifyWantedsTcM"><span class="hs-identifier hs-var hs-var">simplifyWantedsTcM</span></a></span></span><span> </span><span id="local-6989586621683047298"><span class="annot"><span class="annottext">[CtEvidence]
</span><a href="#local-6989586621683047298"><span class="hs-identifier hs-var">wanted</span></a></span></span><span>
</span><span id="line-2737"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplifyWantedsTcM {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CtEvidence] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CtEvidence]
</span><a href="#local-6989586621683047298"><span class="hs-identifier hs-var">wanted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2738"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047299"><span class="annot"><a href="#local-6989586621683047299"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS WantedConstraints -&gt; TcM (WantedConstraints, EvBindMap)
forall a. TcS a -&gt; TcM (a, EvBindMap)
</span><a href="GHC.Tc.Solver.Monad.html#runTcS"><span class="hs-identifier hs-var">runTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CtEvidence] -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#mkSimpleWC"><span class="hs-identifier hs-var">mkSimpleWC</span></a></span><span> </span><span class="annot"><span class="annottext">[CtEvidence]
</span><a href="#local-6989586621683047298"><span class="hs-identifier hs-var">wanted</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2739"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047300"><span class="annot"><a href="#local-6989586621683047300"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-type">TcM.liftZonkM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#zonkWC"><span class="hs-identifier hs-type">TcM.zonkWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047299"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-2740"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;simplifyWantedsTcM }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047300"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2741"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683047300"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2742"></span><span>
</span><span id="line-2743"></span><span class="annot"><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-type">solveWanteds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-2744"></span><span id="solveWanteds"><span class="annot"><span class="annottext">solveWanteds :: WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-var hs-var">solveWanteds</span></a></span></span><span> </span><span id="local-6989586621683047301"><span class="annot"><span class="annottext">wc :: WantedConstraints
</span><a href="#local-6989586621683047301"><span class="hs-identifier hs-var">wc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_errors :: WantedConstraints -&gt; Bag DelayedError
</span><a href="GHC.Tc.Types.Constraint.html#wc_errors"><span class="hs-identifier hs-var">wc_errors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047302"><span class="annot"><span class="annottext">Bag DelayedError
</span><a href="#local-6989586621683047302"><span class="hs-identifier hs-var">errs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2745"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047301"><span class="hs-identifier hs-var">wc</span></a></span><span>  </span><span class="hs-comment">-- Fast path</span><span>
</span><span id="line-2746"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047301"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-2747"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2748"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047303"><span class="annot"><a href="#local-6989586621683047303"><span class="hs-identifier hs-var">cur_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS TcLevel
</span><a href="GHC.Tc.Solver.Monad.html#getTcLevel"><span class="hs-identifier hs-var">TcS.getTcLevel</span></a></span><span>
</span><span id="line-2749"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;solveWanteds {&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2750"></span><span>         </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Level =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047303"><span class="hs-identifier hs-type">cur_lvl</span></a></span><span>
</span><span id="line-2751"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047301"><span class="hs-identifier hs-type">wc</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2752"></span><span>
</span><span id="line-2753"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047305"><span class="annot"><a href="#local-6989586621683047305"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-type">getDynFlags</span></a></span><span>
</span><span id="line-2754"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047306"><span class="annot"><a href="#local-6989586621683047306"><span class="hs-identifier hs-var">solved_wc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplify_loop"><span class="hs-identifier hs-type">simplify_loop</span></a></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.DynFlags.html#solverIterations"><span class="hs-identifier hs-var">solverIterations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047305"><span class="hs-identifier hs-type">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="annot"><a href="#local-6989586621683047301"><span class="hs-identifier hs-type">wc</span></a></span><span>
</span><span id="line-2755"></span><span>
</span><span id="line-2756"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047309"><span class="annot"><a href="#local-6989586621683047309"><span class="hs-identifier hs-var">errs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyDelayedErrors"><span class="hs-identifier hs-type">simplifyDelayedErrors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047302"><span class="hs-identifier hs-type">errs</span></a></span><span>
</span><span id="line-2757"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047311"><span class="annot"><a href="#local-6989586621683047311"><span class="hs-identifier hs-var hs-var">final_wc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047306"><span class="hs-identifier hs-var">solved_wc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_errors"><span class="hs-identifier hs-var">wc_errors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047309"><span class="hs-identifier hs-type">errs'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2758"></span><span>
</span><span id="line-2759"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047312"><span class="annot"><a href="#local-6989586621683047312"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsVar"><span class="hs-identifier hs-type">getTcEvBindsVar</span></a></span><span>
</span><span id="line-2760"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047314"><span class="annot"><a href="#local-6989586621683047314"><span class="hs-identifier hs-var">bb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsMap"><span class="hs-identifier hs-type">TcS.getTcEvBindsMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047312"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span>
</span><span id="line-2761"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;solveWanteds }&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2762"></span><span>                 </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;final wc =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047311"><span class="hs-identifier hs-type">final_wc</span></a></span><span>
</span><span id="line-2763"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;current evbinds  =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#evBindMapBinds"><span class="hs-identifier hs-type">evBindMapBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047314"><span class="hs-identifier hs-type">bb</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2764"></span><span>
</span><span id="line-2765"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683047311"><span class="hs-identifier hs-type">final_wc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2766"></span><span>
</span><span id="line-2767"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplify_loop"><span class="hs-identifier hs-type">simplify_loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2768"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-2769"></span><span class="hs-comment">-- Do a round of solving, and call maybe_simplify_again to iterate</span><span>
</span><span id="line-2770"></span><span class="hs-comment">-- The 'definitely_redo_implications' flags is False if the only reason we</span><span>
</span><span id="line-2771"></span><span class="hs-comment">-- are iterating is that we have added some new Wanted superclasses</span><span>
</span><span id="line-2772"></span><span class="hs-comment">-- hoping for fundeps to help us; see Note [Superclass iteration]</span><span>
</span><span id="line-2773"></span><span class="hs-comment">--</span><span>
</span><span id="line-2774"></span><span class="hs-comment">-- Does not affect wc_holes at all; reason: wc_holes never affects anything</span><span>
</span><span id="line-2775"></span><span class="hs-comment">-- else, so we do them once, at the end in solveWanteds</span><span>
</span><span id="line-2776"></span><span id="simplify_loop"><span class="annot"><span class="annottext">simplify_loop :: Int
-&gt; IntWithInf -&gt; Bool -&gt; WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#simplify_loop"><span class="hs-identifier hs-var hs-var">simplify_loop</span></a></span></span><span> </span><span id="local-6989586621683047316"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683047316"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683047317"><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621683047317"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621683047318"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047318"><span class="hs-identifier hs-var">definitely_redo_implications</span></a></span></span><span>
</span><span id="line-2777"></span><span>              </span><span id="local-6989586621683047319"><span class="annot"><span class="annottext">wc :: WantedConstraints
</span><a href="#local-6989586621683047319"><span class="hs-identifier hs-var">wc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047320"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047320"><span class="hs-identifier hs-var">simples</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047321"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047321"><span class="hs-identifier hs-var">implics</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2778"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#csTraceTcS"><span class="hs-identifier hs-var">csTraceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2779"></span><span>         </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplify_loop iteration=&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683047316"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-2780"></span><span>         </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;definitely_redo =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047318"><span class="hs-identifier hs-var">definitely_redo_implications</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span>
</span><span id="line-2781"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cts -&gt; Int
forall a. Bag a -&gt; Int
</span><a href="GHC.Data.Bag.html#lengthBag"><span class="hs-identifier hs-var">lengthBag</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047320"><span class="hs-identifier hs-var">simples</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simples to solve&quot;</span></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2782"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplify_loop: wc =&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047319"><span class="hs-identifier hs-var">wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2783"></span><span>
</span><span id="line-2784"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047329"><span class="annot"><a href="#local-6989586621683047329"><span class="hs-identifier hs-var">unifs1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047330"><span class="annot"><a href="#local-6989586621683047330"><span class="hs-identifier hs-var">wc1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS WantedConstraints -&gt; TcS (Int, WantedConstraints)
forall a. TcS a -&gt; TcS (Int, a)
</span><a href="GHC.Tc.Solver.Monad.html#reportUnifications"><span class="hs-identifier hs-var">reportUnifications</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS WantedConstraints -&gt; TcS (Int, WantedConstraints))
-&gt; TcS WantedConstraints -&gt; TcS (Int, WantedConstraints)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="hs-comment">-- See Note [Superclass iteration]</span><span>
</span><span id="line-2785"></span><span>                          </span><span class="annot"><span class="annottext">Cts -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.Solve.html#solveSimpleWanteds"><span class="hs-identifier hs-var">solveSimpleWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047320"><span class="hs-identifier hs-var">simples</span></a></span><span>
</span><span id="line-2786"></span><span>                </span><span class="hs-comment">-- Any insoluble constraints are in 'simples' and so get rewritten</span><span>
</span><span id="line-2787"></span><span>                </span><span class="hs-comment">-- See Note [Rewrite insolubles] in GHC.Tc.Solver.InertSet</span><span>
</span><span id="line-2788"></span><span>
</span><span id="line-2789"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047331"><span class="annot"><a href="#local-6989586621683047331"><span class="hs-identifier hs-var">wc2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621683047318"><span class="hs-identifier hs-type">definitely_redo_implications</span></a></span><span>  </span><span class="hs-comment">-- See Note [Superclass iteration]</span><span>
</span><span id="line-2790"></span><span>                   </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><a href="#local-6989586621683047329"><span class="hs-identifier hs-type">unifs1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>                    </span><span class="hs-comment">-- for this conditional</span><span>
</span><span id="line-2791"></span><span>                   </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-type">isEmptyBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047330"><span class="hs-identifier hs-type">wc1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2792"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047319"><span class="hs-identifier hs-type">wc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047330"><span class="hs-identifier hs-type">wc1</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Short cut</span><span>
</span><span id="line-2793"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047332"><span class="annot"><a href="#local-6989586621683047332"><span class="hs-identifier hs-var">implics2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#solveNestedImplications"><span class="hs-identifier hs-type">solveNestedImplications</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2794"></span><span>                                      </span><span class="annot"><a href="#local-6989586621683047321"><span class="hs-identifier hs-type">implics</span></a></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-type">`unionBags`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047330"><span class="hs-identifier hs-type">wc1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2795"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047319"><span class="hs-identifier hs-type">wc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047330"><span class="hs-identifier hs-type">wc1</span></a></span><span>
</span><span id="line-2796"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047332"><span class="hs-identifier hs-type">implics2</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2797"></span><span>
</span><span id="line-2798"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047334"><span class="annot"><a href="#local-6989586621683047334"><span class="hs-identifier hs-var">unif_happened</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#resetUnificationFlag"><span class="hs-identifier hs-type">resetUnificationFlag</span></a></span><span>
</span><span id="line-2799"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#csTraceTcS"><span class="hs-identifier hs-type">csTraceTcS</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;unif_happened&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047334"><span class="hs-identifier hs-type">unif_happened</span></a></span><span>
</span><span id="line-2800"></span><span>         </span><span class="hs-comment">-- Note [The Unification Level Flag] in GHC.Tc.Solver.Monad</span><span>
</span><span id="line-2801"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#maybe_simplify_again"><span class="hs-identifier hs-type">maybe_simplify_again</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047316"><span class="hs-identifier hs-type">n</span></a></span><span class="annot"><span class="hs-operator hs-type">+</span></span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683047317"><span class="hs-identifier hs-type">limit</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047334"><span class="hs-identifier hs-type">unif_happened</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047331"><span class="hs-identifier hs-type">wc2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2802"></span><span>
</span><span id="line-2803"></span><span class="annot"><a href="GHC.Tc.Solver.html#maybe_simplify_again"><span class="hs-identifier hs-type">maybe_simplify_again</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2804"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-2805"></span><span id="maybe_simplify_again"><span class="annot"><span class="annottext">maybe_simplify_again :: Int
-&gt; IntWithInf -&gt; Bool -&gt; WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#maybe_simplify_again"><span class="hs-identifier hs-var hs-var">maybe_simplify_again</span></a></span></span><span> </span><span id="local-6989586621683047338"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683047338"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683047339"><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621683047339"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621683047340"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047340"><span class="hs-identifier hs-var">unif_happened</span></a></span></span><span> </span><span id="local-6989586621683047341"><span class="annot"><span class="annottext">wc :: WantedConstraints
</span><a href="#local-6989586621683047341"><span class="hs-identifier hs-var">wc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047342"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047342"><span class="hs-identifier hs-var">simples</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2806"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683047338"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntWithInf -&gt; Bool
</span><a href="GHC.Types.Basic.html#intGtLimit"><span class="hs-operator hs-var">`intGtLimit`</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621683047339"><span class="hs-identifier hs-var">limit</span></a></span><span>
</span><span id="line-2807"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Add an error (not a warning) if we blow the limit,</span><span>
</span><span id="line-2808"></span><span>         </span><span class="hs-comment">-- Typically if we blow the limit we are going to report some other error</span><span>
</span><span id="line-2809"></span><span>         </span><span class="hs-comment">-- (an unsolved constraint), and we don't want that error to suppress</span><span>
</span><span id="line-2810"></span><span>         </span><span class="hs-comment">-- the iteration limit warning!</span><span>
</span><span id="line-2811"></span><span>         </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#addErrTcS"><span class="hs-identifier hs-var">addErrTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcS ()) -&gt; TcRnMessage -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cts -&gt; IntWithInf -&gt; WantedConstraints -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnSimplifierTooManyIterations"><span class="hs-identifier hs-var">TcRnSimplifierTooManyIterations</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047342"><span class="hs-identifier hs-var">simples</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621683047339"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047341"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-2812"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047341"><span class="hs-identifier hs-var">wc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2813"></span><span>
</span><span id="line-2814"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047340"><span class="hs-identifier hs-var">unif_happened</span></a></span><span>
</span><span id="line-2815"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; IntWithInf -&gt; Bool -&gt; WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#simplify_loop"><span class="hs-identifier hs-var">simplify_loop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683047338"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621683047339"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047341"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-2816"></span><span>
</span><span id="line-2817"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#superClassesMightHelp"><span class="hs-identifier hs-var">superClassesMightHelp</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047341"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-2818"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- We still have unsolved goals, and apparently no way to solve them,</span><span>
</span><span id="line-2819"></span><span>    </span><span class="hs-comment">-- so try expanding superclasses at this level, both Given and Wanted</span><span>
</span><span id="line-2820"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047347"><span class="annot"><a href="#local-6989586621683047347"><span class="hs-identifier hs-var">pending_given</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS [Ct]
</span><a href="GHC.Tc.Solver.Monad.html#getPendingGivenScs"><span class="hs-identifier hs-var">getPendingGivenScs</span></a></span><span>
</span><span id="line-2821"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047348"><span class="annot"><a href="#local-6989586621683047348"><span class="hs-identifier hs-var">pending_wanted</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047349"><span class="annot"><a href="#local-6989586621683047349"><span class="hs-identifier hs-var">simples1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#getPendingWantedScs"><span class="hs-identifier hs-type">getPendingWantedScs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047342"><span class="hs-identifier hs-type">simples</span></a></span><span>
</span><span id="line-2822"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683047347"><span class="hs-identifier hs-type">pending_given</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683047348"><span class="hs-identifier hs-type">pending_wanted</span></a></span><span>
</span><span id="line-2823"></span><span>           </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683047341"><span class="hs-identifier hs-type">wc</span></a></span><span>  </span><span class="hs-comment">-- After all, superclasses did not help</span><span>
</span><span id="line-2824"></span><span>           </span><span class="hs-keyword">else</span><span>
</span><span id="line-2825"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047351"><span class="annot"><a href="#local-6989586621683047351"><span class="hs-identifier hs-var">new_given</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html#makeSuperClasses"><span class="hs-identifier hs-type">makeSuperClasses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047347"><span class="hs-identifier hs-type">pending_given</span></a></span><span>
</span><span id="line-2826"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047352"><span class="annot"><a href="#local-6989586621683047352"><span class="hs-identifier hs-var">new_wanted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Dict.html#makeSuperClasses"><span class="hs-identifier hs-type">makeSuperClasses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047348"><span class="hs-identifier hs-type">pending_wanted</span></a></span><span>
</span><span id="line-2827"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html#solveSimpleGivens"><span class="hs-identifier hs-type">solveSimpleGivens</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047351"><span class="hs-identifier hs-type">new_given</span></a></span><span> </span><span class="hs-comment">-- Add the new Givens to the inert set</span><span>
</span><span id="line-2828"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;maybe_simplify_again&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;pending_given&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047347"><span class="hs-identifier hs-type">pending_given</span></a></span><span>
</span><span id="line-2829"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;new_given&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047351"><span class="hs-identifier hs-type">new_given</span></a></span><span>
</span><span id="line-2830"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;pending_wanted&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047348"><span class="hs-identifier hs-type">pending_wanted</span></a></span><span>
</span><span id="line-2831"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;new_wanted&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047352"><span class="hs-identifier hs-type">new_wanted</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2832"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplify_loop"><span class="hs-identifier hs-type">simplify_loop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047338"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047339"><span class="hs-identifier hs-type">limit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683047347"><span class="hs-identifier hs-type">pending_given</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2833"></span><span>         </span><span class="annot"><a href="#local-6989586621683047341"><span class="hs-identifier hs-type">wc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047349"><span class="hs-identifier hs-type">simples1</span></a></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-type">`unionBags`</span></a></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#listToBag"><span class="hs-identifier hs-type">listToBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047352"><span class="hs-identifier hs-type">new_wanted</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2834"></span><span>         </span><span class="hs-comment">-- (not (null pending_given)): see Note [Superclass iteration]</span><span>
</span><span id="line-2835"></span><span>
</span><span id="line-2836"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2837"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047341"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-2838"></span><span>
</span><span id="line-2839"></span><span class="hs-comment">{- Note [Superclass iteration]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this implication constraint
    forall a.
       [W] d: C Int beta
       forall b. blah
where
  class D a b | a -&gt; b
  class D a b =&gt; C a b
We will expand d's superclasses, giving [W] D Int beta, in the hope of geting
fundeps to unify beta.  Doing so is usually fruitless (no useful fundeps),
and if so it seems a pity to waste time iterating the implications (forall b. blah)
(If we add new Given superclasses it's a different matter: it's really worth looking
at the implications.)

Hence the definitely_redo_implications flag to simplify_loop.  It's usually
True, but False in the case where the only reason to iterate is new Wanted
superclasses.  In that case we check whether the new Wanteds actually led to
any new unifications, and iterate the implications only if so.
-}</span><span>
</span><span id="line-2859"></span><span>
</span><span id="line-2860"></span><span class="hs-comment">{- Note [Expanding Recursive Superclasses and ExpansionFuel]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the class declaration (T21909)

    class C [a] =&gt; C a where
       foo :: a -&gt; Int

and suppose during type inference we obtain an implication constraint:

    forall a. C a =&gt; C [[a]]

To solve this implication constraint, we first expand one layer of the superclass
of Given constraints, but not for Wanted constraints.
(See Note [Eagerly expand given superclasses] and Note [Why adding superclasses can help]
in GHC.Tc.Solver.Dict.) We thus get:

    [G] g1 :: C a
    [G] g2 :: C [a]    -- new superclass layer from g1
    [W] w1 :: C [[a]]

Now, we cannot solve `w1` directly from `g1` or `g2` as we may not have
any instances for C. So we expand a layer of superclasses of each Wanteds and Givens
that we haven't expanded yet.
This is done in `maybe_simplify_again`. And we get:

    [G] g1 :: C a
    [G] g2 :: C [a]
    [G] g3 :: C [[a]]    -- new superclass layer from g2, can solve w1
    [W] w1 :: C [[a]]
    [W] w2 :: C [[[a]]]  -- new superclass layer from w1, not solvable

Now, although we can solve `w1` using `g3` (obtained from expanding `g2`),
we have a new wanted constraint `w2` (obtained from expanding `w1`) that cannot be solved.
We thus make another go at solving in `maybe_simplify_again` by expanding more
layers of superclasses. This looping is futile as Givens will never be able to catch up with Wanteds.

Side Note: In principle we don't actually need to /solve/ `w2`, as it is a superclass of `w1`
but we only expand it to expose any functional dependencies (see Note [The superclass story])
But `w2` is a wanted constraint, so we will try to solve it like any other,
even though ultimately we will discard its evidence.

Solution: Simply bound the maximum number of layers of expansion for
Givens and Wanteds, with ExpansionFuel.  Give the Givens more fuel
(say 3 layers) than the Wanteds (say 1 layer). Now the Givens will
win.  The Wanteds don't need much fuel: we are only expanding at all
to expose functional dependencies, and wantedFuel=1 means we will
expand a full recursive layer.  If the superclass hierarchy is
non-recursive (the normal case) one layer is therefore full expansion.

The default value for wantedFuel = Constants.max_WANTEDS_FUEL = 1.
The default value for givenFuel  = Constants.max_GIVENS_FUEL = 3.
Both are configurable via the `-fgivens-fuel` and `-fwanteds-fuel`
compiler flags.

There are two preconditions for the default fuel values:
   (1) default givenFuel &gt;= default wantedsFuel
   (2) default givenFuel &lt; solverIterations

Precondition (1) ensures that we expand givens at least as many times as we expand wanted constraints
preferably givenFuel &gt; wantedsFuel to avoid issues like T21909 while
the precondition (2) ensures that we do not reach the solver iteration limit and fail with a
more meaningful error message (see T19627)

This also applies for quantified constraints; see `-fqcs-fuel` compiler flag and `QCI.qci_pend_sc` field.
-}</span><span>
</span><span id="line-2925"></span><span>
</span><span id="line-2926"></span><span>
</span><span id="line-2927"></span><span class="annot"><a href="GHC.Tc.Solver.html#solveNestedImplications"><span class="hs-identifier hs-type">solveNestedImplications</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span>
</span><span id="line-2928"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2929"></span><span class="hs-comment">-- Precondition: the TcS inerts may contain unsolved simples which have</span><span>
</span><span id="line-2930"></span><span class="hs-comment">-- to be converted to givens before we go inside a nested implication.</span><span>
</span><span id="line-2931"></span><span id="solveNestedImplications"><span class="annot"><span class="annottext">solveNestedImplications :: Bag Implication -&gt; TcS (Bag Implication)
</span><a href="GHC.Tc.Solver.html#solveNestedImplications"><span class="hs-identifier hs-var hs-var">solveNestedImplications</span></a></span></span><span> </span><span id="local-6989586621683047353"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047353"><span class="hs-identifier hs-var">implics</span></a></span></span><span>
</span><span id="line-2932"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bag Implication -&gt; Bool
forall a. Bag a -&gt; Bool
</span><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047353"><span class="hs-identifier hs-var">implics</span></a></span><span>
</span><span id="line-2933"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag Implication -&gt; TcS (Bag Implication)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag Implication
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2934"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2935"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;solveNestedImplications starting {&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-2936"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047354"><span class="annot"><a href="#local-6989586621683047354"><span class="hs-identifier hs-var">unsolved_implics</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Implication -&gt; TcS (Maybe Implication))
-&gt; Bag Implication -&gt; TcS (Bag (Maybe Implication))
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; Bag a -&gt; m (Bag b)
</span><a href="GHC.Data.Bag.html#mapBagM"><span class="hs-identifier hs-var">mapBagM</span></a></span><span> </span><span class="annot"><span class="annottext">Implication -&gt; TcS (Maybe Implication)
</span><a href="GHC.Tc.Solver.html#solveImplication"><span class="hs-identifier hs-var">solveImplication</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047353"><span class="hs-identifier hs-var">implics</span></a></span><span>
</span><span id="line-2937"></span><span>
</span><span id="line-2938"></span><span>       </span><span class="hs-comment">-- ... and we are back in the original TcS inerts</span><span>
</span><span id="line-2939"></span><span>       </span><span class="hs-comment">-- Notice that the original includes the _insoluble_simples so it was safe to ignore</span><span>
</span><span id="line-2940"></span><span>       </span><span class="hs-comment">-- them in the beginning of this function.</span><span>
</span><span id="line-2941"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;solveNestedImplications end }&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2942"></span><span>                  </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;unsolved_implics =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047354"><span class="hs-identifier hs-type">unsolved_implics</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2943"></span><span>
</span><span id="line-2944"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#catBagMaybes"><span class="hs-identifier hs-type">catBagMaybes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047354"><span class="hs-identifier hs-type">unsolved_implics</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2945"></span><span>
</span><span id="line-2946"></span><span class="annot"><a href="GHC.Tc.Solver.html#solveImplication"><span class="hs-identifier hs-type">solveImplication</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span>    </span><span class="hs-comment">-- Wanted</span><span>
</span><span id="line-2947"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Simplified implication (empty or singleton)</span><span>
</span><span id="line-2948"></span><span class="hs-comment">-- Precondition: The TcS monad contains an empty worklist and given-only inerts</span><span>
</span><span id="line-2949"></span><span class="hs-comment">-- which after trying to solve this implication we must restore to their original value</span><span>
</span><span id="line-2950"></span><span id="solveImplication"><span class="annot"><span class="annottext">solveImplication :: Implication -&gt; TcS (Maybe Implication)
</span><a href="GHC.Tc.Solver.html#solveImplication"><span class="hs-identifier hs-var hs-var">solveImplication</span></a></span></span><span> </span><span id="local-6989586621683047358"><span class="annot"><span class="annottext">imp :: Implication
</span><a href="#local-6989586621683047358"><span class="hs-identifier hs-var">imp</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implic"><span class="hs-identifier hs-type">Implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ic_tclvl :: Implication -&gt; TcLevel
</span><a href="GHC.Tc.Types.Constraint.html#ic_tclvl"><span class="hs-identifier hs-var">ic_tclvl</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047359"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047359"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span>
</span><span id="line-2951"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_binds :: Implication -&gt; EvBindsVar
</span><a href="GHC.Tc.Types.Constraint.html#ic_binds"><span class="hs-identifier hs-var">ic_binds</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047360"><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621683047360"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span>
</span><span id="line-2952"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_given :: Implication -&gt; [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#ic_given"><span class="hs-identifier hs-var">ic_given</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047361"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047361"><span class="hs-identifier hs-var">given_ids</span></a></span></span><span>
</span><span id="line-2953"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_wanted :: Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047362"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047362"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>
</span><span id="line-2954"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_info :: Implication -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Constraint.html#ic_info"><span class="hs-identifier hs-var">ic_info</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047363"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047363"><span class="hs-identifier hs-var">info</span></a></span></span><span>
</span><span id="line-2955"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_status :: Implication -&gt; ImplicStatus
</span><a href="GHC.Tc.Types.Constraint.html#ic_status"><span class="hs-identifier hs-var">ic_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047364"><span class="annot"><span class="annottext">ImplicStatus
</span><a href="#local-6989586621683047364"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2956"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ImplicStatus -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isSolvedStatus"><span class="hs-identifier hs-var">isSolvedStatus</span></a></span><span> </span><span class="annot"><span class="annottext">ImplicStatus
</span><a href="#local-6989586621683047364"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-2957"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Implication -&gt; TcS (Maybe Implication)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; Maybe Implication
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047358"><span class="hs-identifier hs-var">imp</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Do nothing</span><span>
</span><span id="line-2958"></span><span>
</span><span id="line-2959"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- Even for IC_Insoluble it is worth doing more work</span><span>
</span><span id="line-2960"></span><span>               </span><span class="hs-comment">-- The insoluble stuff might be in one sub-implication</span><span>
</span><span id="line-2961"></span><span>               </span><span class="hs-comment">-- and other unsolved goals in another; and we want to</span><span>
</span><span id="line-2962"></span><span>               </span><span class="hs-comment">-- solve the latter as much as possible</span><span>
</span><span id="line-2963"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047365"><span class="annot"><a href="#local-6989586621683047365"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertSet
</span><a href="GHC.Tc.Solver.Monad.html#getInertSet"><span class="hs-identifier hs-var">getInertSet</span></a></span><span>
</span><span id="line-2964"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;solveImplication {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047358"><span class="hs-identifier hs-type">imp</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Inerts&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047365"><span class="hs-identifier hs-type">inerts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2965"></span><span>
</span><span id="line-2966"></span><span>       </span><span class="hs-comment">-- commented out; see `where` clause below</span><span>
</span><span id="line-2967"></span><span>       </span><span class="hs-comment">-- ; when debugIsOn check_tc_level</span><span>
</span><span id="line-2968"></span><span>
</span><span id="line-2969"></span><span>         </span><span class="hs-comment">-- Solve the nested constraints</span><span>
</span><span id="line-2970"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047367"><span class="annot"><a href="#local-6989586621683047367"><span class="hs-identifier hs-var">has_given_eqs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047368"><span class="annot"><a href="#local-6989586621683047368"><span class="hs-identifier hs-var">given_insols</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047369"><span class="annot"><a href="#local-6989586621683047369"><span class="hs-identifier hs-var">residual_wanted</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2971"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#nestImplicTcS"><span class="hs-identifier hs-type">nestImplicTcS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047360"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047359"><span class="hs-identifier hs-type">tclvl</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2972"></span><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047370"><span class="annot"><a href="#local-6989586621683047370"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; SkolemInfoAnon -&gt; CtLocEnv -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#mkGivenLoc"><span class="hs-identifier hs-var">mkGivenLoc</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047359"><span class="hs-identifier hs-var">tclvl</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047363"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; CtLocEnv
</span><a href="GHC.Tc.Types.Constraint.html#ic_env"><span class="hs-identifier hs-var">ic_env</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047358"><span class="hs-identifier hs-var">imp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2973"></span><span>                        </span><span id="local-6989586621683047372"><span class="annot"><a href="#local-6989586621683047372"><span class="hs-identifier hs-var hs-var">givens</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; [TcTyVar] -&gt; [Ct]
</span><a href="GHC.Tc.Types.Constraint.html#mkGivens"><span class="hs-identifier hs-var">mkGivens</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683047370"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047361"><span class="hs-identifier hs-var">given_ids</span></a></span><span>
</span><span id="line-2974"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html#solveSimpleGivens"><span class="hs-identifier hs-type">solveSimpleGivens</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047372"><span class="hs-identifier hs-type">givens</span></a></span><span>
</span><span id="line-2975"></span><span>
</span><span id="line-2976"></span><span>                  </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047373"><span class="annot"><a href="#local-6989586621683047373"><span class="hs-identifier hs-var">residual_wanted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-type">solveWanteds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047362"><span class="hs-identifier hs-type">wanteds</span></a></span><span>
</span><span id="line-2977"></span><span>
</span><span id="line-2978"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047374"><span class="annot"><a href="#local-6989586621683047374"><span class="hs-identifier hs-var">has_eqs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047375"><span class="annot"><a href="#local-6989586621683047375"><span class="hs-identifier hs-var">given_insols</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getHasGivenEqs"><span class="hs-identifier hs-type">getHasGivenEqs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047359"><span class="hs-identifier hs-type">tclvl</span></a></span><span>
</span><span id="line-2979"></span><span>                        </span><span class="hs-comment">-- Call getHasGivenEqs /after/ solveWanteds, because</span><span>
</span><span id="line-2980"></span><span>                        </span><span class="hs-comment">-- solveWanteds can augment the givens, via expandSuperClasses,</span><span>
</span><span id="line-2981"></span><span>                        </span><span class="hs-comment">-- to reveal given superclass equalities</span><span>
</span><span id="line-2982"></span><span>
</span><span id="line-2983"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047374"><span class="hs-identifier hs-type">has_eqs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047375"><span class="hs-identifier hs-type">given_insols</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047373"><span class="hs-identifier hs-type">residual_wanted</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2984"></span><span>
</span><span id="line-2985"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;solveImplication 2&quot;</span></span><span>
</span><span id="line-2986"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047368"><span class="hs-identifier hs-type">given_insols</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047369"><span class="hs-identifier hs-type">residual_wanted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2987"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047377"><span class="annot"><a href="#local-6989586621683047377"><span class="hs-identifier hs-var hs-var">final_wanted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047369"><span class="hs-identifier hs-var">residual_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; InertIrreds -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#addInsols"><span class="hs-operator hs-var">`addInsols`</span></a></span><span> </span><span class="annot"><span class="annottext">InertIrreds
</span><a href="#local-6989586621683047368"><span class="hs-identifier hs-var">given_insols</span></a></span><span>
</span><span id="line-2988"></span><span>             </span><span class="hs-comment">-- Don't lose track of the insoluble givens,</span><span>
</span><span id="line-2989"></span><span>             </span><span class="hs-comment">-- which signal unreachable code; put them in ic_wanted</span><span>
</span><span id="line-2990"></span><span>
</span><span id="line-2991"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047379"><span class="annot"><a href="#local-6989586621683047379"><span class="hs-identifier hs-var">res_implic</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#setImplicationStatus"><span class="hs-identifier hs-type">setImplicationStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047358"><span class="hs-identifier hs-type">imp</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_given_eqs"><span class="hs-identifier hs-var">ic_given_eqs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047367"><span class="hs-identifier hs-type">has_given_eqs</span></a></span><span>
</span><span id="line-2992"></span><span>                                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047377"><span class="hs-identifier hs-type">final_wanted</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2993"></span><span>
</span><span id="line-2994"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047380"><span class="annot"><a href="#local-6989586621683047380"><span class="hs-identifier hs-var">evbinds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsMap"><span class="hs-identifier hs-type">TcS.getTcEvBindsMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047360"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span>
</span><span id="line-2995"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047381"><span class="annot"><a href="#local-6989586621683047381"><span class="hs-identifier hs-var">tcvs</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getTcEvTyCoVars"><span class="hs-identifier hs-type">TcS.getTcEvTyCoVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047360"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span>
</span><span id="line-2996"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;solveImplication end }&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span>
</span><span id="line-2997"></span><span>             </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;has_given_eqs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047367"><span class="hs-identifier hs-type">has_given_eqs</span></a></span><span>
</span><span id="line-2998"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;res_implic =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047379"><span class="hs-identifier hs-type">res_implic</span></a></span><span>
</span><span id="line-2999"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;implication evbinds =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#evBindMapBinds"><span class="hs-identifier hs-type">evBindMapBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047380"><span class="hs-identifier hs-type">evbinds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3000"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;implication tvcs =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047381"><span class="hs-identifier hs-type">tcvs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3001"></span><span>
</span><span id="line-3002"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683047379"><span class="hs-identifier hs-type">res_implic</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3003"></span><span>
</span><span id="line-3004"></span><span>    </span><span class="hs-comment">-- TcLevels must be strictly increasing (see (ImplicInv) in</span><span>
</span><span id="line-3005"></span><span>    </span><span class="hs-comment">-- Note [TcLevel invariants] in GHC.Tc.Utils.TcType),</span><span>
</span><span id="line-3006"></span><span>    </span><span class="hs-comment">-- and in fact I think they should always increase one level at a time.</span><span>
</span><span id="line-3007"></span><span>
</span><span id="line-3008"></span><span>    </span><span class="hs-comment">-- Though sensible, this check causes lots of testsuite failures. It is</span><span>
</span><span id="line-3009"></span><span>    </span><span class="hs-comment">-- remaining commented out for now.</span><span>
</span><span id="line-3010"></span><span>    </span><span class="hs-comment">{-
    check_tc_level = do { cur_lvl &lt;- TcS.getTcLevel
                        ; massertPpr (tclvl == pushTcLevel cur_lvl)
                                     (text &quot;Cur lvl =&quot; &lt;+&gt; ppr cur_lvl $$ text &quot;Imp lvl =&quot; &lt;+&gt; ppr tclvl) }
    -}</span><span>
</span><span id="line-3015"></span><span>
</span><span id="line-3016"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-3017"></span><span class="annot"><a href="GHC.Tc.Solver.html#setImplicationStatus"><span class="hs-identifier hs-type">setImplicationStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3018"></span><span class="hs-comment">-- Finalise the implication returned from solveImplication,</span><span>
</span><span id="line-3019"></span><span class="hs-comment">-- setting the ic_status field</span><span>
</span><span id="line-3020"></span><span class="hs-comment">-- Precondition: the ic_status field is not already IC_Solved</span><span>
</span><span id="line-3021"></span><span class="hs-comment">-- Return Nothing if we can discard the implication altogether</span><span>
</span><span id="line-3022"></span><span id="setImplicationStatus"><span class="annot"><span class="annottext">setImplicationStatus :: Implication -&gt; TcS (Maybe Implication)
</span><a href="GHC.Tc.Solver.html#setImplicationStatus"><span class="hs-identifier hs-var hs-var">setImplicationStatus</span></a></span></span><span> </span><span id="local-6989586621683047383"><span class="annot"><span class="annottext">implic :: Implication
</span><a href="#local-6989586621683047383"><span class="hs-identifier hs-var">implic</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implic"><span class="hs-identifier hs-type">Implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ic_status :: Implication -&gt; ImplicStatus
</span><a href="GHC.Tc.Types.Constraint.html#ic_status"><span class="hs-identifier hs-var">ic_status</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047384"><span class="annot"><span class="annottext">ImplicStatus
</span><a href="#local-6989586621683047384"><span class="hs-identifier hs-var">old_status</span></a></span></span><span>
</span><span id="line-3023"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_info :: Implication -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Constraint.html#ic_info"><span class="hs-identifier hs-var">ic_info</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047385"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047385"><span class="hs-identifier hs-var">info</span></a></span></span><span>
</span><span id="line-3024"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_wanted :: Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047386"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047386"><span class="hs-identifier hs-var">wc</span></a></span></span><span>
</span><span id="line-3025"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_given :: Implication -&gt; [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#ic_given"><span class="hs-identifier hs-var">ic_given</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047387"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047387"><span class="hs-identifier hs-var">givens</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3026"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ImplicStatus -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isSolvedStatus"><span class="hs-identifier hs-var">isSolvedStatus</span></a></span><span> </span><span class="annot"><span class="annottext">ImplicStatus
</span><a href="#local-6989586621683047384"><span class="hs-identifier hs-var">old_status</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SkolemInfoAnon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047385"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3027"></span><span>   </span><span class="hs-comment">-- Precondition: we only set the status if it is not already solved</span><span>
</span><span id="line-3028"></span><span>   </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isSolvedWC"><span class="hs-identifier hs-var">isSolvedWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047388"><span class="hs-identifier hs-var">pruned_wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3029"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;setImplicationStatus(not-all-solved) {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047383"><span class="hs-identifier hs-var">implic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3030"></span><span>
</span><span id="line-3031"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047389"><span class="annot"><a href="#local-6989586621683047389"><span class="hs-identifier hs-var">implic</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Implication -&gt; TcS Implication
</span><a href="GHC.Tc.Solver.html#neededEvVars"><span class="hs-identifier hs-var">neededEvVars</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047383"><span class="hs-identifier hs-var">implic</span></a></span><span>
</span><span id="line-3032"></span><span>
</span><span id="line-3033"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047391"><span class="annot"><a href="#local-6989586621683047391"><span class="hs-identifier hs-var hs-var">new_status</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#insolubleWC"><span class="hs-identifier hs-var">insolubleWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047388"><span class="hs-identifier hs-var">pruned_wc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImplicStatus
</span><a href="GHC.Tc.Types.Constraint.html#IC_Insoluble"><span class="hs-identifier hs-var">IC_Insoluble</span></a></span><span>
</span><span id="line-3034"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImplicStatus
</span><a href="GHC.Tc.Types.Constraint.html#IC_Unsolved"><span class="hs-identifier hs-var">IC_Unsolved</span></a></span><span>
</span><span id="line-3035"></span><span>            </span><span id="local-6989586621683047394"><span class="annot"><a href="#local-6989586621683047394"><span class="hs-identifier hs-var hs-var">new_implic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047389"><span class="hs-identifier hs-var">implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_status"><span class="hs-identifier hs-var">ic_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047391"><span class="hs-identifier hs-type">new_status</span></a></span><span>
</span><span id="line-3036"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047388"><span class="hs-identifier hs-type">pruned_wc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3037"></span><span>
</span><span id="line-3038"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;setImplicationStatus(not-all-solved) }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047394"><span class="hs-identifier hs-type">new_implic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3039"></span><span>
</span><span id="line-3040"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683047394"><span class="hs-identifier hs-type">new_implic</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3041"></span><span>
</span><span id="line-3042"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- Everything is solved</span><span>
</span><span id="line-3043"></span><span>              </span><span class="hs-comment">-- Set status to IC_Solved,</span><span>
</span><span id="line-3044"></span><span>              </span><span class="hs-comment">-- and compute the dead givens and outer needs</span><span>
</span><span id="line-3045"></span><span>              </span><span class="hs-comment">-- See Note [Tracking redundant constraints]</span><span>
</span><span id="line-3046"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;setImplicationStatus(all-solved) {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047383"><span class="hs-identifier hs-var">implic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3047"></span><span>
</span><span id="line-3048"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047395"><span class="annot"><a href="#local-6989586621683047395"><span class="hs-identifier hs-var">implic</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implic"><span class="hs-identifier hs-type">Implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_need_inner"><span class="hs-identifier hs-var">ic_need_inner</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047396"><span class="annot"><a href="#local-6989586621683047396"><span class="hs-identifier hs-var">need_inner</span></a></span></span><span>
</span><span id="line-3049"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_need_outer"><span class="hs-identifier hs-var">ic_need_outer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047398"><span class="annot"><a href="#local-6989586621683047398"><span class="hs-identifier hs-var">need_outer</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Implication -&gt; TcS Implication
</span><a href="GHC.Tc.Solver.html#neededEvVars"><span class="hs-identifier hs-var">neededEvVars</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047383"><span class="hs-identifier hs-var">implic</span></a></span><span>
</span><span id="line-3050"></span><span>
</span><span id="line-3051"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047399"><span class="annot"><a href="#local-6989586621683047399"><span class="hs-identifier hs-var">bad_telescope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#checkBadTelescope"><span class="hs-identifier hs-type">checkBadTelescope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047395"><span class="hs-identifier hs-type">implic</span></a></span><span>
</span><span id="line-3052"></span><span>
</span><span id="line-3053"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047401"><span class="annot"><a href="#local-6989586621683047401"><span class="hs-identifier hs-var hs-var">warn_givens</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon -&gt; VarSet -&gt; [TcTyVar] -&gt; [TcTyVar]
</span><a href="GHC.Tc.Solver.html#findUnnecessaryGivens"><span class="hs-identifier hs-var">findUnnecessaryGivens</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047385"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047396"><span class="hs-identifier hs-var">need_inner</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047387"><span class="hs-identifier hs-var">givens</span></a></span><span>
</span><span id="line-3054"></span><span>
</span><span id="line-3055"></span><span>            </span><span id="local-6989586621683047403"><span class="annot"><a href="#local-6989586621683047403"><span class="hs-identifier hs-var hs-var">discard_entire_implication</span></a></span></span><span>  </span><span class="hs-comment">-- Can we discard the entire implication?</span><span>
</span><span id="line-3056"></span><span>              </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047401"><span class="hs-identifier hs-var">warn_givens</span></a></span><span>           </span><span class="hs-comment">-- No warning from this implication</span><span>
</span><span id="line-3057"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047399"><span class="hs-identifier hs-var">bad_telescope</span></a></span><span>
</span><span id="line-3058"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047388"><span class="hs-identifier hs-var">pruned_wc</span></a></span><span>        </span><span class="hs-comment">-- No live children</span><span>
</span><span id="line-3059"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047398"><span class="hs-identifier hs-var">need_outer</span></a></span><span>   </span><span class="hs-comment">-- No needed vars to pass up to parent</span><span>
</span><span id="line-3060"></span><span>
</span><span id="line-3061"></span><span>            </span><span id="local-6989586621683047405"><span class="annot"><a href="#local-6989586621683047405"><span class="hs-identifier hs-var hs-var">final_status</span></a></span></span><span>
</span><span id="line-3062"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047399"><span class="hs-identifier hs-var">bad_telescope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImplicStatus
</span><a href="GHC.Tc.Types.Constraint.html#IC_BadTelescope"><span class="hs-identifier hs-var">IC_BadTelescope</span></a></span><span>
</span><span id="line-3063"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IC_Solved"><span class="hs-identifier hs-type">IC_Solved</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ics_dead :: [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#ics_dead"><span class="hs-identifier hs-var">ics_dead</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047401"><span class="hs-identifier hs-var">warn_givens</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3064"></span><span>            </span><span id="local-6989586621683047409"><span class="annot"><a href="#local-6989586621683047409"><span class="hs-identifier hs-var hs-var">final_implic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047395"><span class="hs-identifier hs-var">implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_status"><span class="hs-identifier hs-var">ic_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047405"><span class="hs-identifier hs-type">final_status</span></a></span><span>
</span><span id="line-3065"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047388"><span class="hs-identifier hs-type">pruned_wc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3066"></span><span>
</span><span id="line-3067"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;setImplicationStatus(all-solved) }&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-3068"></span><span>        </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;discard:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047403"><span class="hs-identifier hs-type">discard_entire_implication</span></a></span><span>
</span><span id="line-3069"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;new_implic:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047409"><span class="hs-identifier hs-type">final_implic</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3070"></span><span>
</span><span id="line-3071"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683047403"><span class="hs-identifier hs-type">discard_entire_implication</span></a></span><span>
</span><span id="line-3072"></span><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-3073"></span><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683047409"><span class="hs-identifier hs-type">final_implic</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3074"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3075"></span><span>   </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047410"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047410"><span class="hs-identifier hs-var">simples</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047411"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047411"><span class="hs-identifier hs-var">implics</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_errors :: WantedConstraints -&gt; Bag DelayedError
</span><a href="GHC.Tc.Types.Constraint.html#wc_errors"><span class="hs-identifier hs-var">wc_errors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047412"><span class="annot"><span class="annottext">Bag DelayedError
</span><a href="#local-6989586621683047412"><span class="hs-identifier hs-var">errs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047386"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-3076"></span><span>
</span><span id="line-3077"></span><span>   </span><span id="local-6989586621683047413"><span class="annot"><span class="annottext">pruned_implics :: Bag Implication
</span><a href="#local-6989586621683047413"><span class="hs-identifier hs-var hs-var">pruned_implics</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Implication -&gt; Bool) -&gt; Bag Implication -&gt; Bag Implication
forall a. (a -&gt; Bool) -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#filterBag"><span class="hs-identifier hs-var">filterBag</span></a></span><span> </span><span class="annot"><span class="annottext">Implication -&gt; Bool
</span><a href="#local-6989586621683047415"><span class="hs-identifier hs-var">keep_me</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047411"><span class="hs-identifier hs-var">implics</span></a></span><span>
</span><span id="line-3078"></span><span>   </span><span id="local-6989586621683047388"><span class="annot"><span class="annottext">pruned_wc :: WantedConstraints
</span><a href="#local-6989586621683047388"><span class="hs-identifier hs-var hs-var">pruned_wc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047410"><span class="hs-identifier hs-var">simples</span></a></span><span>
</span><span id="line-3079"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047413"><span class="hs-identifier hs-var">pruned_implics</span></a></span><span>
</span><span id="line-3080"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_errors :: Bag DelayedError
</span><a href="GHC.Tc.Types.Constraint.html#wc_errors"><span class="hs-identifier hs-var">wc_errors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag DelayedError
</span><a href="#local-6989586621683047412"><span class="hs-identifier hs-var">errs</span></a></span><span> </span><span class="hs-special">}</span><span>   </span><span class="hs-comment">-- do not prune holes; these should be reported</span><span>
</span><span id="line-3081"></span><span>
</span><span id="line-3082"></span><span>   </span><span class="annot"><a href="#local-6989586621683047415"><span class="hs-identifier hs-type">keep_me</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3083"></span><span>   </span><span id="local-6989586621683047415"><span class="annot"><span class="annottext">keep_me :: Implication -&gt; Bool
</span><a href="#local-6989586621683047415"><span class="hs-identifier hs-var hs-var">keep_me</span></a></span></span><span> </span><span id="local-6989586621683047416"><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047416"><span class="hs-identifier hs-var">ic</span></a></span></span><span>
</span><span id="line-3084"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#IC_Solved"><span class="hs-identifier hs-type">IC_Solved</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ics_dead :: ImplicStatus -&gt; [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#ics_dead"><span class="hs-identifier hs-var">ics_dead</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047417"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047417"><span class="hs-identifier hs-var">dead_givens</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Implication -&gt; ImplicStatus
</span><a href="GHC.Tc.Types.Constraint.html#ic_status"><span class="hs-identifier hs-var">ic_status</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047416"><span class="hs-identifier hs-var">ic</span></a></span><span>
</span><span id="line-3085"></span><span>                          </span><span class="hs-comment">-- Fully solved</span><span>
</span><span id="line-3086"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047417"><span class="hs-identifier hs-var">dead_givens</span></a></span><span>   </span><span class="hs-comment">-- No redundant givens to report</span><span>
</span><span id="line-3087"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bag Implication -&gt; Bool
forall a. Bag a -&gt; Bool
</span><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047416"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3088"></span><span>           </span><span class="hs-comment">-- And no children that might have things to report</span><span>
</span><span id="line-3089"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>       </span><span class="hs-comment">-- Tnen we don't need to keep it</span><span>
</span><span id="line-3090"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3091"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>        </span><span class="hs-comment">-- Otherwise, keep it</span><span>
</span><span id="line-3092"></span><span>
</span><span id="line-3093"></span><span class="annot"><a href="GHC.Tc.Solver.html#findUnnecessaryGivens"><span class="hs-identifier hs-type">findUnnecessaryGivens</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfoAnon"><span class="hs-identifier hs-type">SkolemInfoAnon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3094"></span><span id="findUnnecessaryGivens"><span class="annot"><span class="annottext">findUnnecessaryGivens :: SkolemInfoAnon -&gt; VarSet -&gt; [TcTyVar] -&gt; [TcTyVar]
</span><a href="GHC.Tc.Solver.html#findUnnecessaryGivens"><span class="hs-identifier hs-var hs-var">findUnnecessaryGivens</span></a></span></span><span> </span><span id="local-6989586621683047418"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047418"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621683047419"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047419"><span class="hs-identifier hs-var">need_inner</span></a></span></span><span> </span><span id="local-6989586621683047420"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047420"><span class="hs-identifier hs-var">givens</span></a></span></span><span>
</span><span id="line-3095"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SkolemInfoAnon -&gt; Bool
</span><a href="GHC.Tc.Solver.html#warnRedundantGivens"><span class="hs-identifier hs-var">warnRedundantGivens</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047418"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Don't report redundant constraints at all</span><span>
</span><span id="line-3096"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3097"></span><span>
</span><span id="line-3098"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcTyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047422"><span class="hs-identifier hs-var">unused_givens</span></a></span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Some givens are literally unused</span><span>
</span><span id="line-3099"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047422"><span class="hs-identifier hs-var">unused_givens</span></a></span><span>
</span><span id="line-3100"></span><span>
</span><span id="line-3101"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                       </span><span class="hs-comment">-- All givens are used, but some might</span><span>
</span><span id="line-3102"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047423"><span class="hs-identifier hs-var">redundant_givens</span></a></span><span>                </span><span class="hs-comment">-- still be redundant e.g. (Eq a, Ord a)</span><span>
</span><span id="line-3103"></span><span>
</span><span id="line-3104"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3105"></span><span>    </span><span id="local-6989586621683047424"><span class="annot"><span class="annottext">in_instance_decl :: Bool
</span><a href="#local-6989586621683047424"><span class="hs-identifier hs-var hs-var">in_instance_decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047418"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InstSkol"><span class="hs-identifier hs-type">InstSkol</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3106"></span><span>                       </span><span class="hs-comment">-- See Note [Redundant constraints in instance decls]</span><span>
</span><span id="line-3107"></span><span>
</span><span id="line-3108"></span><span>    </span><span id="local-6989586621683047422"><span class="annot"><span class="annottext">unused_givens :: [TcTyVar]
</span><a href="#local-6989586621683047422"><span class="hs-identifier hs-var hs-var">unused_givens</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; [TcTyVar] -&gt; [TcTyVar]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="#local-6989586621683047426"><span class="hs-identifier hs-var">is_used</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047420"><span class="hs-identifier hs-var">givens</span></a></span><span>
</span><span id="line-3109"></span><span>
</span><span id="line-3110"></span><span>    </span><span id="local-6989586621683047426"><span class="annot"><span class="annottext">is_used :: TcTyVar -&gt; Bool
</span><a href="#local-6989586621683047426"><span class="hs-identifier hs-var hs-var">is_used</span></a></span></span><span> </span><span id="local-6989586621683047427"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047427"><span class="hs-identifier hs-var">given</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="#local-6989586621683047428"><span class="hs-identifier hs-var">is_type_error</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047427"><span class="hs-identifier hs-var">given</span></a></span><span>
</span><span id="line-3111"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047427"><span class="hs-identifier hs-var">given</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047419"><span class="hs-identifier hs-var">need_inner</span></a></span><span>
</span><span id="line-3112"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047424"><span class="hs-identifier hs-var">in_instance_decl</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="#local-6989586621683047429"><span class="hs-identifier hs-var">is_improving</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047427"><span class="hs-identifier hs-var">given</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3113"></span><span>
</span><span id="line-3114"></span><span>    </span><span id="local-6989586621683047430"><span class="annot"><span class="annottext">minimal_givens :: [TcTyVar]
</span><a href="#local-6989586621683047430"><span class="hs-identifier hs-var hs-var">minimal_givens</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; TcType) -&gt; [TcTyVar] -&gt; [TcTyVar]
forall a. (a -&gt; TcType) -&gt; [a] -&gt; [a]
</span><a href="GHC.Tc.Utils.TcType.html#mkMinimalBySCs"><span class="hs-identifier hs-var">mkMinimalBySCs</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Tc.Utils.TcType.html#evVarPred"><span class="hs-identifier hs-var">evVarPred</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047420"><span class="hs-identifier hs-var">givens</span></a></span><span>
</span><span id="line-3115"></span><span>    </span><span id="local-6989586621683047432"><span class="annot"><span class="annottext">is_minimal :: TcTyVar -&gt; Bool
</span><a href="#local-6989586621683047432"><span class="hs-identifier hs-var hs-var">is_minimal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047430"><span class="hs-identifier hs-var">minimal_givens</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3116"></span><span>    </span><span id="local-6989586621683047423"><span class="annot"><span class="annottext">redundant_givens :: [TcTyVar]
</span><a href="#local-6989586621683047423"><span class="hs-identifier hs-var hs-var">redundant_givens</span></a></span></span><span>
</span><span id="line-3117"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047424"><span class="hs-identifier hs-var">in_instance_decl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3118"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; Bool) -&gt; [TcTyVar] -&gt; [TcTyVar]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="#local-6989586621683047432"><span class="hs-identifier hs-var">is_minimal</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047420"><span class="hs-identifier hs-var">givens</span></a></span><span>
</span><span id="line-3119"></span><span>
</span><span id="line-3120"></span><span>    </span><span class="hs-comment">-- See #15232</span><span>
</span><span id="line-3121"></span><span>    </span><span id="local-6989586621683047428"><span class="annot"><span class="annottext">is_type_error :: TcTyVar -&gt; Bool
</span><a href="#local-6989586621683047428"><span class="hs-identifier hs-var hs-var">is_type_error</span></a></span></span><span> </span><span id="local-6989586621683047433"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047433"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isTopLevelUserTypeError"><span class="hs-identifier hs-var">isTopLevelUserTypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047433"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3122"></span><span>
</span><span id="line-3123"></span><span>    </span><span id="local-6989586621683047429"><span class="annot"><span class="annottext">is_improving :: TcType -&gt; Bool
</span><a href="#local-6989586621683047429"><span class="hs-identifier hs-var hs-var">is_improving</span></a></span></span><span> </span><span id="local-6989586621683047436"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047436"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span class="hs-comment">-- (transSuperClasses p) does not include p</span><span>
</span><span id="line-3124"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; Bool) -&gt; [TcType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isImprovementPred"><span class="hs-identifier hs-var">isImprovementPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047436"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; [TcType] -&gt; [TcType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; [TcType]
</span><a href="GHC.Tc.Utils.TcType.html#transSuperClasses"><span class="hs-identifier hs-var">transSuperClasses</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047436"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3125"></span><span>
</span><span id="line-3126"></span><span class="hs-comment">{- Note [Redundant constraints in instance decls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Instance declarations are special in two ways:

* We don't report unused givens if they can give rise to improvement.
  Example (#10100):
    class Add a b ab | a b -&gt; ab, a ab -&gt; b
    instance Add Zero b b
    instance Add a b ab =&gt; Add (Succ a) b (Succ ab)
  The context (Add a b ab) for the instance is clearly unused in terms
  of evidence, since the dictionary has no fields.  But it is still
  needed!  With the context, a wanted constraint
     Add (Succ Zero) beta (Succ Zero)
  we will reduce to (Add Zero beta Zero), and thence we get beta := Zero.
  But without the context we won't find beta := Zero.

  This only matters in instance declarations.

* We don't report givens that are a superclass of another given. E.g.
       class Ord r =&gt; UserOfRegs r a where ...
       instance (Ord r, UserOfRegs r CmmReg) =&gt; UserOfRegs r CmmExpr where
  The (Ord r) is not redundant, even though it is a superclass of
  (UserOfRegs r CmmReg).  See Note [Recursive superclasses] in GHC.Tc.TyCl.Instance.

  Again this is specific to instance declarations.
-}</span><span>
</span><span id="line-3152"></span><span>
</span><span id="line-3153"></span><span>
</span><span id="line-3154"></span><span class="annot"><a href="GHC.Tc.Solver.html#checkBadTelescope"><span class="hs-identifier hs-type">checkBadTelescope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3155"></span><span class="hs-comment">-- True &lt;=&gt; the skolems form a bad telescope</span><span>
</span><span id="line-3156"></span><span class="hs-comment">-- See Note [Checking telescopes] in GHC.Tc.Types.Constraint</span><span>
</span><span id="line-3157"></span><span id="checkBadTelescope"><span class="annot"><span class="annottext">checkBadTelescope :: Implication -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#checkBadTelescope"><span class="hs-identifier hs-var hs-var">checkBadTelescope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implic"><span class="hs-identifier hs-type">Implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ic_info :: Implication -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Constraint.html#ic_info"><span class="hs-identifier hs-var">ic_info</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047440"><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047440"><span class="hs-identifier hs-var">info</span></a></span></span><span>
</span><span id="line-3158"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_skols :: Implication -&gt; [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#ic_skols"><span class="hs-identifier hs-var">ic_skols</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047441"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047441"><span class="hs-identifier hs-var">skols</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3159"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#checkTelescopeSkol"><span class="hs-identifier hs-var">checkTelescopeSkol</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><a href="#local-6989586621683047440"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-3160"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047443"><span class="annot"><a href="#local-6989586621683047443"><span class="hs-identifier hs-var">skols</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; TcS TcTyVar) -&gt; [TcTyVar] -&gt; TcS [TcTyVar]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcS TcTyVar
</span><a href="GHC.Tc.Solver.Monad.html#zonkTyCoVarKind"><span class="hs-identifier hs-var">TcS.zonkTyCoVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047441"><span class="hs-identifier hs-var">skols</span></a></span><span>
</span><span id="line-3161"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047445"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-type">emptyVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="annot"><a href="#local-6989586621683047443"><span class="hs-identifier hs-type">skols</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-3162"></span><span>
</span><span id="line-3163"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3164"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3165"></span><span>
</span><span id="line-3166"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3167"></span><span>    </span><span class="annot"><a href="#local-6989586621683047445"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a></span><span>   </span><span class="hs-comment">-- skolems that appear *later* than the current ones</span><span>
</span><span id="line-3168"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ordered skolems, in reverse order</span><span>
</span><span id="line-3169"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>       </span><span class="hs-comment">-- True &lt;=&gt; there is an out-of-order skolem</span><span>
</span><span id="line-3170"></span><span>    </span><span id="local-6989586621683047445"><span class="annot"><span class="annottext">go :: VarSet -&gt; [TcTyVar] -&gt; Bool
</span><a href="#local-6989586621683047445"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3171"></span><span>    </span><span class="annot"><a href="#local-6989586621683047445"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683047447"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047447"><span class="hs-identifier hs-var">later_skols</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047448"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047448"><span class="hs-identifier hs-var">one_skol</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683047449"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047449"><span class="hs-identifier hs-var">earlier_skols</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3172"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047448"><span class="hs-identifier hs-var">one_skol</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-var">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047447"><span class="hs-identifier hs-var">later_skols</span></a></span><span>
</span><span id="line-3173"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3174"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3175"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [TcTyVar] -&gt; Bool
</span><a href="#local-6989586621683047445"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047447"><span class="hs-identifier hs-var">later_skols</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; TcTyVar -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSet"><span class="hs-operator hs-var">`extendVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047448"><span class="hs-identifier hs-var">one_skol</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047449"><span class="hs-identifier hs-var">earlier_skols</span></a></span><span>
</span><span id="line-3176"></span><span>
</span><span id="line-3177"></span><span class="annot"><a href="GHC.Tc.Solver.html#warnRedundantGivens"><span class="hs-identifier hs-type">warnRedundantGivens</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SkolemInfoAnon"><span class="hs-identifier hs-type">SkolemInfoAnon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3178"></span><span id="warnRedundantGivens"><span class="annot"><span class="annottext">warnRedundantGivens :: SkolemInfoAnon -&gt; Bool
</span><a href="GHC.Tc.Solver.html#warnRedundantGivens"><span class="hs-identifier hs-var hs-var">warnRedundantGivens</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SigSkol"><span class="hs-identifier hs-type">SigSkol</span></a></span><span> </span><span id="local-6989586621683047451"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683047451"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="annot"><span class="annottext">TcType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TcTyVar)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-3179"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683047451"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3180"></span><span>       </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FunSigCtxt"><span class="hs-identifier hs-type">FunSigCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683047453"><span class="annot"><span class="annottext">ReportRedundantConstraints
</span><a href="#local-6989586621683047453"><span class="hs-identifier hs-var">rrc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReportRedundantConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Origin.html#reportRedundantConstraints"><span class="hs-identifier hs-var">reportRedundantConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">ReportRedundantConstraints
</span><a href="#local-6989586621683047453"><span class="hs-identifier hs-var">rrc</span></a></span><span>
</span><span id="line-3181"></span><span>       </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExprSigCtxt"><span class="hs-identifier hs-type">ExprSigCtxt</span></a></span><span> </span><span id="local-6989586621683047456"><span class="annot"><span class="annottext">ReportRedundantConstraints
</span><a href="#local-6989586621683047456"><span class="hs-identifier hs-var">rrc</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReportRedundantConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Origin.html#reportRedundantConstraints"><span class="hs-identifier hs-var">reportRedundantConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">ReportRedundantConstraints
</span><a href="#local-6989586621683047456"><span class="hs-identifier hs-var">rrc</span></a></span><span>
</span><span id="line-3182"></span><span>       </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3183"></span><span>
</span><span id="line-3184"></span><span>  </span><span class="hs-comment">-- To think about: do we want to report redundant givens for</span><span>
</span><span id="line-3185"></span><span>  </span><span class="hs-comment">-- pattern synonyms, PatSynSigSkol? c.f #9953, comment:21.</span><span>
</span><span id="line-3186"></span><span class="annot"><a href="GHC.Tc.Solver.html#warnRedundantGivens"><span class="hs-identifier hs-var">warnRedundantGivens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InstSkol"><span class="hs-identifier hs-type">InstSkol</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3187"></span><span class="annot"><a href="GHC.Tc.Solver.html#warnRedundantGivens"><span class="hs-identifier hs-var">warnRedundantGivens</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3188"></span><span>
</span><span id="line-3189"></span><span class="annot"><a href="GHC.Tc.Solver.html#neededEvVars"><span class="hs-identifier hs-type">neededEvVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span>
</span><span id="line-3190"></span><span class="hs-comment">-- Find all the evidence variables that are &quot;needed&quot;,</span><span>
</span><span id="line-3191"></span><span class="hs-comment">-- and delete dead evidence bindings</span><span>
</span><span id="line-3192"></span><span class="hs-comment">--   See Note [Tracking redundant constraints]</span><span>
</span><span id="line-3193"></span><span class="hs-comment">--   See Note [Delete dead Given evidence bindings]</span><span>
</span><span id="line-3194"></span><span class="hs-comment">--</span><span>
</span><span id="line-3195"></span><span class="hs-comment">--   - Start from initial_seeds (from nested implications)</span><span>
</span><span id="line-3196"></span><span class="hs-comment">--</span><span>
</span><span id="line-3197"></span><span class="hs-comment">--   - Add free vars of RHS of all Wanted evidence bindings</span><span>
</span><span id="line-3198"></span><span class="hs-comment">--     and coercion variables accumulated in tcvs (all Wanted)</span><span>
</span><span id="line-3199"></span><span class="hs-comment">--</span><span>
</span><span id="line-3200"></span><span class="hs-comment">--   - Generate 'needed', the needed set of EvVars, by doing transitive</span><span>
</span><span id="line-3201"></span><span class="hs-comment">--     closure through Given bindings</span><span>
</span><span id="line-3202"></span><span class="hs-comment">--     e.g.   Needed {a,b}</span><span>
</span><span id="line-3203"></span><span class="hs-comment">--            Given  a = sc_sel a2</span><span>
</span><span id="line-3204"></span><span class="hs-comment">--            Then a2 is needed too</span><span>
</span><span id="line-3205"></span><span class="hs-comment">--</span><span>
</span><span id="line-3206"></span><span class="hs-comment">--   - Prune out all Given bindings that are not needed</span><span>
</span><span id="line-3207"></span><span class="hs-comment">--</span><span>
</span><span id="line-3208"></span><span class="hs-comment">--   - From the 'needed' set, delete ev_bndrs, the binders of the</span><span>
</span><span id="line-3209"></span><span class="hs-comment">--     evidence bindings, to give the final needed variables</span><span>
</span><span id="line-3210"></span><span class="hs-comment">--</span><span>
</span><span id="line-3211"></span><span id="neededEvVars"><span class="annot"><span class="annottext">neededEvVars :: Implication -&gt; TcS Implication
</span><a href="GHC.Tc.Solver.html#neededEvVars"><span class="hs-identifier hs-var hs-var">neededEvVars</span></a></span></span><span> </span><span id="local-6989586621683047457"><span class="annot"><span class="annottext">implic :: Implication
</span><a href="#local-6989586621683047457"><span class="hs-identifier hs-var">implic</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implic"><span class="hs-identifier hs-type">Implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ic_given :: Implication -&gt; [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#ic_given"><span class="hs-identifier hs-var">ic_given</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047458"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047458"><span class="hs-identifier hs-var">givens</span></a></span></span><span>
</span><span id="line-3212"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_binds :: Implication -&gt; EvBindsVar
</span><a href="GHC.Tc.Types.Constraint.html#ic_binds"><span class="hs-identifier hs-var">ic_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047459"><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621683047459"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span>
</span><span id="line-3213"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_wanted :: Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047460"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047460"><span class="hs-identifier hs-var">implics</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3214"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ic_need_inner :: Implication -&gt; VarSet
</span><a href="GHC.Tc.Types.Constraint.html#ic_need_inner"><span class="hs-identifier hs-var">ic_need_inner</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047461"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047461"><span class="hs-identifier hs-var">old_needs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3215"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047462"><span class="annot"><a href="#local-6989586621683047462"><span class="hs-identifier hs-var">ev_binds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EvBindsVar -&gt; TcS EvBindMap
</span><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsMap"><span class="hs-identifier hs-var">TcS.getTcEvBindsMap</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621683047459"><span class="hs-identifier hs-var">ev_binds_var</span></a></span><span>
</span><span id="line-3216"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047463"><span class="annot"><a href="#local-6989586621683047463"><span class="hs-identifier hs-var">tcvs</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getTcEvTyCoVars"><span class="hs-identifier hs-type">TcS.getTcEvTyCoVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047459"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span>
</span><span id="line-3217"></span><span>
</span><span id="line-3218"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047464"><span class="annot"><a href="#local-6989586621683047464"><span class="hs-identifier hs-var hs-var">seeds1</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Implication -&gt; VarSet -&gt; VarSet)
-&gt; VarSet -&gt; Bag Implication -&gt; VarSet
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; Bag a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">Implication -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621683047465"><span class="hs-identifier hs-var">add_implic_seeds</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047461"><span class="hs-identifier hs-var">old_needs</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047460"><span class="hs-identifier hs-var">implics</span></a></span><span>
</span><span id="line-3219"></span><span>            </span><span id="local-6989586621683047466"><span class="annot"><a href="#local-6989586621683047466"><span class="hs-identifier hs-var hs-var">seeds2</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EvBind -&gt; VarSet -&gt; VarSet) -&gt; VarSet -&gt; EvBindMap -&gt; VarSet
forall a. (EvBind -&gt; a -&gt; a) -&gt; a -&gt; EvBindMap -&gt; a
</span><a href="GHC.Tc.Types.Evidence.html#nonDetStrictFoldEvBindMap"><span class="hs-identifier hs-var">nonDetStrictFoldEvBindMap</span></a></span><span> </span><span class="annot"><span class="annottext">EvBind -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621683047468"><span class="hs-identifier hs-var">add_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047464"><span class="hs-identifier hs-var">seeds1</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621683047462"><span class="hs-identifier hs-var">ev_binds</span></a></span><span>
</span><span id="line-3220"></span><span>                            </span><span class="hs-comment">-- It's OK to use a non-deterministic fold here</span><span>
</span><span id="line-3221"></span><span>                            </span><span class="hs-comment">-- because add_wanted is commutative</span><span>
</span><span id="line-3222"></span><span>            </span><span id="local-6989586621683047469"><span class="annot"><a href="#local-6989586621683047469"><span class="hs-identifier hs-var hs-var">seeds3</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047466"><span class="hs-identifier hs-var">seeds2</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047463"><span class="hs-identifier hs-var">tcvs</span></a></span><span>
</span><span id="line-3223"></span><span>            </span><span id="local-6989586621683047470"><span class="annot"><a href="#local-6989586621683047470"><span class="hs-identifier hs-var hs-var">need_inner</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EvBindMap -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Tc.Types.Evidence.html#findNeededEvVars"><span class="hs-identifier hs-var">findNeededEvVars</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621683047462"><span class="hs-identifier hs-var">ev_binds</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047469"><span class="hs-identifier hs-var">seeds3</span></a></span><span>
</span><span id="line-3224"></span><span>            </span><span id="local-6989586621683047472"><span class="annot"><a href="#local-6989586621683047472"><span class="hs-identifier hs-var hs-var">live_ev_binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EvBind -&gt; Bool) -&gt; EvBindMap -&gt; EvBindMap
</span><a href="GHC.Tc.Types.Evidence.html#filterEvBindMap"><span class="hs-identifier hs-var">filterEvBindMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; EvBind -&gt; Bool
</span><a href="#local-6989586621683047474"><span class="hs-identifier hs-var">needed_ev_bind</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047470"><span class="hs-identifier hs-var">need_inner</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621683047462"><span class="hs-identifier hs-var">ev_binds</span></a></span><span>
</span><span id="line-3225"></span><span>            </span><span id="local-6989586621683047475"><span class="annot"><a href="#local-6989586621683047475"><span class="hs-identifier hs-var hs-var">need_outer</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; EvBindMap -&gt; VarSet
</span><a href="GHC.Tc.Types.Evidence.html#varSetMinusEvBindMap"><span class="hs-identifier hs-var">varSetMinusEvBindMap</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047470"><span class="hs-identifier hs-var">need_inner</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621683047472"><span class="hs-identifier hs-var">live_ev_binds</span></a></span><span>
</span><span id="line-3226"></span><span>                            </span><span class="annot"><span class="annottext">VarSet -&gt; [TcTyVar] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#delVarSetList"><span class="hs-operator hs-var">`delVarSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047458"><span class="hs-identifier hs-var">givens</span></a></span><span>
</span><span id="line-3227"></span><span>
</span><span id="line-3228"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#setTcEvBindsMap"><span class="hs-identifier hs-type">TcS.setTcEvBindsMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047459"><span class="hs-identifier hs-type">ev_binds_var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047472"><span class="hs-identifier hs-type">live_ev_binds</span></a></span><span>
</span><span id="line-3229"></span><span>           </span><span class="hs-comment">-- See Note [Delete dead Given evidence bindings]</span><span>
</span><span id="line-3230"></span><span>
</span><span id="line-3231"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;neededEvVars&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-3232"></span><span>        </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;old_needs:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047461"><span class="hs-identifier hs-type">old_needs</span></a></span><span>
</span><span id="line-3233"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;seeds3:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047469"><span class="hs-identifier hs-type">seeds3</span></a></span><span>
</span><span id="line-3234"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;tcvs:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047463"><span class="hs-identifier hs-type">tcvs</span></a></span><span>
</span><span id="line-3235"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ev_binds:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047462"><span class="hs-identifier hs-type">ev_binds</span></a></span><span>
</span><span id="line-3236"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;live_ev_binds:&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047472"><span class="hs-identifier hs-type">live_ev_binds</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3237"></span><span>
</span><span id="line-3238"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047457"><span class="hs-identifier hs-type">implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_need_inner"><span class="hs-identifier hs-var">ic_need_inner</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047470"><span class="hs-identifier hs-type">need_inner</span></a></span><span>
</span><span id="line-3239"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ic_need_outer"><span class="hs-identifier hs-var">ic_need_outer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047475"><span class="hs-identifier hs-type">need_outer</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3240"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3241"></span><span>   </span><span id="local-6989586621683047465"><span class="annot"><span class="annottext">add_implic_seeds :: Implication -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621683047465"><span class="hs-identifier hs-var hs-var">add_implic_seeds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implic"><span class="hs-identifier hs-type">Implic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ic_need_outer :: Implication -&gt; VarSet
</span><a href="GHC.Tc.Types.Constraint.html#ic_need_outer"><span class="hs-identifier hs-var">ic_need_outer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047478"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047478"><span class="hs-identifier hs-var">needs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683047479"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047479"><span class="hs-identifier hs-var">acc</span></a></span></span><span>
</span><span id="line-3242"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047478"><span class="hs-identifier hs-var">needs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047479"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-3243"></span><span>
</span><span id="line-3244"></span><span>   </span><span id="local-6989586621683047474"><span class="annot"><span class="annottext">needed_ev_bind :: VarSet -&gt; EvBind -&gt; Bool
</span><a href="#local-6989586621683047474"><span class="hs-identifier hs-var hs-var">needed_ev_bind</span></a></span></span><span> </span><span id="local-6989586621683047480"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047480"><span class="hs-identifier hs-var">needed</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBind"><span class="hs-identifier hs-type">EvBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eb_lhs :: EvBind -&gt; TcTyVar
</span><a href="GHC.Tc.Types.Evidence.html#eb_lhs"><span class="hs-identifier hs-var">eb_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047483"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047483"><span class="hs-identifier hs-var">ev_var</span></a></span></span><span>
</span><span id="line-3245"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eb_info :: EvBind -&gt; EvBindInfo
</span><a href="GHC.Tc.Types.Evidence.html#eb_info"><span class="hs-identifier hs-var">eb_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047485"><span class="annot"><span class="annottext">EvBindInfo
</span><a href="#local-6989586621683047485"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3246"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBindGiven"><span class="hs-identifier hs-type">EvBindGiven</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EvBindInfo
</span><a href="#local-6989586621683047485"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047483"><span class="hs-identifier hs-var">ev_var</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047480"><span class="hs-identifier hs-var">needed</span></a></span><span>
</span><span id="line-3247"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- Keep all wanted bindings</span><span>
</span><span id="line-3248"></span><span>
</span><span id="line-3249"></span><span>   </span><span class="annot"><a href="#local-6989586621683047468"><span class="hs-identifier hs-type">add_wanted</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBind"><span class="hs-identifier hs-type">EvBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-3250"></span><span>   </span><span id="local-6989586621683047468"><span class="annot"><span class="annottext">add_wanted :: EvBind -&gt; VarSet -&gt; VarSet
</span><a href="#local-6989586621683047468"><span class="hs-identifier hs-var hs-var">add_wanted</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBind"><span class="hs-identifier hs-type">EvBind</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">eb_info :: EvBind -&gt; EvBindInfo
</span><a href="GHC.Tc.Types.Evidence.html#eb_info"><span class="hs-identifier hs-var">eb_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047487"><span class="annot"><span class="annottext">EvBindInfo
</span><a href="#local-6989586621683047487"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">eb_rhs :: EvBind -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#eb_rhs"><span class="hs-identifier hs-var">eb_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047489"><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621683047489"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683047490"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047490"><span class="hs-identifier hs-var">needs</span></a></span></span><span>
</span><span id="line-3251"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBindGiven"><span class="hs-identifier hs-type">EvBindGiven</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EvBindInfo
</span><a href="#local-6989586621683047487"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047490"><span class="hs-identifier hs-var">needs</span></a></span><span>  </span><span class="hs-comment">-- Add the rhs vars of the Wanted bindings only</span><span>
</span><span id="line-3252"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EvTerm -&gt; VarSet
</span><a href="GHC.Tc.Types.Evidence.html#evVarsOfTerm"><span class="hs-identifier hs-var">evVarsOfTerm</span></a></span><span> </span><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621683047489"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047490"><span class="hs-identifier hs-var">needs</span></a></span><span>
</span><span id="line-3253"></span><span>
</span><span id="line-3254"></span><span class="hs-comment">-------------------------------------------------</span><span>
</span><span id="line-3255"></span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyDelayedErrors"><span class="hs-identifier hs-type">simplifyDelayedErrors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#DelayedError"><span class="hs-identifier hs-type">DelayedError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#DelayedError"><span class="hs-identifier hs-type">DelayedError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3256"></span><span class="hs-comment">-- Simplify any delayed errors: e.g. type and term holes</span><span>
</span><span id="line-3257"></span><span class="hs-comment">-- NB: At this point we have finished with all the simple</span><span>
</span><span id="line-3258"></span><span class="hs-comment">--     constraints; they are in wc_simple, not in the inert set.</span><span>
</span><span id="line-3259"></span><span class="hs-comment">--     So those Wanteds will not rewrite these delayed errors.</span><span>
</span><span id="line-3260"></span><span class="hs-comment">--     That's probably no bad thing.</span><span>
</span><span id="line-3261"></span><span class="hs-comment">--</span><span>
</span><span id="line-3262"></span><span class="hs-comment">--     However if we have [W] alpha ~ Maybe a, [W] alpha ~ Int</span><span>
</span><span id="line-3263"></span><span class="hs-comment">--     and _ : alpha, then we'll /unify/ alpha with the first of</span><span>
</span><span id="line-3264"></span><span class="hs-comment">--     the Wanteds we get, and thereby report (_ : Maybe a) or</span><span>
</span><span id="line-3265"></span><span class="hs-comment">--     (_ : Int) unpredictably, depending on which we happen to see</span><span>
</span><span id="line-3266"></span><span class="hs-comment">--     first.  Doesn't matter much; there is a type error anyhow.</span><span>
</span><span id="line-3267"></span><span class="hs-comment">--     T17139 is a case in point.</span><span>
</span><span id="line-3268"></span><span id="simplifyDelayedErrors"><span class="annot"><span class="annottext">simplifyDelayedErrors :: Bag DelayedError -&gt; TcS (Bag DelayedError)
</span><a href="GHC.Tc.Solver.html#simplifyDelayedErrors"><span class="hs-identifier hs-var hs-var">simplifyDelayedErrors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DelayedError -&gt; TcS DelayedError)
-&gt; Bag DelayedError -&gt; TcS (Bag DelayedError)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; Bag a -&gt; m (Bag b)
</span><a href="GHC.Data.Bag.html#mapBagM"><span class="hs-identifier hs-var">mapBagM</span></a></span><span> </span><span class="annot"><span class="annottext">DelayedError -&gt; TcS DelayedError
</span><a href="#local-6989586621683047492"><span class="hs-identifier hs-var">simpl_err</span></a></span><span>
</span><span id="line-3269"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3270"></span><span>    </span><span class="annot"><a href="#local-6989586621683047492"><span class="hs-identifier hs-type">simpl_err</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#DelayedError"><span class="hs-identifier hs-type">DelayedError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#DelayedError"><span class="hs-identifier hs-type">DelayedError</span></a></span><span>
</span><span id="line-3271"></span><span>    </span><span id="local-6989586621683047492"><span class="annot"><span class="annottext">simpl_err :: DelayedError -&gt; TcS DelayedError
</span><a href="#local-6989586621683047492"><span class="hs-identifier hs-var hs-var">simpl_err</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#DE_Hole"><span class="hs-identifier hs-type">DE_Hole</span></a></span><span> </span><span id="local-6989586621683047494"><span class="annot"><span class="annottext">Hole
</span><a href="#local-6989586621683047494"><span class="hs-identifier hs-var">hole</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hole -&gt; DelayedError
</span><a href="GHC.Tc.Types.Constraint.html#DE_Hole"><span class="hs-identifier hs-var">DE_Hole</span></a></span><span> </span><span class="annot"><span class="annottext">(Hole -&gt; DelayedError) -&gt; TcS Hole -&gt; TcS DelayedError
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Hole -&gt; TcS Hole
</span><a href="#local-6989586621683047495"><span class="hs-identifier hs-var">simpl_hole</span></a></span><span> </span><span class="annot"><span class="annottext">Hole
</span><a href="#local-6989586621683047494"><span class="hs-identifier hs-var">hole</span></a></span><span>
</span><span id="line-3272"></span><span>    </span><span class="annot"><a href="#local-6989586621683047492"><span class="hs-identifier hs-var">simpl_err</span></a></span><span> </span><span id="local-6989586621683047496"><span class="annot"><span class="annottext">err :: DelayedError
</span><a href="#local-6989586621683047496"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#DE_NotConcrete"><span class="hs-identifier hs-type">DE_NotConcrete</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DelayedError -&gt; TcS DelayedError
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">DelayedError
</span><a href="#local-6989586621683047496"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-3273"></span><span>
</span><span id="line-3274"></span><span>    </span><span class="annot"><a href="#local-6989586621683047495"><span class="hs-identifier hs-type">simpl_hole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Hole"><span class="hs-identifier hs-type">Hole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Hole"><span class="hs-identifier hs-type">Hole</span></a></span><span>
</span><span id="line-3275"></span><span>
</span><span id="line-3276"></span><span>     </span><span class="hs-comment">-- See Note [Do not simplify ConstraintHoles]</span><span>
</span><span id="line-3277"></span><span>    </span><span id="local-6989586621683047495"><span class="annot"><span class="annottext">simpl_hole :: Hole -&gt; TcS Hole
</span><a href="#local-6989586621683047495"><span class="hs-identifier hs-var hs-var">simpl_hole</span></a></span></span><span> </span><span id="local-6989586621683047498"><span class="annot"><span class="annottext">h :: Hole
</span><a href="#local-6989586621683047498"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Hole"><span class="hs-identifier hs-type">Hole</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">hole_sort :: Hole -&gt; HoleSort
</span><a href="GHC.Tc.Types.Constraint.html#hole_sort"><span class="hs-identifier hs-var">hole_sort</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HoleSort
</span><a href="GHC.Tc.Types.Constraint.html#ConstraintHole"><span class="hs-identifier hs-var">ConstraintHole</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hole -&gt; TcS Hole
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Hole
</span><a href="#local-6989586621683047498"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-3278"></span><span>
</span><span id="line-3279"></span><span>     </span><span class="hs-comment">-- other wildcards should be simplified for printing</span><span>
</span><span id="line-3280"></span><span>     </span><span class="hs-comment">-- we must do so here, and not in the error-message generation</span><span>
</span><span id="line-3281"></span><span>     </span><span class="hs-comment">-- code, because we have all the givens already set up</span><span>
</span><span id="line-3282"></span><span>    </span><span class="annot"><a href="#local-6989586621683047495"><span class="hs-identifier hs-var">simpl_hole</span></a></span><span> </span><span id="local-6989586621683047502"><span class="annot"><span class="annottext">h :: Hole
</span><a href="#local-6989586621683047502"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Hole"><span class="hs-identifier hs-type">Hole</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">hole_ty :: Hole -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#hole_ty"><span class="hs-identifier hs-var">hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047504"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047504"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hole_loc :: Hole -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#hole_loc"><span class="hs-identifier hs-var">hole_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047506"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683047506"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3283"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047507"><span class="annot"><a href="#local-6989586621683047507"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcType -&gt; TcS TcType
</span><a href="GHC.Tc.Solver.Rewrite.html#rewriteType"><span class="hs-identifier hs-var">rewriteType</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621683047506"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047504"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3284"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;simpl_hole&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047504"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047507"><span class="hs-identifier hs-type">ty'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3285"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047502"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#hole_ty"><span class="hs-identifier hs-var">hole_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683047507"><span class="hs-identifier hs-type">ty'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3286"></span><span>
</span><span id="line-3287"></span><span class="hs-comment">{- Note [Delete dead Given evidence bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
As a result of superclass expansion, we speculatively
generate evidence bindings for Givens. E.g.
   f :: (a ~ b) =&gt; a -&gt; b -&gt; Bool
   f x y = ...
We'll have
   [G] d1 :: (a~b)
and we'll speculatively generate the evidence binding
   [G] d2 :: (a ~# b) = sc_sel d

Now d2 is available for solving.  But it may not be needed!  Usually
such dead superclass selections will eventually be dropped as dead
code, but:

 * It won't always be dropped (#13032).  In the case of an
   unlifted-equality superclass like d2 above, we generate
       case heq_sc d1 of d2 -&gt; ...
   and we can't (in general) drop that case expression in case
   d1 is bottom.  So it's technically unsound to have added it
   in the first place.

 * Simply generating all those extra superclasses can generate lots of
   code that has to be zonked, only to be discarded later.  Better not
   to generate it in the first place.

   Moreover, if we simplify this implication more than once
   (e.g. because we can't solve it completely on the first iteration
   of simpl_loop), we'll generate all the same bindings AGAIN!

Easy solution: take advantage of the work we are doing to track dead
(unused) Givens, and use it to prune the Given bindings too.  This is
all done by neededEvVars.

This led to a remarkable 25% overall compiler allocation decrease in
test T12227.

But we don't get to discard all redundant equality superclasses, alas;
see #15205.

Note [Do not simplify ConstraintHoles]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Before printing the inferred value for a type hole (a _ wildcard in
a partial type signature), we simplify it w.r.t. any Givens. This
makes for an easier-to-understand diagnostic for the user.

However, we do not wish to do this for extra-constraint holes. Here is
the example for why (partial-sigs/should_compile/T12844):

  bar :: _ =&gt; FooData rngs
  bar = foo

  data FooData rngs

  class Foo xs where foo :: (Head xs ~ '(r,r')) =&gt; FooData xs

  type family Head (xs :: [k]) where Head (x ': xs) = x

GHC correctly infers that the extra-constraints wildcard on `bar`
should be (Head rngs ~ '(r, r'), Foo rngs). It then adds this
constraint as a Given on the implication constraint for `bar`. (This
implication is emitted by emitResidualConstraints.) The Hole for the _
is stored within the implication's WantedConstraints.  When
simplifyHoles is called, that constraint is already assumed as a
Given. Simplifying with respect to it turns it into ('(r, r') ~ '(r,
r'), Foo rngs), which is disastrous.

Furthermore, there is no need to simplify here: extra-constraints wildcards
are filled in with the output of the solver, in chooseInferredQuantifiers
(choose_psig_context), so they are already simplified. (Contrast to normal
type holes, which are just bound to a meta-variable.) Avoiding the poor output
is simple: just don't simplify extra-constraints wildcards.

This is the only reason we need to track ConstraintHole separately
from TypeHole in HoleSort.

See also Note [Extra-constraint holes in partial type signatures]
in GHC.Tc.Gen.HsType.

Note [Tracking redundant constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
With Opt_WarnRedundantConstraints, GHC can report which
constraints of a type signature (or instance declaration) are
redundant, and can be omitted.  Here is an overview of how it
works.

This is all tested in typecheck/should_compile/T20602 (among
others).

----- What is a redundant constraint?

* The things that can be redundant are precisely the Given
  constraints of an implication.

* A constraint can be redundant in two different ways:
  a) It is not needed by the Wanted constraints covered by the
     implication E.g.
       f :: Eq a =&gt; a -&gt; Bool
       f x = True  -- Equality not used
  b) It is implied by other givens.  E.g.
       f :: (Eq a, Ord a)     =&gt; blah   -- Eq a unnecessary
       g :: (Eq a, a~b, Eq b) =&gt; blah   -- Either Eq a or Eq b unnecessary

*  To find (a) we need to know which evidence bindings are 'wanted';
   hence the eb_is_given field on an EvBind.

*  To find (b), we use mkMinimalBySCs on the Givens to see if any
   are unnecessary.

----- How tracking works

(RC1) When two Givens are the same, we drop the evidence for the one
  that requires more superclass selectors. This is done
  according to 2(c) of Note [Replacement vs keeping] in GHC.Tc.Solver.InertSet.

(RC2) The ic_need fields of an Implic records in-scope (given) evidence
  variables bound by the context, that were needed to solve this
  implication (so far).  See the declaration of Implication.

(RC3) setImplicationStatus:
  When the constraint solver finishes solving all the wanteds in
  an implication, it sets its status to IC_Solved

  - The ics_dead field, of IC_Solved, records the subset of this
    implication's ic_given that are redundant (not needed).

  - We compute which evidence variables are needed by an implication
    in setImplicationStatus.  A variable is needed if
    a) it is free in the RHS of a Wanted EvBind,
    b) it is free in the RHS of an EvBind whose LHS is needed, or
    c) it is in the ics_need of a nested implication.

  - After computing which variables are needed, we then look at the
    remaining variables for internal redundancies. This is case (b)
    from above. This is also done in setImplicationStatus.
    Note that we only look for case (b) if case (a) shows up empty,
    as exemplified below.

  - We need to be careful not to discard an implication
    prematurely, even one that is fully solved, because we might
    thereby forget which variables it needs, and hence wrongly
    report a constraint as redundant.  But we can discard it once
    its free vars have been incorporated into its parent; or if it
    simply has no free vars. This careful discarding is also
    handled in setImplicationStatus.

(RC4) We do not want to report redundant constraints for implications
  that come from quantified constraints.  Example #23323:
     data T a
     instance Show (T a) where ...  -- No context!
     foo :: forall f c. (forall a. c a =&gt; Show (f a)) =&gt; Proxy c -&gt; f Int -&gt; Int
     bar = foo @T @Eq

  The call to `foo` gives us
    [W] d : (forall a. Eq a =&gt; Show (T a))
  To solve this, GHC.Tc.Solver.Solve.solveForAll makes an implication constraint:
    forall a. Eq a =&gt;  [W] ds : Show (T a)
  and because of the degnerate instance for `Show (T a)`, we don't need the `Eq a`
  constraint.  But we don't want to report it as redundant!

* Examples:

    f, g, h :: (Eq a, Ord a) =&gt; a -&gt; Bool
    f x = x == x
    g x = x &gt; x
    h x = x == x &amp;&amp; x &gt; x

    All three will discover that they have two [G] Eq a constraints:
    one as given and one extracted from the Ord a constraint. They will
    both discard the latter, as noted above and in
    Note [Replacement vs keeping] in GHC.Tc.Solver.InertSet.

    The body of f uses the [G] Eq a, but not the [G] Ord a. It will
    report a redundant Ord a using the logic for case (a).

    The body of g uses the [G] Ord a, but not the [G] Eq a. It will
    report a redundant Eq a using the logic for case (a).

    The body of h uses both [G] Ord a and [G] Eq a. Case (a) will
    thus come up with nothing redundant. But then, the case (b)
    check will discover that Eq a is redundant and report this.

    If we did case (b) even when case (a) reports something, then
    we would report both constraints as redundant for f, which is
    terrible.

----- Reporting redundant constraints

* GHC.Tc.Errors does the actual warning, in warnRedundantConstraints.

* We don't report redundant givens for *every* implication; only
  for those which reply True to GHC.Tc.Solver.warnRedundantGivens:

   - For example, in a class declaration, the default method *can*
     use the class constraint, but it certainly doesn't *have* to,
     and we don't want to report an error there.  Ditto instance decls.

   - More subtly, in a function definition
       f :: (Ord a, Ord a, Ix a) =&gt; a -&gt; a
       f x = rhs
     we do an ambiguity check on the type (which would find that one
     of the Ord a constraints was redundant), and then we check that
     the definition has that type (which might find that both are
     redundant).  We don't want to report the same error twice, so we
     disable it for the ambiguity check.  Hence using two different
     FunSigCtxts, one with the warn-redundant field set True, and the
     other set False in
        - GHC.Tc.Gen.Bind.tcSpecPrag
        - GHC.Tc.Gen.Bind.tcTySig

  This decision is taken in setImplicationStatus, rather than GHC.Tc.Errors
  so that we can discard implication constraints that we don't need.
  So ics_dead consists only of the *reportable* redundant givens.

----- Shortcomings

Shortcoming 1.  Consider

  j :: (Eq a, a ~ b) =&gt; a -&gt; Bool
  j x = x == x

  k :: (Eq a, b ~ a) =&gt; a -&gt; Bool
  k x = x == x

Currently (Nov 2021), j issues no warning, while k says that b ~ a
is redundant. This is because j uses the a ~ b constraint to rewrite
everything to be in terms of b, while k does none of that. This is
ridiculous, but I (Richard E) don't see a good fix.

Shortcoming 2.  Removing a redundant constraint can cause clients to fail to
compile, by making the function more polymoprhic. Consider (#16154)

  f :: (a ~ Bool) =&gt; a -&gt; Int
  f x = 3

  g :: String -&gt; Int
  g s = f (read s)

The constraint in f's signature is redundant; not used to typecheck
`f`.  And yet if you remove it, `g` won't compile, because there'll
be an ambiguous variable in `g`.
-}</span><span>
</span><span id="line-3529"></span><span>
</span><span id="line-3530"></span><span class="hs-keyword">type</span><span> </span><span id="UnificationDone"><span class="annot"><a href="GHC.Tc.Solver.html#UnificationDone"><span class="hs-identifier hs-var">UnificationDone</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3531"></span><span>
</span><span id="line-3532"></span><span class="annot"><a href="GHC.Tc.Solver.html#noUnification"><span class="hs-identifier hs-type">noUnification</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#didUnification"><span class="hs-identifier hs-type">didUnification</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#UnificationDone"><span class="hs-identifier hs-type">UnificationDone</span></a></span><span>
</span><span id="line-3533"></span><span id="noUnification"><span class="annot"><span class="annottext">noUnification :: Bool
</span><a href="GHC.Tc.Solver.html#noUnification"><span class="hs-identifier hs-var hs-var">noUnification</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3534"></span><span id="didUnification"><span class="annot"><span class="annottext">didUnification :: Bool
</span><a href="GHC.Tc.Solver.html#didUnification"><span class="hs-identifier hs-var hs-var">didUnification</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3535"></span><span>
</span><span id="line-3536"></span><span class="annot"><span class="hs-comment">-- | Like 'defaultTyVar', but in the TcS monad.</span></span><span>
</span><span id="line-3537"></span><span class="annot"><a href="GHC.Tc.Solver.html#defaultTyVarTcS"><span class="hs-identifier hs-type">defaultTyVarTcS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#UnificationDone"><span class="hs-identifier hs-type">UnificationDone</span></a></span><span>
</span><span id="line-3538"></span><span id="defaultTyVarTcS"><span class="annot"><span class="annottext">defaultTyVarTcS :: TcTyVar -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#defaultTyVarTcS"><span class="hs-identifier hs-var hs-var">defaultTyVarTcS</span></a></span></span><span> </span><span id="local-6989586621683047511"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span></span><span>
</span><span id="line-3539"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isTyVarTyVar"><span class="hs-identifier hs-var">isTyVarTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span>
</span><span id="line-3540"></span><span>    </span><span class="hs-comment">-- TyVarTvs should only be unified with a tyvar</span><span>
</span><span id="line-3541"></span><span>    </span><span class="hs-comment">-- never with a type; c.f. GHC.Tc.Utils.TcMType.defaultTyVar</span><span>
</span><span id="line-3542"></span><span>    </span><span class="hs-comment">-- and Note [Inferring kinds for type declarations] in GHC.Tc.TyCl</span><span>
</span><span id="line-3543"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Tc.Solver.html#noUnification"><span class="hs-identifier hs-var">noUnification</span></a></span><span>
</span><span id="line-3544"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Core.Type.html#isRuntimeRepVar"><span class="hs-identifier hs-var">isRuntimeRepVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span>
</span><span id="line-3545"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defaultTyVarTcS RuntimeRep&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3546"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Builtin.Types.html#liftedRepTy"><span class="hs-identifier hs-var">liftedRepTy</span></a></span><span>
</span><span id="line-3547"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Tc.Solver.html#didUnification"><span class="hs-identifier hs-var">didUnification</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3548"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Core.Type.html#isLevityVar"><span class="hs-identifier hs-var">isLevityVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span>
</span><span id="line-3549"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defaultTyVarTcS Levity&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3550"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Builtin.Types.html#liftedDataConTy"><span class="hs-identifier hs-var">liftedDataConTy</span></a></span><span>
</span><span id="line-3551"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Tc.Solver.html#didUnification"><span class="hs-identifier hs-var">didUnification</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3552"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Core.Type.html#isMultiplicityVar"><span class="hs-identifier hs-var">isMultiplicityVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span>
</span><span id="line-3553"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defaultTyVarTcS Multiplicity&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3554"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047511"><span class="hs-identifier hs-var">the_tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span>
</span><span id="line-3555"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Tc.Solver.html#didUnification"><span class="hs-identifier hs-var">didUnification</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3556"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3557"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Tc.Solver.html#noUnification"><span class="hs-identifier hs-var">noUnification</span></a></span><span>  </span><span class="hs-comment">-- the common case</span><span>
</span><span id="line-3558"></span><span>
</span><span id="line-3559"></span><span class="annot"><a href="GHC.Tc.Solver.html#approximateWC"><span class="hs-identifier hs-type">approximateWC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- See Wrinkle (W3) in Note [ApproximateWC]</span><span>
</span><span id="line-3560"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-3561"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Cts"><span class="hs-identifier hs-type">Cts</span></a></span><span>
</span><span id="line-3562"></span><span class="hs-comment">-- Second return value is the depleted wc</span><span>
</span><span id="line-3563"></span><span class="hs-comment">-- Postcondition: Wanted Cts</span><span>
</span><span id="line-3564"></span><span class="hs-comment">-- See Note [ApproximateWC]</span><span>
</span><span id="line-3565"></span><span class="hs-comment">-- See Note [floatKindEqualities vs approximateWC]</span><span>
</span><span id="line-3566"></span><span id="approximateWC"><span class="annot"><span class="annottext">approximateWC :: Bool -&gt; WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Solver.html#approximateWC"><span class="hs-identifier hs-var hs-var">approximateWC</span></a></span></span><span> </span><span id="local-6989586621683047517"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047517"><span class="hs-identifier hs-var">float_past_equalities</span></a></span></span><span> </span><span id="local-6989586621683047518"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047518"><span class="hs-identifier hs-var">wc</span></a></span></span><span>
</span><span id="line-3567"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; VarSet -&gt; WantedConstraints -&gt; Cts
</span><a href="#local-6989586621683047519"><span class="hs-identifier hs-var">float_wc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047518"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-3568"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3569"></span><span>    </span><span class="annot"><a href="#local-6989586621683047519"><span class="hs-identifier hs-type">float_wc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>           </span><span class="hs-comment">-- True &lt;=&gt; there are enclosing equalities</span><span>
</span><span id="line-3570"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a></span><span>   </span><span class="hs-comment">-- Enclosing skolem binders</span><span>
</span><span id="line-3571"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Cts"><span class="hs-identifier hs-type">Cts</span></a></span><span>
</span><span id="line-3572"></span><span>    </span><span id="local-6989586621683047519"><span class="annot"><span class="annottext">float_wc :: Bool -&gt; VarSet -&gt; WantedConstraints -&gt; Cts
</span><a href="#local-6989586621683047519"><span class="hs-identifier hs-var hs-var">float_wc</span></a></span></span><span> </span><span id="local-6989586621683047520"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047520"><span class="hs-identifier hs-var">encl_eqs</span></a></span></span><span> </span><span id="local-6989586621683047521"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047521"><span class="hs-identifier hs-var">trapping_tvs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047522"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047522"><span class="hs-identifier hs-var">simples</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047523"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047523"><span class="hs-identifier hs-var">implics</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3573"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Bool) -&gt; Cts -&gt; Cts
forall a. (a -&gt; Bool) -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#filterBag"><span class="hs-identifier hs-var">filterBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; VarSet -&gt; Ct -&gt; Bool
</span><a href="#local-6989586621683047524"><span class="hs-identifier hs-var">is_floatable</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047520"><span class="hs-identifier hs-var">encl_eqs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047521"><span class="hs-identifier hs-var">trapping_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047522"><span class="hs-identifier hs-var">simples</span></a></span><span> </span><span class="annot"><span class="annottext">Cts -&gt; Cts -&gt; Cts
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span>
</span><span id="line-3574"></span><span>        </span><span class="annot"><span class="annottext">(Implication -&gt; Cts) -&gt; Bag Implication -&gt; Cts
forall a b. (a -&gt; Bag b) -&gt; Bag a -&gt; Bag b
</span><a href="GHC.Data.Bag.html#concatMapBag"><span class="hs-identifier hs-var">concatMapBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; VarSet -&gt; Implication -&gt; Cts
</span><a href="#local-6989586621683047526"><span class="hs-identifier hs-var">float_implic</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047520"><span class="hs-identifier hs-var">encl_eqs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047521"><span class="hs-identifier hs-var">trapping_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047523"><span class="hs-identifier hs-var">implics</span></a></span><span>
</span><span id="line-3575"></span><span>
</span><span id="line-3576"></span><span>    </span><span class="annot"><a href="#local-6989586621683047526"><span class="hs-identifier hs-type">float_implic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Implication"><span class="hs-identifier hs-type">Implication</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Cts"><span class="hs-identifier hs-type">Cts</span></a></span><span>
</span><span id="line-3577"></span><span>    </span><span id="local-6989586621683047526"><span class="annot"><span class="annottext">float_implic :: Bool -&gt; VarSet -&gt; Implication -&gt; Cts
</span><a href="#local-6989586621683047526"><span class="hs-identifier hs-var hs-var">float_implic</span></a></span></span><span> </span><span id="local-6989586621683047527"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047527"><span class="hs-identifier hs-var">encl_eqs</span></a></span></span><span> </span><span id="local-6989586621683047528"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047528"><span class="hs-identifier hs-var">trapping_tvs</span></a></span></span><span> </span><span id="local-6989586621683047529"><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047529"><span class="hs-identifier hs-var">imp</span></a></span></span><span>
</span><span id="line-3578"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; VarSet -&gt; WantedConstraints -&gt; Cts
</span><a href="#local-6989586621683047519"><span class="hs-identifier hs-var">float_wc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047530"><span class="hs-identifier hs-var">new_encl_eqs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047531"><span class="hs-identifier hs-var">new_trapping_tvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047529"><span class="hs-identifier hs-var">imp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3579"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3580"></span><span>        </span><span id="local-6989586621683047531"><span class="annot"><span class="annottext">new_trapping_tvs :: VarSet
</span><a href="#local-6989586621683047531"><span class="hs-identifier hs-var hs-var">new_trapping_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047528"><span class="hs-identifier hs-var">trapping_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [TcTyVar] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSetList"><span class="hs-operator hs-var">`extendVarSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">Implication -&gt; [TcTyVar]
</span><a href="GHC.Tc.Types.Constraint.html#ic_skols"><span class="hs-identifier hs-var">ic_skols</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047529"><span class="hs-identifier hs-var">imp</span></a></span><span>
</span><span id="line-3581"></span><span>        </span><span id="local-6989586621683047530"><span class="annot"><span class="annottext">new_encl_eqs :: Bool
</span><a href="#local-6989586621683047530"><span class="hs-identifier hs-var hs-var">new_encl_eqs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047527"><span class="hs-identifier hs-var">encl_eqs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Implication -&gt; HasGivenEqs
</span><a href="GHC.Tc.Types.Constraint.html#ic_given_eqs"><span class="hs-identifier hs-var">ic_given_eqs</span></a></span><span> </span><span class="annot"><span class="annottext">Implication
</span><a href="#local-6989586621683047529"><span class="hs-identifier hs-var">imp</span></a></span><span> </span><span class="annot"><span class="annottext">HasGivenEqs -&gt; HasGivenEqs -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">HasGivenEqs
</span><a href="GHC.Tc.Types.Constraint.html#MaybeGivenEqs"><span class="hs-identifier hs-var">MaybeGivenEqs</span></a></span><span>
</span><span id="line-3582"></span><span>
</span><span id="line-3583"></span><span>    </span><span id="local-6989586621683047524"><span class="annot"><span class="annottext">is_floatable :: Bool -&gt; VarSet -&gt; Ct -&gt; Bool
</span><a href="#local-6989586621683047524"><span class="hs-identifier hs-var hs-var">is_floatable</span></a></span></span><span> </span><span id="local-6989586621683047532"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047532"><span class="hs-identifier hs-var">encl_eqs</span></a></span></span><span> </span><span id="local-6989586621683047533"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047533"><span class="hs-identifier hs-var">skol_tvs</span></a></span></span><span> </span><span id="local-6989586621683047534"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047534"><span class="hs-identifier hs-var">ct</span></a></span></span><span>
</span><span id="line-3584"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGivenCt"><span class="hs-identifier hs-var">isGivenCt</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047534"><span class="hs-identifier hs-var">ct</span></a></span><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3585"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#insolubleCt"><span class="hs-identifier hs-var">insolubleCt</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047534"><span class="hs-identifier hs-var">ct</span></a></span><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3586"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; VarSet
</span><a href="GHC.Tc.Types.Constraint.html#tyCoVarsOfCt"><span class="hs-identifier hs-var">tyCoVarsOfCt</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047534"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-var">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047533"><span class="hs-identifier hs-var">skol_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3587"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3588"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047534"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3589"></span><span>           </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047517"><span class="hs-identifier hs-var">float_past_equalities</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047532"><span class="hs-identifier hs-var">encl_eqs</span></a></span><span>
</span><span id="line-3590"></span><span>                                  </span><span class="hs-comment">-- See Wrinkle (W1)</span><span>
</span><span id="line-3591"></span><span>           </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-comment">-- See Wrinkle (W2)</span><span>
</span><span id="line-3592"></span><span>           </span><span class="annot"><a href="GHC.Core.Predicate.html#IrredPred"><span class="hs-identifier hs-type">IrredPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-comment">-- ..both in Note [ApproximateWC]</span><span>
</span><span id="line-3593"></span><span>           </span><span class="annot"><a href="GHC.Core.Predicate.html#ForAllPred"><span class="hs-identifier hs-type">ForAllPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3594"></span><span>
</span><span id="line-3595"></span><span class="hs-comment">{- Note [ApproximateWC]
~~~~~~~~~~~~~~~~~~~~~~~
approximateWC takes a constraint, typically arising from the RHS of a
let-binding whose type we are *inferring*, and extracts from it some
*simple* constraints that we might plausibly abstract over.  Of course
the top-level simple constraints are plausible, but we also float constraints
out from inside, if they are not captured by skolems.

The same function is used when doing type-class defaulting (see the call
to applyDefaultingRules) to extract constraints that might be defaulted.

Wrinkle (W1)
  When inferring most-general types (in simplifyInfer), we
  do *not* float an equality constraint if the implication binds
  equality constraints, because that defeats the OutsideIn story.
  Consider data T a where TInt :: T Int MkT :: T a

         f TInt = 3::Int

  We get the implication (a ~ Int =&gt; res ~ Int), where so far we've decided
     f :: T a -&gt; res
  We don't want to float (res~Int) out because then we'll infer
     f :: T a -&gt; Int
  which is only on of the possible types. (GHC 7.6 accidentally *did*
  float out of such implications, which meant it would happily infer
  non-principal types.)

Wrinkle (W2)
  We do allow /class/ constraints to float, even if
  the implication binds equalities.  This is a subtle point: see #23224.
  In principle, a class constraint might ultimately be satisfiable from
  a constraint bound by an implication (see #19106 for an example of this
  kind), but it's extremely obscure and I was unable to construct a
  concrete example.  In any case, in super-subtle cases where this might
  make a difference, you would be much better advised to simply write a
  type signature.

  I included IrredPred here too, for good measure.  In general,
  abstracting over more constraints does no harm.

Wrinkle (W3)
  In findDefaultableGroups we are not worried about the
  most-general type; and we /do/ want to float out of equalities
  (#12797).  Hence the boolean flag to approximateWC.

------ Historical note -----------
There used to be a second caveat, driven by #8155

   2. We do not float out an inner constraint that shares a type variable
      (transitively) with one that is trapped by a skolem.  Eg
          forall a.  F a ~ beta, Integral beta
      We don't want to float out (Integral beta).  Doing so would be bad
      when defaulting, because then we'll default beta:=Integer, and that
      makes the error message much worse; we'd get
          Can't solve  F a ~ Integer
      rather than
          Can't solve  Integral (F a)

      Moreover, floating out these &quot;contaminated&quot; constraints doesn't help
      when generalising either. If we generalise over (Integral b), we still
      can't solve the retained implication (forall a. F a ~ b).  Indeed,
      arguably that too would be a harder error to understand.

But this transitive closure stuff gives rise to a complex rule for
when defaulting actually happens, and one that was never documented.
Moreover (#12923), the more complex rule is sometimes NOT what
you want.  So I simply removed the extra code to implement the
contamination stuff.  There was zero effect on the testsuite (not even #8155).
------ End of historical note -----------

Note [DefaultTyVar]
~~~~~~~~~~~~~~~~~~~
defaultTyVar is used on any un-instantiated meta type variables to
default any RuntimeRep variables to LiftedRep.  This is important
to ensure that instance declarations match.  For example consider

     instance Show (a-&gt;b)
     foo x = show (\_ -&gt; True)

Then we'll get a constraint (Show (p -&gt;q)) where p has kind (TYPE r),
and that won't match the typeKind (*) in the instance decl.  See tests
tc217 and tc175.

We look only at touchable type variables. No further constraints
are going to affect these type variables, so it's time to do it by
hand.  However we aren't ready to default them fully to () or
whatever, because the type-class defaulting rules have yet to run.

An alternate implementation would be to emit a Wanted constraint setting
the RuntimeRep variable to LiftedRep, but this seems unnecessarily indirect.

Note [Promote _and_ default when inferring]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we are inferring a type, we simplify the constraint, and then use
approximateWC to produce a list of candidate constraints.  Then we MUST

  a) Promote any meta-tyvars that have been floated out by
     approximateWC, to restore invariant (WantedInv) described in
     Note [TcLevel invariants] in GHC.Tc.Utils.TcType.

  b) Default the kind of any meta-tyvars that are not mentioned in
     in the environment.

To see (b), suppose the constraint is (C ((a :: OpenKind) -&gt; Int)), and we
have an instance (C ((x:*) -&gt; Int)).  The instance doesn't match -- but it
should!  If we don't solve the constraint, we'll stupidly quantify over
(C (a-&gt;Int)) and, worse, in doing so skolemiseQuantifiedTyVar will quantify over
(b:*) instead of (a:OpenKind), which can lead to disaster; see #7332.
#7641 is a simpler example.

Note [Promoting unification variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we float an equality out of an implication we must &quot;promote&quot; free
unification variables of the equality, in order to maintain Invariant
(WantedInv) from Note [TcLevel invariants] in GHC.Tc.Types.TcType.

This is absolutely necessary. Consider the following example. We start
with two implications and a class with a functional dependency.

    class C x y | x -&gt; y
    instance C [a] [a]

    (I1)      [untch=beta]forall b. 0 =&gt; F Int ~ [beta]
    (I2)      [untch=beta]forall c. 0 =&gt; F Int ~ [[alpha]] /\ C beta [c]

We float (F Int ~ [beta]) out of I1, and we float (F Int ~ [[alpha]]) out of I2.
They may react to yield that (beta := [alpha]) which can then be pushed inwards
the leftover of I2 to get (C [alpha] [a]) which, using the FunDep, will mean that
(alpha := a). In the end we will have the skolem 'b' escaping in the untouchable
beta! Concrete example is in indexed_types/should_fail/ExtraTcsUntch.hs:

    class C x y | x -&gt; y where
     op :: x -&gt; y -&gt; ()

    instance C [a] [a]

    type family F a :: *

    h :: F Int -&gt; ()
    h = undefined

    data TEx where
      TEx :: a -&gt; TEx

    f (x::beta) =
        let g1 :: forall b. b -&gt; ()
            g1 _ = h [x]
            g2 z = case z of TEx y -&gt; (h [[undefined]], op x [y])
        in (g1 '3', g2 undefined)


*********************************************************************************
*                                                                               *
*                          Defaulting and disambiguation                        *
*                                                                               *
*********************************************************************************

Note [How type-class constraints are defaulted]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Type-class defaulting deals with the situation where we have unsolved
constraints like (Num alpha), where `alpha` is a unification variable.  We want
to pick a default for `alpha`, such as `alpha := Int` to resolve the ambiguity.

Type-class defaulting is guided by the `DefaultEnv`: see Note [Named default declarations]
in GHC.Tc.Gen.Default

The entry point for defaulting the unsolved constraints is `applyDefaultingRules`,
which depends on `disambigGroup`, which in turn depends on workhorse
`disambigProposalSequences`. The latter is also used by defaulting plugins through
`disambigMultiGroup` (see Note [Defaulting plugins] below).

The algorithm works as follows. Let S be the complete set of unsolved
constraints, and initialize Sx to an empty set of constraints. For every type
variable `v` that is free in S:

1. Define Cv = { Ci v | Ci v &#8712; S }, the subset of S consisting of all constraints in S of
   form (Ci v), where Ci is a single-parameter type class.  (We do no defaulting for
   multi-parameter type classes.)

2. Define Dv, by extending Cv with the superclasses of every Ci in Cv

3. Define Ev, by filtering Dv to contain only classes with a default declaration.

4. For each Ci in Ev, if Ci has a non-empty default list in the `DefaultEnv`, find the first
   type T in the default list for Ci for which, for every (Ci v) in Cv, the constraint (Ci T)
  is soluble.

5. If there is precisely one type T in the resulting type set, resolve the ambiguity by adding
   a constraint (v~ Ti) constraint to a set Sx; otherwise report a static error.

Note [Defaulting plugins]
~~~~~~~~~~~~~~~~~~~~~~~~~
Defaulting plugins enable extending or overriding the defaulting
behaviour. In `applyDefaultingRules`, before the built-in defaulting
mechanism runs, the loaded defaulting plugins are passed the
`WantedConstraints` and get a chance to propose defaulting assignments
based on them.

Proposals are represented as `[DefaultingProposal]` with each proposal
consisting of a type variable to fill-in, the list of defaulting types to
try in order, and a set of constraints to check at each try. This is
the same representation (albeit in a nicely packaged-up data type) as
the candidates generated by the built-in defaulting mechanism, so the
actual trying of proposals is done by the same `disambigGroup` function.

Wrinkle (DP1): The role of `WantedConstraints`

  Plugins are passed `WantedConstraints` that can perhaps be
  progressed on by defaulting. But a defaulting plugin is not a solver
  plugin, its job is to provide defaulting proposals, i.e. mappings of
  type variable to types. How do plugins know which type variables
  they are supposed to default?

  The `WantedConstraints` passed to the defaulting plugin are zonked
  beforehand to ensure all remaining metavariables are unfilled. Thus,
  the `WantedConstraints` serve a dual purpose: they are both the
  constraints of the given context that can act as hints to the
  defaulting, as well as the containers of the type variables under
  consideration for defaulting.

Wrinkle (DP2): Interactions between defaulting mechanisms

  In the general case, we have multiple defaulting plugins loaded and
  there is also the built-in defaulting mechanism. In this case, we
  have to be careful to keep the `WantedConstraints` passed to the
  plugins up-to-date by zonking between successful defaulting
  rounds. Otherwise, two plugins might come up with a defaulting
  proposal for the same metavariable; if the first one is accepted by
  `disambigGroup` (thus the meta gets filled), the second proposal
  becomes invalid (see #23821 for an example).

-}</span><span>
</span><span id="line-3827"></span><span>
</span><span id="line-3828"></span><span class="annot"><a href="GHC.Tc.Solver.html#tryTypeClassDefaulting"><span class="hs-identifier hs-type">tryTypeClassDefaulting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-3829"></span><span id="tryTypeClassDefaulting"><span class="annot"><span class="annottext">tryTypeClassDefaulting :: WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#tryTypeClassDefaulting"><span class="hs-identifier hs-var hs-var">tryTypeClassDefaulting</span></a></span></span><span> </span><span id="local-6989586621683047536"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047536"><span class="hs-identifier hs-var">wc</span></a></span></span><span>
</span><span id="line-3830"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047536"><span class="hs-identifier hs-var">wc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#insolubleWC"><span class="hs-identifier hs-var">insolubleWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047536"><span class="hs-identifier hs-var">wc</span></a></span><span> </span><span class="hs-comment">-- See Note [Defaulting insolubles]</span><span>
</span><span id="line-3831"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047536"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-3832"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- See Note [When to do type-class defaulting]</span><span>
</span><span id="line-3833"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047537"><span class="annot"><a href="#local-6989586621683047537"><span class="hs-identifier hs-var">something_happened</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#applyDefaultingRules"><span class="hs-identifier hs-var">applyDefaultingRules</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047536"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-3834"></span><span>                               </span><span class="hs-comment">-- See Note [Top-level Defaulting Plan]</span><span>
</span><span id="line-3835"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#solveAgainIf"><span class="hs-identifier hs-type">solveAgainIf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047537"><span class="hs-identifier hs-type">something_happened</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047536"><span class="hs-identifier hs-type">wc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3836"></span><span>
</span><span id="line-3837"></span><span class="annot"><a href="GHC.Tc.Solver.html#applyDefaultingRules"><span class="hs-identifier hs-type">applyDefaultingRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3838"></span><span class="hs-comment">-- True &lt;=&gt; I did some defaulting, by unifying a meta-tyvar</span><span>
</span><span id="line-3839"></span><span class="hs-comment">-- Input WantedConstraints are not necessarily zonked</span><span>
</span><span id="line-3840"></span><span class="hs-comment">-- See Note [How type-class constraints are defaulted]</span><span>
</span><span id="line-3841"></span><span>
</span><span id="line-3842"></span><span id="applyDefaultingRules"><span class="annot"><span class="annottext">applyDefaultingRules :: WantedConstraints -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#applyDefaultingRules"><span class="hs-identifier hs-var hs-var">applyDefaultingRules</span></a></span></span><span> </span><span id="local-6989586621683047539"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047539"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>
</span><span id="line-3843"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047539"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-3844"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3845"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3846"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047540"><span class="annot"><a href="#local-6989586621683047540"><span class="hs-identifier hs-var">default_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047541"><span class="annot"><a href="#local-6989586621683047541"><span class="hs-identifier hs-var">extended_rules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (DefaultEnv, Bool)
</span><a href="GHC.Tc.Solver.Monad.html#getDefaultInfo"><span class="hs-identifier hs-var">getDefaultInfo</span></a></span><span>
</span><span id="line-3847"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047543"><span class="annot"><a href="#local-6989586621683047543"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>                       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#zonkWC"><span class="hs-identifier hs-type">TcS.zonkWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047539"><span class="hs-identifier hs-type">wanteds</span></a></span><span>
</span><span id="line-3848"></span><span>
</span><span id="line-3849"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047545"><span class="annot"><a href="#local-6989586621683047545"><span class="hs-identifier hs-var">tcg_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getGblEnv"><span class="hs-identifier hs-type">TcS.getGblEnv</span></a></span><span>
</span><span id="line-3850"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047547"><span class="annot"><a href="#local-6989586621683047547"><span class="hs-identifier hs-var hs-var">plugins</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; [FillDefaulting]
</span><a href="GHC.Tc.Types.html#tcg_defaulting_plugins"><span class="hs-identifier hs-var">tcg_defaulting_plugins</span></a></span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621683047545"><span class="hs-identifier hs-var">tcg_env</span></a></span><span>
</span><span id="line-3851"></span><span>             </span><span id="local-6989586621683047549"><span class="annot"><a href="#local-6989586621683047549"><span class="hs-identifier hs-var hs-var">default_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DefaultEnv -&gt; [ClassDefaults]
</span><a href="GHC.Types.DefaultEnv.html#defaultList"><span class="hs-identifier hs-var">defaultList</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultEnv
</span><a href="#local-6989586621683047540"><span class="hs-identifier hs-var">default_env</span></a></span><span>
</span><span id="line-3852"></span><span>             </span><span class="hs-comment">-- see Note [Named default declarations] in GHC.Tc.Gen.Default</span><span>
</span><span id="line-3853"></span><span>
</span><span id="line-3854"></span><span>       </span><span class="hs-comment">-- Run any defaulting plugins</span><span>
</span><span id="line-3855"></span><span>       </span><span class="hs-comment">-- See Note [Defaulting plugins] for an overview</span><span>
</span><span id="line-3856"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047550"><span class="annot"><a href="#local-6989586621683047550"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047551"><span class="annot"><a href="#local-6989586621683047551"><span class="hs-identifier hs-var">plugin_defaulted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683047547"><span class="hs-identifier hs-type">plugins</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047543"><span class="hs-identifier hs-type">wanteds</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-3857"></span><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-3858"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;defaultingPlugins {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047543"><span class="hs-identifier hs-type">wanteds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3859"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047552"><span class="annot"><a href="#local-6989586621683047552"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047553"><span class="annot"><a href="#local-6989586621683047553"><span class="hs-identifier hs-var">defaultedGroups</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier hs-type">mapAccumLM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047555"><span class="hs-identifier hs-type">run_defaulting_plugin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047543"><span class="hs-identifier hs-type">wanteds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047547"><span class="hs-identifier hs-type">plugins</span></a></span><span>
</span><span id="line-3860"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;defaultingPlugins }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047553"><span class="hs-identifier hs-type">defaultedGroups</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3861"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047552"><span class="hs-identifier hs-type">wanteds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047553"><span class="hs-identifier hs-type">defaultedGroups</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3862"></span><span>             </span><span class="hs-special">}</span><span>
</span><span id="line-3863"></span><span>
</span><span id="line-3864"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047556"><span class="annot"><a href="#local-6989586621683047556"><span class="hs-identifier hs-var hs-var">groups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([ClassDefaults], Bool) -&gt; WantedConstraints -&gt; [(TcTyVar, [Ct])]
</span><a href="GHC.Tc.Solver.html#findDefaultableGroups"><span class="hs-identifier hs-var">findDefaultableGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ClassDefaults]
</span><a href="#local-6989586621683047549"><span class="hs-identifier hs-var">default_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047541"><span class="hs-identifier hs-var">extended_rules</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047550"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-3865"></span><span>
</span><span id="line-3866"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;applyDefaultingRules {&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-3867"></span><span>                  </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;wanteds =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047550"><span class="hs-identifier hs-type">wanteds</span></a></span><span>
</span><span id="line-3868"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;groups  =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047556"><span class="hs-identifier hs-type">groups</span></a></span><span>
</span><span id="line-3869"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;info    =&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047549"><span class="hs-identifier hs-type">default_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047541"><span class="hs-identifier hs-type">extended_rules</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3870"></span><span>
</span><span id="line-3871"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047558"><span class="annot"><a href="#local-6989586621683047558"><span class="hs-identifier hs-var">something_happeneds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#disambigGroup"><span class="hs-identifier hs-type">disambigGroup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047550"><span class="hs-identifier hs-type">wanteds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047549"><span class="hs-identifier hs-type">default_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683047556"><span class="hs-identifier hs-type">groups</span></a></span><span>
</span><span id="line-3872"></span><span>
</span><span id="line-3873"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;applyDefaultingRules }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047558"><span class="hs-identifier hs-type">something_happeneds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3874"></span><span>
</span><span id="line-3875"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">or</span></span><span> </span><span class="annot"><a href="#local-6989586621683047558"><span class="hs-identifier hs-type">something_happeneds</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">or</span></span><span> </span><span class="annot"><a href="#local-6989586621683047551"><span class="hs-identifier hs-type">plugin_defaulted</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3876"></span><span>
</span><span id="line-3877"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-3878"></span><span>      </span><span id="local-6989586621683047555"><span class="annot"><span class="annottext">run_defaulting_plugin :: WantedConstraints
-&gt; FillDefaulting -&gt; TcS (WantedConstraints, Bool)
</span><a href="#local-6989586621683047555"><span class="hs-identifier hs-var hs-var">run_defaulting_plugin</span></a></span></span><span> </span><span id="local-6989586621683047571"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047571"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span> </span><span id="local-6989586621683047572"><span class="annot"><span class="annottext">FillDefaulting
</span><a href="#local-6989586621683047572"><span class="hs-identifier hs-var">p</span></a></span></span><span>
</span><span id="line-3879"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047573"><span class="annot"><a href="#local-6989586621683047573"><span class="hs-identifier hs-var">groups</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPluginM [DefaultingProposal] -&gt; TcS [DefaultingProposal]
forall a. TcPluginM a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#runTcPluginTcS"><span class="hs-identifier hs-var">runTcPluginTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FillDefaulting
</span><a href="#local-6989586621683047572"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047571"><span class="hs-identifier hs-var">wanteds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3880"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047575"><span class="annot"><a href="#local-6989586621683047575"><span class="hs-identifier hs-var">defaultedGroups</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-3881"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">filterM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683047577"><span class="annot"><span class="annottext">DefaultingProposal
</span><a href="#local-6989586621683047577"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; [Ct] -&gt; ProposalSequence -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#disambigMultiGroup"><span class="hs-identifier hs-var">disambigMultiGroup</span></a></span><span>
</span><span id="line-3882"></span><span>                                   </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047571"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-3883"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DefaultingProposal -&gt; [Ct]
</span><a href="GHC.Tc.Types.html#deProposalCts"><span class="hs-identifier hs-var">deProposalCts</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultingProposal
</span><a href="#local-6989586621683047577"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3884"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Proposal] -&gt; ProposalSequence
</span><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-var">ProposalSequence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TcTyVar, TcType)] -&gt; Proposal
</span><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-var">Proposal</span></a></span><span> </span><span class="annot"><span class="annottext">([(TcTyVar, TcType)] -&gt; Proposal)
-&gt; [[(TcTyVar, TcType)]] -&gt; [Proposal]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">DefaultingProposal -&gt; [[(TcTyVar, TcType)]]
</span><a href="GHC.Tc.Types.html#deProposals"><span class="hs-identifier hs-var">deProposals</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultingProposal
</span><a href="#local-6989586621683047577"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3885"></span><span>                    </span><span class="annot"><a href="#local-6989586621683047573"><span class="hs-identifier hs-type">groups</span></a></span><span>
</span><span id="line-3886"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;defaultingPlugin &quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047575"><span class="hs-identifier hs-type">defaultedGroups</span></a></span><span>
</span><span id="line-3887"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683047575"><span class="hs-identifier hs-type">defaultedGroups</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3888"></span><span>                 </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(WantedConstraints, Bool) -&gt; TcS (WantedConstraints, Bool)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047571"><span class="hs-identifier hs-var">wanteds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-3889"></span><span>                 </span><span class="annot"><span class="annottext">[DefaultingProposal]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-3890"></span><span>                     </span><span class="hs-comment">-- If a defaulting plugin solves any tyvars, some of the wanteds</span><span>
</span><span id="line-3891"></span><span>                     </span><span class="hs-comment">-- will have filled-in metavars by now (see wrinkle DP2 of</span><span>
</span><span id="line-3892"></span><span>                     </span><span class="hs-comment">-- Note [Defaulting plugins]). So we re-zonk to make sure later</span><span>
</span><span id="line-3893"></span><span>                     </span><span class="hs-comment">-- defaulting doesn't try to solve the same metavars.</span><span>
</span><span id="line-3894"></span><span>                     </span><span id="local-6989586621683047583"><span class="annot"><a href="#local-6989586621683047583"><span class="hs-identifier hs-var">wanteds'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.Monad.html#zonkWC"><span class="hs-identifier hs-var">TcS.zonkWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047571"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-3895"></span><span>                     </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047583"><span class="hs-identifier hs-type">wanteds'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3896"></span><span>
</span><span id="line-3897"></span><span class="annot"><a href="GHC.Tc.Solver.html#findDefaultableGroups"><span class="hs-identifier hs-type">findDefaultableGroups</span></a></span><span>
</span><span id="line-3898"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.DefaultEnv.html#ClassDefaults"><span class="hs-identifier hs-type">ClassDefaults</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3899"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-special">)</span><span>            </span><span class="hs-comment">-- extended default rules</span><span>
</span><span id="line-3900"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>   </span><span class="hs-comment">-- Unsolved</span><span>
</span><span id="line-3901"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-3902"></span><span id="findDefaultableGroups"><span class="annot"><span class="annottext">findDefaultableGroups :: ([ClassDefaults], Bool) -&gt; WantedConstraints -&gt; [(TcTyVar, [Ct])]
</span><a href="GHC.Tc.Solver.html#findDefaultableGroups"><span class="hs-identifier hs-var hs-var">findDefaultableGroups</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047584"><span class="annot"><span class="annottext">[ClassDefaults]
</span><a href="#local-6989586621683047584"><span class="hs-identifier hs-var">default_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047585"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047585"><span class="hs-identifier hs-var">extended_defaults</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683047586"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047586"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>
</span><span id="line-3903"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[ClassDefaults] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[ClassDefaults]
</span><a href="#local-6989586621683047584"><span class="hs-identifier hs-var">default_tys</span></a></span><span>
</span><span id="line-3904"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3905"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3906"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047587"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((Ct, Class, TcTyVar) -&gt; Ct) -&gt; [(Ct, Class, TcTyVar)] -&gt; [Ct]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Ct, Class, TcTyVar) -&gt; Ct
forall a b c. (a, b, c) -&gt; a
</span><a href="GHC.Utils.Misc.html#fstOf3"><span class="hs-identifier hs-var">fstOf3</span></a></span><span> </span><span class="annot"><span class="annottext">[(Ct, Class, TcTyVar)]
</span><a href="#local-6989586621683047589"><span class="hs-identifier hs-var">group</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3907"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683047590"><span class="annot"><span class="annottext">group' :: NonEmpty (Ct, Class, TcTyVar)
</span><a href="#local-6989586621683047590"><span class="hs-identifier hs-var">group'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Class
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621683047587"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047587"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="annot"><span class="annottext">[(Ct, Class, TcTyVar)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[NonEmpty (Ct, Class, TcTyVar)]
</span><a href="#local-6989586621683047592"><span class="hs-identifier hs-var">unary_groups</span></a></span><span>
</span><span id="line-3908"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047589"><span class="annot"><span class="annottext">group :: [(Ct, Class, TcTyVar)]
</span><a href="#local-6989586621683047589"><span class="hs-identifier hs-var hs-var">group</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (Ct, Class, TcTyVar) -&gt; [(Ct, Class, TcTyVar)]
forall a. NonEmpty a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Ct, Class, TcTyVar)
</span><a href="#local-6989586621683047590"><span class="hs-identifier hs-var">group'</span></a></span><span>
</span><span id="line-3909"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="#local-6989586621683047593"><span class="hs-identifier hs-var">defaultable_tyvar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047587"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-3910"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyCon] -&gt; Bool
</span><a href="#local-6989586621683047594"><span class="hs-identifier hs-var">defaultable_classes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Ct, Class, TcTyVar) -&gt; TyCon)
-&gt; [(Ct, Class, TcTyVar)] -&gt; [TyCon]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; TyCon
</span><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">(Class -&gt; TyCon)
-&gt; ((Ct, Class, TcTyVar) -&gt; Class) -&gt; (Ct, Class, TcTyVar) -&gt; TyCon
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Ct, Class, TcTyVar) -&gt; Class
forall a b c. (a, b, c) -&gt; b
</span><a href="GHC.Utils.Misc.html#sndOf3"><span class="hs-identifier hs-var">sndOf3</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Ct, Class, TcTyVar)]
</span><a href="#local-6989586621683047589"><span class="hs-identifier hs-var">group</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3911"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3912"></span><span>    </span><span id="local-6989586621683047597"><span class="annot"><span class="annottext">simples :: Cts
</span><a href="#local-6989586621683047597"><span class="hs-identifier hs-var hs-var">simples</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Solver.html#approximateWC"><span class="hs-identifier hs-var">approximateWC</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047586"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-3913"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683047598"><span class="annot"><span class="annottext">[(Ct, Class, TcTyVar)]
</span><a href="#local-6989586621683047598"><span class="hs-identifier hs-var">unaries</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047599"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047599"><span class="hs-identifier hs-var">non_unaries</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Either (Ct, Class, TcTyVar) Ct)
-&gt; [Ct] -&gt; ([(Ct, Class, TcTyVar)], [Ct])
forall a b c. (a -&gt; Either b c) -&gt; [a] -&gt; ([b], [c])
</span><a href="GHC.Utils.Misc.html#partitionWith"><span class="hs-identifier hs-var">partitionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Either (Ct, Class, TcTyVar) Ct
</span><a href="#local-6989586621683047601"><span class="hs-identifier hs-var">find_unary</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cts -&gt; [Ct]
forall a. Bag a -&gt; [a]
</span><a href="GHC.Data.Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047597"><span class="hs-identifier hs-var">simples</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3914"></span><span>    </span><span id="local-6989586621683047592"><span class="annot"><span class="annottext">unary_groups :: [NonEmpty (Ct, Class, TcTyVar)]
</span><a href="#local-6989586621683047592"><span class="hs-identifier hs-var hs-var">unary_groups</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Ct, Class, TcTyVar) -&gt; (Ct, Class, TcTyVar) -&gt; Ordering)
-&gt; [(Ct, Class, TcTyVar)] -&gt; [NonEmpty (Ct, Class, TcTyVar)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [NonEmpty a]
</span><a href="GHC.Data.List.SetOps.html#equivClasses"><span class="hs-identifier hs-var">equivClasses</span></a></span><span> </span><span class="annot"><span class="annottext">(Ct, Class, TcTyVar) -&gt; (Ct, Class, TcTyVar) -&gt; Ordering
forall {a} {a} {b} {a} {b}.
Ord a =&gt;
(a, b, a) -&gt; (a, b, a) -&gt; Ordering
</span><a href="#local-6989586621683047603"><span class="hs-identifier hs-var">cmp_tv</span></a></span><span> </span><span class="annot"><span class="annottext">[(Ct, Class, TcTyVar)]
</span><a href="#local-6989586621683047598"><span class="hs-identifier hs-var">unaries</span></a></span><span>
</span><span id="line-3915"></span><span>
</span><span id="line-3916"></span><span>    </span><span class="annot"><a href="#local-6989586621683047592"><span class="hs-identifier hs-type">unary_groups</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- (C tv) constraints</span><span>
</span><span id="line-3917"></span><span>    </span><span class="annot"><a href="#local-6989586621683047598"><span class="hs-identifier hs-type">unaries</span></a></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- (C tv) constraints</span><span>
</span><span id="line-3918"></span><span>    </span><span class="annot"><a href="#local-6989586621683047599"><span class="hs-identifier hs-type">non_unaries</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span>                            </span><span class="hs-comment">-- and *other* constraints</span><span>
</span><span id="line-3919"></span><span>
</span><span id="line-3920"></span><span>    </span><span class="hs-comment">-- Finds unary type-class constraints</span><span>
</span><span id="line-3921"></span><span>    </span><span class="hs-comment">-- But take account of polykinded classes like Typeable,</span><span>
</span><span id="line-3922"></span><span>    </span><span class="hs-comment">-- which may look like (Typeable * (a:*))   (#8931)</span><span>
</span><span id="line-3923"></span><span>    </span><span class="hs-comment">-- step (1) in Note [How type-class constraints are defaulted]</span><span>
</span><span id="line-3924"></span><span>    </span><span class="annot"><a href="#local-6989586621683047601"><span class="hs-identifier hs-type">find_unary</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span>
</span><span id="line-3925"></span><span>    </span><span id="local-6989586621683047601"><span class="annot"><span class="annottext">find_unary :: Ct -&gt; Either (Ct, Class, TcTyVar) Ct
</span><a href="#local-6989586621683047601"><span class="hs-identifier hs-var hs-var">find_unary</span></a></span></span><span> </span><span id="local-6989586621683047604"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047604"><span class="hs-identifier hs-var">cc</span></a></span></span><span>
</span><span id="line-3926"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047605"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047605"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683047606"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047606"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe (Class, [TcType])
</span><a href="GHC.Core.Predicate.html#getClassPredTys_maybe"><span class="hs-identifier hs-var">getClassPredTys_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047604"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3927"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621683047608"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047608"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TcType] -&gt; [TcType]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; TyCon
</span><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047605"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047606"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-3928"></span><span>              </span><span class="hs-comment">-- Ignore invisible arguments for this purpose</span><span>
</span><span id="line-3929"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683047610"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047610"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcType -&gt; Maybe TcTyVar
</span><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047608"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3930"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047610"><span class="hs-identifier hs-var">tv</span></a></span><span>  </span><span class="hs-comment">-- We might have runtime-skolems in GHCi, and</span><span>
</span><span id="line-3931"></span><span>                          </span><span class="hs-comment">-- we definitely don't want to try to assign to those!</span><span>
</span><span id="line-3932"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct, Class, TcTyVar) -&gt; Either (Ct, Class, TcTyVar) Ct
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047604"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047605"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047610"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3933"></span><span>    </span><span class="annot"><a href="#local-6989586621683047601"><span class="hs-identifier hs-var">find_unary</span></a></span><span> </span><span id="local-6989586621683047611"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047611"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Either (Ct, Class, TcTyVar) Ct
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047611"><span class="hs-identifier hs-var">cc</span></a></span><span>  </span><span class="hs-comment">-- Non unary or non dictionary</span><span>
</span><span id="line-3934"></span><span>
</span><span id="line-3935"></span><span>    </span><span class="annot"><a href="#local-6989586621683047612"><span class="hs-identifier hs-type">bad_tvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a></span><span>  </span><span class="hs-comment">-- TyVars mentioned by non-unaries</span><span>
</span><span id="line-3936"></span><span>    </span><span id="local-6989586621683047612"><span class="annot"><span class="annottext">bad_tvs :: VarSet
</span><a href="#local-6989586621683047612"><span class="hs-identifier hs-var hs-var">bad_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; VarSet) -&gt; [Ct] -&gt; VarSet
forall a. (a -&gt; VarSet) -&gt; [a] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mapUnionVarSet"><span class="hs-identifier hs-var">mapUnionVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; VarSet
</span><a href="GHC.Tc.Types.Constraint.html#tyCoVarsOfCt"><span class="hs-identifier hs-var">tyCoVarsOfCt</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047599"><span class="hs-identifier hs-var">non_unaries</span></a></span><span>
</span><span id="line-3937"></span><span>
</span><span id="line-3938"></span><span>    </span><span id="local-6989586621683047603"><span class="annot"><span class="annottext">cmp_tv :: (a, b, a) -&gt; (a, b, a) -&gt; Ordering
</span><a href="#local-6989586621683047603"><span class="hs-identifier hs-var hs-var">cmp_tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621683047619"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683047619"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621683047620"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683047620"><span class="hs-identifier hs-var">tv2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683047619"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-operator hs-var">`compare`</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683047620"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-3939"></span><span>
</span><span id="line-3940"></span><span>    </span><span class="annot"><a href="#local-6989586621683047593"><span class="hs-identifier hs-type">defaultable_tyvar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3941"></span><span>    </span><span id="local-6989586621683047593"><span class="annot"><span class="annottext">defaultable_tyvar :: TcTyVar -&gt; Bool
</span><a href="#local-6989586621683047593"><span class="hs-identifier hs-var hs-var">defaultable_tyvar</span></a></span></span><span> </span><span id="local-6989586621683047622"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047622"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-3942"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047623"><span class="annot"><span class="annottext">b1 :: Bool
</span><a href="#local-6989586621683047623"><span class="hs-identifier hs-var hs-var">b1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isTyConableTyVar"><span class="hs-identifier hs-var">isTyConableTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047622"><span class="hs-identifier hs-var">tv</span></a></span><span>  </span><span class="hs-comment">-- Note [Avoiding spurious errors]</span><span>
</span><span id="line-3943"></span><span>              </span><span id="local-6989586621683047625"><span class="annot"><span class="annottext">b2 :: Bool
</span><a href="#local-6989586621683047625"><span class="hs-identifier hs-var hs-var">b2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047622"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683047612"><span class="hs-identifier hs-var">bad_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3944"></span><span>          </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047623"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047625"><span class="hs-identifier hs-var">b2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047585"><span class="hs-identifier hs-var">extended_defaults</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Note [Multi-parameter defaults]</span><span>
</span><span id="line-3945"></span><span>
</span><span id="line-3946"></span><span>    </span><span class="hs-comment">-- Determines if any of the given type class constructors is in default_tys</span><span>
</span><span id="line-3947"></span><span>    </span><span class="hs-comment">-- step (3) in Note [How type-class constraints are defaulted]</span><span>
</span><span id="line-3948"></span><span>    </span><span class="annot"><a href="#local-6989586621683047594"><span class="hs-identifier hs-type">defaultable_classes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3949"></span><span>    </span><span id="local-6989586621683047594"><span class="annot"><span class="annottext">defaultable_classes :: [TyCon] -&gt; Bool
</span><a href="#local-6989586621683047594"><span class="hs-identifier hs-var hs-var">defaultable_classes</span></a></span></span><span> </span><span id="local-6989586621683047626"><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621683047626"><span class="hs-identifier hs-var">clss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; ([TyCon] -&gt; Bool) -&gt; [TyCon] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TyCon] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([TyCon] -&gt; Bool) -&gt; ([TyCon] -&gt; [TyCon]) -&gt; [TyCon] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TyCon] -&gt; [TyCon] -&gt; [TyCon]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">intersect</span></span><span> </span><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621683047626"><span class="hs-identifier hs-var">clss</span></a></span><span> </span><span class="annot"><span class="annottext">([TyCon] -&gt; Bool) -&gt; [TyCon] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ClassDefaults -&gt; TyCon) -&gt; [ClassDefaults] -&gt; [TyCon]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ClassDefaults -&gt; TyCon
</span><a href="GHC.Types.DefaultEnv.html#cd_class"><span class="hs-identifier hs-var">cd_class</span></a></span><span> </span><span class="annot"><span class="annottext">[ClassDefaults]
</span><a href="#local-6989586621683047584"><span class="hs-identifier hs-var">default_tys</span></a></span><span>
</span><span id="line-3950"></span><span>
</span><span id="line-3951"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-3952"></span><span>
</span><span id="line-3953"></span><span class="annot"><span class="hs-comment">-- | 'Proposal's to be tried in sequence until the first one that succeeds</span></span><span>
</span><span id="line-3954"></span><span class="hs-keyword">newtype</span><span> </span><span id="ProposalSequence"><span class="annot"><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-var">ProposalSequence</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ProposalSequence"><span class="annot"><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-var">ProposalSequence</span></a></span></span><span class="hs-special">{</span><span id="getProposalSequence"><span class="annot"><span class="annottext">ProposalSequence -&gt; [Proposal]
</span><a href="GHC.Tc.Solver.html#getProposalSequence"><span class="hs-identifier hs-var hs-var">getProposalSequence</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-type">Proposal</span></a></span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><span id="line-3955"></span><span>
</span><span id="line-3956"></span><span class="annot"><span class="hs-comment">-- | An atomic set of proposed type assignments to try applying all at once</span></span><span>
</span><span id="line-3957"></span><span class="hs-keyword">newtype</span><span> </span><span id="Proposal"><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-var">Proposal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Proposal"><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-var">Proposal</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-3958"></span><span>
</span><span id="line-3959"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-type">ProposalSequence</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3960"></span><span>  </span><span id="local-6989586621683047633"><span class="annot"><span class="annottext">ppr :: ProposalSequence -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-type">ProposalSequence</span></a></span><span> </span><span id="local-6989586621683047634"><span class="annot"><span class="annottext">[Proposal]
</span><a href="#local-6989586621683047634"><span class="hs-identifier hs-var">proposals</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Proposal] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Proposal]
</span><a href="#local-6989586621683047634"><span class="hs-identifier hs-var">proposals</span></a></span><span>
</span><span id="line-3961"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-type">Proposal</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3962"></span><span>  </span><span id="local-6989586621683047638"><span class="annot"><span class="annottext">ppr :: Proposal -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-type">Proposal</span></a></span><span> </span><span id="local-6989586621683047639"><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047639"><span class="hs-identifier hs-var">assignments</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TcTyVar, TcType)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047639"><span class="hs-identifier hs-var">assignments</span></a></span><span>
</span><span id="line-3963"></span><span>
</span><span id="line-3964"></span><span class="annot"><a href="GHC.Tc.Solver.html#disambigGroup"><span class="hs-identifier hs-type">disambigGroup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Original constraints, for diagnostic purposes</span></span><span>
</span><span id="line-3965"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.DefaultEnv.html#ClassDefaults"><span class="hs-identifier hs-type">ClassDefaults</span></a></span><span class="hs-special">]</span><span>   </span><span class="annot"><span class="hs-comment">-- ^ The default classes and types</span></span><span>
</span><span id="line-3966"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="annot"><span class="hs-comment">-- ^ All constraints sharing same type variable</span></span><span>
</span><span id="line-3967"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- True &lt;=&gt; something happened, reflected in ty_binds</span><span>
</span><span id="line-3968"></span><span id="disambigGroup"><span class="annot"><span class="annottext">disambigGroup :: WantedConstraints -&gt; [ClassDefaults] -&gt; (TcTyVar, [Ct]) -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#disambigGroup"><span class="hs-identifier hs-var hs-var">disambigGroup</span></a></span></span><span> </span><span id="local-6989586621683047640"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047640"><span class="hs-identifier hs-var">orig_wanteds</span></a></span></span><span> </span><span id="local-6989586621683047641"><span class="annot"><span class="annottext">[ClassDefaults]
</span><a href="#local-6989586621683047641"><span class="hs-identifier hs-var">default_ctys</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047642"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047642"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047643"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047643"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3969"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
-&gt; [Ct]
-&gt; [ProposalSequence]
-&gt; (NonEmpty ([TcTyVar], Subst) -&gt; Bool)
-&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#disambigProposalSequences"><span class="hs-identifier hs-var">disambigProposalSequences</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047640"><span class="hs-identifier hs-var">orig_wanteds</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047643"><span class="hs-identifier hs-var">wanteds</span></a></span><span> </span><span class="annot"><span class="annottext">[ProposalSequence]
</span><a href="#local-6989586621683047645"><span class="hs-identifier hs-var">proposalSequences</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty ([TcTyVar], Subst) -&gt; Bool
</span><a href="#local-6989586621683047646"><span class="hs-identifier hs-var">allConsistent</span></a></span><span>
</span><span id="line-3970"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3971"></span><span>    </span><span id="local-6989586621683047645"><span class="annot"><span class="annottext">proposalSequences :: [ProposalSequence]
</span><a href="#local-6989586621683047645"><span class="hs-identifier hs-var hs-var">proposalSequences</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Proposal] -&gt; ProposalSequence
</span><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-var">ProposalSequence</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[(TcTyVar, TcType)] -&gt; Proposal
</span><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-var">Proposal</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047642"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047647"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683047647"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047647"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047648"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3972"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.DefaultEnv.html#ClassDefaults"><span class="hs-identifier hs-type">ClassDefaults</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">cd_types :: ClassDefaults -&gt; [TcType]
</span><a href="GHC.Types.DefaultEnv.html#cd_types"><span class="hs-identifier hs-var">cd_types</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047648"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047648"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ClassDefaults]
</span><a href="#local-6989586621683047651"><span class="hs-identifier hs-var">defaultses</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3973"></span><span>    </span><span id="local-6989586621683047646"><span class="annot"><span class="annottext">allConsistent :: NonEmpty ([TcTyVar], Subst) -&gt; Bool
</span><a href="#local-6989586621683047646"><span class="hs-identifier hs-var hs-var">allConsistent</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcTyVar]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047652"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047652"><span class="hs-identifier hs-var">sub</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621683047653"><span class="annot"><span class="annottext">[([TcTyVar], Subst)]
</span><a href="#local-6989586621683047653"><span class="hs-identifier hs-var">subs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([TcTyVar], Subst) -&gt; Bool) -&gt; [([TcTyVar], Subst)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; Subst -&gt; Subst -&gt; Bool
</span><a href="#local-6989586621683047654"><span class="hs-identifier hs-var">eqSubAt</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047642"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047652"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Bool)
-&gt; (([TcTyVar], Subst) -&gt; Subst) -&gt; ([TcTyVar], Subst) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([TcTyVar], Subst) -&gt; Subst
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[([TcTyVar], Subst)]
</span><a href="#local-6989586621683047653"><span class="hs-identifier hs-var">subs</span></a></span><span>
</span><span id="line-3974"></span><span>    </span><span id="local-6989586621683047651"><span class="annot"><span class="annottext">defaultses :: [ClassDefaults]
</span><a href="#local-6989586621683047651"><span class="hs-identifier hs-var hs-var">defaultses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3975"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ClassDefaults
</span><a href="#local-6989586621683047655"><span class="hs-identifier hs-var">defaults</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683047655"><span class="annot"><span class="annottext">defaults :: ClassDefaults
</span><a href="#local-6989586621683047655"><span class="hs-identifier hs-var">defaults</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Types.DefaultEnv.html#ClassDefaults"><span class="hs-identifier hs-type">ClassDefaults</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">cd_class :: ClassDefaults -&gt; TyCon
</span><a href="GHC.Types.DefaultEnv.html#cd_class"><span class="hs-identifier hs-var">cd_class</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047656"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683047656"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ClassDefaults]
</span><a href="#local-6989586621683047641"><span class="hs-identifier hs-var">default_ctys</span></a></span><span>
</span><span id="line-3976"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Bool) -&gt; [Ct] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Ct -&gt; Bool
</span><a href="#local-6989586621683047657"><span class="hs-identifier hs-var">isDictForClass</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683047656"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047643"><span class="hs-identifier hs-var">wanteds</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3977"></span><span>    </span><span id="local-6989586621683047657"><span class="annot"><span class="annottext">isDictForClass :: TyCon -&gt; Ct -&gt; Bool
</span><a href="#local-6989586621683047657"><span class="hs-identifier hs-var hs-var">isDictForClass</span></a></span></span><span> </span><span id="local-6989586621683047660"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683047660"><span class="hs-identifier hs-var">clcon</span></a></span></span><span> </span><span id="local-6989586621683047661"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047661"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Class, [TcType]) -&gt; Bool) -&gt; Maybe (Class, [TcType]) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683047660"><span class="hs-identifier hs-var">clcon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TyCon -&gt; Bool)
-&gt; ((Class, [TcType]) -&gt; TyCon) -&gt; (Class, [TcType]) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Class -&gt; TyCon
</span><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">(Class -&gt; TyCon)
-&gt; ((Class, [TcType]) -&gt; Class) -&gt; (Class, [TcType]) -&gt; TyCon
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Class, [TcType]) -&gt; Class
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcType -&gt; Maybe (Class, [TcType])
</span><a href="GHC.Core.Predicate.html#getClassPredTys_maybe"><span class="hs-identifier hs-var">getClassPredTys_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; Maybe (Class, [TcType]))
-&gt; TcType -&gt; Maybe (Class, [TcType])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; TcType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621683047661"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3978"></span><span>    </span><span class="annot"><a href="#local-6989586621683047654"><span class="hs-identifier hs-type">eqSubAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3979"></span><span>    </span><span id="local-6989586621683047654"><span class="annot"><span class="annottext">eqSubAt :: TcTyVar -&gt; Subst -&gt; Subst -&gt; Bool
</span><a href="#local-6989586621683047654"><span class="hs-identifier hs-var hs-var">eqSubAt</span></a></span></span><span> </span><span id="local-6989586621683047662"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047662"><span class="hs-identifier hs-var">tvar</span></a></span></span><span> </span><span id="local-6989586621683047663"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047663"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621683047664"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047664"><span class="hs-identifier hs-var">s2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Bool -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">or</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Bool -&gt; Bool) -&gt; Maybe Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcType -&gt; Bool)
-&gt; Maybe TcType -&gt; Maybe TcType -&gt; Maybe Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; Maybe a -&gt; Maybe b -&gt; Maybe c
forall (f :: * -&gt; *) a b c.
Applicative f =&gt;
(a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
</span><span class="hs-identifier hs-var">liftA2</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; TcType -&gt; TcType -&gt; Bool
TcType -&gt; TcType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-identifier hs-var">tcEqType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; TcTyVar -&gt; Maybe TcType
</span><a href="GHC.Core.TyCo.Subst.html#lookupTyVar"><span class="hs-identifier hs-var">lookupTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047663"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047662"><span class="hs-identifier hs-var">tvar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; TcTyVar -&gt; Maybe TcType
</span><a href="GHC.Core.TyCo.Subst.html#lookupTyVar"><span class="hs-identifier hs-var">lookupTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047664"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047662"><span class="hs-identifier hs-var">tvar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3980"></span><span>
</span><span id="line-3981"></span><span class="hs-comment">-- See Note [How type-class constraints are defaulted]</span><span>
</span><span id="line-3982"></span><span class="annot"><a href="GHC.Tc.Solver.html#disambigMultiGroup"><span class="hs-identifier hs-type">disambigMultiGroup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Original constraints, for diagnostic purposes</span></span><span>
</span><span id="line-3983"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span>                 </span><span class="annot"><span class="hs-comment">-- ^ check these are solved by defaulting</span></span><span>
</span><span id="line-3984"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-type">ProposalSequence</span></a></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ defaulting type assignments to try</span></span><span>
</span><span id="line-3985"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- True &lt;=&gt; something happened, reflected in ty_binds</span><span>
</span><span id="line-3986"></span><span id="disambigMultiGroup"><span class="annot"><span class="annottext">disambigMultiGroup :: WantedConstraints -&gt; [Ct] -&gt; ProposalSequence -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#disambigMultiGroup"><span class="hs-identifier hs-var hs-var">disambigMultiGroup</span></a></span></span><span> </span><span id="local-6989586621683047667"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047667"><span class="hs-identifier hs-var">orig_wanteds</span></a></span></span><span> </span><span id="local-6989586621683047668"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047668"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span> </span><span id="local-6989586621683047669"><span class="annot"><span class="annottext">ProposalSequence
</span><a href="#local-6989586621683047669"><span class="hs-identifier hs-var">proposalSequence</span></a></span></span><span>
</span><span id="line-3987"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
-&gt; [Ct]
-&gt; [ProposalSequence]
-&gt; (NonEmpty ([TcTyVar], Subst) -&gt; Bool)
-&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#disambigProposalSequences"><span class="hs-identifier hs-var">disambigProposalSequences</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047667"><span class="hs-identifier hs-var">orig_wanteds</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047668"><span class="hs-identifier hs-var">wanteds</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ProposalSequence
</span><a href="#local-6989586621683047669"><span class="hs-identifier hs-var">proposalSequence</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; NonEmpty ([TcTyVar], Subst) -&gt; Bool
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-3988"></span><span>
</span><span id="line-3989"></span><span class="annot"><a href="GHC.Tc.Solver.html#disambigProposalSequences"><span class="hs-identifier hs-type">disambigProposalSequences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Original constraints, for diagnostic purposes</span></span><span>
</span><span id="line-3990"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span>                </span><span class="annot"><span class="hs-comment">-- ^ Check these are solved by defaulting</span></span><span>
</span><span id="line-3991"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-type">ProposalSequence</span></a></span><span class="hs-special">]</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The sequences of assignment proposals</span></span><span>
</span><span id="line-3992"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-3993"></span><span>                                                 </span><span class="annot"><span class="hs-comment">-- ^ Predicate for successful assignments</span></span><span>
</span><span id="line-3994"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- True &lt;=&gt; something happened, reflected in ty_binds</span><span>
</span><span id="line-3995"></span><span id="disambigProposalSequences"><span class="annot"><span class="annottext">disambigProposalSequences :: WantedConstraints
-&gt; [Ct]
-&gt; [ProposalSequence]
-&gt; (NonEmpty ([TcTyVar], Subst) -&gt; Bool)
-&gt; TcS Bool
</span><a href="GHC.Tc.Solver.html#disambigProposalSequences"><span class="hs-identifier hs-var hs-var">disambigProposalSequences</span></a></span></span><span> </span><span id="local-6989586621683047671"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047671"><span class="hs-identifier hs-var">orig_wanteds</span></a></span></span><span> </span><span id="local-6989586621683047672"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047672"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span> </span><span id="local-6989586621683047673"><span class="annot"><span class="annottext">[ProposalSequence]
</span><a href="#local-6989586621683047673"><span class="hs-identifier hs-var">proposalSequences</span></a></span></span><span> </span><span id="local-6989586621683047674"><span class="annot"><span class="annottext">NonEmpty ([TcTyVar], Subst) -&gt; Bool
</span><a href="#local-6989586621683047674"><span class="hs-identifier hs-var">allConsistent</span></a></span></span><span>
</span><span id="line-3996"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">(ProposalSequence -&gt; TcS ()) -&gt; [ProposalSequence] -&gt; TcS ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Proposal -&gt; TcS ()) -&gt; [Proposal] -&gt; TcS ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">Proposal -&gt; TcS ()
</span><a href="#local-6989586621683047675"><span class="hs-identifier hs-var">reportInvalidDefaultedTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">([Proposal] -&gt; TcS ())
-&gt; (ProposalSequence -&gt; [Proposal]) -&gt; ProposalSequence -&gt; TcS ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ProposalSequence -&gt; [Proposal]
</span><a href="GHC.Tc.Solver.html#getProposalSequence"><span class="hs-identifier hs-var">getProposalSequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ProposalSequence]
</span><a href="#local-6989586621683047673"><span class="hs-identifier hs-var">proposalSequences</span></a></span><span>
</span><span id="line-3997"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047676"><span class="annot"><a href="#local-6989586621683047676"><span class="hs-identifier hs-var">fake_ev_binds_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS EvBindsVar
</span><a href="GHC.Tc.Solver.Monad.html#newTcEvBinds"><span class="hs-identifier hs-var">TcS.newTcEvBinds</span></a></span><span>
</span><span id="line-3998"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047678"><span class="annot"><a href="#local-6989586621683047678"><span class="hs-identifier hs-var">tclvl</span></a></span></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getTcLevel"><span class="hs-identifier hs-type">TcS.getTcLevel</span></a></span><span>
</span><span id="line-3999"></span><span>       </span><span class="hs-comment">-- Step (4) in Note [How type-class constraints are defaulted]</span><span>
</span><span id="line-4000"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047679"><span class="annot"><a href="#local-6989586621683047679"><span class="hs-identifier hs-var">successes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">catMaybes</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-4001"></span><span>                      </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#nestImplicTcS"><span class="hs-identifier hs-type">nestImplicTcS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047676"><span class="hs-identifier hs-type">fake_ev_binds_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#pushTcLevel"><span class="hs-identifier hs-type">pushTcLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047678"><span class="hs-identifier hs-type">tclvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-4002"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="annot"><a href="#local-6989586621683047680"><span class="hs-identifier hs-type">firstSuccess</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047673"><span class="hs-identifier hs-type">proposalSequences</span></a></span><span>
</span><span id="line-4003"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-type">traceTcS</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;disambigProposalSequences&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047672"><span class="hs-identifier hs-type">wanteds</span></a></span><span>
</span><span id="line-4004"></span><span>                                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047673"><span class="hs-identifier hs-type">proposalSequences</span></a></span><span>
</span><span id="line-4005"></span><span>                                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047679"><span class="hs-identifier hs-type">successes</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-4006"></span><span>       </span><span class="hs-comment">-- Step (5) in Note [How type-class constraints are defaulted]</span><span>
</span><span id="line-4007"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683047679"><span class="hs-identifier hs-type">successes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-4008"></span><span>           </span><span id="local-6989586621683047681"><span class="annot"><span class="annottext">success :: ([TcTyVar], Subst)
</span><a href="#local-6989586621683047681"><span class="hs-identifier hs-var">success</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621683047682"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047682"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047683"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047683"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683047684"><span class="annot"><span class="annottext">[([TcTyVar], Subst)]
</span><a href="#local-6989586621683047684"><span class="hs-identifier hs-var">rest</span></a></span></span><span>
</span><span id="line-4009"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">NonEmpty ([TcTyVar], Subst) -&gt; Bool
</span><a href="#local-6989586621683047674"><span class="hs-identifier hs-var">allConsistent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([TcTyVar], Subst)
</span><a href="#local-6989586621683047681"><span class="hs-identifier hs-var">success</span></a></span><span> </span><span class="annot"><span class="annottext">([TcTyVar], Subst)
-&gt; [([TcTyVar], Subst)] -&gt; NonEmpty ([TcTyVar], Subst)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[([TcTyVar], Subst)]
</span><a href="#local-6989586621683047684"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4010"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; Subst -&gt; TcS ()
</span><a href="GHC.Tc.Solver.html#applyDefaultSubst"><span class="hs-identifier hs-var">applyDefaultSubst</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047682"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047683"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-4011"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047686"><span class="annot"><span class="annottext">warn :: TcTyVar -&gt; TcM ()
</span><a href="#local-6989586621683047686"><span class="hs-identifier hs-var hs-var hs-var">warn</span></a></span></span><span> </span><span id="local-6989586621683047687"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047687"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcM ()) -&gt; Maybe TcType -&gt; TcM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct] -&gt; TcTyVar -&gt; TcType -&gt; TcM ()
</span><a href="GHC.Tc.Errors.html#warnDefaulting"><span class="hs-identifier hs-var">warnDefaulting</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047672"><span class="hs-identifier hs-var">wanteds</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047687"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; TcTyVar -&gt; Maybe TcType
</span><a href="GHC.Core.TyCo.Subst.html#lookupTyVar"><span class="hs-identifier hs-var">lookupTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047683"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047687"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4012"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcM () -&gt; TcS ()
forall a. TcM a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#wrapWarnTcS"><span class="hs-identifier hs-var">wrapWarnTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcS ()) -&gt; TcM () -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; TcM ()) -&gt; [TcTyVar] -&gt; TcM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcM ()
</span><a href="#local-6989586621683047686"><span class="hs-identifier hs-var">warn</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047682"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-4013"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;disambigProposalSequences succeeded }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ProposalSequence] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[ProposalSequence]
</span><a href="#local-6989586621683047673"><span class="hs-identifier hs-var">proposalSequences</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4014"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4015"></span><span>           </span><span class="annot"><span class="annottext">[([TcTyVar], Subst)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-4016"></span><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;disambigProposalSequences failed }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ProposalSequence] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[ProposalSequence]
</span><a href="#local-6989586621683047673"><span class="hs-identifier hs-var">proposalSequences</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4017"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4018"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4019"></span><span>    </span><span class="annot"><a href="#local-6989586621683047675"><span class="hs-identifier hs-type">reportInvalidDefaultedTyVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-type">Proposal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-4020"></span><span>    </span><span class="annot"><a href="#local-6989586621683047680"><span class="hs-identifier hs-type">firstSuccess</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-type">ProposalSequence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4021"></span><span>    </span><span id="local-6989586621683047680"><span class="annot"><span class="annottext">firstSuccess :: ProposalSequence -&gt; TcS (Maybe ([TcTyVar], Subst))
</span><a href="#local-6989586621683047680"><span class="hs-identifier hs-var hs-var">firstSuccess</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#ProposalSequence"><span class="hs-identifier hs-type">ProposalSequence</span></a></span><span> </span><span id="local-6989586621683047690"><span class="annot"><span class="annottext">[Proposal]
</span><a href="#local-6989586621683047690"><span class="hs-identifier hs-var">proposals</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-4022"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">First ([TcTyVar], Subst) -&gt; Maybe ([TcTyVar], Subst)
forall a. First a -&gt; Maybe a
</span><span class="hs-identifier hs-var">getFirst</span></span><span> </span><span class="annot"><span class="annottext">(First ([TcTyVar], Subst) -&gt; Maybe ([TcTyVar], Subst))
-&gt; TcS (First ([TcTyVar], Subst)) -&gt; TcS (Maybe ([TcTyVar], Subst))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Proposal -&gt; TcS (First ([TcTyVar], Subst)))
-&gt; [Proposal] -&gt; TcS (First ([TcTyVar], Subst))
forall (m :: * -&gt; *) (t :: * -&gt; *) b a.
(Applicative m, Foldable t, Monoid b) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m b
</span><a href="GHC.Utils.Monad.html#foldMapM"><span class="hs-identifier hs-var">foldMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe ([TcTyVar], Subst) -&gt; First ([TcTyVar], Subst))
-&gt; TcS (Maybe ([TcTyVar], Subst)) -&gt; TcS (First ([TcTyVar], Subst))
forall a b. (a -&gt; b) -&gt; TcS a -&gt; TcS b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe ([TcTyVar], Subst) -&gt; First ([TcTyVar], Subst)
forall a. Maybe a -&gt; First a
</span><span class="hs-identifier hs-var">First</span></span><span> </span><span class="annot"><span class="annottext">(TcS (Maybe ([TcTyVar], Subst)) -&gt; TcS (First ([TcTyVar], Subst)))
-&gt; (Proposal -&gt; TcS (Maybe ([TcTyVar], Subst)))
-&gt; Proposal
-&gt; TcS (First ([TcTyVar], Subst))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; Proposal -&gt; TcS (Maybe ([TcTyVar], Subst))
</span><a href="GHC.Tc.Solver.html#tryDefaultGroup"><span class="hs-identifier hs-var">tryDefaultGroup</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047672"><span class="hs-identifier hs-var">wanteds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Proposal]
</span><a href="#local-6989586621683047690"><span class="hs-identifier hs-var">proposals</span></a></span><span>
</span><span id="line-4023"></span><span>    </span><span id="local-6989586621683047675"><span class="annot"><span class="annottext">reportInvalidDefaultedTyVars :: Proposal -&gt; TcS ()
</span><a href="#local-6989586621683047675"><span class="hs-identifier hs-var hs-var">reportInvalidDefaultedTyVars</span></a></span></span><span> </span><span id="local-6989586621683047695"><span class="annot"><span class="annottext">proposal :: Proposal
</span><a href="#local-6989586621683047695"><span class="hs-identifier hs-var">proposal</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-type">Proposal</span></a></span><span> </span><span id="local-6989586621683047696"><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047696"><span class="hs-identifier hs-var">assignments</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-4024"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047697"><span class="annot"><span class="annottext">tvs :: [TcTyVar]
</span><a href="#local-6989586621683047697"><span class="hs-identifier hs-var hs-var hs-var">tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar, TcType) -&gt; TcTyVar
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((TcTyVar, TcType) -&gt; TcTyVar) -&gt; [(TcTyVar, TcType)] -&gt; [TcTyVar]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047696"><span class="hs-identifier hs-var">assignments</span></a></span><span>
</span><span id="line-4025"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047698"><span class="annot"><a href="#local-6989586621683047698"><span class="hs-identifier hs-var">invalid_tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; TcS Bool) -&gt; [TcTyVar] -&gt; TcS [TcTyVar]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><a href="GHC.Utils.Monad.html#filterOutM"><span class="hs-identifier hs-var">filterOutM</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Monad.html#isUnfilledMetaTyVar"><span class="hs-identifier hs-var">TcS.isUnfilledMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047697"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-4026"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#errInvalidDefaultedTyVar"><span class="hs-identifier hs-type">errInvalidDefaultedTyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047671"><span class="hs-identifier hs-type">orig_wanteds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047695"><span class="hs-identifier hs-type">proposal</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html#nonEmpty"><span class="hs-identifier hs-type">nonEmpty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047698"><span class="hs-identifier hs-type">invalid_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4027"></span><span>
</span><span id="line-4028"></span><span class="annot"><a href="GHC.Tc.Solver.html#applyDefaultSubst"><span class="hs-identifier hs-type">applyDefaultSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-4029"></span><span id="applyDefaultSubst"><span class="annot"><span class="annottext">applyDefaultSubst :: [TcTyVar] -&gt; Subst -&gt; TcS ()
</span><a href="GHC.Tc.Solver.html#applyDefaultSubst"><span class="hs-identifier hs-var hs-var">applyDefaultSubst</span></a></span></span><span> </span><span id="local-6989586621683047702"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047702"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621683047703"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047703"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-4030"></span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047704"><span class="annot"><a href="#local-6989586621683047704"><span class="hs-identifier hs-var">deep_tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; TcS Bool) -&gt; [TcTyVar] -&gt; TcS [TcTyVar]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Monad.html#isUnfilledMetaTyVar"><span class="hs-identifier hs-var">TcS.isUnfilledMetaTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">([TcTyVar] -&gt; TcS [TcTyVar]) -&gt; [TcTyVar] -&gt; TcS [TcTyVar]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [TcTyVar]
forall elt. UniqSet elt -&gt; [elt]
</span><a href="GHC.Types.Unique.Set.html#nonDetEltsUniqSet"><span class="hs-identifier hs-var">nonDetEltsUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; [TcTyVar]) -&gt; VarSet -&gt; [TcTyVar]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#closeOverKinds"><span class="hs-identifier hs-var">closeOverKinds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcTyVar] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047702"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4031"></span><span>     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">forM_</span></span><span> </span><span class="annot"><a href="#local-6989586621683047704"><span class="hs-identifier hs-type">deep_tvs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621683047707"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047707"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TcType -&gt; TcS ()) -&gt; Maybe TcType -&gt; TcS ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; TcType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047707"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarEnv TcType -&gt; TcTyVar -&gt; Maybe TcType
forall a. VarEnv a -&gt; TcTyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; VarEnv TcType
</span><a href="GHC.Core.TyCo.Subst.html#getTvSubstEnv"><span class="hs-identifier hs-var">getTvSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047703"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047707"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4032"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-4033"></span><span>
</span><span id="line-4034"></span><span class="annot"><a href="GHC.Tc.Solver.html#tryDefaultGroup"><span class="hs-identifier hs-type">tryDefaultGroup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span>       </span><span class="annot"><span class="hs-comment">-- ^ check these are solved by defaulting</span></span><span>
</span><span id="line-4035"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-type">Proposal</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ defaulting type assignments to try</span></span><span>
</span><span id="line-4036"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ successful substitutions, *not* reflected in ty_binds</span></span><span>
</span><span id="line-4037"></span><span id="tryDefaultGroup"><span class="annot"><span class="annottext">tryDefaultGroup :: [Ct] -&gt; Proposal -&gt; TcS (Maybe ([TcTyVar], Subst))
</span><a href="GHC.Tc.Solver.html#tryDefaultGroup"><span class="hs-identifier hs-var hs-var">tryDefaultGroup</span></a></span></span><span> </span><span id="local-6989586621683047710"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047710"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-type">Proposal</span></a></span><span> </span><span id="local-6989586621683047711"><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047711"><span class="hs-identifier hs-var">assignments</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-4038"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047712"><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047712"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047713"><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047713"><span class="hs-identifier hs-var">default_tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TcTyVar, TcType)] -&gt; ([TcTyVar], [TcType])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047711"><span class="hs-identifier hs-var">assignments</span></a></span><span>
</span><span id="line-4039"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683047715"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047715"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcType] -&gt; [TcType] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTyKis"><span class="hs-identifier hs-var">tcMatchTyKis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcTyVar] -&gt; [TcType]
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047712"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcType]
</span><a href="#local-6989586621683047713"><span class="hs-identifier hs-var">default_tys</span></a></span><span>
</span><span id="line-4040"></span><span>            </span><span class="hs-comment">-- Make sure the kinds match too; hence this call to tcMatchTyKi</span><span>
</span><span id="line-4041"></span><span>            </span><span class="hs-comment">-- E.g. suppose the only constraint was (Typeable k (a::k))</span><span>
</span><span id="line-4042"></span><span>            </span><span class="hs-comment">-- With the addition of polykinded defaulting we also want to reject</span><span>
</span><span id="line-4043"></span><span>            </span><span class="hs-comment">-- ill-kinded defaulting attempts like (Eq []) or (Foldable Int) here.</span><span>
</span><span id="line-4044"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683047716"><span class="annot"><a href="#local-6989586621683047716"><span class="hs-identifier hs-var">lcl_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS TcLclEnv
</span><a href="GHC.Tc.Solver.Monad.html#getLclEnv"><span class="hs-identifier hs-var">TcS.getLclEnv</span></a></span><span>
</span><span id="line-4045"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047717"><span class="annot"><a href="#local-6989586621683047717"><span class="hs-identifier hs-var">tc_lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#getTcLevel"><span class="hs-identifier hs-type">TcS.getTcLevel</span></a></span><span>
</span><span id="line-4046"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047718"><span class="annot"><a href="#local-6989586621683047718"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; SkolemInfoAnon -&gt; CtLocEnv -&gt; CtLoc
</span><a href="GHC.Tc.Types.CtLoc.html#mkGivenLoc"><span class="hs-identifier hs-var">mkGivenLoc</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621683047717"><span class="hs-identifier hs-var">tc_lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SkolemInfo -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#getSkolemInfo"><span class="hs-identifier hs-var">getSkolemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfo
HasDebugCallStack =&gt; SkolemInfo
</span><a href="GHC.Tc.Types.Origin.html#unkSkol"><span class="hs-identifier hs-var">unkSkol</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcLclEnv -&gt; CtLocEnv
</span><a href="GHC.Tc.Utils.Monad.html#mkCtLocEnv"><span class="hs-identifier hs-var">mkCtLocEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TcLclEnv
</span><a href="#local-6989586621683047716"><span class="hs-identifier hs-var">lcl_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4047"></span><span>               </span><span class="hs-comment">-- Equality constraints are possible due to type defaulting plugins</span><span>
</span><span id="line-4048"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047719"><span class="annot"><a href="#local-6989586621683047719"><span class="hs-identifier hs-var">wanted_evs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">sequence</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#newWantedNC"><span class="hs-identifier hs-type">newWantedNC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047718"><span class="hs-identifier hs-type">loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047722"><span class="hs-identifier hs-type">rewriters</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047723"><span class="hs-identifier hs-type">pred'</span></a></span><span>
</span><span id="line-4049"></span><span>                                        </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683047724"><span class="annot"><a href="#local-6989586621683047724"><span class="hs-identifier hs-var">wanted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683047710"><span class="hs-identifier hs-type">wanteds</span></a></span><span>
</span><span id="line-4050"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctev_pred"><span class="hs-identifier hs-var">ctev_pred</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047725"><span class="annot"><a href="#local-6989586621683047725"><span class="hs-identifier hs-var">pred</span></a></span></span><span>
</span><span id="line-4051"></span><span>                                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctev_rewriters"><span class="hs-identifier hs-var">ctev_rewriters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047722"><span class="annot"><a href="#local-6989586621683047722"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4052"></span><span>                                            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-type">ctEvidence</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047724"><span class="hs-identifier hs-type">wanted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4053"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683047723"><span class="annot"><a href="#local-6989586621683047723"><span class="hs-identifier hs-var hs-var">pred'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; TcType -&gt; TcType
Subst -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683047715"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047725"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-4054"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683047728"><span class="annot"><a href="#local-6989586621683047728"><span class="hs-identifier hs-var">residual_wc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Solve.html#solveSimpleWanteds"><span class="hs-identifier hs-type">solveSimpleWanteds</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#listToBag"><span class="hs-identifier hs-type">listToBag</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#mkNonCanonical"><span class="hs-identifier hs-type">mkNonCanonical</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047719"><span class="hs-identifier hs-type">wanted_evs</span></a></span><span>
</span><span id="line-4055"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#isEmptyWC"><span class="hs-identifier hs-type">isEmptyWC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683047728"><span class="hs-identifier hs-type">residual_wc</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683047712"><span class="hs-identifier hs-type">tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683047715"><span class="hs-identifier hs-type">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-4056"></span><span>
</span><span id="line-4057"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-4058"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ([TcTyVar], Subst) -&gt; TcS (Maybe ([TcTyVar], Subst))
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ([TcTyVar], Subst)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-4059"></span><span>
</span><span id="line-4060"></span><span class="annot"><a href="GHC.Tc.Solver.html#errInvalidDefaultedTyVar"><span class="hs-identifier hs-type">errInvalidDefaultedTyVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-type">Proposal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-4061"></span><span id="errInvalidDefaultedTyVar"><span class="annot"><span class="annottext">errInvalidDefaultedTyVar :: WantedConstraints -&gt; Proposal -&gt; NonEmpty TcTyVar -&gt; TcS ()
</span><a href="GHC.Tc.Solver.html#errInvalidDefaultedTyVar"><span class="hs-identifier hs-var hs-var">errInvalidDefaultedTyVar</span></a></span></span><span> </span><span id="local-6989586621683047729"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047729"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.html#Proposal"><span class="hs-identifier hs-type">Proposal</span></a></span><span> </span><span id="local-6989586621683047730"><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047730"><span class="hs-identifier hs-var">assignments</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683047731"><span class="annot"><span class="annottext">NonEmpty TcTyVar
</span><a href="#local-6989586621683047731"><span class="hs-identifier hs-var">problematic_tvs</span></a></span></span><span>
</span><span id="line-4062"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcS ()
forall a. TcRnMessage -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#failTcS"><span class="hs-identifier hs-var">failTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcS ()) -&gt; TcRnMessage -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; [(TcTyVar, TcType)] -&gt; NonEmpty TcTyVar -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnInvalidDefaultedTyVar"><span class="hs-identifier hs-var">TcRnInvalidDefaultedTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621683047734"><span class="hs-identifier hs-var">tidy_wanteds</span></a></span><span> </span><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047735"><span class="hs-identifier hs-var">tidy_assignments</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty TcTyVar
</span><a href="#local-6989586621683047736"><span class="hs-identifier hs-var">tidy_problems</span></a></span><span>
</span><span id="line-4063"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-4064"></span><span>    </span><span id="local-6989586621683047737"><span class="annot"><span class="annottext">proposal_tvs :: [TcTyVar]
</span><a href="#local-6989586621683047737"><span class="hs-identifier hs-var hs-var">proposal_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TcTyVar, TcType) -&gt; [TcTyVar])
-&gt; [(TcTyVar, TcType)] -&gt; [TcTyVar]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621683047738"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047738"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047739"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047739"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047738"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; [TcTyVar] -&gt; [TcTyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">TcType -&gt; [TcTyVar]
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypeList"><span class="hs-identifier hs-var">tyCoVarsOfTypeList</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047739"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047730"><span class="hs-identifier hs-var">assignments</span></a></span><span>
</span><span id="line-4065"></span><span>    </span><span id="local-6989586621683047741"><span class="annot"><span class="annottext">tidy_env :: TidyEnv
</span><a href="#local-6989586621683047741"><span class="hs-identifier hs-var hs-var">tidy_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; [TcTyVar] -&gt; TidyEnv
</span><a href="GHC.Core.TyCo.Tidy.html#tidyFreeTyCoVars"><span class="hs-identifier hs-var">tidyFreeTyCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="GHC.Types.Var.Env.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a></span><span> </span><span class="annot"><span class="annottext">([TcTyVar] -&gt; TidyEnv) -&gt; [TcTyVar] -&gt; TidyEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TcTyVar]
</span><a href="#local-6989586621683047737"><span class="hs-identifier hs-var">proposal_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[TcTyVar] -&gt; [TcTyVar] -&gt; [TcTyVar]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty TcTyVar -&gt; [TcTyVar]
forall a. NonEmpty a -&gt; [a]
</span><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html#toList"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty TcTyVar
</span><a href="#local-6989586621683047731"><span class="hs-identifier hs-var">problematic_tvs</span></a></span><span>
</span><span id="line-4066"></span><span>    </span><span id="local-6989586621683047734"><span class="annot"><span class="annottext">tidy_wanteds :: [Ct]
</span><a href="#local-6989586621683047734"><span class="hs-identifier hs-var hs-var">tidy_wanteds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Ct) -&gt; [Ct] -&gt; [Ct]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; Ct -&gt; Ct
</span><a href="GHC.Tc.Zonk.TcType.html#tidyCt"><span class="hs-identifier hs-var">tidyCt</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683047741"><span class="hs-identifier hs-var">tidy_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Ct] -&gt; [Ct]) -&gt; [Ct] -&gt; [Ct]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; [Ct]
</span><a href="#local-6989586621683047746"><span class="hs-identifier hs-var">flattenWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621683047729"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-4067"></span><span>    </span><span id="local-6989586621683047735"><span class="annot"><span class="annottext">tidy_assignments :: [(TcTyVar, TcType)]
</span><a href="#local-6989586621683047735"><span class="hs-identifier hs-var hs-var">tidy_assignments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; TcTyVar -&gt; TcTyVar
</span><a href="GHC.Core.TyCo.Tidy.html#tidyTyCoVarOcc"><span class="hs-identifier hs-var">tidyTyCoVarOcc</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683047741"><span class="hs-identifier hs-var">tidy_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047748"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; TcType -&gt; TcType
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683047741"><span class="hs-identifier hs-var">tidy_env</span></a></span><span> </span><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047750"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683047748"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621683047748"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683047750"><span class="annot"><span class="annottext">TcType
</span><a href="#local-6989586621683047750"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(TcTyVar, TcType)]
</span><a href="#local-6989586621683047730"><span class="hs-identifier hs-var">assignments</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-4068"></span><span>    </span><span id="local-6989586621683047736"><span class="annot"><span class="annottext">tidy_problems :: NonEmpty TcTyVar
</span><a href="#local-6989586621683047736"><span class="hs-identifier hs-var hs-var">tidy_problems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcTyVar -&gt; TcTyVar) -&gt; NonEmpty TcTyVar -&gt; NonEmpty TcTyVar
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; TcTyVar -&gt; TcTyVar
</span><a href="GHC.Core.TyCo.Tidy.html#tidyTyCoVarOcc"><span class="hs-identifier hs-var">tidyTyCoVarOcc</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683047741"><span class="hs-identifier hs-var">tidy_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty TcTyVar
</span><a href="#local-6989586621683047731"><span class="hs-identifier hs-var">problematic_tvs</span></a></span><span>
</span><span id="line-4069"></span><span>
</span><span id="line-4070"></span><span>    </span><span class="annot"><a href="#local-6989586621683047746"><span class="hs-identifier hs-type">flattenWC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-4071"></span><span>    </span><span id="local-6989586621683047746"><span class="annot"><span class="annottext">flattenWC :: WantedConstraints -&gt; [Ct]
</span><a href="#local-6989586621683047746"><span class="hs-identifier hs-var hs-var">flattenWC</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047751"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047751"><span class="hs-identifier hs-var">cts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683047752"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047752"><span class="hs-identifier hs-var">impls</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-4072"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; [Ct]
</span><a href="GHC.Tc.Types.Constraint.html#ctsElts"><span class="hs-identifier hs-var">ctsElts</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621683047751"><span class="hs-identifier hs-var">cts</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; [Ct] -&gt; [Ct]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Implication -&gt; [Ct]) -&gt; Bag Implication -&gt; [Ct]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; [Ct]
</span><a href="#local-6989586621683047746"><span class="hs-identifier hs-var">flattenWC</span></a></span><span> </span><span class="annot"><span class="annottext">(WantedConstraints -&gt; [Ct])
-&gt; (Implication -&gt; WantedConstraints) -&gt; Implication -&gt; [Ct]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Implication -&gt; WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#ic_wanted"><span class="hs-identifier hs-var">ic_wanted</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621683047752"><span class="hs-identifier hs-var">impls</span></a></span><span>
</span><span id="line-4073"></span><span>
</span><span id="line-4074"></span><span class="hs-comment">-- In interactive mode, or with -XExtendedDefaultRules,</span><span>
</span><span id="line-4075"></span><span class="hs-comment">-- we default Show a to Show () to avoid gratuitous errors on &quot;show []&quot;</span><span>
</span><span id="line-4076"></span><span class="annot"><a href="GHC.Tc.Solver.html#isInteractiveClass"><span class="hs-identifier hs-type">isInteractiveClass</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- -XOverloadedStrings?</span><span>
</span><span id="line-4077"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-4078"></span><span id="isInteractiveClass"><span class="annot"><span class="annottext">isInteractiveClass :: Bool -&gt; Class -&gt; Bool
</span><a href="GHC.Tc.Solver.html#isInteractiveClass"><span class="hs-identifier hs-var hs-var">isInteractiveClass</span></a></span></span><span> </span><span id="local-6989586621683047754"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047754"><span class="hs-identifier hs-var">ovl_strings</span></a></span></span><span> </span><span id="local-6989586621683047755"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047755"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-4079"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Class -&gt; Bool
</span><a href="GHC.Tc.Solver.html#isNumClass"><span class="hs-identifier hs-var">isNumClass</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047754"><span class="hs-identifier hs-var">ovl_strings</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047755"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; Unique
</span><a href="GHC.Core.Class.html#classKey"><span class="hs-identifier hs-var">classKey</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047755"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; [Unique] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Unique]
</span><a href="GHC.Builtin.Names.html#interactiveClassKeys"><span class="hs-identifier hs-var">interactiveClassKeys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-4080"></span><span>
</span><span id="line-4081"></span><span>    </span><span class="hs-comment">-- isNumClass adds IsString to the standard numeric classes,</span><span>
</span><span id="line-4082"></span><span>    </span><span class="hs-comment">-- when -XOverloadedStrings is enabled</span><span>
</span><span id="line-4083"></span><span class="annot"><a href="GHC.Tc.Solver.html#isNumClass"><span class="hs-identifier hs-type">isNumClass</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- -XOverloadedStrings?</span><span>
</span><span id="line-4084"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-4085"></span><span id="isNumClass"><span class="annot"><span class="annottext">isNumClass :: Bool -&gt; Class -&gt; Bool
</span><a href="GHC.Tc.Solver.html#isNumClass"><span class="hs-identifier hs-var hs-var">isNumClass</span></a></span></span><span> </span><span id="local-6989586621683047760"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047760"><span class="hs-identifier hs-var">ovl_strings</span></a></span></span><span> </span><span id="local-6989586621683047761"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047761"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-4086"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Builtin.Utils.html#isNumericClass"><span class="hs-identifier hs-var">isNumericClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047761"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683047760"><span class="hs-identifier hs-var">ovl_strings</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683047761"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#isStringClassKey"><span class="hs-identifier hs-var">isStringClassKey</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-4087"></span><span>
</span><span id="line-4088"></span><span>
</span><span id="line-4089"></span><span class="hs-comment">{-
Note [Avoiding spurious errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When doing the unification for defaulting, we check for skolem
type variables, and simply don't default them.  For example:
   f = (*)      -- Monomorphic
   g :: Num a =&gt; a -&gt; a
   g x = f x x
Here, we get a complaint when checking the type signature for g,
that g isn't polymorphic enough; but then we get another one when
dealing with the (Num a) context arising from f's definition;
we try to unify a with Int (to default it), but find that it's
already been unified with the rigid variable from g's type sig.

Note [Multi-parameter defaults]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
With -XExtendedDefaultRules, we default only based on single-variable
constraints, but do not exclude from defaulting any type variables which also
appear in multi-variable constraints. This means that the following will
default properly:

   default (Integer, Double)

   class A b (c :: Symbol) where
      a :: b -&gt; Proxy c

   instance A Integer c where a _ = Proxy

   main = print (a 5 :: Proxy &quot;5&quot;)

Note that if we change the above instance (&quot;instance A Integer&quot;) to
&quot;instance A Double&quot;, we get an error:

   No instance for (A Integer &quot;5&quot;)

This is because the first defaulted type (Integer) has successfully satisfied
its single-parameter constraints (in this case Num).
-}</span><span>
</span><span id="line-4127"></span></pre></body></html>