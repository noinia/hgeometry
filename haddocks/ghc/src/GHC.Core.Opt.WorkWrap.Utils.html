<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1993-1998

A library for the ``worker\/wrapper'' back-end to the strictness analyser
-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html"><span class="hs-identifier">GHC.Core.Opt.WorkWrap.Utils</span></a></span><span>
</span><span id="line-11"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier">WwOpts</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWwBodies"><span class="hs-identifier">mkWwBodies</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr"><span class="hs-identifier">mkWWstr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr_one"><span class="hs-identifier">mkWWstr_one</span></a></span><span>
</span><span id="line-12"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#needsVoidWorkerArg"><span class="hs-identifier">needsVoidWorkerArg</span></a></span><span>
</span><span id="line-13"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier">DataConPatContext</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#UnboxingDecision"><span class="hs-identifier">UnboxingDecision</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#canUnboxArg"><span class="hs-identifier">canUnboxArg</span></a></span><span>
</span><span id="line-15"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#findTypeShape"><span class="hs-identifier">findTypeShape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier">IsRecDataConResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#isRecDataCon"><span class="hs-identifier">isRecDataCon</span></a></span><span>
</span><span id="line-16"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAbsentFiller"><span class="hs-identifier">mkAbsentFiller</span></a></span><span>
</span><span id="line-17"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#isWorkerSmallEnough"><span class="hs-identifier">isWorkerSmallEnough</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#dubiousDataConInstArgTys"><span class="hs-identifier">dubiousDataConInstArgTys</span></a></span><span>
</span><span id="line-18"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier">boringSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#usefulSplit"><span class="hs-identifier">usefulSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#workWrapArity"><span class="hs-identifier">workWrapArity</span></a></span><span>
</span><span id="line-19"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">where</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#isDictTy"><span class="hs-identifier">isDictTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html"><span class="hs-identifier">GHC.Core.Reduction</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.Set.html"><span class="hs-identifier">GHC.Core.TyCon.Set</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.RecWalk.html"><span class="hs-identifier">GHC.Core.TyCon.RecWalk</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html"><span class="hs-identifier">GHC.Core.SimpleOpt</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#SimpleOpts"><span class="hs-identifier">SimpleOpts</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html"><span class="hs-identifier">GHC.Types.Cpr</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html"><span class="hs-identifier">GHC.Types.Id.Make</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#voidArgId"><span class="hs-identifier">voidArgId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#voidPrimId"><span class="hs-identifier">voidPrimId</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html"><span class="hs-identifier">GHC.Types.Unique.Supply</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#getOccFS"><span class="hs-identifier">getOccFS</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html"><span class="hs-identifier">GHC.Data.OrdList</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.List.SetOps.html"><span class="hs-identifier">GHC.Data.List.SetOps</span></a></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#tupleDataCon"><span class="hs-identifier">tupleDataCon</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Applicative.html"><span class="hs-identifier">Control.Applicative</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-operator">(&lt;|&gt;)</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">zipWithM</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">unzip4</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.RepType.html"><span class="hs-identifier">GHC.Types.RepType</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html"><span class="hs-identifier">GHC.Unit.Types</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[mkWrapperAndWorker]{@mkWrapperAndWorker@}
*                                                                      *
************************************************************************

Here's an example.  The original function is:

\begin{verbatim}
g :: forall a . Int -&gt; [a] -&gt; a

g = \/\ a -&gt; \ x ys -&gt;
        case x of
          0 -&gt; head ys
          _ -&gt; head (tail ys)
\end{verbatim}

From this, we want to produce:
\begin{verbatim}
-- wrapper (an unfolding)
g :: forall a . Int -&gt; [a] -&gt; a

g = \/\ a -&gt; \ x ys -&gt;
        case x of
          I# x# -&gt; $wg a x# ys
            -- call the worker; don't forget the type args!

-- worker
$wg :: forall a . Int# -&gt; [a] -&gt; a

$wg = \/\ a -&gt; \ x# ys -&gt;
        let
            x = I# x#
        in
            case x of               -- note: body of g moved intact
              0 -&gt; head ys
              _ -&gt; head (tail ys)
\end{verbatim}

Something we have to be careful about:  Here's an example:

\begin{verbatim}
-- &quot;f&quot; strictness: U(P)U(P)
f (I# a) (I# b) = a +# b

g = f   -- &quot;g&quot; strictness same as &quot;f&quot;
\end{verbatim}

\tr{f} will get a worker all nice and friendly-like; that's good.
{\em But we don't want a worker for \tr{g}}, even though it has the
same strictness as \tr{f}.  Doing so could break laziness, at best.

Consequently, we insist that the number of strictness-info items is
exactly the same as the number of lambda-bound arguments.  (This is
probably slightly paranoid, but OK in practice.)  If it isn't the
same, we ``revise'' the strictness info, so that we won't propagate
the unusable strictness-info into the interfaces.


************************************************************************
*                                                                      *
\subsection{The worker wrapper core}
*                                                                      *
************************************************************************

@mkWwBodies@ is called when doing the worker\/wrapper split inside a module.
-}</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-keyword">data</span><span> </span><span id="WwOpts"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-var">WwOpts</span></a></span></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="MkWwOpts"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#MkWwOpts"><span class="hs-identifier hs-var">MkWwOpts</span></a></span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-comment">-- | Environment of type/data family instances</span></span><span>
</span><span id="line-139"></span><span>    </span><span id="wo_fam_envs"><span class="annot"><span class="annottext">WwOpts -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_fam_envs"><span class="hs-identifier hs-var hs-var">wo_fam_envs</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-comment">-- | Options for the &quot;Simple optimiser&quot;</span></span><span>
</span><span id="line-141"></span><span>    </span><span id="wo_simple_opts"><span class="annot"><span class="annottext">WwOpts -&gt; SimpleOpts
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_simple_opts"><span class="hs-identifier hs-var hs-var">wo_simple_opts</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.SimpleOpt.html#SimpleOpts"><span class="hs-identifier hs-type">SimpleOpts</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- | Whether to enable &quot;Constructed Product Result&quot; analysis.</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-comment">-- (Originally from DOI: 10.1017/S0956796803004751)</span><span>
</span><span id="line-144"></span><span>    </span><span id="wo_cpr_anal"><span class="annot"><span class="annottext">WwOpts -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_cpr_anal"><span class="hs-identifier hs-var hs-var">wo_cpr_anal</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-comment">-- | Used for absent argument error message</span></span><span>
</span><span id="line-146"></span><span>    </span><span id="wo_module"><span class="annot"><span class="annottext">WwOpts -&gt; Module
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_module"><span class="hs-identifier hs-var hs-var">wo_module</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- | Generate workers even if the only effect is some args get passed</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-comment">-- unlifted. See Note [WW for calling convention]</span><span>
</span><span id="line-149"></span><span>    </span><span id="wo_unlift_strict"><span class="annot"><span class="annottext">WwOpts -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_unlift_strict"><span class="hs-identifier hs-var hs-var">wo_unlift_strict</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-keyword">type</span><span> </span><span id="WwResult"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwResult"><span class="hs-identifier hs-var">WwResult</span></a></span></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>              </span><span class="hs-comment">-- Demands for worker (value) args</span><span>
</span><span id="line-153"></span><span>     </span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span class="hs-special">,</span><span>             </span><span class="hs-comment">-- Number of worker (type OR value) args</span><span>
</span><span id="line-154"></span><span>     </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- Wrapper body, lacking only the worker Id</span><span>
</span><span id="line-155"></span><span>     </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Worker body, lacking the original function rhs</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-type">nop_fn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-158"></span><span id="nop_fn"><span class="annot"><span class="annottext">nop_fn :: CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-var hs-var">nop_fn</span></a></span></span><span> </span><span id="local-6989586621682746805"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746805"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746805"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWwBodies"><span class="hs-identifier hs-type">mkWwBodies</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span>
</span><span id="line-162"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>             </span><span class="annot"><span class="hs-comment">-- ^ The original function</span></span><span>
</span><span id="line-163"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>          </span><span class="annot"><span class="hs-comment">-- ^ Worker/wrapper arity</span></span><span>
</span><span id="line-164"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>          </span><span class="annot"><span class="hs-comment">-- ^ Manifest args of original function</span></span><span>
</span><span id="line-165"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>           </span><span class="hs-comment">-- ^ Result type of the original function,</span><span>
</span><span id="line-166"></span><span>                             </span><span class="hs-comment">--   after being stripped of args</span><span>
</span><span id="line-167"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>       </span><span class="annot"><span class="hs-comment">-- ^ Strictness of original function</span></span><span>
</span><span id="line-168"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#Cpr"><span class="hs-identifier hs-type">Cpr</span></a></span><span>            </span><span class="annot"><span class="hs-comment">-- ^ Info about function result</span></span><span>
</span><span id="line-169"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwResult"><span class="hs-identifier hs-type">WwResult</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- ^ Given a function definition</span><span>
</span><span id="line-171"></span><span class="hs-comment">--</span><span>
</span><span id="line-172"></span><span class="hs-comment">-- &gt; data T = MkT Int Bool Char</span><span>
</span><span id="line-173"></span><span class="hs-comment">-- &gt; f :: (a, b) -&gt; Int -&gt; T</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- &gt; f = \x y -&gt; E</span><span>
</span><span id="line-175"></span><span class="hs-comment">--</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- @mkWwBodies _ 'f' ['x::(a,b)','y::Int'] '(a,b)' ['1P(L,L)', '1P(L)'] '1'@</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- returns</span><span>
</span><span id="line-178"></span><span class="hs-comment">--</span><span>
</span><span id="line-179"></span><span class="hs-comment">--   * The wrapper body context for the call to the worker function, lacking</span><span>
</span><span id="line-180"></span><span class="hs-comment">--     only the 'Id' for the worker function:</span><span>
</span><span id="line-181"></span><span class="hs-comment">--</span><span>
</span><span id="line-182"></span><span class="hs-comment">--     &gt; W[_] :: Id -&gt; CoreExpr</span><span>
</span><span id="line-183"></span><span class="hs-comment">--     &gt; W[work_fn] = \x y -&gt;          -- args of the wrapper    (cloned_arg_vars)</span><span>
</span><span id="line-184"></span><span class="hs-comment">--     &gt;   case x of (a, b) -&gt;         -- unbox wrapper args     (wrap_fn_str)</span><span>
</span><span id="line-185"></span><span class="hs-comment">--     &gt;   case y of I# n -&gt;           --</span><span>
</span><span id="line-186"></span><span class="hs-comment">--     &gt;   case &lt;work_fn&gt; a b n of     -- call to the worker fun (call_work)</span><span>
</span><span id="line-187"></span><span class="hs-comment">--     &gt;   (# i, b, c #) -&gt; MkT i b c  -- rebox result           (wrap_fn_cpr)</span><span>
</span><span id="line-188"></span><span class="hs-comment">--</span><span>
</span><span id="line-189"></span><span class="hs-comment">--   * The worker body context that wraps around its hole reboxing defns for x</span><span>
</span><span id="line-190"></span><span class="hs-comment">--     and y, as well as returning CPR transit variables of the unboxed MkT</span><span>
</span><span id="line-191"></span><span class="hs-comment">--     result in an unboxed tuple:</span><span>
</span><span id="line-192"></span><span class="hs-comment">--</span><span>
</span><span id="line-193"></span><span class="hs-comment">--     &gt; w[_] :: CoreExpr -&gt; CoreExpr</span><span>
</span><span id="line-194"></span><span class="hs-comment">--     &gt; w[fn_rhs] = \a b n -&gt;              -- args of the worker       (work_lam_args)</span><span>
</span><span id="line-195"></span><span class="hs-comment">--     &gt;   let { y = I# n; x = (a, b) } in  -- reboxing wrapper args    (work_fn_str)</span><span>
</span><span id="line-196"></span><span class="hs-comment">--     &gt;   case &lt;fn_rhs&gt; x y of             -- call to the original RHS (call_rhs)</span><span>
</span><span id="line-197"></span><span class="hs-comment">--     &gt;   MkT i b c -&gt; (# i, b, c #)       -- return CPR transit vars  (work_fn_cpr)</span><span>
</span><span id="line-198"></span><span class="hs-comment">--</span><span>
</span><span id="line-199"></span><span class="hs-comment">--     NB: The wrap_rhs hole is to be filled with the original wrapper RHS</span><span>
</span><span id="line-200"></span><span class="hs-comment">--     @\x y -&gt; E@. This is so that we can also use @w@ to transform stable</span><span>
</span><span id="line-201"></span><span class="hs-comment">--     unfoldings, the lambda args of which may be different than x and y.</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span class="hs-comment">--   * Id details for the worker function like demands on arguments and its join</span><span>
</span><span id="line-204"></span><span class="hs-comment">--     arity.</span><span>
</span><span id="line-205"></span><span class="hs-comment">--</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- All without looking at E (except for beta reduction, see Note [Join points</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- and beta-redexes]), which allows us to apply the same split to function body</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- and its unfolding(s) alike.</span><span>
</span><span id="line-209"></span><span class="hs-comment">--</span><span>
</span><span id="line-210"></span><span id="mkWwBodies"><span class="annot"><span class="annottext">mkWwBodies :: WwOpts
-&gt; Id
-&gt; Int
-&gt; [Id]
-&gt; Kind
-&gt; [Demand]
-&gt; Cpr
-&gt; UniqSM (Maybe WwResult)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWwBodies"><span class="hs-identifier hs-var hs-var">mkWwBodies</span></a></span></span><span> </span><span id="local-6989586621682746809"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682746809"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682746810"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746810"><span class="hs-identifier hs-var">fun_id</span></a></span></span><span> </span><span id="local-6989586621682746811"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746811"><span class="hs-identifier hs-var">ww_arity</span></a></span></span><span> </span><span id="local-6989586621682746812"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746812"><span class="hs-identifier hs-var">arg_vars</span></a></span></span><span> </span><span id="local-6989586621682746813"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682746813"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span id="local-6989586621682746814"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682746814"><span class="hs-identifier hs-var">demands</span></a></span></span><span> </span><span id="local-6989586621682746815"><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621682746815"><span class="hs-identifier hs-var">res_cpr</span></a></span></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; UniqSM ()
forall (m :: * -&gt; *).
(HasCallStack, Applicative m) =&gt;
Bool -&gt; SDoc -&gt; m ()
</span><a href="GHC.Utils.Panic.html#massertPpr"><span class="hs-identifier hs-var">massertPpr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682746817"><span class="hs-identifier hs-var">arity_ok</span></a></span><span>
</span><span id="line-212"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;wrong wrapper arity&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746810"><span class="hs-identifier hs-var">fun_id</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746812"><span class="hs-identifier hs-var">arg_vars</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682746813"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682746814"><span class="hs-identifier hs-var">demands</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-comment">-- Clone and prepare arg_vars of the original fun RHS</span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-comment">-- See Note [Freshen WW arguments]</span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-comment">-- and Note [Zap IdInfo on worker args]</span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682746821"><span class="annot"><span class="annottext">args_free_tcvs :: TyCoVarSet
</span><a href="#local-6989586621682746821"><span class="hs-identifier hs-var hs-var hs-var">args_free_tcvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Kind] -&gt; TyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682746813"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; [Kind] -&gt; [Kind]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Kind) -&gt; [Id] -&gt; [Kind]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746812"><span class="hs-identifier hs-var">arg_vars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>              </span><span id="local-6989586621682746824"><span class="annot"><span class="annottext">empty_subst :: Subst
</span><a href="#local-6989586621682746824"><span class="hs-identifier hs-var hs-var hs-var">empty_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCoVarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682746821"><span class="hs-identifier hs-var">args_free_tcvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>              </span><span id="local-6989586621682746827"><span class="annot"><span class="annottext">zapped_arg_vars :: [Id]
</span><a href="#local-6989586621682746827"><span class="hs-identifier hs-var hs-var hs-var">zapped_arg_vars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="#local-6989586621682746828"><span class="hs-identifier hs-var">zap_var</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746812"><span class="hs-identifier hs-var">arg_vars</span></a></span><span>
</span><span id="line-220"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746829"><span class="annot"><a href="#local-6989586621682746829"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746830"><span class="annot"><a href="#local-6989586621682746830"><span class="hs-identifier hs-var">cloned_arg_vars</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; UniqSM (Subst, [Id])
forall (m :: * -&gt; *).
MonadUnique m =&gt;
Subst -&gt; [Id] -&gt; m (Subst, [Id])
</span><a href="GHC.Core.Subst.html#cloneBndrs"><span class="hs-identifier hs-var">cloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682746824"><span class="hs-identifier hs-var">empty_subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746827"><span class="hs-identifier hs-var">zapped_arg_vars</span></a></span><span>
</span><span id="line-221"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682746832"><span class="annot"><a href="#local-6989586621682746832"><span class="hs-identifier hs-var hs-var">res_ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682746829"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682746813"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-222"></span><span>              </span><span id="local-6989586621682746834"><span class="annot"><a href="#local-6989586621682746834"><span class="hs-identifier hs-var hs-var">init_str_marks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; StrictnessMark) -&gt; [Id] -&gt; [StrictnessMark]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictnessMark -&gt; Id -&gt; StrictnessMark
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746830"><span class="hs-identifier hs-var">cloned_arg_vars</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746837"><span class="annot"><a href="#local-6989586621682746837"><span class="hs-identifier hs-var">useful1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746838"><span class="annot"><a href="#local-6989586621682746838"><span class="hs-identifier hs-var">work_args_str</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746839"><span class="annot"><a href="#local-6989586621682746839"><span class="hs-identifier hs-var">wrap_fn_str</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746840"><span class="annot"><a href="#local-6989586621682746840"><span class="hs-identifier hs-var">fn_args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkWWbodies&quot; (ppr fun_id $$ ppr (arg_vars `zip` cloned_arg_vars) $$ ppr demands) $</span><span>
</span><span id="line-226"></span><span>                </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr"><span class="hs-identifier hs-type">mkWWstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746809"><span class="hs-identifier hs-type">opts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746830"><span class="hs-identifier hs-type">cloned_arg_vars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746834"><span class="hs-identifier hs-type">init_str_marks</span></a></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746841"><span class="annot"><a href="#local-6989586621682746841"><span class="hs-identifier hs-var">work_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746842"><span class="annot"><a href="#local-6989586621682746842"><span class="hs-identifier hs-var">work_marks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unzip</span></span><span> </span><span class="annot"><a href="#local-6989586621682746838"><span class="hs-identifier hs-type">work_args_str</span></a></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-comment">-- Do CPR w/w.  See Note [Always do CPR w/w]</span><span>
</span><span id="line-231"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746844"><span class="annot"><a href="#local-6989586621682746844"><span class="hs-identifier hs-var">useful2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746845"><span class="annot"><a href="#local-6989586621682746845"><span class="hs-identifier hs-var">wrap_fn_cpr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746846"><span class="annot"><a href="#local-6989586621682746846"><span class="hs-identifier hs-var">work_fn_cpr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr_entry"><span class="hs-identifier hs-type">mkWWcpr_entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746809"><span class="hs-identifier hs-type">opts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746832"><span class="hs-identifier hs-type">res_ty'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746815"><span class="hs-identifier hs-type">res_cpr</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746848"><span class="annot"><a href="#local-6989586621682746848"><span class="hs-identifier hs-var">work_lam_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746849"><span class="annot"><a href="#local-6989586621682746849"><span class="hs-identifier hs-var">work_call_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746850"><span class="annot"><a href="#local-6989586621682746850"><span class="hs-identifier hs-var">work_call_str</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#needsVoidWorkerArg"><span class="hs-identifier hs-type">needsVoidWorkerArg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746810"><span class="hs-identifier hs-type">fun_id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746812"><span class="hs-identifier hs-type">arg_vars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746841"><span class="hs-identifier hs-type">work_args</span></a></span><span>
</span><span id="line-236"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#addVoidWorkerArg"><span class="hs-identifier hs-type">addVoidWorkerArg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746841"><span class="hs-identifier hs-type">work_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746842"><span class="hs-identifier hs-type">work_marks</span></a></span><span>
</span><span id="line-237"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span>
</span><span id="line-238"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682746841"><span class="hs-identifier hs-type">work_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682746841"><span class="hs-identifier hs-type">work_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682746842"><span class="hs-identifier hs-type">work_marks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>              </span><span id="local-6989586621682746852"><span class="annot"><a href="#local-6989586621682746852"><span class="hs-identifier hs-var hs-var">call_work</span></a></span></span><span> </span><span id="local-6989586621682746853"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746853"><span class="hs-identifier hs-var">work_fn</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [Id] -&gt; CoreExpr
forall b. Expr b -&gt; [Id] -&gt; Expr b
</span><a href="GHC.Core.html#mkVarApps"><span class="hs-identifier hs-var">mkVarApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746853"><span class="hs-identifier hs-var">work_fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746849"><span class="hs-identifier hs-var">work_call_args</span></a></span><span>
</span><span id="line-241"></span><span>              </span><span id="local-6989586621682746856"><span class="annot"><a href="#local-6989586621682746856"><span class="hs-identifier hs-var hs-var">call_rhs</span></a></span></span><span> </span><span id="local-6989586621682746857"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746857"><span class="hs-identifier hs-var">fn_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAppsBeta"><span class="hs-identifier hs-var">mkAppsBeta</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746857"><span class="hs-identifier hs-var">fn_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682746840"><span class="hs-identifier hs-var">fn_args</span></a></span><span>
</span><span id="line-242"></span><span>                                  </span><span class="hs-comment">-- See Note [Join points and beta-redexes]</span><span>
</span><span id="line-243"></span><span>              </span><span id="local-6989586621682746859"><span class="annot"><a href="#local-6989586621682746859"><span class="hs-identifier hs-var hs-var">wrapper_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; CoreExpr -&gt; CoreExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746830"><span class="hs-identifier hs-var">cloned_arg_vars</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; (Id -&gt; CoreExpr) -&gt; Id -&gt; CoreExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682746845"><span class="hs-identifier hs-var">wrap_fn_cpr</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; (Id -&gt; CoreExpr) -&gt; Id -&gt; CoreExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682746839"><span class="hs-identifier hs-var">wrap_fn_str</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; (Id -&gt; CoreExpr) -&gt; Id -&gt; CoreExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
</span><a href="#local-6989586621682746852"><span class="hs-identifier hs-var">call_work</span></a></span><span>
</span><span id="line-244"></span><span>                                  </span><span class="hs-comment">-- See Note [Call-by-value for worker args]</span><span>
</span><span id="line-245"></span><span>              </span><span id="local-6989586621682746862"><span class="annot"><a href="#local-6989586621682746862"><span class="hs-identifier hs-var hs-var">work_seq_str_flds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, StrictnessMark)] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkStrictFieldSeqs"><span class="hs-identifier hs-var">mkStrictFieldSeqs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; [StrictnessMark] -&gt; [(Id, StrictnessMark)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746848"><span class="hs-identifier hs-var">work_lam_args</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682746850"><span class="hs-identifier hs-var">work_call_str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>              </span><span id="local-6989586621682746864"><span class="annot"><a href="#local-6989586621682746864"><span class="hs-identifier hs-var hs-var">worker_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; CoreExpr -&gt; CoreExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746848"><span class="hs-identifier hs-var">work_lam_args</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr)
-&gt; (CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682746862"><span class="hs-identifier hs-var">work_seq_str_flds</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr)
-&gt; (CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682746846"><span class="hs-identifier hs-var">work_fn_cpr</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr)
-&gt; (CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682746856"><span class="hs-identifier hs-var">call_rhs</span></a></span><span>
</span><span id="line-247"></span><span>              </span><span id="local-6989586621682746865"><span class="annot"><a href="#local-6989586621682746865"><span class="hs-identifier hs-var hs-var">worker_args_dmds</span></a></span></span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746867"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682746867"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746867"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746849"><span class="hs-identifier hs-var">work_call_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746867"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682746837"><span class="hs-identifier hs-type">useful1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621682746871"><span class="hs-identifier hs-type">only_one_void_argument</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="#local-6989586621682746844"><span class="hs-identifier hs-type">useful2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682746865"><span class="hs-identifier hs-type">worker_args_dmds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="annot"><a href="#local-6989586621682746849"><span class="hs-identifier hs-type">work_call_args</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-251"></span><span>                       </span><span class="annot"><a href="#local-6989586621682746859"><span class="hs-identifier hs-type">wrapper_body</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682746864"><span class="hs-identifier hs-type">worker_body</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-253"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-254"></span><span>        </span><span class="hs-comment">-- We use an INLINE unconditionally, even if the wrapper turns out to be</span><span>
</span><span id="line-255"></span><span>        </span><span class="hs-comment">-- something trivial like</span><span>
</span><span id="line-256"></span><span>        </span><span class="hs-comment">--      fw = ...</span><span>
</span><span id="line-257"></span><span>        </span><span class="hs-comment">--      f = __inline__ (coerce T fw)</span><span>
</span><span id="line-258"></span><span>        </span><span class="hs-comment">-- The point is to propagate the coerce to f's call sites, so even though</span><span>
</span><span id="line-259"></span><span>        </span><span class="hs-comment">-- f's RHS is now trivial (size 1) we still want the __inline__ to prevent</span><span>
</span><span id="line-260"></span><span>        </span><span class="hs-comment">-- fw from being inlined into f's RHS</span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-262"></span><span>    </span><span id="local-6989586621682746828"><span class="annot"><span class="annottext">zap_var :: Id -&gt; Id
</span><a href="#local-6989586621682746828"><span class="hs-identifier hs-var hs-var">zap_var</span></a></span></span><span> </span><span id="local-6989586621682746875"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746875"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746875"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746875"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-263"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; (IdInfo -&gt; IdInfo) -&gt; Id -&gt; Id
(IdInfo -&gt; IdInfo) -&gt; Id -&gt; Id
</span><a href="GHC.Types.Id.html#modifyIdInfo"><span class="hs-identifier hs-var">modifyIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; IdInfo
</span><a href="#local-6989586621682746878"><span class="hs-identifier hs-var">zap_info</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746875"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span id="local-6989586621682746878"><span class="annot"><span class="annottext">zap_info :: IdInfo -&gt; IdInfo
</span><a href="#local-6989586621682746878"><span class="hs-identifier hs-var hs-var">zap_info</span></a></span></span><span> </span><span id="local-6989586621682746879"><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682746879"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-comment">-- See Note [Zap IdInfo on worker args]</span><span>
</span><span id="line-265"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682746879"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; OccInfo -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setOccInfo"><span class="hs-operator hs-var">`setOccInfo`</span></a></span><span>       </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#noOccInfo"><span class="hs-identifier hs-var">noOccInfo</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-comment">-- Note [Do not split void functions]</span><span>
</span><span id="line-268"></span><span>    </span><span id="local-6989586621682746871"><span class="annot"><span class="annottext">only_one_void_argument :: Bool
</span><a href="#local-6989586621682746871"><span class="hs-identifier hs-var hs-var">only_one_void_argument</span></a></span></span><span>
</span><span id="line-269"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span id="local-6989586621682746882"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682746882"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682746814"><span class="hs-identifier hs-var">demands</span></a></span><span>
</span><span id="line-270"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621682746883"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746883"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746812"><span class="hs-identifier hs-var">arg_vars</span></a></span><span>
</span><span id="line-271"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isAbsDmd"><span class="hs-identifier hs-var">isAbsDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682746882"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Bool
Kind -&gt; Bool
</span><a href="GHC.Types.RepType.html#isZeroBitTy"><span class="hs-identifier hs-var">isZeroBitTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746883"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>    </span><span id="local-6989586621682746887"><span class="annot"><span class="annottext">n_dmds :: Int
</span><a href="#local-6989586621682746887"><span class="hs-identifier hs-var hs-var">n_dmds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682746814"><span class="hs-identifier hs-var">demands</span></a></span><span>
</span><span id="line-277"></span><span>    </span><span id="local-6989586621682746817"><span class="annot"><span class="annottext">arity_ok :: Bool
</span><a href="#local-6989586621682746817"><span class="hs-identifier hs-var hs-var">arity_ok</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746810"><span class="hs-identifier hs-var">fun_id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746811"><span class="hs-identifier hs-var">ww_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746887"><span class="hs-identifier hs-var">n_dmds</span></a></span><span>
</span><span id="line-278"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746811"><span class="hs-identifier hs-var">ww_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746887"><span class="hs-identifier hs-var">n_dmds</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-comment">-- | Version of 'GHC.Core.mkApps' that does beta reduction on-the-fly.</span><span>
</span><span id="line-281"></span><span class="hs-comment">-- PRECONDITION: The arg expressions are not free in any of the lambdas binders.</span><span>
</span><span id="line-282"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAppsBeta"><span class="hs-identifier hs-type">mkAppsBeta</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-283"></span><span class="hs-comment">-- The precondition holds for our call site in mkWwBodies, because all the FVs</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- of as are either cloned_arg_vars (and thus fresh) or fresh worker args.</span><span>
</span><span id="line-285"></span><span id="mkAppsBeta"><span class="annot"><span class="annottext">mkAppsBeta :: CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAppsBeta"><span class="hs-identifier hs-var hs-var">mkAppsBeta</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682746893"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746893"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682746894"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746894"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746895"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746895"><span class="hs-identifier hs-var">a</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682746896"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682746896"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Id -&gt; CoreExpr -&gt; CoreExpr -&gt; CoreExpr
Id -&gt; CoreExpr -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#bindNonRec"><span class="hs-identifier hs-var">bindNonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746893"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746895"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAppsBeta"><span class="hs-identifier hs-var">mkAppsBeta</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746894"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682746896"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-286"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAppsBeta"><span class="hs-identifier hs-var">mkAppsBeta</span></a></span><span> </span><span id="local-6989586621682746899"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746899"><span class="hs-identifier hs-var">f</span></a></span></span><span>            </span><span id="local-6989586621682746900"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682746900"><span class="hs-keyword hs-var">as</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746899"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682746900"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- See Note [Limit w/w arity]</span><span>
</span><span id="line-289"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#isWorkerSmallEnough"><span class="hs-identifier hs-type">isWorkerSmallEnough</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-290"></span><span id="isWorkerSmallEnough"><span class="annot"><span class="annottext">isWorkerSmallEnough :: Int -&gt; Int -&gt; [Id] -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#isWorkerSmallEnough"><span class="hs-identifier hs-var hs-var">isWorkerSmallEnough</span></a></span></span><span> </span><span id="local-6989586621682746901"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746901"><span class="hs-identifier hs-var">max_worker_args</span></a></span></span><span> </span><span id="local-6989586621682746902"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746902"><span class="hs-identifier hs-var">old_n_args</span></a></span></span><span> </span><span id="local-6989586621682746903"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746903"><span class="hs-identifier hs-var">vars</span></a></span></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746903"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746902"><span class="hs-identifier hs-var">old_n_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746901"><span class="hs-identifier hs-var">max_worker_args</span></a></span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-comment">-- We count only Free variables (isId) to skip Type, Kind</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-comment">-- variables which have no runtime representation.</span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-comment">-- Also if the function took 82 arguments before (old_n_args), it's fine if</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-comment">-- it takes &lt;= 82 arguments afterwards.</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#workWrapArity"><span class="hs-identifier hs-type">workWrapArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-298"></span><span class="hs-comment">-- See Note [Worker/wrapper arity and join points] in DmdAnal</span><span>
</span><span id="line-299"></span><span id="workWrapArity"><span class="annot"><span class="annottext">workWrapArity :: Id -&gt; CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#workWrapArity"><span class="hs-identifier hs-var hs-var">workWrapArity</span></a></span></span><span> </span><span id="local-6989586621682746906"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746906"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682746907"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746907"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Id -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746906"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-301"></span><span>      </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span id="local-6989586621682746910"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746910"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; Int) -&gt; [Id] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Id], CoreExpr) -&gt; [Id]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(([Id], CoreExpr) -&gt; [Id]) -&gt; ([Id], CoreExpr) -&gt; [Id]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; ([Id], CoreExpr)
forall b. Int -&gt; Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746910"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682746907"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-302"></span><span>      </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-var">NotJoinPoint</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746906"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span class="hs-comment">{-
Note [Always do CPR w/w]
~~~~~~~~~~~~~~~~~~~~~~~~
At one time we refrained from doing CPR w/w for thunks, on the grounds that
we might duplicate work.  But that is already handled by the demand analyser,
which doesn't give the CPR property if w/w might waste work: see
Note [CPR for thunks] in GHC.Core.Opt.DmdAnal.

And if something *has* been given the CPR property and we don't w/w, it's
a disaster, because then the enclosing function might say it has the CPR
property, but now doesn't and there a cascade of disaster.  A good example
is #5920.

Note [Limit w/w arity]
~~~~~~~~~~~~~~~~~~~~~~~~
Guard against high worker arity as it generates a lot of stack traffic.
A simplified example is #11565#comment:6

Current strategy is very simple: don't perform w/w transformation at all
if the result produces a wrapper with arity higher than -fmax-worker-args
and the number arguments before w/w (see #18122).

It is a bit all or nothing, consider

        f (x,y) (a,b,c,d,e ... , z) = rhs

Currently we will remove all w/w ness entirely. But actually we could
w/w on the (x,y) pair... it's the huge product that is the problem.

Could we instead refrain from w/w on an arg-by-arg basis? Yes, that'd
solve f. But we can get a lot of args from deeply-nested products:

        g (a, (b, (c, (d, ...)))) = rhs

This is harder to spot on an arg-by-arg basis. Previously mkWwStr was
given some &quot;fuel&quot; saying how many arguments it could add; when we ran
out of fuel it would stop w/wing.

Still not very clever because it had a left-right bias.

Note [Zap IdInfo on worker args]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have to zap the following IdInfo when re-using arg variables of the original
function for the worker:

  * OccInfo: Dead wrapper args now occur in Apps of the worker's call to the
    original fun body. Those occurrences will quickly cancel away with the lambdas
    of the fun body in the next run of the Simplifier, but CoreLint will complain
    in the meantime, so zap it.

We zap in mkWwBodies because we need the zapped variables when binding them in
mkWWstr (mkAbsentFiller, specifically).

Note [Do not split void functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this rather common form of binding:
        $j = \x:Void# -&gt; ...no use of x...

Since x is not used it'll be marked as absent.  But there is no point
in w/w-ing because we'll simply add (\y:Void#), see addVoidWorkerArg.

If x has a more interesting type (eg Int, or Int#), there *is* a point
in w/w so that we don't pass the argument at all.

************************************************************************
*                                                                      *
\subsection{Making wrapper args}
*                                                                      *
************************************************************************

During worker-wrapper stuff we may end up with an unlifted thing
which we want to let-bind without losing laziness.  So we
add a void argument.  E.g.

        f = /\a -&gt; \x y z -&gt; E::Int#    -- E does not mention x,y,z
==&gt;
        fw = /\ a -&gt; \void -&gt; E
        f  = /\ a -&gt; \x y z -&gt; fw realworld

We use the state-token type which generates no code.
-}</span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span class="hs-comment">-- | Whether the worker needs an additional `Void#` arg as per</span><span>
</span><span id="line-387"></span><span class="hs-comment">-- Note [Protecting the last value argument] or</span><span>
</span><span id="line-388"></span><span class="hs-comment">-- Note [Preserving float barriers].</span><span>
</span><span id="line-389"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#needsVoidWorkerArg"><span class="hs-identifier hs-type">needsVoidWorkerArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-390"></span><span id="needsVoidWorkerArg"><span class="annot"><span class="annottext">needsVoidWorkerArg :: Id -&gt; [Id] -&gt; [Id] -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#needsVoidWorkerArg"><span class="hs-identifier hs-var hs-var">needsVoidWorkerArg</span></a></span></span><span> </span><span id="local-6989586621682746915"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746915"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span> </span><span id="local-6989586621682746916"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746916"><span class="hs-identifier hs-var">wrap_args</span></a></span></span><span> </span><span id="local-6989586621682746917"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746917"><span class="hs-identifier hs-var">work_args</span></a></span></span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682746918"><span class="hs-identifier hs-var">thunk_problem</span></a></span><span>         </span><span class="hs-comment">-- See Note [Protecting the last value argument]</span><span>
</span><span id="line-392"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682746919"><span class="hs-identifier hs-var">needs_float_barrier</span></a></span><span>   </span><span class="hs-comment">-- See Note [Preserving float barriers]</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-comment">-- thunk_problem: see Note [Protecting the last value argument]</span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-comment">-- For join points we are only worried about (4), not (1-4).</span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-comment">-- And (4) can't happen if (null work_args)</span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-comment">--     (We could be more clever, by looking at the result type, but</span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-comment">--      this approach is simple and conservative.)</span><span>
</span><span id="line-399"></span><span>    </span><span id="local-6989586621682746918"><span class="annot"><span class="annottext">thunk_problem :: Bool
</span><a href="#local-6989586621682746918"><span class="hs-identifier hs-var hs-var">thunk_problem</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746915"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682746920"><span class="hs-identifier hs-var">no_value_arg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746917"><span class="hs-identifier hs-var">work_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682746920"><span class="hs-identifier hs-var">no_value_arg</span></a></span><span>
</span><span id="line-401"></span><span>    </span><span id="local-6989586621682746920"><span class="annot"><span class="annottext">no_value_arg :: Bool
</span><a href="#local-6989586621682746920"><span class="hs-identifier hs-var hs-var">no_value_arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746917"><span class="hs-identifier hs-var">work_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-comment">-- needs_float_barrier: see Note [Preserving float barriers]</span><span>
</span><span id="line-404"></span><span>    </span><span id="local-6989586621682746919"><span class="annot"><span class="annottext">needs_float_barrier :: Bool
</span><a href="#local-6989586621682746919"><span class="hs-identifier hs-var hs-var">needs_float_barrier</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682746923"><span class="hs-identifier hs-var">wrap_had_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682746924"><span class="hs-identifier hs-var">work_has_barrier</span></a></span><span>
</span><span id="line-405"></span><span>    </span><span id="local-6989586621682746925"><span class="annot"><span class="annottext">is_float_barrier :: Id -&gt; Bool
</span><a href="#local-6989586621682746925"><span class="hs-identifier hs-var hs-var">is_float_barrier</span></a></span></span><span> </span><span id="local-6989586621682746926"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746926"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746926"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#hasNoOneShotInfo"><span class="hs-identifier hs-var">hasNoOneShotInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OneShotInfo
</span><a href="GHC.Types.Id.html#idOneShotInfo"><span class="hs-identifier hs-var">idOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746926"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621682746923"><span class="annot"><span class="annottext">wrap_had_barrier :: Bool
</span><a href="#local-6989586621682746923"><span class="hs-identifier hs-var hs-var">wrap_had_barrier</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621682746925"><span class="hs-identifier hs-var">is_float_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746916"><span class="hs-identifier hs-var">wrap_args</span></a></span><span>
</span><span id="line-407"></span><span>    </span><span id="local-6989586621682746924"><span class="annot"><span class="annottext">work_has_barrier :: Bool
</span><a href="#local-6989586621682746924"><span class="hs-identifier hs-var hs-var">work_has_barrier</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621682746925"><span class="hs-identifier hs-var">is_float_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746917"><span class="hs-identifier hs-var">work_args</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="hs-comment">-- | Inserts a `Void#` arg as the last argument.</span><span>
</span><span id="line-410"></span><span class="hs-comment">-- Why last? See Note [Worker/wrapper needs to add void arg last]</span><span>
</span><span id="line-411"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#addVoidWorkerArg"><span class="hs-identifier hs-type">addVoidWorkerArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-412"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Lambda bound args</span><span>
</span><span id="line-413"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Args at call site</span><span>
</span><span id="line-414"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- str semantics for the worker args</span><span>
</span><span id="line-415"></span><span id="addVoidWorkerArg"><span class="annot"><span class="annottext">addVoidWorkerArg :: [Id] -&gt; [StrictnessMark] -&gt; ([Id], [Id], [StrictnessMark])
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#addVoidWorkerArg"><span class="hs-identifier hs-var hs-var">addVoidWorkerArg</span></a></span></span><span> </span><span id="local-6989586621682746929"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746929"><span class="hs-identifier hs-var">work_args</span></a></span></span><span> </span><span id="local-6989586621682746930"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682746930"><span class="hs-identifier hs-var">str_marks</span></a></span></span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746929"><span class="hs-identifier hs-var">work_args</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Types.Id.Make.html#voidArgId"><span class="hs-identifier hs-var">voidArgId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746929"><span class="hs-identifier hs-var">work_args</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Types.Id.Make.html#voidPrimId"><span class="hs-identifier hs-var">voidPrimId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682746930"><span class="hs-identifier hs-var">str_marks</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark] -&gt; [StrictnessMark] -&gt; [StrictnessMark]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span class="hs-comment">{-
Note [Protecting the last value argument]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the user writes (\_ -&gt; E), they might be intentionally disallowing
the sharing of E. Since absence analysis and worker-wrapper are keen
to remove such unused arguments, we add in a void argument to prevent
the function from becoming a thunk.  Here are several reasons why turning
a function into a thunk might be bad:

1) It can create a space leak. e.g.
      f x = let y () = [1..x]
            in (sum (y ()) + length (y ()))
   As written it'll calculate [1..x] twice, and avoid keeping a big
   list around.  (Of course let-floating may introduce the leak; but
   at least w/w doesn't.)

2) It can prevent inlining *under a lambda*. e.g.
       g = \y. [1..100]
       f = \t. g ()
   Here we can inline g under the \t.  But we won't if we remove the \y.

3) It can create an unlifted binding.  E.g.
       g :: Int -&gt; Int#
       g = \x. 30#
   Removing the \x would leave an unlifted binding.

4) It can create a worker of ill-kinded type (#22275).  Consider
     f :: forall r (a :: TYPE r). () -&gt; a
     f x = f x
   Here `x` is absent, but if we simply drop it we'd end up with
     $wf :: forall r (a :: TYPE r). a
   But alas $wf's type is ill-kinded: the kind of (/\r (a::TYPE r).a)
   is (TYPE r), which mentions the bound variable `r`.  See also
   Note [Worker/wrapper needs to add void arg last]

See also Note [Preserving float barriers]

NB: Of these, only (1-3) don't apply to a join point, which can be
unlifted even if the RHS is not ok-for-speculation.

Note [Preserving float barriers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
```
let
  t = sum [0..x]
  f a{os} b[Dmd=A] c{os} = ... t ...
in f 1 2 3 + f 4 5 6
```
Here, we would like to drop the argument `b` because it's absent. But doing so
leaves behind only one-shot lambdas, `$wf a{os} c{os} = ...`, and then the
Simplifier will inline `t` into `$wf`, because `$wf` says &quot;I'm only called
once&quot;. That's bad, because we lost sharing of `t`! Similarly, FloatIn would
happily float `t` into `$wf`, see Note [Floating in past a lambda group].

Why does floating happen after dropping `b` but not before? Because `b` was the
only non-one-shot value lambda left, acting as our &quot;float barrier&quot;.

Definition:  A float barrier is a non-one-shot value lambda.
Key insight: If `f` had a float barrier, `$wf` has to have one, too.

To this end, in `needsVoidWorkerArg`, we check whether the wrapper had a float
barrier and if the worker has none so far. If that is the case, we add a `Void#`
argument at the end as an artificial float barrier.

The issue is tracked in #21150. It came up when compiling GHC itself, in
GHC.Tc.Gen.Bind.mkEdges. There the key_map thunk was inlined after WW dropped a
leading absent non-one-shot arg. Here are some example wrapper arguments of
which some are absent or one-shot and the resulting worker arguments:

  * \a{Abs}.\b{os}.\c{os}... ==&gt; \b{os}.\c{os}.\(_::Void#)...
    Wrapper arg `a` was the only float barrier and had been dropped. Hence Void#
p  * \a{Abs,os}.\b{os}.\c... ==&gt; \b{os}.\c...
    Worker arg `c` is a float barrier.
  * \a.\b{Abs}.\c{os}... ==&gt; \a.\c{os}...
    Worker arg `a` is a float barrier.
  * \a{os}.\b{Abs,os}.\c{os}... ==&gt; \a{os}.\c{os}...
    Wrapper didn't have a float barrier, no need for Void#.
  * \a{Abs,os}.... ==&gt; ... (no value lambda left)
    This examples simply demonstrates that preserving float barriers is not
    enough to subsume Note [Protecting the last value argument].

Executable examples in T21150.

Note [Worker/wrapper needs to add void arg last]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider point (4) of Note [Protecting the last value argument]

  f :: forall r (a :: TYPE r). () -&gt; a
  f x = f x

As pointed out in (4) we need to add a void argument.  But if we add
it /first/ we'd get

  $wf :: Void# -&gt; forall r (a :: TYPE r). a
  $wf = ...

But alas $wf's type is /still/ still-kinded, just as before in (4).
Solution is simple: put the void argument /last/:

  $wf :: forall r (a :: TYPE r). Void# -&gt; a
  $wf = ...

c.f Note [SpecConstr void argument insertion] in GHC.Core.Opt.SpecConstr

Note [Join points and beta-redexes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Originally, the worker would invoke the original function by calling it with
arguments, thus producing a beta-redex for the simplifier to munch away:

  \x y z -&gt; e =&gt; (\x y z -&gt; e) wx wy wz

Now that we have special rules about join points, however, this is Not Good if
the original function is itself a join point, as then it may contain invocations
of other join points:

  join j1 x = ...
  join j2 y = if y == 0 then 0 else j1 y

  =&gt;

  join j1 x = ...
  join $wj2 y# = let wy = I# y# in (\y -&gt; if y == 0 then 0 else jump j1 y) wy
  join j2 y = case y of I# y# -&gt; jump $wj2 y#

There can't be an intervening lambda between a join point's declaration and its
occurrences, so $wj2 here is wrong. But of course, this is easy enough to fix:

  ...
  let join $wj2 y# = let wy = I# y# in let y = wy in if y == 0 then 0 else j1 y
  ...

Hence we simply do the beta-reduction here. (This would be harder if we had to
worry about hygiene, but luckily wy is freshly generated.)

Note [Freshen WW arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we do a worker/wrapper split, we must freshen the arg vars of the original
fun RHS because they might shadow each other. E.g.

  f :: forall a. Maybe a -&gt; forall a. Maybe a -&gt; Int -&gt; Int
  f @a x @a y z = case x &lt;|&gt; y of
    Nothing -&gt; z
    Just _  -&gt; z + 1

  ==&gt; {WW split unboxing the Int}

  $wf :: forall a. Maybe a -&gt; forall a. Maybe a -&gt; Int# -&gt; Int
  $wf @a x @a y wz = (\@a x @a y z -&gt; case x &lt;|&gt; y of ...) ??? x @a y (I# wz)

(Notice that the code we actually emit will sort-of ANF-ise the lambda args,
leading to even more shadowing issues. The above demonstrates that even if we
try harder we'll still get shadowing issues.)

What should we put in place for ??? ? Certainly not @a, because that would
reference the wrong, inner a. A similar situation occurred in #12562, we even
saw a type variable in the worker shadowing an outer term-variable binding.

We avoid the issue by freshening the argument variables from the original fun
RHS through 'cloneBndrs', which will also take care of substitution in binder
types. Fortunately, it's sufficient to pick the FVs of the arg vars as in-scope
set, so that we don't need to do a FV traversal over the whole body of the
original function.

At the moment, #12562 has no regression test. As such, this Note is not covered
by any test logic or when bootstrapping the compiler. Yet we clearly want to
freshen the binders, as the example above demonstrates.
Adding a Core pass that maximises shadowing for testing purposes might help,
see #17478.
-}</span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Unboxing Decision for Strictness and CPR}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span class="hs-comment">-- | The information needed to build a pattern for a DataCon to be unboxed.</span><span>
</span><span id="line-600"></span><span class="hs-comment">-- The pattern can be generated from 'dcpc_dc' and 'dcpc_tc_args' via</span><span>
</span><span id="line-601"></span><span class="hs-comment">-- 'GHC.Core.Utils.dataConRepInstPat'. The coercion 'dcpc_co' is for newtype</span><span>
</span><span id="line-602"></span><span class="hs-comment">-- wrappers.</span><span>
</span><span id="line-603"></span><span class="hs-comment">--</span><span>
</span><span id="line-604"></span><span class="hs-comment">-- If we get @DataConPatContext dc tys co@ for some type @ty@</span><span>
</span><span id="line-605"></span><span class="hs-comment">-- and @dataConRepInstPat ... dc tys = (exs, flds)@, then</span><span>
</span><span id="line-606"></span><span class="hs-comment">--</span><span>
</span><span id="line-607"></span><span class="hs-comment">--   * @dc @exs flds :: T tys@</span><span>
</span><span id="line-608"></span><span class="hs-comment">--   * @co :: T tys ~ ty@</span><span>
</span><span id="line-609"></span><span class="hs-comment">--</span><span>
</span><span id="line-610"></span><span class="hs-comment">-- 's' will be 'Demand' or 'Cpr'.</span><span>
</span><span id="line-611"></span><span class="hs-keyword">data</span><span> </span><span id="DataConPatContext"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-var">DataConPatContext</span></a></span></span><span> </span><span id="local-6989586621682746553"><span class="annot"><a href="#local-6989586621682746553"><span class="hs-identifier hs-type">s</span></a></span></span><span>
</span><span id="line-612"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="DataConPatContext"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-var">DataConPatContext</span></a></span></span><span>
</span><span id="line-613"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="dcpc_dc"><span class="annot"><span class="annottext">forall s. DataConPatContext s -&gt; DataCon
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_dc"><span class="hs-identifier hs-var hs-var">dcpc_dc</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span>
</span><span id="line-614"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="dcpc_tc_args"><span class="annot"><span class="annottext">forall s. DataConPatContext s -&gt; [Kind]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_tc_args"><span class="hs-identifier hs-var hs-var">dcpc_tc_args</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-615"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="dcpc_co"><span class="annot"><span class="annottext">forall s. DataConPatContext s -&gt; Coercion
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_co"><span class="hs-identifier hs-var hs-var">dcpc_co</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-616"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="dcpc_args"><span class="annot"><span class="annottext">forall s. DataConPatContext s -&gt; [s]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_args"><span class="hs-identifier hs-var hs-var">dcpc_args</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682746553"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-617"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span class="hs-comment">-- | Describes the outer shape of an argument to be unboxed or left as-is</span><span>
</span><span id="line-620"></span><span class="hs-comment">-- Depending on how @s@ is instantiated (e.g., 'Demand' or 'Cpr').</span><span>
</span><span id="line-621"></span><span class="hs-keyword">data</span><span> </span><span id="UnboxingDecision"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#UnboxingDecision"><span class="hs-identifier hs-var">UnboxingDecision</span></a></span></span><span> </span><span id="local-6989586621682746566"><span class="annot"><a href="#local-6989586621682746566"><span class="hs-identifier hs-type">unboxing_info</span></a></span></span><span>
</span><span id="line-622"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="DontUnbox"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span></span><span>               </span><span class="annot"><span class="hs-comment">-- ^ We ran out of strictness info. Leave untouched.</span></span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DoUnbox"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-var">DoUnbox</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621682746566"><span class="hs-identifier hs-type">unboxing_info</span></a></span><span>  </span><span class="hs-comment">-- ^ The argument is used strictly or the</span><span>
</span><span id="line-624"></span><span>                            </span><span class="hs-comment">-- returned product was constructed, so unbox it.</span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DropAbsent"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DropAbsent"><span class="hs-identifier hs-var">DropAbsent</span></a></span></span><span>              </span><span class="annot"><span class="hs-comment">-- ^ The argument/field was absent. Drop it.</span></span><span>
</span><span id="line-626"></span><span>
</span><span id="line-627"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682746562"><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746562"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#UnboxingDecision"><span class="hs-identifier hs-type">UnboxingDecision</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682746562"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-628"></span><span>  </span><span id="local-6989586621682746950"><span class="annot"><span class="annottext">ppr :: UnboxingDecision i -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">UnboxingDecision i
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;DontUnbox&quot;</span></span><span>
</span><span id="line-629"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">UnboxingDecision i
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DropAbsent"><span class="hs-identifier hs-var">DropAbsent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;DropAbsent&quot;</span></span><span>
</span><span id="line-630"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-type">DoUnbox</span></a></span><span> </span><span id="local-6989586621682746951"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621682746951"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;DoUnbox&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">i -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621682746951"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-631"></span><span>
</span><span id="line-632"></span><span class="annot"><span class="hs-comment">-- | Do we want to create workers just for unlifting?</span></span><span>
</span><span id="line-633"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#wwUseForUnlifting"><span class="hs-identifier hs-type">wwUseForUnlifting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-type">WwUse</span></a></span><span>
</span><span id="line-634"></span><span id="wwUseForUnlifting"><span class="annot"><span class="annottext">wwUseForUnlifting :: WwOpts -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wwUseForUnlifting"><span class="hs-identifier hs-var hs-var">wwUseForUnlifting</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682746956"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682746956"><span class="hs-identifier hs-var">opts</span></a></span></span><span>
</span><span id="line-635"></span><span>    </span><span class="hs-comment">-- Always unlift if possible</span><span>
</span><span id="line-636"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_unlift_strict"><span class="hs-identifier hs-var">wo_unlift_strict</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682746956"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#usefulSplit"><span class="hs-identifier hs-var">usefulSplit</span></a></span><span>
</span><span id="line-637"></span><span>    </span><span class="hs-comment">-- Don't unlift  it would cause additional W/W splits.</span><span>
</span><span id="line-638"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-var">boringSplit</span></a></span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span class="annot"><span class="hs-comment">-- | Is the worker/wrapper split profitable?</span></span><span>
</span><span id="line-641"></span><span class="hs-keyword">type</span><span> </span><span id="WwUse"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-var">WwUse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span class="annot"><span class="hs-comment">-- | WW split not profitable</span></span><span>
</span><span id="line-644"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-type">boringSplit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-type">WwUse</span></a></span><span>
</span><span id="line-645"></span><span id="boringSplit"><span class="annot"><span class="annottext">boringSplit :: Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-var hs-var">boringSplit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-646"></span><span>
</span><span id="line-647"></span><span class="annot"><span class="hs-comment">-- | WW split profitable</span></span><span>
</span><span id="line-648"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#usefulSplit"><span class="hs-identifier hs-type">usefulSplit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-type">WwUse</span></a></span><span>
</span><span id="line-649"></span><span id="usefulSplit"><span class="annot"><span class="annottext">usefulSplit :: Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#usefulSplit"><span class="hs-identifier hs-var hs-var">usefulSplit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-650"></span><span>
</span><span id="line-651"></span><span class="hs-comment">-- | Unwraps the 'Boxity' decision encoded in the given 'SubDemand' and returns</span><span>
</span><span id="line-652"></span><span class="hs-comment">-- a 'DataConPatContext' as well the nested demands on fields of the 'DataCon'</span><span>
</span><span id="line-653"></span><span class="hs-comment">-- to unbox.</span><span>
</span><span id="line-654"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#canUnboxArg"><span class="hs-identifier hs-type">canUnboxArg</span></a></span><span>
</span><span id="line-655"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-656"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>        </span><span class="annot"><span class="hs-comment">-- ^ Type of the argument</span></span><span>
</span><span id="line-657"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ How the arg was used</span></span><span>
</span><span id="line-658"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#UnboxingDecision"><span class="hs-identifier hs-type">UnboxingDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-type">DataConPatContext</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span class="hs-comment">-- See Note [Which types are unboxed?]</span><span>
</span><span id="line-660"></span><span id="canUnboxArg"><span class="annot"><span class="annottext">canUnboxArg :: FamInstEnvs
-&gt; Kind -&gt; Demand -&gt; UnboxingDecision (DataConPatContext Demand)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#canUnboxArg"><span class="hs-identifier hs-var hs-var">canUnboxArg</span></a></span></span><span> </span><span id="local-6989586621682746957"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621682746957"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621682746958"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682746958"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746959"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682746959"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span id="local-6989586621682746961"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682746961"><span class="hs-identifier hs-var">sd</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-661"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Card -&gt; Bool
</span><a href="GHC.Types.Demand.html#isAbs"><span class="hs-identifier hs-var">isAbs</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682746959"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnboxingDecision (DataConPatContext Demand)
forall unboxing_info. UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DropAbsent"><span class="hs-identifier hs-var">DropAbsent</span></a></span><span>
</span><span id="line-663"></span><span>
</span><span id="line-664"></span><span>  </span><span class="hs-comment">-- From here we are strict and not absent</span><span>
</span><span id="line-665"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746963"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682746963"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746964"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682746964"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746965"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682746965"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; Kind -&gt; Maybe (TyCon, [Kind], Coercion)
</span><a href="GHC.Core.Utils.html#normSplitTyConApp_maybe"><span class="hs-identifier hs-var">normSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621682746957"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682746958"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-666"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682746967"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682746967"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe DataCon
</span><a href="GHC.Core.TyCon.html#tyConSingleAlgDataCon_maybe"><span class="hs-identifier hs-var">tyConSingleAlgDataCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682746963"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-667"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682746969"><span class="annot"><span class="annottext">arity :: Int
</span><a href="#local-6989586621682746969"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Int
</span><a href="GHC.Core.DataCon.html#dataConRepArity"><span class="hs-identifier hs-var">dataConRepArity</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682746967"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-668"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746972"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682746972"><span class="hs-identifier hs-var">dmds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SubDemand -&gt; Maybe (Boxity, [Demand])
</span><a href="GHC.Types.Demand.html#viewProd"><span class="hs-identifier hs-var">viewProd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746969"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682746961"><span class="hs-identifier hs-var">sd</span></a></span><span> </span><span class="hs-comment">-- See Note [Boxity analysis]</span><span>
</span><span id="line-669"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682746972"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthIs"><span class="hs-operator hs-var">`lengthIs`</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Int
</span><a href="GHC.Core.DataCon.html#dataConRepArity"><span class="hs-identifier hs-var">dataConRepArity</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682746967"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-670"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataConPatContext Demand
-&gt; UnboxingDecision (DataConPatContext Demand)
forall unboxing_info.
unboxing_info -&gt; UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-var">DoUnbox</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-type">DataConPatContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dcpc_dc :: DataCon
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_dc"><span class="hs-identifier hs-var">dcpc_dc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682746967"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_tc_args :: [Kind]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_tc_args"><span class="hs-identifier hs-var">dcpc_tc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682746964"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-671"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_co :: Coercion
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_co"><span class="hs-identifier hs-var">dcpc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682746965"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_args :: [Demand]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_args"><span class="hs-identifier hs-var">dcpc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682746972"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-672"></span><span>
</span><span id="line-673"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-674"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnboxingDecision (DataConPatContext Demand)
forall unboxing_info. UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span>
</span><span id="line-677"></span><span class="annot"><span class="hs-comment">-- | Unboxing strategy for constructed results.</span></span><span>
</span><span id="line-678"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#canUnboxResult"><span class="hs-identifier hs-type">canUnboxResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#Cpr"><span class="hs-identifier hs-type">Cpr</span></a></span><span>
</span><span id="line-679"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#UnboxingDecision"><span class="hs-identifier hs-type">UnboxingDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-type">DataConPatContext</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#Cpr"><span class="hs-identifier hs-type">Cpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span class="hs-comment">-- See Note [Which types are unboxed?]</span><span>
</span><span id="line-681"></span><span id="canUnboxResult"><span class="annot"><span class="annottext">canUnboxResult :: FamInstEnvs
-&gt; Kind -&gt; Cpr -&gt; UnboxingDecision (DataConPatContext Cpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#canUnboxResult"><span class="hs-identifier hs-var hs-var">canUnboxResult</span></a></span></span><span> </span><span id="local-6989586621682746976"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621682746976"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621682746977"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682746977"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682746978"><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621682746978"><span class="hs-identifier hs-var">cpr</span></a></span></span><span>
</span><span id="line-682"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746979"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746979"><span class="hs-identifier hs-var">con_tag</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746980"><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621682746980"><span class="hs-identifier hs-var">arg_cprs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cpr -&gt; Maybe (Int, [Cpr])
</span><a href="GHC.Types.Cpr.html#asConCpr"><span class="hs-identifier hs-var">asConCpr</span></a></span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621682746978"><span class="hs-identifier hs-var">cpr</span></a></span><span>
</span><span id="line-683"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746982"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682746982"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746983"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682746983"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682746984"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682746984"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; Kind -&gt; Maybe (TyCon, [Kind], Coercion)
</span><a href="GHC.Core.Utils.html#normSplitTyConApp_maybe"><span class="hs-identifier hs-var">normSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621682746976"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682746977"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682746985"><span class="annot"><span class="annottext">[DataCon]
</span><a href="#local-6989586621682746985"><span class="hs-identifier hs-var">dcs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe [DataCon]
</span><a href="GHC.Core.TyCon.html#tyConAlgDataCons_maybe"><span class="hs-identifier hs-var">tyConAlgDataCons_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682746982"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [DataCon] -&gt; Maybe [DataCon] -&gt; Maybe [DataCon]
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DataCon]
</span><a href="#local-6989586621682746987"><span class="hs-identifier hs-var">open_body_ty_warning</span></a></span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DataCon]
</span><a href="#local-6989586621682746985"><span class="hs-identifier hs-var">dcs</span></a></span><span> </span><span class="annot"><span class="annottext">[DataCon] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthAtLeast"><span class="hs-operator hs-var">`lengthAtLeast`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746979"><span class="hs-identifier hs-var">con_tag</span></a></span><span> </span><span class="hs-comment">-- This might not be true if we import the</span><span>
</span><span id="line-686"></span><span>                                </span><span class="hs-comment">-- type constructor via a .hs-boot file (#8743)</span><span>
</span><span id="line-687"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682746989"><span class="annot"><span class="annottext">dc :: DataCon
</span><a href="#local-6989586621682746989"><span class="hs-identifier hs-var hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DataCon]
</span><a href="#local-6989586621682746985"><span class="hs-identifier hs-var">dcs</span></a></span><span> </span><span class="annot"><span class="annottext">[DataCon] -&gt; Int -&gt; DataCon
forall a. Outputable a =&gt; [a] -&gt; Int -&gt; a
</span><a href="GHC.Data.List.SetOps.html#getNth"><span class="hs-operator hs-var">`getNth`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682746979"><span class="hs-identifier hs-var">con_tag</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="GHC.Types.Basic.html#fIRST_TAG"><span class="hs-identifier hs-var">fIRST_TAG</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-688"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [Id]
</span><a href="GHC.Core.DataCon.html#dataConExTyCoVars"><span class="hs-identifier hs-var">dataConExTyCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682746989"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- no existentials;</span><span>
</span><span id="line-689"></span><span>                                </span><span class="hs-comment">-- See (CPR1) in Note [Which types are unboxed?]</span><span>
</span><span id="line-690"></span><span>                                </span><span class="hs-comment">-- and GHC.Core.Opt.CprAnal.argCprType</span><span>
</span><span id="line-691"></span><span>                                </span><span class="hs-comment">-- where we also check this.</span><span>
</span><span id="line-692"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Kind] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [Kind]
</span><a href="GHC.Core.DataCon.html#dataConTheta"><span class="hs-identifier hs-var">dataConTheta</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682746989"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- no constraints;</span><span>
</span><span id="line-693"></span><span>                           </span><span class="hs-comment">-- See (CPR2) in Note [Which types are unboxed?]</span><span>
</span><span id="line-694"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataConPatContext Cpr -&gt; UnboxingDecision (DataConPatContext Cpr)
forall unboxing_info.
unboxing_info -&gt; UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-var">DoUnbox</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-type">DataConPatContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dcpc_dc :: DataCon
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_dc"><span class="hs-identifier hs-var">dcpc_dc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682746989"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_tc_args :: [Kind]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_tc_args"><span class="hs-identifier hs-var">dcpc_tc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682746983"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-695"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_co :: Coercion
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_co"><span class="hs-identifier hs-var">dcpc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682746984"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_args :: [Cpr]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_args"><span class="hs-identifier hs-var">dcpc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621682746980"><span class="hs-identifier hs-var">arg_cprs</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-696"></span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnboxingDecision (DataConPatContext Cpr)
forall unboxing_info. UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-701"></span><span>    </span><span class="hs-comment">-- See Note [non-algebraic or open body type warning]</span><span>
</span><span id="line-702"></span><span>    </span><span id="local-6989586621682746987"><span class="annot"><span class="annottext">open_body_ty_warning :: Maybe [DataCon]
</span><a href="#local-6989586621682746987"><span class="hs-identifier hs-var hs-var">open_body_ty_warning</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; Maybe [DataCon] -&gt; Maybe [DataCon]
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canUnboxResult: non-algebraic or open body type&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682746977"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe [DataCon]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span class="hs-comment">{- Note [Which types are unboxed?]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Worker/wrapper will unbox

  1. A strict data type argument, that
       * is an algebraic data type (not a newtype)
       * is not recursive (as per 'isRecDataCon')
       * has a single constructor (thus is a &quot;product&quot;)
       * that may bind existentials (#18982)
     We can transform
     &gt; data D a = forall b. D a b
     &gt; f (D @ex a b) = e
     to
     &gt; $wf @ex a b = e
     via 'mkWWstr'.

  2. The constructed result of a function, if
       * its type is an algebraic data type (not a newtype)
       * is not recursive (as per 'isRecDataCon')
       * (might have multiple constructors, in contrast to (1))
       * the applied data constructor *does not* bind existentials
       * nor does it bind constraints (equalities or dictionaries)
     We can transform
     &gt; f x y = let ... in D a b
     to
     &gt; $wf x y = let ... in (# a, b #)
     via 'mkWWcpr'.

     (CPR1).  We don't allow existentials for CPR W/W, because we don't have
     unboxed dependent tuples (yet?). Otherwise, we could transform
     &gt; f x y = let ... in D @ex (a :: ..ex..) (b :: ..ex..)
     to
     &gt; $wf x y = let ... in (# @ex, (a :: ..ex..), (b :: ..ex..) #)

     (CPR2) we don't allow constraints for CPR W/W, because an unboxed tuple
     contains types of kind `TYPE rr`, but not of kind `CONSTRAINT rr`.
     This is annoying; there is no real reason for this except that we don't
     have TYPE/CONSTAINT polymorphism.  See Note [TYPE and CONSTRAINT]
     in GHC.Builtin.Types.Prim.

The respective tests are in 'canUnboxArg' and
'canUnboxResult', respectively.

Note [mkWWstr and unsafeCoerce]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
By using unsafeCoerce, it is possible to make the number of demands fail to
match the number of constructor arguments; this happened in #8037.
If so, the worker/wrapper split doesn't work right and we get a Core Lint
bug.  The fix here is simply to decline to do w/w if that happens.

Note [non-algebraic or open body type warning]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There are a few cases where the W/W transformation is told that something
returns a constructor, but the type at hand doesn't really match this. One
real-world example involves unsafeCoerce:
  foo = IO a
  foo = unsafeCoerce c_exit
  foreign import ccall &quot;c_exit&quot; c_exit :: IO ()
Here CPR will tell you that `foo` returns a () constructor for sure, but trying
to create a worker/wrapper for type `a` obviously fails.
(This was a real example until ee8e792  in libraries/base.)

It does not seem feasible to avoid all such cases already in the analyser (and
after all, the analysis is not really wrong), so we simply do nothing here in
mkWWcpr. But we still want to emit warning with -DDEBUG, to hopefully catch
other cases where something went avoidably wrong.

This warning also triggers for the stream fusion library within `text`.
We can't easily W/W constructed results like `Stream` because we have no simple
way to express existential types in the worker's type signature.

Note [WW for calling convention]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we know a function f will always evaluate a particular argument
we might decide that it should rather get evaluated by the caller.
We call this &quot;unlifting&quot; the argument.
Sometimes the caller knows that the argument is already evaluated,
so we won't generate any code to enter/evaluate the argument.
This evaluation avoidance can be quite beneficial.
Especially for recursive functions who pass the same lifted argument
along on each iteration or walk over strict data structures.

One way to achieve this is to do a W/W split, where the wrapper does
the evaluation, and the worker can treat its arguments as unlifted.
The wrapper is small and will be inlined at almost all call sites and
the evaluation code in the wrapper can then cancel out with evaluation
done by the calling context if the argument is evaluated there.
Same idea as W/W to avoid allocation really, just for a different kind
of work.

Performing W/W might not always be a win. In particular it's easy to break
(badly written, but common) rule frameworks by doing additional W/W splits.
See #20364 for a more detailed explanation.

Hence we have the following strategies with different trade-offs:

A) Never do W/W *just* for unlifting of arguments.
  + Very conservative - doesn't break any rules
  - Lot's of performance left on the table

B) Do W/W on just about anything where it might be
  beneficial.
  + Exploits pretty much every opportunity for unlifting.
  - A bit of compile time/code size cost for all the wrappers.
  - Can break rules which would otherwise fire. See #20364.

C) Unlift *any* (non-boot exported) functions arguments if they are strict.
  That is instead of creating a Worker with the new calling convention we
  change the calling convention of the binding itself.
  + Exploits every opportunity for unlifting.
  + Maybe less bad interactions with rules.
  - Requires tracking of boot-exported definitions.
  - Requires either:
    ~ Eta-expansion at *all* call sites in order to generate
      an impedance matcher function. Leading to massive code bloat.
      Essentially we end up creating a impromptu wrapper function
      wherever we wouldn't inline the wrapper with a W/W approach.
    ~ There is the option of achieving this without eta-expansion if we instead expand
      the partial application code to check for demands on the calling convention and
      for it to evaluate the arguments. The main downsides there would be the complexity
      of the implementation and that it carries a certain overhead even for functions who
      don't take advantage of this functionality. I haven't tried this approach because it's
      not trivial to implement and doing W/W splits seems to work well enough.

Currently we use the first approach A) by default, with a flag that allows users to fall back to the
more aggressive approach B).

I also tried the third approach C) using eta-expansion at call sites to avoid modifying the PAP-handling
code which wasn't fruitful. See https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5614#note_389903.
We could still try to do C) in the future by having PAP calls which will evaluate the required arguments
before calling the partially applied function. But this would be neither a small nor simple change so we
stick with A) and a flag for B) for now.

See also Note [Tag Inference] and Note [CBV Function Ids]

Note [Worker/wrapper for strict arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    f x = case x of
             []     -&gt; blah
             (y:ys) -&gt; f ys

Clearly `f` is strict, but its argument is not a product type, so by default
we don't worker/wrapper it.  But it is arguably valuable to do so.  We could
do this:

   f x = case x of xx { DEFAULT -&gt; $wf xx }
   $wf xx = case xx of
              []     -&gt; blah
              (y:ys) -&gt; f ys

Now the worker `$wf` knows that its argument `xx` will be evaluated
and properly tagged, so the code for the `case xx` does not need to do
an &quot;eval&quot; (see `GHC.StgToCmm.Expr.cgCase`).  A call (f (a:as)) will
have the wrapper inlined, and will drop the `case x`, so no eval
happens at all.

The worker `$wf` is a CBV function (see `Note [CBV Function Ids]`
in GHC.Types.Id.Info) and the code generator guarantees that every
call to `$wf` has a properly tagged argument (see `GHC.Stg.InferTags.Rewrite`).

Is this a win?  Not always:
* It can cause slight codesize increases. This is since we push evals to every
  call sites which there might be many. And the evals will only disappear at
  call sites where we already known that the argument is evaluated.

* It will also cause many more functions to get a worker/wrapper split
  which can play badly with rules (see Ticket #20364).  In particular
  if you depend on rules firing on functions marked as NOINLINE
  without marking use sites of these functions as INLINE or INLINEABLE
  then things will break.
  But if you want a function to match in a RULE, it is /in any case/ good practice to
  have a `INLINE[1]` or `NOINLNE[1]` pragma, to ensure that it doesn't inline until
  the rule has had a chance to fire.

So there is a flag, `-fworker-wrapper-cbv`, to control whether we do
w/w on strict arguments (internally `Opt_WorkerWrapperUnlift`).  The
flag is off by default.  The choice is made in
GHC.Core.Opt.WorkWrape.Utils.wwUseForUnlifting

See also `Note [WW for calling convention]` in GHC.Core.Opt.WorkWrap.Utils
-}</span><span>
</span><span id="line-886"></span><span>
</span><span id="line-887"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Worker/wrapper for Strictness and Absence}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-894"></span><span>
</span><span id="line-895"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr"><span class="hs-identifier hs-type">mkWWstr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span>
</span><span id="line-896"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>                         </span><span class="hs-comment">-- Wrapper args; have their demand info on them</span><span>
</span><span id="line-897"></span><span>                                         </span><span class="hs-comment">--  *Includes type variables*</span><span>
</span><span id="line-898"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- Strictness-mark info for arguments</span><span>
</span><span id="line-899"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-type">WwUse</span></a></span><span class="hs-special">,</span><span>                </span><span class="hs-comment">-- Will this result in a useful worker</span><span>
</span><span id="line-900"></span><span>                   </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- Worker args/their call-by-value semantics.</span><span>
</span><span id="line-901"></span><span>                   </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Wrapper body, lacking the worker call</span><span>
</span><span id="line-902"></span><span>                                         </span><span class="hs-comment">-- and without its lambdas</span><span>
</span><span id="line-903"></span><span>                                         </span><span class="hs-comment">-- This fn adds the unboxing</span><span>
</span><span id="line-904"></span><span>                   </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Reboxed args for the call to the</span><span>
</span><span id="line-905"></span><span>                                         </span><span class="hs-comment">-- original RHS. Corresponds one-to-one</span><span>
</span><span id="line-906"></span><span>                                         </span><span class="hs-comment">-- with the wrapper arg vars</span><span>
</span><span id="line-907"></span><span id="mkWWstr"><span class="annot"><span class="annottext">mkWWstr :: WwOpts
-&gt; [Id]
-&gt; [StrictnessMark]
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, [CoreExpr])
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr"><span class="hs-identifier hs-var hs-var">mkWWstr</span></a></span></span><span> </span><span id="local-6989586621682746995"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682746995"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682746996"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746996"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682746997"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682746997"><span class="hs-identifier hs-var">str_marks</span></a></span></span><span>
</span><span id="line-908"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkWWstr&quot; (ppr args) $</span><span>
</span><span id="line-909"></span><span>    </span><span class="annot"><span class="annottext">[Id]
-&gt; [StrictnessMark]
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, [CoreExpr])
</span><a href="#local-6989586621682746998"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682746996"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682746997"><span class="hs-identifier hs-var">str_marks</span></a></span><span>
</span><span id="line-910"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-911"></span><span>    </span><span id="local-6989586621682746998"><span class="annot"><span class="annottext">go :: [Id]
-&gt; [StrictnessMark]
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, [CoreExpr])
</span><a href="#local-6989586621682746998"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, [CoreExpr])
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, [CoreExpr])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-var">boringSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-var">nop_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-912"></span><span>    </span><span class="annot"><a href="#local-6989586621682746998"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682746999"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746999"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682747000"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747000"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747001"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682747001"><span class="hs-identifier hs-var">str</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682747002"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682747002"><span class="hs-identifier hs-var">strs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747003"><span class="annot"><a href="#local-6989586621682747003"><span class="hs-identifier hs-var">useful1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747004"><span class="annot"><a href="#local-6989586621682747004"><span class="hs-identifier hs-var">args1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747005"><span class="annot"><a href="#local-6989586621682747005"><span class="hs-identifier hs-var">wrap_fn1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747006"><span class="annot"><a href="#local-6989586621682747006"><span class="hs-identifier hs-var">wrap_arg</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts
-&gt; Id
-&gt; StrictnessMark
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr_one"><span class="hs-identifier hs-var">mkWWstr_one</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682746995"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682746999"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682747001"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-914"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747007"><span class="annot"><a href="#local-6989586621682747007"><span class="hs-identifier hs-var">useful2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747008"><span class="annot"><a href="#local-6989586621682747008"><span class="hs-identifier hs-var">args2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747009"><span class="annot"><a href="#local-6989586621682747009"><span class="hs-identifier hs-var">wrap_fn2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747010"><span class="annot"><a href="#local-6989586621682747010"><span class="hs-identifier hs-var">wrap_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682746998"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747000"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747002"><span class="hs-identifier hs-type">strs</span></a></span><span>
</span><span id="line-915"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621682747003"><span class="hs-identifier hs-type">useful1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="#local-6989586621682747007"><span class="hs-identifier hs-type">useful2</span></a></span><span>
</span><span id="line-916"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747004"><span class="hs-identifier hs-type">args1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682747008"><span class="hs-identifier hs-type">args2</span></a></span><span>
</span><span id="line-917"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747005"><span class="hs-identifier hs-type">wrap_fn1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="#local-6989586621682747009"><span class="hs-identifier hs-type">wrap_fn2</span></a></span><span>
</span><span id="line-918"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747006"><span class="hs-identifier hs-type">wrap_arg</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621682747010"><span class="hs-identifier hs-type">wrap_args</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-919"></span><span>    </span><span class="annot"><a href="#local-6989586621682746998"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, [CoreExpr])
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mkWWstr: Impossible - str/arg length mismatch&quot;</span></span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-922"></span><span class="hs-comment">-- mkWWstr_one wrap_var = (useful, work_args, wrap_fn, wrap_arg)</span><span>
</span><span id="line-923"></span><span class="hs-comment">--   *  wrap_fn assumes wrap_var is in scope,</span><span>
</span><span id="line-924"></span><span class="hs-comment">--        brings into scope work_args (via cases)</span><span>
</span><span id="line-925"></span><span class="hs-comment">--   * wrap_arg assumes work_args are in scope, and builds a ConApp that</span><span>
</span><span id="line-926"></span><span class="hs-comment">--        reconstructs the RHS of wrap_var that we pass to the original RHS</span><span>
</span><span id="line-927"></span><span class="hs-comment">-- See Note [Worker/wrapper for Strictness and Absence]</span><span>
</span><span id="line-928"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr_one"><span class="hs-identifier hs-type">mkWWstr_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span>
</span><span id="line-929"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>
</span><span id="line-930"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span>
</span><span id="line-931"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-type">WwUse</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span id="mkWWstr_one"><span class="annot"><span class="annottext">mkWWstr_one :: WwOpts
-&gt; Id
-&gt; StrictnessMark
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr_one"><span class="hs-identifier hs-var hs-var">mkWWstr_one</span></a></span></span><span> </span><span id="local-6989586621682747012"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747012"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682747013"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621682747014"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682747014"><span class="hs-identifier hs-var">str_mark</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-933"></span><span>  </span><span class="hs-comment">-- pprTrace &quot;mkWWstr_one&quot; (ppr arg &lt;+&gt; (if isId arg then ppr arg_ty  $$ ppr arg_dmd else text &quot;type arg&quot;)) $</span><span>
</span><span id="line-934"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
-&gt; Kind -&gt; Demand -&gt; UnboxingDecision (DataConPatContext Demand)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#canUnboxArg"><span class="hs-identifier hs-var">canUnboxArg</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621682747015"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747016"><span class="hs-identifier hs-var">arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682747017"><span class="hs-identifier hs-var">arg_dmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-935"></span><span>    </span><span class="annot"><span class="annottext">UnboxingDecision (DataConPatContext Demand)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UniqSM
  (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="#local-6989586621682747018"><span class="hs-identifier hs-var">do_nothing</span></a></span><span>
</span><span id="line-936"></span><span>
</span><span id="line-937"></span><span>    </span><span class="annot"><span class="annottext">UnboxingDecision (DataConPatContext Demand)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DropAbsent"><span class="hs-identifier hs-var">DropAbsent</span></a></span><span>
</span><span id="line-938"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682747019"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747019"><span class="hs-identifier hs-var">absent_filler</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; Id -&gt; StrictnessMark -&gt; Maybe CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAbsentFiller"><span class="hs-identifier hs-var">mkAbsentFiller</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747012"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682747014"><span class="hs-identifier hs-var">str_mark</span></a></span><span>
</span><span id="line-939"></span><span>         </span><span class="hs-comment">-- Absent case.  Drop the argument from the worker.</span><span>
</span><span id="line-940"></span><span>         </span><span class="hs-comment">-- We can't always handle absence for arbitrary</span><span>
</span><span id="line-941"></span><span>         </span><span class="hs-comment">-- unlifted types, so we need to choose just the cases we can</span><span>
</span><span id="line-942"></span><span>         </span><span class="hs-comment">-- (that's what mkAbsentFiller does)</span><span>
</span><span id="line-943"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#usefulSplit"><span class="hs-identifier hs-var">usefulSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-var">nop_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747019"><span class="hs-identifier hs-var">absent_filler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UniqSM
  (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="#local-6989586621682747018"><span class="hs-identifier hs-var">do_nothing</span></a></span><span>
</span><span id="line-945"></span><span>
</span><span id="line-946"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-type">DoUnbox</span></a></span><span> </span><span id="local-6989586621682747020"><span class="annot"><span class="annottext">DataConPatContext Demand
</span><a href="#local-6989586621682747020"><span class="hs-identifier hs-var">dcpc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkWWstr_one:1&quot; (ppr (dcpc_dc dcpc) &lt;+&gt; ppr (dcpc_tc_args dcpc) $$ ppr (dcpc_args dcpc)) $</span><span>
</span><span id="line-947"></span><span>                    </span><span class="annot"><span class="annottext">WwOpts
-&gt; Id
-&gt; DataConPatContext Demand
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#unbox_one_arg"><span class="hs-identifier hs-var">unbox_one_arg</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747012"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">DataConPatContext Demand
</span><a href="#local-6989586621682747020"><span class="hs-identifier hs-var">dcpc</span></a></span><span>
</span><span id="line-948"></span><span>
</span><span id="line-949"></span><span>    </span><span class="annot"><span class="annottext">UnboxingDecision (DataConPatContext Demand)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span>
</span><span id="line-950"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrictDmd"><span class="hs-identifier hs-var">isStrictDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682747017"><span class="hs-identifier hs-var">arg_dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">StrictnessMark -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isMarkedStrict"><span class="hs-identifier hs-var">isMarkedStrict</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682747014"><span class="hs-identifier hs-var">str_mark</span></a></span><span>
</span><span id="line-951"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wwUseForUnlifting"><span class="hs-identifier hs-var">wwUseForUnlifting</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747012"><span class="hs-identifier hs-var">opts</span></a></span><span>  </span><span class="hs-comment">-- See Note [CBV Function Ids]</span><span>
</span><span id="line-952"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747016"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-953"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Bool
Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747016"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Already unlifted!</span><span>
</span><span id="line-954"></span><span>        </span><span class="hs-comment">-- NB: function arguments have a fixed RuntimeRep,</span><span>
</span><span id="line-955"></span><span>        </span><span class="hs-comment">-- so it's OK to call isUnliftedType here</span><span>
</span><span id="line-956"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#usefulSplit"><span class="hs-identifier hs-var">usefulSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#MarkedStrict"><span class="hs-identifier hs-var">MarkedStrict</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-var">nop_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UniqSM
  (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="#local-6989586621682747018"><span class="hs-identifier hs-var">do_nothing</span></a></span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-961"></span><span>    </span><span id="local-6989586621682747015"><span class="annot"><span class="annottext">fam_envs :: FamInstEnvs
</span><a href="#local-6989586621682747015"><span class="hs-identifier hs-var hs-var">fam_envs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_fam_envs"><span class="hs-identifier hs-var">wo_fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747012"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-962"></span><span>    </span><span id="local-6989586621682747016"><span class="annot"><span class="annottext">arg_ty :: Kind
</span><a href="#local-6989586621682747016"><span class="hs-identifier hs-var hs-var">arg_ty</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-963"></span><span>    </span><span id="local-6989586621682747017"><span class="annot"><span class="annottext">arg_dmd :: Demand
</span><a href="#local-6989586621682747017"><span class="hs-identifier hs-var hs-var">arg_dmd</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-964"></span><span>    </span><span id="local-6989586621682747028"><span class="annot"><span class="annottext">arg_str :: StrictnessMark
</span><a href="#local-6989586621682747028"><span class="hs-identifier hs-var hs-var">arg_str</span></a></span></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span> </span><span class="hs-comment">-- Type args don't get strictness marks</span><span>
</span><span id="line-965"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682747014"><span class="hs-identifier hs-var">str_mark</span></a></span><span>
</span><span id="line-966"></span><span>    </span><span id="local-6989586621682747018"><span class="annot"><span class="annottext">do_nothing :: UniqSM
  (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="#local-6989586621682747018"><span class="hs-identifier hs-var hs-var">do_nothing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-var">boringSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682747028"><span class="hs-identifier hs-var">arg_str</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-var">nop_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747013"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span>
</span><span id="line-968"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#unbox_one_arg"><span class="hs-identifier hs-type">unbox_one_arg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span>
</span><span id="line-969"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-type">DataConPatContext</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-970"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-type">WwUse</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-971"></span><span id="unbox_one_arg"><span class="annot"><span class="annottext">unbox_one_arg :: WwOpts
-&gt; Id
-&gt; DataConPatContext Demand
-&gt; UniqSM
     (Bool, [(Id, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#unbox_one_arg"><span class="hs-identifier hs-var hs-var">unbox_one_arg</span></a></span></span><span> </span><span id="local-6989586621682747029"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747029"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682747030"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747030"><span class="hs-identifier hs-var">arg_var</span></a></span></span><span>
</span><span id="line-972"></span><span>              </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-type">DataConPatContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dcpc_dc :: forall s. DataConPatContext s -&gt; DataCon
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_dc"><span class="hs-identifier hs-var">dcpc_dc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682747031"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747031"><span class="hs-identifier hs-var">dc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_tc_args :: forall s. DataConPatContext s -&gt; [Kind]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_tc_args"><span class="hs-identifier hs-var">dcpc_tc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682747032"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747032"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span>
</span><span id="line-973"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_co :: forall s. DataConPatContext s -&gt; Coercion
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_co"><span class="hs-identifier hs-var">dcpc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682747033"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747033"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_args :: forall s. DataConPatContext s -&gt; [s]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_args"><span class="hs-identifier hs-var">dcpc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682747034"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682747034"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-974"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682747035"><span class="annot"><a href="#local-6989586621682747035"><span class="hs-identifier hs-var">pat_bndrs_uniqs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM [Unique]
forall (m :: * -&gt; *). MonadUnique m =&gt; m [Unique]
</span><a href="GHC.Types.Unique.Supply.html#getUniquesM"><span class="hs-identifier hs-var">getUniquesM</span></a></span><span>
</span><span id="line-975"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682747037"><span class="annot"><a href="#local-6989586621682747037"><span class="hs-identifier hs-var hs-var">ex_name_fss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; FastString) -&gt; [Id] -&gt; [FastString]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; FastString
forall a. NamedThing a =&gt; a -&gt; FastString
</span><a href="GHC.Types.Name.html#getOccFS"><span class="hs-identifier hs-var">getOccFS</span></a></span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; [FastString]) -&gt; [Id] -&gt; [FastString]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [Id]
</span><a href="GHC.Core.DataCon.html#dataConExTyCoVars"><span class="hs-identifier hs-var">dataConExTyCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747031"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-976"></span><span>
</span><span id="line-977"></span><span>             </span><span class="hs-comment">-- Create new arguments we get when unboxing dc</span><span>
</span><span id="line-978"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621682747038"><span class="annot"><a href="#local-6989586621682747038"><span class="hs-identifier hs-var">ex_tvs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747039"><span class="annot"><a href="#local-6989586621682747039"><span class="hs-identifier hs-var">arg_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#dataConRepFSInstPat"><span class="hs-identifier hs-type">dataConRepFSInstPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682747037"><span class="hs-identifier hs-type">ex_name_fss</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">repeat</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#ww_prefix"><span class="hs-identifier hs-type">ww_prefix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-979"></span><span>                                            </span><span class="annot"><a href="#local-6989586621682747035"><span class="hs-identifier hs-type">pat_bndrs_uniqs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-type">idMult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747030"><span class="hs-identifier hs-type">arg_var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682747031"><span class="hs-identifier hs-type">dc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747032"><span class="hs-identifier hs-type">tc_args</span></a></span><span>
</span><span id="line-980"></span><span>             </span><span id="local-6989586621682747044"><span class="annot"><a href="#local-6989586621682747044"><span class="hs-identifier hs-var hs-var">con_str_marks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [StrictnessMark]
</span><a href="GHC.Core.DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747031"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-981"></span><span>
</span><span id="line-982"></span><span>             </span><span class="hs-comment">-- Apply str info to new args. Also remove OtherCon unfoldings so they</span><span>
</span><span id="line-983"></span><span>             </span><span class="hs-comment">-- don't end up in lambda binders of the worker.</span><span>
</span><span id="line-984"></span><span>             </span><span class="hs-comment">-- See Note [Never put `OtherCon` unfoldings on lambda binders]</span><span>
</span><span id="line-985"></span><span>             </span><span id="local-6989586621682747046"><span class="annot"><a href="#local-6989586621682747046"><span class="hs-identifier hs-var hs-var">arg_ids'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Types.Id.html#zapIdUnfolding"><span class="hs-identifier hs-var">zapIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; [Id]) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-986"></span><span>                        </span><span class="annot"><span class="annottext">String -&gt; (Id -&gt; Demand -&gt; Id) -&gt; [Id] -&gt; [Demand] -&gt; [Id]
forall a b c.
HasDebugCallStack =&gt;
String -&gt; (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="GHC.Utils.Misc.html#zipWithEqual"><span class="hs-identifier hs-var">zipWithEqual</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unbox_one_arg&quot;</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-identifier hs-var">setIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747039"><span class="hs-identifier hs-var">arg_ids</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682747034"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-987"></span><span>
</span><span id="line-988"></span><span>             </span><span id="local-6989586621682747050"><span class="annot"><a href="#local-6989586621682747050"><span class="hs-identifier hs-var hs-var">unbox_fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
-&gt; Coercion -&gt; Kind -&gt; DataCon -&gt; [Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkUnpackCase"><span class="hs-identifier hs-var">mkUnpackCase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747030"><span class="hs-identifier hs-var">arg_var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747033"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-var">idMult</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747030"><span class="hs-identifier hs-var">arg_var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-989"></span><span>                                     </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747031"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747038"><span class="hs-identifier hs-var">ex_tvs'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747046"><span class="hs-identifier hs-var">arg_ids'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span>             </span><span class="hs-comment">-- Mark arguments coming out of strict fields so we can seq them in the worker</span><span>
</span><span id="line-992"></span><span>             </span><span class="hs-comment">-- See Note [Call-by-value for worker args]</span><span>
</span><span id="line-993"></span><span>             </span><span id="local-6989586621682747052"><span class="annot"><a href="#local-6989586621682747052"><span class="hs-identifier hs-var hs-var">all_str_marks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; StrictnessMark) -&gt; [Id] -&gt; [StrictnessMark]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictnessMark -&gt; Id -&gt; StrictnessMark
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747038"><span class="hs-identifier hs-var">ex_tvs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[StrictnessMark] -&gt; [StrictnessMark] -&gt; [StrictnessMark]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682747044"><span class="hs-identifier hs-var">con_str_marks</span></a></span><span>
</span><span id="line-994"></span><span>
</span><span id="line-995"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747053"><span class="annot"><a href="#local-6989586621682747053"><span class="hs-identifier hs-var">nested_useful</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747054"><span class="annot"><a href="#local-6989586621682747054"><span class="hs-identifier hs-var">worker_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747055"><span class="annot"><a href="#local-6989586621682747055"><span class="hs-identifier hs-var">wrap_fn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747056"><span class="annot"><a href="#local-6989586621682747056"><span class="hs-identifier hs-var">wrap_args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-996"></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr"><span class="hs-identifier hs-type">mkWWstr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747029"><span class="hs-identifier hs-type">opts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682747038"><span class="hs-identifier hs-type">ex_tvs'</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682747046"><span class="hs-identifier hs-type">arg_ids'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682747052"><span class="hs-identifier hs-type">all_str_marks</span></a></span><span>
</span><span id="line-997"></span><span>
</span><span id="line-998"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682747057"><span class="annot"><a href="#local-6989586621682747057"><span class="hs-identifier hs-var hs-var">wrap_arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [CoreExpr] -&gt; CoreExpr
forall b. DataCon -&gt; [Arg b] -&gt; Arg b
</span><a href="GHC.Core.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747031"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Kind -&gt; CoreExpr) -&gt; [Kind] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; CoreExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747032"><span class="hs-identifier hs-var">tc_args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682747056"><span class="hs-identifier hs-var">wrap_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-operator hs-var">`mkCast`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747033"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-999"></span><span>       </span><span class="hs-comment">-- See Note [Unboxing through unboxed tuples]</span><span>
</span><span id="line-1000"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#isUnboxedTupleDataCon"><span class="hs-identifier hs-type">isUnboxedTupleDataCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747031"><span class="hs-identifier hs-type">dc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621682747053"><span class="hs-identifier hs-type">nested_useful</span></a></span><span>
</span><span id="line-1001"></span><span>                     </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-type">boringSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682747030"><span class="hs-identifier hs-type">arg_var</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-type">NotMarkedStrict</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-type">nop_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-type">varToCoreExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747030"><span class="hs-identifier hs-type">arg_var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#usefulSplit"><span class="hs-identifier hs-type">usefulSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747054"><span class="hs-identifier hs-type">worker_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747050"><span class="hs-identifier hs-type">unbox_fn</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="#local-6989586621682747055"><span class="hs-identifier hs-type">wrap_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747057"><span class="hs-identifier hs-type">wrap_arg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1003"></span><span>
</span><span id="line-1004"></span><span class="hs-comment">-- | Tries to find a suitable absent filler to bind the given absent identifier</span><span>
</span><span id="line-1005"></span><span class="hs-comment">-- to. See Note [Absent fillers].</span><span>
</span><span id="line-1006"></span><span class="hs-comment">--</span><span>
</span><span id="line-1007"></span><span class="hs-comment">-- If @mkAbsentFiller _ id == Just e@, then @e@ is an absent filler with the</span><span>
</span><span id="line-1008"></span><span class="hs-comment">-- same type as @id@. Otherwise, no suitable filler could be found.</span><span>
</span><span id="line-1009"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAbsentFiller"><span class="hs-identifier hs-type">mkAbsentFiller</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1010"></span><span id="mkAbsentFiller"><span class="annot"><span class="annottext">mkAbsentFiller :: WwOpts -&gt; Id -&gt; StrictnessMark -&gt; Maybe CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAbsentFiller"><span class="hs-identifier hs-var hs-var">mkAbsentFiller</span></a></span></span><span> </span><span id="local-6989586621682747063"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747063"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682747064"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747064"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621682747065"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682747065"><span class="hs-identifier hs-var">str</span></a></span></span><span>
</span><span id="line-1011"></span><span>  </span><span class="hs-comment">-- The lifted case: bind 'absentError'. See (AF1) in Note [Absent fillers]</span><span>
</span><span id="line-1012"></span><span>  </span><span class="hs-comment">-- We want to use this case if possible, because we get a nice runtime panic message</span><span>
</span><span id="line-1013"></span><span>  </span><span class="hs-comment">-- if we are wrong (like we were in #11126).  Otherwise we fall through to the</span><span>
</span><span id="line-1014"></span><span>  </span><span class="hs-comment">-- less-desirable mkLitRubbish case.</span><span>
</span><span id="line-1015"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#mightBeLiftedType"><span class="hs-identifier hs-var">mightBeLiftedType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747067"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1016"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isDictTy"><span class="hs-identifier hs-var">isDictTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747067"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>                 </span><span class="hs-comment">-- See (AF4) in Note [Absent fillers]</span><span>
</span><span id="line-1017"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrictDmd"><span class="hs-identifier hs-var">isStrictDmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747064"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See (AF2)</span><span>
</span><span id="line-1018"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictnessMark -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isMarkedStrict"><span class="hs-identifier hs-var">isMarkedStrict</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682747065"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>              </span><span class="hs-comment">--    in Note [Absent fillers]</span><span>
</span><span id="line-1019"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe CoreExpr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; String -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkAbsentErrorApp"><span class="hs-identifier hs-var">mkAbsentErrorApp</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747067"><span class="hs-identifier hs-var">arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682747069"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1020"></span><span>
</span><span id="line-1021"></span><span>  </span><span class="hs-comment">-- The default case for mono rep: Bind `RUBBISH[rr] arg_ty`</span><span>
</span><span id="line-1022"></span><span>  </span><span class="hs-comment">-- See Note [Absent fillers]</span><span>
</span><span id="line-1023"></span><span>  </span><span class="hs-comment">-- (AF3): mkLitRubbish returns Nothing if the representation is not</span><span>
</span><span id="line-1024"></span><span>  </span><span class="hs-comment">--        monomorphic, in which case we can't make a filler</span><span>
</span><span id="line-1025"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1026"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Maybe CoreExpr
</span><a href="GHC.Core.Make.html#mkLitRubbish"><span class="hs-identifier hs-var">mkLitRubbish</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747067"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1027"></span><span>
</span><span id="line-1028"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1029"></span><span>    </span><span id="local-6989586621682747067"><span class="annot"><span class="annottext">arg_ty :: Kind
</span><a href="#local-6989586621682747067"><span class="hs-identifier hs-var hs-var">arg_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747064"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1030"></span><span>
</span><span id="line-1031"></span><span>    </span><span id="local-6989586621682747069"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621682747069"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDocContext -&gt; SDoc -&gt; String
</span><a href="GHC.Utils.Outputable.html#renderWithContext"><span class="hs-identifier hs-var">renderWithContext</span></a></span><span>
</span><span id="line-1032"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDocContext
</span><a href="GHC.Utils.Outputable.html#defaultSDocContext"><span class="hs-identifier hs-var">defaultSDocContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#sdocSuppressUniques"><span class="hs-identifier hs-var">sdocSuppressUniques</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1033"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-1034"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Arg:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747064"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1035"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Type:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747067"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1036"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682747076"><span class="hs-identifier hs-var">file_msg</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1037"></span><span>              </span><span class="hs-comment">-- We need to suppress uniques here because otherwise they'd</span><span>
</span><span id="line-1038"></span><span>              </span><span class="hs-comment">-- end up in the generated code as strings. This is bad for</span><span>
</span><span id="line-1039"></span><span>              </span><span class="hs-comment">-- determinism, because with different uniques the strings</span><span>
</span><span id="line-1040"></span><span>              </span><span class="hs-comment">-- will have different lengths and hence different costs for</span><span>
</span><span id="line-1041"></span><span>              </span><span class="hs-comment">-- the inliner leading to different inlining.</span><span>
</span><span id="line-1042"></span><span>              </span><span class="hs-comment">-- See also Note [Unique Determinism] in GHC.Types.Unique</span><span>
</span><span id="line-1043"></span><span>    </span><span id="local-6989586621682747076"><span class="annot"><span class="annottext">file_msg :: SDoc
</span><a href="#local-6989586621682747076"><span class="hs-identifier hs-var hs-var">file_msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In module&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(Module -&gt; SDoc) -&gt; Module -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; Module
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_module"><span class="hs-identifier hs-var">wo_module</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747063"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1044"></span><span>
</span><span id="line-1045"></span><span class="hs-comment">{- Note [Worker/wrapper for Strictness and Absence]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The worker/wrapper transformation, mkWWstr_one, takes concrete action
based on the 'UnboxingDecision' returned by 'canUnboxArg'.
The latter takes into account several possibilities to decide if the
function is worthy for splitting:

1. If an argument is absent, it would be silly to pass it to
   the worker.  Hence the DropAbsent case.  This case must come
   first because the bottom demand B is also strict.
   E.g. B comes from a function like
       f x = error &quot;urk&quot;
   and the absent demand A can come from Note [Unboxing evaluated arguments]
   in GHC.Core.Opt.DmdAnal.

2. If the argument is evaluated strictly (or known to be eval'd),
   we can take a view into the product demand ('viewProd'). In accordance
   with Note [Boxity analysis], 'canUnboxArg' will say 'DoUnbox'.
   'mkWWstr_one' then follows suit it and recurses into the fields of the
   product demand. For example

     f :: (Int, Int) -&gt; Int
     f p = (case p of (a,b) -&gt; a) + 1
   is split to
     f :: (Int, Int) -&gt; Int
     f p = case p of (a,b) -&gt; $wf a

     $wf :: Int -&gt; Int
     $wf a = a + 1

   and
     g :: Bool -&gt; (Int, Int) -&gt; Int
     g c p = case p of (a,b) -&gt;
                if c then a else b
   is split to
     g c p = case p of (a,b) -&gt; $gw c a b
     $gw c a b = if c then a else b

2a But do /not/ unbox if Boxity Analysis said &quot;Boxed&quot;.
   In this case, 'canUnboxArg' returns 'DontUnbox'.
   Otherwise we risk decomposing and reboxing a massive
   tuple which is barely used. Example:

        f :: ((Int,Int) -&gt; String) -&gt; (Int,Int) -&gt; a
        f g pr = error (g pr)

        main = print (f fst (1, error &quot;no&quot;))

   Here, f does not take 'pr' apart, and it's stupid to do so.
   Imagine that it had millions of fields. This actually happened
   in GHC itself where the tuple was DynFlags

2b But if e.g. a large tuple or product type is always demanded we might
   decide to &quot;unlift&quot; it. That is tighten the calling convention for that
   argument to require it to be passed as a pointer to the value itself.
   See Note [WW for calling convention].

3. In all other cases (e.g., lazy, used demand and not eval'd),
   'finaliseArgBoxities' will have cleared the Boxity flag to 'Boxed'
   (see Note [Finalising boxity for demand signatures] in GHC.Core.Opt.DmdAnal)
   and 'canUnboxArg' returns 'DontUnbox' so that 'mkWWstr_one'
   stops unboxing.

Note [Worker/wrapper for bottoming functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used not to split if the result is bottom.
[Justification:  there's no efficiency to be gained.]

But it's sometimes bad not to make a wrapper.  Consider
        fw = \x# -&gt; let x = I# x# in case e of
                                        p1 -&gt; error_fn x
                                        p2 -&gt; error_fn x
                                        p3 -&gt; the real stuff
The re-boxing code won't go away unless error_fn gets a wrapper too.
[We don't do reboxing now, but in general it's better to pass an
unboxed thing to f, and have it reboxed in the error cases....]

Note [Record evaluated-ness in worker/wrapper]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have

   data T = MkT !Int Int

   f :: T -&gt; T
   f x = e

and f's is strict, and has the CPR property.  The we are going to generate
this w/w split

   f x = case x of
           MkT x1 x2 -&gt; case $wf x1 x2 of
                           (# r1, r2 #) -&gt; MkT r1 r2

   $wfw x1 x2 = let x = MkT x1 x2 in
                case e of
                  MkT r1 r2 -&gt; (# r1, r2 #)

Note that

* In the worker $wf, inside 'e' we can be sure that x1 will be
  evaluated (it came from unpacking the argument MkT.  But that's no
  immediately apparent in $wf

* In the wrapper 'f', which we'll inline at call sites, we can be sure
  that 'r1' has been evaluated (because it came from unpacking the result
  MkT.  But that is not immediately apparent from the wrapper code.

Missing these facts isn't unsound, but it loses possible future
opportunities for optimisation.

Solution: use setCaseBndrEvald when creating
 (A) The arg binders x1,x2 in mkWstr_one via mkUnpackCase
         See #13077, test T13077
 (B) The result binders r1,r2 in mkWWcpr_entry
         See Trace #13077, test T13077a
         And #13027 comment:20, item (4)
to record that the relevant binder is evaluated.

Note [Absent fillers]
~~~~~~~~~~~~~~~~~~~~~
Consider

  data T = MkT [Int] [Int] ![Int]  -- NB: last field is strict
  f :: T -&gt; Int# -&gt; blah
  f ps w = case ps of MkT xs ys zs -&gt; &lt;body mentioning xs&gt;

Then f gets a strictness sig of &lt;S(L,A,A)&gt;&lt;A&gt;. We make a worker $wf thus:

  $wf :: [Int] -&gt; blah
  $wf xs = case ps of MkT xs _ _ -&gt; &lt;body mentioning xs&gt;
    where
      ys = absentError &quot;ys :: [Int]&quot;
      zs = RUBBISH[LiftedRep] @[Int]
      ps = MkT xs ys zs
      w  = RUBBISH[IntRep] @Int#

The absent arguments 'ys', 'zs' and 'w' aren't even passed to the worker.
And neither should they! They are never used, their value is irrelevant (hence
they are *dead code*) and they are probably discarded after the next run of the
Simplifier (when they are in fact *unreachable code*). Yet, we have to come up
with &quot;filler&quot; values that we bind the absent arg Ids to.

That is exactly what Note [Rubbish literals] are for: A convenient way to
conjure filler values at any type (and any representation or levity!).

Needless to say, there are some wrinkles:

(AF1) In case we have a absent, /lazy/, and /lifted/ arg, we use an error-thunk
     instead. If absence analysis was wrong (e.g., #11126) and the binding
     in fact is used, then we get a nice panic message instead of undefined
     runtime behavior (See Modes of failure from Note [Rubbish literals]).

     Obviously, we can't use an error-thunk if the value is of unlifted rep
     (like 'Int#' or 'MutVar#'), because we'd immediately evaluate the panic.

(AF2) We also mustn't put an error-thunk (that fills in for an absent value of
     lifted rep) in a strict field, because #16970 establishes the invariant
     that strict fields are always evaluated, by possibly (re-)evaluating what is put in
     a strict field. That's the reason why 'zs' binds a rubbish literal instead
     of an error-thunk, see #19133.

     How do we detect when we are about to put an error-thunk in a strict field?
     Ideally, we'd just look at the 'StrictnessMark' of the DataCon's field. So that's
     what we do!

     There are other necessary conditions for strict fields:
     Note [Unboxing evaluated arguments] in DmdAnal makes it so that the demand on
     'zs' is absent and /strict/: It will get cardinality 'C_10', the empty
     interval, rather than 'C_00'. Hence the 'isStrictDmd' check: It further
     guarantees e never fill in an error-thunk for an absent strict field.
     But that also means we emit a rubbish lit for other args that have
     cardinality 'C_10' (say, the arg to a bottoming function) where we could've
     used an error-thunk.
     NB from Andreas: But I think using an error thunk there would be dodgy no matter what
     for example if we decide to pass the argument to the bottoming function cbv.
     As we might do if the function in question is a worker.
     See Note [CBV Function Ids] in GHC.Types.Id.Info. So I just left the strictness check
     in place on top of threading through the marks from the constructor. It's a *really* cheap
     and easy check to make anyway.

(AF3) We can only emit a LitRubbish if the arg's type `arg_ty` is mono-rep, e.g.
     of the form `TYPE rep` where `rep` is not (and doesn't contain) a variable.
     Why? Because if we don't know its representation (e.g. size in memory,
     register class), we don't know what or how much rubbish to emit in codegen.
     'mkLitRubbish' returns 'Nothing' in this case and we simply fall
     back to passing the original parameter to the worker.

     Note that currently this case should not occur, because binders always
     have to be representation monomorphic. But in the future, we might allow
     levity polymorphism, e.g. a polymorphic levity variable in 'BoxedRep'.

(AF4) Consider (#24934)
         f :: (a~b) =&gt; blah {-# INLINE f #-}
         f d x = case eq_sel d of co -&gt; body
     In #24934 it turned out that `co` was unused; and we discarded the
     entire case-scrutinisation via the `exprOkToDiscard` test in
     `GHC.Core.Opt.Simplify.Iteration.rebuildCase`.  So now `d` is absent.
     But in the /unfolding/ for some reason we did not discard the `case`;
     so when we inline `f` we end up evaluating that `d` argument.  So we had
     better not replace it with an error thunk!

     The root of it is this: `exprOkToDiscard` assumes that a dictionary is
     non-bottom (Note [exprOkForSpeculation and type classes]); but then we replace
     the (a~b) dictionary with an error thunk, breaking the invariant that every
     dictionary is non-bottom.  (If -XDictsStrict is on, the invariant is even
     more important.)

     Simple solution: never use an error thunk for a dictionary; instead fall
     through to mkRubbishLit.  (The only downside is that we lose the compiler
     debugging advantages of (AF1).)

     This is quite delicate.

While (AF1) and (AF2) are simply an optimisation in terms of compiler debugging
experience, (AF3) should be irrelevant in most programs, if not all.

Historical note: I did try the experiment of using an error thunk for unlifted
things too, relying on the simplifier to drop it as dead code.  But this is
fragile

 - It fails when profiling is on, which disables various optimisations

 - It fails when reboxing happens. E.g.
      data T = MkT Int Int#
      f p@(MkT a _) = ...g p....
   where g is /lazy/ in 'p', but only uses the first component.  Then
   'f' is /strict/ in 'p', and only uses the first component.  So we only
   pass that component to the worker for 'f', which reconstructs 'p' to
   pass it to 'g'.  Alas we can't say
       ...f (MkT a (absentError Int# &quot;blah&quot;))...
   because `MkT` is strict in its Int# argument, so we get an absentError
   exception when we shouldn't.  Very annoying!

Note [Unboxing through unboxed tuples]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We should not to a worker/wrapper split just for unboxing the components of
an unboxed tuple (in the result *or* argument, #22388). Consider
  boring_res x y = (# y, x #)
It's entirely pointless to split for the constructed unboxed pair to
  $wboring_res x y = (# y, x #)
  boring_res = case $wboring_res x y of (# a, b #) -&gt; (# a, b #)
`boring_res` will immediately simplify to an alias for `$wboring_res`!

Similarly, the unboxed tuple might occur in argument position
  boring_arg (# x, y, z #) = (# z, x, y #)
It's entirely pointless to &quot;unbox&quot; the triple
  $wboring_arg x y z = (# z, x, y #)
  boring_arg (# x, y, z #) = $wboring_arg x y z
because after unarisation, `boring_arg` is just an alias for `$wboring_arg`.

Conclusion: Only consider unboxing an unboxed tuple useful when we will
also unbox its components. That is governed by the `usefulSplit` mechanism.

************************************************************************
*                                                                      *
         Type scrutiny that is specific to demand analysis
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1304"></span><span>
</span><span id="line-1305"></span><span class="hs-comment">-- | Exactly 'dataConInstArgTys', but lacks the (ASSERT'ed) precondition that</span><span>
</span><span id="line-1306"></span><span class="hs-comment">-- the 'DataCon' may not have existentials. The lack of cloning the</span><span>
</span><span id="line-1307"></span><span class="hs-comment">-- existentials this function \&quot;dubious\&quot;; only use it where type variables</span><span>
</span><span id="line-1308"></span><span class="hs-comment">-- aren't substituted for!  Why may the data con bind existentials?</span><span>
</span><span id="line-1309"></span><span class="hs-comment">--    See Note [Which types are unboxed?]</span><span>
</span><span id="line-1310"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#dubiousDataConInstArgTys"><span class="hs-identifier hs-type">dubiousDataConInstArgTys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1311"></span><span id="dubiousDataConInstArgTys"><span class="annot"><span class="annottext">dubiousDataConInstArgTys :: DataCon -&gt; [Kind] -&gt; [Kind]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dubiousDataConInstArgTys"><span class="hs-identifier hs-var hs-var">dubiousDataConInstArgTys</span></a></span></span><span> </span><span id="local-6989586621682747079"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747079"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span id="local-6989586621682747080"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747080"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747081"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-1312"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1313"></span><span>    </span><span id="local-6989586621682747082"><span class="annot"><span class="annottext">univ_tvs :: [Id]
</span><a href="#local-6989586621682747082"><span class="hs-identifier hs-var hs-var">univ_tvs</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [Id]
</span><a href="GHC.Core.DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747079"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-1314"></span><span>    </span><span id="local-6989586621682747084"><span class="annot"><span class="annottext">ex_tvs :: [Id]
</span><a href="#local-6989586621682747084"><span class="hs-identifier hs-var hs-var">ex_tvs</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [Id]
</span><a href="GHC.Core.DataCon.html#dataConExTyCoVars"><span class="hs-identifier hs-var">dataConExTyCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747079"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-1315"></span><span>    </span><span id="local-6989586621682747085"><span class="annot"><span class="annottext">univ_subst :: Subst
</span><a href="#local-6989586621682747085"><span class="hs-identifier hs-var hs-var">univ_subst</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Kind] -&gt; Subst
HasDebugCallStack =&gt; [Id] -&gt; [Kind] -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#zipTvSubst"><span class="hs-identifier hs-var">zipTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747082"><span class="hs-identifier hs-var">univ_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747080"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-1316"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682747087"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682747087"><span class="hs-identifier hs-var">full_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; [Id] -&gt; (Subst, [Id])
Subst -&gt; [Id] -&gt; (Subst, [Id])
</span><a href="GHC.Core.TyCo.Subst.html#substTyVarBndrs"><span class="hs-identifier hs-var">substTyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682747085"><span class="hs-identifier hs-var">univ_subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747084"><span class="hs-identifier hs-var">ex_tvs</span></a></span><span>
</span><span id="line-1317"></span><span>    </span><span id="local-6989586621682747081"><span class="annot"><span class="annottext">arg_tys :: [Kind]
</span><a href="#local-6989586621682747081"><span class="hs-identifier hs-var hs-var">arg_tys</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Scaled Kind -&gt; Kind) -&gt; [Scaled Kind] -&gt; [Kind]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Kind -&gt; Kind
Subst -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682747087"><span class="hs-identifier hs-var">full_subst</span></a></span><span> </span><span class="annot"><span class="annottext">(Kind -&gt; Kind) -&gt; (Scaled Kind -&gt; Kind) -&gt; Scaled Kind -&gt; Kind
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scaled Kind -&gt; Kind
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Scaled Kind] -&gt; [Kind]) -&gt; [Scaled Kind] -&gt; [Kind]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1318"></span><span>                      </span><span class="annot"><span class="annottext">DataCon -&gt; [Scaled Kind]
</span><a href="GHC.Core.DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747079"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-1319"></span><span>    </span><span class="hs-comment">-- NB: use substTyVarBndrs on ex_tvs to ensure that we</span><span>
</span><span id="line-1320"></span><span>    </span><span class="hs-comment">--     substitute in their kinds.  For example (#22849)</span><span>
</span><span id="line-1321"></span><span>    </span><span class="hs-comment">-- Consider data T a where</span><span>
</span><span id="line-1322"></span><span>    </span><span class="hs-comment">--            MkT :: forall k (t::k-&gt;*) (ix::k). t ix -&gt; T @k a</span><span>
</span><span id="line-1323"></span><span>    </span><span class="hs-comment">-- Then dubiousDataConInstArgTys MkT [Type, Foo] should return</span><span>
</span><span id="line-1324"></span><span>    </span><span class="hs-comment">--        [Foo (ix::Type)], not [Foo (ix::k)]!</span><span>
</span><span id="line-1325"></span><span>
</span><span id="line-1326"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#findTypeShape"><span class="hs-identifier hs-type">findTypeShape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a></span><span>
</span><span id="line-1327"></span><span class="hs-comment">-- Uncover the arrow and product shape of a type</span><span>
</span><span id="line-1328"></span><span class="hs-comment">-- The data type TypeShape is defined in GHC.Types.Demand</span><span>
</span><span id="line-1329"></span><span class="hs-comment">-- See Note [Trimming a demand to a type] in GHC.Core.Opt.DmdAnal</span><span>
</span><span id="line-1330"></span><span id="findTypeShape"><span class="annot"><span class="annottext">findTypeShape :: FamInstEnvs -&gt; Kind -&gt; TypeShape
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#findTypeShape"><span class="hs-identifier hs-var hs-var">findTypeShape</span></a></span></span><span> </span><span id="local-6989586621682747092"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621682747092"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621682747093"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747093"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1331"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Kind -&gt; TypeShape
</span><a href="#local-6989586621682747094"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; RecTcChecker -&gt; RecTcChecker
</span><a href="GHC.Core.TyCon.RecWalk.html#setRecTcMaxBound"><span class="hs-identifier hs-var">setRecTcMaxBound</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="GHC.Core.TyCon.RecWalk.html#initRecTc"><span class="hs-identifier hs-var">initRecTc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747093"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1332"></span><span>       </span><span class="hs-comment">-- You might think this bound of 2 is low, but actually</span><span>
</span><span id="line-1333"></span><span>       </span><span class="hs-comment">-- I think even 1 would be fine.  This only bites for recursive</span><span>
</span><span id="line-1334"></span><span>       </span><span class="hs-comment">-- product types, which are rare, and we really don't want</span><span>
</span><span id="line-1335"></span><span>       </span><span class="hs-comment">-- to look deep into such products -- see #18034</span><span>
</span><span id="line-1336"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1337"></span><span>    </span><span id="local-6989586621682747094"><span class="annot"><span class="annottext">go :: RecTcChecker -&gt; Kind -&gt; TypeShape
</span><a href="#local-6989586621682747094"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682747097"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747097"><span class="hs-identifier hs-var">rec_tc</span></a></span></span><span> </span><span id="local-6989586621682747098"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747098"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1338"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747099"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747099"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Maybe (FunTyFlag, Kind, Kind, Kind)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747098"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1339"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeShape -&gt; TypeShape
</span><a href="GHC.Types.Demand.html#TsFun"><span class="hs-identifier hs-var">TsFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecTcChecker -&gt; Kind -&gt; TypeShape
</span><a href="#local-6989586621682747094"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747097"><span class="hs-identifier hs-var">rec_tc</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747099"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1340"></span><span>
</span><span id="line-1341"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747102"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747102"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747103"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747103"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Maybe (TyCon, [Kind])
Kind -&gt; Maybe (TyCon, [Kind])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747098"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1342"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; TyCon -&gt; [Kind] -&gt; TypeShape
</span><a href="#local-6989586621682747105"><span class="hs-identifier hs-var">go_tc</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747097"><span class="hs-identifier hs-var">rec_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747102"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747103"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-1343"></span><span>
</span><span id="line-1344"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747106"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747106"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Maybe (Id, Kind)
</span><a href="GHC.Core.Type.html#splitForAllTyCoVar_maybe"><span class="hs-identifier hs-var">splitForAllTyCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747098"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1345"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Kind -&gt; TypeShape
</span><a href="#local-6989586621682747094"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747097"><span class="hs-identifier hs-var">rec_tc</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747106"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-1346"></span><span>
</span><span id="line-1347"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1348"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeShape
</span><a href="GHC.Types.Demand.html#TsUnk"><span class="hs-identifier hs-var">TsUnk</span></a></span><span>
</span><span id="line-1349"></span><span>
</span><span id="line-1350"></span><span>    </span><span id="local-6989586621682747105"><span class="annot"><span class="annottext">go_tc :: RecTcChecker -&gt; TyCon -&gt; [Kind] -&gt; TypeShape
</span><a href="#local-6989586621682747105"><span class="hs-identifier hs-var hs-var">go_tc</span></a></span></span><span> </span><span id="local-6989586621682747109"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747109"><span class="hs-identifier hs-var">rec_tc</span></a></span></span><span> </span><span id="local-6989586621682747110"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747110"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682747111"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747111"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span>
</span><span id="line-1351"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#HetReduction"><span class="hs-identifier hs-type">HetReduction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682747114"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747114"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; TyCon -&gt; [Kind] -&gt; Maybe HetReduction
</span><a href="GHC.Core.FamInstEnv.html#topReduceTyFamApp_maybe"><span class="hs-identifier hs-var">topReduceTyFamApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621682747092"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747110"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747111"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-1352"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Kind -&gt; TypeShape
</span><a href="#local-6989586621682747094"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747109"><span class="hs-identifier hs-var">rec_tc</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747114"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1353"></span><span>
</span><span id="line-1354"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682747116"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747116"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe DataCon
</span><a href="GHC.Core.TyCon.html#tyConSingleAlgDataCon_maybe"><span class="hs-identifier hs-var">tyConSingleAlgDataCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747110"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1355"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682747117"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747117"><span class="hs-identifier hs-var">rec_tc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTupleTyCon"><span class="hs-identifier hs-var">isTupleTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747110"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1356"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Maybe RecTcChecker
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747109"><span class="hs-identifier hs-var">rec_tc</span></a></span><span>
</span><span id="line-1357"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; TyCon -&gt; Maybe RecTcChecker
</span><a href="GHC.Core.TyCon.RecWalk.html#checkRecTc"><span class="hs-identifier hs-var">checkRecTc</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747109"><span class="hs-identifier hs-var">rec_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747110"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1358"></span><span>         </span><span class="hs-comment">-- We treat tuples specially because they can't cause loops.</span><span>
</span><span id="line-1359"></span><span>         </span><span class="hs-comment">-- Maybe we should do so in checkRecTc.</span><span>
</span><span id="line-1360"></span><span>         </span><span class="hs-comment">-- The use of 'dubiousDataConInstArgTys' is OK, since this</span><span>
</span><span id="line-1361"></span><span>         </span><span class="hs-comment">-- function performs no substitution at all, hence the uniques</span><span>
</span><span id="line-1362"></span><span>         </span><span class="hs-comment">-- don't matter.</span><span>
</span><span id="line-1363"></span><span>         </span><span class="hs-comment">-- We really do encounter existentials here, see</span><span>
</span><span id="line-1364"></span><span>         </span><span class="hs-comment">-- Note [Which types are unboxed?] for an example.</span><span>
</span><span id="line-1365"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeShape] -&gt; TypeShape
</span><a href="GHC.Types.Demand.html#TsProd"><span class="hs-identifier hs-var">TsProd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Kind -&gt; TypeShape) -&gt; [Kind] -&gt; [TypeShape]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecTcChecker -&gt; Kind -&gt; TypeShape
</span><a href="#local-6989586621682747094"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747117"><span class="hs-identifier hs-var">rec_tc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [Kind] -&gt; [Kind]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dubiousDataConInstArgTys"><span class="hs-identifier hs-var">dubiousDataConInstArgTys</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747116"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747111"><span class="hs-identifier hs-var">tc_args</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1366"></span><span>
</span><span id="line-1367"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747121"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747121"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Kind] -&gt; Maybe (Kind, Coercion)
</span><a href="GHC.Core.Coercion.html#instNewTyCon_maybe"><span class="hs-identifier hs-var">instNewTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747110"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747111"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-1368"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682747123"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747123"><span class="hs-identifier hs-var">rec_tc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; TyCon -&gt; Maybe RecTcChecker
</span><a href="GHC.Core.TyCon.RecWalk.html#checkRecTc"><span class="hs-identifier hs-var">checkRecTc</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747109"><span class="hs-identifier hs-var">rec_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747110"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1369"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Kind -&gt; TypeShape
</span><a href="#local-6989586621682747094"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682747123"><span class="hs-identifier hs-var">rec_tc</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747121"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-1370"></span><span>
</span><span id="line-1371"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1372"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeShape
</span><a href="GHC.Types.Demand.html#TsUnk"><span class="hs-identifier hs-var">TsUnk</span></a></span><span>
</span><span id="line-1373"></span><span>
</span><span id="line-1374"></span><span class="hs-comment">-- | Returned by 'isRecDataCon'.</span><span>
</span><span id="line-1375"></span><span class="hs-comment">-- See also Note [Detecting recursive data constructors].</span><span>
</span><span id="line-1376"></span><span class="hs-keyword">data</span><span> </span><span id="IsRecDataConResult"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-var">IsRecDataConResult</span></a></span></span><span>
</span><span id="line-1377"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="DefinitelyRecursive"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The algorithm detected a loop</span></span><span>
</span><span id="line-1378"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NonRecursiveOrUnsure"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#NonRecursiveOrUnsure"><span class="hs-identifier hs-var">NonRecursiveOrUnsure</span></a></span></span><span> </span><span class="hs-comment">-- ^ The algorithm detected no loop, went out of fuel</span><span>
</span><span id="line-1379"></span><span>                         </span><span class="hs-comment">-- or hit an .hs-boot file</span><span>
</span><span id="line-1380"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747127"><span id="local-6989586621682747132"><span class="annot"><span class="annottext">IsRecDataConResult -&gt; IsRecDataConResult -&gt; Bool
(IsRecDataConResult -&gt; IsRecDataConResult -&gt; Bool)
-&gt; (IsRecDataConResult -&gt; IsRecDataConResult -&gt; Bool)
-&gt; Eq IsRecDataConResult
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: IsRecDataConResult -&gt; IsRecDataConResult -&gt; Bool
== :: IsRecDataConResult -&gt; IsRecDataConResult -&gt; Bool
$c/= :: IsRecDataConResult -&gt; IsRecDataConResult -&gt; Bool
/= :: IsRecDataConResult -&gt; IsRecDataConResult -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747137"><span id="local-6989586621682747139"><span id="local-6989586621682747143"><span class="annot"><span class="annottext">Int -&gt; IsRecDataConResult -&gt; ShowS
[IsRecDataConResult] -&gt; ShowS
IsRecDataConResult -&gt; String
(Int -&gt; IsRecDataConResult -&gt; ShowS)
-&gt; (IsRecDataConResult -&gt; String)
-&gt; ([IsRecDataConResult] -&gt; ShowS)
-&gt; Show IsRecDataConResult
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; IsRecDataConResult -&gt; ShowS
showsPrec :: Int -&gt; IsRecDataConResult -&gt; ShowS
$cshow :: IsRecDataConResult -&gt; String
show :: IsRecDataConResult -&gt; String
$cshowList :: [IsRecDataConResult] -&gt; ShowS
showList :: [IsRecDataConResult] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1381"></span><span>
</span><span id="line-1382"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1383"></span><span>  </span><span id="local-6989586621682747151"><span class="annot"><span class="annottext">ppr :: IsRecDataConResult -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SDoc)
-&gt; (IsRecDataConResult -&gt; String) -&gt; IsRecDataConResult -&gt; SDoc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span>
</span><span id="line-1384"></span><span>
</span><span id="line-1385"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCR"><span class="hs-identifier hs-type">combineIRDCR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span>
</span><span id="line-1386"></span><span id="combineIRDCR"><span class="annot"><span class="annottext">combineIRDCR :: IsRecDataConResult -&gt; IsRecDataConResult -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCR"><span class="hs-identifier hs-var hs-var">combineIRDCR</span></a></span></span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span>
</span><span id="line-1387"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCR"><span class="hs-identifier hs-var">combineIRDCR</span></a></span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span>
</span><span id="line-1388"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCR"><span class="hs-identifier hs-var">combineIRDCR</span></a></span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#NonRecursiveOrUnsure"><span class="hs-identifier hs-var">NonRecursiveOrUnsure</span></a></span><span>
</span><span id="line-1389"></span><span>
</span><span id="line-1390"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCRs"><span class="hs-identifier hs-type">combineIRDCRs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span>
</span><span id="line-1391"></span><span id="combineIRDCRs"><span class="annot"><span class="annottext">combineIRDCRs :: [IsRecDataConResult] -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCRs"><span class="hs-identifier hs-var hs-var">combineIRDCRs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IsRecDataConResult -&gt; IsRecDataConResult -&gt; IsRecDataConResult)
-&gt; IsRecDataConResult -&gt; [IsRecDataConResult] -&gt; IsRecDataConResult
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult -&gt; IsRecDataConResult -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCR"><span class="hs-identifier hs-var">combineIRDCR</span></a></span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#NonRecursiveOrUnsure"><span class="hs-identifier hs-var">NonRecursiveOrUnsure</span></a></span><span>
</span><span id="line-1392"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCRs"><span class="hs-pragma hs-type">combineIRDCRs</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1393"></span><span>
</span><span id="line-1394"></span><span class="hs-comment">-- | @isRecDataCon _ fuel dc@, where @tc = dataConTyCon dc@ returns</span><span>
</span><span id="line-1395"></span><span class="hs-comment">--</span><span>
</span><span id="line-1396"></span><span class="hs-comment">--   * @DefinitelyRecursive@ if the analysis found that @tc@ is reachable</span><span>
</span><span id="line-1397"></span><span class="hs-comment">--     through one of @dc@'s @arg_tys@.</span><span>
</span><span id="line-1398"></span><span class="hs-comment">--   * @NonRecursiveOrUnsure@ if the analysis found that @tc@ is not reachable</span><span>
</span><span id="line-1399"></span><span class="hs-comment">--     through one of @dc@'s fields (so surely non-recursive).</span><span>
</span><span id="line-1400"></span><span class="hs-comment">--   * @NonRecursiveOrUnsure@ when @fuel /= Infinity@</span><span>
</span><span id="line-1401"></span><span class="hs-comment">--     and @fuel@ expansions of nested data TyCons were not enough to prove</span><span>
</span><span id="line-1402"></span><span class="hs-comment">--     non-recursiveness, nor arrive at an occurrence of @tc@ thus proving</span><span>
</span><span id="line-1403"></span><span class="hs-comment">--     recursiveness. (So not sure if non-recursive.)</span><span>
</span><span id="line-1404"></span><span class="hs-comment">--   * @NonRecursiveOrUnsure@ when we hit an abstract TyCon (one without</span><span>
</span><span id="line-1405"></span><span class="hs-comment">--     visible DataCons), such as those imported from .hs-boot files.</span><span>
</span><span id="line-1406"></span><span class="hs-comment">--     Similarly for stuck type and data families.</span><span>
</span><span id="line-1407"></span><span class="hs-comment">--</span><span>
</span><span id="line-1408"></span><span class="hs-comment">-- If @fuel = 'Infinity'@ and there are no boot files involved, then the result</span><span>
</span><span id="line-1409"></span><span class="hs-comment">-- is never @Nothing@ and the analysis is a depth-first search. If @fuel = 'Int'</span><span>
</span><span id="line-1410"></span><span class="hs-comment">-- f@, then the analysis behaves like a depth-limited DFS and returns @Nothing@</span><span>
</span><span id="line-1411"></span><span class="hs-comment">-- if the search was inconclusive.</span><span>
</span><span id="line-1412"></span><span class="hs-comment">--</span><span>
</span><span id="line-1413"></span><span class="hs-comment">-- See Note [Detecting recursive data constructors] for which recursive DataCons</span><span>
</span><span id="line-1414"></span><span class="hs-comment">-- we want to flag.</span><span>
</span><span id="line-1415"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#isRecDataCon"><span class="hs-identifier hs-type">isRecDataCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span>
</span><span id="line-1416"></span><span id="isRecDataCon"><span class="annot"><span class="annottext">isRecDataCon :: FamInstEnvs -&gt; IntWithInf -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#isRecDataCon"><span class="hs-identifier hs-var hs-var">isRecDataCon</span></a></span></span><span> </span><span id="local-6989586621682747156"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621682747156"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621682747157"><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747157"><span class="hs-identifier hs-var">fuel</span></a></span></span><span> </span><span id="local-6989586621682747158"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747158"><span class="hs-identifier hs-var">orig_dc</span></a></span></span><span>
</span><span id="line-1417"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isTupleDataCon"><span class="hs-identifier hs-var">isTupleDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747158"><span class="hs-identifier hs-var">orig_dc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isUnboxedSumDataCon"><span class="hs-identifier hs-var">isUnboxedSumDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747158"><span class="hs-identifier hs-var">orig_dc</span></a></span><span>
</span><span id="line-1418"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#NonRecursiveOrUnsure"><span class="hs-identifier hs-var">NonRecursiveOrUnsure</span></a></span><span>
</span><span id="line-1419"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1420"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTraceWith &quot;isRecDataCon&quot; (\answer -&gt; ppr dc &lt;+&gt; dcolon &lt;+&gt; ppr (dataConRepType dc) $$ ppr fuel $$ ppr answer) $</span><span>
</span><span id="line-1421"></span><span>    </span><span class="annot"><span class="annottext">IntWithInf -&gt; TyConSet -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747161"><span class="hs-identifier hs-var">go_dc</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747157"><span class="hs-identifier hs-var">fuel</span></a></span><span> </span><span class="annot"><span class="annottext">TyConSet
</span><a href="GHC.Core.TyCon.Set.html#emptyTyConSet"><span class="hs-identifier hs-var">emptyTyConSet</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747158"><span class="hs-identifier hs-var">orig_dc</span></a></span><span>
</span><span id="line-1422"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1423"></span><span>    </span><span class="annot"><a href="#local-6989586621682747161"><span class="hs-identifier hs-type">go_dc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.Set.html#TyConSet"><span class="hs-identifier hs-type">TyConSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span>
</span><span id="line-1424"></span><span>    </span><span id="local-6989586621682747161"><span class="annot"><span class="annottext">go_dc :: IntWithInf -&gt; TyConSet -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747161"><span class="hs-identifier hs-var hs-var">go_dc</span></a></span></span><span> </span><span id="local-6989586621682747163"><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747163"><span class="hs-identifier hs-var">fuel</span></a></span></span><span> </span><span id="local-6989586621682747164"><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747164"><span class="hs-identifier hs-var">visited_tcs</span></a></span></span><span> </span><span id="local-6989586621682747165"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747165"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1425"></span><span>      </span><span class="annot"><span class="annottext">[IsRecDataConResult] -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCRs"><span class="hs-identifier hs-var">combineIRDCRs</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">IntWithInf -&gt; TyConSet -&gt; Kind -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747166"><span class="hs-identifier hs-var">go_arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747163"><span class="hs-identifier hs-var">fuel</span></a></span><span> </span><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747164"><span class="hs-identifier hs-var">visited_tcs</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747167"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1426"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682747167"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747167"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scaled Kind -&gt; Kind) -&gt; [Scaled Kind] -&gt; [Kind]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Scaled Kind -&gt; Kind
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [Scaled Kind]
</span><a href="GHC.Core.DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747165"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1427"></span><span>
</span><span id="line-1428"></span><span>    </span><span class="annot"><a href="#local-6989586621682747166"><span class="hs-identifier hs-type">go_arg_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.Set.html#TyConSet"><span class="hs-identifier hs-type">TyConSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span>
</span><span id="line-1429"></span><span>    </span><span id="local-6989586621682747166"><span class="annot"><span class="annottext">go_arg_ty :: IntWithInf -&gt; TyConSet -&gt; Kind -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747166"><span class="hs-identifier hs-var hs-var">go_arg_ty</span></a></span></span><span> </span><span id="local-6989586621682747168"><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747168"><span class="hs-identifier hs-var">fuel</span></a></span></span><span> </span><span id="local-6989586621682747169"><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747169"><span class="hs-identifier hs-var">visited_tcs</span></a></span></span><span> </span><span id="local-6989586621682747170"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747170"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1430"></span><span>      </span><span class="hs-comment">--- | pprTrace &quot;arg_ty&quot; (ppr ty) False = undefined</span><span>
</span><span id="line-1431"></span><span>
</span><span id="line-1432"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747171"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747171"><span class="hs-identifier hs-var">_tcv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747172"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747172"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Maybe (Id, Kind)
</span><a href="GHC.Core.Type.html#splitForAllTyCoVar_maybe"><span class="hs-identifier hs-var">splitForAllTyCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747170"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1433"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntWithInf -&gt; TyConSet -&gt; Kind -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747166"><span class="hs-identifier hs-var">go_arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747168"><span class="hs-identifier hs-var">fuel</span></a></span><span> </span><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747169"><span class="hs-identifier hs-var">visited_tcs</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747172"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-1434"></span><span>          </span><span class="hs-comment">-- See Note [Detecting recursive data constructors], point (A)</span><span>
</span><span id="line-1435"></span><span>
</span><span id="line-1436"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747173"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747173"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747174"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747174"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Maybe (TyCon, [Kind])
Kind -&gt; Maybe (TyCon, [Kind])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747170"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1437"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntWithInf -&gt; TyConSet -&gt; TyCon -&gt; [Kind] -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747175"><span class="hs-identifier hs-var">go_tc_app</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747168"><span class="hs-identifier hs-var">fuel</span></a></span><span> </span><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747169"><span class="hs-identifier hs-var">visited_tcs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747173"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747174"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-1438"></span><span>
</span><span id="line-1439"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1440"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#NonRecursiveOrUnsure"><span class="hs-identifier hs-var">NonRecursiveOrUnsure</span></a></span><span>
</span><span id="line-1441"></span><span>
</span><span id="line-1442"></span><span>    </span><span class="annot"><a href="#local-6989586621682747175"><span class="hs-identifier hs-type">go_tc_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.Set.html#TyConSet"><span class="hs-identifier hs-type">TyConSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span>
</span><span id="line-1443"></span><span>    </span><span id="local-6989586621682747175"><span class="annot"><span class="annottext">go_tc_app :: IntWithInf -&gt; TyConSet -&gt; TyCon -&gt; [Kind] -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747175"><span class="hs-identifier hs-var hs-var">go_tc_app</span></a></span></span><span> </span><span id="local-6989586621682747176"><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747176"><span class="hs-identifier hs-var">fuel</span></a></span></span><span> </span><span id="local-6989586621682747177"><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747177"><span class="hs-identifier hs-var">visited_tcs</span></a></span></span><span> </span><span id="local-6989586621682747178"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747178"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682747179"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747179"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1444"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe [DataCon]
</span><a href="GHC.Core.TyCon.html#tyConDataCons_maybe"><span class="hs-identifier hs-var">tyConDataCons_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747178"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1445"></span><span>      </span><span class="hs-comment">--- | pprTrace &quot;tc_app&quot; (vcat [ppr tc, ppr tc_args]) False = undefined</span><span>
</span><span id="line-1446"></span><span>        </span><span class="annot"><span class="annottext">Maybe [DataCon]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#HetReduction"><span class="hs-identifier hs-type">HetReduction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682747181"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747181"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; TyCon -&gt; [Kind] -&gt; Maybe HetReduction
</span><a href="GHC.Core.FamInstEnv.html#topReduceTyFamApp_maybe"><span class="hs-identifier hs-var">topReduceTyFamApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621682747156"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747178"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747179"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-1447"></span><span>          </span><span class="hs-comment">-- This is the only place where we look at tc_args, which might have</span><span>
</span><span id="line-1448"></span><span>          </span><span class="hs-comment">-- See Note [Detecting recursive data constructors], point (C) and (5)</span><span>
</span><span id="line-1449"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntWithInf -&gt; TyConSet -&gt; Kind -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747166"><span class="hs-identifier hs-var">go_arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747176"><span class="hs-identifier hs-var">fuel</span></a></span><span> </span><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747177"><span class="hs-identifier hs-var">visited_tcs</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747181"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1450"></span><span>
</span><span id="line-1451"></span><span>        </span><span class="annot"><span class="annottext">Maybe [DataCon]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747178"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; TyCon
</span><a href="GHC.Core.DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747158"><span class="hs-identifier hs-var">orig_dc</span></a></span><span>
</span><span id="line-1452"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span> </span><span class="hs-comment">-- loop found!</span><span>
</span><span id="line-1453"></span><span>
</span><span id="line-1454"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682747183"><span class="annot"><span class="annottext">[DataCon]
</span><a href="#local-6989586621682747183"><span class="hs-identifier hs-var">dcs</span></a></span></span><span>
</span><span id="line-1455"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[IsRecDataConResult] -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCRs"><span class="hs-identifier hs-var">combineIRDCRs</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">IntWithInf -&gt; TyConSet -&gt; Kind -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747166"><span class="hs-identifier hs-var">go_arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747176"><span class="hs-identifier hs-var">fuel</span></a></span><span> </span><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747184"><span class="hs-identifier hs-var">visited_tcs'</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747185"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682747185"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747185"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747179"><span class="hs-identifier hs-var">tc_args</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1456"></span><span>              </span><span class="hs-comment">-- Check tc_args, See Note [Detecting recursive data constructors], point (5)</span><span>
</span><span id="line-1457"></span><span>              </span><span class="hs-comment">-- The new visited_tcs', so that we don't recursively check tc,</span><span>
</span><span id="line-1458"></span><span>              </span><span class="hs-comment">-- promising that we will check it below.</span><span>
</span><span id="line-1459"></span><span>              </span><span class="hs-comment">-- Do the tc_args check *before* the dcs check below, otherwise</span><span>
</span><span id="line-1460"></span><span>              </span><span class="hs-comment">-- we might miss an obvious rec occ in tc_args when we run out of</span><span>
</span><span id="line-1461"></span><span>              </span><span class="hs-comment">-- fuel and respond NonRecursiveOrUnsure instead</span><span>
</span><span id="line-1462"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span>
</span><span id="line-1463"></span><span>
</span><span id="line-1464"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747176"><span class="hs-identifier hs-var">fuel</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf -&gt; IntWithInf -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1465"></span><span>              </span><span class="hs-comment">-- See Note [Detecting recursive data constructors], point (4)</span><span>
</span><span id="line-1466"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747178"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyConSet -&gt; Bool
</span><a href="GHC.Core.TyCon.Set.html#elemTyConSet"><span class="hs-operator hs-var">`elemTyConSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747177"><span class="hs-identifier hs-var">visited_tcs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1467"></span><span>              </span><span class="hs-comment">-- only need to check tc if we haven't visited it already. NB: original visited_tcs</span><span>
</span><span id="line-1468"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[IsRecDataConResult] -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#combineIRDCRs"><span class="hs-identifier hs-var">combineIRDCRs</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">IntWithInf -&gt; TyConSet -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="#local-6989586621682747161"><span class="hs-identifier hs-var">go_dc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntWithInf -&gt; Int -&gt; IntWithInf
</span><a href="GHC.Types.Basic.html#subWithInf"><span class="hs-identifier hs-var">subWithInf</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621682747176"><span class="hs-identifier hs-var">fuel</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747184"><span class="hs-identifier hs-var">visited_tcs'</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747188"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682747188"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747188"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DataCon]
</span><a href="#local-6989586621682747183"><span class="hs-identifier hs-var">dcs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1469"></span><span>              </span><span class="hs-comment">-- Finally: check ds</span><span>
</span><span id="line-1470"></span><span>
</span><span id="line-1471"></span><span>        </span><span class="annot"><span class="annottext">Maybe [DataCon]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#NonRecursiveOrUnsure"><span class="hs-identifier hs-var">NonRecursiveOrUnsure</span></a></span><span>
</span><span id="line-1472"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1473"></span><span>          </span><span id="local-6989586621682747184"><span class="annot"><span class="annottext">visited_tcs' :: TyConSet
</span><a href="#local-6989586621682747184"><span class="hs-identifier hs-var hs-var">visited_tcs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyConSet -&gt; TyCon -&gt; TyConSet
</span><a href="GHC.Core.TyCon.Set.html#extendTyConSet"><span class="hs-identifier hs-var">extendTyConSet</span></a></span><span> </span><span class="annot"><span class="annottext">TyConSet
</span><a href="#local-6989586621682747177"><span class="hs-identifier hs-var">visited_tcs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682747178"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1474"></span><span>
</span><span id="line-1475"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Worker/wrapper for CPR}
*                                                                      *
************************************************************************
See Note [Worker/wrapper for CPR] for an overview.
-}</span><span>
</span><span id="line-1483"></span><span>
</span><span id="line-1484"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr_entry"><span class="hs-identifier hs-type">mkWWcpr_entry</span></a></span><span>
</span><span id="line-1485"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span>
</span><span id="line-1486"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>                              </span><span class="hs-comment">-- function body</span><span>
</span><span id="line-1487"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#Cpr"><span class="hs-identifier hs-type">Cpr</span></a></span><span>                               </span><span class="hs-comment">-- CPR analysis results</span><span>
</span><span id="line-1488"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-type">WwUse</span></a></span><span class="hs-special">,</span><span>                    </span><span class="hs-comment">-- Is w/w'ing useful?</span><span>
</span><span id="line-1489"></span><span>             </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- New wrapper. 'nop_fn' if not useful</span><span>
</span><span id="line-1490"></span><span>             </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- New worker.  'nop_fn' if not useful</span><span>
</span><span id="line-1491"></span><span class="annot"><span class="hs-comment">-- ^ Entrypoint to CPR W/W. See Note [Worker/wrapper for CPR] for an overview.</span></span><span>
</span><span id="line-1492"></span><span id="mkWWcpr_entry"><span class="annot"><span class="annottext">mkWWcpr_entry :: WwOpts
-&gt; Kind
-&gt; Cpr
-&gt; UniqSM (Bool, CoreExpr -&gt; CoreExpr, CoreExpr -&gt; CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr_entry"><span class="hs-identifier hs-var hs-var">mkWWcpr_entry</span></a></span></span><span> </span><span id="local-6989586621682747190"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747190"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682747191"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747191"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span> </span><span id="local-6989586621682747192"><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621682747192"><span class="hs-identifier hs-var">body_cpr</span></a></span></span><span>
</span><span id="line-1493"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WwOpts -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_cpr_anal"><span class="hs-identifier hs-var">wo_cpr_anal</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747190"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, CoreExpr -&gt; CoreExpr, CoreExpr -&gt; CoreExpr)
-&gt; UniqSM (Bool, CoreExpr -&gt; CoreExpr, CoreExpr -&gt; CoreExpr)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-var">boringSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-var">nop_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-var">nop_fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1494"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1495"></span><span>    </span><span class="hs-comment">-- Part (1)</span><span>
</span><span id="line-1496"></span><span>    </span><span id="local-6989586621682747193"><span class="annot"><a href="#local-6989586621682747193"><span class="hs-identifier hs-var">res_bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; UniqSM Id
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mk_res_bndr"><span class="hs-identifier hs-var">mk_res_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747191"><span class="hs-identifier hs-var">body_ty</span></a></span><span>
</span><span id="line-1497"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682747195"><span class="annot"><a href="#local-6989586621682747195"><span class="hs-identifier hs-var hs-var">bind_res_bndr</span></a></span></span><span> </span><span id="local-6989586621682747196"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747196"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682747197"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747197"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkDefaultCase"><span class="hs-identifier hs-var">mkDefaultCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747196"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747193"><span class="hs-identifier hs-var">res_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747197"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-1498"></span><span>
</span><span id="line-1499"></span><span>    </span><span class="hs-comment">-- Part (2)</span><span>
</span><span id="line-1500"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682747199"><span class="annot"><a href="#local-6989586621682747199"><span class="hs-identifier hs-var">useful</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#fromOL"><span class="hs-identifier hs-type">fromOL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621682747201"><span class="annot"><a href="#local-6989586621682747201"><span class="hs-identifier hs-var">transit_vars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747202"><span class="annot"><a href="#local-6989586621682747202"><span class="hs-identifier hs-var">rebuilt_result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747203"><span class="annot"><a href="#local-6989586621682747203"><span class="hs-identifier hs-var">work_unpack_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1501"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr_one"><span class="hs-identifier hs-type">mkWWcpr_one</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747190"><span class="hs-identifier hs-type">opts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747193"><span class="hs-identifier hs-type">res_bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747192"><span class="hs-identifier hs-type">body_cpr</span></a></span><span>
</span><span id="line-1502"></span><span>
</span><span id="line-1503"></span><span>    </span><span class="hs-comment">-- Part (3)</span><span>
</span><span id="line-1504"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747205"><span class="annot"><a href="#local-6989586621682747205"><span class="hs-identifier hs-var">unbox_transit_tup</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747206"><span class="annot"><a href="#local-6989586621682747206"><span class="hs-identifier hs-var">transit_tup</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#move_transit_vars"><span class="hs-identifier hs-type">move_transit_vars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747201"><span class="hs-identifier hs-type">transit_vars</span></a></span><span>
</span><span id="line-1505"></span><span>
</span><span id="line-1506"></span><span>    </span><span class="hs-comment">-- Stacking unboxer (work_fn) and builder (wrap_fn) together</span><span>
</span><span id="line-1507"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682747208"><span class="annot"><a href="#local-6989586621682747208"><span class="hs-identifier hs-var hs-var">wrap_fn</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682747205"><span class="hs-identifier hs-var">unbox_transit_tup</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747202"><span class="hs-identifier hs-var">rebuilt_result</span></a></span><span>                 </span><span class="hs-comment">-- 3 2</span><span>
</span><span id="line-1508"></span><span>        </span><span id="local-6989586621682747209"><span class="annot"><a href="#local-6989586621682747209"><span class="hs-identifier hs-var hs-var">work_fn</span></a></span></span><span> </span><span id="local-6989586621682747210"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747210"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682747195"><span class="hs-identifier hs-var">bind_res_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747210"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682747203"><span class="hs-identifier hs-var">work_unpack_res</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747206"><span class="hs-identifier hs-var">transit_tup</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- 1 2 3</span><span>
</span><span id="line-1509"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621682747199"><span class="hs-identifier hs-type">useful</span></a></span><span>
</span><span id="line-1510"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-type">boringSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-type">nop_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-type">nop_fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1511"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#usefulSplit"><span class="hs-identifier hs-type">usefulSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747208"><span class="hs-identifier hs-type">wrap_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747209"><span class="hs-identifier hs-type">work_fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1512"></span><span>
</span><span id="line-1513"></span><span class="annot"><span class="hs-comment">-- | Part (1) of Note [Worker/wrapper for CPR].</span></span><span>
</span><span id="line-1514"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mk_res_bndr"><span class="hs-identifier hs-type">mk_res_bndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-1515"></span><span id="mk_res_bndr"><span class="annot"><span class="annottext">mk_res_bndr :: Kind -&gt; UniqSM Id
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mk_res_bndr"><span class="hs-identifier hs-var hs-var">mk_res_bndr</span></a></span></span><span> </span><span id="local-6989586621682747211"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747211"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1516"></span><span>  </span><span class="hs-comment">-- See Note [Linear types and CPR]</span><span>
</span><span id="line-1517"></span><span>  </span><span id="local-6989586621682747212"><span class="annot"><a href="#local-6989586621682747212"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Kind -&gt; Kind -&gt; UniqSM Id
forall (m :: * -&gt; *).
MonadUnique m =&gt;
FastString -&gt; Kind -&gt; Kind -&gt; m Id
</span><a href="GHC.Types.Id.html#mkSysLocalOrCoVarM"><span class="hs-identifier hs-var">mkSysLocalOrCoVarM</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#ww_prefix"><span class="hs-identifier hs-var">ww_prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#cprCaseBndrMult"><span class="hs-identifier hs-var">cprCaseBndrMult</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747211"><span class="hs-identifier hs-var">body_ty</span></a></span><span>
</span><span id="line-1518"></span><span>  </span><span class="hs-comment">-- See Note [Record evaluated-ness in worker/wrapper]</span><span>
</span><span id="line-1519"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.html#setCaseBndrEvald"><span class="hs-identifier hs-type">setCaseBndrEvald</span></a></span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#MarkedStrict"><span class="hs-identifier hs-type">MarkedStrict</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747212"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1520"></span><span>
</span><span id="line-1521"></span><span class="hs-comment">-- | What part (2) of Note [Worker/wrapper for CPR] collects.</span><span>
</span><span id="line-1522"></span><span class="hs-comment">--</span><span>
</span><span id="line-1523"></span><span class="hs-comment">--   1. A 'WwUse' capturing whether the split does anything useful.</span><span>
</span><span id="line-1524"></span><span class="hs-comment">--   2. The list of transit variables (see the Note).</span><span>
</span><span id="line-1525"></span><span class="hs-comment">--   3. The result builder expression for the wrapper.  The original case binder if not useful.</span><span>
</span><span id="line-1526"></span><span class="hs-comment">--   4. The result unpacking expression for the worker. 'nop_fn' if not useful.</span><span>
</span><span id="line-1527"></span><span class="hs-keyword">type</span><span> </span><span id="CprWwResultOne"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#CprWwResultOne"><span class="hs-identifier hs-var">CprWwResultOne</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-type">WwUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1528"></span><span class="hs-keyword">type</span><span> </span><span id="CprWwResultMany"><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#CprWwResultMany"><span class="hs-identifier hs-var">CprWwResultMany</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwUse"><span class="hs-identifier hs-type">WwUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1529"></span><span>
</span><span id="line-1530"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr"><span class="hs-identifier hs-type">mkWWcpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Cpr.html#Cpr"><span class="hs-identifier hs-type">Cpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#CprWwResultMany"><span class="hs-identifier hs-type">CprWwResultMany</span></a></span><span>
</span><span id="line-1531"></span><span id="mkWWcpr"><span class="annot"><span class="annottext">mkWWcpr :: WwOpts -&gt; [Id] -&gt; [Cpr] -&gt; UniqSM CprWwResultMany
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr"><span class="hs-identifier hs-var hs-var">mkWWcpr</span></a></span></span><span> </span><span id="local-6989586621682747218"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747218"><span class="hs-identifier hs-var">_opts</span></a></span></span><span> </span><span id="local-6989586621682747219"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747219"><span class="hs-identifier hs-var">vars</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">=</span><span>
</span><span id="line-1532"></span><span>  </span><span class="hs-comment">-- special case: No CPRs means all top (for example from FlatConCpr),</span><span>
</span><span id="line-1533"></span><span>  </span><span class="hs-comment">-- hence stop WW.</span><span>
</span><span id="line-1534"></span><span>  </span><span class="annot"><span class="annottext">CprWwResultMany -&gt; UniqSM CprWwResultMany
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-var">boringSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; OrdList Id
forall a. [a] -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#toOL"><span class="hs-identifier hs-var">toOL</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747219"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; CoreExpr) -&gt; [Id] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747219"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-var">nop_fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1535"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr"><span class="hs-identifier hs-var">mkWWcpr</span></a></span><span> </span><span id="local-6989586621682747221"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747221"><span class="hs-identifier hs-var">opts</span></a></span></span><span>  </span><span id="local-6989586621682747222"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747222"><span class="hs-identifier hs-var">vars</span></a></span></span><span> </span><span id="local-6989586621682747223"><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621682747223"><span class="hs-identifier hs-var">cprs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1536"></span><span>  </span><span class="hs-comment">-- No existentials in 'vars'. 'canUnboxResult' should have checked that.</span><span>
</span><span id="line-1537"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; UniqSM ()
forall (m :: * -&gt; *).
(HasCallStack, Applicative m) =&gt;
Bool -&gt; SDoc -&gt; m ()
</span><a href="GHC.Utils.Panic.html#massertPpr"><span class="hs-identifier hs-var">massertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747222"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747222"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[Cpr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621682747223"><span class="hs-identifier hs-var">cprs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1538"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; UniqSM ()
forall (m :: * -&gt; *).
(HasCallStack, Applicative m) =&gt;
Bool -&gt; SDoc -&gt; m ()
</span><a href="GHC.Utils.Panic.html#massertPpr"><span class="hs-identifier hs-var">massertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; [Cpr] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747222"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621682747223"><span class="hs-identifier hs-var">cprs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747222"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[Cpr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621682747223"><span class="hs-identifier hs-var">cprs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1539"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682747225"><span class="annot"><a href="#local-6989586621682747225"><span class="hs-identifier hs-var">usefuls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747226"><span class="annot"><a href="#local-6989586621682747226"><span class="hs-identifier hs-var">varss</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747227"><span class="annot"><a href="#local-6989586621682747227"><span class="hs-identifier hs-var">rebuilt_results</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747228"><span class="annot"><a href="#local-6989586621682747228"><span class="hs-identifier hs-var">work_unpack_ress</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1540"></span><span>    </span><span class="annot"><span class="annottext">[(Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)]
-&gt; ([Bool], [OrdList Id], [CoreExpr], [CoreExpr -&gt; CoreExpr])
forall a b c d. [(a, b, c, d)] -&gt; ([a], [b], [c], [d])
</span><span class="hs-identifier hs-var">unzip4</span></span><span> </span><span class="annot"><span class="annottext">([(Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)]
 -&gt; ([Bool], [OrdList Id], [CoreExpr], [CoreExpr -&gt; CoreExpr]))
-&gt; UniqSM [(Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)]
-&gt; UniqSM
     ([Bool], [OrdList Id], [CoreExpr], [CoreExpr -&gt; CoreExpr])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Id
 -&gt; Cpr
 -&gt; UniqSM (Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr))
-&gt; [Id]
-&gt; [Cpr]
-&gt; UniqSM [(Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WwOpts
-&gt; Id
-&gt; Cpr
-&gt; UniqSM (Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr_one"><span class="hs-identifier hs-var">mkWWcpr_one</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747221"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747222"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621682747223"><span class="hs-identifier hs-var">cprs</span></a></span><span>
</span><span id="line-1541"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">or</span></span><span> </span><span class="annot"><a href="#local-6989586621682747225"><span class="hs-identifier hs-type">usefuls</span></a></span><span>
</span><span id="line-1542"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#concatOL"><span class="hs-identifier hs-type">concatOL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747226"><span class="hs-identifier hs-type">varss</span></a></span><span>
</span><span id="line-1543"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747227"><span class="hs-identifier hs-type">rebuilt_results</span></a></span><span>
</span><span id="line-1544"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">foldl'</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">(.)</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-type">nop_fn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747228"><span class="hs-identifier hs-type">work_unpack_ress</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1545"></span><span>
</span><span id="line-1546"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr_one"><span class="hs-identifier hs-type">mkWWcpr_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#Cpr"><span class="hs-identifier hs-type">Cpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#CprWwResultOne"><span class="hs-identifier hs-type">CprWwResultOne</span></a></span><span>
</span><span id="line-1547"></span><span class="annot"><span class="hs-comment">-- ^ See if we want to unbox the result and hand off to 'unbox_one_result'.</span></span><span>
</span><span id="line-1548"></span><span id="mkWWcpr_one"><span class="annot"><span class="annottext">mkWWcpr_one :: WwOpts
-&gt; Id
-&gt; Cpr
-&gt; UniqSM (Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr_one"><span class="hs-identifier hs-var hs-var">mkWWcpr_one</span></a></span></span><span> </span><span id="local-6989586621682747233"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747233"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682747234"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747234"><span class="hs-identifier hs-var">res_bndr</span></a></span></span><span> </span><span id="local-6989586621682747235"><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621682747235"><span class="hs-identifier hs-var">cpr</span></a></span></span><span>
</span><span id="line-1549"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747234"><span class="hs-identifier hs-var">res_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1550"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-type">DoUnbox</span></a></span><span> </span><span id="local-6989586621682747237"><span class="annot"><span class="annottext">DataConPatContext Cpr
</span><a href="#local-6989586621682747237"><span class="hs-identifier hs-var">dcpc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
-&gt; Kind -&gt; Cpr -&gt; UnboxingDecision (DataConPatContext Cpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#canUnboxResult"><span class="hs-identifier hs-var">canUnboxResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WwOpts -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_fam_envs"><span class="hs-identifier hs-var">wo_fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747233"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747234"><span class="hs-identifier hs-var">res_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621682747235"><span class="hs-identifier hs-var">cpr</span></a></span><span>
</span><span id="line-1551"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WwOpts
-&gt; Id
-&gt; DataConPatContext Cpr
-&gt; UniqSM (Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#unbox_one_result"><span class="hs-identifier hs-var">unbox_one_result</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747233"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747234"><span class="hs-identifier hs-var">res_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">DataConPatContext Cpr
</span><a href="#local-6989586621682747237"><span class="hs-identifier hs-var">dcpc</span></a></span><span>
</span><span id="line-1552"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1553"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)
-&gt; UniqSM (Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-var">boringSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OrdList Id
forall a. a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#unitOL"><span class="hs-identifier hs-var">unitOL</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747234"><span class="hs-identifier hs-var">res_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747234"><span class="hs-identifier hs-var">res_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-var">nop_fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1554"></span><span>
</span><span id="line-1555"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#unbox_one_result"><span class="hs-identifier hs-type">unbox_one_result</span></a></span><span>
</span><span id="line-1556"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-type">DataConPatContext</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#Cpr"><span class="hs-identifier hs-type">Cpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#CprWwResultOne"><span class="hs-identifier hs-type">CprWwResultOne</span></a></span><span>
</span><span id="line-1557"></span><span class="annot"><span class="hs-comment">-- ^ Implements the main bits of part (2) of Note [Worker/wrapper for CPR]</span></span><span>
</span><span id="line-1558"></span><span id="unbox_one_result"><span class="annot"><span class="annottext">unbox_one_result :: WwOpts
-&gt; Id
-&gt; DataConPatContext Cpr
-&gt; UniqSM (Bool, OrdList Id, CoreExpr, CoreExpr -&gt; CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#unbox_one_result"><span class="hs-identifier hs-var hs-var">unbox_one_result</span></a></span></span><span> </span><span id="local-6989586621682747239"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621682747239"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682747240"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747240"><span class="hs-identifier hs-var">res_bndr</span></a></span></span><span>
</span><span id="line-1559"></span><span>                 </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-type">DataConPatContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dcpc_dc :: forall s. DataConPatContext s -&gt; DataCon
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_dc"><span class="hs-identifier hs-var">dcpc_dc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682747241"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747241"><span class="hs-identifier hs-var">dc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_tc_args :: forall s. DataConPatContext s -&gt; [Kind]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_tc_args"><span class="hs-identifier hs-var">dcpc_tc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682747242"><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747242"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span>
</span><span id="line-1560"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_co :: forall s. DataConPatContext s -&gt; Coercion
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_co"><span class="hs-identifier hs-var">dcpc_co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682747243"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747243"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_args :: forall s. DataConPatContext s -&gt; [s]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_args"><span class="hs-identifier hs-var">dcpc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682747244"><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621682747244"><span class="hs-identifier hs-var">arg_cprs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1561"></span><span>  </span><span class="hs-comment">-- unboxer (free in `res_bndr`):       |   builder (where &lt;i&gt; builds what was</span><span>
</span><span id="line-1562"></span><span>  </span><span class="hs-comment">--   ( case res_bndr of (i, j) -&gt; )    |            bound to i)</span><span>
</span><span id="line-1563"></span><span>  </span><span class="hs-comment">--   ( case i of I# a -&gt;          )    |</span><span>
</span><span id="line-1564"></span><span>  </span><span class="hs-comment">--   ( case j of I# b -&gt;          )    |     (      (&lt;i&gt;, &lt;j&gt;)      )</span><span>
</span><span id="line-1565"></span><span>  </span><span class="hs-comment">--   ( &lt;hole&gt;                     )    |</span><span>
</span><span id="line-1566"></span><span>  </span><span id="local-6989586621682747245"><span class="annot"><a href="#local-6989586621682747245"><span class="hs-identifier hs-var">pat_bndrs_uniqs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM [Unique]
forall (m :: * -&gt; *). MonadUnique m =&gt; m [Unique]
</span><a href="GHC.Types.Unique.Supply.html#getUniquesM"><span class="hs-identifier hs-var">getUniquesM</span></a></span><span>
</span><span id="line-1567"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682747246"><span class="annot"><a href="#local-6989586621682747246"><span class="hs-identifier hs-var">_exs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747247"><span class="annot"><a href="#local-6989586621682747247"><span class="hs-identifier hs-var">arg_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1568"></span><span>        </span><span class="annot"><a href="GHC.Core.Utils.html#dataConRepFSInstPat"><span class="hs-identifier hs-type">dataConRepFSInstPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">repeat</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#ww_prefix"><span class="hs-identifier hs-type">ww_prefix</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682747245"><span class="hs-identifier hs-type">pat_bndrs_uniqs</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#cprCaseBndrMult"><span class="hs-identifier hs-type">cprCaseBndrMult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747241"><span class="hs-identifier hs-type">dc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747242"><span class="hs-identifier hs-type">tc_args</span></a></span><span>
</span><span id="line-1569"></span><span>  </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-type">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621682747246"><span class="hs-identifier hs-type">_exs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Should have been caught by canUnboxResult</span><span>
</span><span id="line-1570"></span><span>
</span><span id="line-1571"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682747249"><span class="annot"><a href="#local-6989586621682747249"><span class="hs-identifier hs-var">nested_useful</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747250"><span class="annot"><a href="#local-6989586621682747250"><span class="hs-identifier hs-var">transit_vars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747251"><span class="annot"><a href="#local-6989586621682747251"><span class="hs-identifier hs-var">con_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682747252"><span class="annot"><a href="#local-6989586621682747252"><span class="hs-identifier hs-var">work_unbox_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1572"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWcpr"><span class="hs-identifier hs-type">mkWWcpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747239"><span class="hs-identifier hs-type">opts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747247"><span class="hs-identifier hs-type">arg_ids</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747244"><span class="hs-identifier hs-type">arg_cprs</span></a></span><span>
</span><span id="line-1573"></span><span>
</span><span id="line-1574"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- rebuilt_result = (C a b |&gt; sym co)</span><span>
</span><span id="line-1575"></span><span>      </span><span id="local-6989586621682747253"><span class="annot"><a href="#local-6989586621682747253"><span class="hs-identifier hs-var hs-var">rebuilt_result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [CoreExpr] -&gt; CoreExpr
forall b. DataCon -&gt; [Arg b] -&gt; Arg b
</span><a href="GHC.Core.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747241"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Kind -&gt; CoreExpr) -&gt; [Kind] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; CoreExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">[Kind]
</span><a href="#local-6989586621682747242"><span class="hs-identifier hs-var">tc_args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682747251"><span class="hs-identifier hs-var">con_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-operator hs-var">`mkCast`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747243"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1576"></span><span>      </span><span class="hs-comment">-- this_work_unbox_res alt = (case res_bndr |&gt; co of C a b -&gt; &lt;alt&gt;[a,b])</span><span>
</span><span id="line-1577"></span><span>      </span><span id="local-6989586621682747254"><span class="annot"><a href="#local-6989586621682747254"><span class="hs-identifier hs-var hs-var">this_work_unbox_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
-&gt; Coercion -&gt; Kind -&gt; DataCon -&gt; [Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkUnpackCase"><span class="hs-identifier hs-var">mkUnpackCase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747240"><span class="hs-identifier hs-var">res_bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747243"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#cprCaseBndrMult"><span class="hs-identifier hs-var">cprCaseBndrMult</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747241"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747247"><span class="hs-identifier hs-var">arg_ids</span></a></span><span>
</span><span id="line-1578"></span><span>
</span><span id="line-1579"></span><span>  </span><span class="hs-comment">-- See Note [Unboxing through unboxed tuples]</span><span>
</span><span id="line-1580"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#isUnboxedTupleDataCon"><span class="hs-identifier hs-type">isUnboxedTupleDataCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747241"><span class="hs-identifier hs-type">dc</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621682747249"><span class="hs-identifier hs-type">nested_useful</span></a></span><span>
</span><span id="line-1581"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#boringSplit"><span class="hs-identifier hs-type">boringSplit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#unitOL"><span class="hs-identifier hs-type">unitOL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747240"><span class="hs-identifier hs-type">res_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682747240"><span class="hs-identifier hs-type">res_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#nop_fn"><span class="hs-identifier hs-type">nop_fn</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1582"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#usefulSplit"><span class="hs-identifier hs-type">usefulSplit</span></a></span><span>
</span><span id="line-1583"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747250"><span class="hs-identifier hs-type">transit_vars</span></a></span><span>
</span><span id="line-1584"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747253"><span class="hs-identifier hs-type">rebuilt_result</span></a></span><span>
</span><span id="line-1585"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682747254"><span class="hs-identifier hs-type">this_work_unbox_res</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="#local-6989586621682747252"><span class="hs-identifier hs-type">work_unbox_res</span></a></span><span>
</span><span id="line-1586"></span><span>                   </span><span class="hs-special">)</span><span>
</span><span id="line-1587"></span><span>
</span><span id="line-1588"></span><span class="hs-comment">-- | Implements part (3) of Note [Worker/wrapper for CPR].</span><span>
</span><span id="line-1589"></span><span class="hs-comment">--</span><span>
</span><span id="line-1590"></span><span class="hs-comment">-- If `move_transit_vars [a,b] = (unbox, tup)` then</span><span>
</span><span id="line-1591"></span><span class="hs-comment">--     * `a` and `b` are the *transit vars* to be returned from the worker</span><span>
</span><span id="line-1592"></span><span class="hs-comment">--       to the wrapper</span><span>
</span><span id="line-1593"></span><span class="hs-comment">--     * `unbox scrut alt = (case &lt;scrut&gt; of (# a, b #) -&gt; &lt;alt&gt;)`</span><span>
</span><span id="line-1594"></span><span class="hs-comment">--     * `tup = (# a, b #)`</span><span>
</span><span id="line-1595"></span><span class="hs-comment">-- There is a special case for when there's 1 transit var,</span><span>
</span><span id="line-1596"></span><span class="hs-comment">-- see Note [No unboxed tuple for single, unlifted transit var].</span><span>
</span><span id="line-1597"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#move_transit_vars"><span class="hs-identifier hs-type">move_transit_vars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1598"></span><span id="move_transit_vars"><span class="annot"><span class="annottext">move_transit_vars :: [Id] -&gt; (CoreExpr -&gt; CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#move_transit_vars"><span class="hs-identifier hs-var hs-var">move_transit_vars</span></a></span></span><span> </span><span id="local-6989586621682747255"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747255"><span class="hs-identifier hs-var">vars</span></a></span></span><span>
</span><span id="line-1599"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span id="local-6989586621682747256"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747256"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747255"><span class="hs-identifier hs-var">vars</span></a></span><span>
</span><span id="line-1600"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682747257"><span class="annot"><span class="annottext">var_ty :: Kind
</span><a href="#local-6989586621682747257"><span class="hs-identifier hs-var hs-var">var_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747256"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-1601"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Bool
Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747257"><span class="hs-identifier hs-var">var_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747256"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1602"></span><span>  </span><span class="hs-comment">-- See Note [No unboxed tuple for single, unlifted transit var]</span><span>
</span><span id="line-1603"></span><span>  </span><span class="hs-comment">--   * Wrapper: `unbox scrut alt = (case &lt;scrut&gt; of a -&gt; &lt;alt&gt;)`</span><span>
</span><span id="line-1604"></span><span>  </span><span class="hs-comment">--   * Worker:  `tup = a`</span><span>
</span><span id="line-1605"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682747259"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747259"><span class="hs-identifier hs-var">build_res</span></a></span></span><span> </span><span id="local-6989586621682747260"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747260"><span class="hs-identifier hs-var">wkr_call</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkDefaultCase"><span class="hs-identifier hs-var">mkDefaultCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747260"><span class="hs-identifier hs-var">wkr_call</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747256"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747259"><span class="hs-identifier hs-var">build_res</span></a></span><span>
</span><span id="line-1606"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747256"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- varToCoreExpr important here: var can be a coercion</span><span>
</span><span id="line-1607"></span><span>                          </span><span class="hs-comment">-- Lacking this caused #10658</span><span>
</span><span id="line-1608"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1609"></span><span>  </span><span class="hs-comment">-- The general case: Just return an unboxed tuple from the worker</span><span>
</span><span id="line-1610"></span><span>  </span><span class="hs-comment">--   * Wrapper: `unbox scrut alt = (case &lt;scrut&gt; of (# a, b #) -&gt; &lt;alt&gt;)`</span><span>
</span><span id="line-1611"></span><span>  </span><span class="hs-comment">--   * Worker:  `tup = (# a, b #)`</span><span>
</span><span id="line-1612"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682747261"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747261"><span class="hs-identifier hs-var">build_res</span></a></span></span><span> </span><span id="local-6989586621682747262"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747262"><span class="hs-identifier hs-var">wkr_call</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; AltCon -&gt; [Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkSingleAltCase"><span class="hs-identifier hs-var">mkSingleAltCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747262"><span class="hs-identifier hs-var">wkr_call</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747264"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-1613"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747266"><span class="hs-identifier hs-var">tup_con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747255"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747261"><span class="hs-identifier hs-var">build_res</span></a></span><span>
</span><span id="line-1614"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747267"><span class="hs-identifier hs-var">ubx_tup_app</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1615"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-1616"></span><span>    </span><span id="local-6989586621682747267"><span class="annot"><span class="annottext">ubx_tup_app :: CoreExpr
</span><a href="#local-6989586621682747267"><span class="hs-identifier hs-var hs-var">ubx_tup_app</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkCoreUnboxedTuple"><span class="hs-identifier hs-var">mkCoreUnboxedTuple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; CoreExpr) -&gt; [Id] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747255"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1617"></span><span>    </span><span id="local-6989586621682747266"><span class="annot"><span class="annottext">tup_con :: DataCon
</span><a href="#local-6989586621682747266"><span class="hs-identifier hs-var hs-var">tup_con</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Boxity -&gt; Int -&gt; DataCon
</span><a href="GHC.Builtin.Types.html#tupleDataCon"><span class="hs-identifier hs-var">tupleDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747255"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1618"></span><span>    </span><span class="hs-comment">-- See also Note [Linear types and CPR]</span><span>
</span><span id="line-1619"></span><span>    </span><span id="local-6989586621682747264"><span class="annot"><span class="annottext">case_bndr :: Id
</span><a href="#local-6989586621682747264"><span class="hs-identifier hs-var hs-var">case_bndr</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Kind -&gt; Id
</span><a href="GHC.Core.Make.html#mkWildValBinder"><span class="hs-identifier hs-var">mkWildValBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#cprCaseBndrMult"><span class="hs-identifier hs-var">cprCaseBndrMult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747267"><span class="hs-identifier hs-var">ubx_tup_app</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1620"></span><span>
</span><span id="line-1621"></span><span>
</span><span id="line-1622"></span><span class="hs-comment">{- Note [Worker/wrapper for CPR]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'mkWWcpr_entry' is the entry-point to the worker/wrapper transformation that
exploits CPR info. Here's an example:
```
  f :: ... -&gt; (Int, Int)
  f ... = &lt;body&gt;
```
Let's assume the CPR info `body_cpr` for the body of `f` says
&quot;unbox the pair and its components&quot; and `body_ty` is the type of the function
body `body` (i.e., `(Int, Int)`). Then `mkWWcpr_entry body_ty body_cpr` returns

  * A result-unpacking expression for the worker, with a hole for the fun body:
    ```
      unpack body = ( case &lt;body&gt; of r __DEFAULT -&gt; )    -- (1)
                    ( case r of (i, j) -&gt;           )    -- (2)
                    ( case i of I# a -&gt;             )    -- (2)
                    ( case j of I# b -&gt;             )    -- (2)
                    ( (# a, b #)                    )    -- (3)
    ```
  * A result-building expression for the wrapper, with a hole for the worker call:
    ```
      build wkr_call = ( case &lt;wkr_call&gt; of (# a, b #) -&gt; )    -- (3)
                       ( (I# a, I# b)                     )    -- (2)
    ```
  * The result type of the worker, e.g., `(# Int#, Int# #)` above.

To achieve said transformation, 'mkWWcpr_entry'

  1. First allocates a fresh result binder `r`, giving a name to the `body`
     expression and contributing part (1) of the unpacker and builder.
  2. Then it delegates to 'mkWWcpr_one', which recurses into all result fields
     to unbox, contributing the parts marked with (2). Crucially, it knows
     what belongs in the case scrutinee of the unpacker through the communicated
     Id `r`: The unpacking expression will be free in that variable.
     (This is a similar contract as that of 'mkWWstr_one' for strict args.)
  3. 'mkWWstr_one' produces a bunch of *transit vars*: Those result variables
     that have to be transferred from the worker to the wrapper, where the
     constructed result can be rebuilt, `a` and `b` above. Part (3) is
     responsible for tupling them up in the worker and taking the tuple apart
     in the wrapper. This is implemented in 'move_transit_vars'.

Note [No unboxed tuple for single, unlifted transit var]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When there's only a single, unlifted transit var (Note [Worker/wrapper for CPR]),
we don't wrap an unboxed singleton tuple around it (which otherwise would be
needed to suspend evaluation) and return the unlifted thing directly. E.g.
```
  f :: Int -&gt; Int
  f x = x+1
```
We certainly want `$wf :: Int# -&gt; Int#`, not `$wf :: Int# -&gt; (# Int# #)`.
This is OK as long as we know that evaluation of the returned thing terminates
quickly, as is the case for fields of unlifted type like `Int#`.

But more generally, this should also be true for *lifted* types that terminate
quickly! Consider from `T18109`:
```
  data F = F (Int -&gt; Int)
  f :: Int -&gt; F
  f n = F (+n)

  data T = T (Int, Int)
  g :: T -&gt; T
  g t@(T p) = p `seq` t

  data U = U ![Int]
  h :: Int -&gt; U
  h n = U [0..n]
```
All of the nested fields are actually ok-for-speculation and thus OK to
return unboxed instead of in an unboxed singleton tuple:

 1. The field of `F` is a HNF.
    We want `$wf :: Int -&gt; Int -&gt; Int`.
    We get  `$wf :: Int -&gt; (# Int -&gt; Int #)`.
 2. The field of `T` is `seq`'d in `g`.
    We want `$wg :: (Int, Int) -&gt; (Int, Int)`.
    We get  `$wg :: (Int, Int) -&gt; (# (Int, Int) #)`.
 3. The field of `U` is strict and thus always evaluated.
    We want  `$wh :: Int# -&gt; [Int]`.
    We'd get `$wh :: Int# -&gt; (# [Int] #)`.

By considering vars as unlifted that satisfy 'exprIsHNF', we catch (3).
Why not check for 'exprOkForSpeculation'? Quite perplexingly, evaluated vars
are not ok-for-spec, see Note [exprOkForSpeculation and evaluated variables].
For (1) and (2) we would have to look at the term. WW only looks at the
type and the CPR signature, so the only way to fix (1) and (2) would be to
have a nested termination signature, like in MR !1866.

Note [Linear types and CPR]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Remark on linearity: in both the case of the wrapper and the worker,
we build a linear case to unpack constructed products. All the
multiplicity information is kept in the constructors (both C and (#, #)).
In particular (#,#) is parameterised by the multiplicity of its fields.
Specifically, in this instance, the multiplicity of the fields of (#,#)
is chosen to be the same as those of C.


************************************************************************
*                                                                      *
\subsection{Utilities}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1728"></span><span>
</span><span id="line-1729"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkUnpackCase"><span class="hs-identifier hs-type">mkUnpackCase</span></a></span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1730"></span><span class="hs-comment">-- (mkUnpackCase e co Con args body)</span><span>
</span><span id="line-1731"></span><span class="hs-comment">--      returns</span><span>
</span><span id="line-1732"></span><span class="hs-comment">-- case e |&gt; co of _dead { Con args -&gt; body }</span><span>
</span><span id="line-1733"></span><span id="mkUnpackCase"><span class="annot"><span class="annottext">mkUnpackCase :: CoreExpr
-&gt; Coercion -&gt; Kind -&gt; DataCon -&gt; [Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkUnpackCase"><span class="hs-identifier hs-var hs-var">mkUnpackCase</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682747273"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682747273"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621682747274"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747274"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682747275"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747275"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682747276"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747276"><span class="hs-identifier hs-var">mult</span></a></span></span><span> </span><span id="local-6989586621682747277"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747277"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682747278"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747278"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682747279"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747279"><span class="hs-identifier hs-var">body</span></a></span></span><span>   </span><span class="hs-comment">-- See Note [Profiling and unpacking]</span><span>
</span><span id="line-1734"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682747273"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
-&gt; Coercion -&gt; Kind -&gt; DataCon -&gt; [Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkUnpackCase"><span class="hs-identifier hs-var">mkUnpackCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747274"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747275"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747276"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747277"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747278"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747279"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1735"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkUnpackCase"><span class="hs-identifier hs-var">mkUnpackCase</span></a></span><span> </span><span id="local-6989586621682747280"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747280"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682747281"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747281"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682747282"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747282"><span class="hs-identifier hs-var">mult</span></a></span></span><span> </span><span id="local-6989586621682747283"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747283"><span class="hs-identifier hs-var">boxing_con</span></a></span></span><span> </span><span id="local-6989586621682747284"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747284"><span class="hs-identifier hs-var">unpk_args</span></a></span></span><span> </span><span id="local-6989586621682747285"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747285"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-1736"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; AltCon -&gt; [Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkSingleAltCase"><span class="hs-identifier hs-var">mkSingleAltCase</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747286"><span class="hs-identifier hs-var">casted_scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682747287"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1737"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682747283"><span class="hs-identifier hs-var">boxing_con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682747284"><span class="hs-identifier hs-var">unpk_args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747285"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1738"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1739"></span><span>    </span><span id="local-6989586621682747286"><span class="annot"><span class="annottext">casted_scrut :: CoreExpr
</span><a href="#local-6989586621682747286"><span class="hs-identifier hs-var hs-var">casted_scrut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747280"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-operator hs-var">`mkCast`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682747281"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1740"></span><span>    </span><span id="local-6989586621682747287"><span class="annot"><span class="annottext">bndr :: Id
</span><a href="#local-6989586621682747287"><span class="hs-identifier hs-var hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Kind -&gt; Id
</span><a href="GHC.Core.Make.html#mkWildValBinder"><span class="hs-identifier hs-var">mkWildValBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682747282"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682747286"><span class="hs-identifier hs-var">casted_scrut</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1741"></span><span>
</span><span id="line-1742"></span><span class="hs-comment">-- | The multiplicity of a case binder unboxing a constructed result.</span><span>
</span><span id="line-1743"></span><span class="hs-comment">-- See Note [Linear types and CPR]</span><span>
</span><span id="line-1744"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#cprCaseBndrMult"><span class="hs-identifier hs-type">cprCaseBndrMult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Mult"><span class="hs-identifier hs-type">Mult</span></a></span><span>
</span><span id="line-1745"></span><span id="cprCaseBndrMult"><span class="annot"><span class="annottext">cprCaseBndrMult :: Kind
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#cprCaseBndrMult"><span class="hs-identifier hs-var hs-var">cprCaseBndrMult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Type.html#OneTy"><span class="hs-identifier hs-var">OneTy</span></a></span><span>
</span><span id="line-1746"></span><span>
</span><span id="line-1747"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#ww_prefix"><span class="hs-identifier hs-type">ww_prefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span>
</span><span id="line-1748"></span><span id="ww_prefix"><span class="annot"><span class="annottext">ww_prefix :: FastString
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#ww_prefix"><span class="hs-identifier hs-var hs-var">ww_prefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ww&quot;</span></span><span>
</span><span id="line-1749"></span><span>
</span><span id="line-1750"></span><span class="hs-comment">{- Note [Profiling and unpacking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the original function looked like
        f = \ x -&gt; {-# SCC &quot;foo&quot; #-} E

then we want the CPR'd worker to look like
        \ x -&gt; {-# SCC &quot;foo&quot; #-} (case E of I# x -&gt; x)
and definitely not
        \ x -&gt; case ({-# SCC &quot;foo&quot; #-} E) of I# x -&gt; x)

This transform doesn't move work or allocation
from one cost centre to another.

Later [SDM]: presumably this is because we want the simplifier to
eliminate the case, and the scc would get in the way?  I'm ok with
including the case itself in the cost centre, since it is morally
part of the function (post transformation) anyway.
-}</span><span>
</span><span id="line-1768"></span></pre></body></html>