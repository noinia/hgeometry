<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">--</span><span>
</span><span id="line-6"></span><span class="hs-comment">--  (c) The University of Glasgow 2002-2006</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">-- | The loader</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- This module deals with the top-level issues of dynamic linking (loading),</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- calling the object-code linker and the byte-code linker where necessary.</span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html"><span class="hs-identifier">GHC.Linker.Loader</span></a></span><span>
</span><span id="line-13"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#Loader"><span class="hs-identifier">Loader</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier">LoaderState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier">initLoaderState</span></a></span><span>
</span><span id="line-16"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#uninitializedLoader"><span class="hs-identifier">uninitializedLoader</span></a></span><span>
</span><span id="line-17"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#showLoaderState"><span class="hs-identifier">showLoaderState</span></a></span><span>
</span><span id="line-18"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#getLoaderState"><span class="hs-identifier">getLoaderState</span></a></span><span>
</span><span id="line-19"></span><span>   </span><span class="annot"><span class="hs-comment">-- * Load &amp; Unload</span></span><span>
</span><span id="line-20"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadExpr"><span class="hs-identifier">loadExpr</span></a></span><span>
</span><span id="line-21"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadDecls"><span class="hs-identifier">loadDecls</span></a></span><span>
</span><span id="line-22"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadPackages"><span class="hs-identifier">loadPackages</span></a></span><span>
</span><span id="line-23"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadModule"><span class="hs-identifier">loadModule</span></a></span><span>
</span><span id="line-24"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadCmdLineLibs"><span class="hs-identifier">loadCmdLineLibs</span></a></span><span>
</span><span id="line-25"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadName"><span class="hs-identifier">loadName</span></a></span><span>
</span><span id="line-26"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#unload"><span class="hs-identifier">unload</span></a></span><span>
</span><span id="line-27"></span><span>   </span><span class="annot"><span class="hs-comment">-- * LoadedEnv</span></span><span>
</span><span id="line-28"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#withExtendedLoadedEnv"><span class="hs-identifier">withExtendedLoadedEnv</span></a></span><span>
</span><span id="line-29"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#extendLoadedEnv"><span class="hs-identifier">extendLoadedEnv</span></a></span><span>
</span><span id="line-30"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#deleteFromLoadedEnv"><span class="hs-identifier">deleteFromLoadedEnv</span></a></span><span>
</span><span id="line-31"></span><span>   </span><span class="annot"><span class="hs-comment">-- * Internals</span></span><span>
</span><span id="line-32"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#rmDupLinkables"><span class="hs-identifier">rmDupLinkables</span></a></span><span>
</span><span id="line-33"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#modifyLoaderState"><span class="hs-identifier">modifyLoaderState</span></a></span><span>
</span><span id="line-34"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#initLinkDepsOpts"><span class="hs-identifier">initLinkDepsOpts</span></a></span><span>
</span><span id="line-35"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#getGccSearchDirectory"><span class="hs-identifier">getGccSearchDirectory</span></a></span><span>
</span><span id="line-36"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">where</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Settings.html"><span class="hs-identifier">GHC.Settings</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Platform.html"><span class="hs-identifier">GHC.Platform</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Platform.Ways.html"><span class="hs-identifier">GHC.Platform.Ways</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Phases.html"><span class="hs-identifier">GHC.Driver.Phases</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html"><span class="hs-identifier">GHC.Driver.Env</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html"><span class="hs-identifier">GHC.Driver.Session</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Ppr.html"><span class="hs-identifier">GHC.Driver.Ppr</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Diagnostic.html"><span class="hs-identifier">GHC.Driver.Config.Diagnostic</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Finder.html"><span class="hs-identifier">GHC.Driver.Config.Finder</span></a></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html"><span class="hs-identifier">GHC.Runtime.Interpreter</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html"><span class="hs-identifier">GHCi.RemoteTypes</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Iface.Load.html"><span class="hs-identifier">GHC.Iface.Load</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html"><span class="hs-identifier">GHCi.Message</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#LoadedDLL"><span class="hs-identifier">LoadedDLL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.ByteCode.Linker.html"><span class="hs-identifier">GHC.ByteCode.Linker</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.ByteCode.Asm.html"><span class="hs-identifier">GHC.ByteCode.Asm</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.ByteCode.Types.html"><span class="hs-identifier">GHC.ByteCode.Types</span></a></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.SysTools.html"><span class="hs-identifier">GHC.SysTools</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html"><span class="hs-identifier">GHC.Types.Name.Env</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.DSet.html"><span class="hs-identifier">GHC.Types.Unique.DSet</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.DFM.html"><span class="hs-identifier">GHC.Types.Unique.DFM</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html"><span class="hs-identifier">GHC.Utils.TmpFs</span></a></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Env.html"><span class="hs-identifier">GHC.Unit.Env</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.External.html"><span class="hs-identifier">GHC.Unit.External</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.External.html#ExternalPackageState"><span class="hs-identifier">ExternalPackageState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.External.html#EPS"><span class="hs-identifier">EPS</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Unit.External.html#eps_iface_bytecode"><span class="hs-identifier">eps_iface_bytecode</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.State.html"><span class="hs-identifier">GHC.Unit.State</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Packages</span></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.ShortText.html"><span class="hs-identifier">GHC.Data.ShortText</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Linker.Deps.html"><span class="hs-identifier">GHC.Linker.Deps</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Linker.MacOS.html"><span class="hs-identifier">GHC.Linker.MacOS</span></a></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Linker.Dynamic.html"><span class="hs-identifier">GHC.Linker.Dynamic</span></a></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html"><span class="hs-identifier">GHC.Linker.Types</span></a></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-comment">-- Standard libraries</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Char.html"><span class="hs-identifier">Data.Char</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isSpace</span></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Foldable</span></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">intercalate</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isPrefixOf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nub</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">partition</span></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Concurrent.MVar.html"><span class="hs-identifier">Control.Concurrent.MVar</span></a></span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html"><span class="hs-identifier">Control.Monad.Catch</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.html"><span class="hs-identifier">System.FilePath</span></a></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../directory-1.3.9.0-af18/src/System.Directory.html"><span class="hs-identifier">System.Directory</span></a></span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/System.IO.Unsafe.html"><span class="hs-identifier">System.IO.Unsafe</span></a></span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/System.Environment.html"><span class="hs-identifier">System.Environment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lookupEnv</span></span><span class="hs-special">)</span><span class="hs-cpp">

#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Win32.Info</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getSystemDirectory</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Exception.html"><span class="hs-identifier">GHC.Utils.Exception</span></a></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- Note [Linkers and loaders]</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-118"></span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- Linkers are used to produce linked objects (.so, executables); loaders are</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- used to link in memory (e.g., in GHCi) with the already loaded libraries</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- (ghc-lib, rts, etc.).</span><span>
</span><span id="line-122"></span><span class="hs-comment">--</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- Linking can usually be done with an external linker program (&quot;ld&quot;), but</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- loading is more tricky:</span><span>
</span><span id="line-125"></span><span class="hs-comment">--</span><span>
</span><span id="line-126"></span><span class="hs-comment">--    * Fully dynamic:</span><span>
</span><span id="line-127"></span><span class="hs-comment">--       when GHC is built as a set of dynamic libraries (ghc-lib, rts, etc.)</span><span>
</span><span id="line-128"></span><span class="hs-comment">--       and the modules to load are also compiled for dynamic linking, a</span><span>
</span><span id="line-129"></span><span class="hs-comment">--       solution is to fully rely on external tools:</span><span>
</span><span id="line-130"></span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span class="hs-comment">--       1) link a .so with the external linker</span><span>
</span><span id="line-132"></span><span class="hs-comment">--       2) load the .so with POSIX's &quot;dlopen&quot;</span><span>
</span><span id="line-133"></span><span class="hs-comment">--</span><span>
</span><span id="line-134"></span><span class="hs-comment">--    * When GHC is built as a static program or when libraries we want to load</span><span>
</span><span id="line-135"></span><span class="hs-comment">--    aren't compiled for dynamic linking, GHC uses its own loader (&quot;runtime</span><span>
</span><span id="line-136"></span><span class="hs-comment">--    linker&quot;). The runtime linker is part of the rts (rts/Linker.c).</span><span>
</span><span id="line-137"></span><span class="hs-comment">--</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- Note that within GHC's codebase we often use the word &quot;linker&quot; to refer to</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- the static object loader in the runtime system.</span><span>
</span><span id="line-140"></span><span class="hs-comment">--</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- Loading can be delegated to an external interpreter (&quot;iserv&quot;) when</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- -fexternal-interpreter is used.</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span id="local-6989586621683069396"><span class="annot"><a href="GHC.Linker.Loader.html#uninitialised"><span class="hs-identifier hs-type">uninitialised</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621683069396"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-145"></span><span id="uninitialised"><span class="annot"><span class="annottext">uninitialised :: forall a. a
</span><a href="GHC.Linker.Loader.html#uninitialised"><span class="hs-identifier hs-var hs-var">uninitialised</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; a
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Loader not initialised&quot;</span></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="annot"><a href="GHC.Linker.Loader.html#modifyLoaderState_"><span class="hs-identifier hs-type">modifyLoaderState_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span id="modifyLoaderState_"><span class="annot"><span class="annottext">modifyLoaderState_ :: Interp -&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#modifyLoaderState_"><span class="hs-identifier hs-var hs-var">modifyLoaderState_</span></a></span></span><span> </span><span id="local-6989586621683070122"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070122"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070123"><span class="annot"><span class="annottext">LoaderState -&gt; IO LoaderState
</span><a href="#local-6989586621683070123"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><span class="annottext">MVar (Maybe LoaderState)
-&gt; (Maybe LoaderState -&gt; IO (Maybe LoaderState)) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyMVar_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Loader -&gt; MVar (Maybe LoaderState)
</span><a href="GHC.Linker.Types.html#loader_state"><span class="hs-identifier hs-var">loader_state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Interp -&gt; Loader
</span><a href="GHC.Runtime.Interpreter.Types.html#interpLoader"><span class="hs-identifier hs-var">interpLoader</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070122"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LoaderState -&gt; Maybe LoaderState)
-&gt; IO LoaderState -&gt; IO (Maybe LoaderState)
forall a b. (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; Maybe LoaderState
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(IO LoaderState -&gt; IO (Maybe LoaderState))
-&gt; (Maybe LoaderState -&gt; IO LoaderState)
-&gt; Maybe LoaderState
-&gt; IO (Maybe LoaderState)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; IO LoaderState
</span><a href="#local-6989586621683070123"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(LoaderState -&gt; IO LoaderState)
-&gt; (Maybe LoaderState -&gt; LoaderState)
-&gt; Maybe LoaderState
-&gt; IO LoaderState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; Maybe LoaderState -&gt; LoaderState
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">LoaderState
forall a. a
</span><a href="GHC.Linker.Loader.html#uninitialised"><span class="hs-identifier hs-var">uninitialised</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span id="local-6989586621683069413"><span class="annot"><a href="GHC.Linker.Loader.html#modifyLoaderState"><span class="hs-identifier hs-type">modifyLoaderState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683069413"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621683069413"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-153"></span><span id="modifyLoaderState"><span class="annot"><span class="annottext">modifyLoaderState :: forall a. Interp -&gt; (LoaderState -&gt; IO (LoaderState, a)) -&gt; IO a
</span><a href="GHC.Linker.Loader.html#modifyLoaderState"><span class="hs-identifier hs-var hs-var">modifyLoaderState</span></a></span></span><span> </span><span id="local-6989586621683070131"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070131"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070132"><span class="annot"><span class="annottext">LoaderState -&gt; IO (LoaderState, a)
</span><a href="#local-6989586621683070132"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><span class="annottext">MVar (Maybe LoaderState)
-&gt; (Maybe LoaderState -&gt; IO (Maybe LoaderState, a)) -&gt; IO a
forall a b. MVar a -&gt; (a -&gt; IO (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">modifyMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Loader -&gt; MVar (Maybe LoaderState)
</span><a href="GHC.Linker.Types.html#loader_state"><span class="hs-identifier hs-var">loader_state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Interp -&gt; Loader
</span><a href="GHC.Runtime.Interpreter.Types.html#interpLoader"><span class="hs-identifier hs-var">interpLoader</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070131"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LoaderState -&gt; Maybe LoaderState)
-&gt; IO (LoaderState, a) -&gt; IO (Maybe LoaderState, a)
forall {f :: * -&gt; *} {t} {a} {b}.
Functor f =&gt;
(t -&gt; a) -&gt; f (t, b) -&gt; f (a, b)
</span><a href="#local-6989586621683070134"><span class="hs-identifier hs-var">fmapFst</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; Maybe LoaderState
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(IO (LoaderState, a) -&gt; IO (Maybe LoaderState, a))
-&gt; (Maybe LoaderState -&gt; IO (LoaderState, a))
-&gt; Maybe LoaderState
-&gt; IO (Maybe LoaderState, a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; IO (LoaderState, a)
</span><a href="#local-6989586621683070132"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(LoaderState -&gt; IO (LoaderState, a))
-&gt; (Maybe LoaderState -&gt; LoaderState)
-&gt; Maybe LoaderState
-&gt; IO (LoaderState, a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; Maybe LoaderState -&gt; LoaderState
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">LoaderState
forall a. a
</span><a href="GHC.Linker.Loader.html#uninitialised"><span class="hs-identifier hs-var">uninitialised</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621683070134"><span class="annot"><span class="annottext">fmapFst :: (t -&gt; a) -&gt; f (t, b) -&gt; f (a, b)
</span><a href="#local-6989586621683070134"><span class="hs-identifier hs-var hs-var">fmapFst</span></a></span></span><span> </span><span id="local-6989586621683070137"><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621683070137"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((t, b) -&gt; (a, b)) -&gt; f (t, b) -&gt; f (a, b)
forall a b. (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621683070138"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621683070138"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070139"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621683070139"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621683070137"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621683070138"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621683070139"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="annot"><a href="GHC.Linker.Loader.html#getLoaderState"><span class="hs-identifier hs-type">getLoaderState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span id="getLoaderState"><span class="annot"><span class="annottext">getLoaderState :: Interp -&gt; IO (Maybe LoaderState)
</span><a href="GHC.Linker.Loader.html#getLoaderState"><span class="hs-identifier hs-var hs-var">getLoaderState</span></a></span></span><span> </span><span id="local-6989586621683070140"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070140"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar (Maybe LoaderState) -&gt; IO (Maybe LoaderState)
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Loader -&gt; MVar (Maybe LoaderState)
</span><a href="GHC.Linker.Types.html#loader_state"><span class="hs-identifier hs-var">loader_state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Interp -&gt; Loader
</span><a href="GHC.Runtime.Interpreter.Types.html#interpLoader"><span class="hs-identifier hs-var">interpLoader</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070140"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="annot"><a href="GHC.Linker.Loader.html#emptyLoaderState"><span class="hs-identifier hs-type">emptyLoaderState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-163"></span><span id="emptyLoaderState"><span class="annot"><span class="annottext">emptyLoaderState :: LoaderState
</span><a href="GHC.Linker.Loader.html#emptyLoaderState"><span class="hs-identifier hs-var hs-var">emptyLoaderState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-164"></span><span>   </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">linker_env :: LinkerEnv
</span><a href="GHC.Linker.Types.html#linker_env"><span class="hs-identifier hs-var">linker_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LinkerEnv"><span class="hs-identifier hs-type">LinkerEnv</span></a></span><span>
</span><span id="line-165"></span><span>     </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">closure_env :: ClosureEnv
</span><a href="GHC.Linker.Types.html#closure_env"><span class="hs-identifier hs-var">closure_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureEnv
forall a. NameEnv a
</span><a href="GHC.Types.Name.Env.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a></span><span>
</span><span id="line-166"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">itbl_env :: ItblEnv
</span><a href="GHC.Linker.Types.html#itbl_env"><span class="hs-identifier hs-var">itbl_env</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ItblEnv
forall a. NameEnv a
</span><a href="GHC.Types.Name.Env.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a></span><span>
</span><span id="line-167"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">addr_env :: AddrEnv
</span><a href="GHC.Linker.Types.html#addr_env"><span class="hs-identifier hs-var">addr_env</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AddrEnv
forall a. NameEnv a
</span><a href="GHC.Types.Name.Env.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a></span><span>
</span><span id="line-168"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-169"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pkgs_loaded :: PkgsLoaded
</span><a href="GHC.Linker.Types.html#pkgs_loaded"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070151"><span class="hs-identifier hs-var">init_pkgs</span></a></span><span>
</span><span id="line-170"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">bcos_loaded :: LinkableSet
</span><a href="GHC.Linker.Types.html#bcos_loaded"><span class="hs-identifier hs-var">bcos_loaded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkableSet
forall a. ModuleEnv a
</span><a href="GHC.Unit.Module.Env.html#emptyModuleEnv"><span class="hs-identifier hs-var">emptyModuleEnv</span></a></span><span>
</span><span id="line-171"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">objs_loaded :: LinkableSet
</span><a href="GHC.Linker.Types.html#objs_loaded"><span class="hs-identifier hs-var">objs_loaded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkableSet
forall a. ModuleEnv a
</span><a href="GHC.Unit.Module.Env.html#emptyModuleEnv"><span class="hs-identifier hs-var">emptyModuleEnv</span></a></span><span>
</span><span id="line-172"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">temp_sos :: [(String, String)]
</span><a href="GHC.Linker.Types.html#temp_sos"><span class="hs-identifier hs-var">temp_sos</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-173"></span><span>   </span><span class="hs-special">}</span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-comment">-- Packages that don't need loading, because the compiler</span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-comment">-- shares them with the interpreted program.</span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-comment">-- The linker's symbol table is populated with RTS symbols using an</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-comment">-- explicit list.  See rts/Linker.c for details.</span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621683070151"><span class="annot"><span class="annottext">init_pkgs :: PkgsLoaded
</span><a href="#local-6989586621683070151"><span class="hs-identifier hs-var hs-var">init_pkgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnitId -&gt; LoadedPkgInfo -&gt; PkgsLoaded
forall key elt. Uniquable key =&gt; key -&gt; elt -&gt; UniqDFM key elt
</span><a href="GHC.Types.Unique.DFM.html#unitUDFM"><span class="hs-identifier hs-var">unitUDFM</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="GHC.Unit.Types.html#rtsUnitId"><span class="hs-identifier hs-var">rtsUnitId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnitId
-&gt; [LibrarySpec]
-&gt; [LibrarySpec]
-&gt; [RemotePtr LoadedDLL]
-&gt; UniqDSet UnitId
-&gt; LoadedPkgInfo
</span><a href="GHC.Linker.Types.html#LoadedPkgInfo"><span class="hs-identifier hs-var">LoadedPkgInfo</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="GHC.Unit.Types.html#rtsUnitId"><span class="hs-identifier hs-var">rtsUnitId</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">UniqDSet UnitId
forall a. UniqDSet a
</span><a href="GHC.Types.Unique.DSet.html#emptyUniqDSet"><span class="hs-identifier hs-var">emptyUniqDSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span class="annot"><a href="GHC.Linker.Loader.html#extendLoadedEnv"><span class="hs-identifier hs-type">extendLoadedEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span id="extendLoadedEnv"><span class="annot"><span class="annottext">extendLoadedEnv :: Interp -&gt; [(Name, ForeignHValue)] -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#extendLoadedEnv"><span class="hs-identifier hs-var hs-var">extendLoadedEnv</span></a></span></span><span> </span><span id="local-6989586621683070161"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070161"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070162"><span class="annot"><span class="annottext">[(Name, ForeignHValue)]
</span><a href="#local-6989586621683070162"><span class="hs-identifier hs-var">new_bindings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#modifyLoaderState_"><span class="hs-identifier hs-var">modifyLoaderState_</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070161"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">((LoaderState -&gt; IO LoaderState) -&gt; IO ())
-&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070163"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070163"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">LoaderState -&gt; IO LoaderState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LoaderState -&gt; IO LoaderState) -&gt; LoaderState -&gt; IO LoaderState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; (ClosureEnv -&gt; ClosureEnv) -&gt; LoaderState
</span><a href="GHC.Linker.Types.html#modifyClosureEnv"><span class="hs-identifier hs-var">modifyClosureEnv</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070163"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="annot"><span class="annottext">((ClosureEnv -&gt; ClosureEnv) -&gt; LoaderState)
-&gt; (ClosureEnv -&gt; ClosureEnv) -&gt; LoaderState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070166"><span class="annot"><span class="annottext">ClosureEnv
</span><a href="#local-6989586621683070166"><span class="hs-identifier hs-var">ce</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-185"></span><span>      </span><span class="annot"><span class="annottext">ClosureEnv -&gt; [(Name, ForeignHValue)] -&gt; ClosureEnv
</span><a href="GHC.Linker.Types.html#extendClosureEnv"><span class="hs-identifier hs-var">extendClosureEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureEnv
</span><a href="#local-6989586621683070166"><span class="hs-identifier hs-var">ce</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, ForeignHValue)]
</span><a href="#local-6989586621683070162"><span class="hs-identifier hs-var">new_bindings</span></a></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">-- strictness is important for not retaining old copies of the pls</span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="annot"><a href="GHC.Linker.Loader.html#deleteFromLoadedEnv"><span class="hs-identifier hs-type">deleteFromLoadedEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span id="deleteFromLoadedEnv"><span class="annot"><span class="annottext">deleteFromLoadedEnv :: Interp -&gt; [Name] -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#deleteFromLoadedEnv"><span class="hs-identifier hs-var hs-var">deleteFromLoadedEnv</span></a></span></span><span> </span><span id="local-6989586621683070168"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070168"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070169"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683070169"><span class="hs-identifier hs-var">to_remove</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#modifyLoaderState_"><span class="hs-identifier hs-var">modifyLoaderState_</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070168"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">((LoaderState -&gt; IO LoaderState) -&gt; IO ())
-&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070170"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070170"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="annottext">LoaderState -&gt; IO LoaderState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LoaderState -&gt; IO LoaderState) -&gt; LoaderState -&gt; IO LoaderState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; (ClosureEnv -&gt; ClosureEnv) -&gt; LoaderState
</span><a href="GHC.Linker.Types.html#modifyClosureEnv"><span class="hs-identifier hs-var">modifyClosureEnv</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070170"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="annot"><span class="annottext">((ClosureEnv -&gt; ClosureEnv) -&gt; LoaderState)
-&gt; (ClosureEnv -&gt; ClosureEnv) -&gt; LoaderState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070171"><span class="annot"><span class="annottext">ClosureEnv
</span><a href="#local-6989586621683070171"><span class="hs-identifier hs-var">ce</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-192"></span><span>      </span><span class="annot"><span class="annottext">ClosureEnv -&gt; [Name] -&gt; ClosureEnv
forall a. NameEnv a -&gt; [Name] -&gt; NameEnv a
</span><a href="GHC.Types.Name.Env.html#delListFromNameEnv"><span class="hs-identifier hs-var">delListFromNameEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ClosureEnv
</span><a href="#local-6989586621683070171"><span class="hs-identifier hs-var">ce</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683070169"><span class="hs-identifier hs-var">to_remove</span></a></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="hs-comment">-- | Load the module containing the given Name and get its associated 'HValue'.</span><span>
</span><span id="line-195"></span><span class="hs-comment">--</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- Throws a 'ProgramError' if loading fails or the name cannot be found.</span><span>
</span><span id="line-197"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadName"><span class="hs-identifier hs-type">loadName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#PkgsLoaded"><span class="hs-identifier hs-type">PkgsLoaded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span id="loadName"><span class="annot"><span class="annottext">loadName :: Interp
-&gt; HscEnv -&gt; Name -&gt; IO (ForeignHValue, [Linkable], PkgsLoaded)
</span><a href="GHC.Linker.Loader.html#loadName"><span class="hs-identifier hs-var hs-var">loadName</span></a></span></span><span> </span><span id="local-6989586621683070176"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070176"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070177"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070177"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070178"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070178"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier hs-var">initLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070176"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070177"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><span class="annottext">Interp
-&gt; (LoaderState
    -&gt; IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded)))
-&gt; IO (ForeignHValue, [Linkable], PkgsLoaded)
forall a. Interp -&gt; (LoaderState -&gt; IO (LoaderState, a)) -&gt; IO a
</span><a href="GHC.Linker.Loader.html#modifyLoaderState"><span class="hs-identifier hs-var">modifyLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070176"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">((LoaderState
  -&gt; IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded)))
 -&gt; IO (ForeignHValue, [Linkable], PkgsLoaded))
-&gt; (LoaderState
    -&gt; IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded)))
-&gt; IO (ForeignHValue, [Linkable], PkgsLoaded)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070179"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070179"><span class="hs-identifier hs-var">pls0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683070180"><span class="annot"><a href="#local-6989586621683070180"><span class="hs-identifier hs-var">pls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070181"><span class="annot"><a href="#local-6989586621683070181"><span class="hs-identifier hs-var">links</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070182"><span class="annot"><a href="#local-6989586621683070182"><span class="hs-identifier hs-var">pkgs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070178"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>       </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(LoaderState, [Linkable], PkgsLoaded)
-&gt; IO (LoaderState, [Linkable], PkgsLoaded)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070179"><span class="hs-identifier hs-var">pls0</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
forall {k} (key :: k) elt. UniqDFM key elt
</span><a href="GHC.Types.Unique.DFM.html#emptyUDFM"><span class="hs-identifier hs-var">emptyUDFM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>         </span><span class="hs-special">(</span><span id="local-6989586621683070186"><span class="annot"><a href="#local-6989586621683070186"><span class="hs-identifier hs-var">pls'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070187"><span class="annot"><a href="#local-6989586621683070187"><span class="hs-identifier hs-var">ok</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070188"><span class="annot"><a href="#local-6989586621683070188"><span class="hs-identifier hs-var">links</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070189"><span class="annot"><a href="#local-6989586621683070189"><span class="hs-identifier hs-var">pkgs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp
-&gt; HscEnv
-&gt; LoaderState
-&gt; SrcSpan
-&gt; [Module]
-&gt; IO (LoaderState, SuccessFlag, [Linkable], PkgsLoaded)
</span><a href="GHC.Linker.Loader.html#loadDependencies"><span class="hs-identifier hs-var">loadDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070176"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070177"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070179"><span class="hs-identifier hs-var">pls0</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a></span><span>
</span><span id="line-205"></span><span>                                      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070178"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-206"></span><span>         </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#failed"><span class="hs-identifier hs-type">failed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070187"><span class="hs-identifier hs-type">ok</span></a></span><span>
</span><span id="line-207"></span><span>           </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-type">throwGhcExceptionIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Panic.html#ProgramError"><span class="hs-identifier hs-type">ProgramError</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>           </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070186"><span class="hs-identifier hs-type">pls'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070188"><span class="hs-identifier hs-type">links</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070189"><span class="hs-identifier hs-type">pkgs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html#lookupNameEnv"><span class="hs-identifier hs-type">lookupNameEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#closure_env"><span class="hs-identifier hs-var">closure_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#linker_env"><span class="hs-identifier hs-var">linker_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070180"><span class="hs-identifier hs-type">pls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070178"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-211"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621683070196"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683070196"><span class="hs-identifier hs-var">aa</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(LoaderState, (ForeignHValue, [Linkable], PkgsLoaded))
-&gt; IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070180"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621683070196"><span class="hs-identifier hs-var">aa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070181"><span class="hs-identifier hs-var">links</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070182"><span class="hs-identifier hs-var">pkgs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Name, ForeignHValue)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded))
-&gt; IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded))
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070178"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070178"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded))
 -&gt; IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded)))
-&gt; IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded))
-&gt; IO (LoaderState, (ForeignHValue, [Linkable], PkgsLoaded))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-213"></span><span>                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070199"><span class="annot"><span class="annottext">sym_to_find :: FastString
</span><a href="#local-6989586621683070199"><span class="hs-identifier hs-var hs-var hs-var">sym_to_find</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; String -&gt; FastString
</span><a href="GHC.ByteCode.Linker.html#nameToCLabel"><span class="hs-identifier hs-var">nameToCLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070178"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;closure&quot;</span></span><span>
</span><span id="line-214"></span><span>                        </span><span id="local-6989586621683070201"><span class="annot"><a href="#local-6989586621683070201"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; String -&gt; IO (Maybe HValueRef)
</span><a href="GHC.Runtime.Interpreter.html#lookupClosure"><span class="hs-identifier hs-var">lookupClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070176"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; String
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683070199"><span class="hs-identifier hs-var">sym_to_find</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>                        </span><span id="local-6989586621683070204"><span class="annot"><a href="#local-6989586621683070204"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683070201"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-216"></span><span>                          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683070205"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621683070205"><span class="hs-identifier hs-var">hvref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; HValueRef -&gt; IO ForeignHValue
forall a. Interp -&gt; RemoteRef a -&gt; IO (ForeignRef a)
</span><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070176"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621683070205"><span class="hs-identifier hs-var">hvref</span></a></span><span>
</span><span id="line-217"></span><span>                          </span><span class="annot"><span class="annottext">Maybe HValueRef
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; IO ForeignHValue
forall a. String -&gt; String -&gt; IO a
</span><a href="GHC.ByteCode.Linker.html#linkFail"><span class="hs-identifier hs-var">linkFail</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GHC.Linker.Loader.loadName&quot;</span></span><span>
</span><span id="line-218"></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; String
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683070199"><span class="hs-identifier hs-var">sym_to_find</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070180"><span class="hs-identifier hs-type">pls</span></a></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070204"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070181"><span class="hs-identifier hs-type">links</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070182"><span class="hs-identifier hs-type">pkgs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadDependencies"><span class="hs-identifier hs-type">loadDependencies</span></a></span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SuccessFlag"><span class="hs-identifier hs-type">SuccessFlag</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#PkgsLoaded"><span class="hs-identifier hs-type">PkgsLoaded</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ returns the set of linkables required</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- When called, the loader state must have been initialized (see `initLoaderState`)</span><span>
</span><span id="line-229"></span><span id="loadDependencies"><span class="annot"><span class="annottext">loadDependencies :: Interp
-&gt; HscEnv
-&gt; LoaderState
-&gt; SrcSpan
-&gt; [Module]
-&gt; IO (LoaderState, SuccessFlag, [Linkable], PkgsLoaded)
</span><a href="GHC.Linker.Loader.html#loadDependencies"><span class="hs-identifier hs-var hs-var">loadDependencies</span></a></span></span><span> </span><span id="local-6989586621683070208"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070208"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070209"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070209"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070210"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070210"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span id="local-6989586621683070211"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683070211"><span class="hs-identifier hs-var">span</span></a></span></span><span> </span><span id="local-6989586621683070212"><span class="annot"><span class="annottext">[Module]
</span><a href="#local-6989586621683070212"><span class="hs-identifier hs-var">needed_mods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070213"><span class="annot"><span class="annottext">opts :: LinkDepsOpts
</span><a href="#local-6989586621683070213"><span class="hs-identifier hs-var hs-var hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; LinkDepsOpts
</span><a href="GHC.Linker.Loader.html#initLinkDepsOpts"><span class="hs-identifier hs-var">initLinkDepsOpts</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070209"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>   </span><span class="hs-comment">-- Find what packages and linkables are required</span><span>
</span><span id="line-233"></span><span>   </span><span id="local-6989586621683070214"><span class="annot"><a href="#local-6989586621683070214"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LinkDepsOpts
-&gt; Interp -&gt; LoaderState -&gt; SrcSpan -&gt; [Module] -&gt; IO LinkDeps
</span><a href="GHC.Linker.Deps.html#getLinkDeps"><span class="hs-identifier hs-var">getLinkDeps</span></a></span><span> </span><span class="annot"><span class="annottext">LinkDepsOpts
</span><a href="#local-6989586621683070213"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070208"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070210"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683070211"><span class="hs-identifier hs-var">span</span></a></span><span> </span><span class="annot"><span class="annottext">[Module]
</span><a href="#local-6989586621683070212"><span class="hs-identifier hs-var">needed_mods</span></a></span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070216"><span class="annot"><a href="#local-6989586621683070216"><span class="hs-identifier hs-var hs-var">this_pkgs_needed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkDeps -&gt; UniqDSet UnitId
</span><a href="GHC.Linker.Deps.html#ldNeededUnits"><span class="hs-identifier hs-var">ldNeededUnits</span></a></span><span> </span><span class="annot"><span class="annottext">LinkDeps
</span><a href="#local-6989586621683070214"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span>   </span><span class="hs-comment">-- Link the packages and modules required</span><span>
</span><span id="line-238"></span><span>   </span><span id="local-6989586621683070218"><span class="annot"><a href="#local-6989586621683070218"><span class="hs-identifier hs-var">pls1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadPackages%27"><span class="hs-identifier hs-type">loadPackages'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070208"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070209"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Deps.html#ldUnits"><span class="hs-identifier hs-var">ldUnits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070214"><span class="hs-identifier hs-type">deps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070210"><span class="hs-identifier hs-type">pls</span></a></span><span>
</span><span id="line-239"></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621683070221"><span class="annot"><a href="#local-6989586621683070221"><span class="hs-identifier hs-var">pls2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070222"><span class="annot"><a href="#local-6989586621683070222"><span class="hs-identifier hs-var">succ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadModuleLinkables"><span class="hs-identifier hs-type">loadModuleLinkables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070208"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070209"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070218"><span class="hs-identifier hs-type">pls1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Deps.html#ldNeededLinkables"><span class="hs-identifier hs-var">ldNeededLinkables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070214"><span class="hs-identifier hs-type">deps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070225"><span class="annot"><a href="#local-6989586621683070225"><span class="hs-identifier hs-var hs-var">this_pkgs_loaded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PkgsLoaded -&gt; UniqDFM UnitId UnitId -&gt; PkgsLoaded
forall {k} (key :: k) elt elt2.
UniqDFM key elt -&gt; UniqDFM key elt2 -&gt; UniqDFM key elt
</span><a href="GHC.Types.Unique.DFM.html#udfmRestrictKeys"><span class="hs-identifier hs-var">udfmRestrictKeys</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070227"><span class="hs-identifier hs-var">all_pkgs_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqDFM UnitId UnitId -&gt; PkgsLoaded)
-&gt; UniqDFM UnitId UnitId -&gt; PkgsLoaded
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UniqDSet UnitId -&gt; UniqDFM UnitId UnitId
forall a. UniqDSet a -&gt; UniqDFM a a
</span><a href="GHC.Types.Unique.DSet.html#getUniqDSet"><span class="hs-identifier hs-var">getUniqDSet</span></a></span><span> </span><span class="annot"><span class="annottext">UniqDSet UnitId
</span><a href="#local-6989586621683070229"><span class="hs-identifier hs-var">trans_pkgs_needed</span></a></span><span>
</span><span id="line-241"></span><span>       </span><span id="local-6989586621683070227"><span class="annot"><a href="#local-6989586621683070227"><span class="hs-identifier hs-var hs-var">all_pkgs_loaded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; PkgsLoaded
</span><a href="GHC.Linker.Types.html#pkgs_loaded"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070221"><span class="hs-identifier hs-var">pls2</span></a></span><span>
</span><span id="line-242"></span><span>       </span><span id="local-6989586621683070229"><span class="annot"><a href="#local-6989586621683070229"><span class="hs-identifier hs-var hs-var">trans_pkgs_needed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[UniqDSet UnitId] -&gt; UniqDSet UnitId
forall a. [UniqDSet a] -&gt; UniqDSet a
</span><a href="GHC.Types.Unique.DSet.html#unionManyUniqDSets"><span class="hs-identifier hs-var">unionManyUniqDSets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UniqDSet UnitId
</span><a href="#local-6989586621683070216"><span class="hs-identifier hs-var">this_pkgs_needed</span></a></span><span> </span><span class="annot"><span class="annottext">UniqDSet UnitId -&gt; [UniqDSet UnitId] -&gt; [UniqDSet UnitId]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">LoadedPkgInfo -&gt; UniqDSet UnitId
</span><a href="GHC.Linker.Types.html#loaded_pkg_trans_deps"><span class="hs-identifier hs-var">loaded_pkg_trans_deps</span></a></span><span> </span><span class="annot"><span class="annottext">LoadedPkgInfo
</span><a href="#local-6989586621683070232"><span class="hs-identifier hs-var">pkg</span></a></span><span>
</span><span id="line-243"></span><span>                                                                  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683070233"><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070233"><span class="hs-identifier hs-var">pkg_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqDSet UnitId -&gt; [UnitId]
forall a. UniqDSet a -&gt; [a]
</span><a href="GHC.Types.Unique.DSet.html#uniqDSetToList"><span class="hs-identifier hs-var">uniqDSetToList</span></a></span><span> </span><span class="annot"><span class="annottext">UniqDSet UnitId
</span><a href="#local-6989586621683070216"><span class="hs-identifier hs-var">this_pkgs_needed</span></a></span><span>
</span><span id="line-244"></span><span>                                                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683070232"><span class="annot"><span class="annottext">LoadedPkgInfo
</span><a href="#local-6989586621683070232"><span class="hs-identifier hs-var">pkg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PkgsLoaded -&gt; UnitId -&gt; Maybe LoadedPkgInfo
forall key elt.
Uniquable key =&gt;
UniqDFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.DFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070227"><span class="hs-identifier hs-var">all_pkgs_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070233"><span class="hs-identifier hs-var">pkg_id</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-245"></span><span>                                                                  </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>   </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070221"><span class="hs-identifier hs-type">pls2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070222"><span class="hs-identifier hs-type">succ</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Deps.html#ldAllLinkables"><span class="hs-identifier hs-var">ldAllLinkables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070214"><span class="hs-identifier hs-type">deps</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070225"><span class="hs-identifier hs-type">this_pkgs_loaded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="annot"><span class="hs-comment">-- | Temporarily extend the loaded env.</span></span><span>
</span><span id="line-250"></span><span id="local-6989586621683069482"><span id="local-6989586621683069484"><span class="annot"><a href="GHC.Linker.Loader.html#withExtendedLoadedEnv"><span class="hs-identifier hs-type">withExtendedLoadedEnv</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Exception.html#ExceptionMonad"><span class="hs-identifier hs-type">ExceptionMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683069482"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683069482"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683069484"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621683069482"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683069484"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-256"></span><span id="withExtendedLoadedEnv"><span class="annot"><span class="annottext">withExtendedLoadedEnv :: forall (m :: * -&gt; *) a.
ExceptionMonad m =&gt;
Interp -&gt; [(Name, ForeignHValue)] -&gt; m a -&gt; m a
</span><a href="GHC.Linker.Loader.html#withExtendedLoadedEnv"><span class="hs-identifier hs-var hs-var">withExtendedLoadedEnv</span></a></span></span><span> </span><span id="local-6989586621683070245"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070245"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070246"><span class="annot"><span class="annottext">[(Name, ForeignHValue)]
</span><a href="#local-6989586621683070246"><span class="hs-identifier hs-var">new_env</span></a></span></span><span> </span><span id="local-6989586621683070247"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621683070247"><span class="hs-identifier hs-var">action</span></a></span></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; (() -&gt; m ()) -&gt; (() -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) a c b.
(HasCallStack, MonadMask m) =&gt;
m a -&gt; (a -&gt; m c) -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html#bracket"><span class="hs-identifier hs-var">MC.bracket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Interp -&gt; [(Name, ForeignHValue)] -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#extendLoadedEnv"><span class="hs-identifier hs-var">extendLoadedEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070245"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, ForeignHValue)]
</span><a href="#local-6989586621683070246"><span class="hs-identifier hs-var">new_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>               </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621683070250"><span class="hs-identifier hs-var">reset_old_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>               </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621683070247"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-261"></span><span>        </span><span class="hs-comment">-- Remember that the linker state might be side-effected</span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-comment">-- during the execution of the IO action, and we don't want to</span><span>
</span><span id="line-263"></span><span>        </span><span class="hs-comment">-- lose those changes (we might have linked a new module or</span><span>
</span><span id="line-264"></span><span>        </span><span class="hs-comment">-- package), so the reset action only removes the names we</span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-comment">-- added earlier.</span><span>
</span><span id="line-266"></span><span>          </span><span id="local-6989586621683070250"><span class="annot"><span class="annottext">reset_old_env :: m ()
</span><a href="#local-6989586621683070250"><span class="hs-identifier hs-var hs-var">reset_old_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-267"></span><span>            </span><span class="annot"><span class="annottext">Interp -&gt; [Name] -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#deleteFromLoadedEnv"><span class="hs-identifier hs-var">deleteFromLoadedEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070245"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, ForeignHValue) -&gt; Name)
-&gt; [(Name, ForeignHValue)] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, ForeignHValue) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, ForeignHValue)]
</span><a href="#local-6989586621683070246"><span class="hs-identifier hs-var">new_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="annot"><span class="hs-comment">-- | Display the loader state.</span></span><span>
</span><span id="line-271"></span><span class="annot"><a href="GHC.Linker.Loader.html#showLoaderState"><span class="hs-identifier hs-type">showLoaderState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-272"></span><span id="showLoaderState"><span class="annot"><span class="annottext">showLoaderState :: Interp -&gt; IO SDoc
</span><a href="GHC.Linker.Loader.html#showLoaderState"><span class="hs-identifier hs-var hs-var">showLoaderState</span></a></span></span><span> </span><span id="local-6989586621683070252"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070252"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>  </span><span id="local-6989586621683070253"><span class="annot"><a href="#local-6989586621683070253"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (Maybe LoaderState) -&gt; IO (Maybe LoaderState)
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Loader -&gt; MVar (Maybe LoaderState)
</span><a href="GHC.Linker.Types.html#loader_state"><span class="hs-identifier hs-var">loader_state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Interp -&gt; Loader
</span><a href="GHC.Runtime.Interpreter.Types.html#interpLoader"><span class="hs-identifier hs-var">interpLoader</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070252"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070254"><span class="annot"><a href="#local-6989586621683070254"><span class="hs-identifier hs-var hs-var">docs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe LoaderState
</span><a href="#local-6989586621683070253"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><span class="annottext">Maybe LoaderState
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Loader not initialised&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-276"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683070256"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070256"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Pkgs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[UnitId] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LoadedPkgInfo -&gt; UnitId) -&gt; [LoadedPkgInfo] -&gt; [UnitId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LoadedPkgInfo -&gt; UnitId
</span><a href="GHC.Linker.Types.html#loaded_pkg_uid"><span class="hs-identifier hs-var">loaded_pkg_uid</span></a></span><span> </span><span class="annot"><span class="annottext">([LoadedPkgInfo] -&gt; [UnitId]) -&gt; [LoadedPkgInfo] -&gt; [UnitId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded -&gt; [LoadedPkgInfo]
forall {k} (key :: k) elt. UniqDFM key elt -&gt; [elt]
</span><a href="GHC.Types.Unique.DFM.html#eltsUDFM"><span class="hs-identifier hs-var">eltsUDFM</span></a></span><span> </span><span class="annot"><span class="annottext">(PkgsLoaded -&gt; [LoadedPkgInfo]) -&gt; PkgsLoaded -&gt; [LoadedPkgInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; PkgsLoaded
</span><a href="GHC.Linker.Types.html#pkgs_loaded"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070256"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Objs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkableSet -&gt; [Linkable]
forall a. ModuleEnv a -&gt; [a]
</span><a href="GHC.Unit.Module.Env.html#moduleEnvElts"><span class="hs-identifier hs-var">moduleEnvElts</span></a></span><span> </span><span class="annot"><span class="annottext">(LinkableSet -&gt; [Linkable]) -&gt; LinkableSet -&gt; [Linkable]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; LinkableSet
</span><a href="GHC.Linker.Types.html#objs_loaded"><span class="hs-identifier hs-var">objs_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070256"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BCOs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkableSet -&gt; [Linkable]
forall a. ModuleEnv a -&gt; [a]
</span><a href="GHC.Unit.Module.Env.html#moduleEnvElts"><span class="hs-identifier hs-var">moduleEnvElts</span></a></span><span> </span><span class="annot"><span class="annottext">(LinkableSet -&gt; [Linkable]) -&gt; LinkableSet -&gt; [Linkable]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; LinkableSet
</span><a href="GHC.Linker.Types.html#bcos_loaded"><span class="hs-identifier hs-var">bcos_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070256"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>                    </span><span class="hs-special">]</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#withPprStyle"><span class="hs-identifier hs-type">withPprStyle</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#defaultDumpStyle"><span class="hs-identifier hs-type">defaultDumpStyle</span></a></span><span>
</span><span id="line-282"></span><span>         </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;----- Loader state -----&quot;</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621683070254"><span class="hs-identifier hs-type">docs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="annot"><span class="hs-comment">{- **********************************************************************

                        Initialisation

  ********************************************************************* -}</span></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- | Initialise the dynamic linker.  This entails</span><span>
</span><span id="line-292"></span><span class="hs-comment">--</span><span>
</span><span id="line-293"></span><span class="hs-comment">--  a) Calling the C initialisation procedure,</span><span>
</span><span id="line-294"></span><span class="hs-comment">--</span><span>
</span><span id="line-295"></span><span class="hs-comment">--  b) Loading any packages specified on the command line,</span><span>
</span><span id="line-296"></span><span class="hs-comment">--</span><span>
</span><span id="line-297"></span><span class="hs-comment">--  c) Loading any packages specified on the command line, now held in the</span><span>
</span><span id="line-298"></span><span class="hs-comment">--     @-l@ options in @v_Opt_l@,</span><span>
</span><span id="line-299"></span><span class="hs-comment">--</span><span>
</span><span id="line-300"></span><span class="hs-comment">--  d) Loading any @.o\/.dll@ files specified on the command line, now held</span><span>
</span><span id="line-301"></span><span class="hs-comment">--     in @ldInputs@,</span><span>
</span><span id="line-302"></span><span class="hs-comment">--</span><span>
</span><span id="line-303"></span><span class="hs-comment">--  e) Loading any MacOS frameworks.</span><span>
</span><span id="line-304"></span><span class="hs-comment">--</span><span>
</span><span id="line-305"></span><span class="hs-comment">-- NOTE: This function is idempotent; if called more than once, it does</span><span>
</span><span id="line-306"></span><span class="hs-comment">-- nothing.  This is useful in Template Haskell, where we call it before</span><span>
</span><span id="line-307"></span><span class="hs-comment">-- trying to link.</span><span>
</span><span id="line-308"></span><span class="hs-comment">--</span><span>
</span><span id="line-309"></span><span class="annot"><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier hs-type">initLoaderState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span id="initLoaderState"><span class="annot"><span class="annottext">initLoaderState :: Interp -&gt; HscEnv -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier hs-var hs-var">initLoaderState</span></a></span></span><span> </span><span id="local-6989586621683070264"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070264"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070265"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070265"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><span class="annottext">MVar (Maybe LoaderState)
-&gt; (Maybe LoaderState -&gt; IO (Maybe LoaderState)) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyMVar_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Loader -&gt; MVar (Maybe LoaderState)
</span><a href="GHC.Linker.Types.html#loader_state"><span class="hs-identifier hs-var">loader_state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Interp -&gt; Loader
</span><a href="GHC.Runtime.Interpreter.Types.html#interpLoader"><span class="hs-identifier hs-var">interpLoader</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070264"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Maybe LoaderState -&gt; IO (Maybe LoaderState)) -&gt; IO ())
-&gt; (Maybe LoaderState -&gt; IO (Maybe LoaderState)) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070266"><span class="annot"><span class="annottext">Maybe LoaderState
</span><a href="#local-6989586621683070266"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe LoaderState
</span><a href="#local-6989586621683070266"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span>  </span><span class="annot"><span class="annottext">LoaderState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LoaderState -&gt; IO (Maybe LoaderState)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe LoaderState
</span><a href="#local-6989586621683070266"><span class="hs-identifier hs-var">pls</span></a></span><span>
</span><span id="line-314"></span><span>      </span><span class="annot"><span class="annottext">Maybe LoaderState
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; Maybe LoaderState
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(LoaderState -&gt; Maybe LoaderState)
-&gt; IO LoaderState -&gt; IO (Maybe LoaderState)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#reallyInitLoaderState"><span class="hs-identifier hs-var">reallyInitLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070264"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070265"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span class="annot"><a href="GHC.Linker.Loader.html#reallyInitLoaderState"><span class="hs-identifier hs-type">reallyInitLoaderState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-317"></span><span id="reallyInitLoaderState"><span class="annot"><span class="annottext">reallyInitLoaderState :: Interp -&gt; HscEnv -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#reallyInitLoaderState"><span class="hs-identifier hs-var hs-var">reallyInitLoaderState</span></a></span></span><span> </span><span id="local-6989586621683070269"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070269"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070270"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070270"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-comment">-- Initialise the linker state</span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070271"><span class="annot"><span class="annottext">pls0 :: LoaderState
</span><a href="#local-6989586621683070271"><span class="hs-identifier hs-var hs-var">pls0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="GHC.Linker.Loader.html#emptyLoaderState"><span class="hs-identifier hs-var">emptyLoaderState</span></a></span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Arch
</span><a href="GHC.Platform.html#platformArch"><span class="hs-identifier hs-var">platformArch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; Platform
</span><a href="GHC.Driver.DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070270"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-comment">-- FIXME: we don't initialize anything with the JS interpreter.</span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-comment">-- Perhaps we should load preload packages. We'll load them on demand</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-comment">-- anyway.</span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchJavaScript</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; IO LoaderState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070271"><span class="hs-identifier hs-var">pls0</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>      </span><span class="hs-comment">-- (a) initialise the C dynamic linker</span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="annottext">Interp -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#initObjLinker"><span class="hs-identifier hs-var">initObjLinker</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070269"><span class="hs-identifier hs-var">interp</span></a></span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>      </span><span class="hs-comment">-- (b) Load packages from the command-line (Note [preload packages])</span><span>
</span><span id="line-333"></span><span>      </span><span id="local-6989586621683070277"><span class="annot"><a href="#local-6989586621683070277"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IO LoaderState -&gt; UnitId -&gt; HomeUnitEnv -&gt; IO LoaderState)
-&gt; IO LoaderState -&gt; UnitEnvGraph HomeUnitEnv -&gt; IO LoaderState
forall b a. (b -&gt; UnitId -&gt; a -&gt; b) -&gt; b -&gt; UnitEnvGraph a -&gt; b
</span><a href="GHC.Unit.Env.html#unitEnv_foldWithKey"><span class="hs-identifier hs-var">unitEnv_foldWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683070279"><span class="annot"><span class="annottext">IO LoaderState
</span><a href="#local-6989586621683070279"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621683070280"><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070280"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621683070281"><span class="annot"><span class="annottext">HomeUnitEnv
</span><a href="#local-6989586621683070281"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO LoaderState
</span><a href="#local-6989586621683070279"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">IO LoaderState -&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO LoaderState
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070282"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070282"><span class="hs-identifier hs-var">pls'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; [UnitId] -&gt; LoaderState -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#loadPackages%27"><span class="hs-identifier hs-var">loadPackages'</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070269"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; UnitId -&gt; HscEnv -&gt; HscEnv
UnitId -&gt; HscEnv -&gt; HscEnv
</span><a href="GHC.Driver.Env.html#hscSetActiveUnitId"><span class="hs-identifier hs-var">hscSetActiveUnitId</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070280"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070270"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnitState -&gt; [UnitId]
</span><a href="GHC.Unit.State.html#preloadUnits"><span class="hs-identifier hs-var">preloadUnits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HomeUnitEnv -&gt; UnitState
</span><a href="GHC.Unit.Env.html#homeUnitEnv_units"><span class="hs-identifier hs-var">homeUnitEnv_units</span></a></span><span> </span><span class="annot"><span class="annottext">HomeUnitEnv
</span><a href="#local-6989586621683070281"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070282"><span class="hs-identifier hs-var">pls'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoaderState -&gt; IO LoaderState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070271"><span class="hs-identifier hs-var">pls0</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; UnitEnvGraph HomeUnitEnv
</span><a href="GHC.Driver.Env.html#hsc_HUG"><span class="hs-identifier hs-var">hsc_HUG</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070270"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>      </span><span class="hs-comment">-- steps (c), (d) and (e)</span><span>
</span><span id="line-336"></span><span>      </span><span class="annot"><a href="GHC.Linker.Loader.html#loadCmdLineLibs%27"><span class="hs-identifier hs-type">loadCmdLineLibs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070269"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070270"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070277"><span class="hs-identifier hs-type">pls</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadCmdLineLibs"><span class="hs-identifier hs-type">loadCmdLineLibs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span id="loadCmdLineLibs"><span class="annot"><span class="annottext">loadCmdLineLibs :: Interp -&gt; HscEnv -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#loadCmdLineLibs"><span class="hs-identifier hs-var hs-var">loadCmdLineLibs</span></a></span></span><span> </span><span id="local-6989586621683070288"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070288"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070289"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070289"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier hs-var">initLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070288"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070289"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#modifyLoaderState_"><span class="hs-identifier hs-var">modifyLoaderState_</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070288"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">((LoaderState -&gt; IO LoaderState) -&gt; IO ())
-&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070290"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070290"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; LoaderState -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#loadCmdLineLibs%27"><span class="hs-identifier hs-var">loadCmdLineLibs'</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070288"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070289"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070290"><span class="hs-identifier hs-var">pls</span></a></span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadCmdLineLibs%27"><span class="hs-identifier hs-type">loadCmdLineLibs'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-347"></span><span id="loadCmdLineLibs%27"><span class="annot"><span class="annottext">loadCmdLineLibs' :: Interp -&gt; HscEnv -&gt; LoaderState -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#loadCmdLineLibs%27"><span class="hs-identifier hs-var hs-var">loadCmdLineLibs'</span></a></span></span><span> </span><span id="local-6989586621683070291"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070291"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070292"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070292"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070293"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070293"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Set UnitId, LoaderState) -&gt; LoaderState
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Set UnitId, LoaderState) -&gt; LoaderState)
-&gt; IO (Set UnitId, LoaderState) -&gt; IO LoaderState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>
</span><span id="line-348"></span><span>    </span><span class="annot"><span class="annottext">((Set UnitId, LoaderState)
 -&gt; UnitId -&gt; IO (Set UnitId, LoaderState))
-&gt; (Set UnitId, LoaderState)
-&gt; Set UnitId
-&gt; IO (Set UnitId, LoaderState)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span>
</span><span id="line-349"></span><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621683070296"><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621683070296"><span class="hs-identifier hs-var">done'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070297"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070297"><span class="hs-identifier hs-var">pls'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683070298"><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070298"><span class="hs-identifier hs-var">cur_uid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><span class="annottext">Set UnitId -&gt; UnitId -&gt; LoaderState -&gt; IO (Set UnitId, LoaderState)
</span><a href="#local-6989586621683070299"><span class="hs-identifier hs-var">load</span></a></span><span> </span><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621683070296"><span class="hs-identifier hs-var">done'</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070298"><span class="hs-identifier hs-var">cur_uid</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070297"><span class="hs-identifier hs-var">pls'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set UnitId
forall a. Set a
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070293"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; Set UnitId
</span><a href="GHC.Driver.Env.html#hsc_all_home_unit_ids"><span class="hs-identifier hs-var">hsc_all_home_unit_ids</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070292"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><a href="#local-6989586621683070299"><span class="hs-identifier hs-type">load</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set.Set</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set.Set</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>    </span><span id="local-6989586621683070299"><span class="annot"><span class="annottext">load :: Set UnitId -&gt; UnitId -&gt; LoaderState -&gt; IO (Set UnitId, LoaderState)
</span><a href="#local-6989586621683070299"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span> </span><span id="local-6989586621683070302"><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621683070302"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span id="local-6989586621683070303"><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070303"><span class="hs-identifier hs-var">uid</span></a></span></span><span> </span><span id="local-6989586621683070304"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070304"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070303"><span class="hs-identifier hs-var">uid</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId -&gt; Set UnitId -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#member"><span class="hs-operator hs-var">`Set.member`</span></a></span><span> </span><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621683070302"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Set UnitId, LoaderState) -&gt; IO (Set UnitId, LoaderState)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621683070302"><span class="hs-identifier hs-var">done</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070304"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>    </span><span class="annot"><a href="#local-6989586621683070299"><span class="hs-identifier hs-var">load</span></a></span><span> </span><span id="local-6989586621683070306"><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621683070306"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span id="local-6989586621683070307"><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070307"><span class="hs-identifier hs-var">uid</span></a></span></span><span> </span><span id="local-6989586621683070308"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070308"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070309"><span class="annot"><span class="annottext">hsc' :: HscEnv
</span><a href="#local-6989586621683070309"><span class="hs-identifier hs-var hs-var hs-var">hsc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; UnitId -&gt; HscEnv -&gt; HscEnv
UnitId -&gt; HscEnv -&gt; HscEnv
</span><a href="GHC.Driver.Env.html#hscSetActiveUnitId"><span class="hs-identifier hs-var">hscSetActiveUnitId</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070307"><span class="hs-identifier hs-var">uid</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070292"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-358"></span><span>      </span><span class="hs-comment">-- Load potential dependencies first</span><span>
</span><span id="line-359"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683070310"><span class="annot"><a href="#local-6989586621683070310"><span class="hs-identifier hs-var">done'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070311"><span class="annot"><a href="#local-6989586621683070311"><span class="hs-identifier hs-var">pls'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Set UnitId, LoaderState)
 -&gt; UnitId -&gt; IO (Set UnitId, LoaderState))
-&gt; (Set UnitId, LoaderState)
-&gt; [UnitId]
-&gt; IO (Set UnitId, LoaderState)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621683070312"><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621683070312"><span class="hs-identifier hs-var">done'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070313"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070313"><span class="hs-identifier hs-var">pls'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683070314"><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070314"><span class="hs-identifier hs-var">uid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set UnitId -&gt; UnitId -&gt; LoaderState -&gt; IO (Set UnitId, LoaderState)
</span><a href="#local-6989586621683070299"><span class="hs-identifier hs-var">load</span></a></span><span> </span><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621683070312"><span class="hs-identifier hs-var">done'</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070314"><span class="hs-identifier hs-var">uid</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070313"><span class="hs-identifier hs-var">pls'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621683070306"><span class="hs-identifier hs-var">done</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070308"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnitState -&gt; [UnitId]
</span><a href="GHC.Unit.State.html#homeUnitDepends"><span class="hs-identifier hs-var">homeUnitDepends</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; HscEnv -&gt; UnitState
HscEnv -&gt; UnitState
</span><a href="GHC.Driver.Env.html#hsc_units"><span class="hs-identifier hs-var">hsc_units</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070309"><span class="hs-identifier hs-var">hsc'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>      </span><span id="local-6989586621683070317"><span class="annot"><a href="#local-6989586621683070317"><span class="hs-identifier hs-var">pls''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadCmdLineLibs%27%27"><span class="hs-identifier hs-type">loadCmdLineLibs''</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070291"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070309"><span class="hs-identifier hs-type">hsc'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070311"><span class="hs-identifier hs-type">pls'</span></a></span><span>
</span><span id="line-362"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#insert"><span class="hs-identifier hs-type">Set.insert</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070307"><span class="hs-identifier hs-type">uid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070310"><span class="hs-identifier hs-type">done'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070317"><span class="hs-identifier hs-type">pls''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadCmdLineLibs%27%27"><span class="hs-identifier hs-type">loadCmdLineLibs''</span></a></span><span>
</span><span id="line-365"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-366"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-369"></span><span id="loadCmdLineLibs%27%27"><span class="annot"><span class="annottext">loadCmdLineLibs'' :: Interp -&gt; HscEnv -&gt; LoaderState -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#loadCmdLineLibs%27%27"><span class="hs-identifier hs-var hs-var">loadCmdLineLibs''</span></a></span></span><span> </span><span id="local-6989586621683070320"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070320"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070321"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070321"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070322"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070322"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070323"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621683070323"><span class="hs-identifier hs-var hs-var">dflags</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ldInputs :: DynFlags -&gt; [Option]
</span><a href="GHC.Driver.DynFlags.html#ldInputs"><span class="hs-identifier hs-var">ldInputs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683070326"><span class="annot"><span class="annottext">[Option]
</span><a href="#local-6989586621683070326"><span class="hs-identifier hs-var hs-var">cmdline_ld_inputs</span></a></span></span><span>
</span><span id="line-373"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">libraryPaths :: DynFlags -&gt; [String]
</span><a href="GHC.Driver.DynFlags.html#libraryPaths"><span class="hs-identifier hs-var">libraryPaths</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683070328"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070328"><span class="hs-identifier hs-var hs-var">lib_paths_base</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070321"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-375"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070329"><span class="annot"><span class="annottext">logger :: Logger
</span><a href="#local-6989586621683070329"><span class="hs-identifier hs-var hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070321"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>      </span><span class="hs-comment">-- (c) Link libraries from the command-line</span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070331"><span class="annot"><span class="annottext">minus_ls_1 :: [String]
</span><a href="#local-6989586621683070331"><span class="hs-identifier hs-var hs-var hs-var">minus_ls_1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070332"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'-'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'l'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683070332"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070332"><span class="hs-identifier hs-var">lib</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Option]
</span><a href="#local-6989586621683070326"><span class="hs-identifier hs-var">cmdline_ld_inputs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>      </span><span class="hs-comment">-- On Windows we want to add libpthread by default just as GCC would.</span><span>
</span><span id="line-381"></span><span>      </span><span class="hs-comment">-- However because we don't know the actual name of pthread's dll we</span><span>
</span><span id="line-382"></span><span>      </span><span class="hs-comment">-- need to defer this to the locateLib call so we can't initialize it</span><span>
</span><span id="line-383"></span><span>      </span><span class="hs-comment">-- inside of the rts. Instead we do it here to be able to find the</span><span>
</span><span id="line-384"></span><span>      </span><span class="hs-comment">-- import library for pthreads. See #13210.</span><span>
</span><span id="line-385"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070334"><span class="annot"><span class="annottext">platform :: Platform
</span><a href="#local-6989586621683070334"><span class="hs-identifier hs-var hs-var hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Platform
</span><a href="GHC.Driver.DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070323"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-386"></span><span>          </span><span id="local-6989586621683070335"><span class="annot"><span class="annottext">os :: OS
</span><a href="#local-6989586621683070335"><span class="hs-identifier hs-var hs-var hs-var">os</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; OS
</span><a href="GHC.Platform.html#platformOS"><span class="hs-identifier hs-var">platformOS</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070334"><span class="hs-identifier hs-var">platform</span></a></span><span>
</span><span id="line-387"></span><span>          </span><span id="local-6989586621683070337"><span class="annot"><span class="annottext">minus_ls :: [String]
</span><a href="#local-6989586621683070337"><span class="hs-identifier hs-var hs-var hs-var">minus_ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OS
</span><a href="#local-6989586621683070335"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-388"></span><span>                       </span><span class="annot"><span class="annottext">OS
</span><span class="hs-identifier hs-var">OSMinGW32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pthread&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; [String]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070331"><span class="hs-identifier hs-var">minus_ls_1</span></a></span><span>
</span><span id="line-389"></span><span>                       </span><span class="annot"><span class="annottext">OS
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070331"><span class="hs-identifier hs-var">minus_ls_1</span></a></span><span>
</span><span id="line-390"></span><span>      </span><span class="hs-comment">-- See Note [Fork/Exec Windows]</span><span>
</span><span id="line-391"></span><span>      </span><span id="local-6989586621683070339"><span class="annot"><a href="#local-6989586621683070339"><span class="hs-identifier hs-var">gcc_paths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DynFlags -&gt; OS -&gt; IO [String]
</span><a href="GHC.Linker.Loader.html#getGCCPaths"><span class="hs-identifier hs-var">getGCCPaths</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070329"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070323"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">OS
</span><a href="#local-6989586621683070335"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>      </span><span id="local-6989586621683070341"><span class="annot"><a href="#local-6989586621683070341"><span class="hs-identifier hs-var">lib_paths_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#addEnvPaths"><span class="hs-identifier hs-type">addEnvPaths</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;LIBRARY_PATH&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621683070328"><span class="hs-identifier hs-type">lib_paths_base</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>      </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-type">maybePutStrLn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070329"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Search directories (user):&quot;</span></span><span>
</span><span id="line-396"></span><span>      </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStr"><span class="hs-identifier hs-type">maybePutStr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070329"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">unlines</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;  &quot;</span></span><span class="annot"><span class="hs-operator">++</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070341"><span class="hs-identifier hs-type">lib_paths_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>      </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-type">maybePutStrLn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070329"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Search directories (gcc):&quot;</span></span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStr"><span class="hs-identifier hs-type">maybePutStr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070329"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">unlines</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;  &quot;</span></span><span class="annot"><span class="hs-operator">++</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070339"><span class="hs-identifier hs-type">gcc_paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>      </span><span id="local-6989586621683070346"><span class="annot"><a href="#local-6989586621683070346"><span class="hs-identifier hs-var">libspecs</span></a></span></span><span>
</span><span id="line-401"></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Loader.html#locateLib"><span class="hs-identifier hs-type">locateLib</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070320"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070321"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621683070341"><span class="hs-identifier hs-type">lib_paths_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070339"><span class="hs-identifier hs-type">gcc_paths</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070337"><span class="hs-identifier hs-type">minus_ls</span></a></span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span>      </span><span class="hs-comment">-- (d) Link .o files from the command-line</span><span>
</span><span id="line-404"></span><span>      </span><span id="local-6989586621683070349"><span class="annot"><a href="#local-6989586621683070349"><span class="hs-identifier hs-var">classified_ld_inputs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Loader.html#classifyLdInput"><span class="hs-identifier hs-type">classifyLdInput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070329"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070334"><span class="hs-identifier hs-type">platform</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>                                </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="#local-6989586621683070351"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Utils.CliOption.html#FileOption"><span class="hs-identifier hs-type">FileOption</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683070351"><span class="annot"><a href="#local-6989586621683070351"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621683070326"><span class="hs-identifier hs-type">cmdline_ld_inputs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-comment">-- (e) Link any MacOS frameworks</span><span>
</span><span id="line-408"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070353"><span class="annot"><a href="#local-6989586621683070353"><span class="hs-identifier hs-var hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Platform
</span><a href="GHC.Driver.DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070323"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-409"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683070354"><span class="annot"><a href="#local-6989586621683070354"><span class="hs-identifier hs-var">framework_paths</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070355"><span class="annot"><a href="#local-6989586621683070355"><span class="hs-identifier hs-var">frameworks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-410"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Platform.html#platformUsesFrameworks"><span class="hs-identifier hs-type">platformUsesFrameworks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070353"><span class="hs-identifier hs-type">platform</span></a></span><span>
</span><span id="line-411"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.DynFlags.html#frameworkPaths"><span class="hs-identifier hs-var">frameworkPaths</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070323"><span class="hs-identifier hs-type">dflags</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#cmdlineFrameworks"><span class="hs-identifier hs-var">cmdlineFrameworks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070323"><span class="hs-identifier hs-type">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-comment">-- Finally do (c),(d),(e)</span><span>
</span><span id="line-415"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070359"><span class="annot"><a href="#local-6989586621683070359"><span class="hs-identifier hs-var hs-var">cmdline_lib_specs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe LibrarySpec] -&gt; [LibrarySpec]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe LibrarySpec]
</span><a href="#local-6989586621683070349"><span class="hs-identifier hs-var">classified_ld_inputs</span></a></span><span>
</span><span id="line-416"></span><span>                           </span><span class="annot"><span class="annottext">[LibrarySpec] -&gt; [LibrarySpec] -&gt; [LibrarySpec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070346"><span class="hs-identifier hs-var">libspecs</span></a></span><span>
</span><span id="line-417"></span><span>                           </span><span class="annot"><span class="annottext">[LibrarySpec] -&gt; [LibrarySpec] -&gt; [LibrarySpec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; [String] -&gt; [LibrarySpec]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#Framework"><span class="hs-identifier hs-var">Framework</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070355"><span class="hs-identifier hs-var">frameworks</span></a></span><span>
</span><span id="line-418"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683070359"><span class="hs-identifier hs-type">cmdline_lib_specs</span></a></span><span>
</span><span id="line-419"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683070322"><span class="hs-identifier hs-type">pls</span></a></span><span>
</span><span id="line-420"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-421"></span><span>           </span><span class="hs-comment">-- Add directories to library search paths, this only has an effect</span><span>
</span><span id="line-422"></span><span>           </span><span class="hs-comment">-- on Windows. On Unix OSes this function is a NOP.</span><span>
</span><span id="line-423"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070363"><span class="annot"><a href="#local-6989586621683070363"><span class="hs-identifier hs-var hs-var">all_paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070364"><span class="annot"><span class="annottext">paths :: [String]
</span><a href="#local-6989586621683070364"><span class="hs-identifier hs-var hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#takeDirectory"><span class="hs-identifier hs-var">takeDirectory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; String
</span><a href="GHC.Driver.Session.html#pgm_c"><span class="hs-identifier hs-var">pgm_c</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070323"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>                                     </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; [String]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070354"><span class="hs-identifier hs-var">framework_paths</span></a></span><span>
</span><span id="line-425"></span><span>                                    </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070328"><span class="hs-identifier hs-var">lib_paths_base</span></a></span><span>
</span><span id="line-426"></span><span>                                    </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#takeDirectory"><span class="hs-identifier hs-var">takeDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070367"><span class="hs-identifier hs-var">dll</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-type">DLLPath</span></a></span><span> </span><span id="local-6989586621683070367"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070367"><span class="hs-identifier hs-var">dll</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070346"><span class="hs-identifier hs-var">libspecs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-427"></span><span>                           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String]
forall a. Eq a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">nub</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; [String]) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#normalise"><span class="hs-identifier hs-var">normalise</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070364"><span class="hs-identifier hs-var">paths</span></a></span><span>
</span><span id="line-428"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070370"><span class="annot"><a href="#local-6989586621683070370"><span class="hs-identifier hs-var hs-var">lib_paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String]
forall a. Eq a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">nub</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; [String]) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070328"><span class="hs-identifier hs-var">lib_paths_base</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070339"><span class="hs-identifier hs-var">gcc_paths</span></a></span><span>
</span><span id="line-429"></span><span>           </span><span id="local-6989586621683070371"><span class="annot"><a href="#local-6989586621683070371"><span class="hs-identifier hs-var">all_paths_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#addEnvPaths"><span class="hs-identifier hs-type">addEnvPaths</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;LD_LIBRARY_PATH&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621683070363"><span class="hs-identifier hs-type">all_paths</span></a></span><span>
</span><span id="line-430"></span><span>           </span><span id="local-6989586621683070372"><span class="annot"><a href="#local-6989586621683070372"><span class="hs-identifier hs-var">pathCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.html#addLibrarySearchPath"><span class="hs-identifier hs-type">addLibrarySearchPath</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070320"><span class="hs-identifier hs-type">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070371"><span class="hs-identifier hs-type">all_paths_env</span></a></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070374"><span class="annot"><a href="#local-6989586621683070374"><span class="hs-identifier hs-var hs-var">merged_specs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec] -&gt; [LibrarySpec]
</span><a href="GHC.Linker.Loader.html#mergeStaticObjects"><span class="hs-identifier hs-var">mergeStaticObjects</span></a></span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070359"><span class="hs-identifier hs-var">cmdline_lib_specs</span></a></span><span>
</span><span id="line-433"></span><span>           </span><span id="local-6989586621683070376"><span class="annot"><a href="#local-6989586621683070376"><span class="hs-identifier hs-var">pls1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">foldM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Loader.html#preloadLib"><span class="hs-identifier hs-type">preloadLib</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070320"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070321"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070370"><span class="hs-identifier hs-type">lib_paths</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070354"><span class="hs-identifier hs-type">framework_paths</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070322"><span class="hs-identifier hs-type">pls</span></a></span><span>
</span><span id="line-434"></span><span>                         </span><span class="annot"><a href="#local-6989586621683070374"><span class="hs-identifier hs-type">merged_specs</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>           </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStr"><span class="hs-identifier hs-type">maybePutStr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070329"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;final link ... &quot;</span></span><span>
</span><span id="line-437"></span><span>           </span><span id="local-6989586621683070378"><span class="annot"><a href="#local-6989586621683070378"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#resolveObjs"><span class="hs-identifier hs-type">resolveObjs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070320"><span class="hs-identifier hs-type">interp</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>           </span><span class="hs-comment">-- DLLs are loaded, reset the search paths</span><span>
</span><span id="line-440"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.html#removeLibrarySearchPath"><span class="hs-identifier hs-type">removeLibrarySearchPath</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070320"><span class="hs-identifier hs-type">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="annot"><a href="#local-6989586621683070372"><span class="hs-identifier hs-type">pathCache</span></a></span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>           </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#succeeded"><span class="hs-identifier hs-type">succeeded</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070378"><span class="hs-identifier hs-type">ok</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-type">maybePutStrLn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070329"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;done&quot;</span></span><span>
</span><span id="line-443"></span><span>           </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-type">throwGhcExceptionIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Panic.html#ProgramError"><span class="hs-identifier hs-type">ProgramError</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;linking extra libraries/objects failed&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683070376"><span class="hs-identifier hs-type">pls1</span></a></span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span class="hs-comment">-- | Merge runs of consecutive of 'Objects'. This allows for resolution of</span><span>
</span><span id="line-448"></span><span class="hs-comment">-- cyclic symbol references when dynamically linking. Specifically, we link</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- together all of the static objects into a single shared object, avoiding</span><span>
</span><span id="line-450"></span><span class="hs-comment">-- the issue we saw in #13786.</span><span>
</span><span id="line-451"></span><span class="annot"><a href="GHC.Linker.Loader.html#mergeStaticObjects"><span class="hs-identifier hs-type">mergeStaticObjects</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-452"></span><span id="mergeStaticObjects"><span class="annot"><span class="annottext">mergeStaticObjects :: [LibrarySpec] -&gt; [LibrarySpec]
</span><a href="GHC.Linker.Loader.html#mergeStaticObjects"><span class="hs-identifier hs-var hs-var">mergeStaticObjects</span></a></span></span><span> </span><span id="local-6989586621683070385"><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070385"><span class="hs-identifier hs-var">specs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [LibrarySpec] -&gt; [LibrarySpec]
</span><a href="#local-6989586621683070386"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070385"><span class="hs-identifier hs-var">specs</span></a></span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-454"></span><span>    </span><span class="annot"><a href="#local-6989586621683070386"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-455"></span><span>    </span><span id="local-6989586621683070386"><span class="annot"><span class="annottext">go :: [String] -&gt; [LibrarySpec] -&gt; [LibrarySpec]
</span><a href="#local-6989586621683070386"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683070388"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070388"><span class="hs-identifier hs-var">accum</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#Objects"><span class="hs-identifier hs-type">Objects</span></a></span><span> </span><span id="local-6989586621683070389"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070389"><span class="hs-identifier hs-var">objs</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683070390"><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070390"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [LibrarySpec] -&gt; [LibrarySpec]
</span><a href="#local-6989586621683070386"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070389"><span class="hs-identifier hs-var">objs</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070388"><span class="hs-identifier hs-var">accum</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070390"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-456"></span><span>    </span><span class="annot"><a href="#local-6989586621683070386"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683070391"><span class="annot"><span class="annottext">accum :: [String]
</span><a href="#local-6989586621683070391"><span class="hs-identifier hs-var">accum</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[String]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683070392"><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070392"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#Objects"><span class="hs-identifier hs-var">Objects</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; [String]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070391"><span class="hs-identifier hs-var">accum</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LibrarySpec -&gt; [LibrarySpec] -&gt; [LibrarySpec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [LibrarySpec] -&gt; [LibrarySpec]
</span><a href="#local-6989586621683070386"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070392"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-457"></span><span>    </span><span class="annot"><a href="#local-6989586621683070386"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683070393"><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070393"><span class="hs-identifier hs-var">spec</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683070394"><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070394"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070393"><span class="hs-identifier hs-var">spec</span></a></span><span> </span><span class="annot"><span class="annottext">LibrarySpec -&gt; [LibrarySpec] -&gt; [LibrarySpec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [LibrarySpec] -&gt; [LibrarySpec]
</span><a href="#local-6989586621683070386"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070394"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-458"></span><span>    </span><span class="annot"><a href="#local-6989586621683070386"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="hs-comment">{- Note [preload packages]
   ~~~~~~~~~~~~~~~~~~~~~~~
Why do we need to preload packages from the command line?  This is an
explanation copied from #2437:

I tried to implement the suggestion from #3560, thinking it would be
easy, but there are two reasons we link in packages eagerly when they
are mentioned on the command line:

  * So that you can link in extra object files or libraries that
    depend on the packages. e.g. ghc -package foo -lbar where bar is a
    C library that depends on something in foo. So we could link in
    foo eagerly if and only if there are extra C libs or objects to
    link in, but....

  * Haskell code can depend on a C function exported by a package, and
    the normal dependency tracking that TH uses can't know about these
    dependencies. The test ghcilink004 relies on this, for example.

I conclude that we need two -package flags: one that says &quot;this is a
package I want to make available&quot;, and one that says &quot;this is a
package I want to link in eagerly&quot;. Would that be too complicated for
users?
-}</span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span class="annot"><a href="GHC.Linker.Loader.html#classifyLdInput"><span class="hs-identifier hs-type">classifyLdInput</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Platform.html#Platform"><span class="hs-identifier hs-type">Platform</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span id="classifyLdInput"><span class="annot"><span class="annottext">classifyLdInput :: Logger -&gt; Platform -&gt; String -&gt; IO (Maybe LibrarySpec)
</span><a href="GHC.Linker.Loader.html#classifyLdInput"><span class="hs-identifier hs-var hs-var">classifyLdInput</span></a></span></span><span> </span><span id="local-6989586621683070395"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070395"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621683070396"><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070396"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span id="local-6989586621683070397"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070397"><span class="hs-identifier hs-var">f</span></a></span></span><span>
</span><span id="line-487"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; String -&gt; Bool
</span><a href="GHC.Driver.Phases.html#isObjectFilename"><span class="hs-identifier hs-var">isObjectFilename</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070396"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070397"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe LibrarySpec -&gt; IO (Maybe LibrarySpec)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LibrarySpec -&gt; Maybe LibrarySpec
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#Objects"><span class="hs-identifier hs-var">Objects</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070397"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; String -&gt; Bool
</span><a href="GHC.Driver.Phases.html#isDynLibFilename"><span class="hs-identifier hs-var">isDynLibFilename</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070396"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070397"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe LibrarySpec -&gt; IO (Maybe LibrarySpec)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LibrarySpec -&gt; Maybe LibrarySpec
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070397"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-490"></span><span>        </span><span class="annot"><span class="annottext">Logger -&gt; MessageClass -&gt; SrcSpan -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070395"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">MessageClass
</span><a href="GHC.Types.Error.html#MCInfo"><span class="hs-identifier hs-var">MCInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a></span><span>
</span><span id="line-491"></span><span>            </span><span class="annot"><span class="annottext">(SDoc -&gt; IO ()) -&gt; SDoc -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PprStyle -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#withPprStyle"><span class="hs-identifier hs-var">withPprStyle</span></a></span><span> </span><span class="annot"><span class="annottext">PprStyle
</span><a href="GHC.Utils.Outputable.html#defaultUserStyle"><span class="hs-identifier hs-var">defaultUserStyle</span></a></span><span>
</span><span id="line-492"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Warning: ignoring unrecognised input `&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070397"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;'&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>        </span><span class="annot"><span class="annottext">Maybe LibrarySpec -&gt; IO (Maybe LibrarySpec)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe LibrarySpec
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="annot"><a href="GHC.Linker.Loader.html#preloadLib"><span class="hs-identifier hs-type">preloadLib</span></a></span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-503"></span><span id="preloadLib"><span class="annot"><span class="annottext">preloadLib :: Interp
-&gt; HscEnv
-&gt; [String]
-&gt; [String]
-&gt; LoaderState
-&gt; LibrarySpec
-&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#preloadLib"><span class="hs-identifier hs-var hs-var">preloadLib</span></a></span></span><span> </span><span id="local-6989586621683070403"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070403"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070404"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070404"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070405"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070405"><span class="hs-identifier hs-var">lib_paths</span></a></span></span><span> </span><span id="local-6989586621683070406"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070406"><span class="hs-identifier hs-var">framework_paths</span></a></span></span><span> </span><span id="local-6989586621683070407"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070407"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span id="local-6989586621683070408"><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070408"><span class="hs-identifier hs-var">lib_spec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-504"></span><span>  </span><span class="annot"><span class="annottext">Logger -&gt; String -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070409"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Loading object &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">LibrarySpec -&gt; String
</span><a href="GHC.Linker.Loader.html#showLS"><span class="hs-identifier hs-var">showLS</span></a></span><span> </span><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070408"><span class="hs-identifier hs-var">lib_spec</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; ... &quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070408"><span class="hs-identifier hs-var">lib_spec</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-506"></span><span>    </span><span class="annot"><a href="GHC.Linker.Types.html#Objects"><span class="hs-identifier hs-type">Objects</span></a></span><span> </span><span id="local-6989586621683070411"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070411"><span class="hs-identifier hs-var">static_ishs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-507"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683070412"><span class="annot"><a href="#local-6989586621683070412"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070413"><span class="annot"><a href="#local-6989586621683070413"><span class="hs-identifier hs-var">pls1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; IO (Bool, LoaderState)
</span><a href="#local-6989586621683070414"><span class="hs-identifier hs-var">preload_statics</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070405"><span class="hs-identifier hs-var">lib_paths</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070411"><span class="hs-identifier hs-var">static_ishs</span></a></span><span>
</span><span id="line-508"></span><span>      </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-type">maybePutStrLn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070409"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683070412"><span class="hs-identifier hs-type">b</span></a></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-string">&quot;done&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-string">&quot;not found&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683070413"><span class="hs-identifier hs-type">pls1</span></a></span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span>    </span><span class="annot"><a href="GHC.Linker.Types.html#Archive"><span class="hs-identifier hs-type">Archive</span></a></span><span> </span><span id="local-6989586621683070416"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070416"><span class="hs-identifier hs-var">static_ish</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-512"></span><span>      </span><span id="local-6989586621683070417"><span class="annot"><a href="#local-6989586621683070417"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String -&gt; IO Bool
</span><a href="#local-6989586621683070418"><span class="hs-identifier hs-var">preload_static_archive</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070405"><span class="hs-identifier hs-var">lib_paths</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070416"><span class="hs-identifier hs-var">static_ish</span></a></span><span>
</span><span id="line-513"></span><span>      </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-type">maybePutStrLn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070409"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683070417"><span class="hs-identifier hs-type">b</span></a></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-string">&quot;done&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-string">&quot;not found&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683070407"><span class="hs-identifier hs-type">pls</span></a></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span>    </span><span class="annot"><a href="GHC.Linker.Types.html#DLL"><span class="hs-identifier hs-type">DLL</span></a></span><span> </span><span id="local-6989586621683070420"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070420"><span class="hs-identifier hs-var">dll_unadorned</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-517"></span><span>      </span><span id="local-6989586621683070421"><span class="annot"><a href="#local-6989586621683070421"><span class="hs-identifier hs-var">maybe_errstr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; String -&gt; IO (Either String (RemotePtr LoadedDLL))
</span><a href="GHC.Runtime.Interpreter.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070403"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; String -&gt; String
</span><a href="GHC.Platform.html#platformSOName"><span class="hs-identifier hs-var">platformSOName</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070424"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070420"><span class="hs-identifier hs-var">dll_unadorned</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683070421"><span class="hs-identifier hs-type">maybe_errstr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-519"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">RemotePtr LoadedDLL
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; String -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070409"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;done&quot;</span></span><span>
</span><span id="line-520"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683070425"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070425"><span class="hs-identifier hs-var">mm</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; OS
</span><a href="GHC.Platform.html#platformOS"><span class="hs-identifier hs-var">platformOS</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070424"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">OS -&gt; OS -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">OS
</span><span class="hs-identifier hs-var">OSDarwin</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-521"></span><span>           </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; LibrarySpec -&gt; IO ()
</span><a href="#local-6989586621683070428"><span class="hs-identifier hs-var">preloadFailed</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070425"><span class="hs-identifier hs-var">mm</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070405"><span class="hs-identifier hs-var">lib_paths</span></a></span><span> </span><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070408"><span class="hs-identifier hs-var">lib_spec</span></a></span><span>
</span><span id="line-522"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683070429"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070429"><span class="hs-identifier hs-var">mm</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-523"></span><span>           </span><span class="hs-comment">-- As a backup, on Darwin, try to also load a .so file</span><span>
</span><span id="line-524"></span><span>           </span><span class="hs-comment">-- since (apparently) some things install that way - see</span><span>
</span><span id="line-525"></span><span>           </span><span class="hs-comment">-- ticket #8770.</span><span>
</span><span id="line-526"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070430"><span class="annot"><span class="annottext">libfile :: String
</span><a href="#local-6989586621683070430"><span class="hs-identifier hs-var hs-var hs-var">libfile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lib&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070420"><span class="hs-identifier hs-var">dll_unadorned</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;so&quot;</span></span><span>
</span><span id="line-527"></span><span>           </span><span id="local-6989586621683070432"><span class="annot"><a href="#local-6989586621683070432"><span class="hs-identifier hs-var">err2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; String -&gt; IO (Either String (RemotePtr LoadedDLL))
</span><a href="GHC.Runtime.Interpreter.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070403"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070430"><span class="hs-identifier hs-var">libfile</span></a></span><span>
</span><span id="line-528"></span><span>           </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683070432"><span class="hs-identifier hs-type">err2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-529"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">RemotePtr LoadedDLL
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; String -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070409"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;done&quot;</span></span><span>
</span><span id="line-530"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; LibrarySpec -&gt; IO ()
</span><a href="#local-6989586621683070428"><span class="hs-identifier hs-var">preloadFailed</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070429"><span class="hs-identifier hs-var">mm</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070405"><span class="hs-identifier hs-var">lib_paths</span></a></span><span> </span><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070408"><span class="hs-identifier hs-var">lib_spec</span></a></span><span>
</span><span id="line-531"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683070407"><span class="hs-identifier hs-type">pls</span></a></span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span>    </span><span class="annot"><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-type">DLLPath</span></a></span><span> </span><span id="local-6989586621683070433"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070433"><span class="hs-identifier hs-var">dll_path</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-534"></span><span>      </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683070434"><span class="annot"><a href="#local-6989586621683070434"><span class="hs-identifier hs-var">maybe_errstr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; String -&gt; IO (Either String (RemotePtr LoadedDLL))
</span><a href="GHC.Runtime.Interpreter.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070403"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070433"><span class="hs-identifier hs-var">dll_path</span></a></span><span>
</span><span id="line-535"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683070434"><span class="hs-identifier hs-type">maybe_errstr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-536"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">RemotePtr LoadedDLL
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; String -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070409"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;done&quot;</span></span><span>
</span><span id="line-537"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683070435"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070435"><span class="hs-identifier hs-var">mm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; LibrarySpec -&gt; IO ()
</span><a href="#local-6989586621683070428"><span class="hs-identifier hs-var">preloadFailed</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070435"><span class="hs-identifier hs-var">mm</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070405"><span class="hs-identifier hs-var">lib_paths</span></a></span><span> </span><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070408"><span class="hs-identifier hs-var">lib_spec</span></a></span><span>
</span><span id="line-538"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683070407"><span class="hs-identifier hs-type">pls</span></a></span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span>    </span><span class="annot"><a href="GHC.Linker.Types.html#Framework"><span class="hs-identifier hs-type">Framework</span></a></span><span> </span><span id="local-6989586621683070436"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070436"><span class="hs-identifier hs-var">framework</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-541"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Bool
</span><a href="GHC.Platform.html#platformUsesFrameworks"><span class="hs-identifier hs-var">platformUsesFrameworks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; Platform
</span><a href="GHC.Driver.DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070437"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683070438"><span class="annot"><a href="#local-6989586621683070438"><span class="hs-identifier hs-var">maybe_errstr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; [String] -&gt; String -&gt; IO (Maybe String)
</span><a href="GHC.Linker.MacOS.html#loadFramework"><span class="hs-identifier hs-var">loadFramework</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070403"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070406"><span class="hs-identifier hs-var">framework_paths</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070436"><span class="hs-identifier hs-var">framework</span></a></span><span>
</span><span id="line-543"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683070438"><span class="hs-identifier hs-type">maybe_errstr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-544"></span><span>                 </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; String -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070409"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;done&quot;</span></span><span>
</span><span id="line-545"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683070440"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070440"><span class="hs-identifier hs-var">mm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; LibrarySpec -&gt; IO ()
</span><a href="#local-6989586621683070428"><span class="hs-identifier hs-var">preloadFailed</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070440"><span class="hs-identifier hs-var">mm</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070406"><span class="hs-identifier hs-var">framework_paths</span></a></span><span> </span><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070408"><span class="hs-identifier hs-var">lib_spec</span></a></span><span>
</span><span id="line-546"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683070407"><span class="hs-identifier hs-type">pls</span></a></span><span>
</span><span id="line-547"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">GhcException -&gt; IO LoaderState
forall a. GhcException -&gt; IO a
</span><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-var">throwGhcExceptionIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; GhcException
</span><a href="GHC.Utils.Panic.html#ProgramError"><span class="hs-identifier hs-var">ProgramError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;preloadLib Framework&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-550"></span><span>    </span><span id="local-6989586621683070437"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621683070437"><span class="hs-identifier hs-var hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-551"></span><span>    </span><span id="local-6989586621683070409"><span class="annot"><span class="annottext">logger :: Logger
</span><a href="#local-6989586621683070409"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070404"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-552"></span><span>
</span><span id="line-553"></span><span>    </span><span id="local-6989586621683070424"><span class="annot"><span class="annottext">platform :: Platform
</span><a href="#local-6989586621683070424"><span class="hs-identifier hs-var hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Platform
</span><a href="GHC.Driver.DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070437"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span>    </span><span class="annot"><a href="#local-6989586621683070428"><span class="hs-identifier hs-type">preloadFailed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>    </span><span id="local-6989586621683070428"><span class="annot"><span class="annottext">preloadFailed :: String -&gt; [String] -&gt; LibrarySpec -&gt; IO ()
</span><a href="#local-6989586621683070428"><span class="hs-identifier hs-var hs-var">preloadFailed</span></a></span></span><span> </span><span id="local-6989586621683070441"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070441"><span class="hs-identifier hs-var">sys_errmsg</span></a></span></span><span> </span><span id="local-6989586621683070442"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070442"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span id="local-6989586621683070443"><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070443"><span class="hs-identifier hs-var">spec</span></a></span></span><span>
</span><span id="line-557"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; String -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070409"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;failed.\n&quot;</span></span><span>
</span><span id="line-558"></span><span>            </span><span class="annot"><span class="annottext">GhcException -&gt; IO ()
forall a. GhcException -&gt; IO a
</span><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-var">throwGhcExceptionIO</span></a></span><span> </span><span class="annot"><span class="annottext">(GhcException -&gt; IO ()) -&gt; GhcException -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-559"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; GhcException
</span><a href="GHC.Utils.Panic.html#CmdLineError"><span class="hs-identifier hs-var">CmdLineError</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-560"></span><span>                    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;user specified .o/.so/.DLL could not be loaded (&quot;</span></span><span>
</span><span id="line-561"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070441"><span class="hs-identifier hs-var">sys_errmsg</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)\nWhilst trying to load:  &quot;</span></span><span>
</span><span id="line-562"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">LibrarySpec -&gt; String
</span><a href="GHC.Linker.Loader.html#showLS"><span class="hs-identifier hs-var">showLS</span></a></span><span> </span><span class="annot"><span class="annottext">LibrarySpec
</span><a href="#local-6989586621683070443"><span class="hs-identifier hs-var">spec</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\nAdditional directories searched:&quot;</span></span><span>
</span><span id="line-563"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070442"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; (none)&quot;</span></span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-564"></span><span>                        </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; String
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">intercalate</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;   &quot;</span></span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070442"><span class="hs-identifier hs-var">paths</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-comment">-- Not interested in the paths in the static case.</span><span>
</span><span id="line-567"></span><span>    </span><span id="local-6989586621683070414"><span class="annot"><span class="annottext">preload_statics :: [String] -&gt; [String] -&gt; IO (Bool, LoaderState)
</span><a href="#local-6989586621683070414"><span class="hs-identifier hs-var hs-var">preload_statics</span></a></span></span><span> </span><span id="local-6989586621683070445"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070445"><span class="hs-identifier hs-var">_paths</span></a></span></span><span> </span><span id="local-6989586621683070446"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070446"><span class="hs-identifier hs-var">names</span></a></span></span><span>
</span><span id="line-568"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683070447"><span class="annot"><a href="#local-6989586621683070447"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">or</span></span><span> </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; IO [Bool] -&gt; IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO Bool) -&gt; [String] -&gt; IO [Bool]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO Bool
</span><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#doesFileExist"><span class="hs-identifier hs-var">doesFileExist</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070446"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-569"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621683070447"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070407"><span class="hs-identifier hs-type">pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#interpreterDynamic"><span class="hs-identifier hs-type">interpreterDynamic</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070403"><span class="hs-identifier hs-type">interp</span></a></span><span>
</span><span id="line-571"></span><span>                             </span><span class="hs-keyword">then</span><span>  </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683070451"><span class="annot"><a href="#local-6989586621683070451"><span class="hs-identifier hs-var">pls1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#dynLoadObjs"><span class="hs-identifier hs-type">dynLoadObjs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070403"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070404"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070407"><span class="hs-identifier hs-type">pls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070446"><span class="hs-identifier hs-type">names</span></a></span><span>
</span><span id="line-572"></span><span>                                      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070451"><span class="hs-identifier hs-type">pls1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>                             </span><span class="hs-keyword">else</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadObj"><span class="hs-identifier hs-type">loadObj</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070403"><span class="hs-identifier hs-type">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070446"><span class="hs-identifier hs-type">names</span></a></span><span>
</span><span id="line-574"></span><span>                                      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070407"><span class="hs-identifier hs-type">pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>
</span><span id="line-576"></span><span>    </span><span id="local-6989586621683070418"><span class="annot"><span class="annottext">preload_static_archive :: [String] -&gt; String -&gt; IO Bool
</span><a href="#local-6989586621683070418"><span class="hs-identifier hs-var hs-var">preload_static_archive</span></a></span></span><span> </span><span id="local-6989586621683070454"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070454"><span class="hs-identifier hs-var">_paths</span></a></span></span><span> </span><span id="local-6989586621683070455"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070455"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-577"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683070456"><span class="annot"><a href="#local-6989586621683070456"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO Bool
</span><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#doesFileExist"><span class="hs-identifier hs-var">doesFileExist</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070455"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-578"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621683070456"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-579"></span><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#interpreterDynamic"><span class="hs-identifier hs-type">interpreterDynamic</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070403"><span class="hs-identifier hs-type">interp</span></a></span><span>
</span><span id="line-580"></span><span>                                 </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-type">throwGhcExceptionIO</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-581"></span><span>                                      </span><span class="annot"><a href="GHC.Utils.Panic.html#CmdLineError"><span class="hs-identifier hs-type">CmdLineError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070457"><span class="hs-identifier hs-type">dynamic_msg</span></a></span><span>
</span><span id="line-582"></span><span>                                 </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadArchive"><span class="hs-identifier hs-type">loadArchive</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070403"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070455"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-583"></span><span>                             </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span>
</span><span id="line-584"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-585"></span><span>        </span><span id="local-6989586621683070457"><span class="annot"><span class="annottext">dynamic_msg :: String
</span><a href="#local-6989586621683070457"><span class="hs-identifier hs-var hs-var">dynamic_msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unlines</span></span><span>
</span><span id="line-586"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;User-specified static library could not be loaded (&quot;</span></span><span>
</span><span id="line-587"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070455"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-588"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Loading static libraries is not supported in this configuration.&quot;</span></span><span>
</span><span id="line-589"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Try using a dynamic library instead.&quot;</span></span><span>
</span><span id="line-590"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-591"></span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="annot"><span class="hs-comment">{- **********************************************************************

                        Link a byte-code expression

  ********************************************************************* -}</span></span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span class="hs-comment">-- | Load a single expression, /including/ first loading packages and</span><span>
</span><span id="line-600"></span><span class="hs-comment">-- modules that this expression depends on.</span><span>
</span><span id="line-601"></span><span class="hs-comment">--</span><span>
</span><span id="line-602"></span><span class="hs-comment">-- Raises an IO exception ('ProgramError') if it can't find a compiled</span><span>
</span><span id="line-603"></span><span class="hs-comment">-- version of the dependents to load.</span><span>
</span><span id="line-604"></span><span class="hs-comment">--</span><span>
</span><span id="line-605"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadExpr"><span class="hs-identifier hs-type">loadExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.ByteCode.Types.html#UnlinkedBCO"><span class="hs-identifier hs-type">UnlinkedBCO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span>
</span><span id="line-606"></span><span id="loadExpr"><span class="annot"><span class="annottext">loadExpr :: Interp -&gt; HscEnv -&gt; SrcSpan -&gt; UnlinkedBCO -&gt; IO ForeignHValue
</span><a href="GHC.Linker.Loader.html#loadExpr"><span class="hs-identifier hs-var hs-var">loadExpr</span></a></span></span><span> </span><span id="local-6989586621683070459"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070459"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070460"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070460"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070461"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683070461"><span class="hs-identifier hs-var">span</span></a></span></span><span> </span><span id="local-6989586621683070462"><span class="annot"><span class="annottext">UnlinkedBCO
</span><a href="#local-6989586621683070462"><span class="hs-identifier hs-var">root_ul_bco</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-607"></span><span>  </span><span class="hs-comment">-- Initialise the linker (if it's not been done already)</span><span>
</span><span id="line-608"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier hs-var">initLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070459"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070460"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-609"></span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-comment">-- Take lock for the actual work.</span><span>
</span><span id="line-611"></span><span>  </span><span class="annot"><span class="annottext">Interp
-&gt; (LoaderState -&gt; IO (LoaderState, ForeignHValue))
-&gt; IO ForeignHValue
forall a. Interp -&gt; (LoaderState -&gt; IO (LoaderState, a)) -&gt; IO a
</span><a href="GHC.Linker.Loader.html#modifyLoaderState"><span class="hs-identifier hs-var">modifyLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070459"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">((LoaderState -&gt; IO (LoaderState, ForeignHValue))
 -&gt; IO ForeignHValue)
-&gt; (LoaderState -&gt; IO (LoaderState, ForeignHValue))
-&gt; IO ForeignHValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070463"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070463"><span class="hs-identifier hs-var">pls0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-612"></span><span>    </span><span class="hs-comment">-- Load the packages and modules required</span><span>
</span><span id="line-613"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683070464"><span class="annot"><a href="#local-6989586621683070464"><span class="hs-identifier hs-var">pls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070465"><span class="annot"><a href="#local-6989586621683070465"><span class="hs-identifier hs-var">ok</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp
-&gt; HscEnv
-&gt; LoaderState
-&gt; SrcSpan
-&gt; [Module]
-&gt; IO (LoaderState, SuccessFlag, [Linkable], PkgsLoaded)
</span><a href="GHC.Linker.Loader.html#loadDependencies"><span class="hs-identifier hs-var">loadDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070459"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070460"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070463"><span class="hs-identifier hs-var">pls0</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683070461"><span class="hs-identifier hs-var">span</span></a></span><span> </span><span class="annot"><span class="annottext">[Module]
</span><a href="#local-6989586621683070466"><span class="hs-identifier hs-var">needed_mods</span></a></span><span>
</span><span id="line-614"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#failed"><span class="hs-identifier hs-type">failed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070465"><span class="hs-identifier hs-type">ok</span></a></span><span>
</span><span id="line-615"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-type">throwGhcExceptionIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Panic.html#ProgramError"><span class="hs-identifier hs-type">ProgramError</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-616"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-617"></span><span>        </span><span class="hs-comment">-- Load the expression itself</span><span>
</span><span id="line-618"></span><span>        </span><span class="hs-comment">-- Load the necessary packages and linkables</span><span>
</span><span id="line-619"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070467"><span class="annot"><a href="#local-6989586621683070467"><span class="hs-identifier hs-var hs-var">le</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; LinkerEnv
</span><a href="GHC.Linker.Types.html#linker_env"><span class="hs-identifier hs-var">linker_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070464"><span class="hs-identifier hs-var">pls</span></a></span><span>
</span><span id="line-620"></span><span>            </span><span id="local-6989586621683070468"><span class="annot"><a href="#local-6989586621683070468"><span class="hs-identifier hs-var hs-var">bco_ix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Int)] -&gt; NameEnv Int
forall a. [(Name, a)] -&gt; NameEnv a
</span><a href="GHC.Types.Name.Env.html#mkNameEnv"><span class="hs-identifier hs-var">mkNameEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnlinkedBCO -&gt; Name
</span><a href="GHC.ByteCode.Types.html#unlinkedBCOName"><span class="hs-identifier hs-var">unlinkedBCOName</span></a></span><span> </span><span class="annot"><span class="annottext">UnlinkedBCO
</span><a href="#local-6989586621683070462"><span class="hs-identifier hs-var">root_ul_bco</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-621"></span><span>        </span><span id="local-6989586621683070471"><span class="annot"><a href="#local-6989586621683070471"><span class="hs-identifier hs-var">resolved</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.ByteCode.Linker.html#linkBCO"><span class="hs-identifier hs-type">linkBCO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070459"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#pkgs_loaded"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070464"><span class="hs-identifier hs-type">pls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070467"><span class="hs-identifier hs-type">le</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070468"><span class="hs-identifier hs-type">bco_ix</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070462"><span class="hs-identifier hs-type">root_ul_bco</span></a></span><span>
</span><span id="line-622"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621683070473"><span class="annot"><a href="#local-6989586621683070473"><span class="hs-identifier hs-var">root_hvref</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#createBCOs"><span class="hs-identifier hs-type">createBCOs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070459"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683070471"><span class="hs-identifier hs-type">resolved</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-623"></span><span>        </span><span id="local-6989586621683070475"><span class="annot"><a href="#local-6989586621683070475"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-type">mkFinalizedHValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070459"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070473"><span class="hs-identifier hs-type">root_hvref</span></a></span><span>
</span><span id="line-624"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070464"><span class="hs-identifier hs-type">pls</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070475"><span class="hs-identifier hs-type">fhv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-626"></span><span>     </span><span id="local-6989586621683070476"><span class="annot"><span class="annottext">free_names :: [Name]
</span><a href="#local-6989586621683070476"><span class="hs-identifier hs-var hs-var">free_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqDSet Name -&gt; [Name]
forall a. UniqDSet a -&gt; [a]
</span><a href="GHC.Types.Unique.DSet.html#uniqDSetToList"><span class="hs-identifier hs-var">uniqDSetToList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnlinkedBCO -&gt; UniqDSet Name
</span><a href="GHC.ByteCode.Asm.html#bcoFreeNames"><span class="hs-identifier hs-var">bcoFreeNames</span></a></span><span> </span><span class="annot"><span class="annottext">UnlinkedBCO
</span><a href="#local-6989586621683070462"><span class="hs-identifier hs-var">root_ul_bco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-627"></span><span>
</span><span id="line-628"></span><span>     </span><span class="annot"><a href="#local-6989586621683070466"><span class="hs-identifier hs-type">needed_mods</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-629"></span><span>     </span><span id="local-6989586621683070466"><span class="annot"><span class="annottext">needed_mods :: [Module]
</span><a href="#local-6989586621683070466"><span class="hs-identifier hs-var hs-var">needed_mods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070478"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683070478"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070478"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683070476"><span class="hs-identifier hs-var">free_names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-630"></span><span>                     </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070478"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- Names from other modules</span><span>
</span><span id="line-631"></span><span>                     </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isWiredInName"><span class="hs-identifier hs-var">isWiredInName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070478"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Exclude wired-in names</span><span>
</span><span id="line-632"></span><span>                   </span><span class="hs-special">]</span><span>                        </span><span class="hs-comment">-- (see note below)</span><span>
</span><span id="line-633"></span><span>        </span><span class="hs-comment">-- Exclude wired-in names because we may not have read</span><span>
</span><span id="line-634"></span><span>        </span><span class="hs-comment">-- their interface files, so getLinkDeps will fail</span><span>
</span><span id="line-635"></span><span>        </span><span class="hs-comment">-- All wired-in names are in the base package, which we link</span><span>
</span><span id="line-636"></span><span>        </span><span class="hs-comment">-- by default, so we can safely ignore them here.</span><span>
</span><span id="line-637"></span><span>
</span><span id="line-638"></span><span class="annot"><a href="GHC.Linker.Loader.html#initLinkDepsOpts"><span class="hs-identifier hs-type">initLinkDepsOpts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Deps.html#LinkDepsOpts"><span class="hs-identifier hs-type">LinkDepsOpts</span></a></span><span>
</span><span id="line-639"></span><span id="initLinkDepsOpts"><span class="annot"><span class="annottext">initLinkDepsOpts :: HscEnv -&gt; LinkDepsOpts
</span><a href="GHC.Linker.Loader.html#initLinkDepsOpts"><span class="hs-identifier hs-var hs-var">initLinkDepsOpts</span></a></span></span><span> </span><span id="local-6989586621683070480"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070480"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkDepsOpts
</span><a href="#local-6989586621683070481"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-640"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-641"></span><span>    </span><span id="local-6989586621683070481"><span class="annot"><span class="annottext">opts :: LinkDepsOpts
</span><a href="#local-6989586621683070481"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Linker.Deps.html#LinkDepsOpts"><span class="hs-identifier hs-type">LinkDepsOpts</span></a></span><span>
</span><span id="line-642"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ldObjSuffix :: String
</span><a href="GHC.Linker.Deps.html#ldObjSuffix"><span class="hs-identifier hs-var">ldObjSuffix</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; String
</span><a href="GHC.Driver.Session.html#objectSuf"><span class="hs-identifier hs-var">objectSuf</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070485"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-643"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldForceDyn :: Bool
</span><a href="GHC.Linker.Deps.html#ldForceDyn"><span class="hs-identifier hs-var">ldForceDyn</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Bool
</span><a href="GHC.Settings.html#sTargetRTSLinkerOnlySupportsSharedLibs"><span class="hs-identifier hs-var">sTargetRTSLinkerOnlySupportsSharedLibs</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Bool) -&gt; Settings -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Settings
</span><a href="GHC.Driver.Session.html#settings"><span class="hs-identifier hs-var">settings</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070485"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-644"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldOneShotMode :: Bool
</span><a href="GHC.Linker.Deps.html#ldOneShotMode"><span class="hs-identifier hs-var">ldOneShotMode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GhcMode -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#isOneShot"><span class="hs-identifier hs-var">isOneShot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; GhcMode
</span><a href="GHC.Driver.DynFlags.html#ghcMode"><span class="hs-identifier hs-var">ghcMode</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070485"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldModuleGraph :: ModuleGraph
</span><a href="GHC.Linker.Deps.html#ldModuleGraph"><span class="hs-identifier hs-var">ldModuleGraph</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; ModuleGraph
</span><a href="GHC.Driver.Env.Types.html#hsc_mod_graph"><span class="hs-identifier hs-var">hsc_mod_graph</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070480"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-646"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldUnitEnv :: UnitEnv
</span><a href="GHC.Linker.Deps.html#ldUnitEnv"><span class="hs-identifier hs-var">ldUnitEnv</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; UnitEnv
</span><a href="GHC.Driver.Env.Types.html#hsc_unit_env"><span class="hs-identifier hs-var">hsc_unit_env</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070480"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-647"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldPprOpts :: SDocContext
</span><a href="GHC.Linker.Deps.html#ldPprOpts"><span class="hs-identifier hs-var">ldPprOpts</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; PprStyle -&gt; SDocContext
</span><a href="GHC.Driver.DynFlags.html#initSDocContext"><span class="hs-identifier hs-var">initSDocContext</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070485"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">PprStyle
</span><a href="GHC.Utils.Outputable.html#defaultUserStyle"><span class="hs-identifier hs-var">defaultUserStyle</span></a></span><span>
</span><span id="line-648"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldFinderCache :: FinderCache
</span><a href="GHC.Linker.Deps.html#ldFinderCache"><span class="hs-identifier hs-var">ldFinderCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; FinderCache
</span><a href="GHC.Driver.Env.Types.html#hsc_FC"><span class="hs-identifier hs-var">hsc_FC</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070480"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-649"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldFinderOpts :: FinderOpts
</span><a href="GHC.Linker.Deps.html#ldFinderOpts"><span class="hs-identifier hs-var">ldFinderOpts</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; FinderOpts
</span><a href="GHC.Driver.Config.Finder.html#initFinderOpts"><span class="hs-identifier hs-var">initFinderOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070485"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-650"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldUseByteCode :: Bool
</span><a href="GHC.Linker.Deps.html#ldUseByteCode"><span class="hs-identifier hs-var">ldUseByteCode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_UseBytecodeRatherThanObjects"><span class="hs-identifier hs-var">Opt_UseBytecodeRatherThanObjects</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070485"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-651"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldMsgOpts :: DiagnosticOpts IfaceMessage
</span><a href="GHC.Linker.Deps.html#ldMsgOpts"><span class="hs-identifier hs-var">ldMsgOpts</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; DiagnosticOpts IfaceMessage
</span><a href="GHC.Driver.Config.Diagnostic.html#initIfaceMessageOpts"><span class="hs-identifier hs-var">initIfaceMessageOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070485"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-652"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ldWays :: Ways
</span><a href="GHC.Linker.Deps.html#ldWays"><span class="hs-identifier hs-var">ldWays</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Ways
</span><a href="GHC.Driver.DynFlags.html#ways"><span class="hs-identifier hs-var">ways</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070485"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-653"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Module -&gt; IO (MaybeErr MissingInterfaceError ModIface)
ldLoadIface :: SDoc -&gt; Module -&gt; IO (MaybeErr MissingInterfaceError ModIface)
ldLoadIface :: SDoc -&gt; Module -&gt; IO (MaybeErr MissingInterfaceError ModIface)
</span><a href="#local-6989586621683070509"><span class="hs-identifier hs-var hs-var">ldLoadIface</span></a></span><span>
</span><span id="line-654"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Module -&gt; IO (Maybe Linkable)
ldLoadByteCode :: Module -&gt; IO (Maybe Linkable)
ldLoadByteCode :: Module -&gt; IO (Maybe Linkable)
</span><a href="#local-6989586621683070511"><span class="hs-identifier hs-var hs-var">ldLoadByteCode</span></a></span><span>
</span><span id="line-655"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-656"></span><span>    </span><span id="local-6989586621683070485"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621683070485"><span class="hs-identifier hs-var hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070480"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-657"></span><span>    </span><span id="local-6989586621683070509"><span class="annot"><span class="annottext">ldLoadIface :: SDoc -&gt; Module -&gt; IO (MaybeErr MissingInterfaceError ModIface)
</span><a href="#local-6989586621683070509"><span class="hs-identifier hs-var hs-var">ldLoadIface</span></a></span></span><span> </span><span id="local-6989586621683070513"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683070513"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621683070514"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683070514"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc
-&gt; HscEnv
-&gt; IfG (MaybeErr MissingInterfaceError ModIface)
-&gt; IO (MaybeErr MissingInterfaceError ModIface)
forall a. SDoc -&gt; HscEnv -&gt; IfG a -&gt; IO a
</span><a href="GHC.Tc.Utils.Monad.html#initIfaceCheck"><span class="hs-identifier hs-var">initIfaceCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;loader&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070480"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-658"></span><span>                          </span><span class="annot"><span class="annottext">(IfG (MaybeErr MissingInterfaceError ModIface)
 -&gt; IO (MaybeErr MissingInterfaceError ModIface))
-&gt; IfG (MaybeErr MissingInterfaceError ModIface)
-&gt; IO (MaybeErr MissingInterfaceError ModIface)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDoc
-&gt; Module
-&gt; WhereFrom
-&gt; IfG (MaybeErr MissingInterfaceError ModIface)
forall lcl.
SDoc
-&gt; Module
-&gt; WhereFrom
-&gt; IfM lcl (MaybeErr MissingInterfaceError ModIface)
</span><a href="GHC.Iface.Load.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683070513"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683070514"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsBootInterface -&gt; WhereFrom
</span><a href="GHC.Iface.Load.html#ImportByUser"><span class="hs-identifier hs-var">ImportByUser</span></a></span><span> </span><span class="annot"><span class="annottext">IsBootInterface
</span><a href="Language.Haskell.Syntax.ImpExp.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span>
</span><span id="line-660"></span><span>    </span><span id="local-6989586621683070511"><span class="annot"><span class="annottext">ldLoadByteCode :: Module -&gt; IO (Maybe Linkable)
</span><a href="#local-6989586621683070511"><span class="hs-identifier hs-var hs-var">ldLoadByteCode</span></a></span></span><span> </span><span id="local-6989586621683070519"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683070519"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-661"></span><span>      </span><span class="annot"><a href="GHC.Unit.External.html#EPS"><span class="hs-identifier hs-type">EPS</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621683070520"><span class="annot"><a href="GHC.Unit.External.html#eps_iface_bytecode"><span class="hs-identifier hs-var hs-var">eps_iface_bytecode</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; IO ExternalPackageState
</span><a href="GHC.Driver.Env.html#hscEPS"><span class="hs-identifier hs-var">hscEPS</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070480"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-662"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">sequence</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Env.html#lookupModuleEnv"><span class="hs-identifier hs-type">lookupModuleEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070520"><span class="hs-identifier hs-type">eps_iface_bytecode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070519"><span class="hs-identifier hs-type">mod</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-663"></span><span>
</span><span id="line-664"></span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span class="annot"><span class="hs-comment">{- **********************************************************************

              Loading a Decls statement

  ********************************************************************* -}</span></span><span>
</span><span id="line-671"></span><span>
</span><span id="line-672"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadDecls"><span class="hs-identifier hs-type">loadDecls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#PkgsLoaded"><span class="hs-identifier hs-type">PkgsLoaded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span id="loadDecls"><span class="annot"><span class="annottext">loadDecls :: Interp
-&gt; HscEnv
-&gt; SrcSpan
-&gt; Linkable
-&gt; IO ([(Name, ForeignHValue)], [Linkable], PkgsLoaded)
</span><a href="GHC.Linker.Loader.html#loadDecls"><span class="hs-identifier hs-var hs-var">loadDecls</span></a></span></span><span> </span><span id="local-6989586621683070524"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070524"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070525"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070525"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070526"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683070526"><span class="hs-identifier hs-var">span</span></a></span></span><span> </span><span id="local-6989586621683070527"><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070527"><span class="hs-identifier hs-var">linkable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-674"></span><span>    </span><span class="hs-comment">-- Initialise the linker (if it's not been done already)</span><span>
</span><span id="line-675"></span><span>    </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier hs-var">initLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070524"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070525"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-676"></span><span>
</span><span id="line-677"></span><span>    </span><span class="hs-comment">-- Take lock for the actual work.</span><span>
</span><span id="line-678"></span><span>    </span><span class="annot"><span class="annottext">Interp
-&gt; (LoaderState
    -&gt; IO
         (LoaderState, ([(Name, ForeignHValue)], [Linkable], PkgsLoaded)))
-&gt; IO ([(Name, ForeignHValue)], [Linkable], PkgsLoaded)
forall a. Interp -&gt; (LoaderState -&gt; IO (LoaderState, a)) -&gt; IO a
</span><a href="GHC.Linker.Loader.html#modifyLoaderState"><span class="hs-identifier hs-var">modifyLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070524"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">((LoaderState
  -&gt; IO
       (LoaderState, ([(Name, ForeignHValue)], [Linkable], PkgsLoaded)))
 -&gt; IO ([(Name, ForeignHValue)], [Linkable], PkgsLoaded))
-&gt; (LoaderState
    -&gt; IO
         (LoaderState, ([(Name, ForeignHValue)], [Linkable], PkgsLoaded)))
-&gt; IO ([(Name, ForeignHValue)], [Linkable], PkgsLoaded)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070528"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070528"><span class="hs-identifier hs-var">pls0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-679"></span><span>      </span><span class="hs-comment">-- Link the foreign objects first; BCOs in linkable are ignored here.</span><span>
</span><span id="line-680"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683070529"><span class="annot"><a href="#local-6989586621683070529"><span class="hs-identifier hs-var">pls1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070530"><span class="annot"><a href="#local-6989586621683070530"><span class="hs-identifier hs-var">objs_ok</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp
-&gt; HscEnv
-&gt; LoaderState
-&gt; [Linkable]
-&gt; IO (LoaderState, SuccessFlag)
</span><a href="GHC.Linker.Loader.html#loadObjects"><span class="hs-identifier hs-var">loadObjects</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070524"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070525"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070528"><span class="hs-identifier hs-var">pls0</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070527"><span class="hs-identifier hs-var">linkable</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-681"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#failed"><span class="hs-identifier hs-type">failed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070530"><span class="hs-identifier hs-type">objs_ok</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-type">throwGhcExceptionIO</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#ProgramError"><span class="hs-identifier hs-type">ProgramError</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;loadDecls: failed to load foreign objects&quot;</span></span><span>
</span><span id="line-682"></span><span>
</span><span id="line-683"></span><span>      </span><span class="hs-comment">-- Link the packages and modules required</span><span>
</span><span id="line-684"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683070533"><span class="annot"><a href="#local-6989586621683070533"><span class="hs-identifier hs-var">pls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070534"><span class="annot"><a href="#local-6989586621683070534"><span class="hs-identifier hs-var">ok</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070535"><span class="annot"><a href="#local-6989586621683070535"><span class="hs-identifier hs-var">links_needed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070536"><span class="annot"><a href="#local-6989586621683070536"><span class="hs-identifier hs-var">units_needed</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadDependencies"><span class="hs-identifier hs-type">loadDependencies</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070524"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070525"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070529"><span class="hs-identifier hs-type">pls1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070526"><span class="hs-identifier hs-type">span</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070537"><span class="hs-identifier hs-type">needed_mods</span></a></span><span>
</span><span id="line-685"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#failed"><span class="hs-identifier hs-type">failed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070534"><span class="hs-identifier hs-type">ok</span></a></span><span>
</span><span id="line-686"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-type">throwGhcExceptionIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Panic.html#ProgramError"><span class="hs-identifier hs-type">ProgramError</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-687"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-688"></span><span>          </span><span class="hs-comment">-- Link the expression itself</span><span>
</span><span id="line-689"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070538"><span class="annot"><a href="#local-6989586621683070538"><span class="hs-identifier hs-var hs-var">le</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; LinkerEnv
</span><a href="GHC.Linker.Types.html#linker_env"><span class="hs-identifier hs-var">linker_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070533"><span class="hs-identifier hs-var">pls</span></a></span><span>
</span><span id="line-690"></span><span>              </span><span id="local-6989586621683070539"><span class="annot"><a href="#local-6989586621683070539"><span class="hs-identifier hs-var hs-var">le2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkerEnv
</span><a href="#local-6989586621683070538"><span class="hs-identifier hs-var">le</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#itbl_env"><span class="hs-identifier hs-var">itbl_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683070541"><span class="annot"><span class="annottext">ItblEnv
</span><a href="#local-6989586621683070541"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621683070542"><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621683070542"><span class="hs-identifier hs-var">cbc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ItblEnv -&gt; ItblEnv -&gt; ItblEnv
forall a. NameEnv a -&gt; NameEnv a -&gt; NameEnv a
</span><a href="GHC.Types.Name.Env.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ItblEnv
</span><a href="#local-6989586621683070541"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompiledByteCode -&gt; ItblEnv
</span><a href="GHC.ByteCode.Types.html#bc_itbls"><span class="hs-identifier hs-var">bc_itbls</span></a></span><span> </span><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621683070542"><span class="hs-identifier hs-var">cbc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#itbl_env"><span class="hs-identifier hs-var">itbl_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070538"><span class="hs-identifier hs-type">le</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070545"><span class="hs-identifier hs-type">cbcs</span></a></span><span>
</span><span id="line-691"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#addr_env"><span class="hs-identifier hs-var">addr_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683070546"><span class="annot"><span class="annottext">AddrEnv
</span><a href="#local-6989586621683070546"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621683070547"><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621683070547"><span class="hs-identifier hs-var">cbc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AddrEnv -&gt; AddrEnv -&gt; AddrEnv
forall a. NameEnv a -&gt; NameEnv a -&gt; NameEnv a
</span><a href="GHC.Types.Name.Env.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AddrEnv
</span><a href="#local-6989586621683070546"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompiledByteCode -&gt; AddrEnv
</span><a href="GHC.ByteCode.Types.html#bc_strs"><span class="hs-identifier hs-var">bc_strs</span></a></span><span> </span><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621683070547"><span class="hs-identifier hs-var">cbc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#addr_env"><span class="hs-identifier hs-var">addr_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070538"><span class="hs-identifier hs-type">le</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070545"><span class="hs-identifier hs-type">cbcs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-692"></span><span>
</span><span id="line-693"></span><span>          </span><span class="hs-comment">-- Link the necessary packages and linkables</span><span>
</span><span id="line-694"></span><span>          </span><span id="local-6989586621683070549"><span class="annot"><a href="#local-6989586621683070549"><span class="hs-identifier hs-var">new_bindings</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#linkSomeBCOs"><span class="hs-identifier hs-type">linkSomeBCOs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070524"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#pkgs_loaded"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070533"><span class="hs-identifier hs-type">pls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070539"><span class="hs-identifier hs-type">le2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070545"><span class="hs-identifier hs-type">cbcs</span></a></span><span>
</span><span id="line-695"></span><span>          </span><span id="local-6989586621683070551"><span class="annot"><a href="#local-6989586621683070551"><span class="hs-identifier hs-var">nms_fhvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#makeForeignNamedHValueRefs"><span class="hs-identifier hs-type">makeForeignNamedHValueRefs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070524"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070549"><span class="hs-identifier hs-type">new_bindings</span></a></span><span>
</span><span id="line-696"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070553"><span class="annot"><a href="#local-6989586621683070553"><span class="hs-identifier hs-var hs-var">ce2</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureEnv -&gt; [(Name, ForeignHValue)] -&gt; ClosureEnv
</span><a href="GHC.Linker.Types.html#extendClosureEnv"><span class="hs-identifier hs-var">extendClosureEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkerEnv -&gt; ClosureEnv
</span><a href="GHC.Linker.Types.html#closure_env"><span class="hs-identifier hs-var">closure_env</span></a></span><span> </span><span class="annot"><span class="annottext">LinkerEnv
</span><a href="#local-6989586621683070539"><span class="hs-identifier hs-var">le2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, ForeignHValue)]
</span><a href="#local-6989586621683070551"><span class="hs-identifier hs-var">nms_fhvs</span></a></span><span>
</span><span id="line-697"></span><span>              </span><span class="hs-glyph">!</span><span id="local-6989586621683070554"><span class="annot"><a href="#local-6989586621683070554"><span class="hs-identifier hs-var hs-var">pls2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070533"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#linker_env"><span class="hs-identifier hs-var">linker_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070539"><span class="hs-identifier hs-type">le2</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#closure_env"><span class="hs-identifier hs-var">closure_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070553"><span class="hs-identifier hs-type">ce2</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-698"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070554"><span class="hs-identifier hs-type">pls2</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070551"><span class="hs-identifier hs-type">nms_fhvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070535"><span class="hs-identifier hs-type">links_needed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070536"><span class="hs-identifier hs-type">units_needed</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-699"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-700"></span><span>    </span><span id="local-6989586621683070545"><span class="annot"><span class="annottext">cbcs :: [CompiledByteCode]
</span><a href="#local-6989586621683070545"><span class="hs-identifier hs-var hs-var">cbcs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; [CompiledByteCode]
</span><a href="GHC.Linker.Types.html#linkableBCOs"><span class="hs-identifier hs-var">linkableBCOs</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070527"><span class="hs-identifier hs-var">linkable</span></a></span><span>
</span><span id="line-701"></span><span>
</span><span id="line-702"></span><span>    </span><span id="local-6989586621683070556"><span class="annot"><span class="annottext">free_names :: [Name]
</span><a href="#local-6989586621683070556"><span class="hs-identifier hs-var hs-var">free_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqDSet Name -&gt; [Name]
forall a. UniqDSet a -&gt; [a]
</span><a href="GHC.Types.Unique.DSet.html#uniqDSetToList"><span class="hs-identifier hs-var">uniqDSetToList</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqDSet Name -&gt; [Name]) -&gt; UniqDSet Name -&gt; [Name]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-703"></span><span>      </span><span class="annot"><span class="annottext">(UniqDSet Name -&gt; CompiledByteCode -&gt; UniqDSet Name)
-&gt; UniqDSet Name -&gt; [CompiledByteCode] -&gt; UniqDSet Name
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span>
</span><span id="line-704"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683070557"><span class="annot"><span class="annottext">UniqDSet Name
</span><a href="#local-6989586621683070557"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621683070558"><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621683070558"><span class="hs-identifier hs-var">cbc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(UniqDSet Name -&gt; UnlinkedBCO -&gt; UniqDSet Name)
-&gt; UniqDSet Name -&gt; FlatBag UnlinkedBCO -&gt; UniqDSet Name
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; FlatBag a -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683070559"><span class="annot"><span class="annottext">UniqDSet Name
</span><a href="#local-6989586621683070559"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span id="local-6989586621683070560"><span class="annot"><span class="annottext">UnlinkedBCO
</span><a href="#local-6989586621683070560"><span class="hs-identifier hs-var">bco</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnlinkedBCO -&gt; UniqDSet Name
</span><a href="GHC.ByteCode.Asm.html#bcoFreeNames"><span class="hs-identifier hs-var">bcoFreeNames</span></a></span><span> </span><span class="annot"><span class="annottext">UnlinkedBCO
</span><a href="#local-6989586621683070560"><span class="hs-identifier hs-var">bco</span></a></span><span> </span><span class="annot"><span class="annottext">UniqDSet Name -&gt; UniqDSet Name -&gt; UniqDSet Name
forall a. UniqDSet a -&gt; UniqDSet a -&gt; UniqDSet a
</span><a href="GHC.Types.Unique.DSet.html#unionUniqDSets"><span class="hs-operator hs-var">`unionUniqDSets`</span></a></span><span> </span><span class="annot"><span class="annottext">UniqDSet Name
</span><a href="#local-6989586621683070559"><span class="hs-identifier hs-var">acc'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UniqDSet Name
</span><a href="#local-6989586621683070557"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompiledByteCode -&gt; FlatBag UnlinkedBCO
</span><a href="GHC.ByteCode.Types.html#bc_bcos"><span class="hs-identifier hs-var">bc_bcos</span></a></span><span> </span><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621683070558"><span class="hs-identifier hs-var">cbc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-705"></span><span>        </span><span class="annot"><span class="annottext">UniqDSet Name
forall a. UniqDSet a
</span><a href="GHC.Types.Unique.DSet.html#emptyUniqDSet"><span class="hs-identifier hs-var">emptyUniqDSet</span></a></span><span> </span><span class="annot"><span class="annottext">[CompiledByteCode]
</span><a href="#local-6989586621683070545"><span class="hs-identifier hs-var">cbcs</span></a></span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span>    </span><span class="annot"><a href="#local-6989586621683070537"><span class="hs-identifier hs-type">needed_mods</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-708"></span><span>    </span><span id="local-6989586621683070537"><span class="annot"><span class="annottext">needed_mods :: [Module]
</span><a href="#local-6989586621683070537"><span class="hs-identifier hs-var hs-var">needed_mods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070563"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683070563"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070563"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683070556"><span class="hs-identifier hs-var">free_names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-709"></span><span>                    </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070563"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span>       </span><span class="hs-comment">-- Names from other modules</span><span>
</span><span id="line-710"></span><span>                    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isWiredInName"><span class="hs-identifier hs-var">isWiredInName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070563"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Exclude wired-in names</span><span>
</span><span id="line-711"></span><span>                  </span><span class="hs-special">]</span><span>                         </span><span class="hs-comment">-- (see note below)</span><span>
</span><span id="line-712"></span><span>    </span><span class="hs-comment">-- Exclude wired-in names because we may not have read</span><span>
</span><span id="line-713"></span><span>    </span><span class="hs-comment">-- their interface files, so getLinkDeps will fail</span><span>
</span><span id="line-714"></span><span>    </span><span class="hs-comment">-- All wired-in names are in the base package, which we link</span><span>
</span><span id="line-715"></span><span>    </span><span class="hs-comment">-- by default, so we can safely ignore them here.</span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span class="annot"><span class="hs-comment">{- **********************************************************************

              Loading a single module

  ********************************************************************* -}</span></span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadModule"><span class="hs-identifier hs-type">loadModule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span id="loadModule"><span class="annot"><span class="annottext">loadModule :: Interp -&gt; HscEnv -&gt; Module -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#loadModule"><span class="hs-identifier hs-var hs-var">loadModule</span></a></span></span><span> </span><span id="local-6989586621683070564"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070564"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070565"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070565"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070566"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683070566"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-725"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier hs-var">initLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070564"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070565"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-726"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#modifyLoaderState_"><span class="hs-identifier hs-var">modifyLoaderState_</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070564"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">((LoaderState -&gt; IO LoaderState) -&gt; IO ())
-&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070567"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070567"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683070568"><span class="annot"><a href="#local-6989586621683070568"><span class="hs-identifier hs-var">pls'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070569"><span class="annot"><a href="#local-6989586621683070569"><span class="hs-identifier hs-var">ok</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp
-&gt; HscEnv
-&gt; LoaderState
-&gt; SrcSpan
-&gt; [Module]
-&gt; IO (LoaderState, SuccessFlag, [Linkable], PkgsLoaded)
</span><a href="GHC.Linker.Loader.html#loadDependencies"><span class="hs-identifier hs-var">loadDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070564"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070565"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070567"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621683070566"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-728"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#failed"><span class="hs-identifier hs-type">failed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070569"><span class="hs-identifier hs-type">ok</span></a></span><span>
</span><span id="line-729"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-type">throwGhcExceptionIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Panic.html#ProgramError"><span class="hs-identifier hs-type">ProgramError</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;could not load module&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-730"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683070568"><span class="hs-identifier hs-type">pls'</span></a></span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span class="annot"><span class="hs-comment">{- **********************************************************************

                Link some linkables
        The linkables may consist of a mixture of
        byte-code modules and object modules

  ********************************************************************* -}</span></span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadModuleLinkables"><span class="hs-identifier hs-type">loadModuleLinkables</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SuccessFlag"><span class="hs-identifier hs-type">SuccessFlag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span id="loadModuleLinkables"><span class="annot"><span class="annottext">loadModuleLinkables :: Interp
-&gt; HscEnv
-&gt; LoaderState
-&gt; [Linkable]
-&gt; IO (LoaderState, SuccessFlag)
</span><a href="GHC.Linker.Loader.html#loadModuleLinkables"><span class="hs-identifier hs-var hs-var">loadModuleLinkables</span></a></span></span><span> </span><span id="local-6989586621683070570"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070570"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070571"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070571"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070572"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070572"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span id="local-6989586621683070573"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070573"><span class="hs-identifier hs-var">linkables</span></a></span></span><span>
</span><span id="line-742"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (LoaderState, SuccessFlag) -&gt; IO (LoaderState, SuccessFlag)
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(IO (LoaderState, SuccessFlag) -&gt; IO (LoaderState, SuccessFlag))
-&gt; IO (LoaderState, SuccessFlag) -&gt; IO (LoaderState, SuccessFlag)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- don't want to be interrupted by ^C in here</span><span>
</span><span id="line-743"></span><span>
</span><span id="line-744"></span><span>        </span><span class="annot"><span class="annottext">Logger -&gt; Int -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Error.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070571"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; IO ()) -&gt; SDoc -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-745"></span><span>          </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Loading module linkables&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span>
</span><span id="line-746"></span><span>            </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Objects:&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Linkable -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(Linkable -&gt; SDoc) -&gt; [Linkable] -&gt; [SDoc]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070577"><span class="hs-identifier hs-var">objs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-747"></span><span>            </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Bytecode:&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Linkable -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(Linkable -&gt; SDoc) -&gt; [Linkable] -&gt; [SDoc]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070578"><span class="hs-identifier hs-var">bcos</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span>                </span><span class="hs-comment">-- Load objects first; they can't depend on BCOs</span><span>
</span><span id="line-751"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621683070579"><span class="annot"><a href="#local-6989586621683070579"><span class="hs-identifier hs-var">pls1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070580"><span class="annot"><a href="#local-6989586621683070580"><span class="hs-identifier hs-var">ok_flag</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp
-&gt; HscEnv
-&gt; LoaderState
-&gt; [Linkable]
-&gt; IO (LoaderState, SuccessFlag)
</span><a href="GHC.Linker.Loader.html#loadObjects"><span class="hs-identifier hs-var">loadObjects</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070570"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070571"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070572"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070577"><span class="hs-identifier hs-var">objs</span></a></span><span>
</span><span id="line-752"></span><span>
</span><span id="line-753"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#failed"><span class="hs-identifier hs-type">failed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070580"><span class="hs-identifier hs-type">ok_flag</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-754"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070579"><span class="hs-identifier hs-type">pls1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Failed"><span class="hs-identifier hs-type">Failed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-755"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-756"></span><span>                </span><span id="local-6989586621683070582"><span class="annot"><a href="#local-6989586621683070582"><span class="hs-identifier hs-var">pls2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#dynLinkBCOs"><span class="hs-identifier hs-type">dynLinkBCOs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070570"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070579"><span class="hs-identifier hs-type">pls1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070578"><span class="hs-identifier hs-type">bcos</span></a></span><span>
</span><span id="line-757"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070582"><span class="hs-identifier hs-type">pls2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Succeeded"><span class="hs-identifier hs-type">Succeeded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-758"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-759"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683070577"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070577"><span class="hs-identifier hs-var">objs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070578"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070578"><span class="hs-identifier hs-var">bcos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Linkable] -&gt; ([Linkable], [Linkable])
</span><a href="GHC.Linker.Types.html#partitionLinkables"><span class="hs-identifier hs-var">partitionLinkables</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070573"><span class="hs-identifier hs-var">linkables</span></a></span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span>
</span><span id="line-762"></span><span class="annot"><a href="GHC.Linker.Loader.html#linkableInSet"><span class="hs-identifier hs-type">linkableInSet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LinkableSet"><span class="hs-identifier hs-type">LinkableSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-763"></span><span id="linkableInSet"><span class="annot"><span class="annottext">linkableInSet :: Linkable -&gt; LinkableSet -&gt; Bool
</span><a href="GHC.Linker.Loader.html#linkableInSet"><span class="hs-identifier hs-var hs-var">linkableInSet</span></a></span></span><span> </span><span id="local-6989586621683070587"><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070587"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621683070588"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070588"><span class="hs-identifier hs-var">objs_loaded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-764"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LinkableSet -&gt; Module -&gt; Maybe Linkable
forall a. ModuleEnv a -&gt; Module -&gt; Maybe a
</span><a href="GHC.Unit.Module.Env.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070588"><span class="hs-identifier hs-var">objs_loaded</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Linkable -&gt; Module
</span><a href="GHC.Linker.Types.html#linkableModule"><span class="hs-identifier hs-var">linkableModule</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070587"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-765"></span><span>        </span><span class="annot"><span class="annottext">Maybe Linkable
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-766"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683070590"><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070590"><span class="hs-identifier hs-var">m</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; UTCTime
</span><a href="GHC.Linker.Types.html#linkableTime"><span class="hs-identifier hs-var">linkableTime</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070587"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; UTCTime
</span><a href="GHC.Linker.Types.html#linkableTime"><span class="hs-identifier hs-var">linkableTime</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070590"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-767"></span><span>
</span><span id="line-768"></span><span>
</span><span id="line-769"></span><span class="annot"><span class="hs-comment">{- **********************************************************************

                The object-code linker

  ********************************************************************* -}</span></span><span>
</span><span id="line-774"></span><span>
</span><span id="line-775"></span><span class="hs-comment">-- | Load the object files and link them</span><span>
</span><span id="line-776"></span><span class="hs-comment">--</span><span>
</span><span id="line-777"></span><span class="hs-comment">-- If the interpreter uses dynamic-linking, build a shared library and load it.</span><span>
</span><span id="line-778"></span><span class="hs-comment">-- Otherwise, use the RTS linker.</span><span>
</span><span id="line-779"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadObjects"><span class="hs-identifier hs-type">loadObjects</span></a></span><span>
</span><span id="line-780"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span>
</span><span id="line-782"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-783"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-784"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SuccessFlag"><span class="hs-identifier hs-type">SuccessFlag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span id="loadObjects"><span class="annot"><span class="annottext">loadObjects :: Interp
-&gt; HscEnv
-&gt; LoaderState
-&gt; [Linkable]
-&gt; IO (LoaderState, SuccessFlag)
</span><a href="GHC.Linker.Loader.html#loadObjects"><span class="hs-identifier hs-var hs-var">loadObjects</span></a></span></span><span> </span><span id="local-6989586621683070592"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070592"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070593"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070593"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070594"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070594"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span id="local-6989586621683070595"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070595"><span class="hs-identifier hs-var">objs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-786"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683070596"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070596"><span class="hs-identifier hs-var">objs_loaded'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070597"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070597"><span class="hs-identifier hs-var">new_objs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkableSet -&gt; [Linkable] -&gt; (LinkableSet, [Linkable])
</span><a href="GHC.Linker.Loader.html#rmDupLinkables"><span class="hs-identifier hs-var">rmDupLinkables</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoaderState -&gt; LinkableSet
</span><a href="GHC.Linker.Types.html#objs_loaded"><span class="hs-identifier hs-var">objs_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070594"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070595"><span class="hs-identifier hs-var">objs</span></a></span><span>
</span><span id="line-787"></span><span>            </span><span id="local-6989586621683070598"><span class="annot"><span class="annottext">pls1 :: LoaderState
</span><a href="#local-6989586621683070598"><span class="hs-identifier hs-var hs-var">pls1</span></a></span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070594"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#objs_loaded"><span class="hs-identifier hs-var">objs_loaded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070596"><span class="hs-identifier hs-type">objs_loaded'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-788"></span><span>            </span><span id="local-6989586621683070599"><span class="annot"><span class="annottext">wanted_objs :: [String]
</span><a href="#local-6989586621683070599"><span class="hs-identifier hs-var hs-var">wanted_objs</span></a></span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Linkable -&gt; [String]) -&gt; [Linkable] -&gt; [String]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; [String]
</span><a href="GHC.Linker.Types.html#linkableFiles"><span class="hs-identifier hs-var">linkableFiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070597"><span class="hs-identifier hs-var">new_objs</span></a></span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.html#interpreterDynamic"><span class="hs-identifier hs-var">interpreterDynamic</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070592"><span class="hs-identifier hs-var">interp</span></a></span><span>
</span><span id="line-791"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683070602"><span class="annot"><a href="#local-6989586621683070602"><span class="hs-identifier hs-var">pls2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; LoaderState -&gt; [String] -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#dynLoadObjs"><span class="hs-identifier hs-var">dynLoadObjs</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070592"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070593"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070598"><span class="hs-identifier hs-var">pls1</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070599"><span class="hs-identifier hs-var">wanted_objs</span></a></span><span>
</span><span id="line-792"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070602"><span class="hs-identifier hs-type">pls2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Succeeded"><span class="hs-identifier hs-type">Succeeded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; [String] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Interp -&gt; String -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#loadObj"><span class="hs-identifier hs-var">loadObj</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070592"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070599"><span class="hs-identifier hs-var">wanted_objs</span></a></span><span>
</span><span id="line-794"></span><span>
</span><span id="line-795"></span><span>                    </span><span class="hs-comment">-- Link them all together</span><span>
</span><span id="line-796"></span><span>                    </span><span id="local-6989586621683070603"><span class="annot"><a href="#local-6989586621683070603"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; IO SuccessFlag
</span><a href="GHC.Runtime.Interpreter.html#resolveObjs"><span class="hs-identifier hs-var">resolveObjs</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070592"><span class="hs-identifier hs-var">interp</span></a></span><span>
</span><span id="line-797"></span><span>
</span><span id="line-798"></span><span>                    </span><span class="hs-comment">-- If resolving failed, unload all our</span><span>
</span><span id="line-799"></span><span>                    </span><span class="hs-comment">-- object modules and carry on</span><span>
</span><span id="line-800"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#succeeded"><span class="hs-identifier hs-type">succeeded</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070603"><span class="hs-identifier hs-type">ok</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-801"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070598"><span class="hs-identifier hs-type">pls1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Succeeded"><span class="hs-identifier hs-type">Succeeded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-803"></span><span>                            </span><span id="local-6989586621683070604"><span class="annot"><a href="#local-6989586621683070604"><span class="hs-identifier hs-var">pls2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#unload_wkr"><span class="hs-identifier hs-type">unload_wkr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070592"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621683070598"><span class="hs-identifier hs-type">pls1</span></a></span><span>
</span><span id="line-804"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070604"><span class="hs-identifier hs-type">pls2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Failed"><span class="hs-identifier hs-type">Failed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span class="annot"><span class="hs-comment">-- | Create a shared library containing the given object files and load it.</span></span><span>
</span><span id="line-808"></span><span class="annot"><a href="GHC.Linker.Loader.html#dynLoadObjs"><span class="hs-identifier hs-type">dynLoadObjs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-809"></span><span id="dynLoadObjs"><span class="annot"><span class="annottext">dynLoadObjs :: Interp -&gt; HscEnv -&gt; LoaderState -&gt; [String] -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#dynLoadObjs"><span class="hs-identifier hs-var hs-var">dynLoadObjs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Interp
</span><span class="hs-identifier">_</span></span><span>      </span><span class="annot"><span class="annottext">HscEnv
</span><span class="hs-identifier">_</span></span><span>       </span><span id="local-6989586621683070606"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070606"><span class="hs-identifier hs-var">pls</span></a></span></span><span>                           </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; IO LoaderState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070606"><span class="hs-identifier hs-var">pls</span></a></span><span>
</span><span id="line-810"></span><span class="annot"><a href="GHC.Linker.Loader.html#dynLoadObjs"><span class="hs-identifier hs-var">dynLoadObjs</span></a></span><span> </span><span id="local-6989586621683070607"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070607"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070608"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070608"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070609"><span class="annot"><span class="annottext">pls :: LoaderState
</span><a href="#local-6989586621683070609"><span class="hs-identifier hs-var">pls</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span class="hs-special">{</span><span id="local-6989586621683070610"><span id="local-6989586621683070611"><span id="local-6989586621683070612"><span id="local-6989586621683070613"><span id="local-6989586621683070614"><span class="annot"><span class="annottext">[(String, String)]
PkgsLoaded
LinkableSet
LinkerEnv
linker_env :: LoaderState -&gt; LinkerEnv
pkgs_loaded :: LoaderState -&gt; PkgsLoaded
bcos_loaded :: LoaderState -&gt; LinkableSet
objs_loaded :: LoaderState -&gt; LinkableSet
temp_sos :: LoaderState -&gt; [(String, String)]
linker_env :: LinkerEnv
bcos_loaded :: LinkableSet
objs_loaded :: LinkableSet
pkgs_loaded :: PkgsLoaded
temp_sos :: [(String, String)]
</span><a href="GHC.Linker.Types.html#linker_env"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621683070615"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070615"><span class="hs-identifier hs-var">objs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-811"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070616"><span class="annot"><span class="annottext">unit_env :: UnitEnv
</span><a href="#local-6989586621683070616"><span class="hs-identifier hs-var hs-var hs-var">unit_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; UnitEnv
</span><a href="GHC.Driver.Env.Types.html#hsc_unit_env"><span class="hs-identifier hs-var">hsc_unit_env</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070608"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-812"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070617"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621683070617"><span class="hs-identifier hs-var hs-var hs-var">dflags</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070608"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-813"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070618"><span class="annot"><span class="annottext">logger :: Logger
</span><a href="#local-6989586621683070618"><span class="hs-identifier hs-var hs-var hs-var">logger</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070608"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-814"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070619"><span class="annot"><span class="annottext">tmpfs :: TmpFs
</span><a href="#local-6989586621683070619"><span class="hs-identifier hs-var hs-var hs-var">tmpfs</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; TmpFs
</span><a href="GHC.Driver.Env.Types.html#hsc_tmpfs"><span class="hs-identifier hs-var">hsc_tmpfs</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070608"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-815"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070621"><span class="annot"><span class="annottext">platform :: Platform
</span><a href="#local-6989586621683070621"><span class="hs-identifier hs-var hs-var hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnitEnv -&gt; Platform
</span><a href="GHC.Unit.Env.html#ue_platform"><span class="hs-identifier hs-var">ue_platform</span></a></span><span> </span><span class="annot"><span class="annottext">UnitEnv
</span><a href="#local-6989586621683070616"><span class="hs-identifier hs-var">unit_env</span></a></span><span>
</span><span id="line-816"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070623"><span class="annot"><span class="annottext">minus_ls :: [String]
</span><a href="#local-6989586621683070623"><span class="hs-identifier hs-var hs-var hs-var">minus_ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070624"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'-'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'l'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683070624"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070624"><span class="hs-identifier hs-var">lib</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; [Option]
</span><a href="GHC.Driver.DynFlags.html#ldInputs"><span class="hs-identifier hs-var">ldInputs</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070617"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-817"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070625"><span class="annot"><span class="annottext">minus_big_ls :: [String]
</span><a href="#local-6989586621683070625"><span class="hs-identifier hs-var hs-var hs-var">minus_big_ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070626"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'-'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'L'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683070626"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070626"><span class="hs-identifier hs-var">lib</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; [Option]
</span><a href="GHC.Driver.DynFlags.html#ldInputs"><span class="hs-identifier hs-var">ldInputs</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070617"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-818"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683070627"><span class="annot"><a href="#local-6989586621683070627"><span class="hs-identifier hs-var">soFile</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070628"><span class="annot"><a href="#local-6989586621683070628"><span class="hs-identifier hs-var">libPath</span></a></span></span><span> </span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070629"><span class="annot"><a href="#local-6989586621683070629"><span class="hs-identifier hs-var">libName</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-819"></span><span>      </span><span class="annot"><span class="annottext">Logger
-&gt; TmpFs
-&gt; TempDir
-&gt; TempFileLifetime
-&gt; String
-&gt; IO (String, String, String)
</span><a href="GHC.Utils.TmpFs.html#newTempLibName"><span class="hs-identifier hs-var">newTempLibName</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070618"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621683070619"><span class="hs-identifier hs-var">tmpfs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; TempDir
</span><a href="GHC.Driver.DynFlags.html#tmpDir"><span class="hs-identifier hs-var">tmpDir</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070617"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="GHC.Utils.TmpFs.html#TFL_CurrentModule"><span class="hs-identifier hs-var">TFL_CurrentModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; String
</span><a href="GHC.Platform.html#platformSOExt"><span class="hs-identifier hs-var">platformSOExt</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070621"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-820"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-821"></span><span>        </span><span id="local-6989586621683070634"><span class="annot"><a href="#local-6989586621683070634"><span class="hs-identifier hs-var hs-var">dflags2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070617"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-822"></span><span>                      </span><span class="hs-comment">-- We don't want the original ldInputs in</span><span>
</span><span id="line-823"></span><span>                      </span><span class="hs-comment">-- (they're already linked in), but we do want</span><span>
</span><span id="line-824"></span><span>                      </span><span class="hs-comment">-- to link against previous dynLoadObjs</span><span>
</span><span id="line-825"></span><span>                      </span><span class="hs-comment">-- libraries if there were any, so that the linker</span><span>
</span><span id="line-826"></span><span>                      </span><span class="hs-comment">-- can resolve dependencies when it loads this</span><span>
</span><span id="line-827"></span><span>                      </span><span class="hs-comment">-- library.</span><span>
</span><span id="line-828"></span><span>                      </span><span class="annot"><a href="GHC.Driver.DynFlags.html#ldInputs"><span class="hs-identifier hs-var">ldInputs</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-829"></span><span>                           </span><span class="annot"><span class="hs-identifier hs-type">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683070635"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070635"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-l&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070635"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-830"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">nub</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">snd</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683070614"><span class="hs-identifier hs-type">temp_sos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-831"></span><span>                        </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683070636"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070636"><span class="hs-identifier hs-var">lp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-L&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070636"><span class="hs-identifier hs-var">lp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-832"></span><span>                                          </span><span class="annot"><span class="annottext">Option -&gt; [Option] -&gt; [Option]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; OS -&gt; Bool
</span><a href="GHC.Driver.Session.html#useXLinkerRPath"><span class="hs-identifier hs-var">useXLinkerRPath</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070617"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; OS
</span><a href="GHC.Platform.html#platformOS"><span class="hs-identifier hs-var">platformOS</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070621"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>                                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-Xlinker&quot;</span></span><span>
</span><span id="line-834"></span><span>                                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-rpath&quot;</span></span><span>
</span><span id="line-835"></span><span>                                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-Xlinker&quot;</span></span><span>
</span><span id="line-836"></span><span>                                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070636"><span class="hs-identifier hs-var">lp</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-837"></span><span>                                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-838"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">nub</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">fst</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621683070614"><span class="hs-identifier hs-type">temp_sos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-839"></span><span>                        </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">concatMap</span></span><span>
</span><span id="line-840"></span><span>                             </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683070638"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070638"><span class="hs-identifier hs-var">lp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-L&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070638"><span class="hs-identifier hs-var">lp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-841"></span><span>                                  </span><span class="annot"><span class="annottext">Option -&gt; [Option] -&gt; [Option]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; OS -&gt; Bool
</span><a href="GHC.Driver.Session.html#useXLinkerRPath"><span class="hs-identifier hs-var">useXLinkerRPath</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070617"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; OS
</span><a href="GHC.Platform.html#platformOS"><span class="hs-identifier hs-var">platformOS</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070621"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span>                                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-Xlinker&quot;</span></span><span>
</span><span id="line-843"></span><span>                                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-rpath&quot;</span></span><span>
</span><span id="line-844"></span><span>                                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-Xlinker&quot;</span></span><span>
</span><span id="line-845"></span><span>                                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070638"><span class="hs-identifier hs-var">lp</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-846"></span><span>                                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>                             </span><span class="annot"><a href="#local-6989586621683070625"><span class="hs-identifier hs-type">minus_big_ls</span></a></span><span>
</span><span id="line-848"></span><span>                        </span><span class="hs-comment">-- See Note [-Xlinker -rpath vs -Wl,-rpath]</span><span>
</span><span id="line-849"></span><span>                        </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683070639"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070639"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-l&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070639"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070623"><span class="hs-identifier hs-type">minus_ls</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-850"></span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span>                      </span><span class="hs-comment">-- Add -l options and -L options from dflags.</span><span>
</span><span id="line-853"></span><span>                      </span><span class="hs-comment">--</span><span>
</span><span id="line-854"></span><span>                      </span><span class="hs-comment">-- When running TH for a non-dynamic way, we still</span><span>
</span><span id="line-855"></span><span>                      </span><span class="hs-comment">-- need to make -l flags to link against the dynamic</span><span>
</span><span id="line-856"></span><span>                      </span><span class="hs-comment">-- libraries, so we need to add WayDyn to ways.</span><span>
</span><span id="line-857"></span><span>                      </span><span class="hs-comment">--</span><span>
</span><span id="line-858"></span><span>                      </span><span class="hs-comment">-- Likewise if loading if the profiled way then need to</span><span>
</span><span id="line-859"></span><span>                      </span><span class="hs-comment">-- add WayProf.</span><span>
</span><span id="line-860"></span><span>                      </span><span class="annot"><a href="GHC.Driver.DynFlags.html#targetWays_"><span class="hs-identifier hs-var">targetWays_</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070641"><span class="annot"><a href="#local-6989586621683070641"><span class="hs-identifier hs-var hs-var">ws</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Way -&gt; Ways
forall a. a -&gt; Set a
</span><a href="../../containers-0.7-5a8f/src/Data.Set.Internal.html#singleton"><span class="hs-identifier hs-var">Set.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">Way
</span><a href="GHC.Platform.Ways.html#WayDyn"><span class="hs-identifier hs-var">WayDyn</span></a></span><span>
</span><span id="line-861"></span><span>                                     </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#interpreterProfiled"><span class="hs-identifier hs-type">interpreterProfiled</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070607"><span class="hs-identifier hs-type">interp</span></a></span><span>
</span><span id="line-862"></span><span>                                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Platform.Ways.html#addWay"><span class="hs-identifier hs-type">addWay</span></a></span><span> </span><span class="annot"><a href="GHC.Platform.Ways.html#WayProf"><span class="hs-identifier hs-type">WayProf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070641"><span class="hs-identifier hs-type">ws</span></a></span><span>
</span><span id="line-863"></span><span>                                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="#local-6989586621683070641"><span class="hs-identifier hs-type">ws</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-864"></span><span>                      </span><span class="annot"><a href="GHC.Driver.DynFlags.html#outputFile_"><span class="hs-identifier hs-var">outputFile_</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683070627"><span class="hs-identifier hs-type">soFile</span></a></span><span>
</span><span id="line-865"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-866"></span><span>    </span><span class="hs-comment">-- link all &quot;loaded packages&quot; so symbols in those can be resolved</span><span>
</span><span id="line-867"></span><span>    </span><span class="hs-comment">-- Note: We are loading packages with local scope, so to see the</span><span>
</span><span id="line-868"></span><span>    </span><span class="hs-comment">-- symbols in this link we must link all loaded packages again.</span><span>
</span><span id="line-869"></span><span>    </span><span class="annot"><a href="GHC.Linker.Dynamic.html#linkDynLib"><span class="hs-identifier hs-type">linkDynLib</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070618"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070619"><span class="hs-identifier hs-type">tmpfs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070634"><span class="hs-identifier hs-type">dflags2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070616"><span class="hs-identifier hs-type">unit_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070615"><span class="hs-identifier hs-type">objs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#loaded_pkg_uid"><span class="hs-identifier hs-var">loaded_pkg_uid</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.Types.Unique.DFM.html#eltsUDFM"><span class="hs-identifier hs-type">eltsUDFM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070613"><span class="hs-identifier hs-type">pkgs_loaded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>
</span><span id="line-871"></span><span>    </span><span class="hs-comment">-- if we got this far, extend the lifetime of the library file</span><span>
</span><span id="line-872"></span><span>    </span><span class="annot"><a href="GHC.Utils.TmpFs.html#changeTempFilesLifetime"><span class="hs-identifier hs-type">changeTempFilesLifetime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070619"><span class="hs-identifier hs-type">tmpfs</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TFL_GhcSession"><span class="hs-identifier hs-type">TFL_GhcSession</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683070627"><span class="hs-identifier hs-type">soFile</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-873"></span><span>    </span><span id="local-6989586621683070651"><span class="annot"><a href="#local-6989586621683070651"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadDLL"><span class="hs-identifier hs-type">loadDLL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070607"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070627"><span class="hs-identifier hs-type">soFile</span></a></span><span>
</span><span id="line-874"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683070651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-875"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">RemotePtr LoadedDLL
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; IO LoaderState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LoaderState -&gt; IO LoaderState) -&gt; LoaderState -&gt; IO LoaderState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070609"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#temp_sos"><span class="hs-identifier hs-var">temp_sos</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070628"><span class="hs-identifier hs-type">libPath</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070629"><span class="hs-identifier hs-type">libName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621683070614"><span class="hs-identifier hs-type">temp_sos</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-876"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683070652"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070652"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; IO LoaderState
forall a. String -&gt; String -&gt; IO a
</span><a href="GHC.ByteCode.Linker.html#linkFail"><span class="hs-identifier hs-var">linkFail</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070653"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070652"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-877"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-878"></span><span>    </span><span id="local-6989586621683070653"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621683070653"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GHC.Linker.Loader.dynLoadObjs: Loading temp shared object failed&quot;</span></span><span>
</span><span id="line-879"></span><span>
</span><span id="line-880"></span><span class="annot"><a href="GHC.Linker.Loader.html#rmDupLinkables"><span class="hs-identifier hs-type">rmDupLinkables</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LinkableSet"><span class="hs-identifier hs-type">LinkableSet</span></a></span><span>    </span><span class="hs-comment">-- Already loaded</span><span>
</span><span id="line-881"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- New linkables</span><span>
</span><span id="line-882"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#LinkableSet"><span class="hs-identifier hs-type">LinkableSet</span></a></span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- New loaded set (including new ones)</span><span>
</span><span id="line-883"></span><span>                   </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- New linkables (excluding dups)</span><span>
</span><span id="line-884"></span><span id="rmDupLinkables"><span class="annot"><span class="annottext">rmDupLinkables :: LinkableSet -&gt; [Linkable] -&gt; (LinkableSet, [Linkable])
</span><a href="GHC.Linker.Loader.html#rmDupLinkables"><span class="hs-identifier hs-var hs-var">rmDupLinkables</span></a></span></span><span> </span><span id="local-6989586621683070654"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070654"><span class="hs-identifier hs-var">already</span></a></span></span><span> </span><span id="local-6989586621683070655"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070655"><span class="hs-identifier hs-var">ls</span></a></span></span><span>
</span><span id="line-885"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkableSet
-&gt; [Linkable] -&gt; [Linkable] -&gt; (LinkableSet, [Linkable])
</span><a href="#local-6989586621683070656"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070654"><span class="hs-identifier hs-var">already</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070655"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-886"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-887"></span><span>    </span><span id="local-6989586621683070656"><span class="annot"><span class="annottext">go :: LinkableSet
-&gt; [Linkable] -&gt; [Linkable] -&gt; (LinkableSet, [Linkable])
</span><a href="#local-6989586621683070656"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621683070657"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070657"><span class="hs-identifier hs-var">already</span></a></span></span><span> </span><span id="local-6989586621683070658"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070658"><span class="hs-identifier hs-var">extras</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070657"><span class="hs-identifier hs-var">already</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070658"><span class="hs-identifier hs-var">extras</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-888"></span><span>    </span><span class="annot"><a href="#local-6989586621683070656"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683070659"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070659"><span class="hs-identifier hs-var">already</span></a></span></span><span> </span><span id="local-6989586621683070660"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070660"><span class="hs-identifier hs-var">extras</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683070661"><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070661"><span class="hs-identifier hs-var">l</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683070662"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070662"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-889"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; LinkableSet -&gt; Bool
</span><a href="GHC.Linker.Loader.html#linkableInSet"><span class="hs-identifier hs-var">linkableInSet</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070661"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070659"><span class="hs-identifier hs-var">already</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkableSet
-&gt; [Linkable] -&gt; [Linkable] -&gt; (LinkableSet, [Linkable])
</span><a href="#local-6989586621683070656"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070659"><span class="hs-identifier hs-var">already</span></a></span><span>     </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070660"><span class="hs-identifier hs-var">extras</span></a></span><span>     </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070662"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-890"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkableSet
-&gt; [Linkable] -&gt; [Linkable] -&gt; (LinkableSet, [Linkable])
</span><a href="#local-6989586621683070656"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkableSet -&gt; Module -&gt; Linkable -&gt; LinkableSet
forall a. ModuleEnv a -&gt; Module -&gt; a -&gt; ModuleEnv a
</span><a href="GHC.Unit.Module.Env.html#extendModuleEnv"><span class="hs-identifier hs-var">extendModuleEnv</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070659"><span class="hs-identifier hs-var">already</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Linkable -&gt; Module
</span><a href="GHC.Linker.Types.html#linkableModule"><span class="hs-identifier hs-var">linkableModule</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070661"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070661"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070661"><span class="hs-identifier hs-var">l</span></a></span><span class="annot"><span class="annottext">Linkable -&gt; [Linkable] -&gt; [Linkable]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070660"><span class="hs-identifier hs-var">extras</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070662"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-891"></span><span>
</span><span id="line-892"></span><span class="annot"><span class="hs-comment">{- **********************************************************************

                The byte-code linker

  ********************************************************************* -}</span></span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span>
</span><span id="line-899"></span><span class="annot"><a href="GHC.Linker.Loader.html#dynLinkBCOs"><span class="hs-identifier hs-type">dynLinkBCOs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-900"></span><span id="dynLinkBCOs"><span class="annot"><span class="annottext">dynLinkBCOs :: Interp -&gt; LoaderState -&gt; [Linkable] -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#dynLinkBCOs"><span class="hs-identifier hs-var hs-var">dynLinkBCOs</span></a></span></span><span> </span><span id="local-6989586621683070664"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070664"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070665"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070665"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span id="local-6989586621683070666"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070666"><span class="hs-identifier hs-var">bcos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-901"></span><span>
</span><span id="line-902"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683070667"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070667"><span class="hs-identifier hs-var hs-var">bcos_loaded'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070668"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070668"><span class="hs-identifier hs-var hs-var">new_bcos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkableSet -&gt; [Linkable] -&gt; (LinkableSet, [Linkable])
</span><a href="GHC.Linker.Loader.html#rmDupLinkables"><span class="hs-identifier hs-var">rmDupLinkables</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoaderState -&gt; LinkableSet
</span><a href="GHC.Linker.Types.html#bcos_loaded"><span class="hs-identifier hs-var">bcos_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070665"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070666"><span class="hs-identifier hs-var">bcos</span></a></span><span>
</span><span id="line-903"></span><span>            </span><span id="local-6989586621683070669"><span class="annot"><span class="annottext">pls1 :: LoaderState
</span><a href="#local-6989586621683070669"><span class="hs-identifier hs-var hs-var hs-var">pls1</span></a></span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070665"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#bcos_loaded"><span class="hs-identifier hs-var">bcos_loaded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070667"><span class="hs-identifier hs-type">bcos_loaded'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-904"></span><span>
</span><span id="line-905"></span><span>            </span><span class="annot"><a href="#local-6989586621683070670"><span class="hs-identifier hs-type">parts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#LinkablePart"><span class="hs-identifier hs-type">LinkablePart</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-906"></span><span>            </span><span id="local-6989586621683070670"><span class="annot"><span class="annottext">parts :: [LinkablePart]
</span><a href="#local-6989586621683070670"><span class="hs-identifier hs-var hs-var hs-var">parts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Linkable -&gt; [LinkablePart]) -&gt; [Linkable] -&gt; [LinkablePart]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty LinkablePart -&gt; [LinkablePart]
forall a. NonEmpty a -&gt; [a]
</span><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html#toList"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty LinkablePart -&gt; [LinkablePart])
-&gt; (Linkable -&gt; NonEmpty LinkablePart)
-&gt; Linkable
-&gt; [LinkablePart]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; NonEmpty LinkablePart
</span><a href="GHC.Linker.Types.html#linkableParts"><span class="hs-identifier hs-var">linkableParts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070668"><span class="hs-identifier hs-var">new_bcos</span></a></span><span>
</span><span id="line-907"></span><span>
</span><span id="line-908"></span><span>            </span><span class="annot"><a href="#local-6989586621683070673"><span class="hs-identifier hs-type">cbcs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.ByteCode.Types.html#CompiledByteCode"><span class="hs-identifier hs-type">CompiledByteCode</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-909"></span><span>            </span><span id="local-6989586621683070673"><span class="annot"><span class="annottext">cbcs :: [CompiledByteCode]
</span><a href="#local-6989586621683070673"><span class="hs-identifier hs-var hs-var hs-var">cbcs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LinkablePart -&gt; [CompiledByteCode])
-&gt; [LinkablePart] -&gt; [CompiledByteCode]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">LinkablePart -&gt; [CompiledByteCode]
</span><a href="GHC.Linker.Types.html#linkablePartAllBCOs"><span class="hs-identifier hs-var">linkablePartAllBCOs</span></a></span><span> </span><span class="annot"><span class="annottext">[LinkablePart]
</span><a href="#local-6989586621683070670"><span class="hs-identifier hs-var">parts</span></a></span><span>
</span><span id="line-910"></span><span>
</span><span id="line-911"></span><span>
</span><span id="line-912"></span><span>            </span><span id="local-6989586621683070675"><span class="annot"><span class="annottext">le1 :: LinkerEnv
</span><a href="#local-6989586621683070675"><span class="hs-identifier hs-var hs-var hs-var">le1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState -&gt; LinkerEnv
</span><a href="GHC.Linker.Types.html#linker_env"><span class="hs-identifier hs-var">linker_env</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070665"><span class="hs-identifier hs-var">pls</span></a></span><span>
</span><span id="line-913"></span><span>            </span><span id="local-6989586621683070676"><span class="annot"><span class="annottext">ie2 :: ItblEnv
</span><a href="#local-6989586621683070676"><span class="hs-identifier hs-var hs-var hs-var">ie2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ItblEnv -&gt; ItblEnv -&gt; ItblEnv) -&gt; ItblEnv -&gt; [ItblEnv] -&gt; ItblEnv
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">ItblEnv -&gt; ItblEnv -&gt; ItblEnv
forall a. NameEnv a -&gt; NameEnv a -&gt; NameEnv a
</span><a href="GHC.Types.Name.Env.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkerEnv -&gt; ItblEnv
</span><a href="GHC.Linker.Types.html#itbl_env"><span class="hs-identifier hs-var">itbl_env</span></a></span><span> </span><span class="annot"><span class="annottext">LinkerEnv
</span><a href="#local-6989586621683070675"><span class="hs-identifier hs-var">le1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CompiledByteCode -&gt; ItblEnv) -&gt; [CompiledByteCode] -&gt; [ItblEnv]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CompiledByteCode -&gt; ItblEnv
</span><a href="GHC.ByteCode.Types.html#bc_itbls"><span class="hs-identifier hs-var">bc_itbls</span></a></span><span> </span><span class="annot"><span class="annottext">[CompiledByteCode]
</span><a href="#local-6989586621683070673"><span class="hs-identifier hs-var">cbcs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>            </span><span id="local-6989586621683070678"><span class="annot"><span class="annottext">ae2 :: AddrEnv
</span><a href="#local-6989586621683070678"><span class="hs-identifier hs-var hs-var hs-var">ae2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AddrEnv -&gt; AddrEnv -&gt; AddrEnv) -&gt; AddrEnv -&gt; [AddrEnv] -&gt; AddrEnv
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">AddrEnv -&gt; AddrEnv -&gt; AddrEnv
forall a. NameEnv a -&gt; NameEnv a -&gt; NameEnv a
</span><a href="GHC.Types.Name.Env.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkerEnv -&gt; AddrEnv
</span><a href="GHC.Linker.Types.html#addr_env"><span class="hs-identifier hs-var">addr_env</span></a></span><span> </span><span class="annot"><span class="annottext">LinkerEnv
</span><a href="#local-6989586621683070675"><span class="hs-identifier hs-var">le1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CompiledByteCode -&gt; AddrEnv) -&gt; [CompiledByteCode] -&gt; [AddrEnv]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CompiledByteCode -&gt; AddrEnv
</span><a href="GHC.ByteCode.Types.html#bc_strs"><span class="hs-identifier hs-var">bc_strs</span></a></span><span> </span><span class="annot"><span class="annottext">[CompiledByteCode]
</span><a href="#local-6989586621683070673"><span class="hs-identifier hs-var">cbcs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-915"></span><span>            </span><span id="local-6989586621683070679"><span class="annot"><span class="annottext">le2 :: LinkerEnv
</span><a href="#local-6989586621683070679"><span class="hs-identifier hs-var hs-var hs-var">le2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkerEnv
</span><a href="#local-6989586621683070675"><span class="hs-identifier hs-var">le1</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#itbl_env"><span class="hs-identifier hs-var">itbl_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070676"><span class="hs-identifier hs-type">ie2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#addr_env"><span class="hs-identifier hs-var">addr_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070678"><span class="hs-identifier hs-type">ae2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-916"></span><span>
</span><span id="line-917"></span><span>        </span><span id="local-6989586621683070680"><span class="annot"><a href="#local-6989586621683070680"><span class="hs-identifier hs-var">names_and_refs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp
-&gt; PkgsLoaded
-&gt; LinkerEnv
-&gt; [CompiledByteCode]
-&gt; IO [(Name, HValueRef)]
</span><a href="GHC.Linker.Loader.html#linkSomeBCOs"><span class="hs-identifier hs-var">linkSomeBCOs</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070664"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoaderState -&gt; PkgsLoaded
</span><a href="GHC.Linker.Types.html#pkgs_loaded"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070665"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LinkerEnv
</span><a href="#local-6989586621683070679"><span class="hs-identifier hs-var">le2</span></a></span><span> </span><span class="annot"><span class="annottext">[CompiledByteCode]
</span><a href="#local-6989586621683070673"><span class="hs-identifier hs-var">cbcs</span></a></span><span>
</span><span id="line-918"></span><span>
</span><span id="line-919"></span><span>        </span><span class="hs-comment">-- We only want to add the external ones to the ClosureEnv</span><span>
</span><span id="line-920"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683070681"><span class="annot"><a href="#local-6989586621683070681"><span class="hs-identifier hs-var">to_add</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070682"><span class="annot"><a href="#local-6989586621683070682"><span class="hs-identifier hs-var">to_drop</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">partition</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-type">isExternalName</span></a></span><span class="annot"><span class="hs-operator hs-type">.</span></span><span class="annot"><span class="hs-identifier hs-type">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070680"><span class="hs-identifier hs-type">names_and_refs</span></a></span><span>
</span><span id="line-921"></span><span>
</span><span id="line-922"></span><span>        </span><span class="hs-comment">-- Immediately release any HValueRefs we're not going to add</span><span>
</span><span id="line-923"></span><span>        </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#freeHValueRefs"><span class="hs-identifier hs-type">freeHValueRefs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070664"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">snd</span></span><span> </span><span class="annot"><a href="#local-6989586621683070682"><span class="hs-identifier hs-type">to_drop</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-924"></span><span>        </span><span class="hs-comment">-- Wrap finalizers on the ones we want to keep</span><span>
</span><span id="line-925"></span><span>        </span><span id="local-6989586621683070684"><span class="annot"><a href="#local-6989586621683070684"><span class="hs-identifier hs-var">new_binds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#makeForeignNamedHValueRefs"><span class="hs-identifier hs-type">makeForeignNamedHValueRefs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070664"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070681"><span class="hs-identifier hs-type">to_add</span></a></span><span>
</span><span id="line-926"></span><span>
</span><span id="line-927"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070685"><span class="annot"><a href="#local-6989586621683070685"><span class="hs-identifier hs-var hs-var">ce2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClosureEnv -&gt; [(Name, ForeignHValue)] -&gt; ClosureEnv
</span><a href="GHC.Linker.Types.html#extendClosureEnv"><span class="hs-identifier hs-var">extendClosureEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkerEnv -&gt; ClosureEnv
</span><a href="GHC.Linker.Types.html#closure_env"><span class="hs-identifier hs-var">closure_env</span></a></span><span> </span><span class="annot"><span class="annottext">LinkerEnv
</span><a href="#local-6989586621683070679"><span class="hs-identifier hs-var">le2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, ForeignHValue)]
</span><a href="#local-6989586621683070684"><span class="hs-identifier hs-var">new_binds</span></a></span><span>
</span><span id="line-928"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="annot"><a href="#local-6989586621683070669"><span class="hs-identifier hs-type">pls1</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#linker_env"><span class="hs-identifier hs-var">linker_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070679"><span class="hs-identifier hs-type">le2</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#closure_env"><span class="hs-identifier hs-var">closure_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070685"><span class="hs-identifier hs-type">ce2</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span class="hs-comment">-- Link a bunch of BCOs and return references to their values</span><span>
</span><span id="line-931"></span><span class="annot"><a href="GHC.Linker.Loader.html#linkSomeBCOs"><span class="hs-identifier hs-type">linkSomeBCOs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-932"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#PkgsLoaded"><span class="hs-identifier hs-type">PkgsLoaded</span></a></span><span>
</span><span id="line-933"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LinkerEnv"><span class="hs-identifier hs-type">LinkerEnv</span></a></span><span>
</span><span id="line-934"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.ByteCode.Types.html#CompiledByteCode"><span class="hs-identifier hs-type">CompiledByteCode</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-935"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-936"></span><span>                        </span><span class="hs-comment">-- The returned HValueRefs are associated 1-1 with</span><span>
</span><span id="line-937"></span><span>                        </span><span class="hs-comment">-- the incoming unlinked BCOs.  Each gives the</span><span>
</span><span id="line-938"></span><span>                        </span><span class="hs-comment">-- value of the corresponding unlinked BCO</span><span>
</span><span id="line-939"></span><span>
</span><span id="line-940"></span><span id="linkSomeBCOs"><span class="annot"><span class="annottext">linkSomeBCOs :: Interp
-&gt; PkgsLoaded
-&gt; LinkerEnv
-&gt; [CompiledByteCode]
-&gt; IO [(Name, HValueRef)]
</span><a href="GHC.Linker.Loader.html#linkSomeBCOs"><span class="hs-identifier hs-var hs-var">linkSomeBCOs</span></a></span></span><span> </span><span id="local-6989586621683070686"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070686"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070687"><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070687"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span></span><span> </span><span id="local-6989586621683070688"><span class="annot"><span class="annottext">LinkerEnv
</span><a href="#local-6989586621683070688"><span class="hs-identifier hs-var">le</span></a></span></span><span> </span><span id="local-6989586621683070689"><span class="annot"><span class="annottext">[CompiledByteCode]
</span><a href="#local-6989586621683070689"><span class="hs-identifier hs-var">mods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CompiledByteCode
 -&gt; ([[UnlinkedBCO]] -&gt; IO [(Name, HValueRef)])
 -&gt; [[UnlinkedBCO]]
 -&gt; IO [(Name, HValueRef)])
-&gt; ([[UnlinkedBCO]] -&gt; IO [(Name, HValueRef)])
-&gt; [CompiledByteCode]
-&gt; [[UnlinkedBCO]]
-&gt; IO [(Name, HValueRef)]
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">CompiledByteCode
-&gt; ([[UnlinkedBCO]] -&gt; IO [(Name, HValueRef)])
-&gt; [[UnlinkedBCO]]
-&gt; IO [(Name, HValueRef)]
forall {t}.
CompiledByteCode -&gt; ([[UnlinkedBCO]] -&gt; t) -&gt; [[UnlinkedBCO]] -&gt; t
</span><a href="#local-6989586621683070690"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">[[UnlinkedBCO]] -&gt; IO [(Name, HValueRef)]
</span><a href="#local-6989586621683070691"><span class="hs-identifier hs-var">do_link</span></a></span><span> </span><span class="annot"><span class="annottext">[CompiledByteCode]
</span><a href="#local-6989586621683070689"><span class="hs-identifier hs-var">mods</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-941"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-942"></span><span>  </span><span id="local-6989586621683070690"><span class="annot"><span class="annottext">fun :: CompiledByteCode -&gt; ([[UnlinkedBCO]] -&gt; t) -&gt; [[UnlinkedBCO]] -&gt; t
</span><a href="#local-6989586621683070690"><span class="hs-identifier hs-var hs-var">fun</span></a></span></span><span> </span><span class="annot"><a href="GHC.ByteCode.Types.html#CompiledByteCode"><span class="hs-identifier hs-type">CompiledByteCode</span></a></span><span class="hs-special">{</span><span id="local-6989586621683070694"><span id="local-6989586621683070695"><span id="local-6989586621683070696"><span id="local-6989586621683070697"><span id="local-6989586621683070698"><span id="local-6989586621683070699"><span class="annot"><span class="annottext">[SptEntry]
[FFIInfo]
Maybe ModBreaks
AddrEnv
ItblEnv
FlatBag UnlinkedBCO
bc_itbls :: CompiledByteCode -&gt; ItblEnv
bc_strs :: CompiledByteCode -&gt; AddrEnv
bc_bcos :: CompiledByteCode -&gt; FlatBag UnlinkedBCO
bc_bcos :: FlatBag UnlinkedBCO
bc_itbls :: ItblEnv
bc_ffis :: [FFIInfo]
bc_strs :: AddrEnv
bc_breaks :: Maybe ModBreaks
bc_spt_entries :: [SptEntry]
bc_spt_entries :: CompiledByteCode -&gt; [SptEntry]
bc_breaks :: CompiledByteCode -&gt; Maybe ModBreaks
bc_ffis :: CompiledByteCode -&gt; [FFIInfo]
</span><a href="GHC.ByteCode.Types.html#bc_itbls"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621683070703"><span class="annot"><span class="annottext">[[UnlinkedBCO]] -&gt; t
</span><a href="#local-6989586621683070703"><span class="hs-identifier hs-var">inner</span></a></span></span><span> </span><span id="local-6989586621683070704"><span class="annot"><span class="annottext">[[UnlinkedBCO]]
</span><a href="#local-6989586621683070704"><span class="hs-identifier hs-var">accum</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-943"></span><span>    </span><span class="annot"><span class="annottext">[[UnlinkedBCO]] -&gt; t
</span><a href="#local-6989586621683070703"><span class="hs-identifier hs-var">inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlatBag UnlinkedBCO -&gt; [UnlinkedBCO]
forall a. FlatBag a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">Foldable.toList</span></span><span> </span><span class="annot"><span class="annottext">FlatBag UnlinkedBCO
</span><a href="#local-6989586621683070694"><span class="hs-identifier hs-var">bc_bcos</span></a></span><span> </span><span class="annot"><span class="annottext">[UnlinkedBCO] -&gt; [[UnlinkedBCO]] -&gt; [[UnlinkedBCO]]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[[UnlinkedBCO]]
</span><a href="#local-6989586621683070704"><span class="hs-identifier hs-var">accum</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>
</span><span id="line-945"></span><span>  </span><span id="local-6989586621683070691"><span class="annot"><span class="annottext">do_link :: [[UnlinkedBCO]] -&gt; IO [(Name, HValueRef)]
</span><a href="#local-6989586621683070691"><span class="hs-identifier hs-var hs-var">do_link</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, HValueRef)] -&gt; IO [(Name, HValueRef)]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-946"></span><span>  </span><span class="annot"><a href="#local-6989586621683070691"><span class="hs-identifier hs-var">do_link</span></a></span><span> </span><span id="local-6989586621683070706"><span class="annot"><span class="annottext">[[UnlinkedBCO]]
</span><a href="#local-6989586621683070706"><span class="hs-identifier hs-var">mods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-947"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070707"><span class="annot"><span class="annottext">flat :: [UnlinkedBCO]
</span><a href="#local-6989586621683070707"><span class="hs-identifier hs-var hs-var hs-var">flat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">UnlinkedBCO
</span><a href="#local-6989586621683070708"><span class="hs-identifier hs-var">bco</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683070709"><span class="annot"><span class="annottext">[UnlinkedBCO]
</span><a href="#local-6989586621683070709"><span class="hs-identifier hs-var">bcos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[[UnlinkedBCO]]
</span><a href="#local-6989586621683070706"><span class="hs-identifier hs-var">mods</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070708"><span class="annot"><span class="annottext">UnlinkedBCO
</span><a href="#local-6989586621683070708"><span class="hs-identifier hs-var">bco</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[UnlinkedBCO]
</span><a href="#local-6989586621683070709"><span class="hs-identifier hs-var">bcos</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-948"></span><span>        </span><span id="local-6989586621683070710"><span class="annot"><span class="annottext">names :: [Name]
</span><a href="#local-6989586621683070710"><span class="hs-identifier hs-var hs-var hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UnlinkedBCO -&gt; Name) -&gt; [UnlinkedBCO] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">UnlinkedBCO -&gt; Name
</span><a href="GHC.ByteCode.Types.html#unlinkedBCOName"><span class="hs-identifier hs-var">unlinkedBCOName</span></a></span><span> </span><span class="annot"><span class="annottext">[UnlinkedBCO]
</span><a href="#local-6989586621683070707"><span class="hs-identifier hs-var">flat</span></a></span><span>
</span><span id="line-949"></span><span>        </span><span id="local-6989586621683070711"><span class="annot"><span class="annottext">bco_ix :: NameEnv Int
</span><a href="#local-6989586621683070711"><span class="hs-identifier hs-var hs-var hs-var">bco_ix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Int)] -&gt; NameEnv Int
forall a. [(Name, a)] -&gt; NameEnv a
</span><a href="GHC.Types.Name.Env.html#mkNameEnv"><span class="hs-identifier hs-var">mkNameEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; [Int] -&gt; [(Name, Int)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621683070710"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-950"></span><span>    </span><span id="local-6989586621683070712"><span class="annot"><a href="#local-6989586621683070712"><span class="hs-identifier hs-var">resolved</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[IO ResolvedBCO] -&gt; IO [ResolvedBCO]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
forall (m :: * -&gt; *) a. Monad m =&gt; [m a] -&gt; m [a]
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Interp
-&gt; PkgsLoaded
-&gt; LinkerEnv
-&gt; NameEnv Int
-&gt; UnlinkedBCO
-&gt; IO ResolvedBCO
</span><a href="GHC.ByteCode.Linker.html#linkBCO"><span class="hs-identifier hs-var">linkBCO</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070686"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070687"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">LinkerEnv
</span><a href="#local-6989586621683070688"><span class="hs-identifier hs-var">le</span></a></span><span> </span><span class="annot"><span class="annottext">NameEnv Int
</span><a href="#local-6989586621683070711"><span class="hs-identifier hs-var">bco_ix</span></a></span><span> </span><span class="annot"><span class="annottext">UnlinkedBCO
</span><a href="#local-6989586621683070713"><span class="hs-identifier hs-var">bco</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683070713"><span class="annot"><span class="annottext">UnlinkedBCO
</span><a href="#local-6989586621683070713"><span class="hs-identifier hs-var">bco</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[UnlinkedBCO]
</span><a href="#local-6989586621683070707"><span class="hs-identifier hs-var">flat</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-951"></span><span>    </span><span id="local-6989586621683070714"><span class="annot"><a href="#local-6989586621683070714"><span class="hs-identifier hs-var">hvrefs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#createBCOs"><span class="hs-identifier hs-type">createBCOs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070686"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070712"><span class="hs-identifier hs-type">resolved</span></a></span><span>
</span><span id="line-952"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">zip</span></span><span> </span><span class="annot"><a href="#local-6989586621683070710"><span class="hs-identifier hs-type">names</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070714"><span class="hs-identifier hs-type">hvrefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-953"></span><span>
</span><span id="line-954"></span><span class="annot"><span class="hs-comment">-- | Useful to apply to the result of 'linkSomeBCOs'</span></span><span>
</span><span id="line-955"></span><span class="annot"><a href="GHC.Linker.Loader.html#makeForeignNamedHValueRefs"><span class="hs-identifier hs-type">makeForeignNamedHValueRefs</span></a></span><span>
</span><span id="line-956"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-957"></span><span id="makeForeignNamedHValueRefs"><span class="annot"><span class="annottext">makeForeignNamedHValueRefs :: Interp -&gt; [(Name, HValueRef)] -&gt; IO [(Name, ForeignHValue)]
</span><a href="GHC.Linker.Loader.html#makeForeignNamedHValueRefs"><span class="hs-identifier hs-var hs-var">makeForeignNamedHValueRefs</span></a></span></span><span> </span><span id="local-6989586621683070715"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070715"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070716"><span class="annot"><span class="annottext">[(Name, HValueRef)]
</span><a href="#local-6989586621683070716"><span class="hs-identifier hs-var">bindings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-958"></span><span>  </span><span class="annot"><span class="annottext">((Name, HValueRef) -&gt; IO (Name, ForeignHValue))
-&gt; [(Name, HValueRef)] -&gt; IO [(Name, ForeignHValue)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621683070717"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070717"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070718"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621683070718"><span class="hs-identifier hs-var">hvref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070717"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ForeignHValue -&gt; (Name, ForeignHValue))
-&gt; IO ForeignHValue -&gt; IO (Name, ForeignHValue)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Interp -&gt; HValueRef -&gt; IO ForeignHValue
forall a. Interp -&gt; RemoteRef a -&gt; IO (ForeignRef a)
</span><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070715"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621683070718"><span class="hs-identifier hs-var">hvref</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, HValueRef)]
</span><a href="#local-6989586621683070716"><span class="hs-identifier hs-var">bindings</span></a></span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span class="annot"><span class="hs-comment">{- **********************************************************************

                Unload some object modules

  ********************************************************************* -}</span></span><span>
</span><span id="line-965"></span><span>
</span><span id="line-966"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-967"></span><span class="hs-comment">-- | Unloading old objects ready for a new compilation sweep.</span><span>
</span><span id="line-968"></span><span class="hs-comment">--</span><span>
</span><span id="line-969"></span><span class="hs-comment">-- The compilation manager provides us with a list of linkables that it</span><span>
</span><span id="line-970"></span><span class="hs-comment">-- considers \&quot;stable\&quot;, i.e. won't be recompiled this time around.  For</span><span>
</span><span id="line-971"></span><span class="hs-comment">-- each of the modules current linked in memory,</span><span>
</span><span id="line-972"></span><span class="hs-comment">--</span><span>
</span><span id="line-973"></span><span class="hs-comment">--   * if the linkable is stable (and it's the same one -- the user may have</span><span>
</span><span id="line-974"></span><span class="hs-comment">--     recompiled the module on the side), we keep it,</span><span>
</span><span id="line-975"></span><span class="hs-comment">--</span><span>
</span><span id="line-976"></span><span class="hs-comment">--   * otherwise, we unload it.</span><span>
</span><span id="line-977"></span><span class="hs-comment">--</span><span>
</span><span id="line-978"></span><span class="hs-comment">--   * we also implicitly unload all temporary bindings at this point.</span><span>
</span><span id="line-979"></span><span class="hs-comment">--</span><span>
</span><span id="line-980"></span><span class="annot"><a href="GHC.Linker.Loader.html#unload"><span class="hs-identifier hs-type">unload</span></a></span><span>
</span><span id="line-981"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-982"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span>
</span><span id="line-983"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ The linkables to *keep*.</span></span><span>
</span><span id="line-984"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-985"></span><span id="unload"><span class="annot"><span class="annottext">unload :: Interp -&gt; HscEnv -&gt; [Linkable] -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#unload"><span class="hs-identifier hs-var hs-var">unload</span></a></span></span><span> </span><span id="local-6989586621683070719"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070719"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070720"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070720"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070721"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070721"><span class="hs-identifier hs-var">linkables</span></a></span></span><span>
</span><span id="line-986"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- mask, so we're safe from Ctrl-C in here</span><span>
</span><span id="line-987"></span><span>
</span><span id="line-988"></span><span>        </span><span class="hs-comment">-- Initialise the linker (if it's not been done already)</span><span>
</span><span id="line-989"></span><span>        </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier hs-var">initLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070719"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070720"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span>        </span><span id="local-6989586621683070722"><span class="annot"><a href="#local-6989586621683070722"><span class="hs-identifier hs-var">new_pls</span></a></span></span><span>
</span><span id="line-992"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp
-&gt; (LoaderState -&gt; IO (LoaderState, LoaderState)) -&gt; IO LoaderState
forall a. Interp -&gt; (LoaderState -&gt; IO (LoaderState, a)) -&gt; IO a
</span><a href="GHC.Linker.Loader.html#modifyLoaderState"><span class="hs-identifier hs-var">modifyLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070719"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">((LoaderState -&gt; IO (LoaderState, LoaderState)) -&gt; IO LoaderState)
-&gt; (LoaderState -&gt; IO (LoaderState, LoaderState)) -&gt; IO LoaderState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070723"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070723"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-993"></span><span>                 </span><span id="local-6989586621683070724"><span class="annot"><a href="#local-6989586621683070724"><span class="hs-identifier hs-var">pls1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; [Linkable] -&gt; LoaderState -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#unload_wkr"><span class="hs-identifier hs-var">unload_wkr</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070719"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070721"><span class="hs-identifier hs-var">linkables</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070723"><span class="hs-identifier hs-var">pls</span></a></span><span>
</span><span id="line-994"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070724"><span class="hs-identifier hs-type">pls1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070724"><span class="hs-identifier hs-type">pls1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-995"></span><span>
</span><span id="line-996"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070725"><span class="annot"><a href="#local-6989586621683070725"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070720"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-997"></span><span>        </span><span class="annot"><a href="GHC.Utils.Error.html#debugTraceMsg"><span class="hs-identifier hs-type">debugTraceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070725"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-998"></span><span>          </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;unload: retaining objs&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Env.html#moduleEnvElts"><span class="hs-identifier hs-type">moduleEnvElts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#objs_loaded"><span class="hs-identifier hs-var">objs_loaded</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070722"><span class="hs-identifier hs-type">new_pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-999"></span><span>        </span><span class="annot"><a href="GHC.Utils.Error.html#debugTraceMsg"><span class="hs-identifier hs-type">debugTraceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070725"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1000"></span><span>          </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;unload: retaining bcos&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Env.html#moduleEnvElts"><span class="hs-identifier hs-type">moduleEnvElts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#bcos_loaded"><span class="hs-identifier hs-var">bcos_loaded</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070722"><span class="hs-identifier hs-type">new_pls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1001"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>
</span><span id="line-1003"></span><span class="annot"><a href="GHC.Linker.Loader.html#unload_wkr"><span class="hs-identifier hs-type">unload_wkr</span></a></span><span>
</span><span id="line-1004"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-1005"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- stable linkables</span><span>
</span><span id="line-1006"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-1007"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-1008"></span><span class="hs-comment">-- Does the core unload business</span><span>
</span><span id="line-1009"></span><span class="hs-comment">-- (the wrapper blocks exceptions and deals with the LS get and put)</span><span>
</span><span id="line-1010"></span><span>
</span><span id="line-1011"></span><span id="unload_wkr"><span class="annot"><span class="annottext">unload_wkr :: Interp -&gt; [Linkable] -&gt; LoaderState -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#unload_wkr"><span class="hs-identifier hs-var hs-var">unload_wkr</span></a></span></span><span> </span><span id="local-6989586621683070726"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070726"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070727"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070727"><span class="hs-identifier hs-var">keep_linkables</span></a></span></span><span> </span><span id="local-6989586621683070728"><span class="annot"><span class="annottext">pls :: LoaderState
</span><a href="#local-6989586621683070728"><span class="hs-identifier hs-var">pls</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span class="hs-special">{</span><span id="local-6989586621683070729"><span id="local-6989586621683070730"><span id="local-6989586621683070731"><span id="local-6989586621683070732"><span id="local-6989586621683070733"><span class="annot"><span class="annottext">[(String, String)]
PkgsLoaded
LinkableSet
LinkerEnv
linker_env :: LoaderState -&gt; LinkerEnv
pkgs_loaded :: LoaderState -&gt; PkgsLoaded
bcos_loaded :: LoaderState -&gt; LinkableSet
objs_loaded :: LoaderState -&gt; LinkableSet
temp_sos :: LoaderState -&gt; [(String, String)]
linker_env :: LinkerEnv
bcos_loaded :: LinkableSet
objs_loaded :: LinkableSet
pkgs_loaded :: PkgsLoaded
temp_sos :: [(String, String)]
</span><a href="GHC.Linker.Types.html#linker_env"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1012"></span><span>  </span><span class="hs-comment">-- NB. careful strictness here to avoid keeping the old LS when</span><span>
</span><span id="line-1013"></span><span>  </span><span class="hs-comment">-- we're unloading some code.  -fghci-leak-check with the tests in</span><span>
</span><span id="line-1014"></span><span>  </span><span class="hs-comment">-- testsuite/ghci can detect space leaks here.</span><span>
</span><span id="line-1015"></span><span>
</span><span id="line-1016"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683070734"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070734"><span class="hs-identifier hs-var hs-var">objs_to_keep'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070735"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070735"><span class="hs-identifier hs-var hs-var">bcos_to_keep'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Linkable -&gt; Bool) -&gt; [Linkable] -&gt; ([Linkable], [Linkable])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">partition</span></span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; Bool
</span><a href="GHC.Linker.Types.html#linkableIsNativeCodeOnly"><span class="hs-identifier hs-var">linkableIsNativeCodeOnly</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070727"><span class="hs-identifier hs-var">keep_linkables</span></a></span><span>
</span><span id="line-1017"></span><span>      </span><span id="local-6989586621683070737"><span class="annot"><span class="annottext">objs_to_keep :: LinkableSet
</span><a href="#local-6989586621683070737"><span class="hs-identifier hs-var hs-var hs-var">objs_to_keep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Linkable] -&gt; LinkableSet
</span><a href="GHC.Linker.Types.html#mkLinkableSet"><span class="hs-identifier hs-var">mkLinkableSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070734"><span class="hs-identifier hs-var">objs_to_keep'</span></a></span><span>
</span><span id="line-1018"></span><span>      </span><span id="local-6989586621683070739"><span class="annot"><span class="annottext">bcos_to_keep :: LinkableSet
</span><a href="#local-6989586621683070739"><span class="hs-identifier hs-var hs-var hs-var">bcos_to_keep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Linkable] -&gt; LinkableSet
</span><a href="GHC.Linker.Types.html#mkLinkableSet"><span class="hs-identifier hs-var">mkLinkableSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070735"><span class="hs-identifier hs-var">bcos_to_keep'</span></a></span><span>
</span><span id="line-1019"></span><span>
</span><span id="line-1020"></span><span>      </span><span id="local-6989586621683070740"><span class="annot"><span class="annottext">discard :: LinkableSet -&gt; Linkable -&gt; Bool
</span><a href="#local-6989586621683070740"><span class="hs-identifier hs-var hs-var hs-var">discard</span></a></span></span><span> </span><span id="local-6989586621683070741"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070741"><span class="hs-identifier hs-var">keep</span></a></span></span><span> </span><span id="local-6989586621683070742"><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070742"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Linkable -&gt; LinkableSet -&gt; Bool
</span><a href="GHC.Linker.Loader.html#linkableInSet"><span class="hs-identifier hs-var">linkableInSet</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070742"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070741"><span class="hs-identifier hs-var">keep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1021"></span><span>
</span><span id="line-1022"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683070743"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070743"><span class="hs-identifier hs-var hs-var">objs_to_unload</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070744"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070744"><span class="hs-identifier hs-var hs-var">remaining_objs_loaded</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1023"></span><span>         </span><span class="annot"><span class="annottext">(Linkable -&gt; Bool) -&gt; LinkableSet -&gt; (LinkableSet, LinkableSet)
forall a. (a -&gt; Bool) -&gt; ModuleEnv a -&gt; (ModuleEnv a, ModuleEnv a)
</span><a href="GHC.Unit.Module.Env.html#partitionModuleEnv"><span class="hs-identifier hs-var">partitionModuleEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkableSet -&gt; Linkable -&gt; Bool
</span><a href="#local-6989586621683070740"><span class="hs-identifier hs-var">discard</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070737"><span class="hs-identifier hs-var">objs_to_keep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070731"><span class="hs-identifier hs-var">objs_loaded</span></a></span><span>
</span><span id="line-1024"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683070746"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070746"><span class="hs-identifier hs-var hs-var">bcos_to_unload</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070747"><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070747"><span class="hs-identifier hs-var hs-var">remaining_bcos_loaded</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1025"></span><span>         </span><span class="annot"><span class="annottext">(Linkable -&gt; Bool) -&gt; LinkableSet -&gt; (LinkableSet, LinkableSet)
forall a. (a -&gt; Bool) -&gt; ModuleEnv a -&gt; (ModuleEnv a, ModuleEnv a)
</span><a href="GHC.Unit.Module.Env.html#partitionModuleEnv"><span class="hs-identifier hs-var">partitionModuleEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LinkableSet -&gt; Linkable -&gt; Bool
</span><a href="#local-6989586621683070740"><span class="hs-identifier hs-var">discard</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070739"><span class="hs-identifier hs-var">bcos_to_keep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070730"><span class="hs-identifier hs-var">bcos_loaded</span></a></span><span>
</span><span id="line-1026"></span><span>
</span><span id="line-1027"></span><span>      </span><span id="local-6989586621683070748"><span class="annot"><span class="annottext">linkables_to_unload :: [Linkable]
</span><a href="#local-6989586621683070748"><span class="hs-identifier hs-var hs-var hs-var">linkables_to_unload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LinkableSet -&gt; [Linkable]
forall a. ModuleEnv a -&gt; [a]
</span><a href="GHC.Unit.Module.Env.html#moduleEnvElts"><span class="hs-identifier hs-var">moduleEnvElts</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070743"><span class="hs-identifier hs-var">objs_to_unload</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable] -&gt; [Linkable] -&gt; [Linkable]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">LinkableSet -&gt; [Linkable]
forall a. ModuleEnv a -&gt; [a]
</span><a href="GHC.Unit.Module.Env.html#moduleEnvElts"><span class="hs-identifier hs-var">moduleEnvElts</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070746"><span class="hs-identifier hs-var">bcos_to_unload</span></a></span><span>
</span><span id="line-1028"></span><span>
</span><span id="line-1029"></span><span>  </span><span class="annot"><span class="annottext">(Linkable -&gt; IO ()) -&gt; [Linkable] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; IO ()
</span><a href="#local-6989586621683070749"><span class="hs-identifier hs-var">unloadObjs</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070748"><span class="hs-identifier hs-var">linkables_to_unload</span></a></span><span>
</span><span id="line-1030"></span><span>
</span><span id="line-1031"></span><span>  </span><span class="hs-comment">-- If we unloaded any object files at all, we need to purge the cache</span><span>
</span><span id="line-1032"></span><span>  </span><span class="hs-comment">-- of lookupSymbol results.</span><span>
</span><span id="line-1033"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Linkable] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Linkable -&gt; Bool) -&gt; [Linkable] -&gt; [Linkable]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Linkable -&gt; Bool) -&gt; Linkable -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; Bool) -&gt; (Linkable -&gt; [String]) -&gt; Linkable -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; [String]
</span><a href="GHC.Linker.Types.html#linkableObjs"><span class="hs-identifier hs-var">linkableObjs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621683070748"><span class="hs-identifier hs-var">linkables_to_unload</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1034"></span><span>    </span><span class="annot"><span class="annottext">Interp -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#purgeLookupSymbolCache"><span class="hs-identifier hs-var">purgeLookupSymbolCache</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070726"><span class="hs-identifier hs-var">interp</span></a></span><span>
</span><span id="line-1035"></span><span>
</span><span id="line-1036"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Note that we want to remove all *local*</span><span>
</span><span id="line-1037"></span><span>      </span><span class="hs-comment">-- (i.e. non-isExternal) names too (these are the</span><span>
</span><span id="line-1038"></span><span>      </span><span class="hs-comment">-- temporary bindings from the command line).</span><span>
</span><span id="line-1039"></span><span>      </span><span class="annot"><a href="#local-6989586621683070752"><span class="hs-identifier hs-type">keep_name</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1040"></span><span>      </span><span id="local-6989586621683070752"><span class="annot"><span class="annottext">keep_name :: Name -&gt; Bool
</span><a href="#local-6989586621683070752"><span class="hs-identifier hs-var hs-var">keep_name</span></a></span></span><span> </span><span id="local-6989586621683070753"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070753"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070753"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-1041"></span><span>                    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683070753"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Module -&gt; LinkableSet -&gt; Bool
forall a. Module -&gt; ModuleEnv a -&gt; Bool
</span><a href="GHC.Unit.Module.Env.html#elemModuleEnv"><span class="hs-operator hs-var">`elemModuleEnv`</span></a></span><span> </span><span class="annot"><span class="annottext">LinkableSet
</span><a href="#local-6989586621683070747"><span class="hs-identifier hs-var">remaining_bcos_loaded</span></a></span><span>
</span><span id="line-1042"></span><span>
</span><span id="line-1043"></span><span>      </span><span class="hs-glyph">!</span><span id="local-6989586621683070756"><span class="annot"><span class="annottext">new_pls :: LoaderState
</span><a href="#local-6989586621683070756"><span class="hs-identifier hs-var hs-var">new_pls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070728"><span class="hs-identifier hs-var">pls</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#linker_env"><span class="hs-identifier hs-var">linker_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#filterLinkerEnv"><span class="hs-identifier hs-type">filterLinkerEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070752"><span class="hs-identifier hs-type">keep_name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070729"><span class="hs-identifier hs-type">linker_env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1044"></span><span>                       </span><span class="annot"><a href="GHC.Linker.Types.html#bcos_loaded"><span class="hs-identifier hs-var">bcos_loaded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070747"><span class="hs-identifier hs-type">remaining_bcos_loaded</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1045"></span><span>                       </span><span class="annot"><a href="GHC.Linker.Types.html#objs_loaded"><span class="hs-identifier hs-var">objs_loaded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070744"><span class="hs-identifier hs-type">remaining_objs_loaded</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1046"></span><span>
</span><span id="line-1047"></span><span>  </span><span class="annot"><span class="annottext">LoaderState -&gt; IO LoaderState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070756"><span class="hs-identifier hs-var">new_pls</span></a></span><span>
</span><span id="line-1048"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1049"></span><span>    </span><span class="annot"><a href="#local-6989586621683070749"><span class="hs-identifier hs-type">unloadObjs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1050"></span><span>    </span><span id="local-6989586621683070749"><span class="annot"><span class="annottext">unloadObjs :: Linkable -&gt; IO ()
</span><a href="#local-6989586621683070749"><span class="hs-identifier hs-var hs-var">unloadObjs</span></a></span></span><span> </span><span id="local-6989586621683070758"><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070758"><span class="hs-identifier hs-var">lnk</span></a></span></span><span>
</span><span id="line-1051"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.html#interpreterDynamic"><span class="hs-identifier hs-var">interpreterDynamic</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070726"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1052"></span><span>        </span><span class="hs-comment">-- We don't do any cleanup when linking objects with the</span><span>
</span><span id="line-1053"></span><span>        </span><span class="hs-comment">-- dynamic linker.  Doing so introduces extra complexity for</span><span>
</span><span id="line-1054"></span><span>        </span><span class="hs-comment">-- not much benefit.</span><span>
</span><span id="line-1055"></span><span>
</span><span id="line-1056"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1057"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; [String] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Interp -&gt; String -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#unloadObj"><span class="hs-identifier hs-var">unloadObj</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070726"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Linkable -&gt; [String]
</span><a href="GHC.Linker.Types.html#linkableObjs"><span class="hs-identifier hs-var">linkableObjs</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621683070758"><span class="hs-identifier hs-var">lnk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1058"></span><span>                </span><span class="hs-comment">-- The components of a BCO linkable may contain</span><span>
</span><span id="line-1059"></span><span>                </span><span class="hs-comment">-- dot-o files (generated from C stubs).</span><span>
</span><span id="line-1060"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1061"></span><span>                </span><span class="hs-comment">-- But the BCO parts can be unlinked just by</span><span>
</span><span id="line-1062"></span><span>                </span><span class="hs-comment">-- letting go of them (plus of course depopulating</span><span>
</span><span id="line-1063"></span><span>                </span><span class="hs-comment">-- the symbol table which is done in the main body)</span><span>
</span><span id="line-1064"></span><span>
</span><span id="line-1065"></span><span class="annot"><a href="GHC.Linker.Loader.html#showLS"><span class="hs-identifier hs-type">showLS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-1066"></span><span id="showLS"><span class="annot"><span class="annottext">showLS :: LibrarySpec -&gt; String
</span><a href="GHC.Linker.Loader.html#showLS"><span class="hs-identifier hs-var hs-var">showLS</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#Objects"><span class="hs-identifier hs-type">Objects</span></a></span><span> </span><span id="local-6989586621683070760"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070760"><span class="hs-identifier hs-var">nms</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(static) [&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; String
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">intercalate</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, &quot;</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070760"><span class="hs-identifier hs-var">nms</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;]&quot;</span></span><span>
</span><span id="line-1067"></span><span class="annot"><a href="GHC.Linker.Loader.html#showLS"><span class="hs-identifier hs-var">showLS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#Archive"><span class="hs-identifier hs-type">Archive</span></a></span><span> </span><span id="local-6989586621683070761"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070761"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(static archive) &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070761"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1068"></span><span class="annot"><a href="GHC.Linker.Loader.html#showLS"><span class="hs-identifier hs-var">showLS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#DLL"><span class="hs-identifier hs-type">DLL</span></a></span><span> </span><span id="local-6989586621683070762"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070762"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(dynamic) &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070762"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1069"></span><span class="annot"><a href="GHC.Linker.Loader.html#showLS"><span class="hs-identifier hs-var">showLS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-type">DLLPath</span></a></span><span> </span><span id="local-6989586621683070763"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070763"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(dynamic) &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070763"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1070"></span><span class="annot"><a href="GHC.Linker.Loader.html#showLS"><span class="hs-identifier hs-var">showLS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#Framework"><span class="hs-identifier hs-type">Framework</span></a></span><span> </span><span id="local-6989586621683070764"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070764"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(framework) &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070764"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1071"></span><span>
</span><span id="line-1072"></span><span class="hs-comment">-- | Load exactly the specified packages, and their dependents (unless of</span><span>
</span><span id="line-1073"></span><span class="hs-comment">-- course they are already loaded).  The dependents are loaded</span><span>
</span><span id="line-1074"></span><span class="hs-comment">-- automatically, and it doesn't matter what order you specify the input</span><span>
</span><span id="line-1075"></span><span class="hs-comment">-- packages.</span><span>
</span><span id="line-1076"></span><span class="hs-comment">--</span><span>
</span><span id="line-1077"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadPackages"><span class="hs-identifier hs-type">loadPackages</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Types.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1078"></span><span class="hs-comment">-- NOTE: in fact, since each module tracks all the packages it depends on,</span><span>
</span><span id="line-1079"></span><span class="hs-comment">--       we don't really need to use the package-config dependencies.</span><span>
</span><span id="line-1080"></span><span class="hs-comment">--</span><span>
</span><span id="line-1081"></span><span class="hs-comment">-- However we do need the package-config stuff (to find aux libs etc),</span><span>
</span><span id="line-1082"></span><span class="hs-comment">-- and following them lets us load libraries in the right order, which</span><span>
</span><span id="line-1083"></span><span class="hs-comment">-- perhaps makes the error message a bit more localised if we get a link</span><span>
</span><span id="line-1084"></span><span class="hs-comment">-- failure.  So the dependency walking code is still here.</span><span>
</span><span id="line-1085"></span><span>
</span><span id="line-1086"></span><span id="loadPackages"><span class="annot"><span class="annottext">loadPackages :: Interp -&gt; HscEnv -&gt; [UnitId] -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#loadPackages"><span class="hs-identifier hs-var hs-var">loadPackages</span></a></span></span><span> </span><span id="local-6989586621683070765"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070765"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070766"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070766"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070767"><span class="annot"><span class="annottext">[UnitId]
</span><a href="#local-6989586621683070767"><span class="hs-identifier hs-var">new_pkgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1087"></span><span>  </span><span class="hs-comment">-- It's probably not safe to try to load packages concurrently, so we take</span><span>
</span><span id="line-1088"></span><span>  </span><span class="hs-comment">-- a lock.</span><span>
</span><span id="line-1089"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#initLoaderState"><span class="hs-identifier hs-var">initLoaderState</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070765"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070766"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-1090"></span><span>  </span><span class="annot"><span class="annottext">Interp -&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#modifyLoaderState_"><span class="hs-identifier hs-var">modifyLoaderState_</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070765"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">((LoaderState -&gt; IO LoaderState) -&gt; IO ())
-&gt; (LoaderState -&gt; IO LoaderState) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683070768"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070768"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1091"></span><span>    </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; [UnitId] -&gt; LoaderState -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#loadPackages%27"><span class="hs-identifier hs-var">loadPackages'</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070765"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070766"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">[UnitId]
</span><a href="#local-6989586621683070767"><span class="hs-identifier hs-var">new_pkgs</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070768"><span class="hs-identifier hs-var">pls</span></a></span><span>
</span><span id="line-1092"></span><span>
</span><span id="line-1093"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadPackages%27"><span class="hs-identifier hs-type">loadPackages'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Types.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LoaderState"><span class="hs-identifier hs-type">LoaderState</span></a></span><span>
</span><span id="line-1094"></span><span id="loadPackages%27"><span class="annot"><span class="annottext">loadPackages' :: Interp -&gt; HscEnv -&gt; [UnitId] -&gt; LoaderState -&gt; IO LoaderState
</span><a href="GHC.Linker.Loader.html#loadPackages%27"><span class="hs-identifier hs-var hs-var">loadPackages'</span></a></span></span><span> </span><span id="local-6989586621683070769"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070769"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070770"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070770"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070771"><span class="annot"><span class="annottext">[UnitId]
</span><a href="#local-6989586621683070771"><span class="hs-identifier hs-var">new_pks</span></a></span></span><span> </span><span id="local-6989586621683070772"><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070772"><span class="hs-identifier hs-var">pls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1095"></span><span>    </span><span id="local-6989586621683070773"><span class="annot"><a href="#local-6989586621683070773"><span class="hs-identifier hs-var">pkgs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PkgsLoaded -&gt; [UnitId] -&gt; IO PkgsLoaded
</span><a href="#local-6989586621683070774"><span class="hs-identifier hs-var">link</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoaderState -&gt; PkgsLoaded
</span><a href="GHC.Linker.Types.html#pkgs_loaded"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span><span> </span><span class="annot"><span class="annottext">LoaderState
</span><a href="#local-6989586621683070772"><span class="hs-identifier hs-var">pls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[UnitId]
</span><a href="#local-6989586621683070771"><span class="hs-identifier hs-var">new_pks</span></a></span><span>
</span><span id="line-1096"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$!</span></span><span> </span><span class="annot"><a href="#local-6989586621683070772"><span class="hs-identifier hs-type">pls</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#pkgs_loaded"><span class="hs-identifier hs-var">pkgs_loaded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683070773"><span class="hs-identifier hs-type">pkgs'</span></a></span><span>
</span><span id="line-1097"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-1098"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1099"></span><span>     </span><span class="annot"><a href="#local-6989586621683070774"><span class="hs-identifier hs-type">link</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#PkgsLoaded"><span class="hs-identifier hs-type">PkgsLoaded</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Types.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#PkgsLoaded"><span class="hs-identifier hs-type">PkgsLoaded</span></a></span><span>
</span><span id="line-1100"></span><span>     </span><span id="local-6989586621683070774"><span class="annot"><span class="annottext">link :: PkgsLoaded -&gt; [UnitId] -&gt; IO PkgsLoaded
</span><a href="#local-6989586621683070774"><span class="hs-identifier hs-var hs-var">link</span></a></span></span><span> </span><span id="local-6989586621683070775"><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070775"><span class="hs-identifier hs-var">pkgs</span></a></span></span><span> </span><span id="local-6989586621683070776"><span class="annot"><span class="annottext">[UnitId]
</span><a href="#local-6989586621683070776"><span class="hs-identifier hs-var">new_pkgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1101"></span><span>         </span><span class="annot"><span class="annottext">(PkgsLoaded -&gt; UnitId -&gt; IO PkgsLoaded)
-&gt; PkgsLoaded -&gt; [UnitId] -&gt; IO PkgsLoaded
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded -&gt; UnitId -&gt; IO PkgsLoaded
</span><a href="#local-6989586621683070777"><span class="hs-identifier hs-var">link_one</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070775"><span class="hs-identifier hs-var">pkgs</span></a></span><span> </span><span class="annot"><span class="annottext">[UnitId]
</span><a href="#local-6989586621683070776"><span class="hs-identifier hs-var">new_pkgs</span></a></span><span>
</span><span id="line-1102"></span><span>
</span><span id="line-1103"></span><span>     </span><span id="local-6989586621683070777"><span class="annot"><span class="annottext">link_one :: PkgsLoaded -&gt; UnitId -&gt; IO PkgsLoaded
</span><a href="#local-6989586621683070777"><span class="hs-identifier hs-var hs-var">link_one</span></a></span></span><span> </span><span id="local-6989586621683070778"><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070778"><span class="hs-identifier hs-var">pkgs</span></a></span></span><span> </span><span id="local-6989586621683070779"><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070779"><span class="hs-identifier hs-var">new_pkg</span></a></span></span><span>
</span><span id="line-1104"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070779"><span class="hs-identifier hs-var">new_pkg</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId -&gt; PkgsLoaded -&gt; Bool
forall key elt. Uniquable key =&gt; key -&gt; UniqDFM key elt -&gt; Bool
</span><a href="GHC.Types.Unique.DFM.html#elemUDFM"><span class="hs-operator hs-var">`elemUDFM`</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070778"><span class="hs-identifier hs-var">pkgs</span></a></span><span>   </span><span class="hs-comment">-- Already linked</span><span>
</span><span id="line-1105"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PkgsLoaded -&gt; IO PkgsLoaded
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070778"><span class="hs-identifier hs-var">pkgs</span></a></span><span>
</span><span id="line-1106"></span><span>
</span><span id="line-1107"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683070781"><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070781"><span class="hs-identifier hs-var">pkg_cfg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnitState -&gt; UnitId -&gt; Maybe UnitInfo
</span><a href="GHC.Unit.State.html#lookupUnitId"><span class="hs-identifier hs-var">lookupUnitId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; HscEnv -&gt; UnitState
HscEnv -&gt; UnitState
</span><a href="GHC.Driver.Env.html#hsc_units"><span class="hs-identifier hs-var">hsc_units</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070770"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070779"><span class="hs-identifier hs-var">new_pkg</span></a></span><span>
</span><span id="line-1108"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070783"><span class="annot"><span class="annottext">deps :: [UnitId]
</span><a href="#local-6989586621683070783"><span class="hs-identifier hs-var hs-var hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; [UnitId]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod -&gt; [uid]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitDepends"><span class="hs-identifier hs-var">unitDepends</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070781"><span class="hs-identifier hs-var">pkg_cfg</span></a></span><span>
</span><span id="line-1109"></span><span>               </span><span class="hs-comment">-- Link dependents first</span><span>
</span><span id="line-1110"></span><span>             </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683070785"><span class="annot"><a href="#local-6989586621683070785"><span class="hs-identifier hs-var">pkgs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PkgsLoaded -&gt; [UnitId] -&gt; IO PkgsLoaded
</span><a href="#local-6989586621683070774"><span class="hs-identifier hs-var">link</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070778"><span class="hs-identifier hs-var">pkgs</span></a></span><span> </span><span class="annot"><span class="annottext">[UnitId]
</span><a href="#local-6989586621683070783"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-1111"></span><span>                </span><span class="hs-comment">-- Now link the package itself</span><span>
</span><span id="line-1112"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683070786"><span class="annot"><a href="#local-6989586621683070786"><span class="hs-identifier hs-var">hs_cls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070787"><span class="annot"><a href="#local-6989586621683070787"><span class="hs-identifier hs-var">extra_cls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070788"><span class="annot"><a href="#local-6989586621683070788"><span class="hs-identifier hs-var">loaded_dlls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#loadPackage"><span class="hs-identifier hs-type">loadPackage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070769"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070770"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070781"><span class="hs-identifier hs-type">pkg_cfg</span></a></span><span>
</span><span id="line-1113"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070790"><span class="annot"><a href="#local-6989586621683070790"><span class="hs-identifier hs-var hs-var">trans_deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[UniqDSet UnitId] -&gt; UniqDSet UnitId
forall a. [UniqDSet a] -&gt; UniqDSet a
</span><a href="GHC.Types.Unique.DSet.html#unionManyUniqDSets"><span class="hs-identifier hs-var">unionManyUniqDSets</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">UniqDSet UnitId -&gt; UnitId -&gt; UniqDSet UnitId
forall a. Uniquable a =&gt; UniqDSet a -&gt; a -&gt; UniqDSet a
</span><a href="GHC.Types.Unique.DSet.html#addOneToUniqDSet"><span class="hs-identifier hs-var">addOneToUniqDSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoadedPkgInfo -&gt; UniqDSet UnitId
</span><a href="GHC.Linker.Types.html#loaded_pkg_trans_deps"><span class="hs-identifier hs-var">loaded_pkg_trans_deps</span></a></span><span> </span><span class="annot"><span class="annottext">LoadedPkgInfo
</span><a href="#local-6989586621683070792"><span class="hs-identifier hs-var">loaded_pkg_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070793"><span class="hs-identifier hs-var">dep_pkg</span></a></span><span>
</span><span id="line-1114"></span><span>                                                   </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683070793"><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070793"><span class="hs-identifier hs-var">dep_pkg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[UnitId]
</span><a href="#local-6989586621683070783"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-1115"></span><span>                                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683070792"><span class="annot"><span class="annottext">LoadedPkgInfo
</span><a href="#local-6989586621683070792"><span class="hs-identifier hs-var">loaded_pkg_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe LoadedPkgInfo -&gt; [Maybe LoadedPkgInfo]
forall a. a -&gt; [a]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PkgsLoaded -&gt; UnitId -&gt; Maybe LoadedPkgInfo
forall key elt.
Uniquable key =&gt;
UniqDFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.DFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621683070785"><span class="hs-identifier hs-var">pkgs'</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070793"><span class="hs-identifier hs-var">dep_pkg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1116"></span><span>                                                   </span><span class="hs-special">]</span><span>
</span><span id="line-1117"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Unique.DFM.html#addToUDFM"><span class="hs-identifier hs-type">addToUDFM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070785"><span class="hs-identifier hs-type">pkgs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070779"><span class="hs-identifier hs-type">new_pkg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#LoadedPkgInfo"><span class="hs-identifier hs-type">LoadedPkgInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070779"><span class="hs-identifier hs-type">new_pkg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070786"><span class="hs-identifier hs-type">hs_cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070787"><span class="hs-identifier hs-type">extra_cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070788"><span class="hs-identifier hs-type">loaded_dlls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070790"><span class="hs-identifier hs-type">trans_deps</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1118"></span><span>
</span><span id="line-1119"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1120"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GhcException -&gt; IO PkgsLoaded
forall a. GhcException -&gt; IO a
</span><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-var">throwGhcExceptionIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; GhcException
</span><a href="GHC.Utils.Panic.html#CmdLineError"><span class="hs-identifier hs-var">CmdLineError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unknown package: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; String
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnitId -&gt; FastString
</span><a href="GHC.Unit.Types.html#unitIdFS"><span class="hs-identifier hs-var">unitIdFS</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="#local-6989586621683070779"><span class="hs-identifier hs-var">new_pkg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1121"></span><span>
</span><span id="line-1122"></span><span>
</span><span id="line-1123"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadPackage"><span class="hs-identifier hs-type">loadPackage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Info.html#UnitInfo"><span class="hs-identifier hs-type">UnitInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#LoadedDLL"><span class="hs-identifier hs-type">LoadedDLL</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1124"></span><span id="loadPackage"><span class="annot"><span class="annottext">loadPackage :: Interp
-&gt; HscEnv
-&gt; UnitInfo
-&gt; IO ([LibrarySpec], [LibrarySpec], [RemotePtr LoadedDLL])
</span><a href="GHC.Linker.Loader.html#loadPackage"><span class="hs-identifier hs-var hs-var">loadPackage</span></a></span></span><span> </span><span id="local-6989586621683070796"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070796"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070797"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070797"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070798"><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070798"><span class="hs-identifier hs-var">pkg</span></a></span></span><span>
</span><span id="line-1125"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1126"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070799"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621683070799"><span class="hs-identifier hs-var hs-var hs-var">dflags</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070797"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-1127"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070800"><span class="annot"><span class="annottext">logger :: Logger
</span><a href="#local-6989586621683070800"><span class="hs-identifier hs-var hs-var hs-var">logger</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070797"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-1128"></span><span>            </span><span id="local-6989586621683070801"><span class="annot"><span class="annottext">platform :: Platform
</span><a href="#local-6989586621683070801"><span class="hs-identifier hs-var hs-var hs-var">platform</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Platform
</span><a href="GHC.Driver.DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070799"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1129"></span><span>            </span><span id="local-6989586621683070802"><span class="annot"><span class="annottext">is_dyn :: Bool
</span><a href="#local-6989586621683070802"><span class="hs-identifier hs-var hs-var hs-var">is_dyn</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.html#interpreterDynamic"><span class="hs-identifier hs-var">interpreterDynamic</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070796"><span class="hs-identifier hs-var">interp</span></a></span><span>
</span><span id="line-1130"></span><span>            </span><span id="local-6989586621683070803"><span class="annot"><span class="annottext">dirs :: [String]
</span><a href="#local-6989586621683070803"><span class="hs-identifier hs-var hs-var hs-var">dirs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070802"><span class="hs-identifier hs-var">is_dyn</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePathST -&gt; String) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FilePathST -&gt; String
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.ShortText.html#unpack"><span class="hs-identifier hs-var">ST.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">([FilePathST] -&gt; [String]) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; [FilePathST]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod
-&gt; [FilePathST]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitLibraryDynDirs"><span class="hs-identifier hs-var">Packages.unitLibraryDynDirs</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070798"><span class="hs-identifier hs-var">pkg</span></a></span><span>
</span><span id="line-1131"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePathST -&gt; String) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FilePathST -&gt; String
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.ShortText.html#unpack"><span class="hs-identifier hs-var">ST.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">([FilePathST] -&gt; [String]) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; [FilePathST]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod
-&gt; [FilePathST]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitLibraryDirs"><span class="hs-identifier hs-var">Packages.unitLibraryDirs</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070798"><span class="hs-identifier hs-var">pkg</span></a></span><span>
</span><span id="line-1132"></span><span>
</span><span id="line-1133"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070807"><span class="annot"><span class="annottext">hs_libs :: [String]
</span><a href="#local-6989586621683070807"><span class="hs-identifier hs-var hs-var hs-var">hs_libs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePathST -&gt; String) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FilePathST -&gt; String
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.ShortText.html#unpack"><span class="hs-identifier hs-var">ST.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">([FilePathST] -&gt; [String]) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; [FilePathST]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod
-&gt; [FilePathST]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitLibraries"><span class="hs-identifier hs-var">Packages.unitLibraries</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070798"><span class="hs-identifier hs-var">pkg</span></a></span><span>
</span><span id="line-1134"></span><span>            </span><span class="hs-comment">-- The FFI GHCi import lib isn't needed as</span><span>
</span><span id="line-1135"></span><span>            </span><span class="hs-comment">-- GHC.Linker.Loader + rts/Linker.c link the</span><span>
</span><span id="line-1136"></span><span>            </span><span class="hs-comment">-- interpreted references to FFI to the compiled FFI.</span><span>
</span><span id="line-1137"></span><span>            </span><span class="hs-comment">-- We therefore filter it out so that we don't get</span><span>
</span><span id="line-1138"></span><span>            </span><span class="hs-comment">-- duplicate symbol errors.</span><span>
</span><span id="line-1139"></span><span>            </span><span id="local-6989586621683070809"><span class="annot"><span class="annottext">hs_libs' :: [String]
</span><a href="#local-6989586621683070809"><span class="hs-identifier hs-var hs-var hs-var">hs_libs'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">(String -&gt; Bool) -&gt; [String] -&gt; [String]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;HSffi&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070807"><span class="hs-identifier hs-var">hs_libs</span></a></span><span>
</span><span id="line-1140"></span><span>
</span><span id="line-1141"></span><span>        </span><span class="hs-comment">-- Because of slight differences between the GHC dynamic linker and</span><span>
</span><span id="line-1142"></span><span>        </span><span class="hs-comment">-- the native system linker some packages have to link with a</span><span>
</span><span id="line-1143"></span><span>        </span><span class="hs-comment">-- different list of libraries when using GHCi. Examples include: libs</span><span>
</span><span id="line-1144"></span><span>        </span><span class="hs-comment">-- that are actually gnu ld scripts, and the possibility that the .a</span><span>
</span><span id="line-1145"></span><span>        </span><span class="hs-comment">-- libs do not exactly match the .so/.dll equivalents. So if the</span><span>
</span><span id="line-1146"></span><span>        </span><span class="hs-comment">-- package file provides an &quot;extra-ghci-libraries&quot; field then we use</span><span>
</span><span id="line-1147"></span><span>        </span><span class="hs-comment">-- that instead of the &quot;extra-libraries&quot; field.</span><span>
</span><span id="line-1148"></span><span>            </span><span id="local-6989586621683070810"><span class="annot"><span class="annottext">extdeplibs :: [String]
</span><a href="#local-6989586621683070810"><span class="hs-identifier hs-var hs-var hs-var">extdeplibs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePathST -&gt; String) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FilePathST -&gt; String
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.ShortText.html#unpack"><span class="hs-identifier hs-var">ST.unpack</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[FilePathST] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnitInfo -&gt; [FilePathST]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod
-&gt; [FilePathST]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitExtDepLibsGhc"><span class="hs-identifier hs-var">Packages.unitExtDepLibsGhc</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070798"><span class="hs-identifier hs-var">pkg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1149"></span><span>                                      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; [FilePathST]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod
-&gt; [FilePathST]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitExtDepLibsSys"><span class="hs-identifier hs-var">Packages.unitExtDepLibsSys</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070798"><span class="hs-identifier hs-var">pkg</span></a></span><span>
</span><span id="line-1150"></span><span>                                      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; [FilePathST]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod
-&gt; [FilePathST]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitExtDepLibsGhc"><span class="hs-identifier hs-var">Packages.unitExtDepLibsGhc</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070798"><span class="hs-identifier hs-var">pkg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1151"></span><span>            </span><span id="local-6989586621683070813"><span class="annot"><span class="annottext">linkerlibs :: [String]
</span><a href="#local-6989586621683070813"><span class="hs-identifier hs-var hs-var hs-var">linkerlibs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070814"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'-'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'l'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683070814"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070814"><span class="hs-identifier hs-var">lib</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FilePathST -&gt; String) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FilePathST -&gt; String
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.ShortText.html#unpack"><span class="hs-identifier hs-var">ST.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">([FilePathST] -&gt; [String]) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; [FilePathST]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod
-&gt; [FilePathST]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitLinkerOptions"><span class="hs-identifier hs-var">Packages.unitLinkerOptions</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070798"><span class="hs-identifier hs-var">pkg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1152"></span><span>            </span><span id="local-6989586621683070816"><span class="annot"><span class="annottext">extra_libs :: [String]
</span><a href="#local-6989586621683070816"><span class="hs-identifier hs-var hs-var hs-var">extra_libs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070810"><span class="hs-identifier hs-var">extdeplibs</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070813"><span class="hs-identifier hs-var">linkerlibs</span></a></span><span>
</span><span id="line-1153"></span><span>
</span><span id="line-1154"></span><span>        </span><span class="hs-comment">-- See Note [Fork/Exec Windows]</span><span>
</span><span id="line-1155"></span><span>        </span><span id="local-6989586621683070817"><span class="annot"><a href="#local-6989586621683070817"><span class="hs-identifier hs-var">gcc_paths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DynFlags -&gt; OS -&gt; IO [String]
</span><a href="GHC.Linker.Loader.html#getGCCPaths"><span class="hs-identifier hs-var">getGCCPaths</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070800"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070799"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; OS
</span><a href="GHC.Platform.html#platformOS"><span class="hs-identifier hs-var">platformOS</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070801"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1156"></span><span>        </span><span id="local-6989586621683070818"><span class="annot"><a href="#local-6989586621683070818"><span class="hs-identifier hs-var">dirs_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#addEnvPaths"><span class="hs-identifier hs-type">addEnvPaths</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;LIBRARY_PATH&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621683070803"><span class="hs-identifier hs-type">dirs</span></a></span><span>
</span><span id="line-1157"></span><span>
</span><span id="line-1158"></span><span>        </span><span id="local-6989586621683070819"><span class="annot"><a href="#local-6989586621683070819"><span class="hs-identifier hs-var">hs_classifieds</span></a></span></span><span>
</span><span id="line-1159"></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Loader.html#locateLib"><span class="hs-identifier hs-type">locateLib</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070797"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span>  </span><span class="annot"><a href="#local-6989586621683070818"><span class="hs-identifier hs-type">dirs_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070817"><span class="hs-identifier hs-type">gcc_paths</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070809"><span class="hs-identifier hs-type">hs_libs'</span></a></span><span>
</span><span id="line-1160"></span><span>        </span><span id="local-6989586621683070820"><span class="annot"><a href="#local-6989586621683070820"><span class="hs-identifier hs-var">extra_classifieds</span></a></span></span><span>
</span><span id="line-1161"></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Loader.html#locateLib"><span class="hs-identifier hs-type">locateLib</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070797"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="annot"><a href="#local-6989586621683070818"><span class="hs-identifier hs-type">dirs_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070817"><span class="hs-identifier hs-type">gcc_paths</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070816"><span class="hs-identifier hs-type">extra_libs</span></a></span><span>
</span><span id="line-1162"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070821"><span class="annot"><a href="#local-6989586621683070821"><span class="hs-identifier hs-var hs-var">classifieds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070819"><span class="hs-identifier hs-var">hs_classifieds</span></a></span><span> </span><span class="annot"><span class="annottext">[LibrarySpec] -&gt; [LibrarySpec] -&gt; [LibrarySpec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070820"><span class="hs-identifier hs-var">extra_classifieds</span></a></span><span>
</span><span id="line-1163"></span><span>
</span><span id="line-1164"></span><span>        </span><span class="hs-comment">-- Complication: all the .so's must be loaded before any of the .o's.</span><span>
</span><span id="line-1165"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070822"><span class="annot"><a href="#local-6989586621683070822"><span class="hs-identifier hs-var hs-var">known_hs_dlls</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070823"><span class="hs-identifier hs-var">dll</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-type">DLLPath</span></a></span><span> </span><span id="local-6989586621683070823"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070823"><span class="hs-identifier hs-var">dll</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070819"><span class="hs-identifier hs-var">hs_classifieds</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1166"></span><span>            </span><span id="local-6989586621683070824"><span class="annot"><a href="#local-6989586621683070824"><span class="hs-identifier hs-var hs-var">known_extra_dlls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070825"><span class="hs-identifier hs-var">dll</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-type">DLLPath</span></a></span><span> </span><span id="local-6989586621683070825"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070825"><span class="hs-identifier hs-var">dll</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070820"><span class="hs-identifier hs-var">extra_classifieds</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1167"></span><span>            </span><span id="local-6989586621683070826"><span class="annot"><a href="#local-6989586621683070826"><span class="hs-identifier hs-var hs-var">known_dlls</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070822"><span class="hs-identifier hs-var">known_hs_dlls</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070824"><span class="hs-identifier hs-var">known_extra_dlls</span></a></span><span class="hs-cpp">
#if defined(CAN_LOAD_DLL)
</span><span>            </span><span id="local-6989586621683070827"><span class="annot"><a href="#local-6989586621683070827"><span class="hs-identifier hs-var hs-var">dlls</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070828"><span class="hs-identifier hs-var">dll</span></a></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#DLL"><span class="hs-identifier hs-type">DLL</span></a></span><span> </span><span id="local-6989586621683070828"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070828"><span class="hs-identifier hs-var">dll</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070821"><span class="hs-identifier hs-var">classifieds</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-cpp">
#endif
</span><span>            </span><span id="local-6989586621683070829"><span class="annot"><a href="#local-6989586621683070829"><span class="hs-identifier hs-var hs-var">objs</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070830"><span class="hs-identifier hs-var">obj</span></a></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#Objects"><span class="hs-identifier hs-type">Objects</span></a></span><span> </span><span id="local-6989586621683070831"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070831"><span class="hs-identifier hs-var">objs</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070821"><span class="hs-identifier hs-var">classifieds</span></a></span><span>
</span><span id="line-1172"></span><span>                                </span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070830"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070830"><span class="hs-identifier hs-var">obj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070831"><span class="hs-identifier hs-var">objs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1173"></span><span>            </span><span id="local-6989586621683070832"><span class="annot"><a href="#local-6989586621683070832"><span class="hs-identifier hs-var hs-var">archs</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070833"><span class="hs-identifier hs-var">arch</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#Archive"><span class="hs-identifier hs-type">Archive</span></a></span><span> </span><span id="local-6989586621683070833"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070833"><span class="hs-identifier hs-var">arch</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621683070821"><span class="hs-identifier hs-var">classifieds</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1174"></span><span>
</span><span id="line-1175"></span><span>        </span><span class="hs-comment">-- Add directories to library search paths</span><span>
</span><span id="line-1176"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070834"><span class="annot"><a href="#local-6989586621683070834"><span class="hs-identifier hs-var hs-var">dll_paths</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#takeDirectory"><span class="hs-identifier hs-var">takeDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070826"><span class="hs-identifier hs-var">known_dlls</span></a></span><span>
</span><span id="line-1177"></span><span>            </span><span id="local-6989586621683070835"><span class="annot"><a href="#local-6989586621683070835"><span class="hs-identifier hs-var hs-var">all_paths</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String]
forall a. Eq a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">nub</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; [String]) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#normalise"><span class="hs-identifier hs-var">normalise</span></a></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; [String]) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070834"><span class="hs-identifier hs-var">dll_paths</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070803"><span class="hs-identifier hs-var">dirs</span></a></span><span>
</span><span id="line-1178"></span><span>        </span><span id="local-6989586621683070836"><span class="annot"><a href="#local-6989586621683070836"><span class="hs-identifier hs-var">all_paths_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#addEnvPaths"><span class="hs-identifier hs-type">addEnvPaths</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;LD_LIBRARY_PATH&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621683070835"><span class="hs-identifier hs-type">all_paths</span></a></span><span>
</span><span id="line-1179"></span><span>        </span><span id="local-6989586621683070837"><span class="annot"><a href="#local-6989586621683070837"><span class="hs-identifier hs-var">pathCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.html#addLibrarySearchPath"><span class="hs-identifier hs-type">addLibrarySearchPath</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070836"><span class="hs-identifier hs-type">all_paths_env</span></a></span><span>
</span><span id="line-1180"></span><span>
</span><span id="line-1181"></span><span>        </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutSDoc"><span class="hs-identifier hs-type">maybePutSDoc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070800"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-1182"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Loading unit &quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-type">&lt;&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.State.html#pprUnitInfoForUser"><span class="hs-identifier hs-type">pprUnitInfoForUser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070798"><span class="hs-identifier hs-type">pkg</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-type">&lt;&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot; ... &quot;</span></span><span class="hs-special">)</span><span class="hs-cpp">

#if defined(CAN_LOAD_DLL)
</span><span>        </span><span class="annot"><a href="GHC.Linker.Loader.html#loadFrameworks"><span class="hs-identifier hs-type">loadFrameworks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070801"><span class="hs-identifier hs-type">platform</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070798"><span class="hs-identifier hs-type">pkg</span></a></span><span>
</span><span id="line-1186"></span><span>        </span><span class="hs-comment">-- See Note [Crash early load_dyn and locateLib]</span><span>
</span><span id="line-1187"></span><span>        </span><span class="hs-comment">-- Crash early if can't load any of `known_dlls`</span><span>
</span><span id="line-1188"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Loader.html#load_dyn"><span class="hs-identifier hs-type">load_dyn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070797"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070824"><span class="hs-identifier hs-type">known_extra_dlls</span></a></span><span>
</span><span id="line-1189"></span><span>        </span><span id="local-6989586621683070843"><span class="annot"><a href="#local-6989586621683070843"><span class="hs-identifier hs-var">loaded_dlls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapMaybeM"><span class="hs-identifier hs-type">mapMaybeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Loader.html#load_dyn"><span class="hs-identifier hs-type">load_dyn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070797"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070822"><span class="hs-identifier hs-type">known_hs_dlls</span></a></span><span>
</span><span id="line-1190"></span><span>        </span><span class="hs-comment">-- For remaining `dlls` crash early only when there is surely</span><span>
</span><span id="line-1191"></span><span>        </span><span class="hs-comment">-- no package's DLL around ... (not is_dyn)</span><span>
</span><span id="line-1192"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Loader.html#load_dyn"><span class="hs-identifier hs-type">load_dyn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070797"><span class="hs-identifier hs-type">hsc_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621683070802"><span class="hs-identifier hs-type">is_dyn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Platform.html#platformSOName"><span class="hs-identifier hs-type">platformSOName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070801"><span class="hs-identifier hs-type">platform</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070827"><span class="hs-identifier hs-type">dlls</span></a></span><span class="hs-cpp">
#else
</span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">loaded_dlls</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-cpp">
#endif
</span><span>        </span><span class="hs-comment">-- After loading all the DLLs, we can load the static objects.</span><span>
</span><span id="line-1197"></span><span>        </span><span class="hs-comment">-- Ordering isn't important here, because we do one final link</span><span>
</span><span id="line-1198"></span><span>        </span><span class="hs-comment">-- step to resolve everything.</span><span>
</span><span id="line-1199"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadObj"><span class="hs-identifier hs-type">loadObj</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070829"><span class="hs-identifier hs-type">objs</span></a></span><span>
</span><span id="line-1200"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadArchive"><span class="hs-identifier hs-type">loadArchive</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683070832"><span class="hs-identifier hs-type">archs</span></a></span><span>
</span><span id="line-1201"></span><span>
</span><span id="line-1202"></span><span>        </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStr"><span class="hs-identifier hs-type">maybePutStr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070800"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;linking ... &quot;</span></span><span>
</span><span id="line-1203"></span><span>        </span><span id="local-6989586621683070845"><span class="annot"><a href="#local-6989586621683070845"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#resolveObjs"><span class="hs-identifier hs-type">resolveObjs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span>
</span><span id="line-1204"></span><span>
</span><span id="line-1205"></span><span>        </span><span class="hs-comment">-- DLLs are loaded, reset the search paths</span><span>
</span><span id="line-1206"></span><span>        </span><span class="hs-comment">-- Import libraries will be loaded via loadArchive so only</span><span>
</span><span id="line-1207"></span><span>        </span><span class="hs-comment">-- reset the DLL search path after all archives are loaded</span><span>
</span><span id="line-1208"></span><span>        </span><span class="hs-comment">-- as well.</span><span>
</span><span id="line-1209"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.html#removeLibrarySearchPath"><span class="hs-identifier hs-type">removeLibrarySearchPath</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070796"><span class="hs-identifier hs-type">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">reverse</span></span><span> </span><span class="annot"><a href="#local-6989586621683070837"><span class="hs-identifier hs-type">pathCache</span></a></span><span>
</span><span id="line-1210"></span><span>
</span><span id="line-1211"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#succeeded"><span class="hs-identifier hs-type">succeeded</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070845"><span class="hs-identifier hs-type">ok</span></a></span><span>
</span><span id="line-1212"></span><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1213"></span><span>             </span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-type">maybePutStrLn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070800"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;done.&quot;</span></span><span>
</span><span id="line-1214"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070819"><span class="hs-identifier hs-type">hs_classifieds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070820"><span class="hs-identifier hs-type">extra_classifieds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683070843"><span class="hs-identifier hs-type">loaded_dlls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1215"></span><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070846"><span class="annot"><a href="#local-6989586621683070846"><span class="hs-identifier hs-var hs-var">errmsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unable to load unit `&quot;</span></span><span>
</span><span id="line-1216"></span><span>                             </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; SDoc
</span><a href="GHC.Unit.State.html#pprUnitInfoForUser"><span class="hs-identifier hs-var">pprUnitInfoForUser</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070798"><span class="hs-identifier hs-var">pkg</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;'&quot;</span></span><span>
</span><span id="line-1217"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-type">throwGhcExceptionIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Panic.html#InstallationError"><span class="hs-identifier hs-type">InstallationError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Ppr.html#showSDoc"><span class="hs-identifier hs-type">showSDoc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070799"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070846"><span class="hs-identifier hs-type">errmsg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1218"></span><span>
</span><span id="line-1219"></span><span class="hs-comment">{-
Note [Crash early load_dyn and locateLib]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a package is &quot;normal&quot; (exposes it's code from more than zero Haskell
modules, unlike e.g. that in ghcilink004) and is built &quot;dyn&quot; way, then
it has it's code compiled and linked into the DLL, which GHCi linker picks
when loading the package's code (see the big comment in the beginning of
`locateLib`).

When loading DLLs, GHCi linker simply calls the system's `dlopen` or
`LoadLibrary` APIs. This is quite different from the case when GHCi linker
loads an object file or static library. When loading an object file or static
library GHCi linker parses them and resolves all symbols &quot;manually&quot;.
These object file or static library may reference some external symbols
defined in some external DLLs. And GHCi should know which these
external DLLs are.

But when GHCi loads a DLL, it's the *system* linker who manages all
the necessary dependencies, and it is able to load this DLL not having
any extra info. Thus we don't *have to* crash in this case even if we
are unable to load any supposed dependencies explicitly.

Suppose during GHCi session a client of the package wants to
`foreign import` a symbol which isn't exposed by the package DLL, but
is exposed by such an external (dependency) DLL.
If the DLL isn't *explicitly* loaded because `load_dyn` failed to do
this, then the client code eventually crashes because the GHCi linker
isn't able to locate this symbol (GHCi linker maintains a list of
explicitly loaded DLLs it looks into when trying to find a symbol).

This is why we still should try to load all the dependency DLLs
even though we know that the system linker loads them implicitly when
loading the package DLL.

Why we still keep the `crash_early` opportunity then not allowing such
a permissive behaviour for any DLLs? Well, we, perhaps, improve a user
experience in some cases slightly.

But if it happens there exist other corner cases where our current
usage of `crash_early` flag is overly restrictive, we may lift the
restriction very easily.
-}</span><span class="hs-cpp">

#if defined(CAN_LOAD_DLL)
</span><span class="hs-comment">-- we have already searched the filesystem; the strings passed to load_dyn</span><span>
</span><span id="line-1264"></span><span class="hs-comment">-- can be passed directly to loadDLL.  They are either fully-qualified</span><span>
</span><span id="line-1265"></span><span class="hs-comment">-- (&quot;/usr/lib/libfoo.so&quot;), or unqualified (&quot;libfoo.so&quot;).  In the latter case,</span><span>
</span><span id="line-1266"></span><span class="hs-comment">-- loadDLL is going to search the system paths to find the library.</span><span>
</span><span id="line-1267"></span><span class="annot"><a href="GHC.Linker.Loader.html#load_dyn"><span class="hs-identifier hs-type">load_dyn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.RemoteTypes.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.12.2-bd10/src/GHCi.Message.html#LoadedDLL"><span class="hs-identifier hs-type">LoadedDLL</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1268"></span><span id="load_dyn"><span class="annot"><span class="annottext">load_dyn :: Interp
-&gt; HscEnv -&gt; Bool -&gt; String -&gt; IO (Maybe (RemotePtr LoadedDLL))
</span><a href="GHC.Linker.Loader.html#load_dyn"><span class="hs-identifier hs-var hs-var">load_dyn</span></a></span></span><span> </span><span id="local-6989586621683070849"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070849"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070850"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070850"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070851"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070851"><span class="hs-identifier hs-var">crash_early</span></a></span></span><span> </span><span id="local-6989586621683070852"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070852"><span class="hs-identifier hs-var">dll</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1269"></span><span>  </span><span id="local-6989586621683070853"><span class="annot"><a href="#local-6989586621683070853"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; String -&gt; IO (Either String (RemotePtr LoadedDLL))
</span><a href="GHC.Runtime.Interpreter.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070849"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070852"><span class="hs-identifier hs-var">dll</span></a></span><span>
</span><span id="line-1270"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683070853"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1271"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621683070854"><span class="annot"><span class="annottext">RemotePtr LoadedDLL
</span><a href="#local-6989586621683070854"><span class="hs-identifier hs-var">loaded_dll</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (RemotePtr LoadedDLL) -&gt; IO (Maybe (RemotePtr LoadedDLL))
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemotePtr LoadedDLL -&gt; Maybe (RemotePtr LoadedDLL)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">RemotePtr LoadedDLL
</span><a href="#local-6989586621683070854"><span class="hs-identifier hs-var">loaded_dll</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1272"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621683070855"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070855"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1273"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070851"><span class="hs-identifier hs-var">crash_early</span></a></span><span>
</span><span id="line-1274"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Maybe (RemotePtr LoadedDLL))
forall a. String -&gt; IO a
</span><a href="GHC.Utils.Panic.Plain.html#cmdLineErrorIO"><span class="hs-identifier hs-var">cmdLineErrorIO</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070855"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1275"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1276"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WarningFlag -&gt; DiagOpts -&gt; Bool
</span><a href="GHC.Utils.Error.html#diag_wopt"><span class="hs-identifier hs-var">diag_wopt</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag
</span><a href="GHC.Driver.Flags.html#Opt_WarnMissedExtraSharedLib"><span class="hs-identifier hs-var">Opt_WarnMissedExtraSharedLib</span></a></span><span> </span><span class="annot"><span class="annottext">DiagOpts
</span><a href="#local-6989586621683070859"><span class="hs-identifier hs-var">diag_opts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1277"></span><span>            </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger -&gt; MessageClass -&gt; SrcSpan -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070860"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-1278"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiagOpts
-&gt; DiagnosticReason -&gt; Maybe DiagnosticCode -&gt; MessageClass
</span><a href="GHC.Utils.Error.html#mkMCDiagnostic"><span class="hs-identifier hs-var">mkMCDiagnostic</span></a></span><span> </span><span class="annot"><span class="annottext">DiagOpts
</span><a href="#local-6989586621683070859"><span class="hs-identifier hs-var">diag_opts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WarningFlag -&gt; DiagnosticReason
</span><a href="GHC.Types.Error.html#WarningWithFlag"><span class="hs-identifier hs-var">WarningWithFlag</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag
</span><a href="GHC.Driver.Flags.html#Opt_WarnMissedExtraSharedLib"><span class="hs-identifier hs-var">Opt_WarnMissedExtraSharedLib</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe DiagnosticCode
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1279"></span><span>                  </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; IO ()) -&gt; SDoc -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PprStyle -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#withPprStyle"><span class="hs-identifier hs-var">withPprStyle</span></a></span><span> </span><span class="annot"><span class="annottext">PprStyle
</span><a href="GHC.Utils.Outputable.html#defaultUserStyle"><span class="hs-identifier hs-var">defaultUserStyle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall {b}. (IsDoc b, IsLine b) =&gt; String -&gt; b
</span><a href="#local-6989586621683070863"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070855"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1280"></span><span>          </span><span class="annot"><span class="annottext">Maybe (RemotePtr LoadedDLL) -&gt; IO (Maybe (RemotePtr LoadedDLL))
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (RemotePtr LoadedDLL)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1281"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1282"></span><span>    </span><span id="local-6989586621683070859"><span class="annot"><span class="annottext">diag_opts :: DiagOpts
</span><a href="#local-6989586621683070859"><span class="hs-identifier hs-var hs-var">diag_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; DiagOpts
</span><a href="GHC.Driver.Config.Diagnostic.html#initDiagOpts"><span class="hs-identifier hs-var">initDiagOpts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070850"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1283"></span><span>    </span><span id="local-6989586621683070860"><span class="annot"><span class="annottext">logger :: Logger
</span><a href="#local-6989586621683070860"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070850"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-1284"></span><span>    </span><span id="local-6989586621683070863"><span class="annot"><span class="annottext">note :: String -&gt; b
</span><a href="#local-6989586621683070863"><span class="hs-identifier hs-var hs-var">note</span></a></span></span><span> </span><span id="local-6989586621683070879"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070879"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[b] -&gt; b
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="annot"><span class="annottext">([b] -&gt; b) -&gt; [b] -&gt; b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; b) -&gt; [String] -&gt; [b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; b
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span>
</span><span id="line-1285"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070879"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1286"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;It's OK if you don't want to use symbols from it directly.&quot;</span></span><span>
</span><span id="line-1287"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(the package DLL is loaded by the system linker&quot;</span></span><span>
</span><span id="line-1288"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; which manages dependencies by itself).&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1289"></span><span>
</span><span id="line-1290"></span><span class="annot"><a href="GHC.Linker.Loader.html#loadFrameworks"><span class="hs-identifier hs-type">loadFrameworks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Platform.html#Platform"><span class="hs-identifier hs-type">Platform</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Info.html#UnitInfo"><span class="hs-identifier hs-type">UnitInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1291"></span><span id="loadFrameworks"><span class="annot"><span class="annottext">loadFrameworks :: Interp -&gt; Platform -&gt; UnitInfo -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#loadFrameworks"><span class="hs-identifier hs-var hs-var">loadFrameworks</span></a></span></span><span> </span><span id="local-6989586621683070880"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070880"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070881"><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070881"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span id="local-6989586621683070882"><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070882"><span class="hs-identifier hs-var">pkg</span></a></span></span><span>
</span><span id="line-1292"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; Bool
</span><a href="GHC.Platform.html#platformUsesFrameworks"><span class="hs-identifier hs-var">platformUsesFrameworks</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070881"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; [String] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><a href="#local-6989586621683070883"><span class="hs-identifier hs-var">load</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070884"><span class="hs-identifier hs-var">frameworks</span></a></span><span>
</span><span id="line-1293"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1294"></span><span>    </span><span id="local-6989586621683070885"><span class="annot"><span class="annottext">fw_dirs :: [String]
</span><a href="#local-6989586621683070885"><span class="hs-identifier hs-var hs-var">fw_dirs</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePathST -&gt; String) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FilePathST -&gt; String
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.ShortText.html#unpack"><span class="hs-identifier hs-var">ST.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">([FilePathST] -&gt; [String]) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; [FilePathST]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod
-&gt; [FilePathST]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitExtDepFrameworkDirs"><span class="hs-identifier hs-var">Packages.unitExtDepFrameworkDirs</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070882"><span class="hs-identifier hs-var">pkg</span></a></span><span>
</span><span id="line-1295"></span><span>    </span><span id="local-6989586621683070884"><span class="annot"><span class="annottext">frameworks :: [String]
</span><a href="#local-6989586621683070884"><span class="hs-identifier hs-var hs-var">frameworks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePathST -&gt; String) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">FilePathST -&gt; String
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Data.ShortText.html#unpack"><span class="hs-identifier hs-var">ST.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">([FilePathST] -&gt; [String]) -&gt; [FilePathST] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnitInfo -&gt; [FilePathST]
forall srcpkgid srcpkgname uid modulename mod.
GenericUnitInfo srcpkgid srcpkgname uid modulename mod
-&gt; [FilePathST]
</span><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Unit.Database.html#unitExtDepFrameworks"><span class="hs-identifier hs-var">Packages.unitExtDepFrameworks</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInfo
</span><a href="#local-6989586621683070882"><span class="hs-identifier hs-var">pkg</span></a></span><span>
</span><span id="line-1296"></span><span>
</span><span id="line-1297"></span><span>    </span><span id="local-6989586621683070883"><span class="annot"><span class="annottext">load :: String -&gt; IO ()
</span><a href="#local-6989586621683070883"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span> </span><span id="local-6989586621683070888"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070888"><span class="hs-identifier hs-var">fw</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span id="local-6989586621683070889"><span class="annot"><a href="#local-6989586621683070889"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; [String] -&gt; String -&gt; IO (Maybe String)
</span><a href="GHC.Linker.MacOS.html#loadFramework"><span class="hs-identifier hs-var">loadFramework</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070880"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070885"><span class="hs-identifier hs-var">fw_dirs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070888"><span class="hs-identifier hs-var">fw</span></a></span><span>
</span><span id="line-1298"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683070889"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1299"></span><span>                    </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1300"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683070890"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070890"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. String -&gt; IO a
</span><a href="GHC.Utils.Panic.Plain.html#cmdLineErrorIO"><span class="hs-identifier hs-var">cmdLineErrorIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;can't load framework: &quot;</span></span><span>
</span><span id="line-1301"></span><span>                                                </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070888"><span class="hs-identifier hs-var">fw</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; (&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070890"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span> </span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-1304"></span><span class="hs-comment">-- Try to find an object file for a given library in the given paths.</span><span>
</span><span id="line-1305"></span><span class="hs-comment">-- If it isn't present, we assume that addDLL in the RTS can find it,</span><span>
</span><span id="line-1306"></span><span class="hs-comment">-- which generally means that it should be a dynamic library in the</span><span>
</span><span id="line-1307"></span><span class="hs-comment">-- standard system search path.</span><span>
</span><span id="line-1308"></span><span class="hs-comment">-- For GHCi we tend to prefer dynamic libraries over static ones as</span><span>
</span><span id="line-1309"></span><span class="hs-comment">-- they are easier to load and manage, have less overhead.</span><span>
</span><span id="line-1310"></span><span class="annot"><a href="GHC.Linker.Loader.html#locateLib"><span class="hs-identifier hs-type">locateLib</span></a></span><span>
</span><span id="line-1311"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-1312"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span>
</span><span id="line-1313"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1314"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span>
</span><span id="line-1315"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span>
</span><span id="line-1316"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-1317"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span>
</span><span id="line-1318"></span><span id="locateLib"><span class="annot"><span class="annottext">locateLib :: Interp
-&gt; HscEnv
-&gt; Bool
-&gt; [String]
-&gt; [String]
-&gt; String
-&gt; IO LibrarySpec
</span><a href="GHC.Linker.Loader.html#locateLib"><span class="hs-identifier hs-var hs-var">locateLib</span></a></span></span><span> </span><span id="local-6989586621683070891"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070891"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621683070892"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070892"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621683070893"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070893"><span class="hs-identifier hs-var">is_hs</span></a></span></span><span> </span><span id="local-6989586621683070894"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070894"><span class="hs-identifier hs-var">lib_dirs</span></a></span></span><span> </span><span id="local-6989586621683070895"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070895"><span class="hs-identifier hs-var">gcc_dirs</span></a></span></span><span> </span><span id="local-6989586621683070896"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070896"><span class="hs-identifier hs-var">lib0</span></a></span></span><span>
</span><span id="line-1319"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070893"><span class="hs-identifier hs-var">is_hs</span></a></span><span>
</span><span id="line-1320"></span><span>    </span><span class="hs-comment">-- For non-Haskell libraries (e.g. gmp, iconv):</span><span>
</span><span id="line-1321"></span><span>    </span><span class="hs-comment">--   first look in library-dirs for a dynamic library (on User paths only)</span><span>
</span><span id="line-1322"></span><span>    </span><span class="hs-comment">--   (libfoo.so)</span><span>
</span><span id="line-1323"></span><span>    </span><span class="hs-comment">--   then  try looking for import libraries on Windows (on User paths only)</span><span>
</span><span id="line-1324"></span><span>    </span><span class="hs-comment">--   (.dll.a, .lib)</span><span>
</span><span id="line-1325"></span><span>    </span><span class="hs-comment">--   first look in library-dirs for a dynamic library (on GCC paths only)</span><span>
</span><span id="line-1326"></span><span>    </span><span class="hs-comment">--   (libfoo.so)</span><span>
</span><span id="line-1327"></span><span>    </span><span class="hs-comment">--   then  check for system dynamic libraries (e.g. kernel32.dll on windows)</span><span>
</span><span id="line-1328"></span><span>    </span><span class="hs-comment">--   then  try looking for import libraries on Windows (on GCC paths only)</span><span>
</span><span id="line-1329"></span><span>    </span><span class="hs-comment">--   (.dll.a, .lib)</span><span>
</span><span id="line-1330"></span><span>    </span><span class="hs-comment">--   then  look in library-dirs for a static library (libfoo.a)</span><span>
</span><span id="line-1331"></span><span>    </span><span class="hs-comment">--   then look in library-dirs and inplace GCC for a dynamic library (libfoo.so)</span><span>
</span><span id="line-1332"></span><span>    </span><span class="hs-comment">--   then  try looking for import libraries on Windows (.dll.a, .lib)</span><span>
</span><span id="line-1333"></span><span>    </span><span class="hs-comment">--   then  look in library-dirs and inplace GCC for a static library (libfoo.a)</span><span>
</span><span id="line-1334"></span><span>    </span><span class="hs-comment">--   then  try &quot;gcc --print-file-name&quot; to search gcc's search path</span><span>
</span><span id="line-1335"></span><span>    </span><span class="hs-comment">--       for a dynamic library (#5289)</span><span>
</span><span id="line-1336"></span><span>    </span><span class="hs-comment">--   otherwise, assume loadDLL can find it</span><span>
</span><span id="line-1337"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1338"></span><span>    </span><span class="hs-comment">--   The logic is a bit complicated, but the rationale behind it is that</span><span>
</span><span id="line-1339"></span><span>    </span><span class="hs-comment">--   loading a shared library for us is O(1) while loading an archive is</span><span>
</span><span id="line-1340"></span><span>    </span><span class="hs-comment">--   O(n). Loading an import library is also O(n) so in general we prefer</span><span>
</span><span id="line-1341"></span><span>    </span><span class="hs-comment">--   shared libraries because they are simpler and faster.</span><span>
</span><span id="line-1342"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1343"></span><span>  </span><span class="hs-glyph">=</span><span class="hs-cpp">
#if defined(CAN_LOAD_DLL)
</span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070897"><span class="hs-identifier hs-var">findDll</span></a></span><span>   </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070898"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070900"><span class="hs-identifier hs-var">tryImpLib</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070898"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span class="hs-cpp">
#if defined(CAN_LOAD_DLL)
</span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070897"><span class="hs-identifier hs-var">findDll</span></a></span><span>   </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070901"><span class="hs-identifier hs-var">gcc</span></a></span><span>  </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span>
</span><span id="line-1350"></span><span>    </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070902"><span class="hs-identifier hs-var">findSysDll</span></a></span><span>     </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070900"><span class="hs-identifier hs-var">tryImpLib</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070901"><span class="hs-identifier hs-var">gcc</span></a></span><span>  </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span>
</span><span id="line-1353"></span><span>    </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070903"><span class="hs-identifier hs-var">findArchive</span></a></span><span>    </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span>
</span><span id="line-1354"></span><span>    </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070904"><span class="hs-identifier hs-var">tryGcc</span></a></span><span>         </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span>
</span><span id="line-1355"></span><span>    </span><span class="annot"><span class="annottext">IO LibrarySpec
</span><a href="#local-6989586621683070905"><span class="hs-identifier hs-var">assumeDll</span></a></span><span>
</span><span id="line-1356"></span><span>
</span><span id="line-1357"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070906"><span class="hs-identifier hs-var">loading_dynamic_hs_libs</span></a></span><span> </span><span class="hs-comment">-- search for .so libraries first.</span><span>
</span><span id="line-1358"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070907"><span class="hs-identifier hs-var">findHSDll</span></a></span><span>     </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span>
</span><span id="line-1359"></span><span>    </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070908"><span class="hs-identifier hs-var">findDynObject</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span>
</span><span id="line-1360"></span><span>    </span><span class="annot"><span class="annottext">IO LibrarySpec
</span><a href="#local-6989586621683070905"><span class="hs-identifier hs-var">assumeDll</span></a></span><span>
</span><span id="line-1361"></span><span>
</span><span id="line-1362"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1363"></span><span>    </span><span class="hs-comment">-- use HSfoo.{o,p_o} if it exists, otherwise fallback to libHSfoo{,_p}.a</span><span>
</span><span id="line-1364"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070909"><span class="hs-identifier hs-var">findObject</span></a></span><span>  </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span>
</span><span id="line-1365"></span><span>    </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070903"><span class="hs-identifier hs-var">findArchive</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec) -&gt; IO LibrarySpec -&gt; IO LibrarySpec
forall {m :: * -&gt; *} {b}. Monad m =&gt; m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var">`orElse`</span></a></span><span>
</span><span id="line-1366"></span><span>    </span><span class="annot"><span class="annottext">IO LibrarySpec
</span><a href="#local-6989586621683070905"><span class="hs-identifier hs-var">assumeDll</span></a></span><span>
</span><span id="line-1367"></span><span>
</span><span id="line-1368"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-1369"></span><span>     </span><span id="local-6989586621683070910"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621683070910"><span class="hs-identifier hs-var hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070892"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-1370"></span><span>     </span><span id="local-6989586621683070911"><span class="annot"><span class="annottext">logger :: Logger
</span><a href="#local-6989586621683070911"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621683070892"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-1371"></span><span>     </span><span id="local-6989586621683070912"><span class="annot"><span class="annottext">diag_opts :: DiagOpts
</span><a href="#local-6989586621683070912"><span class="hs-identifier hs-var hs-var">diag_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; DiagOpts
</span><a href="GHC.Driver.Config.Diagnostic.html#initDiagOpts"><span class="hs-identifier hs-var">initDiagOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070910"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1372"></span><span>     </span><span id="local-6989586621683070913"><span class="annot"><span class="annottext">dirs :: [String]
</span><a href="#local-6989586621683070913"><span class="hs-identifier hs-var hs-var">dirs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070894"><span class="hs-identifier hs-var">lib_dirs</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070895"><span class="hs-identifier hs-var">gcc_dirs</span></a></span><span>
</span><span id="line-1373"></span><span>     </span><span id="local-6989586621683070901"><span class="annot"><span class="annottext">gcc :: Bool
</span><a href="#local-6989586621683070901"><span class="hs-identifier hs-var hs-var">gcc</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1374"></span><span>     </span><span id="local-6989586621683070898"><span class="annot"><span class="annottext">user :: Bool
</span><a href="#local-6989586621683070898"><span class="hs-identifier hs-var hs-var">user</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1375"></span><span>
</span><span id="line-1376"></span><span>     </span><span class="hs-comment">-- Emulate ld's behavior of treating $LIB in `-l:$LIB` as a literal file</span><span>
</span><span id="line-1377"></span><span>     </span><span class="hs-comment">-- name</span><span>
</span><span id="line-1378"></span><span>     </span><span class="hs-special">(</span><span id="local-6989586621683070914"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683070915"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070915"><span class="hs-identifier hs-var">verbatim</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070896"><span class="hs-identifier hs-var">lib0</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1379"></span><span>       </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">':'</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683070916"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070916"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070916"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-1380"></span><span>       </span><span id="local-6989586621683070917"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070917"><span class="hs-identifier hs-var">other</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070917"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-1381"></span><span>
</span><span id="line-1382"></span><span>     </span><span id="local-6989586621683070918"><span class="annot"><span class="annottext">obj_file :: String
</span><a href="#local-6989586621683070918"><span class="hs-identifier hs-var hs-var">obj_file</span></a></span></span><span>
</span><span id="line-1383"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070893"><span class="hs-identifier hs-var">is_hs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070919"><span class="hs-identifier hs-var">loading_profiled_hs_libs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;p_o&quot;</span></span><span>
</span><span id="line-1384"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;o&quot;</span></span><span>
</span><span id="line-1385"></span><span>     </span><span id="local-6989586621683070920"><span class="annot"><span class="annottext">dyn_obj_file :: String
</span><a href="#local-6989586621683070920"><span class="hs-identifier hs-var hs-var">dyn_obj_file</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dyn_o&quot;</span></span><span>
</span><span id="line-1386"></span><span>     </span><span id="local-6989586621683070921"><span class="annot"><span class="annottext">arch_files :: [String]
</span><a href="#local-6989586621683070921"><span class="hs-identifier hs-var hs-var">arch_files</span></a></span></span><span>
</span><span id="line-1387"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070915"><span class="hs-identifier hs-var">verbatim</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1388"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lib&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070922"><span class="hs-identifier hs-var">lib_tag</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;a&quot;</span></span><span>
</span><span id="line-1389"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;a&quot;</span></span><span> </span><span class="hs-comment">-- native code has no lib_tag</span><span>
</span><span id="line-1390"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lib&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span>
</span><span id="line-1391"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span>
</span><span id="line-1392"></span><span>                     </span><span class="hs-special">]</span><span>
</span><span id="line-1393"></span><span>     </span><span id="local-6989586621683070922"><span class="annot"><span class="annottext">lib_tag :: String
</span><a href="#local-6989586621683070922"><span class="hs-identifier hs-var hs-var">lib_tag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070893"><span class="hs-identifier hs-var">is_hs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070919"><span class="hs-identifier hs-var">loading_profiled_hs_libs</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_p&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-1394"></span><span>
</span><span id="line-1395"></span><span>     </span><span id="local-6989586621683070919"><span class="annot"><span class="annottext">loading_profiled_hs_libs :: Bool
</span><a href="#local-6989586621683070919"><span class="hs-identifier hs-var hs-var">loading_profiled_hs_libs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.html#interpreterProfiled"><span class="hs-identifier hs-var">interpreterProfiled</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070891"><span class="hs-identifier hs-var">interp</span></a></span><span>
</span><span id="line-1396"></span><span>     </span><span id="local-6989586621683070906"><span class="annot"><span class="annottext">loading_dynamic_hs_libs :: Bool
</span><a href="#local-6989586621683070906"><span class="hs-identifier hs-var hs-var">loading_dynamic_hs_libs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.html#interpreterDynamic"><span class="hs-identifier hs-var">interpreterDynamic</span></a></span><span>  </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070891"><span class="hs-identifier hs-var">interp</span></a></span><span>
</span><span id="line-1397"></span><span>
</span><span id="line-1398"></span><span>     </span><span id="local-6989586621683070923"><span class="annot"><span class="annottext">import_libs :: [String]
</span><a href="#local-6989586621683070923"><span class="hs-identifier hs-var hs-var">import_libs</span></a></span></span><span>
</span><span id="line-1399"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070915"><span class="hs-identifier hs-var">verbatim</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1400"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lib&quot;</span></span><span>
</span><span id="line-1401"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lib&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lib&quot;</span></span><span>
</span><span id="line-1402"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lib&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dll.a&quot;</span></span><span>
</span><span id="line-1403"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dll.a&quot;</span></span><span>
</span><span id="line-1404"></span><span>                     </span><span class="hs-special">]</span><span>
</span><span id="line-1405"></span><span>
</span><span id="line-1406"></span><span>     </span><span id="local-6989586621683070924"><span class="annot"><span class="annottext">hs_dyn_lib_name :: String
</span><a href="#local-6989586621683070924"><span class="hs-identifier hs-var hs-var">hs_dyn_lib_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070922"><span class="hs-identifier hs-var">lib_tag</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">GhcNameVersion -&gt; String
</span><a href="GHC.Settings.html#dynLibSuffix"><span class="hs-identifier hs-var">dynLibSuffix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; GhcNameVersion
</span><a href="GHC.Driver.DynFlags.html#ghcNameVersion"><span class="hs-identifier hs-var">ghcNameVersion</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070910"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1407"></span><span>     </span><span id="local-6989586621683070927"><span class="annot"><span class="annottext">hs_dyn_lib_file :: String
</span><a href="#local-6989586621683070927"><span class="hs-identifier hs-var hs-var">hs_dyn_lib_file</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; String -&gt; String
</span><a href="GHC.Platform.html#platformHsSOName"><span class="hs-identifier hs-var">platformHsSOName</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070929"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070924"><span class="hs-identifier hs-var">hs_dyn_lib_name</span></a></span><span class="hs-cpp">

#if defined(CAN_LOAD_DLL)
</span><span>     </span><span id="local-6989586621683070930"><span class="annot"><span class="annottext">so_name :: String
</span><a href="#local-6989586621683070930"><span class="hs-identifier hs-var hs-var">so_name</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; String -&gt; String
</span><a href="GHC.Platform.html#platformSOName"><span class="hs-identifier hs-var">platformSOName</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070929"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span>
</span><span id="line-1411"></span><span>     </span><span id="local-6989586621683070931"><span class="annot"><span class="annottext">lib_so_name :: String
</span><a href="#local-6989586621683070931"><span class="hs-identifier hs-var hs-var">lib_so_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lib&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070930"><span class="hs-identifier hs-var">so_name</span></a></span><span>
</span><span id="line-1412"></span><span>     </span><span id="local-6989586621683070932"><span class="annot"><span class="annottext">dyn_lib_file :: String
</span><a href="#local-6989586621683070932"><span class="hs-identifier hs-var hs-var">dyn_lib_file</span></a></span></span><span>
</span><span id="line-1413"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070915"><span class="hs-identifier hs-var">verbatim</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Bool) -&gt; [String] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#isExtensionOf"><span class="hs-operator hs-var">`isExtensionOf`</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.so&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.dylib&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.dll&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-1414"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span>
</span><span id="line-1415"></span><span>
</span><span id="line-1416"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchX86_64</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Arch
</span><a href="#local-6989586621683070936"><span class="hs-identifier hs-var">arch</span></a></span><span>
</span><span id="line-1417"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OS
</span><span class="hs-identifier hs-var">OSSolaris2</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OS
</span><a href="#local-6989586621683070938"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-1418"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;64&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070930"><span class="hs-identifier hs-var">so_name</span></a></span><span>
</span><span id="line-1419"></span><span>
</span><span id="line-1420"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1421"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070930"><span class="hs-identifier hs-var">so_name</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-1424"></span><span>     </span><span id="local-6989586621683070909"><span class="annot"><span class="annottext">findObject :: IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070909"><span class="hs-identifier hs-var hs-var">findObject</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Maybe LibrarySpec)
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec)
-&gt; (String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#Objects"><span class="hs-identifier hs-var">Objects</span></a></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; LibrarySpec)
-&gt; (String -&gt; [String]) -&gt; String -&gt; LibrarySpec
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; [String]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String -&gt; IO (Maybe String)
</span><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#findFile"><span class="hs-identifier hs-var">findFile</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070913"><span class="hs-identifier hs-var">dirs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070918"><span class="hs-identifier hs-var">obj_file</span></a></span><span>
</span><span id="line-1425"></span><span>     </span><span id="local-6989586621683070908"><span class="annot"><span class="annottext">findDynObject :: IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070908"><span class="hs-identifier hs-var hs-var">findDynObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Maybe LibrarySpec)
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec)
-&gt; (String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#Objects"><span class="hs-identifier hs-var">Objects</span></a></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; LibrarySpec)
-&gt; (String -&gt; [String]) -&gt; String -&gt; LibrarySpec
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; [String]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String -&gt; IO (Maybe String)
</span><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#findFile"><span class="hs-identifier hs-var">findFile</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070913"><span class="hs-identifier hs-var">dirs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070920"><span class="hs-identifier hs-var">dyn_obj_file</span></a></span><span>
</span><span id="line-1426"></span><span>     </span><span id="local-6989586621683070903"><span class="annot"><span class="annottext">findArchive :: IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070903"><span class="hs-identifier hs-var hs-var">findArchive</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070942"><span class="annot"><span class="annottext">local :: String -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070942"><span class="hs-identifier hs-var hs-var">local</span></a></span></span><span> </span><span id="local-6989586621683070943"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070943"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Maybe LibrarySpec)
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#Archive"><span class="hs-identifier hs-var">Archive</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String -&gt; IO (Maybe String)
</span><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#findFile"><span class="hs-identifier hs-var">findFile</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070913"><span class="hs-identifier hs-var">dirs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070943"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1427"></span><span>                     </span><span class="hs-keyword">in</span><span>  </span><span class="annot"><span class="annottext">[IO (Maybe LibrarySpec)] -&gt; IO (Maybe LibrarySpec)
forall a. [IO (Maybe a)] -&gt; IO (Maybe a)
</span><a href="#local-6989586621683070944"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; IO (Maybe LibrarySpec))
-&gt; [String] -&gt; [IO (Maybe LibrarySpec)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070942"><span class="hs-identifier hs-var">local</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070921"><span class="hs-identifier hs-var">arch_files</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1428"></span><span>     </span><span id="local-6989586621683070907"><span class="annot"><span class="annottext">findHSDll :: IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070907"><span class="hs-identifier hs-var hs-var">findHSDll</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Maybe LibrarySpec)
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String -&gt; IO (Maybe String)
</span><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#findFile"><span class="hs-identifier hs-var">findFile</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070913"><span class="hs-identifier hs-var">dirs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070927"><span class="hs-identifier hs-var">hs_dyn_lib_file</span></a></span><span class="hs-cpp">
#if defined(CAN_LOAD_DLL)
</span><span>     </span><span id="local-6989586621683070897"><span class="annot"><span class="annottext">findDll :: Bool -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070897"><span class="hs-identifier hs-var hs-var">findDll</span></a></span></span><span>    </span><span id="local-6989586621683070945"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070945"><span class="hs-identifier hs-var">re</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070946"><span class="annot"><span class="annottext">dirs' :: [String]
</span><a href="#local-6989586621683070946"><span class="hs-identifier hs-var hs-var">dirs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070945"><span class="hs-identifier hs-var">re</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070898"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070894"><span class="hs-identifier hs-var">lib_dirs</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070895"><span class="hs-identifier hs-var">gcc_dirs</span></a></span><span>
</span><span id="line-1431"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Maybe LibrarySpec)
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String -&gt; IO (Maybe String)
</span><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#findFile"><span class="hs-identifier hs-var">findFile</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070946"><span class="hs-identifier hs-var">dirs'</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070932"><span class="hs-identifier hs-var">dyn_lib_file</span></a></span><span>
</span><span id="line-1432"></span><span>     </span><span id="local-6989586621683070902"><span class="annot"><span class="annottext">findSysDll :: IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070902"><span class="hs-identifier hs-var hs-var">findSysDll</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Maybe LibrarySpec)
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec)
-&gt; (String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#DLL"><span class="hs-identifier hs-var">DLL</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec)
-&gt; (String -&gt; String) -&gt; String -&gt; LibrarySpec
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#dropExtension"><span class="hs-identifier hs-var">dropExtension</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; (String -&gt; String) -&gt; String -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
</span><a href="../../filepath-1.5.4.0-e69b/src/System.FilePath.Posix.html#takeFileName"><span class="hs-identifier hs-var">takeFileName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1433"></span><span>                        </span><span class="annot"><span class="annottext">Interp -&gt; String -&gt; IO (Maybe String)
</span><a href="GHC.Runtime.Interpreter.html#findSystemLibrary"><span class="hs-identifier hs-var">findSystemLibrary</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070891"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070930"><span class="hs-identifier hs-var">so_name</span></a></span><span class="hs-cpp">
#endif
</span><span>     </span><span id="local-6989586621683070904"><span class="annot"><span class="annottext">tryGcc :: IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070904"><span class="hs-identifier hs-var hs-var">tryGcc</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070950"><span class="annot"><span class="annottext">search :: String -&gt; [String] -&gt; IO (Maybe String)
</span><a href="#local-6989586621683070950"><span class="hs-identifier hs-var hs-var">search</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DynFlags -&gt; String -&gt; [String] -&gt; IO (Maybe String)
</span><a href="GHC.Linker.Loader.html#searchForLibUsingGcc"><span class="hs-identifier hs-var">searchForLibUsingGcc</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070911"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070910"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-cpp">
#if defined(CAN_LOAD_DLL)
</span><span>                         </span><span id="local-6989586621683070956"><span class="annot"><span class="annottext">dllpath :: IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070956"><span class="hs-identifier hs-var hs-var">dllpath</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Maybe LibrarySpec)
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1438"></span><span>                         </span><span id="local-6989586621683070957"><span class="annot"><span class="annottext">short :: IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070957"><span class="hs-identifier hs-var hs-var">short</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070956"><span class="hs-identifier hs-var">dllpath</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; IO (Maybe String)
</span><a href="#local-6989586621683070950"><span class="hs-identifier hs-var">search</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070930"><span class="hs-identifier hs-var">so_name</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070894"><span class="hs-identifier hs-var">lib_dirs</span></a></span><span>
</span><span id="line-1439"></span><span>                         </span><span id="local-6989586621683070958"><span class="annot"><span class="annottext">full :: IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070958"><span class="hs-identifier hs-var hs-var">full</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070956"><span class="hs-identifier hs-var">dllpath</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; IO (Maybe String)
</span><a href="#local-6989586621683070950"><span class="hs-identifier hs-var">search</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070931"><span class="hs-identifier hs-var">lib_so_name</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070894"><span class="hs-identifier hs-var">lib_dirs</span></a></span><span>
</span><span id="line-1440"></span><span>                         </span><span id="local-6989586621683070959"><span class="annot"><span class="annottext">dlls :: [IO (Maybe LibrarySpec)]
</span><a href="#local-6989586621683070959"><span class="hs-identifier hs-var hs-var">dlls</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070957"><span class="hs-identifier hs-var">short</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070958"><span class="hs-identifier hs-var">full</span></a></span><span class="hs-special">]</span><span class="hs-cpp">
#endif
</span><span>                         </span><span id="local-6989586621683070960"><span class="annot"><span class="annottext">gcc :: String -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070960"><span class="hs-identifier hs-var hs-var">gcc</span></a></span></span><span> </span><span id="local-6989586621683070961"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070961"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Maybe LibrarySpec)
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#Archive"><span class="hs-identifier hs-var">Archive</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; IO (Maybe String)
</span><a href="#local-6989586621683070950"><span class="hs-identifier hs-var">search</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070961"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070894"><span class="hs-identifier hs-var">lib_dirs</span></a></span><span>
</span><span id="line-1443"></span><span>                         </span><span id="local-6989586621683070962"><span class="annot"><span class="annottext">files :: [String]
</span><a href="#local-6989586621683070962"><span class="hs-identifier hs-var hs-var">files</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070923"><span class="hs-identifier hs-var">import_libs</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070921"><span class="hs-identifier hs-var">arch_files</span></a></span><span>
</span><span id="line-1444"></span><span>                         </span><span id="local-6989586621683070963"><span class="annot"><span class="annottext">archives :: [IO (Maybe LibrarySpec)]
</span><a href="#local-6989586621683070963"><span class="hs-identifier hs-var hs-var">archives</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO (Maybe LibrarySpec))
-&gt; [String] -&gt; [IO (Maybe LibrarySpec)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070960"><span class="hs-identifier hs-var">gcc</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070962"><span class="hs-identifier hs-var">files</span></a></span><span>
</span><span id="line-1445"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[IO (Maybe LibrarySpec)] -&gt; IO (Maybe LibrarySpec)
forall a. [IO (Maybe a)] -&gt; IO (Maybe a)
</span><a href="#local-6989586621683070944"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="annot"><span class="annottext">([IO (Maybe LibrarySpec)] -&gt; IO (Maybe LibrarySpec))
-&gt; [IO (Maybe LibrarySpec)] -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span class="hs-cpp">
#if defined(CAN_LOAD_DLL)
</span><span>                          </span><span class="annot"><span class="annottext">[IO (Maybe LibrarySpec)]
</span><a href="#local-6989586621683070959"><span class="hs-identifier hs-var">dlls</span></a></span><span> </span><span class="annot"><span class="annottext">[IO (Maybe LibrarySpec)]
-&gt; [IO (Maybe LibrarySpec)] -&gt; [IO (Maybe LibrarySpec)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="hs-cpp">
#endif
</span><span>                          </span><span class="annot"><span class="annottext">[IO (Maybe LibrarySpec)]
</span><a href="#local-6989586621683070963"><span class="hs-identifier hs-var">archives</span></a></span><span>
</span><span id="line-1450"></span><span>     </span><span id="local-6989586621683070900"><span class="annot"><span class="annottext">tryImpLib :: Bool -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070900"><span class="hs-identifier hs-var hs-var">tryImpLib</span></a></span></span><span> </span><span id="local-6989586621683070964"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070964"><span class="hs-identifier hs-var">re</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OS
</span><a href="#local-6989586621683070938"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1451"></span><span>                       </span><span class="annot"><span class="annottext">OS
</span><span class="hs-identifier hs-var">OSMinGW32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1452"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070965"><span class="annot"><span class="annottext">dirs' :: [String]
</span><a href="#local-6989586621683070965"><span class="hs-identifier hs-var hs-var">dirs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070964"><span class="hs-identifier hs-var">re</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070898"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070894"><span class="hs-identifier hs-var">lib_dirs</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070895"><span class="hs-identifier hs-var">gcc_dirs</span></a></span><span>
</span><span id="line-1453"></span><span>                            </span><span id="local-6989586621683070966"><span class="annot"><span class="annottext">implib :: String -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070966"><span class="hs-identifier hs-var hs-var">implib</span></a></span></span><span> </span><span id="local-6989586621683070967"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070967"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; Maybe LibrarySpec)
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; LibrarySpec) -&gt; Maybe String -&gt; Maybe LibrarySpec
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#Archive"><span class="hs-identifier hs-var">Archive</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (Maybe String) -&gt; IO (Maybe LibrarySpec))
-&gt; IO (Maybe String) -&gt; IO (Maybe LibrarySpec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1454"></span><span>                                            </span><span class="annot"><span class="annottext">[String] -&gt; String -&gt; IO (Maybe String)
</span><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#findFile"><span class="hs-identifier hs-var">findFile</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070965"><span class="hs-identifier hs-var">dirs'</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070967"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1455"></span><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[IO (Maybe LibrarySpec)] -&gt; IO (Maybe LibrarySpec)
forall a. [IO (Maybe a)] -&gt; IO (Maybe a)
</span><a href="#local-6989586621683070944"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; IO (Maybe LibrarySpec))
-&gt; [String] -&gt; [IO (Maybe LibrarySpec)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Maybe LibrarySpec)
</span><a href="#local-6989586621683070966"><span class="hs-identifier hs-var">implib</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070923"><span class="hs-identifier hs-var">import_libs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1456"></span><span>                       </span><span class="annot"><span class="annottext">OS
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe LibrarySpec -&gt; IO (Maybe LibrarySpec)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe LibrarySpec
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1457"></span><span>
</span><span id="line-1458"></span><span>     </span><span class="hs-comment">-- TH Makes use of the interpreter so this failure is not obvious.</span><span>
</span><span id="line-1459"></span><span>     </span><span class="hs-comment">-- So we are nice and warn/inform users why we fail before we do.</span><span>
</span><span id="line-1460"></span><span>     </span><span class="hs-comment">-- But only for haskell libraries, as C libraries don't have a</span><span>
</span><span id="line-1461"></span><span>     </span><span class="hs-comment">-- profiling/non-profiling distinction to begin with.</span><span>
</span><span id="line-1462"></span><span>     </span><span id="local-6989586621683070905"><span class="annot"><span class="annottext">assumeDll :: IO LibrarySpec
</span><a href="#local-6989586621683070905"><span class="hs-identifier hs-var hs-var">assumeDll</span></a></span></span><span>
</span><span id="line-1463"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070893"><span class="hs-identifier hs-var">is_hs</span></a></span><span>
</span><span id="line-1464"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683070906"><span class="hs-identifier hs-var">loading_dynamic_hs_libs</span></a></span><span>
</span><span id="line-1465"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.html#interpreterProfiled"><span class="hs-identifier hs-var">interpreterProfiled</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621683070891"><span class="hs-identifier hs-var">interp</span></a></span><span>
</span><span id="line-1466"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1467"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070968"><span class="annot"><span class="annottext">diag :: MessageClass
</span><a href="#local-6989586621683070968"><span class="hs-identifier hs-var hs-var hs-var">diag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiagOpts
-&gt; DiagnosticReason -&gt; Maybe DiagnosticCode -&gt; MessageClass
</span><a href="GHC.Utils.Error.html#mkMCDiagnostic"><span class="hs-identifier hs-var">mkMCDiagnostic</span></a></span><span> </span><span class="annot"><span class="annottext">DiagOpts
</span><a href="#local-6989586621683070912"><span class="hs-identifier hs-var">diag_opts</span></a></span><span> </span><span class="annot"><span class="annottext">DiagnosticReason
</span><a href="GHC.Types.Error.html#WarningWithoutFlag"><span class="hs-identifier hs-var">WarningWithoutFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DiagnosticCode
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1468"></span><span>          </span><span class="annot"><span class="annottext">Logger -&gt; MessageClass -&gt; SrcSpan -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070911"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">MessageClass
</span><a href="#local-6989586621683070968"><span class="hs-identifier hs-var">diag</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; IO ()) -&gt; SDoc -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PprStyle -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#withPprStyle"><span class="hs-identifier hs-var">withPprStyle</span></a></span><span> </span><span class="annot"><span class="annottext">PprStyle
</span><a href="GHC.Utils.Outputable.html#defaultErrStyle"><span class="hs-identifier hs-var">defaultErrStyle</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1469"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Interpreter failed to load profiled static library&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'.'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-1470"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; \tTrying dynamic library instead. If this fails try to rebuild&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>
</span><span id="line-1471"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;libraries with profiling support.&quot;</span></span><span>
</span><span id="line-1472"></span><span>          </span><span class="annot"><span class="annottext">LibrarySpec -&gt; IO LibrarySpec
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#DLL"><span class="hs-identifier hs-var">DLL</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1473"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LibrarySpec -&gt; IO LibrarySpec
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; LibrarySpec
</span><a href="GHC.Linker.Types.html#DLL"><span class="hs-identifier hs-var">DLL</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070914"><span class="hs-identifier hs-var">lib</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1474"></span><span>     </span><span class="hs-keyword">infixr</span><span> </span><span class="annot"><a href="#local-6989586621683070899"><span class="hs-operator hs-type">`orElse`</span></a></span><span>
</span><span id="line-1475"></span><span>     </span><span id="local-6989586621683070982"><span class="annot"><span class="annottext">m (Maybe b)
</span><a href="#local-6989586621683070982"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621683070899"><span class="annot"><span class="annottext">orElse :: m (Maybe b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621683070899"><span class="hs-operator hs-var hs-var">`orElse`</span></a></span></span><span> </span><span id="local-6989586621683070983"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621683070983"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Maybe b)
</span><a href="#local-6989586621683070982"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe b) -&gt; (Maybe b -&gt; m b) -&gt; m b
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">m b -&gt; (b -&gt; m b) -&gt; Maybe b -&gt; m b
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621683070983"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1476"></span><span>
</span><span id="line-1477"></span><span>     </span><span id="local-6989586621683069647"><span class="annot"><a href="#local-6989586621683070944"><span class="hs-identifier hs-type">apply</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621683069647"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621683069647"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1478"></span><span>     </span><span id="local-6989586621683070944"><span class="annot"><span class="annottext">apply :: forall a. [IO (Maybe a)] -&gt; IO (Maybe a)
</span><a href="#local-6989586621683070944"><span class="hs-identifier hs-var hs-var">apply</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; IO (Maybe a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1479"></span><span>     </span><span class="annot"><a href="#local-6989586621683070944"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683070988"><span class="annot"><span class="annottext">IO (Maybe a)
</span><a href="#local-6989586621683070988"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683070989"><span class="annot"><span class="annottext">[IO (Maybe a)]
</span><a href="#local-6989586621683070989"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683070990"><span class="annot"><a href="#local-6989586621683070990"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe a)
</span><a href="#local-6989586621683070988"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1480"></span><span>                       </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">isJust</span></span><span> </span><span class="annot"><a href="#local-6989586621683070990"><span class="hs-identifier hs-type">x'</span></a></span><span>
</span><span id="line-1481"></span><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683070990"><span class="hs-identifier hs-type">x'</span></a></span><span>
</span><span id="line-1482"></span><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="#local-6989586621683070944"><span class="hs-identifier hs-type">apply</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070989"><span class="hs-identifier hs-type">xs</span></a></span><span>
</span><span id="line-1483"></span><span>
</span><span id="line-1484"></span><span>     </span><span id="local-6989586621683070929"><span class="annot"><span class="annottext">platform :: Platform
</span><a href="#local-6989586621683070929"><span class="hs-identifier hs-var hs-var">platform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Platform
</span><a href="GHC.Driver.DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070910"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-cpp">
#if defined(CAN_LOAD_DLL)
</span><span>     </span><span id="local-6989586621683070936"><span class="annot"><span class="annottext">arch :: Arch
</span><a href="#local-6989586621683070936"><span class="hs-identifier hs-var hs-var">arch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Arch
</span><a href="GHC.Platform.html#platformArch"><span class="hs-identifier hs-var">platformArch</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070929"><span class="hs-identifier hs-var">platform</span></a></span><span class="hs-cpp">
#endif
</span><span>     </span><span id="local-6989586621683070938"><span class="annot"><span class="annottext">os :: OS
</span><a href="#local-6989586621683070938"><span class="hs-identifier hs-var hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; OS
</span><a href="GHC.Platform.html#platformOS"><span class="hs-identifier hs-var">platformOS</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621683070929"><span class="hs-identifier hs-var">platform</span></a></span><span>
</span><span id="line-1489"></span><span>
</span><span id="line-1490"></span><span class="annot"><a href="GHC.Linker.Loader.html#searchForLibUsingGcc"><span class="hs-identifier hs-type">searchForLibUsingGcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">)</span><span>
</span><span id="line-1491"></span><span id="searchForLibUsingGcc"><span class="annot"><span class="annottext">searchForLibUsingGcc :: Logger -&gt; DynFlags -&gt; String -&gt; [String] -&gt; IO (Maybe String)
</span><a href="GHC.Linker.Loader.html#searchForLibUsingGcc"><span class="hs-identifier hs-var hs-var">searchForLibUsingGcc</span></a></span></span><span> </span><span id="local-6989586621683070992"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070992"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621683070993"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070993"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683070994"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070994"><span class="hs-identifier hs-var">so</span></a></span></span><span> </span><span id="local-6989586621683070995"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070995"><span class="hs-identifier hs-var">dirs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1492"></span><span>   </span><span class="hs-comment">-- GCC does not seem to extend the library search path (using -L) when using</span><span>
</span><span id="line-1493"></span><span>   </span><span class="hs-comment">-- --print-file-name. So instead pass it a new base location.</span><span>
</span><span id="line-1494"></span><span>   </span><span id="local-6989586621683070996"><span class="annot"><a href="#local-6989586621683070996"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DynFlags -&gt; [Option] -&gt; IO String
</span><a href="GHC.SysTools.Tasks.html#askLd"><span class="hs-identifier hs-var">askLd</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683070992"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683070993"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; Option) -&gt; [String] -&gt; [Option]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#FileOption"><span class="hs-identifier hs-var">FileOption</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-B&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683070995"><span class="hs-identifier hs-var">dirs</span></a></span><span>
</span><span id="line-1495"></span><span>                          </span><span class="annot"><span class="annottext">[Option] -&gt; [Option] -&gt; [Option]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;--print-file-name&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070994"><span class="hs-identifier hs-var">so</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1496"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683070998"><span class="annot"><a href="#local-6989586621683070998"><span class="hs-identifier hs-var hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String]
</span><span class="hs-identifier hs-var">lines</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683070996"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1497"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-1498"></span><span>                </span><span id="local-6989586621683071000"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071000"><span class="hs-identifier hs-var">l</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[String]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071000"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-1499"></span><span>   </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683070998"><span class="hs-identifier hs-type">file</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="#local-6989586621683070994"><span class="hs-identifier hs-type">so</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1500"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>
</span><span id="line-1501"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683071001"><span class="annot"><a href="#local-6989586621683071001"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#doesFileExist"><span class="hs-identifier hs-type">doesFileExist</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683070998"><span class="hs-identifier hs-type">file</span></a></span><span> </span><span class="hs-comment">-- file could be a folder (see #16063)</span><span>
</span><span id="line-1502"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683071001"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621683070998"><span class="hs-identifier hs-type">file</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1503"></span><span>
</span><span id="line-1504"></span><span class="hs-comment">-- | Retrieve the list of search directory GCC and the System use to find</span><span>
</span><span id="line-1505"></span><span class="hs-comment">--   libraries and components. See Note [Fork/Exec Windows].</span><span>
</span><span id="line-1506"></span><span class="annot"><a href="GHC.Linker.Loader.html#getGCCPaths"><span class="hs-identifier hs-type">getGCCPaths</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OS</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span>
</span><span id="line-1507"></span><span id="getGCCPaths"><span class="annot"><span class="annottext">getGCCPaths :: Logger -&gt; DynFlags -&gt; OS -&gt; IO [String]
</span><a href="GHC.Linker.Loader.html#getGCCPaths"><span class="hs-identifier hs-var hs-var">getGCCPaths</span></a></span></span><span> </span><span id="local-6989586621683071002"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071002"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621683071003"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683071003"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683071004"><span class="annot"><span class="annottext">OS
</span><a href="#local-6989586621683071004"><span class="hs-identifier hs-var">os</span></a></span></span><span>
</span><span id="line-1508"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OS
</span><a href="#local-6989586621683071004"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">OS -&gt; OS -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">OS
</span><span class="hs-identifier hs-var">OSMinGW32</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Arch
</span><a href="GHC.Platform.html#platformArch"><span class="hs-identifier hs-var">platformArch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; Platform
</span><a href="GHC.Driver.DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683071003"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Arch -&gt; Arch -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Arch
</span><span class="hs-identifier hs-var">ArchWasm32</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1509"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621683071007"><span class="annot"><a href="#local-6989586621683071007"><span class="hs-identifier hs-var">gcc_dirs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DynFlags -&gt; String -&gt; IO [String]
</span><a href="GHC.Linker.Loader.html#getGccSearchDirectory"><span class="hs-identifier hs-var">getGccSearchDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071002"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683071003"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;libraries&quot;</span></span><span>
</span><span id="line-1510"></span><span>           </span><span id="local-6989586621683071008"><span class="annot"><a href="#local-6989586621683071008"><span class="hs-identifier hs-var">sys_dirs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#getSystemDirectories"><span class="hs-identifier hs-type">getSystemDirectories</span></a></span><span>
</span><span id="line-1511"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">nub</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621683071007"><span class="hs-identifier hs-type">gcc_dirs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683071008"><span class="hs-identifier hs-type">sys_dirs</span></a></span><span>
</span><span id="line-1512"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; IO [String]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1513"></span><span>
</span><span id="line-1514"></span><span class="hs-comment">-- | Cache for the GCC search directories as this can't easily change</span><span>
</span><span id="line-1515"></span><span class="hs-comment">--   during an invocation of GHC. (Maybe with some env. variable but we'll)</span><span>
</span><span id="line-1516"></span><span class="hs-comment">--   deal with that highly unlikely scenario then.</span><span>
</span><span id="line-1517"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#gccSearchDirCache"><span class="hs-pragma hs-type">gccSearchDirCache</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1518"></span><span class="annot"><a href="GHC.Linker.Loader.html#gccSearchDirCache"><span class="hs-identifier hs-type">gccSearchDirCache</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1519"></span><span id="gccSearchDirCache"><span class="annot"><span class="annottext">gccSearchDirCache :: IORef [(String, [String])]
</span><a href="GHC.Linker.Loader.html#gccSearchDirCache"><span class="hs-identifier hs-var hs-var">gccSearchDirCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (IORef [(String, [String])]) -&gt; IORef [(String, [String])]
forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef [(String, [String])]) -&gt; IORef [(String, [String])])
-&gt; IO (IORef [(String, [String])]) -&gt; IORef [(String, [String])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(String, [String])] -&gt; IO (IORef [(String, [String])])
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1520"></span><span>
</span><span id="line-1521"></span><span class="hs-comment">-- Note [Fork/Exec Windows]</span><span>
</span><span id="line-1522"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-1523"></span><span class="hs-comment">-- fork/exec is expensive on Windows, for each time we ask GCC for a library we</span><span>
</span><span id="line-1524"></span><span class="hs-comment">-- have to eat the cost of af least 3 of these: gcc -&gt; real_gcc -&gt; cc1.</span><span>
</span><span id="line-1525"></span><span class="hs-comment">-- So instead get a list of location that GCC would search and use findDirs</span><span>
</span><span id="line-1526"></span><span class="hs-comment">-- which hopefully is written in an optimized manner to take advantage of</span><span>
</span><span id="line-1527"></span><span class="hs-comment">-- caching. At the very least we remove the overhead of the fork/exec and waits</span><span>
</span><span id="line-1528"></span><span class="hs-comment">-- which dominate a large percentage of startup time on Windows.</span><span>
</span><span id="line-1529"></span><span class="annot"><a href="GHC.Linker.Loader.html#getGccSearchDirectory"><span class="hs-identifier hs-type">getGccSearchDirectory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span>
</span><span id="line-1530"></span><span id="getGccSearchDirectory"><span class="annot"><span class="annottext">getGccSearchDirectory :: Logger -&gt; DynFlags -&gt; String -&gt; IO [String]
</span><a href="GHC.Linker.Loader.html#getGccSearchDirectory"><span class="hs-identifier hs-var hs-var">getGccSearchDirectory</span></a></span></span><span> </span><span id="local-6989586621683071013"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071013"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621683071014"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683071014"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683071015"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071015"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1531"></span><span>    </span><span id="local-6989586621683071016"><span class="annot"><a href="#local-6989586621683071016"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef [(String, [String])] -&gt; IO [(String, [String])]
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef [(String, [String])]
</span><a href="GHC.Linker.Loader.html#gccSearchDirCache"><span class="hs-identifier hs-var">gccSearchDirCache</span></a></span><span>
</span><span id="line-1532"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="hs-identifier hs-type">lookup</span></span><span> </span><span class="annot"><a href="#local-6989586621683071015"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683071016"><span class="hs-identifier hs-type">cache</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1533"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683071019"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683071019"><span class="hs-identifier hs-var">x</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; IO [String]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683071019"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1534"></span><span>      </span><span class="annot"><span class="annottext">Maybe [String]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1535"></span><span>        </span><span id="local-6989586621683071020"><span class="annot"><a href="#local-6989586621683071020"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DynFlags -&gt; [Option] -&gt; IO String
</span><a href="GHC.SysTools.Tasks.html#askLd"><span class="hs-identifier hs-var">askLd</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071013"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683071014"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; Option
</span><a href="GHC.Utils.CliOption.html#Option"><span class="hs-identifier hs-var">Option</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;--print-search-dirs&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-1536"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683071021"><span class="annot"><a href="#local-6989586621683071021"><span class="hs-identifier hs-var hs-var">line</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; String
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">dropWhile</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">isSpace</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071020"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-1537"></span><span>            </span><span id="local-6989586621683071023"><span class="annot"><a href="#local-6989586621683071023"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071015"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;: =&quot;</span></span><span>
</span><span id="line-1538"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621683071021"><span class="hs-identifier hs-type">line</span></a></span><span>
</span><span id="line-1539"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1540"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683071024"><span class="annot"><a href="#local-6989586621683071024"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String]
</span><a href="#local-6989586621683071025"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; [String]) -&gt; String -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
</span><a href="#local-6989586621683071026"><span class="hs-identifier hs-var">find</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071023"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071021"><span class="hs-identifier hs-var">line</span></a></span><span>
</span><span id="line-1541"></span><span>                  </span><span id="local-6989586621683071027"><span class="annot"><a href="#local-6989586621683071027"><span class="hs-identifier hs-var">dirs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">filterM</span></span><span> </span><span class="annot"><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#doesDirectoryExist"><span class="hs-identifier hs-type">doesDirectoryExist</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683071024"><span class="hs-identifier hs-type">val</span></a></span><span>
</span><span id="line-1542"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">modifyIORef'</span></span><span> </span><span class="annot"><a href="GHC.Linker.Loader.html#gccSearchDirCache"><span class="hs-identifier hs-type">gccSearchDirCache</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">key</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">dirs</span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-1543"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621683071024"><span class="hs-identifier hs-type">val</span></a></span><span>
</span><span id="line-1544"></span><span>      </span><span class="hs-keyword">where</span><span> </span><span class="annot"><a href="#local-6989586621683071025"><span class="hs-identifier hs-type">split</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span>
</span><span id="line-1545"></span><span>            </span><span id="local-6989586621683071025"><span class="annot"><span class="annottext">split :: String -&gt; [String]
</span><a href="#local-6989586621683071025"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span id="local-6989586621683071031"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071031"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; (String, String)
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">break</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">';'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">':'</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071031"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1546"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621683071034"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071034"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071034"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1547"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621683071035"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071035"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683071036"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071036"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071035"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; [String]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String]
</span><a href="#local-6989586621683071025"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071036"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1548"></span><span>
</span><span id="line-1549"></span><span>            </span><span class="annot"><a href="#local-6989586621683071026"><span class="hs-identifier hs-type">find</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-1550"></span><span>            </span><span id="local-6989586621683071026"><span class="annot"><span class="annottext">find :: String -&gt; String -&gt; String
</span><a href="#local-6989586621683071026"><span class="hs-identifier hs-var hs-var">find</span></a></span></span><span> </span><span id="local-6989586621683071037"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071037"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621683071038"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071038"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683071039"><span class="annot"><span class="annottext">lst :: [String]
</span><a href="#local-6989586621683071039"><span class="hs-identifier hs-var hs-var">lst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String]
</span><span class="hs-identifier hs-var">lines</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071038"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1551"></span><span>                           </span><span id="local-6989586621683071040"><span class="annot"><span class="annottext">val :: [String]
</span><a href="#local-6989586621683071040"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; Bool) -&gt; [String] -&gt; [String]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071037"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Bool
</span><span class="hs-operator hs-var">`isPrefixOf`</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683071039"><span class="hs-identifier hs-var">lst</span></a></span><span>
</span><span id="line-1552"></span><span>                       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683071040"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1553"></span><span>                              </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1554"></span><span>                              </span><span id="local-6989586621683071041"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071041"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[String]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; (String, String)
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">break</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'='</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071041"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1555"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1556"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683071042"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071042"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071042"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1557"></span><span>
</span><span id="line-1558"></span><span class="hs-comment">-- | Get a list of system search directories, this to alleviate pressure on</span><span>
</span><span id="line-1559"></span><span class="hs-comment">-- the findSysDll function.</span><span>
</span><span id="line-1560"></span><span class="annot"><a href="GHC.Linker.Loader.html#getSystemDirectories"><span class="hs-identifier hs-type">getSystemDirectories</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span class="hs-identifier">getSystemDirectories</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">getSystemDirectory</span><span class="hs-cpp">
#else
</span><span id="getSystemDirectories"><span class="annot"><span class="annottext">getSystemDirectories :: IO [String]
</span><a href="GHC.Linker.Loader.html#getSystemDirectories"><span class="hs-identifier hs-var hs-var">getSystemDirectories</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; IO [String]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-1567"></span><span class="hs-comment">-- | Merge the given list of paths with those in the environment variable</span><span>
</span><span id="line-1568"></span><span class="hs-comment">--   given. If the variable does not exist then just return the identity.</span><span>
</span><span id="line-1569"></span><span class="annot"><a href="GHC.Linker.Loader.html#addEnvPaths"><span class="hs-identifier hs-type">addEnvPaths</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span>
</span><span id="line-1570"></span><span id="addEnvPaths"><span class="annot"><span class="annottext">addEnvPaths :: String -&gt; [String] -&gt; IO [String]
</span><a href="GHC.Linker.Loader.html#addEnvPaths"><span class="hs-identifier hs-var hs-var">addEnvPaths</span></a></span></span><span> </span><span id="local-6989586621683071043"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071043"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621683071044"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683071044"><span class="hs-identifier hs-var">list</span></a></span></span><span>
</span><span id="line-1571"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- According to POSIX (chapter 8.3) a zero-length prefix means current</span><span>
</span><span id="line-1572"></span><span>       </span><span class="hs-comment">-- working directory. Replace empty strings in the env variable with</span><span>
</span><span id="line-1573"></span><span>       </span><span class="hs-comment">-- `working_dir` (see also #14695).</span><span>
</span><span id="line-1574"></span><span>       </span><span id="local-6989586621683071045"><span class="annot"><a href="#local-6989586621683071045"><span class="hs-identifier hs-var">working_dir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO String
</span><a href="../../directory-1.3.9.0-af18/src/System.Directory.html#getCurrentDirectory"><span class="hs-identifier hs-var">getCurrentDirectory</span></a></span><span>
</span><span id="line-1575"></span><span>       </span><span id="local-6989586621683071047"><span class="annot"><a href="#local-6989586621683071047"><span class="hs-identifier hs-var">values</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">lookupEnv</span></span><span> </span><span class="annot"><a href="#local-6989586621683071043"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-1576"></span><span>       </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683071047"><span class="hs-identifier hs-type">values</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1577"></span><span>         </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; IO [String]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683071044"><span class="hs-identifier hs-var">list</span></a></span><span>
</span><span id="line-1578"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683071048"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071048"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; IO [String]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; IO [String]) -&gt; [String] -&gt; IO [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621683071044"><span class="hs-identifier hs-var">list</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; [String]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; [String]
</span><a href="#local-6989586621683071049"><span class="hs-identifier hs-var">splitEnv</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071045"><span class="hs-identifier hs-var">working_dir</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071048"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1579"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1580"></span><span>      </span><span class="annot"><a href="#local-6989586621683071049"><span class="hs-identifier hs-type">splitEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span>
</span><span id="line-1581"></span><span>      </span><span id="local-6989586621683071049"><span class="annot"><span class="annottext">splitEnv :: String -&gt; String -&gt; [String]
</span><a href="#local-6989586621683071049"><span class="hs-identifier hs-var hs-var">splitEnv</span></a></span></span><span> </span><span id="local-6989586621683071050"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071050"><span class="hs-identifier hs-var">working_dir</span></a></span></span><span> </span><span id="local-6989586621683071051"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071051"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1582"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; String -&gt; (String, String)
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">break</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621683071052"><span class="hs-identifier hs-var">envListSep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071051"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1583"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621683071053"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071053"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1584"></span><span>            </span><span class="hs-special">[</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071053"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071050"><span class="hs-identifier hs-var">working_dir</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071053"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1585"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621683071054"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071054"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683071055"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071055"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1586"></span><span>            </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071054"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071050"><span class="hs-identifier hs-var">working_dir</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071054"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; [String]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; [String]
</span><a href="#local-6989586621683071049"><span class="hs-identifier hs-var">splitEnv</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071050"><span class="hs-identifier hs-var">working_dir</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071055"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span>      </span><span class="hs-identifier">envListSep</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">';'</span><span class="hs-cpp">
#else
</span><span>      </span><span id="local-6989586621683071052"><span class="annot"><span class="annottext">envListSep :: Char
</span><a href="#local-6989586621683071052"><span class="hs-identifier hs-var hs-var">envListSep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">':'</span></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-1593"></span><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><span id="line-1594"></span><span class="hs-comment">-- Loading a dynamic library (dlopen()-ish on Unix, LoadLibrary-ish on Win32)</span><span>
</span><span id="line-1595"></span><span>
</span><span id="line-1596"></span><span>
</span><span id="line-1597"></span><span class="annot"><span class="hs-comment">{- **********************************************************************

                Helper functions

  ********************************************************************* -}</span></span><span>
</span><span id="line-1602"></span><span>
</span><span id="line-1603"></span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutSDoc"><span class="hs-identifier hs-type">maybePutSDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1604"></span><span id="maybePutSDoc"><span class="annot"><span class="annottext">maybePutSDoc :: Logger -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutSDoc"><span class="hs-identifier hs-var hs-var">maybePutSDoc</span></a></span></span><span> </span><span id="local-6989586621683071056"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071056"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621683071057"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683071057"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-1605"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logVerbAtLeast"><span class="hs-identifier hs-var">logVerbAtLeast</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071056"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1606"></span><span>          </span><span class="annot"><span class="annottext">Logger -&gt; MessageClass -&gt; SrcSpan -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071056"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-1607"></span><span>              </span><span class="annot"><span class="annottext">MessageClass
</span><a href="GHC.Types.Error.html#MCInteractive"><span class="hs-identifier hs-var">MCInteractive</span></a></span><span>
</span><span id="line-1608"></span><span>              </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a></span><span>
</span><span id="line-1609"></span><span>              </span><span class="annot"><span class="annottext">(SDoc -&gt; IO ()) -&gt; SDoc -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PprStyle -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#withPprStyle"><span class="hs-identifier hs-var">withPprStyle</span></a></span><span> </span><span class="annot"><span class="annottext">PprStyle
</span><a href="GHC.Utils.Outputable.html#defaultUserStyle"><span class="hs-identifier hs-var">defaultUserStyle</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683071057"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1610"></span><span>
</span><span id="line-1611"></span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStr"><span class="hs-identifier hs-type">maybePutStr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1612"></span><span id="maybePutStr"><span class="annot"><span class="annottext">maybePutStr :: Logger -&gt; String -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutStr"><span class="hs-identifier hs-var hs-var">maybePutStr</span></a></span></span><span> </span><span id="local-6989586621683071060"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071060"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621683071061"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071061"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutSDoc"><span class="hs-identifier hs-var">maybePutSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071060"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071061"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1613"></span><span>
</span><span id="line-1614"></span><span class="annot"><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-type">maybePutStrLn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1615"></span><span id="maybePutStrLn"><span class="annot"><span class="annottext">maybePutStrLn :: Logger -&gt; String -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutStrLn"><span class="hs-identifier hs-var hs-var">maybePutStrLn</span></a></span></span><span> </span><span id="local-6989586621683071062"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071062"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621683071063"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071063"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Linker.Loader.html#maybePutSDoc"><span class="hs-identifier hs-var">maybePutSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621683071062"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621683071063"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1616"></span></pre></body></html>