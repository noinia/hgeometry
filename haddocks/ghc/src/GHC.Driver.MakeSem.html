<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BlockArguments #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE NumericUnderscores #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-comment">-- | Implementation of a jobserver using system semaphores.</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html"><span class="hs-identifier">GHC.Driver.MakeSem</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * JSem: parallelism semaphore backed</span></span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-comment">-- by a system semaphore (Posix/Windows)</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="GHC.Driver.MakeSem.html#runJSemAbstractSem"><span class="hs-identifier">runJSemAbstractSem</span></a></span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span>  </span><span class="annot"><span class="hs-comment">-- * System semaphores</span></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#Semaphore"><span class="hs-identifier">Semaphore</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#SemaphoreName"><span class="hs-identifier">SemaphoreName</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Abstract semaphores</span></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#AbstractSem"><span class="hs-identifier">AbstractSem</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#withAbstractSem"><span class="hs-identifier">withAbstractSem</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/GHC.Conc.html"><span class="hs-identifier">GHC.Conc</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html"><span class="hs-identifier">GHC.Data.OrdList</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/GHC.IO.Exception.html"><span class="hs-identifier">GHC.IO.Exception</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Json.html"><span class="hs-identifier">GHC.Utils.Json</span></a></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html"><span class="hs-identifier">System.Semaphore</span></a></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html"><span class="hs-identifier">Control.Monad.Catch</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Concurrent.MVar.html"><span class="hs-identifier">Control.Concurrent.MVar</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.html"><span class="hs-identifier">Control.Concurrent.STM</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Functor.html"><span class="hs-identifier">Data.Functor</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Debug.Trace.html"><span class="hs-identifier">Debug.Trace</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-comment">---------------------------------------</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- Semaphore jobserver</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-comment">-- | A jobserver based off a system 'Semaphore'.</span><span>
</span><span id="line-47"></span><span class="hs-comment">--</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- Keeps track of the pending jobs and resources</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- available from the semaphore.</span><span>
</span><span id="line-50"></span><span class="hs-keyword">data</span><span> </span><span id="Jobserver"><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-var">Jobserver</span></a></span></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Jobserver"><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-var">Jobserver</span></a></span></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="jSemaphore"><span class="annot"><span class="annottext">Jobserver -&gt; Semaphore
</span><a href="GHC.Driver.MakeSem.html#jSemaphore"><span class="hs-identifier hs-var hs-var">jSemaphore</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#Semaphore"><span class="hs-identifier hs-type">Semaphore</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The semaphore which controls available resources</span></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="jobs"><span class="annot"><span class="annottext">Jobserver -&gt; TVar JobResources
</span><a href="GHC.Driver.MakeSem.html#jobs"><span class="hs-identifier hs-var hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-comment">-- ^ The currently pending jobs, and the resources</span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-comment">-- obtained from the semaphore</span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">data</span><span> </span><span id="JobserverOptions"><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverOptions"><span class="hs-identifier hs-var">JobserverOptions</span></a></span></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="JobserverOptions"><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverOptions"><span class="hs-identifier hs-var">JobserverOptions</span></a></span></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="releaseDebounce"><span class="annot"><span class="annottext">JobserverOptions -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#releaseDebounce"><span class="hs-identifier hs-var hs-var">releaseDebounce</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-62"></span><span>     </span><span class="hs-comment">-- ^ Minimum delay, in milliseconds, between acquiring a token</span><span>
</span><span id="line-63"></span><span>     </span><span class="hs-comment">-- and releasing a token.</span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="setNumCapsDebounce"><span class="annot"><span class="annottext">JobserverOptions -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#setNumCapsDebounce"><span class="hs-identifier hs-var hs-var">setNumCapsDebounce</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-comment">-- ^ Minimum delay, in milliseconds, between two consecutive</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-comment">-- calls of 'setNumCapabilities'.</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#defaultJobserverOptions"><span class="hs-identifier hs-type">defaultJobserverOptions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverOptions"><span class="hs-identifier hs-type">JobserverOptions</span></a></span><span>
</span><span id="line-70"></span><span id="defaultJobserverOptions"><span class="annot"><span class="annottext">defaultJobserverOptions :: JobserverOptions
</span><a href="GHC.Driver.MakeSem.html#defaultJobserverOptions"><span class="hs-identifier hs-var hs-var">defaultJobserverOptions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverOptions"><span class="hs-identifier hs-type">JobserverOptions</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">releaseDebounce :: Int
</span><a href="GHC.Driver.MakeSem.html#releaseDebounce"><span class="hs-identifier hs-var">releaseDebounce</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000</span></span><span> </span><span class="hs-comment">-- 1 second</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">setNumCapsDebounce :: Int
</span><a href="GHC.Driver.MakeSem.html#setNumCapsDebounce"><span class="hs-identifier hs-var">setNumCapsDebounce</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000</span></span><span> </span><span class="hs-comment">-- 1 second</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- | Resources available for running jobs, i.e.</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- tokens obtained from the parallelism semaphore.</span><span>
</span><span id="line-78"></span><span class="hs-keyword">data</span><span> </span><span id="JobResources"><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-var">JobResources</span></a></span></span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Jobs"><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-var">Jobs</span></a></span></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="tokensOwned"><span class="annot"><span class="annottext">JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var hs-var">tokensOwned</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ How many tokens have been claimed from the semaphore</span></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tokensFree"><span class="annot"><span class="annottext">JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var hs-var">tokensFree</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ How many tokens are not currently being used</span></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="jobsWaiting"><span class="annot"><span class="annottext">JobResources -&gt; OrdList (TMVar ())
</span><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var hs-var">jobsWaiting</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#TMVar"><span class="hs-identifier hs-type">TMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-comment">-- ^ Pending jobs waiting on a token, the job will be blocked on the TMVar so putting into</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- the TMVar will allow the job to continue.</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-90"></span><span>  </span><span id="local-6989586621682473713"><span class="annot"><span class="annottext">ppr :: JobResources -&gt; SDoc
</span><a href="#local-6989586621682473713"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span class="hs-special">{</span><span id="local-6989586621682473715"><span id="local-6989586621682473716"><span id="local-6989586621682473717"><span class="annot"><span class="annottext">Int
OrdList (TMVar ())
tokensOwned :: JobResources -&gt; Int
tokensFree :: JobResources -&gt; Int
jobsWaiting :: JobResources -&gt; OrdList (TMVar ())
tokensOwned :: Int
tokensFree :: Int
jobsWaiting :: OrdList (TMVar ())
</span><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;JobResources&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>
</span><span id="line-92"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span>
</span><span id="line-93"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;owned=&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473715"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span>
</span><span id="line-94"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;free=&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473716"><span class="hs-identifier hs-var">tokensFree</span></a></span><span>
</span><span id="line-95"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_waiting=&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList (TMVar ()) -&gt; Int
forall a. OrdList a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">OrdList (TMVar ())
</span><a href="#local-6989586621682473717"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>          </span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="annot"><span class="hs-comment">-- | Add one new token.</span></span><span>
</span><span id="line-99"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#addToken"><span class="hs-identifier hs-type">addToken</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span>
</span><span id="line-100"></span><span id="addToken"><span class="annot"><span class="annottext">addToken :: JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#addToken"><span class="hs-identifier hs-var hs-var">addToken</span></a></span></span><span> </span><span id="local-6989586621682473725"><span class="annot"><span class="annottext">jobs :: JobResources
</span><a href="#local-6989586621682473725"><span class="hs-identifier hs-var">jobs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tokensOwned :: JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473726"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473726"><span class="hs-identifier hs-var">owned</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tokensFree :: JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473727"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473727"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473725"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473726"><span class="hs-identifier hs-type">owned</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473727"><span class="hs-identifier hs-type">free</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="annot"><span class="hs-comment">-- | Free one token.</span></span><span>
</span><span id="line-104"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#addFreeToken"><span class="hs-identifier hs-type">addFreeToken</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span>
</span><span id="line-105"></span><span id="addFreeToken"><span class="annot"><span class="annottext">addFreeToken :: JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#addFreeToken"><span class="hs-identifier hs-var hs-var">addFreeToken</span></a></span></span><span> </span><span id="local-6989586621682473730"><span class="annot"><span class="annottext">jobs :: JobResources
</span><a href="#local-6989586621682473730"><span class="hs-identifier hs-var">jobs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tokensFree :: JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473731"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473731"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; JobResources -&gt; JobResources
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473730"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473731"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;addFreeToken:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473730"><span class="hs-identifier hs-var">jobs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473731"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="annottext">(JobResources -&gt; JobResources) -&gt; JobResources -&gt; JobResources
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473730"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473731"><span class="hs-identifier hs-type">free</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="annot"><span class="hs-comment">-- | Use up one token.</span></span><span>
</span><span id="line-111"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#removeFreeToken"><span class="hs-identifier hs-type">removeFreeToken</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span>
</span><span id="line-112"></span><span id="removeFreeToken"><span class="annot"><span class="annottext">removeFreeToken :: JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#removeFreeToken"><span class="hs-identifier hs-var hs-var">removeFreeToken</span></a></span></span><span> </span><span id="local-6989586621682473735"><span class="annot"><span class="annottext">jobs :: JobResources
</span><a href="#local-6989586621682473735"><span class="hs-identifier hs-var">jobs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tokensFree :: JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473736"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473736"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; JobResources -&gt; JobResources
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473736"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;removeFreeToken:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473736"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><span class="annottext">(JobResources -&gt; JobResources) -&gt; JobResources -&gt; JobResources
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473735"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473736"><span class="hs-identifier hs-type">free</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="annot"><span class="hs-comment">-- | Return one owned token.</span></span><span>
</span><span id="line-118"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#removeOwnedToken"><span class="hs-identifier hs-type">removeOwnedToken</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span>
</span><span id="line-119"></span><span id="removeOwnedToken"><span class="annot"><span class="annottext">removeOwnedToken :: JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#removeOwnedToken"><span class="hs-identifier hs-var hs-var">removeOwnedToken</span></a></span></span><span> </span><span id="local-6989586621682473738"><span class="annot"><span class="annottext">jobs :: JobResources
</span><a href="#local-6989586621682473738"><span class="hs-identifier hs-var">jobs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tokensOwned :: JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473739"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473739"><span class="hs-identifier hs-var">owned</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; JobResources -&gt; JobResources
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473739"><span class="hs-identifier hs-var">owned</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;removeOwnedToken:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473739"><span class="hs-identifier hs-var">owned</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>  </span><span class="annot"><span class="annottext">(JobResources -&gt; JobResources) -&gt; JobResources -&gt; JobResources
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473738"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473739"><span class="hs-identifier hs-type">owned</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="annot"><span class="hs-comment">-- | Add one new job to the end of the list of pending jobs.</span></span><span>
</span><span id="line-125"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#addJob"><span class="hs-identifier hs-type">addJob</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#TMVar"><span class="hs-identifier hs-type">TMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span>
</span><span id="line-126"></span><span id="addJob"><span class="annot"><span class="annottext">addJob :: TMVar () -&gt; JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#addJob"><span class="hs-identifier hs-var hs-var">addJob</span></a></span></span><span> </span><span id="local-6989586621682473741"><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621682473741"><span class="hs-identifier hs-var">job</span></a></span></span><span> </span><span id="local-6989586621682473742"><span class="annot"><span class="annottext">jobs :: JobResources
</span><a href="#local-6989586621682473742"><span class="hs-identifier hs-var">jobs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jobsWaiting :: JobResources -&gt; OrdList (TMVar ())
</span><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473743"><span class="annot"><span class="annottext">OrdList (TMVar ())
</span><a href="#local-6989586621682473743"><span class="hs-identifier hs-var">wait</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473742"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473743"><span class="hs-identifier hs-type">wait</span></a></span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#SnocOL"><span class="hs-operator hs-type">`SnocOL`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473741"><span class="hs-identifier hs-type">job</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="annot"><span class="hs-comment">-- | The state of the semaphore job server.</span></span><span>
</span><span id="line-130"></span><span class="hs-keyword">data</span><span> </span><span id="JobserverState"><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-var">JobserverState</span></a></span></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="JobserverState"><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-var">JobserverState</span></a></span></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="jobserverAction"><span class="annot"><span class="annottext">JobserverState -&gt; JobserverAction
</span><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var hs-var">jobserverAction</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverAction"><span class="hs-identifier hs-type">JobserverAction</span></a></span><span>
</span><span id="line-133"></span><span>      </span><span class="hs-comment">-- ^ The current action being performed by the</span><span>
</span><span id="line-134"></span><span>      </span><span class="hs-comment">-- job server.</span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="canChangeNumCaps"><span class="annot"><span class="annottext">JobserverState -&gt; TVar Bool
</span><a href="GHC.Driver.MakeSem.html#canChangeNumCaps"><span class="hs-identifier hs-var hs-var">canChangeNumCaps</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>      </span><span class="hs-comment">-- ^ A TVar that signals whether it has been long</span><span>
</span><span id="line-137"></span><span>      </span><span class="hs-comment">-- enough since we last changed 'numCapabilities'.</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="canReleaseToken"><span class="annot"><span class="annottext">JobserverState -&gt; TVar Bool
</span><a href="GHC.Driver.MakeSem.html#canReleaseToken"><span class="hs-identifier hs-var hs-var">canReleaseToken</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>      </span><span class="hs-comment">-- ^ A TVar that signals whether we last acquired</span><span>
</span><span id="line-140"></span><span>      </span><span class="hs-comment">-- a token long enough ago that we can now release</span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-comment">-- a token.</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-143"></span><span class="hs-keyword">data</span><span> </span><span id="JobserverAction"><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverAction"><span class="hs-identifier hs-var">JobserverAction</span></a></span></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-comment">-- | The jobserver is idle: no thread is currently</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-comment">-- interacting with the semaphore.</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Idle"><span class="annot"><a href="GHC.Driver.MakeSem.html#Idle"><span class="hs-identifier hs-var">Idle</span></a></span></span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A thread is waiting for a token on the semaphore.</span></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Acquiring"><span class="annot"><a href="GHC.Driver.MakeSem.html#Acquiring"><span class="hs-identifier hs-var">Acquiring</span></a></span></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="activeWaitId"><span class="annot"><span class="annottext">JobserverAction -&gt; WaitId
</span><a href="GHC.Driver.MakeSem.html#activeWaitId"><span class="hs-identifier hs-var hs-var">activeWaitId</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#WaitId"><span class="hs-identifier hs-type">WaitId</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="threadFinished"><span class="annot"><span class="annottext">JobserverAction -&gt; TMVar (Maybe SomeException)
</span><a href="GHC.Driver.MakeSem.html#threadFinished"><span class="hs-identifier hs-var hs-var">threadFinished</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#TMVar"><span class="hs-identifier hs-type">TMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.SomeException</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">-- | Retrieve the 'TMVar' that signals if the current thread has finished,</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- if any thread is currently active in the jobserver.</span><span>
</span><span id="line-154"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#activeThread_maybe"><span class="hs-identifier hs-type">activeThread_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverAction"><span class="hs-identifier hs-type">JobserverAction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#TMVar"><span class="hs-identifier hs-type">TMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.SomeException</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span id="activeThread_maybe"><span class="annot"><span class="annottext">activeThread_maybe :: JobserverAction -&gt; Maybe (TMVar (Maybe SomeException))
</span><a href="GHC.Driver.MakeSem.html#activeThread_maybe"><span class="hs-identifier hs-var hs-var">activeThread_maybe</span></a></span></span><span> </span><span class="annot"><span class="annottext">JobserverAction
</span><a href="GHC.Driver.MakeSem.html#Idle"><span class="hs-identifier hs-var">Idle</span></a></span><span>                                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TMVar (Maybe SomeException))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-156"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#activeThread_maybe"><span class="hs-identifier hs-var">activeThread_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#Acquiring"><span class="hs-identifier hs-type">Acquiring</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">threadFinished :: JobserverAction -&gt; TMVar (Maybe SomeException)
</span><a href="GHC.Driver.MakeSem.html#threadFinished"><span class="hs-identifier hs-var">threadFinished</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473755"><span class="annot"><span class="annottext">TMVar (Maybe SomeException)
</span><a href="#local-6989586621682473755"><span class="hs-identifier hs-var">tmvar</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMVar (Maybe SomeException) -&gt; Maybe (TMVar (Maybe SomeException))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TMVar (Maybe SomeException)
</span><a href="#local-6989586621682473755"><span class="hs-identifier hs-var">tmvar</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="hs-comment">-- | Whether we should try to acquire a new token from the semaphore:</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- there is a pending job and no free tokens.</span><span>
</span><span id="line-160"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#guardAcquire"><span class="hs-identifier hs-type">guardAcquire</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-161"></span><span id="guardAcquire"><span class="annot"><span class="annottext">guardAcquire :: JobResources -&gt; Bool
</span><a href="GHC.Driver.MakeSem.html#guardAcquire"><span class="hs-identifier hs-var hs-var">guardAcquire</span></a></span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682473757"><span class="annot"><span class="annottext">Int
tokensFree :: JobResources -&gt; Int
tokensFree :: Int
</span><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var hs-var">tokensFree</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473758"><span class="annot"><span class="annottext">OrdList (TMVar ())
jobsWaiting :: JobResources -&gt; OrdList (TMVar ())
jobsWaiting :: OrdList (TMVar ())
</span><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var hs-var">jobsWaiting</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473757"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList (TMVar ()) -&gt; Bool
forall a. OrdList a -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">OrdList (TMVar ())
</span><a href="#local-6989586621682473758"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="hs-comment">-- | Whether we should release a token from the semaphore:</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- there are no pending jobs and we can release a token.</span><span>
</span><span id="line-166"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#guardRelease"><span class="hs-identifier hs-type">guardRelease</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-167"></span><span id="guardRelease"><span class="annot"><span class="annottext">guardRelease :: JobResources -&gt; Bool
</span><a href="GHC.Driver.MakeSem.html#guardRelease"><span class="hs-identifier hs-var hs-var">guardRelease</span></a></span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682473763"><span class="annot"><span class="annottext">Int
tokensFree :: JobResources -&gt; Int
tokensFree :: Int
</span><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var hs-var">tokensFree</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473764"><span class="annot"><span class="annottext">Int
tokensOwned :: JobResources -&gt; Int
tokensOwned :: Int
</span><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var hs-var">tokensOwned</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473765"><span class="annot"><span class="annottext">OrdList (TMVar ())
jobsWaiting :: JobResources -&gt; OrdList (TMVar ())
jobsWaiting :: OrdList (TMVar ())
</span><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var hs-var">jobsWaiting</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList (TMVar ()) -&gt; Bool
forall a. OrdList a -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">OrdList (TMVar ())
</span><a href="#local-6989586621682473765"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473763"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473764"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="hs-comment">---------------------------------------</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- Semaphore jobserver implementation</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-comment">-- | Add one pending job to the jobserver.</span><span>
</span><span id="line-174"></span><span class="hs-comment">--</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- Blocks, waiting on the jobserver to supply a free token.</span><span>
</span><span id="line-176"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#acquireJob"><span class="hs-identifier hs-type">acquireJob</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span id="acquireJob"><span class="annot"><span class="annottext">acquireJob :: TVar JobResources -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#acquireJob"><span class="hs-identifier hs-var hs-var">acquireJob</span></a></span></span><span> </span><span id="local-6989586621682473767"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473767"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682473768"><span class="annot"><a href="#local-6989586621682473768"><span class="hs-identifier hs-var">job_tmvar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473769"><span class="annot"><a href="#local-6989586621682473769"><span class="hs-identifier hs-var">_jobs0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; STM ((TMVar (), JobResources), Maybe JobResources)
-&gt; IO (TMVar (), JobResources)
forall a. String -&gt; STM (a, Maybe JobResources) -&gt; IO a
</span><a href="GHC.Driver.MakeSem.html#tracedAtomically"><span class="hs-identifier hs-var">tracedAtomically</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;acquire&quot;</span></span><span> </span><span class="annot"><span class="annottext">(STM ((TMVar (), JobResources), Maybe JobResources)
 -&gt; IO (TMVar (), JobResources))
-&gt; STM ((TMVar (), JobResources), Maybe JobResources)
-&gt; IO (TMVar (), JobResources)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">TVar JobResources
-&gt; (JobResources -&gt; STM ((TMVar (), JobResources), JobResources))
-&gt; STM ((TMVar (), JobResources), Maybe JobResources)
forall a.
HasCallStack =&gt;
TVar JobResources
-&gt; (JobResources -&gt; STM (a, JobResources))
-&gt; STM (a, Maybe JobResources)
</span><a href="GHC.Driver.MakeSem.html#modifyJobResources"><span class="hs-identifier hs-var">modifyJobResources</span></a></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473767"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682473772"><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473772"><span class="hs-identifier hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>      </span><span id="local-6989586621682473773"><span class="annot"><a href="#local-6989586621682473773"><span class="hs-identifier hs-var">job_tmvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TMVar ())
forall a. STM (TMVar a)
</span><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#newEmptyTMVar"><span class="hs-identifier hs-var">newEmptyTMVar</span></a></span><span>
</span><span id="line-181"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682473773"><span class="hs-identifier hs-type">job_tmvar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682473772"><span class="hs-identifier hs-type">jobs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#addJob"><span class="hs-identifier hs-type">addJob</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473773"><span class="hs-identifier hs-type">job_tmvar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473772"><span class="hs-identifier hs-type">jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">atomically</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#takeTMVar"><span class="hs-identifier hs-type">takeTMVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473768"><span class="hs-identifier hs-type">job_tmvar</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="hs-comment">-- | Signal to the job server that one job has completed,</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- releasing its corresponding token.</span><span>
</span><span id="line-186"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#releaseJob"><span class="hs-identifier hs-type">releaseJob</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span id="releaseJob"><span class="annot"><span class="annottext">releaseJob :: TVar JobResources -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#releaseJob"><span class="hs-identifier hs-var hs-var">releaseJob</span></a></span></span><span> </span><span id="local-6989586621682473778"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473778"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; STM ((), Maybe JobResources) -&gt; IO ()
forall a. String -&gt; STM (a, Maybe JobResources) -&gt; IO a
</span><a href="GHC.Driver.MakeSem.html#tracedAtomically"><span class="hs-identifier hs-var">tracedAtomically</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;release&quot;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>    </span><span class="annot"><span class="annottext">TVar JobResources
-&gt; (JobResources -&gt; STM ((), JobResources))
-&gt; STM ((), Maybe JobResources)
forall a.
HasCallStack =&gt;
TVar JobResources
-&gt; (JobResources -&gt; STM (a, JobResources))
-&gt; STM (a, Maybe JobResources)
</span><a href="GHC.Driver.MakeSem.html#modifyJobResources"><span class="hs-identifier hs-var">modifyJobResources</span></a></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473778"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682473779"><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473779"><span class="hs-identifier hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-190"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; STM ()
forall (m :: * -&gt; *).
(HasCallStack, Applicative m) =&gt;
Bool -&gt; SDoc -&gt; m ()
</span><a href="GHC.Utils.Panic.html#massertPpr"><span class="hs-identifier hs-var">massertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473779"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473779"><span class="hs-identifier hs-var">jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;releaseJob: more free jobs than owned jobs!&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>      </span><span class="annot"><span class="annottext">((), JobResources) -&gt; STM ((), JobResources)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#addFreeToken"><span class="hs-identifier hs-var">addFreeToken</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473779"><span class="hs-identifier hs-var">jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- | Release all tokens owned from the semaphore (to clean up</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- the jobserver at the end).</span><span>
</span><span id="line-197"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#cleanupJobserver"><span class="hs-identifier hs-type">cleanupJobserver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span id="cleanupJobserver"><span class="annot"><span class="annottext">cleanupJobserver :: Jobserver -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#cleanupJobserver"><span class="hs-identifier hs-var hs-var">cleanupJobserver</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jSemaphore :: Jobserver -&gt; Semaphore
</span><a href="GHC.Driver.MakeSem.html#jSemaphore"><span class="hs-identifier hs-var">jSemaphore</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473783"><span class="annot"><span class="annottext">Semaphore
</span><a href="#local-6989586621682473783"><span class="hs-identifier hs-var">sem</span></a></span></span><span>
</span><span id="line-199"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">jobs :: Jobserver -&gt; TVar JobResources
</span><a href="GHC.Driver.MakeSem.html#jobs"><span class="hs-identifier hs-var">jobs</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473784"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473784"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473785"><span class="annot"><a href="#local-6989586621682473785"><span class="hs-identifier hs-var">owned</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar JobResources -&gt; IO JobResources
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473784"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682473787"><span class="annot"><a href="#local-6989586621682473787"><span class="hs-identifier hs-var hs-var">toks_to_release</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473785"><span class="hs-identifier hs-var">owned</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-comment">-- Subtract off the implicit token: whoever spawned the ghc process</span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-comment">-- in the first place is responsible for that token.</span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#releaseSemaphore"><span class="hs-identifier hs-type">releaseSemaphore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473783"><span class="hs-identifier hs-type">sem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473787"><span class="hs-identifier hs-type">toks_to_release</span></a></span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span class="hs-comment">-- | Dispatch the available tokens acquired from the semaphore</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- to the pending jobs in the job server.</span><span>
</span><span id="line-209"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#dispatchTokens"><span class="hs-identifier hs-type">dispatchTokens</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span>
</span><span id="line-210"></span><span id="dispatchTokens"><span class="annot"><span class="annottext">dispatchTokens :: JobResources -&gt; STM JobResources
</span><a href="GHC.Driver.MakeSem.html#dispatchTokens"><span class="hs-identifier hs-var hs-var">dispatchTokens</span></a></span></span><span> </span><span id="local-6989586621682473790"><span class="annot"><span class="annottext">jobs :: JobResources
</span><a href="#local-6989586621682473790"><span class="hs-identifier hs-var">jobs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tokensFree :: JobResources -&gt; Int
</span><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473791"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473791"><span class="hs-identifier hs-var">toks_free</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">jobsWaiting :: JobResources -&gt; OrdList (TMVar ())
</span><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473792"><span class="annot"><span class="annottext">OrdList (TMVar ())
</span><a href="#local-6989586621682473792"><span class="hs-identifier hs-var">wait</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473791"><span class="hs-identifier hs-var">toks_free</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473793"><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621682473793"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#ConsOL"><span class="hs-operator hs-type">`ConsOL`</span></a></span><span> </span><span id="local-6989586621682473795"><span class="annot"><span class="annottext">OrdList (TMVar ())
</span><a href="#local-6989586621682473795"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OrdList (TMVar ())
</span><a href="#local-6989586621682473792"><span class="hs-identifier hs-var">wait</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-comment">-- There's a pending job and a free token:</span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-comment">-- pass on the token to that job, and recur.</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">TMVar () -&gt; () -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#putTMVar"><span class="hs-identifier hs-var">putTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621682473793"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682473797"><span class="annot"><span class="annottext">jobs' :: JobResources
</span><a href="#local-6989586621682473797"><span class="hs-identifier hs-var hs-var">jobs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473790"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473791"><span class="hs-identifier hs-type">toks_free</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">-</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473795"><span class="hs-identifier hs-type">rest</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-218"></span><span>      </span><span class="annot"><span class="annottext">JobResources -&gt; STM JobResources
</span><a href="GHC.Driver.MakeSem.html#dispatchTokens"><span class="hs-identifier hs-var">dispatchTokens</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473797"><span class="hs-identifier hs-var">jobs'</span></a></span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JobResources -&gt; STM JobResources
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473790"><span class="hs-identifier hs-var">jobs</span></a></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-comment">-- | Update the available resources used from a semaphore, dispatching</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- any newly acquired resources.</span><span>
</span><span id="line-224"></span><span class="hs-comment">--</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- Invariant: if the number of available resources decreases, there</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- must be no pending jobs.</span><span>
</span><span id="line-227"></span><span class="hs-comment">--</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- All modifications should go through this function to ensure the contents</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- of the 'TVar' remains in normal form.</span><span>
</span><span id="line-230"></span><span id="local-6989586621682473427"><span class="annot"><a href="GHC.Driver.MakeSem.html#modifyJobResources"><span class="hs-identifier hs-type">modifyJobResources</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span>
</span><span id="line-231"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682473427"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682473427"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-233"></span><span id="modifyJobResources"><span class="annot"><span class="annottext">modifyJobResources :: forall a.
HasCallStack =&gt;
TVar JobResources
-&gt; (JobResources -&gt; STM (a, JobResources))
-&gt; STM (a, Maybe JobResources)
</span><a href="GHC.Driver.MakeSem.html#modifyJobResources"><span class="hs-identifier hs-var hs-var">modifyJobResources</span></a></span></span><span> </span><span id="local-6989586621682473814"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473814"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span id="local-6989586621682473815"><span class="annot"><span class="annottext">JobResources -&gt; STM (a, JobResources)
</span><a href="#local-6989586621682473815"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>  </span><span id="local-6989586621682473816"><span class="annot"><a href="#local-6989586621682473816"><span class="hs-identifier hs-var">old_jobs</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar JobResources -&gt; STM JobResources
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473814"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682473818"><span class="annot"><a href="#local-6989586621682473818"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473819"><span class="annot"><a href="#local-6989586621682473819"><span class="hs-identifier hs-var">jobs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682473815"><span class="hs-identifier hs-type">action</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473816"><span class="hs-identifier hs-type">old_jobs</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-comment">-- Check the invariant: if the number of free tokens has decreased,</span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-comment">-- there must be no pending jobs.</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="GHC.Utils.Panic.html#massertPpr"><span class="hs-identifier hs-type">massertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473819"><span class="hs-identifier hs-type">jobs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473819"><span class="hs-identifier hs-type">jobs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;=</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473816"><span class="hs-identifier hs-type">old_jobs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-type">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;modiyJobResources: pending jobs but fewer free tokens&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-241"></span><span>  </span><span id="local-6989586621682473822"><span class="annot"><a href="#local-6989586621682473822"><span class="hs-identifier hs-var">dispatched_jobs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#dispatchTokens"><span class="hs-identifier hs-type">dispatchTokens</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473819"><span class="hs-identifier hs-type">jobs</span></a></span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">writeTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621682473814"><span class="hs-identifier hs-type">jobs_tvar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473822"><span class="hs-identifier hs-type">dispatched_jobs</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682473818"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621682473822"><span class="hs-identifier hs-type">dispatched_jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#tracedAtomically_"><span class="hs-identifier hs-type">tracedAtomically_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span id="tracedAtomically_"><span class="annot"><span class="annottext">tracedAtomically_ :: String -&gt; STM (Maybe JobResources) -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#tracedAtomically_"><span class="hs-identifier hs-var hs-var">tracedAtomically_</span></a></span></span><span> </span><span id="local-6989586621682473825"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682473825"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621682473826"><span class="annot"><span class="annottext">STM (Maybe JobResources)
</span><a href="#local-6989586621682473826"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; STM ((), Maybe JobResources) -&gt; IO ()
forall a. String -&gt; STM (a, Maybe JobResources) -&gt; IO a
</span><a href="GHC.Driver.MakeSem.html#tracedAtomically"><span class="hs-identifier hs-var">tracedAtomically</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682473825"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe JobResources -&gt; ((), Maybe JobResources))
-&gt; STM (Maybe JobResources) -&gt; STM ((), Maybe JobResources)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (Maybe JobResources)
</span><a href="#local-6989586621682473826"><span class="hs-identifier hs-var">act</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span id="local-6989586621682473426"><span class="annot"><a href="GHC.Driver.MakeSem.html#tracedAtomically"><span class="hs-identifier hs-type">tracedAtomically</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682473426"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621682473426"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-250"></span><span id="tracedAtomically"><span class="annot"><span class="annottext">tracedAtomically :: forall a. String -&gt; STM (a, Maybe JobResources) -&gt; IO a
</span><a href="GHC.Driver.MakeSem.html#tracedAtomically"><span class="hs-identifier hs-var hs-var">tracedAtomically</span></a></span></span><span> </span><span id="local-6989586621682473833"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682473833"><span class="hs-identifier hs-var">origin</span></a></span></span><span> </span><span id="local-6989586621682473834"><span class="annot"><span class="annottext">STM (a, Maybe JobResources)
</span><a href="#local-6989586621682473834"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682473835"><span class="annot"><a href="#local-6989586621682473835"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473836"><span class="annot"><a href="#local-6989586621682473836"><span class="hs-identifier hs-var">mjr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (a, Maybe JobResources) -&gt; IO (a, Maybe JobResources)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM (a, Maybe JobResources)
</span><a href="#local-6989586621682473834"><span class="hs-identifier hs-var">act</span></a></span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">forM_</span></span><span> </span><span class="annot"><a href="#local-6989586621682473836"><span class="hs-identifier hs-type">mjr</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682473838"><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473838"><span class="hs-identifier hs-var">jr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-comment">-- Use the &quot;jsem:&quot; prefix to identify where the write traces are</span><span>
</span><span id="line-254"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">traceEventIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;jsem:&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; JobResources -&gt; String
</span><a href="GHC.Driver.MakeSem.html#renderJobResources"><span class="hs-identifier hs-var">renderJobResources</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682473833"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473838"><span class="hs-identifier hs-var">jr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682473835"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#renderJobResources"><span class="hs-identifier hs-type">renderJobResources</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-258"></span><span id="renderJobResources"><span class="annot"><span class="annottext">renderJobResources :: String -&gt; JobResources -&gt; String
</span><a href="GHC.Driver.MakeSem.html#renderJobResources"><span class="hs-identifier hs-var hs-var">renderJobResources</span></a></span></span><span> </span><span id="local-6989586621682473841"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682473841"><span class="hs-identifier hs-var">origin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span id="local-6989586621682473842"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473842"><span class="hs-identifier hs-var">own</span></a></span></span><span> </span><span id="local-6989586621682473843"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473843"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span id="local-6989586621682473844"><span class="annot"><span class="annottext">OrdList (TMVar ())
</span><a href="#local-6989586621682473844"><span class="hs-identifier hs-var">pending</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; String
</span><a href="GHC.Utils.Outputable.html#showSDocUnsafe"><span class="hs-identifier hs-var">showSDocUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; String) -&gt; SDoc -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">JsonDoc -&gt; SDoc
</span><a href="GHC.Utils.Json.html#renderJSON"><span class="hs-identifier hs-var">renderJSON</span></a></span><span> </span><span class="annot"><span class="annottext">(JsonDoc -&gt; SDoc) -&gt; JsonDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">[(String, JsonDoc)] -&gt; JsonDoc
</span><a href="GHC.Utils.Json.html#JSObject"><span class="hs-identifier hs-var">JSObject</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;name&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; JsonDoc
</span><a href="GHC.Utils.Json.html#JSString"><span class="hs-identifier hs-var">JSString</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682473841"><span class="hs-identifier hs-var">origin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;owned&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; JsonDoc
</span><a href="GHC.Utils.Json.html#JSInt"><span class="hs-identifier hs-var">JSInt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473842"><span class="hs-identifier hs-var">own</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;free&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; JsonDoc
</span><a href="GHC.Utils.Json.html#JSInt"><span class="hs-identifier hs-var">JSInt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682473843"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pending&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; JsonDoc
</span><a href="GHC.Utils.Json.html#JSInt"><span class="hs-identifier hs-var">JSInt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList (TMVar ()) -&gt; Int
forall a. OrdList a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">OrdList (TMVar ())
</span><a href="#local-6989586621682473844"><span class="hs-identifier hs-var">pending</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>           </span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span class="hs-comment">-- | Spawn a new thread that waits on the semaphore in order to acquire</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- an additional token.</span><span>
</span><span id="line-268"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#acquireThread"><span class="hs-identifier hs-type">acquireThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverAction"><span class="hs-identifier hs-type">JobserverAction</span></a></span><span>
</span><span id="line-269"></span><span id="acquireThread"><span class="annot"><span class="annottext">acquireThread :: Jobserver -&gt; IO JobserverAction
</span><a href="GHC.Driver.MakeSem.html#acquireThread"><span class="hs-identifier hs-var hs-var">acquireThread</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jSemaphore :: Jobserver -&gt; Semaphore
</span><a href="GHC.Driver.MakeSem.html#jSemaphore"><span class="hs-identifier hs-var">jSemaphore</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473851"><span class="annot"><span class="annottext">Semaphore
</span><a href="#local-6989586621682473851"><span class="hs-identifier hs-var">sem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">jobs :: Jobserver -&gt; TVar JobResources
</span><a href="GHC.Driver.MakeSem.html#jobs"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473852"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473852"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-270"></span><span>    </span><span id="local-6989586621682473853"><span class="annot"><a href="#local-6989586621682473853"><span class="hs-identifier hs-var">threadFinished_tmvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar (Maybe SomeException))
forall a. IO (TMVar a)
</span><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#newEmptyTMVarIO"><span class="hs-identifier hs-var">newEmptyTMVarIO</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-272"></span><span>      </span><span class="annot"><a href="#local-6989586621682473855"><span class="hs-identifier hs-type">wait_result_action</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.SomeException</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>      </span><span id="local-6989586621682473855"><span class="annot"><a href="#local-6989586621682473855"><span class="hs-identifier hs-var hs-var">wait_result_action</span></a></span></span><span> </span><span id="local-6989586621682473856"><span class="annot"><span class="annottext">Either SomeException Bool
</span><a href="#local-6989586621682473856"><span class="hs-identifier hs-var">wait_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-274"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; STM (Maybe JobResources) -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#tracedAtomically_"><span class="hs-identifier hs-var">tracedAtomically_</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;acquire_thread&quot;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-275"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682473857"><span class="annot"><a href="#local-6989586621682473857"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473858"><span class="annot"><a href="#local-6989586621682473858"><span class="hs-identifier hs-var">jb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException Bool
</span><a href="#local-6989586621682473856"><span class="hs-identifier hs-var">wait_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682473859"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621682473859"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.SomeException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-277"></span><span>              </span><span class="annot"><span class="annottext">(Maybe SomeException, Maybe JobResources)
-&gt; STM (Maybe SomeException, Maybe JobResources)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((Maybe SomeException, Maybe JobResources)
 -&gt; STM (Maybe SomeException, Maybe JobResources))
-&gt; (Maybe SomeException, Maybe JobResources)
-&gt; STM (Maybe SomeException, Maybe JobResources)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Maybe SomeException
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621682473859"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe JobResources
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621682473860"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682473860"><span class="hs-identifier hs-var">success</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-279"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682473860"><span class="hs-identifier hs-var">success</span></a></span><span>
</span><span id="line-280"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-281"></span><span>                  </span><span class="annot"><span class="annottext">TVar JobResources
-&gt; (JobResources -&gt; STM (Maybe SomeException, JobResources))
-&gt; STM (Maybe SomeException, Maybe JobResources)
forall a.
HasCallStack =&gt;
TVar JobResources
-&gt; (JobResources -&gt; STM (a, JobResources))
-&gt; STM (a, Maybe JobResources)
</span><a href="GHC.Driver.MakeSem.html#modifyJobResources"><span class="hs-identifier hs-var">modifyJobResources</span></a></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473852"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682473861"><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473861"><span class="hs-identifier hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-282"></span><span>                    </span><span class="annot"><span class="annottext">(Maybe SomeException, JobResources)
-&gt; STM (Maybe SomeException, JobResources)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe SomeException
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#addToken"><span class="hs-identifier hs-var">addToken</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473861"><span class="hs-identifier hs-var">jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>                </span><span class="hs-keyword">else</span><span>
</span><span id="line-284"></span><span>                  </span><span class="annot"><span class="annottext">(Maybe SomeException, Maybe JobResources)
-&gt; STM (Maybe SomeException, Maybe JobResources)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe SomeException
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe JobResources
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>          </span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#putTMVar"><span class="hs-identifier hs-type">putTMVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473853"><span class="hs-identifier hs-type">threadFinished_tmvar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473857"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-286"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682473858"><span class="hs-identifier hs-type">jb</span></a></span><span>
</span><span id="line-287"></span><span>    </span><span id="local-6989586621682473862"><span class="annot"><a href="#local-6989586621682473862"><span class="hs-identifier hs-var">wait_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#forkWaitOnSemaphoreInterruptible"><span class="hs-identifier hs-type">forkWaitOnSemaphoreInterruptible</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473851"><span class="hs-identifier hs-type">sem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473855"><span class="hs-identifier hs-type">wait_result_action</span></a></span><span>
</span><span id="line-288"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">labelThread</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#waitingThreadId"><span class="hs-identifier hs-var">waitingThreadId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473862"><span class="hs-identifier hs-type">wait_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;acquire_thread&quot;</span></span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Acquiring"><span class="hs-identifier hs-type">Acquiring</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#activeWaitId"><span class="hs-identifier hs-var">activeWaitId</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473862"><span class="hs-identifier hs-type">wait_id</span></a></span><span>
</span><span id="line-290"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#threadFinished"><span class="hs-identifier hs-var">threadFinished</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473853"><span class="hs-identifier hs-type">threadFinished_tmvar</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span class="hs-comment">-- | Spawn a thread to release ownership of one resource from the semaphore,</span><span>
</span><span id="line-293"></span><span class="hs-comment">-- provided we have spare resources and no pending jobs.</span><span>
</span><span id="line-294"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#releaseThread"><span class="hs-identifier hs-type">releaseThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverAction"><span class="hs-identifier hs-type">JobserverAction</span></a></span><span>
</span><span id="line-295"></span><span id="releaseThread"><span class="annot"><span class="annottext">releaseThread :: Jobserver -&gt; IO JobserverAction
</span><a href="GHC.Driver.MakeSem.html#releaseThread"><span class="hs-identifier hs-var hs-var">releaseThread</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jSemaphore :: Jobserver -&gt; Semaphore
</span><a href="GHC.Driver.MakeSem.html#jSemaphore"><span class="hs-identifier hs-var">jSemaphore</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473867"><span class="annot"><span class="annottext">Semaphore
</span><a href="#local-6989586621682473867"><span class="hs-identifier hs-var">sem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">jobs :: Jobserver -&gt; TVar JobResources
</span><a href="GHC.Driver.MakeSem.html#jobs"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473868"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473868"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>  </span><span id="local-6989586621682473869"><span class="annot"><a href="#local-6989586621682473869"><span class="hs-identifier hs-var">threadFinished_tmvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar (Maybe SomeException))
forall a. IO (TMVar a)
</span><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#newEmptyTMVarIO"><span class="hs-identifier hs-var">newEmptyTMVarIO</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html#mask_"><span class="hs-identifier hs-type">MC.mask_</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-comment">-- Pre-release the resource so that another thread doesn't take control of it</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-comment">-- just as we release the lock on the semaphore.</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621682473871"><span class="annot"><a href="#local-6989586621682473871"><span class="hs-identifier hs-var">still_ok_to_release</span></a></span></span><span>
</span><span id="line-301"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tracedAtomically"><span class="hs-identifier hs-type">tracedAtomically</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;pre_release&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-302"></span><span>         </span><span class="annot"><a href="GHC.Driver.MakeSem.html#modifyJobResources"><span class="hs-identifier hs-type">modifyJobResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473868"><span class="hs-identifier hs-type">jobs_tvar</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682473872"><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473872"><span class="hs-identifier hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-303"></span><span>           </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">JobResources -&gt; Bool
</span><a href="GHC.Driver.MakeSem.html#guardRelease"><span class="hs-identifier hs-var">guardRelease</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473872"><span class="hs-identifier hs-var">jobs</span></a></span><span>
</span><span id="line-304"></span><span>               </span><span class="hs-comment">-- TODO: should this also debounce?</span><span>
</span><span id="line-305"></span><span>           </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Bool, JobResources) -&gt; STM (Bool, JobResources)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#removeOwnedToken"><span class="hs-identifier hs-var">removeOwnedToken</span></a></span><span> </span><span class="annot"><span class="annottext">(JobResources -&gt; JobResources) -&gt; JobResources -&gt; JobResources
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#removeFreeToken"><span class="hs-identifier hs-var">removeFreeToken</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473872"><span class="hs-identifier hs-var">jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>           </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(Bool, JobResources) -&gt; STM (Bool, JobResources)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473872"><span class="hs-identifier hs-var">jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621682473871"><span class="hs-identifier hs-type">still_ok_to_release</span></a></span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Idle"><span class="hs-identifier hs-type">Idle</span></a></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>      </span><span id="local-6989586621682473873"><span class="annot"><a href="#local-6989586621682473873"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">forkIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>        </span><span id="local-6989586621682473875"><span class="annot"><a href="#local-6989586621682473875"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html#try"><span class="hs-identifier hs-type">MC.try</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#releaseSemaphore"><span class="hs-identifier hs-type">releaseSemaphore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473867"><span class="hs-identifier hs-type">sem</span></a></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-312"></span><span>        </span><span class="annot"><a href="GHC.Driver.MakeSem.html#tracedAtomically_"><span class="hs-identifier hs-type">tracedAtomically_</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;post-release&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682473877"><span class="annot"><a href="#local-6989586621682473877"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473878"><span class="annot"><a href="#local-6989586621682473878"><span class="hs-identifier hs-var">jobs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682473875"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-314"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682473879"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621682473879"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.SomeException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-315"></span><span>              </span><span class="annot"><span class="annottext">TVar JobResources
-&gt; (JobResources -&gt; STM (Maybe SomeException, JobResources))
-&gt; STM (Maybe SomeException, Maybe JobResources)
forall a.
HasCallStack =&gt;
TVar JobResources
-&gt; (JobResources -&gt; STM (a, JobResources))
-&gt; STM (a, Maybe JobResources)
</span><a href="GHC.Driver.MakeSem.html#modifyJobResources"><span class="hs-identifier hs-var">modifyJobResources</span></a></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473868"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682473880"><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473880"><span class="hs-identifier hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-316"></span><span>                </span><span class="annot"><span class="annottext">(Maybe SomeException, JobResources)
-&gt; STM (Maybe SomeException, JobResources)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Maybe SomeException
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621682473879"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JobResources -&gt; JobResources
</span><a href="GHC.Driver.MakeSem.html#addToken"><span class="hs-identifier hs-var">addToken</span></a></span><span> </span><span class="annot"><span class="annottext">JobResources
</span><a href="#local-6989586621682473880"><span class="hs-identifier hs-var">jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>              </span><span class="annot"><span class="annottext">(Maybe SomeException, Maybe JobResources)
-&gt; STM (Maybe SomeException, Maybe JobResources)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe SomeException
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe JobResources
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>          </span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#putTMVar"><span class="hs-identifier hs-type">putTMVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473869"><span class="hs-identifier hs-type">threadFinished_tmvar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473877"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-320"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682473878"><span class="hs-identifier hs-type">jobs</span></a></span><span>
</span><span id="line-321"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">labelThread</span></span><span> </span><span class="annot"><a href="#local-6989586621682473873"><span class="hs-identifier hs-type">tid</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;release_thread&quot;</span></span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Idle"><span class="hs-identifier hs-type">Idle</span></a></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="hs-comment">-- | When there are pending jobs but no free tokens,</span><span>
</span><span id="line-325"></span><span class="hs-comment">-- spawn a thread to acquire a new token from the semaphore.</span><span>
</span><span id="line-326"></span><span class="hs-comment">--</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- See 'acquireThread'.</span><span>
</span><span id="line-328"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#tryAcquire"><span class="hs-identifier hs-type">tryAcquire</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverOptions"><span class="hs-identifier hs-type">JobserverOptions</span></a></span><span>
</span><span id="line-329"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span>
</span><span id="line-330"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span>
</span><span id="line-331"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span id="tryAcquire"><span class="annot"><span class="annottext">tryAcquire :: JobserverOptions
-&gt; Jobserver -&gt; JobserverState -&gt; STM (IO JobserverState)
</span><a href="GHC.Driver.MakeSem.html#tryAcquire"><span class="hs-identifier hs-var hs-var">tryAcquire</span></a></span></span><span> </span><span id="local-6989586621682473882"><span class="annot"><span class="annottext">JobserverOptions
</span><a href="#local-6989586621682473882"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682473883"><span class="annot"><span class="annottext">js :: Jobserver
</span><a href="#local-6989586621682473883"><span class="hs-identifier hs-var">js</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jobs :: Jobserver -&gt; TVar JobResources
</span><a href="GHC.Driver.MakeSem.html#jobs"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473884"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473884"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>  </span><span id="local-6989586621682473885"><span class="annot"><span class="annottext">st :: JobserverState
</span><a href="#local-6989586621682473885"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jobserverAction :: JobserverState -&gt; JobserverAction
</span><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var">jobserverAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JobserverAction
</span><a href="GHC.Driver.MakeSem.html#Idle"><span class="hs-identifier hs-var">Idle</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621682473886"><span class="annot"><a href="#local-6989586621682473886"><span class="hs-identifier hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar JobResources -&gt; STM JobResources
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473884"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#guardAcquire"><span class="hs-identifier hs-type">guardAcquire</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473886"><span class="hs-identifier hs-type">jobs</span></a></span><span>
</span><span id="line-337"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-338"></span><span>      </span><span id="local-6989586621682473887"><span class="annot"><a href="#local-6989586621682473887"><span class="hs-identifier hs-var">action</span></a></span></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#acquireThread"><span class="hs-identifier hs-type">acquireThread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473883"><span class="hs-identifier hs-type">js</span></a></span><span>
</span><span id="line-339"></span><span>      </span><span class="hs-comment">-- Set a debounce after acquiring a token.</span><span>
</span><span id="line-340"></span><span>      </span><span id="local-6989586621682473888"><span class="annot"><a href="#local-6989586621682473888"><span class="hs-identifier hs-var">can_release_tvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">registerDelay</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#releaseDebounce"><span class="hs-identifier hs-var">releaseDebounce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473882"><span class="hs-identifier hs-type">opts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">*</span></span><span> </span><span class="annot"><span class="hs-number">1000</span></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621682473885"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var">jobserverAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473887"><span class="hs-identifier hs-type">action</span></a></span><span>
</span><span id="line-342"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#canReleaseToken"><span class="hs-identifier hs-var">canReleaseToken</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473888"><span class="hs-identifier hs-type">can_release_tvar</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-343"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#tryAcquire"><span class="hs-identifier hs-var">tryAcquire</span></a></span><span> </span><span class="annot"><span class="annottext">JobserverOptions
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Jobserver
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">JobserverState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM (IO JobserverState)
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="hs-comment">-- | When there are free tokens and no pending jobs,</span><span>
</span><span id="line-346"></span><span class="hs-comment">-- spawn a thread to release a token from the semaphore.</span><span>
</span><span id="line-347"></span><span class="hs-comment">--</span><span>
</span><span id="line-348"></span><span class="hs-comment">-- See 'releaseThread'.</span><span>
</span><span id="line-349"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#tryRelease"><span class="hs-identifier hs-type">tryRelease</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span>
</span><span id="line-350"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span>
</span><span id="line-351"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span id="tryRelease"><span class="annot"><span class="annottext">tryRelease :: Jobserver -&gt; JobserverState -&gt; STM (IO JobserverState)
</span><a href="GHC.Driver.MakeSem.html#tryRelease"><span class="hs-identifier hs-var hs-var">tryRelease</span></a></span></span><span> </span><span id="local-6989586621682473893"><span class="annot"><span class="annottext">sjs :: Jobserver
</span><a href="#local-6989586621682473893"><span class="hs-identifier hs-var">sjs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jobs :: Jobserver -&gt; TVar JobResources
</span><a href="GHC.Driver.MakeSem.html#jobs"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473894"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473894"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>  </span><span id="local-6989586621682473895"><span class="annot"><span class="annottext">st :: JobserverState
</span><a href="#local-6989586621682473895"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span>
</span><span id="line-354"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jobserverAction :: JobserverState -&gt; JobserverAction
</span><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var">jobserverAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JobserverAction
</span><a href="GHC.Driver.MakeSem.html#Idle"><span class="hs-identifier hs-var">Idle</span></a></span><span>
</span><span id="line-355"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">canReleaseToken :: JobserverState -&gt; TVar Bool
</span><a href="GHC.Driver.MakeSem.html#canReleaseToken"><span class="hs-identifier hs-var">canReleaseToken</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473896"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621682473896"><span class="hs-identifier hs-var">can_release_tvar</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>    </span><span id="local-6989586621682473897"><span class="annot"><a href="#local-6989586621682473897"><span class="hs-identifier hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar JobResources -&gt; STM JobResources
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473894"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span>
</span><span id="line-358"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span>  </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#guardRelease"><span class="hs-identifier hs-type">guardRelease</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473897"><span class="hs-identifier hs-type">jobs</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span id="local-6989586621682473898"><span class="annot"><a href="#local-6989586621682473898"><span class="hs-identifier hs-var">can_release</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621682473896"><span class="hs-identifier hs-type">can_release_tvar</span></a></span><span>
</span><span id="line-360"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><a href="#local-6989586621682473898"><span class="hs-identifier hs-type">can_release</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>      </span><span id="local-6989586621682473899"><span class="annot"><a href="#local-6989586621682473899"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#releaseThread"><span class="hs-identifier hs-type">releaseThread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473893"><span class="hs-identifier hs-type">sjs</span></a></span><span>
</span><span id="line-363"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621682473895"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var">jobserverAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473899"><span class="hs-identifier hs-type">action</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-364"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#tryRelease"><span class="hs-identifier hs-var">tryRelease</span></a></span><span> </span><span class="annot"><span class="annottext">Jobserver
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">JobserverState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM (IO JobserverState)
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="hs-comment">-- | Wait for an active thread to finish. Once it finishes:</span><span>
</span><span id="line-367"></span><span class="hs-comment">--</span><span>
</span><span id="line-368"></span><span class="hs-comment">--  - set the 'JobserverAction' to 'Idle',</span><span>
</span><span id="line-369"></span><span class="hs-comment">--  - update the number of capabilities to reflect the number</span><span>
</span><span id="line-370"></span><span class="hs-comment">--    of owned tokens from the semaphore.</span><span>
</span><span id="line-371"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#tryNoticeIdle"><span class="hs-identifier hs-type">tryNoticeIdle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverOptions"><span class="hs-identifier hs-type">JobserverOptions</span></a></span><span>
</span><span id="line-372"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span>
</span><span id="line-373"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span>
</span><span id="line-374"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span id="tryNoticeIdle"><span class="annot"><span class="annottext">tryNoticeIdle :: JobserverOptions
-&gt; TVar JobResources -&gt; JobserverState -&gt; STM (IO JobserverState)
</span><a href="GHC.Driver.MakeSem.html#tryNoticeIdle"><span class="hs-identifier hs-var hs-var">tryNoticeIdle</span></a></span></span><span> </span><span id="local-6989586621682473901"><span class="annot"><span class="annottext">JobserverOptions
</span><a href="#local-6989586621682473901"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682473902"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473902"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span id="local-6989586621682473903"><span class="annot"><span class="annottext">JobserverState
</span><a href="#local-6989586621682473903"><span class="hs-identifier hs-var">jobserver_state</span></a></span></span><span>
</span><span id="line-376"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682473904"><span class="annot"><span class="annottext">TMVar (Maybe SomeException)
</span><a href="#local-6989586621682473904"><span class="hs-identifier hs-var">threadFinished_tmvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">JobserverAction -&gt; Maybe (TMVar (Maybe SomeException))
</span><a href="GHC.Driver.MakeSem.html#activeThread_maybe"><span class="hs-identifier hs-var">activeThread_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(JobserverAction -&gt; Maybe (TMVar (Maybe SomeException)))
-&gt; JobserverAction -&gt; Maybe (TMVar (Maybe SomeException))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">JobserverState -&gt; JobserverAction
</span><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var">jobserverAction</span></a></span><span> </span><span class="annot"><span class="annottext">JobserverState
</span><a href="#local-6989586621682473903"><span class="hs-identifier hs-var">jobserver_state</span></a></span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; TMVar (Maybe SomeException) -&gt; STM (IO JobserverState)
</span><a href="#local-6989586621682473905"><span class="hs-identifier hs-var">sync_num_caps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">JobserverState -&gt; TVar Bool
</span><a href="GHC.Driver.MakeSem.html#canChangeNumCaps"><span class="hs-identifier hs-var">canChangeNumCaps</span></a></span><span> </span><span class="annot"><span class="annottext">JobserverState
</span><a href="#local-6989586621682473903"><span class="hs-identifier hs-var">jobserver_state</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TMVar (Maybe SomeException)
</span><a href="#local-6989586621682473904"><span class="hs-identifier hs-var">threadFinished_tmvar</span></a></span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-379"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM (IO JobserverState)
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span> </span><span class="hs-comment">-- no active thread: wait until jobserver isn't idle</span><span>
</span><span id="line-380"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-381"></span><span>    </span><span class="annot"><a href="#local-6989586621682473905"><span class="hs-identifier hs-type">sync_num_caps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-382"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#TMVar"><span class="hs-identifier hs-type">TMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.SomeException</span></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>    </span><span id="local-6989586621682473905"><span class="annot"><span class="annottext">sync_num_caps :: TVar Bool -&gt; TMVar (Maybe SomeException) -&gt; STM (IO JobserverState)
</span><a href="#local-6989586621682473905"><span class="hs-identifier hs-var hs-var">sync_num_caps</span></a></span></span><span> </span><span id="local-6989586621682473906"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621682473906"><span class="hs-identifier hs-var">can_change_numcaps_tvar</span></a></span></span><span> </span><span id="local-6989586621682473907"><span class="annot"><span class="annottext">TMVar (Maybe SomeException)
</span><a href="#local-6989586621682473907"><span class="hs-identifier hs-var">threadFinished_tmvar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-385"></span><span>      </span><span id="local-6989586621682473908"><span class="annot"><a href="#local-6989586621682473908"><span class="hs-identifier hs-var">mb_ex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar (Maybe SomeException) -&gt; STM (Maybe SomeException)
forall a. TMVar a -&gt; STM a
</span><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TMVar.html#takeTMVar"><span class="hs-identifier hs-var">takeTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar (Maybe SomeException)
</span><a href="#local-6989586621682473907"><span class="hs-identifier hs-var">threadFinished_tmvar</span></a></span><span>
</span><span id="line-386"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">for_</span></span><span> </span><span class="annot"><a href="#local-6989586621682473908"><span class="hs-identifier hs-type">mb_ex</span></a></span><span> </span><span class="annot"><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html#throwM"><span class="hs-identifier hs-type">MC.throwM</span></a></span><span>
</span><span id="line-387"></span><span>      </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682473911"><span class="annot"><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var hs-var">tokensOwned</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621682473902"><span class="hs-identifier hs-type">jobs_tvar</span></a></span><span>
</span><span id="line-388"></span><span>      </span><span id="local-6989586621682473912"><span class="annot"><a href="#local-6989586621682473912"><span class="hs-identifier hs-var">can_change_numcaps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621682473906"><span class="hs-identifier hs-type">can_change_numcaps_tvar</span></a></span><span>
</span><span id="line-389"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><a href="#local-6989586621682473912"><span class="hs-identifier hs-type">can_change_numcaps</span></a></span><span>
</span><span id="line-390"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-391"></span><span>        </span><span id="local-6989586621682473913"><span class="annot"><a href="#local-6989586621682473913"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">getNumCapabilities</span></span><span>
</span><span id="line-392"></span><span>        </span><span id="local-6989586621682473915"><span class="annot"><a href="#local-6989586621682473915"><span class="hs-identifier hs-var">can_change_numcaps_tvar_2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-393"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621682473913"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="#local-6989586621682473911"><span class="hs-identifier hs-type">tokensOwned</span></a></span><span>
</span><span id="line-394"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682473906"><span class="hs-identifier hs-type">can_change_numcaps_tvar</span></a></span><span>
</span><span id="line-395"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-396"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">setNumCapabilities</span></span><span> </span><span class="annot"><a href="#local-6989586621682473911"><span class="hs-identifier hs-type">tokensOwned</span></a></span><span>
</span><span id="line-397"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">registerDelay</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#setNumCapsDebounce"><span class="hs-identifier hs-var">setNumCapsDebounce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473901"><span class="hs-identifier hs-type">opts</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">*</span></span><span> </span><span class="annot"><span class="hs-number">1000</span></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-399"></span><span>          </span><span class="annot"><a href="#local-6989586621682473903"><span class="hs-identifier hs-type">jobserver_state</span></a></span><span>
</span><span id="line-400"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var">jobserverAction</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Idle"><span class="hs-identifier hs-type">Idle</span></a></span><span>
</span><span id="line-401"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#canChangeNumCaps"><span class="hs-identifier hs-var">canChangeNumCaps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682473915"><span class="hs-identifier hs-type">can_change_numcaps_tvar_2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span class="hs-comment">-- | Try to stop the current thread which is acquiring/releasing resources</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- if that operation is no longer relevant.</span><span>
</span><span id="line-405"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#tryStopThread"><span class="hs-identifier hs-type">tryStopThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobResources"><span class="hs-identifier hs-type">JobResources</span></a></span><span>
</span><span id="line-406"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span>
</span><span id="line-407"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span id="tryStopThread"><span class="annot"><span class="annottext">tryStopThread :: TVar JobResources -&gt; JobserverState -&gt; STM (IO JobserverState)
</span><a href="GHC.Driver.MakeSem.html#tryStopThread"><span class="hs-identifier hs-var hs-var">tryStopThread</span></a></span></span><span> </span><span id="local-6989586621682473917"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473917"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span id="local-6989586621682473918"><span class="annot"><span class="annottext">JobserverState
</span><a href="#local-6989586621682473918"><span class="hs-identifier hs-var">jsj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">JobserverState -&gt; JobserverAction
</span><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var">jobserverAction</span></a></span><span> </span><span class="annot"><span class="annottext">JobserverState
</span><a href="#local-6989586621682473918"><span class="hs-identifier hs-var">jsj</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-410"></span><span>    </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Acquiring"><span class="hs-identifier hs-type">Acquiring</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">activeWaitId :: JobserverAction -&gt; WaitId
</span><a href="GHC.Driver.MakeSem.html#activeWaitId"><span class="hs-identifier hs-var">activeWaitId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473919"><span class="annot"><span class="annottext">WaitId
</span><a href="#local-6989586621682473919"><span class="hs-identifier hs-var">wait_id</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-411"></span><span>     </span><span id="local-6989586621682473920"><span class="annot"><a href="#local-6989586621682473920"><span class="hs-identifier hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar JobResources -&gt; STM JobResources
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473917"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span>
</span><span id="line-412"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473920"><span class="hs-identifier hs-type">jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-414"></span><span>       </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#interruptWaitOnSemaphore"><span class="hs-identifier hs-type">interruptWaitOnSemaphore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473919"><span class="hs-identifier hs-type">wait_id</span></a></span><span>
</span><span id="line-415"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621682473918"><span class="hs-identifier hs-type">jsj</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var">jobserverAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Idle"><span class="hs-identifier hs-type">Idle</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-416"></span><span>    </span><span class="annot"><span class="annottext">JobserverAction
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM (IO JobserverState)
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span class="hs-comment">-- | Main jobserver loop: acquire/release resources as</span><span>
</span><span id="line-419"></span><span class="hs-comment">-- needed for the pending jobs and available semaphore tokens.</span><span>
</span><span id="line-420"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#jobserverLoop"><span class="hs-identifier hs-type">jobserverLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverOptions"><span class="hs-identifier hs-type">JobserverOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span id="jobserverLoop"><span class="annot"><span class="annottext">jobserverLoop :: JobserverOptions -&gt; Jobserver -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#jobserverLoop"><span class="hs-identifier hs-var hs-var">jobserverLoop</span></a></span></span><span> </span><span id="local-6989586621682473923"><span class="annot"><span class="annottext">JobserverOptions
</span><a href="#local-6989586621682473923"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682473924"><span class="annot"><span class="annottext">sjs :: Jobserver
</span><a href="#local-6989586621682473924"><span class="hs-identifier hs-var">sjs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jobs :: Jobserver -&gt; TVar JobResources
</span><a href="GHC.Driver.MakeSem.html#jobs"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682473925"><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473925"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-423"></span><span>      </span><span id="local-6989586621682473926"><span class="annot"><a href="#local-6989586621682473926"><span class="hs-identifier hs-var">true_tvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (TVar Bool)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-424"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621682473928"><span class="hs-identifier hs-type">init_state</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span>
</span><span id="line-425"></span><span>          </span><span id="local-6989586621682473928"><span class="annot"><a href="#local-6989586621682473928"><span class="hs-identifier hs-var hs-var">init_state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-426"></span><span>            </span><span class="annot"><a href="GHC.Driver.MakeSem.html#JobserverState"><span class="hs-identifier hs-type">JobserverState</span></a></span><span>
</span><span id="line-427"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jobserverAction :: JobserverAction
</span><a href="GHC.Driver.MakeSem.html#jobserverAction"><span class="hs-identifier hs-var">jobserverAction</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JobserverAction
</span><a href="GHC.Driver.MakeSem.html#Idle"><span class="hs-identifier hs-var">Idle</span></a></span><span>
</span><span id="line-428"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">canChangeNumCaps :: TVar Bool
</span><a href="GHC.Driver.MakeSem.html#canChangeNumCaps"><span class="hs-identifier hs-var">canChangeNumCaps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621682473926"><span class="hs-identifier hs-var">true_tvar</span></a></span><span>
</span><span id="line-429"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">canReleaseToken :: TVar Bool
</span><a href="GHC.Driver.MakeSem.html#canReleaseToken"><span class="hs-identifier hs-var">canReleaseToken</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621682473926"><span class="hs-identifier hs-var">true_tvar</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-430"></span><span>      </span><span class="annot"><a href="#local-6989586621682473929"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473928"><span class="hs-identifier hs-type">init_state</span></a></span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-432"></span><span>    </span><span id="local-6989586621682473929"><span class="annot"><span class="annottext">loop :: JobserverState -&gt; IO ()
</span><a href="#local-6989586621682473929"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621682473930"><span class="annot"><span class="annottext">JobserverState
</span><a href="#local-6989586621682473930"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-433"></span><span>      </span><span id="local-6989586621682473931"><span class="annot"><a href="#local-6989586621682473931"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (IO JobserverState) -&gt; IO (IO JobserverState)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (IO JobserverState) -&gt; IO (IO JobserverState))
-&gt; STM (IO JobserverState) -&gt; IO (IO JobserverState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[STM (IO JobserverState)] -&gt; STM (IO JobserverState)
forall (t :: * -&gt; *) (f :: * -&gt; *) a.
(Foldable t, Alternative f) =&gt;
t (f a) -&gt; f a
</span><span class="hs-identifier hs-var">asum</span></span><span> </span><span class="annot"><span class="annottext">([STM (IO JobserverState)] -&gt; STM (IO JobserverState))
-&gt; [STM (IO JobserverState)] -&gt; STM (IO JobserverState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682473933"><span class="annot"><span class="annottext">JobserverState -&gt; STM (IO JobserverState)
</span><a href="#local-6989586621682473933"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">JobserverState -&gt; STM (IO JobserverState)
</span><a href="#local-6989586621682473933"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">JobserverState
</span><a href="#local-6989586621682473930"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((JobserverState -&gt; STM (IO JobserverState))
 -&gt; STM (IO JobserverState))
-&gt; [JobserverState -&gt; STM (IO JobserverState)]
-&gt; [STM (IO JobserverState)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>
</span><span id="line-434"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Jobserver -&gt; JobserverState -&gt; STM (IO JobserverState)
</span><a href="GHC.Driver.MakeSem.html#tryRelease"><span class="hs-identifier hs-var">tryRelease</span></a></span><span>    </span><span class="annot"><span class="annottext">Jobserver
</span><a href="#local-6989586621682473924"><span class="hs-identifier hs-var">sjs</span></a></span><span>
</span><span id="line-435"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JobserverOptions
-&gt; Jobserver -&gt; JobserverState -&gt; STM (IO JobserverState)
</span><a href="GHC.Driver.MakeSem.html#tryAcquire"><span class="hs-identifier hs-var">tryAcquire</span></a></span><span>    </span><span class="annot"><span class="annottext">JobserverOptions
</span><a href="#local-6989586621682473923"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Jobserver
</span><a href="#local-6989586621682473924"><span class="hs-identifier hs-var">sjs</span></a></span><span>
</span><span id="line-436"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JobserverOptions
-&gt; TVar JobResources -&gt; JobserverState -&gt; STM (IO JobserverState)
</span><a href="GHC.Driver.MakeSem.html#tryNoticeIdle"><span class="hs-identifier hs-var">tryNoticeIdle</span></a></span><span> </span><span class="annot"><span class="annottext">JobserverOptions
</span><a href="#local-6989586621682473923"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473925"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span>
</span><span id="line-437"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TVar JobResources -&gt; JobserverState -&gt; STM (IO JobserverState)
</span><a href="GHC.Driver.MakeSem.html#tryStopThread"><span class="hs-identifier hs-var">tryStopThread</span></a></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473925"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span>
</span><span id="line-438"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-439"></span><span>      </span><span id="local-6989586621682473934"><span class="annot"><a href="#local-6989586621682473934"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682473931"><span class="hs-identifier hs-type">action</span></a></span><span>
</span><span id="line-440"></span><span>      </span><span class="annot"><a href="#local-6989586621682473929"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473934"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span class="annot"><span class="hs-comment">-- | Create a new jobserver using the given semaphore handle.</span></span><span>
</span><span id="line-443"></span><span class="annot"><a href="GHC.Driver.MakeSem.html#makeJobserver"><span class="hs-identifier hs-type">makeJobserver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#SemaphoreName"><span class="hs-identifier hs-type">SemaphoreName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#AbstractSem"><span class="hs-identifier hs-type">AbstractSem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span id="makeJobserver"><span class="annot"><span class="annottext">makeJobserver :: SemaphoreName -&gt; IO (AbstractSem, IO ())
</span><a href="GHC.Driver.MakeSem.html#makeJobserver"><span class="hs-identifier hs-var hs-var">makeJobserver</span></a></span></span><span> </span><span id="local-6989586621682473936"><span class="annot"><span class="annottext">SemaphoreName
</span><a href="#local-6989586621682473936"><span class="hs-identifier hs-var">sem_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-445"></span><span>  </span><span id="local-6989586621682473937"><span class="annot"><a href="#local-6989586621682473937"><span class="hs-identifier hs-var">semaphore</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SemaphoreName -&gt; IO Semaphore
</span><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#openSemaphore"><span class="hs-identifier hs-var">openSemaphore</span></a></span><span> </span><span class="annot"><span class="annottext">SemaphoreName
</span><a href="#local-6989586621682473936"><span class="hs-identifier hs-var">sem_name</span></a></span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-447"></span><span>    </span><span id="local-6989586621682473939"><span class="annot"><a href="#local-6989586621682473939"><span class="hs-identifier hs-var hs-var">init_jobs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-448"></span><span>      </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobs"><span class="hs-identifier hs-type">Jobs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tokensOwned :: Int
</span><a href="GHC.Driver.MakeSem.html#tokensOwned"><span class="hs-identifier hs-var">tokensOwned</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-449"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tokensFree :: Int
</span><a href="GHC.Driver.MakeSem.html#tokensFree"><span class="hs-identifier hs-var">tokensFree</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-450"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">jobsWaiting :: OrdList (TMVar ())
</span><a href="GHC.Driver.MakeSem.html#jobsWaiting"><span class="hs-identifier hs-var">jobsWaiting</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList (TMVar ())
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#NilOL"><span class="hs-identifier hs-var">NilOL</span></a></span><span>
</span><span id="line-451"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-452"></span><span>  </span><span id="local-6989586621682473941"><span class="annot"><a href="#local-6989586621682473941"><span class="hs-identifier hs-var">jobs_tvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newTVarIO</span></span><span> </span><span class="annot"><a href="#local-6989586621682473939"><span class="hs-identifier hs-type">init_jobs</span></a></span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-454"></span><span>    </span><span id="local-6989586621682473942"><span class="annot"><a href="#local-6989586621682473942"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JobserverOptions
</span><a href="GHC.Driver.MakeSem.html#defaultJobserverOptions"><span class="hs-identifier hs-var">defaultJobserverOptions</span></a></span><span> </span><span class="hs-comment">-- TODO: allow this to be configured</span><span>
</span><span id="line-455"></span><span>    </span><span id="local-6989586621682473943"><span class="annot"><a href="#local-6989586621682473943"><span class="hs-identifier hs-var hs-var">sjs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Driver.MakeSem.html#Jobserver"><span class="hs-identifier hs-type">Jobserver</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">jSemaphore :: Semaphore
</span><a href="GHC.Driver.MakeSem.html#jSemaphore"><span class="hs-identifier hs-var">jSemaphore</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Semaphore
</span><a href="#local-6989586621682473937"><span class="hs-identifier hs-var">semaphore</span></a></span><span>
</span><span id="line-456"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">jobs :: TVar JobResources
</span><a href="GHC.Driver.MakeSem.html#jobs"><span class="hs-identifier hs-var">jobs</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473941"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-457"></span><span>  </span><span id="local-6989586621682473944"><span class="annot"><a href="#local-6989586621682473944"><span class="hs-identifier hs-var">loop_finished_mvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newEmptyMVar</span></span><span>
</span><span id="line-458"></span><span>  </span><span id="local-6989586621682473946"><span class="annot"><a href="#local-6989586621682473946"><span class="hs-identifier hs-var">loop_tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">forkIOWithUnmask</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682473948"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621682473948"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-459"></span><span>    </span><span id="local-6989586621682473949"><span class="annot"><a href="#local-6989586621682473949"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Either SomeException ())
forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Either SomeException ()))
-&gt; IO () -&gt; IO (Either SomeException ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621682473948"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">JobserverOptions -&gt; Jobserver -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#jobserverLoop"><span class="hs-identifier hs-var">jobserverLoop</span></a></span><span> </span><span class="annot"><span class="annottext">JobserverOptions
</span><a href="#local-6989586621682473942"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Jobserver
</span><a href="#local-6989586621682473943"><span class="hs-identifier hs-var">sjs</span></a></span><span>
</span><span id="line-460"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">putMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621682473944"><span class="hs-identifier hs-type">loop_finished_mvar</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-461"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682473949"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-462"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621682473952"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621682473952"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-463"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">AsyncException
</span><span class="hs-identifier hs-var">ThreadKilled</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe AsyncException
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621682473952"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-464"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe SomeException
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-465"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-466"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe SomeException
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621682473952"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-467"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe SomeException
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-468"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">labelThread</span></span><span> </span><span class="annot"><a href="#local-6989586621682473946"><span class="hs-identifier hs-type">loop_tid</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;job_server&quot;</span></span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-470"></span><span>    </span><span id="local-6989586621682473955"><span class="annot"><a href="#local-6989586621682473955"><span class="hs-identifier hs-var hs-var">acquireSem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar JobResources -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#acquireJob"><span class="hs-identifier hs-var">acquireJob</span></a></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473941"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span>
</span><span id="line-471"></span><span>    </span><span id="local-6989586621682473956"><span class="annot"><a href="#local-6989586621682473956"><span class="hs-identifier hs-var hs-var">releaseSem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar JobResources -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#releaseJob"><span class="hs-identifier hs-var">releaseJob</span></a></span><span> </span><span class="annot"><span class="annottext">TVar JobResources
</span><a href="#local-6989586621682473941"><span class="hs-identifier hs-var">jobs_tvar</span></a></span><span>
</span><span id="line-472"></span><span>    </span><span id="local-6989586621682473957"><span class="annot"><a href="#local-6989586621682473957"><span class="hs-identifier hs-var hs-var">cleanupSem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-473"></span><span>      </span><span class="hs-comment">-- this is interruptible</span><span>
</span><span id="line-474"></span><span>      </span><span class="annot"><span class="annottext">Jobserver -&gt; IO ()
</span><a href="GHC.Driver.MakeSem.html#cleanupJobserver"><span class="hs-identifier hs-var">cleanupJobserver</span></a></span><span> </span><span class="annot"><span class="annottext">Jobserver
</span><a href="#local-6989586621682473943"><span class="hs-identifier hs-var">sjs</span></a></span><span>
</span><span id="line-475"></span><span>      </span><span class="annot"><span class="annottext">ThreadId -&gt; IO ()
</span><span class="hs-identifier hs-var">killThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621682473946"><span class="hs-identifier hs-var">loop_tid</span></a></span><span>
</span><span id="line-476"></span><span>      </span><span id="local-6989586621682473959"><span class="annot"><a href="#local-6989586621682473959"><span class="hs-identifier hs-var">mb_ex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (Maybe SomeException) -&gt; IO (Maybe SomeException)
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe SomeException)
</span><a href="#local-6989586621682473944"><span class="hs-identifier hs-var">loop_finished_mvar</span></a></span><span>
</span><span id="line-477"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">for_</span></span><span> </span><span class="annot"><a href="#local-6989586621682473959"><span class="hs-identifier hs-type">mb_ex</span></a></span><span> </span><span class="annot"><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html#throwM"><span class="hs-identifier hs-type">MC.throwM</span></a></span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#AbstractSem"><span class="hs-identifier hs-type">AbstractSem</span></a></span><span class="hs-special">{</span><span class="annot"><a href="#local-6989586621682473955"><span class="hs-glyph hs-type hs-type hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682473957"><span class="hs-identifier hs-type">cleanupSem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>
</span><span id="line-481"></span><span class="hs-comment">-- | Implement an abstract semaphore using a semaphore 'Jobserver'</span><span>
</span><span id="line-482"></span><span class="hs-comment">-- which queries the system semaphore of the given name for resources.</span><span>
</span><span id="line-483"></span><span id="local-6989586621682473482"><span class="annot"><a href="GHC.Driver.MakeSem.html#runJSemAbstractSem"><span class="hs-identifier hs-type">runJSemAbstractSem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#SemaphoreName"><span class="hs-identifier hs-type">SemaphoreName</span></a></span><span>         </span><span class="annot"><span class="hs-comment">-- ^ the system semaphore to use</span></span><span>
</span><span id="line-484"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../semaphore-compat-1.0.0-73c7/src/System.Semaphore.html#AbstractSem"><span class="hs-identifier hs-type">AbstractSem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621682473482"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ the operation to run</span><span>
</span><span id="line-485"></span><span>                                            </span><span class="hs-comment">-- which requires a semaphore</span><span>
</span><span id="line-486"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621682473482"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-487"></span><span id="runJSemAbstractSem"><span class="annot"><span class="annottext">runJSemAbstractSem :: forall a. SemaphoreName -&gt; (AbstractSem -&gt; IO a) -&gt; IO a
</span><a href="GHC.Driver.MakeSem.html#runJSemAbstractSem"><span class="hs-identifier hs-var hs-var">runJSemAbstractSem</span></a></span></span><span> </span><span id="local-6989586621682473981"><span class="annot"><span class="annottext">SemaphoreName
</span><a href="#local-6989586621682473981"><span class="hs-identifier hs-var">sem</span></a></span></span><span> </span><span id="local-6989586621682473982"><span class="annot"><span class="annottext">AbstractSem -&gt; IO a
</span><a href="#local-6989586621682473982"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((forall a. IO a -&gt; IO a) -&gt; IO a) -&gt; IO a
forall b.
HasCallStack =&gt;
((forall a. IO a -&gt; IO a) -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) b.
(MonadMask m, HasCallStack) =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html#mask"><span class="hs-identifier hs-var">MC.mask</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621682473984"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621682473984"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-488"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682473985"><span class="annot"><a href="#local-6989586621682473985"><span class="hs-identifier hs-var">abs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682473986"><span class="annot"><a href="#local-6989586621682473986"><span class="hs-identifier hs-var">cleanup</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SemaphoreName -&gt; IO (AbstractSem, IO ())
</span><a href="GHC.Driver.MakeSem.html#makeJobserver"><span class="hs-identifier hs-var">makeJobserver</span></a></span><span> </span><span class="annot"><span class="annottext">SemaphoreName
</span><a href="#local-6989586621682473981"><span class="hs-identifier hs-var">sem</span></a></span><span>
</span><span id="line-489"></span><span>  </span><span id="local-6989586621682473987"><span class="annot"><a href="#local-6989586621682473987"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">try</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621682473984"><span class="hs-identifier hs-type">unmask</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621682473982"><span class="hs-identifier hs-type">action</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473985"><span class="hs-identifier hs-type">abs</span></a></span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682473987"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-491"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682473988"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621682473988"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.SomeException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-492"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">Either</span></span><span> </span><span class="annot"><span class="hs-identifier">MC.SomeException</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Either SomeException ())
forall (m :: * -&gt; *) e a.
(HasCallStack, MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html#try"><span class="hs-identifier hs-var">MC.try</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621682473986"><span class="hs-identifier hs-var">cleanup</span></a></span><span>
</span><span id="line-493"></span><span>      </span><span class="annot"><a href="../../exceptions-0.10.9-4d2e/src/Control.Monad.Catch.html#throwM"><span class="hs-identifier hs-type">MC.throwM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682473988"><span class="hs-identifier hs-type">e1</span></a></span><span>
</span><span id="line-494"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621682473989"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682473989"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621682473986"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; a -&gt; IO a
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; b -&gt; f b
</span><span class="hs-operator hs-var">$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682473989"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span class="hs-comment">{- Note [Architecture of the Job Server]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In `-jsem` mode, the amount of parallelism that GHC can use is controlled by a
system semaphore. We take resources from the semaphore when we need them, and
give them back if we don't have enough to do.

A naive implementation would just take and release the semaphore around performing
the action, but this leads to two issues:

* When taking a token in the semaphore, we must call `setNumCapabilities` in order
  to adjust how many capabilities are available for parallel garbage collection.
  This causes unnecessary synchronisations.
* We want to implement a debounce, so that whilst there is pending work in the
  current process we prefer to keep hold of resources from the semaphore.
  This reduces overall memory usage, as there are fewer live GHC processes at once.

Therefore, the obtention of semaphore resources is separated away from the
request for the resource in the driver.

A token from the semaphore is requested using `acquireJob`. This creates a pending
job, which is a MVar that can be filled in to signal that the requested token is ready.

When the job is finished, the token is released by calling `releaseJob`, which just
increases the number of `free` jobs. If there are more pending jobs when the free count
is increased, the token is immediately reused (see `modifyJobResources`).

The `jobServerLoop` interacts with the system semaphore: when there are pending
jobs, `acquireThread` blocks, waiting for a token from the semaphore. Once a
token is obtained, it increases the owned count.

When GHC has free tokens (tokens from the semaphore that it is not using),
no pending jobs, and the debounce has expired, then `releaseThread` will
release tokens back to the global semaphore.

`tryStopThread` attempts to kill threads which are waiting to acquire a resource
when we no longer need it. For example, consider that we attempt to acquire two
tokens, but the first job finishes before we acquire the second token.
This second token is no longer needed, so we should cancel the wait
(as it would not be used to do any work, and not be returned until the debounce).
We only need to kill `acquireJob`, because `releaseJob` never blocks.

Note [Eventlog Messages for jsem]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It can be tricky to verify that the work is shared adequately across different
processes. To help debug this, we output the values of `JobResource` to the
eventlog whenever the global state changes. There are some scripts which can be used
to analyse this output and report statistics about core saturation in the
GitHub repo (https://github.com/mpickering/ghc-jsem-analyse).

-}</span><span>
</span><span id="line-546"></span></pre></body></html>