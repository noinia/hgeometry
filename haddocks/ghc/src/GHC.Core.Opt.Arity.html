<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


        Arity and eta expansion
-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="annot"><span class="hs-comment">-- | Arity and eta expansion</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span>
</span><span id="line-13"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- Finding arity</span><span>
</span><span id="line-14"></span><span>     </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier">manifestArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier">joinRhsArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier">exprArity</span></a></span><span>
</span><span id="line-15"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#findRhsArity"><span class="hs-identifier">findRhsArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#cheapArityType"><span class="hs-identifier">cheapArityType</span></a></span><span>
</span><span id="line-16"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityOpts"><span class="hs-identifier">ArityOpts</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** Eta expansion</span></span><span>
</span><span id="line-19"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprEtaExpandArity"><span class="hs-identifier">exprEtaExpandArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpand"><span class="hs-identifier">etaExpand</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier">etaExpandAT</span></a></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** Eta reduction</span></span><span>
</span><span id="line-22"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#tryEtaReduce"><span class="hs-identifier">tryEtaReduce</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** ArityType</span></span><span>
</span><span id="line-25"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier">ArityType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#mkBotArityType"><span class="hs-identifier">mkBotArityType</span></a></span><span>
</span><span id="line-26"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier">arityTypeArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier">idArityType</span></a></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** Bottoming things</span></span><span>
</span><span id="line-29"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprIsDeadEnd"><span class="hs-identifier">exprIsDeadEnd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprBotStrictness_maybe"><span class="hs-identifier">exprBotStrictness_maybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityTypeBotSigs_maybe"><span class="hs-identifier">arityTypeBotSigs_maybe</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** typeArity and the state hack</span></span><span>
</span><span id="line-32"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier">typeArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeOneShots"><span class="hs-identifier">typeOneShots</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeOneShot"><span class="hs-identifier">typeOneShot</span></a></span><span>
</span><span id="line-33"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#isOneShotBndr"><span class="hs-identifier">isOneShotBndr</span></a></span><span>
</span><span id="line-34"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#isStateHackType"><span class="hs-identifier">isStateHackType</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span>   </span><span class="annot"><span class="hs-comment">-- * Lambdas</span></span><span>
</span><span id="line-37"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#zapLamBndrs"><span class="hs-identifier">zapLamBndrs</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** Join points</span></span><span>
</span><span id="line-41"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPoint"><span class="hs-identifier">etaExpandToJoinPoint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier">etaExpandToJoinPointRule</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** Coercions and casts</span></span><span>
</span><span id="line-44"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier">pushCoArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier">pushCoArgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier">pushCoValArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier">pushCoTyArg</span></a></span><span>
</span><span id="line-45"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoercionIntoLambda"><span class="hs-identifier">pushCoercionIntoLambda</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoDataCon"><span class="hs-identifier">pushCoDataCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#collectBindersPushingCo"><span class="hs-identifier">collectBindersPushingCo</span></a></span><span>
</span><span id="line-46"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">where</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier">tyConArity</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.RecWalk.html"><span class="hs-identifier">GHC.Core.TyCon.RecWalk</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.RecWalk.html#initRecTc"><span class="hs-identifier">initRecTc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.RecWalk.html#checkRecTc"><span class="hs-identifier">checkRecTc</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#isDictTy"><span class="hs-identifier">isDictTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#isEvVar"><span class="hs-identifier">isEvVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#isCallStackPredTy"><span class="hs-identifier">isCallStackPredTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#isCallStackTy"><span class="hs-identifier">isCallStackTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">-- We have two sorts of substitution:</span><span>
</span><span id="line-61"></span><span class="hs-comment">--   GHC.Core.Subst.Subst, and GHC.Core.TyCo.Subst</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- Both have substTy, substCo  Hence need for qualification</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Core</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html"><span class="hs-identifier">GHC.Core.TyCo.Compare</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier">eqType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html"><span class="hs-identifier">GHC.Types.Cpr</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier">CprSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#mkCprSig"><span class="hs-identifier">mkCprSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#botCpr"><span class="hs-identifier">botCpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html"><span class="hs-identifier">GHC.Builtin.Types.Prim</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Uniques.html"><span class="hs-identifier">GHC.Builtin.Uniques</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html"><span class="hs-identifier">GHC.Data.Graph.UnVar</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html"><span class="hs-identifier">GHC.Data.Pair</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.GlobalVars.html"><span class="hs-identifier">GHC.Utils.GlobalVars</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.GlobalVars.html#unsafeHasNoStateHack"><span class="hs-identifier">unsafeHasNoStateHack</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Constants.html"><span class="hs-identifier">GHC.Utils.Constants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier">debugIsOn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">isJust</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
              manifestArity and exprArity
*                                                                      *
************************************************************************

exprArity is a cheap-and-cheerful version of exprEtaExpandArity.
It tells how many things the expression can be applied to before doing
any work.  It doesn't look inside cases, lets, etc.  The idea is that
exprEtaExpandArity will do the hard work, leaving something that's easy
for exprArity to grapple with.  In particular, Simplify uses exprArity to
compute the ArityInfo for the Id.

Originally I thought that it was enough just to look for top-level lambdas, but
it isn't.  I've seen this

        foo = PrelBase.timesInt

We want foo to get arity 2 even though the eta-expander will leave it
unchanged, in the expectation that it'll be inlined.  But occasionally it
isn't, because foo is blacklisted (used in a rule).

Similarly, see the ok_note check in exprEtaExpandArity.  So
        f = __inline_me (\x -&gt; e)
won't be eta-expanded.

And in any case it seems more robust to have exprArity be a bit more intelligent.
But note that   (\x y z -&gt; f x y z)
should have arity 3, regardless of f's arity.
-}</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-type">manifestArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-125"></span><span class="hs-comment">-- ^ manifestArity sees how many leading value lambdas there are,</span><span>
</span><span id="line-126"></span><span class="hs-comment">--   after looking through casts</span><span>
</span><span id="line-127"></span><span id="manifestArity"><span class="annot"><span class="annottext">manifestArity :: CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var hs-var">manifestArity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682707226"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707226"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682707227"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707227"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707226"><span class="hs-identifier hs-var">v</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707227"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-128"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707227"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-129"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682707231"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707231"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682707232"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707232"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707231"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707232"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-130"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682707236"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707236"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707236"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-131"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-type">joinRhsArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span>
</span><span id="line-134"></span><span class="hs-comment">-- Join points are supposed to have manifestly-visible</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- lambdas at the top: no ticks, no casts, nothing</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- Moreover, type lambdas count in JoinArity</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- NB: For non-recursive bindings, the join arity of the binding may actually be</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- less that the number of manifestly-visible lambdas.</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- See Note [Join arity prediction based on joinRhsArity] in GHC.Core.Opt.OccurAnal</span><span>
</span><span id="line-140"></span><span id="joinRhsArity"><span class="annot"><span class="annottext">joinRhsArity :: CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-var hs-var">joinRhsArity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682707238"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707238"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-var">joinRhsArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707238"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-141"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-var">joinRhsArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-145"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprBotStrictness_maybe"><span class="hs-identifier hs-type">exprBotStrictness_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier hs-type">CprSig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- A cheap and cheerful function that identifies bottoming functions</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- and gives them a suitable strictness and CPR signatures.</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- It's used during float-out</span><span>
</span><span id="line-149"></span><span id="exprBotStrictness_maybe"><span class="annot"><span class="annottext">exprBotStrictness_maybe :: CoreExpr -&gt; Maybe (Int, DmdSig, CprSig)
</span><a href="GHC.Core.Opt.Arity.html#exprBotStrictness_maybe"><span class="hs-identifier hs-var hs-var">exprBotStrictness_maybe</span></a></span></span><span> </span><span id="local-6989586621682707239"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707239"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; Maybe (Int, DmdSig, CprSig)
</span><a href="GHC.Core.Opt.Arity.html#arityTypeBotSigs_maybe"><span class="hs-identifier hs-var">arityTypeBotSigs_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; SafeArityType
CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#cheapArityType"><span class="hs-identifier hs-var">cheapArityType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707239"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityTypeBotSigs_maybe"><span class="hs-identifier hs-type">arityTypeBotSigs_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier hs-type">CprSig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- Arity of a divergent function</span><span>
</span><span id="line-153"></span><span id="arityTypeBotSigs_maybe"><span class="annot"><span class="annottext">arityTypeBotSigs_maybe :: SafeArityType -&gt; Maybe (Int, DmdSig, CprSig)
</span><a href="GHC.Core.Opt.Arity.html#arityTypeBotSigs_maybe"><span class="hs-identifier hs-var hs-var">arityTypeBotSigs_maybe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707241"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707241"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span id="local-6989586621682707242"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707242"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707242"><span class="hs-identifier hs-var">div</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int, DmdSig, CprSig) -&gt; Maybe (Int, DmdSig, CprSig)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707244"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-155"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Divergence -&gt; DmdSig
</span><a href="GHC.Types.Demand.html#mkVanillaDmdSig"><span class="hs-identifier hs-var">mkVanillaDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707244"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#botDiv"><span class="hs-identifier hs-var">botDiv</span></a></span><span>
</span><span id="line-156"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cpr -&gt; CprSig
</span><a href="GHC.Types.Cpr.html#mkCprSig"><span class="hs-identifier hs-var">mkCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707244"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="GHC.Types.Cpr.html#botCpr"><span class="hs-identifier hs-var">botCpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Int, DmdSig, CprSig)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-159"></span><span>    </span><span id="local-6989586621682707244"><span class="annot"><span class="annottext">arity :: Int
</span><a href="#local-6989586621682707244"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707241"><span class="hs-identifier hs-var">lams</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">{- Note [exprArity for applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we come to an application we check that the arg is trivial.
   eg  f (fac x) does not have arity 2,
                 even if f has arity 3!

* We require that is trivial rather merely cheap.  Suppose f has arity 2.
  Then    f (Just y)
  has arity 0, because if we gave it arity 1 and then inlined f we'd get
          let v = Just y in \w. &lt;f-body&gt;
  which has arity 0.  And we try to maintain the invariant that we don't
  have arity decreases.

*  The `max 0` is important!  (\x y -&gt; f x) has arity 2, even if f is
   unknown, hence arity 0


************************************************************************
*                                                                      *
              typeArity and the &quot;state hack&quot;
*                                                                      *
********************************************************************* -}</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-type">typeArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-187"></span><span class="hs-comment">-- ^ (typeArity ty) says how many arrows GHC can expose in 'ty', after</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- looking through newtypes.  More generally, (typeOneShots ty) returns</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- ty's [OneShotInfo], based only on the type itself, using typeOneShot</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- on the argument type to access the &quot;state hack&quot;.</span><span>
</span><span id="line-191"></span><span id="typeArity"><span class="annot"><span class="annottext">typeArity :: Type -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-var hs-var">typeArity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([OneShotInfo] -&gt; Int) -&gt; (Type -&gt; [OneShotInfo]) -&gt; Type -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.Arity.html#typeOneShots"><span class="hs-identifier hs-var">typeOneShots</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeOneShots"><span class="hs-identifier hs-type">typeOneShots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- How many value arrows are visible in the type?</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- We look through foralls, and newtypes</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- See Note [Arity invariants for bindings]</span><span>
</span><span id="line-197"></span><span id="typeOneShots"><span class="annot"><span class="annottext">typeOneShots :: Type -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.Arity.html#typeOneShots"><span class="hs-identifier hs-var hs-var">typeOneShots</span></a></span></span><span> </span><span id="local-6989586621682707249"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707249"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621682707250"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="GHC.Core.TyCon.RecWalk.html#initRecTc"><span class="hs-identifier hs-var">initRecTc</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707249"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621682707250"><span class="annot"><span class="annottext">go :: RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621682707250"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682707252"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682707252"><span class="hs-identifier hs-var">rec_nts</span></a></span></span><span> </span><span id="local-6989586621682707253"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707253"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-201"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707254"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707254"><span class="hs-identifier hs-var">tcv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707255"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707255"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (TyVar, Type)
</span><a href="GHC.Core.Type.html#splitForAllTyCoVar_maybe"><span class="hs-identifier hs-var">splitForAllTyCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707253"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707254"><span class="hs-identifier hs-var">tcv</span></a></span><span>
</span><span id="line-203"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; OneShotInfo
</span><a href="GHC.Types.Id.html#idOneShotInfo"><span class="hs-identifier hs-var">idOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707254"><span class="hs-identifier hs-var">tcv</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; [OneShotInfo] -&gt; [OneShotInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621682707250"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682707252"><span class="hs-identifier hs-var">rec_nts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707255"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-204"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621682707250"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682707252"><span class="hs-identifier hs-var">rec_nts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707255"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621682707259"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707259"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682707260"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707260"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (FunTyFlag, Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707253"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; OneShotInfo
</span><a href="GHC.Core.Opt.Arity.html#typeOneShot"><span class="hs-identifier hs-var">typeOneShot</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707259"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; [OneShotInfo] -&gt; [OneShotInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621682707250"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682707252"><span class="hs-identifier hs-var">rec_nts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707260"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707262"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682707262"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682707263"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682707263"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707253"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707265"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707265"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Maybe (Type, Coercion)
</span><a href="GHC.Core.Coercion.html#instNewTyCon_maybe"><span class="hs-identifier hs-var">instNewTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682707262"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682707263"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-211"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682707267"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682707267"><span class="hs-identifier hs-var">rec_nts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; TyCon -&gt; Maybe RecTcChecker
</span><a href="GHC.Core.TyCon.RecWalk.html#checkRecTc"><span class="hs-identifier hs-var">checkRecTc</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682707252"><span class="hs-identifier hs-var">rec_nts</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682707262"><span class="hs-identifier hs-var">tc</span></a></span><span>  </span><span class="hs-comment">-- See Note [Expanding newtypes and products]</span><span>
</span><span id="line-212"></span><span>                                                </span><span class="hs-comment">-- in GHC.Core.TyCon</span><span>
</span><span id="line-213"></span><span class="hs-comment">--   , not (isClassTyCon tc)    -- Do not eta-expand through newtype classes</span><span>
</span><span id="line-214"></span><span class="hs-comment">--                              -- See Note [Newtype classes and eta expansion]</span><span>
</span><span id="line-215"></span><span class="hs-comment">--                              (no longer required)</span><span>
</span><span id="line-216"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621682707250"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621682707267"><span class="hs-identifier hs-var">rec_nts'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707265"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-comment">-- Important to look through non-recursive newtypes, so that, eg</span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-comment">--      (f x)   where f has arity 2, f :: Int -&gt; IO ()</span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-comment">-- Here we want to get arity 1 for the result!</span><span>
</span><span id="line-220"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-221"></span><span>        </span><span class="hs-comment">-- AND through a layer of recursive newtypes</span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-comment">-- e.g. newtype Stream m a b = Stream (m (Either b (a, Stream m a b)))</span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-225"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeOneShot"><span class="hs-identifier hs-type">typeOneShot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span>
</span><span id="line-228"></span><span id="typeOneShot"><span class="annot"><span class="annottext">typeOneShot :: Type -&gt; OneShotInfo
</span><a href="GHC.Core.Opt.Arity.html#typeOneShot"><span class="hs-identifier hs-var hs-var">typeOneShot</span></a></span></span><span> </span><span id="local-6989586621682707268"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707268"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-229"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isStateHackType"><span class="hs-identifier hs-var">isStateHackType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707268"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span>
</span><span id="line-230"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="hs-comment">-- | Like 'idOneShotInfo', but taking the Horrible State Hack in to account</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- See Note [The state-transformer hack] in &quot;GHC.Core.Opt.Arity&quot;</span><span>
</span><span id="line-234"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#idStateHackOneShotInfo"><span class="hs-identifier hs-type">idStateHackOneShotInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span>
</span><span id="line-235"></span><span id="idStateHackOneShotInfo"><span class="annot"><span class="annottext">idStateHackOneShotInfo :: TyVar -&gt; OneShotInfo
</span><a href="GHC.Core.Opt.Arity.html#idStateHackOneShotInfo"><span class="hs-identifier hs-var hs-var">idStateHackOneShotInfo</span></a></span></span><span> </span><span id="local-6989586621682707273"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707273"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isStateHackType"><span class="hs-identifier hs-var">isStateHackType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707273"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; OneShotInfo
</span><a href="GHC.Types.Id.html#idOneShotInfo"><span class="hs-identifier hs-var">idOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707273"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | Returns whether the lambda associated with the 'Id' is</span><span>
</span><span id="line-240"></span><span class="hs-comment">--   certainly applied at most once</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- This one is the &quot;business end&quot;, called externally.</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- It works on type variables as well as Ids, returning True</span><span>
</span><span id="line-243"></span><span class="hs-comment">-- Its main purpose is to encapsulate the Horrible State Hack</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- See Note [The state-transformer hack] in &quot;GHC.Core.Opt.Arity&quot;</span><span>
</span><span id="line-245"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#isOneShotBndr"><span class="hs-identifier hs-type">isOneShotBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-246"></span><span id="isOneShotBndr"><span class="annot"><span class="annottext">isOneShotBndr :: TyVar -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isOneShotBndr"><span class="hs-identifier hs-var hs-var">isOneShotBndr</span></a></span></span><span> </span><span id="local-6989586621682707276"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707276"><span class="hs-identifier hs-var">var</span></a></span></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707276"><span class="hs-identifier hs-var">var</span></a></span><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; OneShotInfo
</span><a href="GHC.Core.Opt.Arity.html#idStateHackOneShotInfo"><span class="hs-identifier hs-var">idStateHackOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707276"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#isStateHackType"><span class="hs-identifier hs-type">isStateHackType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-252"></span><span id="isStateHackType"><span class="annot"><span class="annottext">isStateHackType :: Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isStateHackType"><span class="hs-identifier hs-var hs-var">isStateHackType</span></a></span></span><span> </span><span id="local-6989586621682707278"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707278"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Utils.GlobalVars.html#unsafeHasNoStateHack"><span class="hs-identifier hs-var">unsafeHasNoStateHack</span></a></span><span>   </span><span class="hs-comment">-- Switch off with -fno-state-hack</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe TyCon
</span><a href="GHC.Core.Type.html#tyConAppTyCon_maybe"><span class="hs-identifier hs-var">tyConAppTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707278"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-257"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682707280"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682707280"><span class="hs-identifier hs-var">tycon</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682707280"><span class="hs-identifier hs-var">tycon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="GHC.Builtin.Types.Prim.html#statePrimTyCon"><span class="hs-identifier hs-var">statePrimTyCon</span></a></span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="annottext">Maybe TyCon
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-259"></span><span>        </span><span class="hs-comment">-- This is a gross hack.  It claims that</span><span>
</span><span id="line-260"></span><span>        </span><span class="hs-comment">-- every function over realWorldStatePrimTy is a one-shot</span><span>
</span><span id="line-261"></span><span>        </span><span class="hs-comment">-- function.  This is pretty true in practice, and makes a big</span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-comment">-- difference.  For example, consider</span><span>
</span><span id="line-263"></span><span>        </span><span class="hs-comment">--      a `thenST` \ r -&gt; ...E...</span><span>
</span><span id="line-264"></span><span>        </span><span class="hs-comment">-- The early full laziness pass, if it doesn't know that r is one-shot</span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-comment">-- will pull out E (let's say it doesn't mention r) to give</span><span>
</span><span id="line-266"></span><span>        </span><span class="hs-comment">--      let lvl = E in a `thenST` \ r -&gt; ...lvl...</span><span>
</span><span id="line-267"></span><span>        </span><span class="hs-comment">-- When `thenST` gets inlined, we end up with</span><span>
</span><span id="line-268"></span><span>        </span><span class="hs-comment">--      let lvl = E in \s -&gt; case a s of (r, s') -&gt; ...lvl...</span><span>
</span><span id="line-269"></span><span>        </span><span class="hs-comment">-- and we don't re-inline E.</span><span>
</span><span id="line-270"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-comment">-- It would be better to spot that r was one-shot to start with, but</span><span>
</span><span id="line-272"></span><span>        </span><span class="hs-comment">-- I don't want to rely on that.</span><span>
</span><span id="line-273"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-274"></span><span>        </span><span class="hs-comment">-- Another good example is in fill_in in PrelPack.hs.  We should be able to</span><span>
</span><span id="line-275"></span><span>        </span><span class="hs-comment">-- spot that fill_in has arity 2 (and when Keith is done, we will) but we can't yet.</span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-comment">{- Note [Arity invariants for bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have the following invariants for let-bindings

  (1) In any binding f = e,
         idArity f &lt;= typeArity (idType f)
      We enforce this with trimArityType, called in findRhsArity;
      see Note [Arity trimming].

      Note that we enforce this only for /bindings/.  We do /not/ insist that
         arityTypeArity (arityType e) &lt;= typeArity (exprType e)
      because that is quite a bit more expensive to guaranteed; it would
      mean checking at every Cast in the recursive arityType, for example.

  (2) If typeArity (exprType e) = n,
      then manifestArity (etaExpand e n) = n

      That is, etaExpand can always expand as much as typeArity says
      (or less, of course). So the case analysis in etaExpand and in
      typeArity must match.

      Consequence: because of (1), if we eta-expand to (idArity f), we will
      end up with n manifest lambdas.

   (3) In any binding f = e,
         idArity f &lt;= arityTypeArity (safeArityType (arityType e))
       That is, we call safeArityType before attributing e's arityType to f.
       See Note [SafeArityType].

       So we call safeArityType in findRhsArity.

Suppose we have
   f :: Int -&gt; Int -&gt; Int
   f x y = x+y    -- Arity 2

   g :: F Int
   g = case &lt;cond&gt; of { True  -&gt; f |&gt; co1
                      ; False -&gt; g |&gt; co2 }

where F is a type family.  Now, we can't eta-expand g to have arity 2,
because etaExpand, which works off the /type/ of the expression
(albeit looking through newtypes), doesn't know how to make an
eta-expanded binding
   g = (\a b. case x of ...) |&gt; co
because it can't make up `co` or the types of `a` and `b`.

So invariant (1) ensures that every binding has an arity that is no greater
than the typeArity of the RHS; and invariant (2) ensures that etaExpand
and handle what typeArity says.

Why is this important?  Because

  - In GHC.Iface.Tidy we use exprArity/manifestArity to fix the *final
    arity* of each top-level Id, and in

  - In CorePrep we use etaExpand on each rhs, so that the visible
    lambdas actually match that arity, which in turn means that the
    StgRhs has a number of lambdas that precisely matches the arity.

Note [Arity trimming]
~~~~~~~~~~~~~~~~~~~~~
Invariant (1) of Note [Arity invariants for bindings] is upheld by findRhsArity,
which calls trimArityType to trim the ArityType to match the Arity of the
binding.  Failing to do so, and hence breaking invariant (1) led to #5441.

How to trim?  If we end in topDiv, it's easy.  But we must take great care with
dead ends (i.e. botDiv). Suppose the expression was (\x y. error &quot;urk&quot;),
we'll get \??.&#8869;.  We absolutely must not trim that to \?.&#8869;, because that
claims that ((\x y. error &quot;urk&quot;) |&gt; co) diverges when given one argument,
which it absolutely does not. And Bad Things happen if we think something
returns bottom when it doesn't (#16066).

So, if we need to trim a dead-ending arity type, switch (conservatively) to
topDiv.

Historical note: long ago, we unconditionally switched to topDiv when we
encountered a cast, but that is far too conservative: see #5475

Note [Newtype classes and eta expansion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    NB: this nasty special case is no longer required, because
    for newtype classes we don't use the class-op rule mechanism
    at all.  See Note [Single-method classes] in GHC.Tc.TyCl.Instance. SLPJ May 2013

-------- Old out of date comments, just for interest -----------
We have to be careful when eta-expanding through newtypes.  In general
it's a good idea, but annoyingly it interacts badly with the class-op
rule mechanism.  Consider

   class C a where { op :: a -&gt; a }
   instance C b =&gt; C [b] where
     op x = ...

These translate to

   co :: forall a. (a-&gt;a) ~ C a

   $copList :: C b -&gt; [b] -&gt; [b]
   $copList d x = ...

   $dfList :: C b -&gt; C [b]
   {-# DFunUnfolding = [$copList] #-}
   $dfList d = $copList d |&gt; co@[b]

Now suppose we have:

   dCInt :: C Int

   blah :: [Int] -&gt; [Int]
   blah = op ($dfList dCInt)

Now we want the built-in op/$dfList rule will fire to give
   blah = $copList dCInt

But with eta-expansion 'blah' might (and in #3772, which is
slightly more complicated, does) turn into

   blah = op (\eta. ($dfList dCInt |&gt; sym co) eta)

and now it is *much* harder for the op/$dfList rule to fire, because
exprIsConApp_maybe won't hold of the argument to op.  I considered
trying to *make* it hold, but it's tricky and I gave up.

The test simplCore/should_compile/T3722 is an excellent example.
-------- End of old out of date comments, just for interest -----------
-}</span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span class="annot"><span class="hs-comment">{- ********************************************************************
*                                                                      *
                  Zapping lambda binders
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#zapLamBndrs"><span class="hs-identifier hs-type">zapLamBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#FullArgCount"><span class="hs-identifier hs-type">FullArgCount</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- If (\xyz. t) appears under-applied to only two arguments,</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- we must zap the occ-info on x,y, because they appear (in 't') under the \z.</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- See Note [Occurrence analysis for lambda binders] in GHc.Core.Opt.OccurAnal</span><span>
</span><span id="line-415"></span><span class="hs-comment">--</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- NB: both `arg_count` and `bndrs` include both type and value args/bndrs</span><span>
</span><span id="line-417"></span><span id="zapLamBndrs"><span class="annot"><span class="annottext">zapLamBndrs :: Int -&gt; [TyVar] -&gt; [TyVar]
</span><a href="GHC.Core.Opt.Arity.html#zapLamBndrs"><span class="hs-identifier hs-var hs-var">zapLamBndrs</span></a></span></span><span> </span><span id="local-6989586621682707283"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707283"><span class="hs-identifier hs-var">arg_count</span></a></span></span><span> </span><span id="local-6989586621682707284"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707284"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707285"><span class="hs-identifier hs-var">no_need_to_zap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707284"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [TyVar] -&gt; [TyVar]
</span><a href="#local-6989586621682707286"><span class="hs-identifier hs-var">zap_em</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707283"><span class="hs-identifier hs-var">arg_count</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707284"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-421"></span><span>    </span><span id="local-6989586621682707285"><span class="annot"><span class="annottext">no_need_to_zap :: Bool
</span><a href="#local-6989586621682707285"><span class="hs-identifier hs-var hs-var">no_need_to_zap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; [TyVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isOneShotBndr"><span class="hs-identifier hs-var">isOneShotBndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [TyVar] -&gt; [TyVar]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707283"><span class="hs-identifier hs-var">arg_count</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707284"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span>    </span><span class="annot"><a href="#local-6989586621682707286"><span class="hs-identifier hs-type">zap_em</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#FullArgCount"><span class="hs-identifier hs-type">FullArgCount</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-424"></span><span>    </span><span id="local-6989586621682707286"><span class="annot"><span class="annottext">zap_em :: Int -&gt; [TyVar] -&gt; [TyVar]
</span><a href="#local-6989586621682707286"><span class="hs-identifier hs-var hs-var">zap_em</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621682707289"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707289"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707289"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-425"></span><span>    </span><span class="annot"><a href="#local-6989586621682707286"><span class="hs-identifier hs-var">zap_em</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-426"></span><span>    </span><span class="annot"><a href="#local-6989586621682707286"><span class="hs-identifier hs-var">zap_em</span></a></span><span> </span><span id="local-6989586621682707290"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707290"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707291"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707291"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707292"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707292"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707291"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707291"><span class="hs-identifier hs-var">b</span></a></span><span>              </span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [TyVar] -&gt; [TyVar]
</span><a href="#local-6989586621682707286"><span class="hs-identifier hs-var">zap_em</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707290"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707292"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-427"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; TyVar
</span><a href="GHC.Types.Id.html#zapLamIdInfo"><span class="hs-identifier hs-var">zapLamIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707291"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [TyVar] -&gt; [TyVar]
</span><a href="#local-6989586621682707286"><span class="hs-identifier hs-var">zap_em</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707290"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707292"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
           Computing the &quot;arity&quot; of an expression
*                                                                      *
************************************************************************

Note [Definition of arity]
~~~~~~~~~~~~~~~~~~~~~~~~~~
The &quot;arity&quot; of an expression 'e' is n if
   applying 'e' to *fewer* than n *value* arguments
   converges rapidly

Or, to put it another way

   there is no work lost in duplicating the partial
   application (e x1 .. x(n-1))

In the divergent case, no work is lost by duplicating because if the thing
is evaluated once, that's the end of the program.

Or, to put it another way, in any context C

   C[ (\x1 .. xn. e x1 .. xn) ]
         is as efficient as
   C[ e ]

It's all a bit more subtle than it looks:

Note [One-shot lambdas]
~~~~~~~~~~~~~~~~~~~~~~~
Consider one-shot lambdas
                let x = expensive in \y z -&gt; E
We want this to have arity 1 if the \y-abstraction is a 1-shot lambda.

Note [Dealing with bottom]
~~~~~~~~~~~~~~~~~~~~~~~~~~
GHC does some transformations that are technically unsound wrt
bottom, because doing so improves arities... a lot!  We describe
them in this Note.

The flag -fpedantic-bottoms (off by default) restore technically
correct behaviour at the cots of efficiency.

It's mostly to do with eta-expansion.  Consider

   f = \x -&gt; case x of
               True  -&gt; \s -&gt; e1
               False -&gt; \s -&gt; e2

This happens all the time when f :: Bool -&gt; IO ()
In this case we do eta-expand, in order to get that \s to the
top, and give f arity 2.

This isn't really right in the presence of seq.  Consider
        (f bot) `seq` 1

This should diverge!  But if we eta-expand, it won't.  We ignore this
&quot;problem&quot; (unless -fpedantic-bottoms is on), because being scrupulous
would lose an important transformation for many programs. (See
#5587 for an example.)

Consider also
        f = \x -&gt; error &quot;foo&quot;
Here, arity 1 is fine.  But if it looks like this (see #22068)
        f = \x -&gt; case x of
                        True  -&gt; error &quot;foo&quot;
                        False -&gt; \y -&gt; x+y
then we want to get arity 2.  Technically, this isn't quite right, because
        (f True) `seq` 1
should diverge, but it'll converge if we eta-expand f.  Nevertheless, we
do so; it improves some programs significantly, and increasing convergence
isn't a bad thing.  Hence the ABot/ATop in ArityType.

So these two transformations aren't always the Right Thing, and we
have several tickets reporting unexpected behaviour resulting from
this transformation.  So we try to limit it as much as possible:

 (1) Do NOT move a lambda outside a known-bottom case expression
       case undefined of { (a,b) -&gt; \y -&gt; e }
     This showed up in #5557

 (2) Do NOT move a lambda outside a case unless
     (a) The scrutinee is ok-for-speculation, or
     (b) more liberally: the scrutinee is cheap (e.g. a variable), and
         -fpedantic-bottoms is not enforced (see #2915 for an example)

Of course both (1) and (2) are readily defeated by disguising the bottoms.

There also is an interaction with Note [Combining arity type with demand info],
outlined in Wrinkle (CAD1).

Note [Newtype arity]
~~~~~~~~~~~~~~~~~~~~
Non-recursive newtypes are transparent, and should not get in the way.
We do (currently) eta-expand recursive newtypes too.  So if we have, say

        newtype T = MkT ([T] -&gt; Int)

Suppose we have
        e = coerce T f
where f has arity 1.  Then: etaExpandArity e = 1;
that is, etaExpandArity looks through the coerce.

When we eta-expand e to arity 1: eta_expand 1 e T
we want to get:                  coerce T (\x::[T] -&gt; (coerce ([T]-&gt;Int) e) x)

  HOWEVER, note that if you use coerce bogusly you can ge
        coerce Int negate
  And since negate has arity 2, you might try to eta expand.  But you can't
  decompose Int to a function type.   Hence the final case in eta_expand.

Note [The state-transformer hack]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
        f = e
where e has arity n.  Then, if we know from the context that f has
a usage type like
        t1 -&gt; ... -&gt; tn -1-&gt; t(n+1) -1-&gt; ... -1-&gt; tm -&gt; ...
then we can expand the arity to m.  This usage type says that
any application (x e1 .. en) will be applied to uniquely to (m-n) more args
Consider f = \x. let y = &lt;expensive&gt;
                 in case x of
                      True  -&gt; foo
                      False -&gt; \(s:RealWorld) -&gt; e
where foo has arity 1.  Then we want the state hack to
apply to foo too, so we can eta expand the case.

Then we expect that if f is applied to one arg, it'll be applied to two
(that's the hack -- we don't really know, and sometimes it's false)
See also Id.isOneShotBndr.

Note [State hack and bottoming functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's a terrible idea to use the state hack on a bottoming function.
Here's what happens (#2861):

  f :: String -&gt; IO T
  f = \p. error &quot;...&quot;

Eta-expand, using the state hack:

  f = \p. (\s. ((error &quot;...&quot;) |&gt; g1) s) |&gt; g2
  g1 :: IO T ~ (S -&gt; (S,T))
  g2 :: (S -&gt; (S,T)) ~ IO T

Extrude the g2

  f' = \p. \s. ((error &quot;...&quot;) |&gt; g1) s
  f = f' |&gt; (String -&gt; g2)

Discard args for bottoming function

  f' = \p. \s. ((error &quot;...&quot;) |&gt; g1 |&gt; g3
  g3 :: (S -&gt; (S,T)) ~ (S,T)

Extrude g1.g3

  f'' = \p. \s. (error &quot;...&quot;)
  f' = f'' |&gt; (String -&gt; S -&gt; g1.g3)

And now we can repeat the whole loop.  Aargh!  The bug is in applying the
state hack to a function which then swallows the argument.

This arose in another guise in #3959.  Here we had

     catch# (throw exn &gt;&gt; return ())

Note that (throw :: forall a e. Exn e =&gt; e -&gt; a) is called with [a = IO ()].
After inlining (&gt;&gt;) we get

     catch# (\_. throw {IO ()} exn)

We must *not* eta-expand to

     catch# (\_ _. throw {...} exn)

because 'catch#' expects to get a (# _,_ #) after applying its argument to
a State#, not another function!

In short, we use the state hack to allow us to push let inside a lambda,
but not to introduce a new lambda.


Note [ArityType]
~~~~~~~~~~~~~~~~
ArityType can be thought of as an abstraction of an expression.
The ArityType
   AT [ (IsCheap,     NoOneShotInfo)
      , (IsExpensive, OneShotLam)
      , (IsCheap,     OneShotLam) ] Dunno)

abstracts an expression like
   \x. let &lt;expensive&gt; in
       \y{os}.
       \z{os}. blah

In general we have (AT lams div).  Then
* In lams :: [(Cost,OneShotInfo)]
  * The Cost flag describes the part of the expression down
    to the first (value) lambda.
  * The OneShotInfo flag gives the one-shot info on that lambda.

* If 'div' is dead-ending ('isDeadEndDiv'), then application to
  'length lams' arguments will surely diverge, similar to the situation
  with 'DmdType'.

ArityType is the result of a compositional analysis on expressions,
from which we can decide the real arity of the expression (extracted
with function exprEtaExpandArity).

We use the following notation:
  at  ::= \p1..pn.div
  div ::= T | x | &#8869;
  p   ::= (c o)
  c   ::= X | C    -- Expensive or Cheap
  o   ::= ? | 1    -- NotOneShot or OneShotLam
We may omit the \. if n = 0.
And &#8869; stands for `AT [] botDiv`

Here is an example demonstrating the notation:
  \(C?)(X1)(C1).T
stands for
   AT [ (IsCheap,NoOneShotInfo)
      , (IsExpensive,OneShotLam)
      , (IsCheap,OneShotLam) ]
      topDiv

See the 'Outputable' instance for more information. It's pretty simple.

How can we use ArityType?  Example:
      f = \x\y. let v = &lt;expensive&gt; in
          \s(one-shot) \t(one-shot). blah
      'f' has arity type \(C?)(C?)(X1)(C1).T
      The one-shot-ness means we can, in effect, push that
      'let' inside the \st, and expand to arity 4

Suppose f = \xy. x+y
Then  f             :: \(C?)(C?).T
      f v           :: \(C?).T
      f &lt;expensive&gt; :: \(X?).T

Here is what the fields mean. If an arbitrary expression 'f' has
ArityType 'at', then

 * If @at = AT [o1,..,on] botDiv@ (notation: \o1..on.&#8869;), then @f x1..xn@
   definitely diverges. Partial applications to fewer than n args may *or
   may not* diverge.  Ditto exnDiv.

 * If `f` has ArityType `at` we can eta-expand `f` to have (aritTypeOneShots at)
   arguments without losing sharing. This function checks that the either
   there are no expensive expressions, or the lambdas are one-shots.

   NB 'f' is an arbitrary expression, eg @f = g e1 e2@.  This 'f' can have
   arity type @AT oss _@, with @length oss &gt; 0@, only if e1 e2 are themselves
   cheap.

 * In both cases, @f@, @f x1@, ... @f x1 ... x(n-1)@ are definitely
   really functions, or bottom, but *not* casts from a data type, in
   at least one case branch.  (If it's a function in one case branch but
   an unsafe cast from a data type in another, the program is bogus.)
   So eta expansion is dynamically ok; see Note [State hack and
   bottoming functions], the part about catch#

Wrinkles

* Wrinkle [Bottoming functions]: see function 'arityLam'.
  We treat bottoming functions as one-shot, because there is no point
  in floating work outside the lambda, and it's fine to float it inside.

  For example, this is fine (see test stranal/sigs/BottomFromInnerLambda)
       let x = &lt;expensive&gt; in \y. error (g x y)
       ==&gt; \y. let x = &lt;expensive&gt; in error (g x y)

  Idea: perhaps we could enforce this invariant with
     data Arity Type = TopAT [(Cost, OneShotInfo)] | DivAT [Cost]


Note [SafeArityType]
~~~~~~~~~~~~~~~~~~~~
The function safeArityType trims an ArityType to return a &quot;safe&quot; ArityType,
for which we use a type synonym SafeArityType.  It is &quot;safe&quot; in the sense
that (arityTypeArity at) really reflects the arity of the expression, whereas
a regular ArityType might have more lambdas in its [ATLamInfo] that the
(cost-free) arity of the expression.

For example
   \x.\y.let v = expensive in \z. blah
has
   arityType = AT [C?, C?, X?, C?] Top
But the expression actually has arity 2, not 4, because of the X.
So safeArityType will trim it to (AT [C?, C?] Top), whose [ATLamInfo]
now reflects the (cost-free) arity of the expression

Why do we ever need an &quot;unsafe&quot; ArityType, such as the example above?
Because its (cost-free) arity may increased by combineWithCallCards
in findRhsArity. See Note [Combining arity type with demand info].

Thus the function `arityType` returns a regular &quot;unsafe&quot; ArityType, that
goes deeply into the lambdas (including under IsExpensive). But that is
very local; most ArityTypes are indeed &quot;safe&quot;.  We use the type synonym
SafeArityType to indicate where we believe the ArityType is safe.
-}</span></span><span>
</span><span id="line-732"></span><span>
</span><span id="line-733"></span><span class="hs-comment">-- | The analysis lattice of arity analysis. It is isomorphic to</span><span>
</span><span id="line-734"></span><span class="hs-comment">--</span><span>
</span><span id="line-735"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-736"></span><span class="hs-comment">--    data ArityType'</span><span>
</span><span id="line-737"></span><span class="hs-comment">--      = AEnd Divergence</span><span>
</span><span id="line-738"></span><span class="hs-comment">--      | ALam OneShotInfo ArityType'</span><span>
</span><span id="line-739"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-740"></span><span class="hs-comment">--</span><span>
</span><span id="line-741"></span><span class="hs-comment">-- Which is easier to display the Hasse diagram for:</span><span>
</span><span id="line-742"></span><span class="hs-comment">--</span><span>
</span><span id="line-743"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-744"></span><span class="hs-comment">--  ALam OneShotLam at</span><span>
</span><span id="line-745"></span><span class="hs-comment">--          |</span><span>
</span><span id="line-746"></span><span class="hs-comment">--      AEnd topDiv</span><span>
</span><span id="line-747"></span><span class="hs-comment">--          |</span><span>
</span><span id="line-748"></span><span class="hs-comment">--  ALam NoOneShotInfo at</span><span>
</span><span id="line-749"></span><span class="hs-comment">--          |</span><span>
</span><span id="line-750"></span><span class="hs-comment">--      AEnd exnDiv</span><span>
</span><span id="line-751"></span><span class="hs-comment">--          |</span><span>
</span><span id="line-752"></span><span class="hs-comment">--      AEnd botDiv</span><span>
</span><span id="line-753"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-754"></span><span class="hs-comment">--</span><span>
</span><span id="line-755"></span><span class="hs-comment">-- where the @at@ fields of @ALam@ are inductively subject to the same order.</span><span>
</span><span id="line-756"></span><span class="hs-comment">-- That is, @ALam os at1 &lt; ALam os at2@ iff @at1 &lt; at2@.</span><span>
</span><span id="line-757"></span><span class="hs-comment">--</span><span>
</span><span id="line-758"></span><span class="hs-comment">-- Why the strange Top element?</span><span>
</span><span id="line-759"></span><span class="hs-comment">--   See Note [Combining case branches: optimistic one-shot-ness]</span><span>
</span><span id="line-760"></span><span class="hs-comment">--</span><span>
</span><span id="line-761"></span><span class="hs-comment">-- We rely on this lattice structure for fixed-point iteration in</span><span>
</span><span id="line-762"></span><span class="hs-comment">-- 'findRhsArity'. For the semantics of 'ArityType', see Note [ArityType].</span><span>
</span><span id="line-763"></span><span class="hs-keyword">data</span><span> </span><span id="ArityType"><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-var">ArityType</span></a></span></span><span>  </span><span class="hs-comment">-- See Note [ArityType]</span><span>
</span><span id="line-764"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="AT"><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ATLamInfo"><span class="hs-identifier hs-type">ATLamInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Demand.html#Divergence"><span class="hs-identifier hs-type">Divergence</span></a></span><span>
</span><span id="line-765"></span><span>    </span><span class="hs-comment">-- ^ `AT oss div` is an abstraction of the expression, which describes</span><span>
</span><span id="line-766"></span><span>    </span><span class="hs-comment">-- its lambdas, and how much work appears where.</span><span>
</span><span id="line-767"></span><span>    </span><span class="hs-comment">-- See Note [ArityType] for more information</span><span>
</span><span id="line-768"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-769"></span><span>    </span><span class="hs-comment">-- If `div` is dead-ending ('isDeadEndDiv'), then application to</span><span>
</span><span id="line-770"></span><span>    </span><span class="hs-comment">-- `length os` arguments will surely diverge, similar to the situation</span><span>
</span><span id="line-771"></span><span>    </span><span class="hs-comment">-- with 'DmdType'.</span><span>
</span><span id="line-772"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621682707300"><span id="local-6989586621682707307"><span class="annot"><span class="annottext">SafeArityType -&gt; SafeArityType -&gt; Bool
(SafeArityType -&gt; SafeArityType -&gt; Bool)
-&gt; (SafeArityType -&gt; SafeArityType -&gt; Bool) -&gt; Eq SafeArityType
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: SafeArityType -&gt; SafeArityType -&gt; Bool
== :: SafeArityType -&gt; SafeArityType -&gt; Bool
$c/= :: SafeArityType -&gt; SafeArityType -&gt; Bool
/= :: SafeArityType -&gt; SafeArityType -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span class="hs-keyword">type</span><span> </span><span id="ATLamInfo"><span class="annot"><a href="GHC.Core.Opt.Arity.html#ATLamInfo"><span class="hs-identifier hs-var">ATLamInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-775"></span><span>     </span><span class="hs-comment">-- ^ Info about one lambda in an ArityType</span><span>
</span><span id="line-776"></span><span>     </span><span class="hs-comment">-- See Note [ArityType]</span><span>
</span><span id="line-777"></span><span>
</span><span id="line-778"></span><span class="hs-keyword">type</span><span> </span><span id="SafeArityType"><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-var">SafeArityType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-comment">-- See Note [SafeArityType]</span><span>
</span><span id="line-779"></span><span>
</span><span id="line-780"></span><span class="hs-keyword">data</span><span> </span><span id="Cost"><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-var">Cost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="IsCheap"><span class="annot"><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="IsExpensive"><span class="annot"><a href="GHC.Core.Opt.Arity.html#IsExpensive"><span class="hs-identifier hs-var">IsExpensive</span></a></span></span><span>
</span><span id="line-781"></span><span>          </span><span class="hs-keyword">deriving</span><span class="hs-special">(</span><span> </span><span id="local-6989586621682707318"><span id="local-6989586621682707323"><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Bool
(Cost -&gt; Cost -&gt; Bool) -&gt; (Cost -&gt; Cost -&gt; Bool) -&gt; Eq Cost
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: Cost -&gt; Cost -&gt; Bool
== :: Cost -&gt; Cost -&gt; Bool
$c/= :: Cost -&gt; Cost -&gt; Bool
/= :: Cost -&gt; Cost -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-782"></span><span>
</span><span id="line-783"></span><span id="local-6989586621682706822"><span class="annot"><a href="GHC.Core.Opt.Arity.html#allCosts"><span class="hs-identifier hs-type">allCosts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682706822"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682706822"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span></span><span>
</span><span id="line-784"></span><span id="allCosts"><span class="annot"><span class="annottext">allCosts :: forall a. (a -&gt; Cost) -&gt; [a] -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#allCosts"><span class="hs-identifier hs-var hs-var">allCosts</span></a></span></span><span> </span><span id="local-6989586621682707327"><span class="annot"><span class="annottext">a -&gt; Cost
</span><a href="#local-6989586621682707327"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682707328"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682707328"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Cost -&gt; Cost) -&gt; Cost -&gt; [a] -&gt; Cost
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#addCost"><span class="hs-identifier hs-var">addCost</span></a></span><span> </span><span class="annot"><span class="annottext">(Cost -&gt; Cost -&gt; Cost) -&gt; (a -&gt; Cost) -&gt; a -&gt; Cost -&gt; Cost
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Cost
</span><a href="#local-6989586621682707327"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682707328"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#addCost"><span class="hs-identifier hs-type">addCost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span>
</span><span id="line-787"></span><span id="addCost"><span class="annot"><span class="annottext">addCost :: Cost -&gt; Cost -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#addCost"><span class="hs-identifier hs-var hs-var">addCost</span></a></span></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span>
</span><span id="line-788"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#addCost"><span class="hs-identifier hs-var">addCost</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span>       </span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsExpensive"><span class="hs-identifier hs-var">IsExpensive</span></a></span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span class="hs-comment">-- | This is the BNF of the generated output:</span><span>
</span><span id="line-791"></span><span class="hs-comment">--</span><span>
</span><span id="line-792"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-793"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-794"></span><span class="hs-comment">--</span><span>
</span><span id="line-795"></span><span class="hs-comment">-- We format</span><span>
</span><span id="line-796"></span><span class="hs-comment">-- @AT [o1,..,on] topDiv@ as @\o1..on.T@ and</span><span>
</span><span id="line-797"></span><span class="hs-comment">-- @AT [o1,..,on] botDiv@ as @\o1..on.&#8869;@, respectively.</span><span>
</span><span id="line-798"></span><span class="hs-comment">-- More concretely, @AT [NOI,OS,OS] topDiv@ is formatted as @\?11.T@.</span><span>
</span><span id="line-799"></span><span class="hs-comment">-- If the one-shot info is empty, we omit the leading @\.@.</span><span>
</span><span id="line-800"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-801"></span><span>  </span><span id="local-6989586621682707343"><span class="annot"><span class="annottext">ppr :: SafeArityType -&gt; SDoc
</span><a href="#local-6989586621682707343"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707345"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707345"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621682707346"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707346"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707345"><span class="hs-identifier hs-var">oss</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; SDoc
forall {doc}. IsLine doc =&gt; Divergence -&gt; doc
</span><a href="#local-6989586621682707348"><span class="hs-identifier hs-var">pp_div</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707346"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-803"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\\'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hcat"><span class="hs-identifier hs-var">hcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ATLamInfo -&gt; SDoc) -&gt; [ATLamInfo] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ATLamInfo -&gt; SDoc
forall {doc}. IsLine doc =&gt; ATLamInfo -&gt; doc
</span><a href="#local-6989586621682707352"><span class="hs-identifier hs-var">pp_os</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707345"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#dot"><span class="hs-identifier hs-var">dot</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; SDoc
forall {doc}. IsLine doc =&gt; Divergence -&gt; doc
</span><a href="#local-6989586621682707348"><span class="hs-identifier hs-var">pp_div</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707346"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-804"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-805"></span><span>      </span><span id="local-6989586621682707348"><span class="annot"><span class="annottext">pp_div :: Divergence -&gt; doc
</span><a href="#local-6989586621682707348"><span class="hs-identifier hs-var hs-var">pp_div</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; doc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'&#8869;'</span></span><span>
</span><span id="line-806"></span><span>      </span><span class="annot"><a href="#local-6989586621682707348"><span class="hs-identifier hs-var">pp_div</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#ExnOrDiv"><span class="hs-identifier hs-var">ExnOrDiv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; doc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'x'</span></span><span>
</span><span id="line-807"></span><span>      </span><span class="annot"><a href="#local-6989586621682707348"><span class="hs-identifier hs-var">pp_div</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; doc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'T'</span></span><span>
</span><span id="line-808"></span><span>      </span><span id="local-6989586621682707352"><span class="annot"><span class="annottext">pp_os :: ATLamInfo -&gt; doc
</span><a href="#local-6989586621682707352"><span class="hs-identifier hs-var hs-var">pp_os</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span class="hs-special">,</span><span>     </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(C1)&quot;</span></span><span>
</span><span id="line-809"></span><span>      </span><span class="annot"><a href="#local-6989586621682707352"><span class="hs-identifier hs-var">pp_os</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsExpensive"><span class="hs-identifier hs-var">IsExpensive</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(X1)&quot;</span></span><span>
</span><span id="line-810"></span><span>      </span><span class="annot"><a href="#local-6989586621682707352"><span class="hs-identifier hs-var">pp_os</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span class="hs-special">,</span><span>     </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(C?)&quot;</span></span><span>
</span><span id="line-811"></span><span>      </span><span class="annot"><a href="#local-6989586621682707352"><span class="hs-identifier hs-var">pp_os</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsExpensive"><span class="hs-identifier hs-var">IsExpensive</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(X?)&quot;</span></span><span>
</span><span id="line-812"></span><span>
</span><span id="line-813"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#mkBotArityType"><span class="hs-identifier hs-type">mkBotArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-814"></span><span id="mkBotArityType"><span class="annot"><span class="annottext">mkBotArityType :: [OneShotInfo] -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#mkBotArityType"><span class="hs-identifier hs-var hs-var">mkBotArityType</span></a></span></span><span> </span><span id="local-6989586621682707372"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707372"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707373"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682707373"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707373"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707372"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#botDiv"><span class="hs-identifier hs-var">botDiv</span></a></span><span>
</span><span id="line-815"></span><span>
</span><span id="line-816"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-type">botArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-817"></span><span id="botArityType"><span class="annot"><span class="annottext">botArityType :: SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-var hs-var">botArityType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#mkBotArityType"><span class="hs-identifier hs-var">mkBotArityType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-818"></span><span>
</span><span id="line-819"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#topArityType"><span class="hs-identifier hs-type">topArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-820"></span><span id="topArityType"><span class="annot"><span class="annottext">topArityType :: SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#topArityType"><span class="hs-identifier hs-var hs-var">topArityType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-821"></span><span>
</span><span id="line-822"></span><span class="annot"><span class="hs-comment">-- | The number of value args for the arity type</span></span><span>
</span><span id="line-823"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier hs-type">arityTypeArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-824"></span><span id="arityTypeArity"><span class="annot"><span class="annottext">arityTypeArity :: SafeArityType -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier hs-var hs-var">arityTypeArity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707377"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707377"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707377"><span class="hs-identifier hs-var">lams</span></a></span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityTypeOneShots"><span class="hs-identifier hs-type">arityTypeOneShots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-827"></span><span class="hs-comment">-- Returns a list only as long as the arity should be</span><span>
</span><span id="line-828"></span><span id="arityTypeOneShots"><span class="annot"><span class="annottext">arityTypeOneShots :: SafeArityType -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.Arity.html#arityTypeOneShots"><span class="hs-identifier hs-var hs-var">arityTypeOneShots</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707379"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707379"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ATLamInfo -&gt; OneShotInfo) -&gt; [ATLamInfo] -&gt; [OneShotInfo]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ATLamInfo -&gt; OneShotInfo
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707379"><span class="hs-identifier hs-var">lams</span></a></span><span>
</span><span id="line-829"></span><span>
</span><span id="line-830"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#safeArityType"><span class="hs-identifier hs-type">safeArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span>
</span><span id="line-831"></span><span class="hs-comment">-- ^ Assuming this ArityType is all we know, find the arity of</span><span>
</span><span id="line-832"></span><span class="hs-comment">-- the function, and trim the argument info (and Divergence)</span><span>
</span><span id="line-833"></span><span class="hs-comment">-- to match that arity. See Note [SafeArityType]</span><span>
</span><span id="line-834"></span><span id="safeArityType"><span class="annot"><span class="annottext">safeArityType :: SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#safeArityType"><span class="hs-identifier hs-var hs-var">safeArityType</span></a></span></span><span> </span><span id="local-6989586621682707382"><span class="annot"><span class="annottext">at :: SafeArityType
</span><a href="#local-6989586621682707382"><span class="hs-identifier hs-var">at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707383"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707383"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost -&gt; [ATLamInfo] -&gt; Maybe Int
</span><a href="#local-6989586621682707384"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707383"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-836"></span><span>      </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707382"><span class="hs-identifier hs-var">at</span></a></span><span>  </span><span class="hs-comment">-- No trimming needed</span><span>
</span><span id="line-837"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682707385"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707385"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707385"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707383"><span class="hs-identifier hs-var">lams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-838"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-839"></span><span>   </span><span class="annot"><a href="#local-6989586621682707384"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-840"></span><span>   </span><span id="local-6989586621682707384"><span class="annot"><span class="annottext">go :: Int -&gt; Cost -&gt; [ATLamInfo] -&gt; Maybe Int
</span><a href="#local-6989586621682707384"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-841"></span><span>   </span><span class="annot"><a href="#local-6989586621682707384"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707387"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707387"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span id="local-6989586621682707388"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707388"><span class="hs-identifier hs-var">ch1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682707389"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707389"><span class="hs-identifier hs-var">ch2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682707390"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707390"><span class="hs-identifier hs-var">os</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707391"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707391"><span class="hs-identifier hs-var">lams</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707388"><span class="hs-identifier hs-var">ch1</span></a></span><span> </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#addCost"><span class="hs-operator hs-var">`addCost`</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707389"><span class="hs-identifier hs-var">ch2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707390"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-843"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsExpensive"><span class="hs-identifier hs-var">IsExpensive</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707387"><span class="hs-identifier hs-var">ar</span></a></span><span>
</span><span id="line-844"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682707392"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707392"><span class="hs-identifier hs-var">ch</span></a></span></span><span class="hs-special">,</span><span>          </span><span class="annot"><span class="annottext">OneShotInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost -&gt; [ATLamInfo] -&gt; Maybe Int
</span><a href="#local-6989586621682707384"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707387"><span class="hs-identifier hs-var">ar</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707392"><span class="hs-identifier hs-var">ch</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707391"><span class="hs-identifier hs-var">lams</span></a></span><span>
</span><span id="line-845"></span><span>
</span><span id="line-846"></span><span class="hs-keyword">infixl</span><span> </span><span class="hs-number">2</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#trimArityType"><span class="hs-operator hs-type">`trimArityType`</span></a></span><span>
</span><span id="line-847"></span><span>
</span><span id="line-848"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#trimArityType"><span class="hs-identifier hs-type">trimArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-849"></span><span class="hs-comment">-- ^ Trim an arity type so that it has at most the given arity.</span><span>
</span><span id="line-850"></span><span class="hs-comment">-- Any excess 'OneShotInfo's are truncated to 'topDiv', even if</span><span>
</span><span id="line-851"></span><span class="hs-comment">-- they end in 'ABot'.  See Note [Arity trimming]</span><span>
</span><span id="line-852"></span><span id="trimArityType"><span class="annot"><span class="annottext">trimArityType :: Int -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#trimArityType"><span class="hs-identifier hs-var hs-var">trimArityType</span></a></span></span><span> </span><span id="local-6989586621682707394"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707394"><span class="hs-identifier hs-var">max_arity</span></a></span></span><span> </span><span id="local-6989586621682707395"><span class="annot"><span class="annottext">at :: SafeArityType
</span><a href="#local-6989586621682707395"><span class="hs-identifier hs-var">at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707396"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707396"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-853"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707396"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthAtMost"><span class="hs-operator hs-var">`lengthAtMost`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707394"><span class="hs-identifier hs-var">max_arity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707395"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-854"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707394"><span class="hs-identifier hs-var">max_arity</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707396"><span class="hs-identifier hs-var">lams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span class="hs-keyword">data</span><span> </span><span id="ArityOpts"><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityOpts"><span class="hs-identifier hs-var">ArityOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ArityOpts"><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityOpts"><span class="hs-identifier hs-var">ArityOpts</span></a></span></span><span>
</span><span id="line-857"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ao_ped_bot"><span class="annot"><span class="annottext">ArityOpts -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#ao_ped_bot"><span class="hs-identifier hs-var hs-var">ao_ped_bot</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-comment">-- See Note [Dealing with bottom]</span><span>
</span><span id="line-858"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ao_dicts_cheap"><span class="annot"><span class="annottext">ArityOpts -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#ao_dicts_cheap"><span class="hs-identifier hs-var hs-var">ao_dicts_cheap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-comment">-- See Note [Eta expanding through dictionaries]</span><span>
</span><span id="line-859"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-860"></span><span>
</span><span id="line-861"></span><span class="hs-comment">-- | The Arity returned is the number of value args the</span><span>
</span><span id="line-862"></span><span class="hs-comment">-- expression can be applied to without doing much work</span><span>
</span><span id="line-863"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprEtaExpandArity"><span class="hs-identifier hs-type">exprEtaExpandArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityOpts"><span class="hs-identifier hs-type">ArityOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span>
</span><span id="line-864"></span><span class="hs-comment">-- exprEtaExpandArity is used when eta expanding</span><span>
</span><span id="line-865"></span><span class="hs-comment">--      e  ==&gt;  \xy -&gt; e x y</span><span>
</span><span id="line-866"></span><span class="hs-comment">-- Nothing if the expression has arity 0</span><span>
</span><span id="line-867"></span><span id="exprEtaExpandArity"><span class="annot"><span class="annottext">exprEtaExpandArity :: HasDebugCallStack =&gt; ArityOpts -&gt; CoreExpr -&gt; Maybe SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#exprEtaExpandArity"><span class="hs-identifier hs-var hs-var">exprEtaExpandArity</span></a></span></span><span> </span><span id="local-6989586621682707403"><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682707403"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682707404"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707404"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-868"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707405"><span class="hs-identifier hs-var">arity_type</span></a></span><span>
</span><span id="line-869"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe SafeArityType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-870"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-871"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; Maybe SafeArityType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707405"><span class="hs-identifier hs-var">arity_type</span></a></span><span>
</span><span id="line-872"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-873"></span><span>    </span><span id="local-6989586621682707405"><span class="annot"><span class="annottext">arity_type :: SafeArityType
</span><a href="#local-6989586621682707405"><span class="hs-identifier hs-var hs-var">arity_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#safeArityType"><span class="hs-identifier hs-var">safeArityType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityOpts -&gt; Bool -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#findRhsArityEnv"><span class="hs-identifier hs-var">findRhsArityEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682707403"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707404"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-874"></span><span>
</span><span id="line-875"></span><span>
</span><span id="line-876"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   findRhsArity
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-881"></span><span>
</span><span id="line-882"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#findRhsArity"><span class="hs-identifier hs-type">findRhsArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityOpts"><span class="hs-identifier hs-type">ArityOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-883"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-884"></span><span class="hs-comment">-- This implements the fixpoint loop for arity analysis</span><span>
</span><span id="line-885"></span><span class="hs-comment">-- See Note [Arity analysis]</span><span>
</span><span id="line-886"></span><span class="hs-comment">--</span><span>
</span><span id="line-887"></span><span class="hs-comment">-- The Bool is True if the returned arity is greater than (exprArity rhs)</span><span>
</span><span id="line-888"></span><span class="hs-comment">--     so the caller should do eta-expansion</span><span>
</span><span id="line-889"></span><span class="hs-comment">-- That Bool is never True for join points, which are never eta-expanded</span><span>
</span><span id="line-890"></span><span class="hs-comment">--</span><span>
</span><span id="line-891"></span><span class="hs-comment">-- Returns an SafeArityType that is guaranteed trimmed to typeArity of 'bndr'</span><span>
</span><span id="line-892"></span><span class="hs-comment">--         See Note [Arity trimming]</span><span>
</span><span id="line-893"></span><span>
</span><span id="line-894"></span><span id="findRhsArity"><span class="annot"><span class="annottext">findRhsArity :: ArityOpts -&gt; RecFlag -&gt; TyVar -&gt; CoreExpr -&gt; (Bool, SafeArityType)
</span><a href="GHC.Core.Opt.Arity.html#findRhsArity"><span class="hs-identifier hs-var hs-var">findRhsArity</span></a></span></span><span> </span><span id="local-6989586621682707407"><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682707407"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682707408"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682707408"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621682707409"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707409"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682707410"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707410"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-895"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707409"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-896"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707412"><span class="hs-identifier hs-var">join_arity_type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-897"></span><span>    </span><span class="hs-comment">-- False: see Note [Do not eta-expand join points]</span><span>
</span><span id="line-898"></span><span>    </span><span class="hs-comment">-- But do return the correct arity and bottom-ness, because</span><span>
</span><span id="line-899"></span><span>    </span><span class="hs-comment">-- these are used to set the bndr's IdInfo (#15517)</span><span>
</span><span id="line-900"></span><span>    </span><span class="hs-comment">-- Note [Invariants on join points] invariant 2b, in GHC.Core</span><span>
</span><span id="line-901"></span><span>
</span><span id="line-902"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-903"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707413"><span class="hs-identifier hs-var">arity_increased</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707414"><span class="hs-identifier hs-var">non_join_arity_type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-904"></span><span>    </span><span class="hs-comment">-- arity_increased: eta-expand if we'll get more lambdas</span><span>
</span><span id="line-905"></span><span>    </span><span class="hs-comment">-- to the top of the RHS</span><span>
</span><span id="line-906"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-907"></span><span>    </span><span id="local-6989586621682707415"><span class="annot"><span class="annottext">old_arity :: Int
</span><a href="#local-6989586621682707415"><span class="hs-identifier hs-var hs-var">old_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-var">exprArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707410"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-908"></span><span>
</span><span id="line-909"></span><span>    </span><span class="annot"><a href="#local-6989586621682707416"><span class="hs-identifier hs-type">init_env</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-910"></span><span>    </span><span id="local-6989586621682707416"><span class="annot"><span class="annottext">init_env :: ArityEnv
</span><a href="#local-6989586621682707416"><span class="hs-identifier hs-var hs-var">init_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityOpts -&gt; Bool -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#findRhsArityEnv"><span class="hs-identifier hs-var">findRhsArityEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682707407"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707409"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span>
</span><span id="line-912"></span><span>    </span><span class="hs-comment">-- Non-join-points only</span><span>
</span><span id="line-913"></span><span>    </span><span id="local-6989586621682707414"><span class="annot"><span class="annottext">non_join_arity_type :: SafeArityType
</span><a href="#local-6989586621682707414"><span class="hs-identifier hs-var hs-var">non_join_arity_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682707408"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-914"></span><span>                             </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SafeArityType -&gt; SafeArityType
</span><a href="#local-6989586621682707418"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-var">botArityType</span></a></span><span>
</span><span id="line-915"></span><span>                             </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; SafeArityType
</span><a href="#local-6989586621682707420"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707416"><span class="hs-identifier hs-var">init_env</span></a></span><span>
</span><span id="line-916"></span><span>    </span><span id="local-6989586621682707413"><span class="annot"><span class="annottext">arity_increased :: Bool
</span><a href="#local-6989586621682707413"><span class="hs-identifier hs-var hs-var">arity_increased</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier hs-var">arityTypeArity</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707414"><span class="hs-identifier hs-var">non_join_arity_type</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707415"><span class="hs-identifier hs-var">old_arity</span></a></span><span>
</span><span id="line-917"></span><span>
</span><span id="line-918"></span><span>    </span><span class="hs-comment">-- Join-points only</span><span>
</span><span id="line-919"></span><span>    </span><span class="hs-comment">-- See Note [Arity for non-recursive join bindings]</span><span>
</span><span id="line-920"></span><span>    </span><span class="hs-comment">-- and Note [Arity for recursive join bindings]</span><span>
</span><span id="line-921"></span><span>    </span><span id="local-6989586621682707412"><span class="annot"><span class="annottext">join_arity_type :: SafeArityType
</span><a href="#local-6989586621682707412"><span class="hs-identifier hs-var hs-var">join_arity_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621682707408"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-922"></span><span>                         </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SafeArityType -&gt; SafeArityType
</span><a href="#local-6989586621682707418"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-var">botArityType</span></a></span><span>
</span><span id="line-923"></span><span>                         </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#trimArityType"><span class="hs-identifier hs-var">trimArityType</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707422"><span class="hs-identifier hs-var">ty_arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; SafeArityType
CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#cheapArityType"><span class="hs-identifier hs-var">cheapArityType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707410"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-924"></span><span>
</span><span id="line-925"></span><span>    </span><span id="local-6989586621682707422"><span class="annot"><span class="annottext">ty_arity :: Int
</span><a href="#local-6989586621682707422"><span class="hs-identifier hs-var hs-var">ty_arity</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-var">typeArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707409"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-926"></span><span>    </span><span id="local-6989586621682707423"><span class="annot"><span class="annottext">use_call_cards :: [Card]
</span><a href="#local-6989586621682707423"><span class="hs-identifier hs-var hs-var">use_call_cards</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; [Card]
</span><a href="GHC.Core.Opt.Arity.html#useSiteCallCards"><span class="hs-identifier hs-var">useSiteCallCards</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707409"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-927"></span><span>
</span><span id="line-928"></span><span>    </span><span class="annot"><a href="#local-6989586621682707420"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span>
</span><span id="line-929"></span><span>    </span><span id="local-6989586621682707420"><span class="annot"><span class="annottext">step :: ArityEnv -&gt; SafeArityType
</span><a href="#local-6989586621682707420"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621682707425"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707425"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#trimArityType"><span class="hs-identifier hs-var">trimArityType</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707422"><span class="hs-identifier hs-var">ty_arity</span></a></span><span> </span><span class="annot"><span class="annottext">(SafeArityType -&gt; SafeArityType) -&gt; SafeArityType -&gt; SafeArityType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-930"></span><span>               </span><span class="annot"><span class="annottext">SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#safeArityType"><span class="hs-identifier hs-var">safeArityType</span></a></span><span> </span><span class="annot"><span class="annottext">(SafeArityType -&gt; SafeArityType) -&gt; SafeArityType -&gt; SafeArityType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- See Note [Arity invariants for bindings], item (3)</span><span>
</span><span id="line-931"></span><span>               </span><span class="annot"><span class="annottext">ArityEnv -&gt; SafeArityType -&gt; [Card] -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#combineWithCallCards"><span class="hs-identifier hs-var">combineWithCallCards</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707425"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707425"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707410"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707423"><span class="hs-identifier hs-var">use_call_cards</span></a></span><span>
</span><span id="line-932"></span><span>       </span><span class="hs-comment">-- trimArityType: see Note [Trim arity inside the loop]</span><span>
</span><span id="line-933"></span><span>       </span><span class="hs-comment">-- combineWithCallCards: take account of the demand on the</span><span>
</span><span id="line-934"></span><span>       </span><span class="hs-comment">-- binder.  Perhaps it is always called with 2 args</span><span>
</span><span id="line-935"></span><span>       </span><span class="hs-comment">--   let f = \x. blah in (f 3 4, f 1 9)</span><span>
</span><span id="line-936"></span><span>       </span><span class="hs-comment">-- f's demand-info says how many args it is called with</span><span>
</span><span id="line-937"></span><span>
</span><span id="line-938"></span><span>    </span><span class="hs-comment">-- The fixpoint iteration (go), done for recursive bindings. We</span><span>
</span><span id="line-939"></span><span>    </span><span class="hs-comment">-- always do one step, but usually that produces a result equal</span><span>
</span><span id="line-940"></span><span>    </span><span class="hs-comment">-- to old_arity, and then we stop right away, because old_arity</span><span>
</span><span id="line-941"></span><span>    </span><span class="hs-comment">-- is assumed to be sound. In other words, arities should never</span><span>
</span><span id="line-942"></span><span>    </span><span class="hs-comment">-- decrease.  Result: the common case is that there is just one</span><span>
</span><span id="line-943"></span><span>    </span><span class="hs-comment">-- iteration</span><span>
</span><span id="line-944"></span><span>    </span><span class="annot"><a href="#local-6989586621682707418"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span>
</span><span id="line-945"></span><span>    </span><span id="local-6989586621682707418"><span class="annot"><span class="annottext">go :: Int -&gt; SafeArityType -&gt; SafeArityType
</span><a href="#local-6989586621682707418"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682707427"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707427"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682707428"><span class="annot"><span class="annottext">cur_at :: SafeArityType
</span><a href="#local-6989586621682707428"><span class="hs-identifier hs-var">cur_at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707429"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707429"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span id="local-6989586621682707430"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707430"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-946"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707430"><span class="hs-identifier hs-var">div</span></a></span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- the &quot;stop right away&quot; case</span><span>
</span><span id="line-947"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707429"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707415"><span class="hs-identifier hs-var">old_arity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707428"><span class="hs-identifier hs-var">cur_at</span></a></span><span> </span><span class="hs-comment">-- from above</span><span>
</span><span id="line-948"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707432"><span class="hs-identifier hs-var">next_at</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; SafeArityType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707428"><span class="hs-identifier hs-var">cur_at</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707428"><span class="hs-identifier hs-var">cur_at</span></a></span><span>
</span><span id="line-949"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-950"></span><span>         </span><span class="hs-comment">-- Warn if more than 2 iterations. Why 2? See Note [Exciting arity]</span><span>
</span><span id="line-951"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; SafeArityType -&gt; SafeArityType
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707427"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-952"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Exciting arity&quot;</span></span><span>
</span><span id="line-953"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707409"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707428"><span class="hs-identifier hs-var">cur_at</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707432"><span class="hs-identifier hs-var">next_at</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707410"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SafeArityType -&gt; SafeArityType) -&gt; SafeArityType -&gt; SafeArityType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-954"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; SafeArityType -&gt; SafeArityType
</span><a href="#local-6989586621682707418"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707427"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707432"><span class="hs-identifier hs-var">next_at</span></a></span><span>
</span><span id="line-955"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-956"></span><span>        </span><span id="local-6989586621682707432"><span class="annot"><span class="annottext">next_at :: SafeArityType
</span><a href="#local-6989586621682707432"><span class="hs-identifier hs-var hs-var">next_at</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; SafeArityType
</span><a href="#local-6989586621682707420"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; SafeArityType -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707416"><span class="hs-identifier hs-var">init_env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707409"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707428"><span class="hs-identifier hs-var">cur_at</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#combineWithCallCards"><span class="hs-identifier hs-type">combineWithCallCards</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Card"><span class="hs-identifier hs-type">Card</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-959"></span><span class="hs-comment">-- See Note [Combining arity type with demand info]</span><span>
</span><span id="line-960"></span><span id="combineWithCallCards"><span class="annot"><span class="annottext">combineWithCallCards :: ArityEnv -&gt; SafeArityType -&gt; [Card] -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#combineWithCallCards"><span class="hs-identifier hs-var hs-var">combineWithCallCards</span></a></span></span><span> </span><span id="local-6989586621682707439"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707439"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682707440"><span class="annot"><span class="annottext">at :: SafeArityType
</span><a href="#local-6989586621682707440"><span class="hs-identifier hs-var">at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707441"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707441"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span id="local-6989586621682707442"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707442"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707443"><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707443"><span class="hs-identifier hs-var">cards</span></a></span></span><span>
</span><span id="line-961"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707441"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707440"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-962"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; [OneShotInfo] -&gt; [ATLamInfo]
</span><a href="#local-6989586621682707444"><span class="hs-identifier hs-var">zip_lams</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707441"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707445"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707442"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-963"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-964"></span><span>    </span><span id="local-6989586621682707445"><span class="annot"><span class="annottext">oss :: [OneShotInfo]
</span><a href="#local-6989586621682707445"><span class="hs-identifier hs-var hs-var">oss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Card -&gt; OneShotInfo) -&gt; [Card] -&gt; [OneShotInfo]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Card -&gt; OneShotInfo
</span><a href="#local-6989586621682707446"><span class="hs-identifier hs-var">card_to_oneshot</span></a></span><span> </span><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707443"><span class="hs-identifier hs-var">cards</span></a></span><span>
</span><span id="line-965"></span><span>    </span><span id="local-6989586621682707446"><span class="annot"><span class="annottext">card_to_oneshot :: Card -&gt; OneShotInfo
</span><a href="#local-6989586621682707446"><span class="hs-identifier hs-var hs-var">card_to_oneshot</span></a></span></span><span> </span><span id="local-6989586621682707447"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682707447"><span class="hs-identifier hs-var">n</span></a></span></span><span>
</span><span id="line-966"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Card -&gt; Bool
</span><a href="GHC.Types.Demand.html#isAtMostOnce"><span class="hs-identifier hs-var">isAtMostOnce</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682707447"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#pedanticBottoms"><span class="hs-identifier hs-var">pedanticBottoms</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707439"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span>         </span><span class="hs-comment">-- Take care for -fpedantic-bottoms;</span><span>
</span><span id="line-968"></span><span>         </span><span class="hs-comment">-- see Note [Combining arity type with demand info], Wrinkle (CAD1)</span><span>
</span><span id="line-969"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span>
</span><span id="line-970"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682707447"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Card -&gt; Card -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="GHC.Types.Demand.html#C_11"><span class="hs-identifier hs-var">C_11</span></a></span><span>
</span><span id="line-971"></span><span>         </span><span class="hs-comment">-- Safe to eta-expand even in the presence of -fpedantic-bottoms</span><span>
</span><span id="line-972"></span><span>         </span><span class="hs-comment">-- see Note [Combining arity type with demand info], Wrinkle (CAD1)</span><span>
</span><span id="line-973"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span>
</span><span id="line-974"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-975"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span>
</span><span id="line-976"></span><span>    </span><span class="annot"><a href="#local-6989586621682707444"><span class="hs-identifier hs-type">zip_lams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ATLamInfo"><span class="hs-identifier hs-type">ATLamInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ATLamInfo"><span class="hs-identifier hs-type">ATLamInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-977"></span><span>    </span><span id="local-6989586621682707444"><span class="annot"><span class="annottext">zip_lams :: [ATLamInfo] -&gt; [OneShotInfo] -&gt; [ATLamInfo]
</span><a href="#local-6989586621682707444"><span class="hs-identifier hs-var hs-var">zip_lams</span></a></span></span><span> </span><span id="local-6989586621682707451"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707451"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707451"><span class="hs-identifier hs-var">lams</span></a></span><span>
</span><span id="line-978"></span><span>    </span><span class="annot"><a href="#local-6989586621682707444"><span class="hs-identifier hs-var">zip_lams</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span id="local-6989586621682707452"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707452"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707442"><span class="hs-identifier hs-var">div</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-979"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsExpensive"><span class="hs-identifier hs-var">IsExpensive</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-980"></span><span>                                           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(OneShotInfo -&gt; Bool) -&gt; [OneShotInfo] -&gt; [OneShotInfo]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">takeWhile</span></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOneShotInfo"><span class="hs-identifier hs-var">isOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707452"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-981"></span><span>    </span><span class="annot"><a href="#local-6989586621682707444"><span class="hs-identifier hs-var">zip_lams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682707455"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707455"><span class="hs-identifier hs-var">ch</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682707456"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707456"><span class="hs-identifier hs-var">os1</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707457"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707457"><span class="hs-identifier hs-var">lams</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707458"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707458"><span class="hs-identifier hs-var">os2</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707459"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707459"><span class="hs-identifier hs-var">oss</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-982"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707455"><span class="hs-identifier hs-var">ch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707456"><span class="hs-identifier hs-var">os1</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; OneShotInfo -&gt; OneShotInfo
</span><a href="GHC.Types.Basic.html#bestOneShot"><span class="hs-operator hs-var">`bestOneShot`</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707458"><span class="hs-identifier hs-var">os2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ATLamInfo -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; [OneShotInfo] -&gt; [ATLamInfo]
</span><a href="#local-6989586621682707444"><span class="hs-identifier hs-var">zip_lams</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707457"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707459"><span class="hs-identifier hs-var">oss</span></a></span><span>
</span><span id="line-983"></span><span>
</span><span id="line-984"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#useSiteCallCards"><span class="hs-identifier hs-type">useSiteCallCards</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Card"><span class="hs-identifier hs-type">Card</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-985"></span><span id="useSiteCallCards"><span class="annot"><span class="annottext">useSiteCallCards :: TyVar -&gt; [Card]
</span><a href="GHC.Core.Opt.Arity.html#useSiteCallCards"><span class="hs-identifier hs-var hs-var">useSiteCallCards</span></a></span></span><span> </span><span id="local-6989586621682707461"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707461"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-986"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707462"><span class="hs-identifier hs-var">call_arity_one_shots</span></a></span><span> </span><span class="annot"><span class="annottext">[Card] -&gt; [Card] -&gt; [Card]
</span><a href="#local-6989586621682707463"><span class="hs-operator hs-var">`zip_cards`</span></a></span><span> </span><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707464"><span class="hs-identifier hs-var">dmd_one_shots</span></a></span><span>
</span><span id="line-987"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-988"></span><span>    </span><span class="annot"><a href="#local-6989586621682707462"><span class="hs-identifier hs-type">call_arity_one_shots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Card"><span class="hs-identifier hs-type">Card</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-989"></span><span>    </span><span id="local-6989586621682707462"><span class="annot"><span class="annottext">call_arity_one_shots :: [Card]
</span><a href="#local-6989586621682707462"><span class="hs-identifier hs-var hs-var">call_arity_one_shots</span></a></span></span><span>
</span><span id="line-990"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707465"><span class="hs-identifier hs-var">call_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-991"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="GHC.Types.Demand.html#C_0N"><span class="hs-identifier hs-var">C_0N</span></a></span><span> </span><span class="annot"><span class="annottext">Card -&gt; [Card] -&gt; [Card]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Card -&gt; [Card]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707465"><span class="hs-identifier hs-var">call_arity</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="GHC.Types.Demand.html#C_01"><span class="hs-identifier hs-var">C_01</span></a></span><span>
</span><span id="line-992"></span><span>    </span><span class="hs-comment">-- Call Arity analysis says /however often the function is called/, it is</span><span>
</span><span id="line-993"></span><span>    </span><span class="hs-comment">-- always applied to this many arguments.</span><span>
</span><span id="line-994"></span><span>    </span><span class="hs-comment">-- The first C_0N is because of the &quot;however often it is called&quot; part.</span><span>
</span><span id="line-995"></span><span>    </span><span class="hs-comment">-- Thus if Call Arity says &quot;always applied to 3 args&quot; then the one-shot info</span><span>
</span><span id="line-996"></span><span>    </span><span class="hs-comment">-- we get is [C_0N, C_01, C_01]</span><span>
</span><span id="line-997"></span><span>    </span><span id="local-6989586621682707465"><span class="annot"><span class="annottext">call_arity :: Int
</span><a href="#local-6989586621682707465"><span class="hs-identifier hs-var hs-var">call_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Int
</span><a href="GHC.Types.Id.html#idCallArity"><span class="hs-identifier hs-var">idCallArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707461"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-998"></span><span>
</span><span id="line-999"></span><span>    </span><span class="annot"><a href="#local-6989586621682707464"><span class="hs-identifier hs-type">dmd_one_shots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Card"><span class="hs-identifier hs-type">Card</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1000"></span><span>    </span><span class="hs-comment">-- If the demand info is C(x,C(1,C(1,.))) then we know that an</span><span>
</span><span id="line-1001"></span><span>    </span><span class="hs-comment">-- application to one arg is also an application to three</span><span>
</span><span id="line-1002"></span><span>    </span><span id="local-6989586621682707464"><span class="annot"><span class="annottext">dmd_one_shots :: [Card]
</span><a href="#local-6989586621682707464"><span class="hs-identifier hs-var hs-var">dmd_one_shots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707461"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1003"></span><span>      </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#AbsDmd"><span class="hs-identifier hs-var">AbsDmd</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- There is no use in eta expanding</span><span>
</span><span id="line-1004"></span><span>      </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#BotDmd"><span class="hs-identifier hs-var">BotDmd</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- when the binding could be dropped instead</span><span>
</span><span id="line-1005"></span><span>      </span><span class="annot"><span class="annottext">Card
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span id="local-6989586621682707474"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682707474"><span class="hs-identifier hs-var">sd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubDemand -&gt; [Card]
</span><a href="GHC.Types.Demand.html#callCards"><span class="hs-identifier hs-var">callCards</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682707474"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1006"></span><span>
</span><span id="line-1007"></span><span>    </span><span class="hs-comment">-- Take the *longer* list</span><span>
</span><span id="line-1008"></span><span>    </span><span id="local-6989586621682707463"><span class="annot"><span class="annottext">zip_cards :: [Card] -&gt; [Card] -&gt; [Card]
</span><a href="#local-6989586621682707463"><span class="hs-identifier hs-var hs-var">zip_cards</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707476"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682707476"><span class="hs-identifier hs-var">n1</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707477"><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707477"><span class="hs-identifier hs-var">ns1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707478"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682707478"><span class="hs-identifier hs-var">n2</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707479"><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707479"><span class="hs-identifier hs-var">ns2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682707476"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="annot"><span class="annottext">Card -&gt; Card -&gt; Card
</span><a href="GHC.Types.Demand.html#glbCard"><span class="hs-operator hs-var">`glbCard`</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682707478"><span class="hs-identifier hs-var">n2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Card -&gt; [Card] -&gt; [Card]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Card] -&gt; [Card] -&gt; [Card]
</span><a href="#local-6989586621682707463"><span class="hs-identifier hs-var">zip_cards</span></a></span><span> </span><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707477"><span class="hs-identifier hs-var">ns1</span></a></span><span> </span><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707479"><span class="hs-identifier hs-var">ns2</span></a></span><span>
</span><span id="line-1009"></span><span>    </span><span class="annot"><a href="#local-6989586621682707463"><span class="hs-identifier hs-var">zip_cards</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span id="local-6989586621682707481"><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707481"><span class="hs-identifier hs-var">ns2</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707481"><span class="hs-identifier hs-var">ns2</span></a></span><span>
</span><span id="line-1010"></span><span>    </span><span class="annot"><a href="#local-6989586621682707463"><span class="hs-identifier hs-var">zip_cards</span></a></span><span> </span><span id="local-6989586621682707482"><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707482"><span class="hs-identifier hs-var">ns1</span></a></span></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Card]
</span><a href="#local-6989586621682707482"><span class="hs-identifier hs-var">ns1</span></a></span><span>
</span><span id="line-1011"></span><span>
</span><span id="line-1012"></span><span class="hs-comment">{- Note [Arity analysis]
~~~~~~~~~~~~~~~~~~~~~~~~
The motivating example for arity analysis is this:

  f = \x. let g = f (x+1)
          in \y. ...g...

What arity does f have?  Really it should have arity 2, but a naive
look at the RHS won't see that.  You need a fixpoint analysis which
says it has arity &quot;infinity&quot; the first time round.

This example happens a lot; it first showed up in Andy Gill's thesis,
fifteen years ago!  It also shows up in the code for 'rnf' on lists
in #4138.

We do the necessary, quite simple fixed-point iteration in 'findRhsArity',
which assumes for a single binding 'ABot' on the first run and iterates
until it finds a stable arity type. Two wrinkles

* We often have to ask (see the Case or Let case of 'arityType') whether some
  expression is cheap. In the case of an application, that depends on the arity
  of the application head! That's why we have our own version of 'exprIsCheap',
  'myExprIsCheap', that will integrate the optimistic arity types we have on
  f and g into the cheapness check.

* Consider this (#18793)

    go = \ds. case ds of
           []     -&gt; id
           (x:ys) -&gt; let acc = go ys in
                     case blah of
                       True  -&gt; acc
                       False -&gt; \ x1 -&gt; acc (negate x1)

  We must propagate go's optimistically large arity to @acc@, so that the
  tail call to @acc@ in the True branch has sufficient arity.  This is done
  by the 'am_sigs' field in 'FindRhsArity', and 'lookupSigEnv' in the Var case
  of 'arityType'.

Note [Exciting arity]
~~~~~~~~~~~~~~~~~~~~~
The fixed-point iteration in 'findRhsArity' stabilises very quickly in almost
all cases. To get notified of cases where we need an usual number of iterations,
we emit a warning in debug mode, so that we can investigate and make sure that
we really can't do better. It's a gross hack, but catches real bugs (#18870).

Now, which number is &quot;unusual&quot;? We pick n &gt; 2. Here's a pretty common and
expected example that takes two iterations and would ruin the specificity
of the warning (from T18937):

  f :: [Int] -&gt; Int -&gt; Int
  f []     = id
  f (x:xs) = let y = sum [0..x]
             in \z -&gt; f xs (y + z)

Fixed-point iteration starts with arity type &#8869; for f. After the first
iteration, we get arity type \??.T, e.g. arity 2, because we unconditionally
'floatIn' the let-binding (see its bottom case).  After the second iteration,
we get arity type \?.T, e.g. arity 1, because now we are no longer allowed
to floatIn the non-cheap let-binding.  Which is all perfectly benign, but
means we do two iterations (well, actually 3 'step's to detect we are stable)
and don't want to emit the warning.

Note [Trim arity inside the loop]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here's an example (from gadt/nbe.hs) which caused trouble.
  data Exp g t where
     Lam :: Ty a -&gt; Exp (g,a) b -&gt; Exp g (a-&gt;b)

  eval :: Exp g t -&gt; g -&gt; t
  eval (Lam _ e) g = \a -&gt; eval e (g,a)

The danger is that we get arity 3 from analysing this; and the
next time arity 4, and so on for ever.  Solution: use trimArityType
on each iteration.

Note [Combining arity type with demand info]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   let f = \x. let y = &lt;expensive&gt; in \p \q{os}. blah
   in ...(f a b)...(f c d)...

* From the RHS we get an ArityType like
    AT [ (IsCheap,?), (IsExpensive,?), (IsCheap,OneShotLam) ] Dunno
  where &quot;?&quot; means NoOneShotInfo

* From the body, the demand analyser (or Call Arity) will tell us
  that the function is always applied to at least two arguments.

Combining these two pieces of info, we can get the final ArityType
    AT [ (IsCheap,?), (IsExpensive,OneShotLam), (IsCheap,OneShotLam) ] Dunno
result: arity=3, which is better than we could do from either
source alone.

The &quot;combining&quot; part is done by combineWithCallCards.  It
uses info from both Call Arity and demand analysis.

We may have /more/ call demands from the calls than we have lambdas
in the binding.  E.g.
    let f1 = \x. g x x in ...(f1 p q r)...
    -- Demand on f1 is C(x,C(1,C(1,L)))

    let f2 = \y. error y in ...(f2 p q r)...
    -- Demand on f2 is C(x,C(1,C(1,L)))

In both these cases we can eta expand f1 and f2 to arity 3.
But /only/ for called-once demands.  Suppose we had
    let f1 = \y. g x x in ...let h = f1 p q in ...(h r1)...(h r2)...

Now we don't want to eta-expand f1 to have 3 args; only two.
Nor, in the case of f2, do we want to push that error call under
a lambda.  Hence the takeWhile in combineWithDemandDoneShots.

Wrinkles:

(CAD1) #24296 exposed a subtle interaction with -fpedantic-bottoms
  (See Note [Dealing with bottom]). Consider

    let f = \x y. error &quot;blah&quot; in
    f 2 1 `seq` Just (f 3 2 1)
      -- Demand on f is C(x,C(1,C(M,L)))

  Usually, it is OK to consider a lambda that is called *at most* once (so call
  cardinality C_01, abbreviated M) a one-shot lambda and eta-expand over it.
  But with -fpedantic-bottoms that is no longer true: If we were to eta-expand
  f to arity 3, we'd discard the error raised when evaluating `f 2 1`.
  Hence in the presence of -fpedantic-bottoms, we must have C_11 for
  eta-expansion.

Note [Do not eta-expand join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Similarly to CPR (see Note [Don't w/w join points for CPR] in
GHC.Core.Opt.WorkWrap), a join point stands well to gain from its outer binding's
eta-expansion, and eta-expanding a join point is fraught with issues like how to
deal with a cast:

    let join $j1 :: IO ()
             $j1 = ...
             $j2 :: Int -&gt; IO ()
             $j2 n = if n &gt; 0 then $j1
                              else ...

    =&gt;

    let join $j1 :: IO ()
             $j1 = (\eta -&gt; ...)
                     `cast` N:IO :: State# RealWorld -&gt; (# State# RealWorld, ())
                                 ~  IO ()
             $j2 :: Int -&gt; IO ()
             $j2 n = (\eta -&gt; if n &gt; 0 then $j1
                                       else ...)
                     `cast` N:IO :: State# RealWorld -&gt; (# State# RealWorld, ())
                                 ~  IO ()

The cast here can't be pushed inside the lambda (since it's not casting to a
function type), so the lambda has to stay, but it can't because it contains a
reference to a join point. In fact, $j2 can't be eta-expanded at all. Rather
than try and detect this situation (and whatever other situations crop up!), we
don't bother; again, any surrounding eta-expansion will improve these join
points anyway, since an outer cast can *always* be pushed inside. By the time
CorePrep comes around, the code is very likely to look more like this:

    let join $j1 :: State# RealWorld -&gt; (# State# RealWorld, ())
             $j1 = (...) eta
             $j2 :: Int -&gt; State# RealWorld -&gt; (# State# RealWorld, ())
             $j2 = if n &gt; 0 then $j1
                            else (...) eta

Note [Arity for recursive join bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f x = joinrec j 0 = \ a b c -&gt; (a,x,b)
                j n = j (n-1)
        in j 20

Obviously `f` should get arity 4.  But it's a bit tricky:

1. Remember, we don't eta-expand join points; see
   Note [Do not eta-expand join points].

2. But even though we aren't going to eta-expand it, we still want `j` to get
   idArity=4, via the findRhsArity fixpoint.  Then when we are doing findRhsArity
   for `f`, we'll call arityType on f's RHS:
    - At the letrec-binding for `j` we'll whiz up an arity-4 ArityType
      for `j` (See Note [arityType for non-recursive let-bindings]
      in GHC.Core.Opt.Arity)b
    - At the occurrence (j 20) that arity-4 ArityType will leave an arity-3
      result.

3. All this, even though j's /join-arity/ (stored in the JoinId) is 1.
   This is is the Main Reason that we want the idArity to sometimes be
   larger than the join-arity c.f. Note [Invariants on join points] item 2b
   in GHC.Core.

4. Be very careful of things like this (#21755):
     g x = let j 0 = \y -&gt; (x,y)
               j n = expensive n `seq` j (n-1)
           in j x
   Here we do /not/ want eta-expand `g`, lest we duplicate all those
   (expensive n) calls.

   But it's fine: the findRhsArity fixpoint calculation will compute arity-1
   for `j` (not arity 2); and that's just what we want. But we do need that
   fixpoint.

   Historical note: an earlier version of GHC did a hack in which we gave
   join points an ArityType of ABot, but that did not work with this #21755
   case.

5. arityType does not usually expect to encounter free join points;
   see GHC.Core.Opt.Arity Note [No free join points in arityType].
   But consider
          f x = join    j1 y = .... in
                joinrec j2 z = ...j1 y... in
                j2 v

   When doing findRhsArity on `j2` we'll encounter the free `j1`.
   But that is fine, because we aren't going to eta-expand `j2`;
   we just want to know its arity.  So we have a flag am_no_eta,
   switched on when doing findRhsArity on a join point RHS. If
   the flag is on, we allow free join points, but not otherwise.


Note [Arity for non-recursive join bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note [Arity for recursive join bindings] deals with recursive join
bindings. But what about /non-recursive/ones?  If we just call
findRhsArity, it will call arityType.  And that can be expensive when
we have deeply nested join points:
  join j1 x1 = join j2 x2 = join j3 x3 = blah3
                            in blah2
               in blah1
(e.g. test T18698b).

So we call cheapArityType instead.  It's good enough for practical
purposes.

(Side note: maybe we should use cheapArity for the RHS of let bindings
in the main arityType function.)
-}</span><span>
</span><span id="line-1252"></span><span>
</span><span id="line-1253"></span><span>
</span><span id="line-1254"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   arityType
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-1259"></span><span>
</span><span id="line-1260"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityLam"><span class="hs-identifier hs-type">arityLam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1261"></span><span id="arityLam"><span class="annot"><span class="annottext">arityLam :: TyVar -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityLam"><span class="hs-identifier hs-var hs-var">arityLam</span></a></span></span><span> </span><span id="local-6989586621682707483"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707483"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707484"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707484"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621682707485"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707485"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1262"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707486"><span class="hs-identifier hs-var">one_shot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ATLamInfo -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707484"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707485"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-1263"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1264"></span><span>    </span><span id="local-6989586621682707486"><span class="annot"><span class="annottext">one_shot :: OneShotInfo
</span><a href="#local-6989586621682707486"><span class="hs-identifier hs-var hs-var">one_shot</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707485"><span class="hs-identifier hs-var">div</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span>
</span><span id="line-1265"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; OneShotInfo
</span><a href="GHC.Core.Opt.Arity.html#idStateHackOneShotInfo"><span class="hs-identifier hs-var">idStateHackOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707483"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-1266"></span><span>    </span><span class="hs-comment">-- If the body diverges, treat it as one-shot: no point</span><span>
</span><span id="line-1267"></span><span>    </span><span class="hs-comment">-- in floating out, and no penalty for floating in</span><span>
</span><span id="line-1268"></span><span>    </span><span class="hs-comment">-- See Wrinkle [Bottoming functions] in Note [ArityType]</span><span>
</span><span id="line-1269"></span><span>
</span><span id="line-1270"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-type">floatIn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1271"></span><span class="hs-comment">-- We have something like (let x = E in b),</span><span>
</span><span id="line-1272"></span><span class="hs-comment">-- where b has the given arity type.</span><span>
</span><span id="line-1273"></span><span class="hs-comment">-- NB: be as lazy as possible in the Cost-of-E argument;</span><span>
</span><span id="line-1274"></span><span class="hs-comment">--     we can often get away without ever looking at it</span><span>
</span><span id="line-1275"></span><span class="hs-comment">--     See Note [Care with nested expressions]</span><span>
</span><span id="line-1276"></span><span id="floatIn"><span class="annot"><span class="annottext">floatIn :: Cost -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-var hs-var">floatIn</span></a></span></span><span> </span><span id="local-6989586621682707488"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707488"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621682707489"><span class="annot"><span class="annottext">at :: SafeArityType
</span><a href="#local-6989586621682707489"><span class="hs-identifier hs-var">at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707490"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707490"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span id="local-6989586621682707491"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707491"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1277"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707490"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1278"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707489"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-1279"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsExpensive"><span class="hs-identifier hs-var">IsExpensive</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OneShotInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[ATLamInfo]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707489"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-1280"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621682707492"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707492"><span class="hs-identifier hs-var">os</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707493"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707493"><span class="hs-identifier hs-var">lams</span></a></span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707488"><span class="hs-identifier hs-var">ch</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707492"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">ATLamInfo -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707493"><span class="hs-identifier hs-var">lams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707491"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-1281"></span><span>
</span><span id="line-1282"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#addWork"><span class="hs-identifier hs-type">addWork</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1283"></span><span class="hs-comment">-- Add work to the outermost level of the arity type</span><span>
</span><span id="line-1284"></span><span id="addWork"><span class="annot"><span class="annottext">addWork :: SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#addWork"><span class="hs-identifier hs-var hs-var">addWork</span></a></span></span><span> </span><span id="local-6989586621682707495"><span class="annot"><span class="annottext">at :: SafeArityType
</span><a href="#local-6989586621682707495"><span class="hs-identifier hs-var">at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707496"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707496"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span id="local-6989586621682707497"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707497"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1285"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707496"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1286"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707495"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-1287"></span><span>      </span><span id="local-6989586621682707498"><span class="annot"><span class="annottext">ATLamInfo
</span><a href="#local-6989586621682707498"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707499"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707499"><span class="hs-identifier hs-var">lams'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ATLamInfo -&gt; ATLamInfo
</span><a href="GHC.Core.Opt.Arity.html#add_work"><span class="hs-identifier hs-var">add_work</span></a></span><span> </span><span class="annot"><span class="annottext">ATLamInfo
</span><a href="#local-6989586621682707498"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">ATLamInfo -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707499"><span class="hs-identifier hs-var">lams'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707497"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-1288"></span><span>
</span><span id="line-1289"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#add_work"><span class="hs-identifier hs-type">add_work</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ATLamInfo"><span class="hs-identifier hs-type">ATLamInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ATLamInfo"><span class="hs-identifier hs-type">ATLamInfo</span></a></span><span>
</span><span id="line-1290"></span><span id="add_work"><span class="annot"><span class="annottext">add_work :: ATLamInfo -&gt; ATLamInfo
</span><a href="GHC.Core.Opt.Arity.html#add_work"><span class="hs-identifier hs-var hs-var">add_work</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621682707501"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707501"><span class="hs-identifier hs-var">os</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsExpensive"><span class="hs-identifier hs-var">IsExpensive</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707501"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1291"></span><span>
</span><span id="line-1292"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityApp"><span class="hs-identifier hs-type">arityApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1293"></span><span class="hs-comment">-- Processing (fun arg) where at is the ArityType of fun,</span><span>
</span><span id="line-1294"></span><span class="hs-comment">-- Knock off an argument and behave like 'let'</span><span>
</span><span id="line-1295"></span><span id="arityApp"><span class="annot"><span class="annottext">arityApp :: SafeArityType -&gt; Cost -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityApp"><span class="hs-identifier hs-var hs-var">arityApp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682707503"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707503"><span class="hs-identifier hs-var">ch1</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OneShotInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707504"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707504"><span class="hs-identifier hs-var">oss</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707505"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707505"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707506"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707506"><span class="hs-identifier hs-var">ch2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-var">floatIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707503"><span class="hs-identifier hs-var">ch1</span></a></span><span> </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#addCost"><span class="hs-operator hs-var">`addCost`</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707506"><span class="hs-identifier hs-var">ch2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707504"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707505"><span class="hs-identifier hs-var">div</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1296"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityApp"><span class="hs-identifier hs-var">arityApp</span></a></span><span> </span><span id="local-6989586621682707507"><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707507"><span class="hs-identifier hs-var">at</span></a></span></span><span>                     </span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707507"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-1297"></span><span>
</span><span id="line-1298"></span><span class="hs-comment">-- | Least upper bound in the 'ArityType' lattice.</span><span>
</span><span id="line-1299"></span><span class="hs-comment">-- See the haddocks on 'ArityType' for the lattice.</span><span>
</span><span id="line-1300"></span><span class="hs-comment">--</span><span>
</span><span id="line-1301"></span><span class="hs-comment">-- Used for branches of a @case@.</span><span>
</span><span id="line-1302"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-type">andArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1303"></span><span id="andArityType"><span class="annot"><span class="annottext">andArityType :: ArityEnv -&gt; SafeArityType -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var hs-var">andArityType</span></a></span></span><span> </span><span id="local-6989586621682707509"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707509"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707510"><span class="annot"><span class="annottext">ATLamInfo
</span><a href="#local-6989586621682707510"><span class="hs-identifier hs-var">lam1</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707511"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707511"><span class="hs-identifier hs-var">lams1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707512"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707512"><span class="hs-identifier hs-var">div1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707513"><span class="annot"><span class="annottext">ATLamInfo
</span><a href="#local-6989586621682707513"><span class="hs-identifier hs-var">lam2</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707514"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707514"><span class="hs-identifier hs-var">lams2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707515"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707515"><span class="hs-identifier hs-var">div2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1304"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707516"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707516"><span class="hs-identifier hs-var">lams'</span></a></span></span><span> </span><span id="local-6989586621682707517"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707517"><span class="hs-identifier hs-var">div'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; SafeArityType -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var">andArityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707509"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707511"><span class="hs-identifier hs-var">lams1</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707512"><span class="hs-identifier hs-var">div1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707514"><span class="hs-identifier hs-var">lams2</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707515"><span class="hs-identifier hs-var">div2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1305"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ATLamInfo
</span><a href="#local-6989586621682707510"><span class="hs-identifier hs-var">lam1</span></a></span><span> </span><span class="annot"><span class="annottext">ATLamInfo -&gt; ATLamInfo -&gt; ATLamInfo
</span><a href="#local-6989586621682707518"><span class="hs-operator hs-var">`and_lam`</span></a></span><span> </span><span class="annot"><span class="annottext">ATLamInfo
</span><a href="#local-6989586621682707513"><span class="hs-identifier hs-var">lam2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ATLamInfo -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707516"><span class="hs-identifier hs-var">lams'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707517"><span class="hs-identifier hs-var">div'</span></a></span><span>
</span><span id="line-1306"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1307"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682707519"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707519"><span class="hs-identifier hs-var">ch1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682707520"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707520"><span class="hs-identifier hs-var">os1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707518"><span class="annot"><span class="annottext">and_lam :: ATLamInfo -&gt; ATLamInfo -&gt; ATLamInfo
</span><a href="#local-6989586621682707518"><span class="hs-operator hs-var hs-var">`and_lam`</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707521"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707521"><span class="hs-identifier hs-var">ch2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682707522"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707522"><span class="hs-identifier hs-var">os2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1308"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707519"><span class="hs-identifier hs-var">ch1</span></a></span><span> </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#addCost"><span class="hs-operator hs-var">`addCost`</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707521"><span class="hs-identifier hs-var">ch2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707520"><span class="hs-identifier hs-var">os1</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; OneShotInfo -&gt; OneShotInfo
</span><a href="GHC.Types.Basic.html#bestOneShot"><span class="hs-operator hs-var">`bestOneShot`</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707522"><span class="hs-identifier hs-var">os2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1309"></span><span>        </span><span class="hs-comment">-- bestOneShot: see Note [Combining case branches: optimistic one-shot-ness]</span><span>
</span><span id="line-1310"></span><span>
</span><span id="line-1311"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var">andArityType</span></a></span><span> </span><span id="local-6989586621682707523"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707523"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621682707524"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707524"><span class="hs-identifier hs-var">div1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707525"><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707525"><span class="hs-identifier hs-var">at2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; Divergence -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#andWithTail"><span class="hs-identifier hs-var">andWithTail</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707523"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707524"><span class="hs-identifier hs-var">div1</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707525"><span class="hs-identifier hs-var">at2</span></a></span><span>
</span><span id="line-1312"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var">andArityType</span></a></span><span> </span><span id="local-6989586621682707527"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707527"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682707528"><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707528"><span class="hs-identifier hs-var">at1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621682707529"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707529"><span class="hs-identifier hs-var">div2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; Divergence -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#andWithTail"><span class="hs-identifier hs-var">andWithTail</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707527"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707529"><span class="hs-identifier hs-var">div2</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707528"><span class="hs-identifier hs-var">at1</span></a></span><span>
</span><span id="line-1313"></span><span>
</span><span id="line-1314"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#andWithTail"><span class="hs-identifier hs-type">andWithTail</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Divergence"><span class="hs-identifier hs-type">Divergence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1315"></span><span id="andWithTail"><span class="annot"><span class="annottext">andWithTail :: ArityEnv -&gt; Divergence -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#andWithTail"><span class="hs-identifier hs-var hs-var">andWithTail</span></a></span></span><span> </span><span id="local-6989586621682707530"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707530"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682707531"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707531"><span class="hs-identifier hs-var">div1</span></a></span></span><span> </span><span id="local-6989586621682707532"><span class="annot"><span class="annottext">at2 :: SafeArityType
</span><a href="#local-6989586621682707532"><span class="hs-identifier hs-var">at2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707533"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707533"><span class="hs-identifier hs-var">lams2</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1316"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707531"><span class="hs-identifier hs-var">div1</span></a></span><span>    </span><span class="hs-comment">-- case x of { T -&gt; error; F -&gt; \y.e }</span><span>
</span><span id="line-1317"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707532"><span class="hs-identifier hs-var">at2</span></a></span><span>                  </span><span class="hs-comment">-- See Note</span><span>
</span><span id="line-1318"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#pedanticBottoms"><span class="hs-identifier hs-var">pedanticBottoms</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707530"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">--    [Combining case branches: andWithTail]</span><span>
</span><span id="line-1319"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-1320"></span><span>
</span><span id="line-1321"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- case x of { T -&gt; plusInt &lt;expensive&gt;; F -&gt; \y.e }</span><span>
</span><span id="line-1322"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ATLamInfo -&gt; ATLamInfo) -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ATLamInfo -&gt; ATLamInfo
</span><a href="GHC.Core.Opt.Arity.html#add_work"><span class="hs-identifier hs-var">add_work</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707533"><span class="hs-identifier hs-var">lams2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>    </span><span class="hs-comment">-- We know div1 = topDiv</span><span>
</span><span id="line-1323"></span><span>    </span><span class="hs-comment">-- See Note [Combining case branches: andWithTail]</span><span>
</span><span id="line-1324"></span><span>
</span><span id="line-1325"></span><span class="hs-comment">{- Note [Combining case branches: optimistic one-shot-ness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When combining the ArityTypes for two case branches (with
andArityType) and both ArityTypes have ATLamInfo, then we just combine
their expensive-ness and one-shot info.  The tricky point is when we
have

     case x of True -&gt; \x{one-shot). blah1
               Fale -&gt; \y.           blah2

Since one-shot-ness is about the /consumer/ not the /producer/, we
optimistically assume that if either branch is one-shot, we combine
the best of the two branches, on the (slightly dodgy) basis that if we
know one branch is one-shot, then they all must be.  Surprisingly,
this means that the one-shot arity type is effectively the top element
of the lattice.

Hence the call to `bestOneShot` in `andArityType`.

Here's an example:
  go = \x. let z = go e0
               go2 = \x. case x of
                           True  -&gt; z
                           False -&gt; \s(one-shot). e1
           in go2 x

We *really* want to respect the one-shot annotation provided by the
user and eta-expand go and go2.  In the first fixpoint iteration of
'go' we'll bind 'go' to botArityType (written \.&#8869;, see Note
[ArityType]).  So 'z' will get arityType \.&#8869;; so we end up combining
the True and False branches:

      \.&#8869; `andArityType` \1.T

That gives \1.T (see Note [Combining case branches: andWithTail],
first bullet).  So 'go2' gets an arityType of \(C?)(C1).T, which is
what we want.

Note [Care with nested expressions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    arityType (Just &lt;big-expressions&gt;)
We will take
    arityType Just = AT [(IsCheap,os)] topDiv
and then do
    arityApp (AT [(IsCheap os)] topDiv) (exprCost &lt;big-expression&gt;)
The result will be AT [] topDiv.  It doesn't matter what &lt;big-expresison&gt;
is!  The same is true of
    arityType (let x = &lt;rhs&gt; in &lt;body&gt;)
where the cost of &lt;rhs&gt; doesn't matter unless &lt;body&gt; has a useful
arityType.

TL;DR in `floatIn`, do not to look at the Cost argument until you have to.

I found this when looking at #24471, although I don't think it was really
the main culprit.

Note [Combining case branches: andWithTail]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When combining the ArityTypes for two case branches (with andArityType)
and one side or the other has run out of ATLamInfo; then we get
into `andWithTail`.

* If one branch is guaranteed bottom (isDeadEndDiv), we just take
  the other. Consider   case x of
             True  -&gt; \x.  error &quot;urk&quot;
             False -&gt; \xy. error &quot;urk2&quot;

  Remember: \o1..on.&#8869; means &quot;if you apply to n args, it'll definitely
  diverge&quot;.  So we need \??.&#8869; for the whole thing, the /max/ of both
  arities.

* Otherwise, if pedantic-bottoms is on, we just have to return
  AT [] topDiv.  E.g. if we have
    f x z = case x of True  -&gt; \y. blah
                      False -&gt; z
  then we can't eta-expand, because that would change the behaviour
  of (f False bottom().

* But if pedantic-bottoms is not on, we allow ourselves to push
  `z` under a lambda (much as we allow ourselves to put the `case x`
  under a lambda).  However we know nothing about the expensiveness
  or one-shot-ness of `z`, so we'd better assume it looks like
  (Expensive, NoOneShotInfo) all the way. Remembering
  Note [Combining case branches: optimistic one-shot-ness],
  we just add work to ever ATLamInfo, keeping the one-shot-ness.

Note [Eta expanding through CallStacks]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Just as it's good to eta-expand through dictionaries, so it is good to
do so through CallStacks.  #20103 is a case in point, where we got
  foo :: HasCallStack =&gt; Int -&gt; Int
  foo = \(d::CallStack). let d2 = pushCallStack blah d in
        \(x:Int). blah

We really want to eta-expand this!  #20103 is quite convincing!
We do this regardless of -fdicts-cheap; it's not really a dictionary.

We also want to check both for (IP blah CallStack) and for CallStack itself.
We might have either
   d :: IP blah CallStack    -- Or HasCallStack
   d = (cs-expr :: CallStack) |&gt; (nt-ax :: CallStack ~ IP blah CallStack)
or just
   cs :: CallStack
   cs = cs-expr

Test T20103 is an example of the latter.

Note [Eta expanding through dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the experimental -fdicts-cheap flag is on, we eta-expand through
dictionary bindings.  This improves arities. Thereby, it also
means that full laziness is less prone to floating out the
application of a function to its dictionary arguments, which
can thereby lose opportunities for fusion.  Example:
        foo :: Ord a =&gt; a -&gt; ...
     foo = /\a \(d:Ord a). let d' = ...d... in \(x:a). ....
        -- So foo has arity 1

     f = \x. foo dInt $ bar x

The (foo DInt) is floated out, and makes ineffective a RULE
     foo (bar x) = ...

One could go further and make exprIsCheap reply True to any
dictionary-typed expression, but that's more work.
-}</span><span>
</span><span id="line-1452"></span><span>
</span><span id="line-1453"></span><span class="hs-comment">---------------------------</span><span>
</span><span id="line-1454"></span><span>
</span><span id="line-1455"></span><span class="hs-keyword">data</span><span> </span><span id="ArityEnv"><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-var">ArityEnv</span></a></span></span><span>
</span><span id="line-1456"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="AE"><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-var">AE</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="am_opts"><span class="annot"><span class="annottext">ArityEnv -&gt; ArityOpts
</span><a href="GHC.Core.Opt.Arity.html#am_opts"><span class="hs-identifier hs-var hs-var">am_opts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityOpts"><span class="hs-identifier hs-type">ArityOpts</span></a></span><span>
</span><span id="line-1457"></span><span>
</span><span id="line-1458"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="am_sigs"><span class="annot"><span class="annottext">ArityEnv -&gt; IdEnv SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var hs-var">am_sigs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1459"></span><span>         </span><span class="hs-comment">-- NB `SafeArityType` so we can use this in myIsCheapApp</span><span>
</span><span id="line-1460"></span><span>         </span><span class="hs-comment">-- See Note [Arity analysis] for details about fixed-point iteration.</span><span>
</span><span id="line-1461"></span><span>
</span><span id="line-1462"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="am_free_joins"><span class="annot"><span class="annottext">ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#am_free_joins"><span class="hs-identifier hs-var hs-var">am_free_joins</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>  </span><span class="hs-comment">-- True &lt;=&gt; free join points allowed</span><span>
</span><span id="line-1463"></span><span>         </span><span class="hs-comment">-- Used /only/ to support assertion checks</span><span>
</span><span id="line-1464"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1465"></span><span>
</span><span id="line-1466"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1467"></span><span>  </span><span id="local-6989586621682707552"><span class="annot"><span class="annottext">ppr :: ArityEnv -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_sigs :: ArityEnv -&gt; IdEnv SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682707553"><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707553"><span class="hs-identifier hs-var">sigs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">am_free_joins :: ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#am_free_joins"><span class="hs-identifier hs-var">am_free_joins</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682707554"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707554"><span class="hs-identifier hs-var">free_joins</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1468"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;AE&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;free joins:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707554"><span class="hs-identifier hs-var">free_joins</span></a></span><span>
</span><span id="line-1469"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sigs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707553"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1470"></span><span>
</span><span id="line-1471"></span><span class="annot"><span class="hs-comment">-- | The @ArityEnv@ used by 'findRhsArity'.</span></span><span>
</span><span id="line-1472"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#findRhsArityEnv"><span class="hs-identifier hs-type">findRhsArityEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityOpts"><span class="hs-identifier hs-type">ArityOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-1473"></span><span id="findRhsArityEnv"><span class="annot"><span class="annottext">findRhsArityEnv :: ArityOpts -&gt; Bool -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#findRhsArityEnv"><span class="hs-identifier hs-var hs-var">findRhsArityEnv</span></a></span></span><span> </span><span id="local-6989586621682707557"><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682707557"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682707558"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707558"><span class="hs-identifier hs-var">free_joins</span></a></span></span><span>
</span><span id="line-1474"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_opts :: ArityOpts
</span><a href="GHC.Core.Opt.Arity.html#am_opts"><span class="hs-identifier hs-var">am_opts</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682707557"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-1475"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">am_free_joins :: Bool
</span><a href="GHC.Core.Opt.Arity.html#am_free_joins"><span class="hs-identifier hs-var">am_free_joins</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707558"><span class="hs-identifier hs-var">free_joins</span></a></span><span>
</span><span id="line-1476"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">am_sigs :: IdEnv SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1477"></span><span>
</span><span id="line-1478"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#freeJoinsOK"><span class="hs-identifier hs-type">freeJoinsOK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1479"></span><span id="freeJoinsOK"><span class="annot"><span class="annottext">freeJoinsOK :: ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#freeJoinsOK"><span class="hs-identifier hs-var hs-var">freeJoinsOK</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_free_joins :: ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#am_free_joins"><span class="hs-identifier hs-var">am_free_joins</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682707561"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707561"><span class="hs-identifier hs-var">free_joins</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707561"><span class="hs-identifier hs-var">free_joins</span></a></span><span>
</span><span id="line-1480"></span><span>
</span><span id="line-1481"></span><span class="hs-comment">-- First some internal functions in snake_case for deleting in certain VarEnvs</span><span>
</span><span id="line-1482"></span><span class="hs-comment">-- of the ArityType. Don't call these; call delInScope* instead!</span><span>
</span><span id="line-1483"></span><span>
</span><span id="line-1484"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-type">modifySigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-1485"></span><span id="modifySigEnv"><span class="annot"><span class="annottext">modifySigEnv :: (IdEnv SafeArityType -&gt; IdEnv SafeArityType)
-&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-var hs-var">modifySigEnv</span></a></span></span><span> </span><span id="local-6989586621682707563"><span class="annot"><span class="annottext">IdEnv SafeArityType -&gt; IdEnv SafeArityType
</span><a href="#local-6989586621682707563"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682707564"><span class="annot"><span class="annottext">env :: ArityEnv
</span><a href="#local-6989586621682707564"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_sigs :: ArityEnv -&gt; IdEnv SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682707565"><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707565"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707564"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682707563"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682707565"><span class="hs-identifier hs-type">sigs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1486"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-pragma hs-type">modifySigEnv</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1487"></span><span>
</span><span id="line-1488"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#del_sig_env"><span class="hs-identifier hs-type">del_sig_env</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-comment">-- internal!</span><span>
</span><span id="line-1489"></span><span id="del_sig_env"><span class="annot"><span class="annottext">del_sig_env :: TyVar -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#del_sig_env"><span class="hs-identifier hs-var hs-var">del_sig_env</span></a></span></span><span> </span><span id="local-6989586621682707567"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707567"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IdEnv SafeArityType -&gt; IdEnv SafeArityType)
-&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-var">modifySigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682707568"><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707568"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType -&gt; TyVar -&gt; IdEnv SafeArityType
forall a. VarEnv a -&gt; TyVar -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707568"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707567"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1490"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#del_sig_env"><span class="hs-pragma hs-type">del_sig_env</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1491"></span><span>
</span><span id="line-1492"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#del_sig_env_list"><span class="hs-identifier hs-type">del_sig_env_list</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-comment">-- internal!</span><span>
</span><span id="line-1493"></span><span id="del_sig_env_list"><span class="annot"><span class="annottext">del_sig_env_list :: [TyVar] -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#del_sig_env_list"><span class="hs-identifier hs-var hs-var">del_sig_env_list</span></a></span></span><span> </span><span id="local-6989586621682707571"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707571"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IdEnv SafeArityType -&gt; IdEnv SafeArityType)
-&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-var">modifySigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682707572"><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707572"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType -&gt; [TyVar] -&gt; IdEnv SafeArityType
forall a. VarEnv a -&gt; [TyVar] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707572"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707571"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1494"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#del_sig_env_list"><span class="hs-pragma hs-type">del_sig_env_list</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1495"></span><span>
</span><span id="line-1496"></span><span class="hs-comment">-- end of internal deletion functions</span><span>
</span><span id="line-1497"></span><span>
</span><span id="line-1498"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-type">extendSigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-1499"></span><span id="extendSigEnv"><span class="annot"><span class="annottext">extendSigEnv :: ArityEnv -&gt; TyVar -&gt; SafeArityType -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-var hs-var">extendSigEnv</span></a></span></span><span> </span><span id="local-6989586621682707574"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707574"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682707575"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707575"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682707576"><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707576"><span class="hs-identifier hs-var">ar_ty</span></a></span></span><span>
</span><span id="line-1500"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IdEnv SafeArityType -&gt; IdEnv SafeArityType)
-&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-var">modifySigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682707577"><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707577"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType
-&gt; TyVar -&gt; SafeArityType -&gt; IdEnv SafeArityType
forall a. VarEnv a -&gt; TyVar -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707577"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707575"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707576"><span class="hs-identifier hs-var">ar_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ArityEnv -&gt; ArityEnv) -&gt; ArityEnv -&gt; ArityEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1501"></span><span>    </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707574"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1502"></span><span>
</span><span id="line-1503"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#delInScope"><span class="hs-identifier hs-type">delInScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-1504"></span><span id="delInScope"><span class="annot"><span class="annottext">delInScope :: ArityEnv -&gt; TyVar -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScope"><span class="hs-identifier hs-var hs-var">delInScope</span></a></span></span><span> </span><span id="local-6989586621682707580"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707580"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682707581"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707581"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#del_sig_env"><span class="hs-identifier hs-var">del_sig_env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707581"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707580"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1505"></span><span>
</span><span id="line-1506"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#delInScopeList"><span class="hs-identifier hs-type">delInScopeList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-1507"></span><span id="delInScopeList"><span class="annot"><span class="annottext">delInScopeList :: ArityEnv -&gt; [TyVar] -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScopeList"><span class="hs-identifier hs-var hs-var">delInScopeList</span></a></span></span><span> </span><span id="local-6989586621682707583"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707583"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682707584"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707584"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#del_sig_env_list"><span class="hs-identifier hs-var">del_sig_env_list</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707584"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707583"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1508"></span><span>
</span><span id="line-1509"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#lookupSigEnv"><span class="hs-identifier hs-type">lookupSigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span>
</span><span id="line-1510"></span><span id="lookupSigEnv"><span class="annot"><span class="annottext">lookupSigEnv :: ArityEnv -&gt; TyVar -&gt; Maybe SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#lookupSigEnv"><span class="hs-identifier hs-var hs-var">lookupSigEnv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_sigs :: ArityEnv -&gt; IdEnv SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682707586"><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707586"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707587"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707587"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType -&gt; TyVar -&gt; Maybe SafeArityType
forall a. VarEnv a -&gt; TyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707586"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707587"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-1511"></span><span>
</span><span id="line-1512"></span><span class="hs-comment">-- | Whether the analysis should be pedantic about bottoms.</span><span>
</span><span id="line-1513"></span><span class="hs-comment">-- 'exprBotStrictness_maybe' always is.</span><span>
</span><span id="line-1514"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pedanticBottoms"><span class="hs-identifier hs-type">pedanticBottoms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1515"></span><span id="pedanticBottoms"><span class="annot"><span class="annottext">pedanticBottoms :: ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#pedanticBottoms"><span class="hs-identifier hs-var hs-var">pedanticBottoms</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_opts :: ArityEnv -&gt; ArityOpts
</span><a href="GHC.Core.Opt.Arity.html#am_opts"><span class="hs-identifier hs-var">am_opts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityOpts"><span class="hs-identifier hs-type">ArityOpts</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ao_ped_bot :: ArityOpts -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#ao_ped_bot"><span class="hs-identifier hs-var">ao_ped_bot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682707589"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707589"><span class="hs-identifier hs-var">ped_bot</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707589"><span class="hs-identifier hs-var">ped_bot</span></a></span><span>
</span><span id="line-1516"></span><span>
</span><span id="line-1517"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprCost"><span class="hs-identifier hs-type">exprCost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span>
</span><span id="line-1518"></span><span id="exprCost"><span class="annot"><span class="annottext">exprCost :: ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#exprCost"><span class="hs-identifier hs-var hs-var">exprCost</span></a></span></span><span> </span><span id="local-6989586621682707591"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707591"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682707592"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707592"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682707593"><span class="annot"><span class="annottext">Maybe Type
</span><a href="#local-6989586621682707593"><span class="hs-identifier hs-var">mb_ty</span></a></span></span><span>
</span><span id="line-1519"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-var">myExprIsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707591"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707592"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Type
</span><a href="#local-6989586621682707593"><span class="hs-identifier hs-var">mb_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span>
</span><span id="line-1520"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsExpensive"><span class="hs-identifier hs-var">IsExpensive</span></a></span><span>
</span><span id="line-1521"></span><span>
</span><span id="line-1522"></span><span class="hs-comment">-- | A version of 'exprIsCheap' that considers results from arity analysis</span><span>
</span><span id="line-1523"></span><span class="hs-comment">-- and optionally the expression's type.</span><span>
</span><span id="line-1524"></span><span class="hs-comment">-- Under 'exprBotStrictness_maybe', no expressions are cheap.</span><span>
</span><span id="line-1525"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-type">myExprIsCheap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1526"></span><span id="myExprIsCheap"><span class="annot"><span class="annottext">myExprIsCheap :: ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-var hs-var">myExprIsCheap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_opts :: ArityEnv -&gt; ArityOpts
</span><a href="GHC.Core.Opt.Arity.html#am_opts"><span class="hs-identifier hs-var">am_opts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682707596"><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682707596"><span class="hs-identifier hs-var">opts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">am_sigs :: ArityEnv -&gt; IdEnv SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682707597"><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707597"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707598"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707598"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682707599"><span class="annot"><span class="annottext">Maybe Type
</span><a href="#local-6989586621682707599"><span class="hs-identifier hs-var">mb_ty</span></a></span></span><span>
</span><span id="line-1527"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682707600"><span class="hs-identifier hs-var">cheap_dict</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707602"><span class="hs-identifier hs-var">cheap_fun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707598"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1528"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1529"></span><span>    </span><span id="local-6989586621682707600"><span class="annot"><span class="annottext">cheap_dict :: Bool
</span><a href="#local-6989586621682707600"><span class="hs-identifier hs-var hs-var">cheap_dict</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Type
</span><a href="#local-6989586621682707599"><span class="hs-identifier hs-var">mb_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1530"></span><span>                     </span><span class="annot"><span class="annottext">Maybe Type
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1531"></span><span>                     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682707603"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707603"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityOpts -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#ao_dicts_cheap"><span class="hs-identifier hs-var">ao_dicts_cheap</span></a></span><span> </span><span class="annot"><span class="annottext">ArityOpts
</span><a href="#local-6989586621682707596"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isDictTy"><span class="hs-identifier hs-var">isDictTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707603"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1532"></span><span>                                </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isCallStackPredTy"><span class="hs-identifier hs-var">isCallStackPredTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707603"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isCallStackTy"><span class="hs-identifier hs-var">isCallStackTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707603"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1533"></span><span>        </span><span class="hs-comment">-- See Note [Eta expanding through dictionaries]</span><span>
</span><span id="line-1534"></span><span>        </span><span class="hs-comment">-- See Note [Eta expanding through CallStacks]</span><span>
</span><span id="line-1535"></span><span>
</span><span id="line-1536"></span><span>    </span><span id="local-6989586621682707602"><span class="annot"><span class="annottext">cheap_fun :: CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707602"><span class="hs-identifier hs-var hs-var">cheap_fun</span></a></span></span><span> </span><span id="local-6989586621682707604"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707604"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheapAppFun -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsCheapX"><span class="hs-identifier hs-var">exprIsCheapX</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdEnv SafeArityType -&gt; CheapAppFun
</span><a href="GHC.Core.Opt.Arity.html#myIsCheapApp"><span class="hs-identifier hs-var">myIsCheapApp</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707597"><span class="hs-identifier hs-var">sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707604"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1537"></span><span>
</span><span id="line-1538"></span><span class="hs-comment">-- | A version of 'isCheapApp' that considers results from arity analysis.</span><span>
</span><span id="line-1539"></span><span class="hs-comment">-- See Note [Arity analysis] for what's in the signature environment and why</span><span>
</span><span id="line-1540"></span><span class="hs-comment">-- it's important.</span><span>
</span><span id="line-1541"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#myIsCheapApp"><span class="hs-identifier hs-type">myIsCheapApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#CheapAppFun"><span class="hs-identifier hs-type">CheapAppFun</span></a></span><span>
</span><span id="line-1542"></span><span id="myIsCheapApp"><span class="annot"><span class="annottext">myIsCheapApp :: IdEnv SafeArityType -&gt; CheapAppFun
</span><a href="GHC.Core.Opt.Arity.html#myIsCheapApp"><span class="hs-identifier hs-var hs-var">myIsCheapApp</span></a></span></span><span> </span><span id="local-6989586621682707608"><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707608"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span id="local-6989586621682707609"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707609"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682707610"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707610"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType -&gt; TyVar -&gt; Maybe SafeArityType
forall a. VarEnv a -&gt; TyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv SafeArityType
</span><a href="#local-6989586621682707608"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707609"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1543"></span><span>
</span><span id="line-1544"></span><span>  </span><span class="hs-comment">-- Nothing means not a local function, fall back to regular</span><span>
</span><span id="line-1545"></span><span>  </span><span class="hs-comment">-- 'GHC.Core.Utils.isCheapApp'</span><span>
</span><span id="line-1546"></span><span>  </span><span class="annot"><span class="annottext">Maybe SafeArityType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheapAppFun
</span><a href="GHC.Core.Utils.html#isCheapApp"><span class="hs-identifier hs-var">isCheapApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707609"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707610"><span class="hs-identifier hs-var">n_val_args</span></a></span><span>
</span><span id="line-1547"></span><span>
</span><span id="line-1548"></span><span>  </span><span class="hs-comment">-- `Just at` means local function with `at` as current SafeArityType.</span><span>
</span><span id="line-1549"></span><span>  </span><span class="hs-comment">-- NB the SafeArityType bit: that means we can ignore the cost flags</span><span>
</span><span id="line-1550"></span><span>  </span><span class="hs-comment">--    in 'lams', and just consider the length</span><span>
</span><span id="line-1551"></span><span>  </span><span class="hs-comment">-- Roughly approximate what 'isCheapApp' is doing.</span><span>
</span><span id="line-1552"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621682707611"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707611"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span id="local-6989586621682707612"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707612"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1553"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707612"><span class="hs-identifier hs-var">div</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- See Note [isCheapApp: bottoming functions] in GHC.Core.Utils</span><span>
</span><span id="line-1554"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707610"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- Essentially</span><span>
</span><span id="line-1555"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707610"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707611"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- isWorkFreeApp</span><span>
</span><span id="line-1556"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1557"></span><span>
</span><span id="line-1558"></span><span class="hs-comment">----------------</span><span>
</span><span id="line-1559"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-type">arityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1560"></span><span class="hs-comment">-- Precondition: all the free join points of the expression</span><span>
</span><span id="line-1561"></span><span class="hs-comment">--               are bound by the ArityEnv</span><span>
</span><span id="line-1562"></span><span class="hs-comment">-- See Note [No free join points in arityType]</span><span>
</span><span id="line-1563"></span><span class="hs-comment">--</span><span>
</span><span id="line-1564"></span><span class="hs-comment">-- Returns ArityType, not SafeArityType.  The caller must do</span><span>
</span><span id="line-1565"></span><span class="hs-comment">-- trimArityType if necessary.</span><span>
</span><span id="line-1566"></span><span id="arityType"><span class="annot"><span class="annottext">arityType :: HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var hs-var">arityType</span></a></span></span><span> </span><span id="local-6989586621682707631"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707631"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682707633"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707633"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1567"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682707634"><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707634"><span class="hs-identifier hs-var">at</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; Maybe SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#lookupSigEnv"><span class="hs-identifier hs-var">lookupSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707631"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707633"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-comment">-- Local binding</span><span>
</span><span id="line-1568"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707634"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-1569"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1570"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; SafeArityType -&gt; SafeArityType
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#freeJoinsOK"><span class="hs-identifier hs-var">freeJoinsOK</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707631"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707633"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707633"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SafeArityType -&gt; SafeArityType) -&gt; SafeArityType -&gt; SafeArityType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1571"></span><span>    </span><span class="hs-comment">-- All join-point should be in the ae_sigs</span><span>
</span><span id="line-1572"></span><span>    </span><span class="hs-comment">-- See Note [No free join points in arityType]</span><span>
</span><span id="line-1573"></span><span>    </span><span class="annot"><span class="annottext">TyVar -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier hs-var">idArityType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707633"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1574"></span><span>
</span><span id="line-1575"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621682707636"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707636"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682707637"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707637"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1576"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707636"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707637"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1577"></span><span>
</span><span id="line-1578"></span><span>        </span><span class="hs-comment">-- Lambdas; increase arity</span><span>
</span><span id="line-1579"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621682707638"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707638"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682707639"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707639"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621682707640"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707640"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1580"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707639"><span class="hs-identifier hs-var">x</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityLam"><span class="hs-identifier hs-var">arityLam</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707639"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707641"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707640"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1581"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707641"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707640"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1582"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1583"></span><span>    </span><span id="local-6989586621682707641"><span class="annot"><span class="annottext">env' :: ArityEnv
</span><a href="#local-6989586621682707641"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScope"><span class="hs-identifier hs-var">delInScope</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707638"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707639"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1584"></span><span>
</span><span id="line-1585"></span><span>        </span><span class="hs-comment">-- Applications; decrease arity, except for types</span><span>
</span><span id="line-1586"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621682707642"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707642"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682707644"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707644"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1587"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707642"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707644"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-1588"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621682707646"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707646"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682707647"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707647"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682707648"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707648"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1589"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; Cost -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityApp"><span class="hs-identifier hs-var">arityApp</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707649"><span class="hs-identifier hs-var">fun_at</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707650"><span class="hs-identifier hs-var">arg_cost</span></a></span><span>
</span><span id="line-1590"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-1591"></span><span>     </span><span id="local-6989586621682707649"><span class="annot"><span class="annottext">fun_at :: SafeArityType
</span><a href="#local-6989586621682707649"><span class="hs-identifier hs-var hs-var">fun_at</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707646"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707647"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-1592"></span><span>     </span><span id="local-6989586621682707650"><span class="annot"><span class="annottext">arg_cost :: Cost
</span><a href="#local-6989586621682707650"><span class="hs-identifier hs-var hs-var">arg_cost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#exprCost"><span class="hs-identifier hs-var">exprCost</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707646"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707648"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Type
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1593"></span><span>
</span><span id="line-1594"></span><span>        </span><span class="hs-comment">-- Case/Let; keep arity if either the expression is cheap</span><span>
</span><span id="line-1595"></span><span>        </span><span class="hs-comment">-- or it's a 1-shot lambda</span><span>
</span><span id="line-1596"></span><span>        </span><span class="hs-comment">-- The former is not really right for Haskell</span><span>
</span><span id="line-1597"></span><span>        </span><span class="hs-comment">--      f x = case x of { (a,b) -&gt; \y. e }</span><span>
</span><span id="line-1598"></span><span>        </span><span class="hs-comment">--  ===&gt;</span><span>
</span><span id="line-1599"></span><span>        </span><span class="hs-comment">--      f x y = case x of { (a,b) -&gt; e }</span><span>
</span><span id="line-1600"></span><span>        </span><span class="hs-comment">-- The difference is observable using 'seq'</span><span>
</span><span id="line-1601"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1602"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621682707651"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707651"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682707653"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707653"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682707654"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707654"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682707655"><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707655"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1603"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#exprIsDeadEnd"><span class="hs-identifier hs-var">exprIsDeadEnd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707653"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707655"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1604"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-var">botArityType</span></a></span><span>    </span><span class="hs-comment">-- Do not eta expand. See (1) in Note [Dealing with bottom]</span><span>
</span><span id="line-1605"></span><span>
</span><span id="line-1606"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#pedanticBottoms"><span class="hs-identifier hs-var">pedanticBottoms</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707651"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See (2) in Note [Dealing with bottom]</span><span>
</span><span id="line-1607"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-var">myExprIsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707651"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707653"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707654"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1608"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707656"><span class="hs-identifier hs-var">alts_type</span></a></span><span>
</span><span id="line-1609"></span><span>
</span><span id="line-1610"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprOkForSpeculation"><span class="hs-identifier hs-var">exprOkForSpeculation</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707653"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-1611"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707656"><span class="hs-identifier hs-var">alts_type</span></a></span><span>
</span><span id="line-1612"></span><span>
</span><span id="line-1613"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>            </span><span class="hs-comment">-- In the remaining cases we may not push</span><span>
</span><span id="line-1614"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#addWork"><span class="hs-identifier hs-var">addWork</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707656"><span class="hs-identifier hs-var">alts_type</span></a></span><span>    </span><span class="hs-comment">-- evaluation of the scrutinee in</span><span>
</span><span id="line-1615"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1616"></span><span>    </span><span id="local-6989586621682707658"><span class="annot"><span class="annottext">env' :: ArityEnv
</span><a href="#local-6989586621682707658"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScope"><span class="hs-identifier hs-var">delInScope</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707651"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707654"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1617"></span><span>    </span><span id="local-6989586621682707659"><span class="annot"><span class="annottext">arity_type_alt :: Alt TyVar -&gt; SafeArityType
</span><a href="#local-6989586621682707659"><span class="hs-identifier hs-var hs-var">arity_type_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682707661"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682707661"><span class="hs-identifier hs-var">_con</span></a></span></span><span> </span><span id="local-6989586621682707662"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707662"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682707663"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707663"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; [TyVar] -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScopeList"><span class="hs-identifier hs-var">delInScopeList</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707658"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707662"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707663"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1618"></span><span>    </span><span id="local-6989586621682707656"><span class="annot"><span class="annottext">alts_type :: SafeArityType
</span><a href="#local-6989586621682707656"><span class="hs-identifier hs-var hs-var">alts_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SafeArityType -&gt; SafeArityType -&gt; SafeArityType)
-&gt; [SafeArityType] -&gt; SafeArityType
forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldr1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; SafeArityType -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var">andArityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707651"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Alt TyVar -&gt; SafeArityType) -&gt; [Alt TyVar] -&gt; [SafeArityType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Alt TyVar -&gt; SafeArityType
</span><a href="#local-6989586621682707659"><span class="hs-identifier hs-var">arity_type_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707655"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1619"></span><span>
</span><span id="line-1620"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621682707665"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707665"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682707668"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707668"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682707669"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707669"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707670"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707670"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1621"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [arityType for non-recursive let-bindings]</span><span>
</span><span id="line-1622"></span><span>    </span><span class="annot"><span class="annottext">Cost -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-var">floatIn</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707671"><span class="hs-identifier hs-var">rhs_cost</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707672"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707670"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1623"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1624"></span><span>    </span><span id="local-6989586621682707671"><span class="annot"><span class="annottext">rhs_cost :: Cost
</span><a href="#local-6989586621682707671"><span class="hs-identifier hs-var hs-var">rhs_cost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#exprCost"><span class="hs-identifier hs-var">exprCost</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707665"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707669"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707668"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1625"></span><span>    </span><span id="local-6989586621682707672"><span class="annot"><span class="annottext">env' :: ArityEnv
</span><a href="#local-6989586621682707672"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; SafeArityType -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707665"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707668"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#safeArityType"><span class="hs-identifier hs-var">safeArityType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707665"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707669"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1626"></span><span>
</span><span id="line-1627"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621682707673"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707673"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682707675"><span class="annot"><span class="annottext">[(TyVar, CoreExpr)]
</span><a href="#local-6989586621682707675"><span class="hs-identifier hs-var">prs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707676"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707676"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1628"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [arityType for recursive let-bindings]</span><span>
</span><span id="line-1629"></span><span>    </span><span class="annot"><span class="annottext">Cost -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-var">floatIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((TyVar, CoreExpr) -&gt; Cost) -&gt; [(TyVar, CoreExpr)] -&gt; Cost
forall a. (a -&gt; Cost) -&gt; [a] -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#allCosts"><span class="hs-identifier hs-var">allCosts</span></a></span><span> </span><span class="annot"><span class="annottext">(TyVar, CoreExpr) -&gt; Cost
</span><a href="#local-6989586621682707677"><span class="hs-identifier hs-var">bind_cost</span></a></span><span> </span><span class="annot"><span class="annottext">[(TyVar, CoreExpr)]
</span><a href="#local-6989586621682707675"><span class="hs-identifier hs-var">prs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707678"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707676"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1630"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1631"></span><span>    </span><span id="local-6989586621682707677"><span class="annot"><span class="annottext">bind_cost :: (TyVar, CoreExpr) -&gt; Cost
</span><a href="#local-6989586621682707677"><span class="hs-identifier hs-var hs-var">bind_cost</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707679"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707679"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682707680"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707680"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Cost
</span><a href="GHC.Core.Opt.Arity.html#exprCost"><span class="hs-identifier hs-var">exprCost</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707678"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707680"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707679"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1632"></span><span>    </span><span id="local-6989586621682707678"><span class="annot"><span class="annottext">env' :: ArityEnv
</span><a href="#local-6989586621682707678"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ArityEnv -&gt; (TyVar, CoreExpr) -&gt; ArityEnv)
-&gt; ArityEnv -&gt; [(TyVar, CoreExpr)] -&gt; ArityEnv
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; (TyVar, CoreExpr) -&gt; ArityEnv
</span><a href="#local-6989586621682707682"><span class="hs-identifier hs-var">extend_rec</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707673"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(TyVar, CoreExpr)]
</span><a href="#local-6989586621682707675"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-1633"></span><span>    </span><span class="annot"><a href="#local-6989586621682707682"><span class="hs-identifier hs-type">extend_rec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-1634"></span><span>    </span><span id="local-6989586621682707682"><span class="annot"><span class="annottext">extend_rec :: ArityEnv -&gt; (TyVar, CoreExpr) -&gt; ArityEnv
</span><a href="#local-6989586621682707682"><span class="hs-identifier hs-var hs-var">extend_rec</span></a></span></span><span> </span><span id="local-6989586621682707683"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707683"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707684"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707684"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; SafeArityType -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707683"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707684"><span class="hs-identifier hs-var">b</span></a></span><span>  </span><span class="annot"><span class="annottext">(SafeArityType -&gt; ArityEnv) -&gt; SafeArityType -&gt; ArityEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1635"></span><span>                           </span><span class="annot"><span class="annottext">TyVar -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier hs-var">idArityType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707684"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1636"></span><span>      </span><span class="hs-comment">-- See Note [arityType for recursive let-bindings]</span><span>
</span><span id="line-1637"></span><span>
</span><span id="line-1638"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621682707685"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707685"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682707686"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707686"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682707687"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707687"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1639"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707686"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; SafeArityType
ArityEnv -&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621682707685"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707687"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1640"></span><span>
</span><span id="line-1641"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#topArityType"><span class="hs-identifier hs-var">topArityType</span></a></span><span>
</span><span id="line-1642"></span><span>
</span><span id="line-1643"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-1644"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier hs-type">idArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1645"></span><span id="idArityType"><span class="annot"><span class="annottext">idArityType :: TyVar -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier hs-var hs-var">idArityType</span></a></span></span><span> </span><span id="local-6989586621682707688"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707688"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-1646"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682707689"><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621682707689"><span class="hs-identifier hs-var">strict_sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707688"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1647"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707691"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682707691"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707692"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707692"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; ([Demand], Divergence)
</span><a href="GHC.Types.Demand.html#splitDmdSig"><span class="hs-identifier hs-var">splitDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621682707689"><span class="hs-identifier hs-var">strict_sig</span></a></span><span>
</span><span id="line-1648"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707692"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-1649"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#takeList"><span class="hs-identifier hs-var">takeList</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682707691"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707695"><span class="hs-identifier hs-var">one_shots</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707692"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-1650"></span><span>
</span><span id="line-1651"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Utils.html#isEmptyTy"><span class="hs-identifier hs-var">isEmptyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707697"><span class="hs-identifier hs-var">id_ty</span></a></span><span>
</span><span id="line-1652"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-var">botArityType</span></a></span><span>
</span><span id="line-1653"></span><span>
</span><span id="line-1654"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1655"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [ATLamInfo] -&gt; [ATLamInfo]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707688"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707695"><span class="hs-identifier hs-var">one_shots</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-1656"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1657"></span><span>    </span><span id="local-6989586621682707697"><span class="annot"><span class="annottext">id_ty :: Type
</span><a href="#local-6989586621682707697"><span class="hs-identifier hs-var hs-var">id_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707688"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1658"></span><span>
</span><span id="line-1659"></span><span>    </span><span class="annot"><a href="#local-6989586621682707695"><span class="hs-identifier hs-type">one_shots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- One-shot-ness derived from the type</span><span>
</span><span id="line-1660"></span><span>    </span><span id="local-6989586621682707695"><span class="annot"><span class="annottext">one_shots :: [ATLamInfo]
</span><a href="#local-6989586621682707695"><span class="hs-identifier hs-var hs-var">one_shots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost -&gt; [Cost]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">[Cost] -&gt; [OneShotInfo] -&gt; [ATLamInfo]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.Arity.html#typeOneShots"><span class="hs-identifier hs-var">typeOneShots</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707697"><span class="hs-identifier hs-var">id_ty</span></a></span><span>
</span><span id="line-1661"></span><span>
</span><span id="line-1662"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-1663"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#cheapArityType"><span class="hs-identifier hs-type">cheapArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1664"></span><span class="hs-comment">-- A fast and cheap version of arityType.</span><span>
</span><span id="line-1665"></span><span class="hs-comment">-- Returns an ArityType with IsCheap everywhere</span><span>
</span><span id="line-1666"></span><span class="hs-comment">-- c.f. GHC.Core.Utils.exprIsDeadEnd</span><span>
</span><span id="line-1667"></span><span class="hs-comment">--</span><span>
</span><span id="line-1668"></span><span class="hs-comment">-- /Can/ encounter a free join-point Id; e.g. via the call</span><span>
</span><span id="line-1669"></span><span class="hs-comment">--   in exprBotStrictness_maybe, which is called in lots</span><span>
</span><span id="line-1670"></span><span class="hs-comment">--   of places</span><span>
</span><span id="line-1671"></span><span class="hs-comment">--</span><span>
</span><span id="line-1672"></span><span class="hs-comment">-- Returns ArityType, not SafeArityType.  The caller must do</span><span>
</span><span id="line-1673"></span><span class="hs-comment">-- trimArityType if necessary.</span><span>
</span><span id="line-1674"></span><span id="cheapArityType"><span class="annot"><span class="annottext">cheapArityType :: HasDebugCallStack =&gt; CoreExpr -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#cheapArityType"><span class="hs-identifier hs-var hs-var">cheapArityType</span></a></span></span><span> </span><span id="local-6989586621682707701"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707701"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SafeArityType
</span><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707701"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1675"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1676"></span><span>    </span><span id="local-6989586621682707702"><span class="annot"><span class="annottext">go :: CoreExpr -&gt; SafeArityType
</span><a href="#local-6989586621682707702"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682707704"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707704"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier hs-var">idArityType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707704"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1677"></span><span>    </span><span class="annot"><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682707705"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707705"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SafeArityType
</span><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707705"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1678"></span><span>    </span><span class="annot"><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682707706"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707706"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621682707707"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707707"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707706"><span class="hs-identifier hs-var">x</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; SafeArityType -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#arityLam"><span class="hs-identifier hs-var">arityLam</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707706"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; SafeArityType
</span><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707707"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1679"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SafeArityType
</span><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707707"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1680"></span><span>    </span><span class="annot"><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682707708"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707708"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682707709"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707709"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707709"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SafeArityType
</span><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707708"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1681"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SafeArityType -&gt; SafeArityType
</span><a href="#local-6989586621682707711"><span class="hs-identifier hs-var">arity_app</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707709"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; SafeArityType
</span><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707708"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1682"></span><span>
</span><span id="line-1683"></span><span>    </span><span class="annot"><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682707712"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707712"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682707713"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707713"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707712"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SafeArityType
</span><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707713"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1684"></span><span>
</span><span id="line-1685"></span><span>    </span><span class="hs-comment">-- Null alts: see Note [Empty case alternatives] in GHC.Core</span><span>
</span><span id="line-1686"></span><span>    </span><span class="annot"><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682707714"><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707714"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Alt TyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707714"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-var">botArityType</span></a></span><span>
</span><span id="line-1687"></span><span>
</span><span id="line-1688"></span><span>    </span><span class="hs-comment">-- Give up on let, case.  In particular, unlike arityType,</span><span>
</span><span id="line-1689"></span><span>    </span><span class="hs-comment">-- we make no attempt to look inside let's.</span><span>
</span><span id="line-1690"></span><span>    </span><span class="annot"><a href="#local-6989586621682707702"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#topArityType"><span class="hs-identifier hs-var">topArityType</span></a></span><span>
</span><span id="line-1691"></span><span>
</span><span id="line-1692"></span><span>    </span><span class="hs-comment">-- Specialised version of arityApp; all costs in ArityType are IsCheap</span><span>
</span><span id="line-1693"></span><span>    </span><span class="hs-comment">-- See Note [exprArity for applications]</span><span>
</span><span id="line-1694"></span><span>    </span><span class="hs-comment">-- NB: (1) coercions count as a value argument</span><span>
</span><span id="line-1695"></span><span>    </span><span class="hs-comment">--     (2) we use the super-cheap exprIsTrivial rather than the</span><span>
</span><span id="line-1696"></span><span>    </span><span class="hs-comment">--         more complicated and expensive exprIsCheap</span><span>
</span><span id="line-1697"></span><span>    </span><span id="local-6989586621682707711"><span class="annot"><span class="annottext">arity_app :: CoreExpr -&gt; SafeArityType -&gt; SafeArityType
</span><a href="#local-6989586621682707711"><span class="hs-identifier hs-var hs-var">arity_app</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682707722"><span class="annot"><span class="annottext">at :: SafeArityType
</span><a href="#local-6989586621682707722"><span class="hs-identifier hs-var">at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707722"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-1698"></span><span>    </span><span class="annot"><a href="#local-6989586621682707711"><span class="hs-identifier hs-var">arity_app</span></a></span><span> </span><span id="local-6989586621682707723"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707723"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621682707724"><span class="annot"><span class="annottext">at :: SafeArityType
</span><a href="#local-6989586621682707724"><span class="hs-identifier hs-var">at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682707725"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707725"><span class="hs-identifier hs-var">cost</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OneShotInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707726"><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707726"><span class="hs-identifier hs-var">lams</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707727"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707727"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1699"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621682707725"><span class="hs-identifier hs-var">cost</span></a></span><span> </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="GHC.Core.Opt.Arity.html#IsCheap"><span class="hs-identifier hs-var">IsCheap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SafeArityType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707724"><span class="hs-identifier hs-var">at</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707723"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1700"></span><span>         </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707727"><span class="hs-identifier hs-var">div</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707726"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621682707727"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-1701"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707723"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ATLamInfo] -&gt; Divergence -&gt; SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[ATLamInfo]
</span><a href="#local-6989586621682707726"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-1702"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="GHC.Core.Opt.Arity.html#topArityType"><span class="hs-identifier hs-var">topArityType</span></a></span><span>
</span><span id="line-1703"></span><span>
</span><span id="line-1704"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1705"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-type">exprArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-1706"></span><span class="hs-comment">-- ^ An approximate, even faster, version of 'cheapArityType'</span><span>
</span><span id="line-1707"></span><span class="hs-comment">-- Roughly   exprArity e = arityTypeArity (cheapArityType e)</span><span>
</span><span id="line-1708"></span><span class="hs-comment">-- But it's a bit less clever about bottoms</span><span>
</span><span id="line-1709"></span><span class="hs-comment">--</span><span>
</span><span id="line-1710"></span><span class="hs-comment">-- We do /not/ guarantee that exprArity e &lt;= typeArity e</span><span>
</span><span id="line-1711"></span><span class="hs-comment">-- You may need to do arity trimming after calling exprArity</span><span>
</span><span id="line-1712"></span><span class="hs-comment">-- See Note [Arity trimming]</span><span>
</span><span id="line-1713"></span><span class="hs-comment">-- Reason: if we do arity trimming here we have take exprType</span><span>
</span><span id="line-1714"></span><span class="hs-comment">--         and that can be expensive if there is a large cast</span><span>
</span><span id="line-1715"></span><span id="exprArity"><span class="annot"><span class="annottext">exprArity :: CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-var hs-var">exprArity</span></a></span></span><span> </span><span id="local-6989586621682707729"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707729"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707729"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1716"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1717"></span><span>    </span><span id="local-6989586621682707730"><span class="annot"><span class="annottext">go :: CoreExpr -&gt; Int
</span><a href="#local-6989586621682707730"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682707738"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707738"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707738"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1718"></span><span>    </span><span class="annot"><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682707739"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707739"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621682707740"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707740"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707739"><span class="hs-identifier hs-var">x</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707740"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1719"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707740"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1720"></span><span>    </span><span class="annot"><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682707741"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707741"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682707742"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707742"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707741"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707742"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1721"></span><span>    </span><span class="annot"><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682707743"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707743"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707743"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1722"></span><span>    </span><span class="annot"><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682707744"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707744"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707744"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1723"></span><span>    </span><span class="annot"><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682707745"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707745"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682707746"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707746"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707746"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707745"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`max`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1724"></span><span>        </span><span class="hs-comment">-- See Note [exprArity for applications]</span><span>
</span><span id="line-1725"></span><span>        </span><span class="hs-comment">-- NB: coercions count as a value argument</span><span>
</span><span id="line-1726"></span><span>
</span><span id="line-1727"></span><span>    </span><span class="annot"><a href="#local-6989586621682707730"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1728"></span><span>
</span><span id="line-1729"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-1730"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprIsDeadEnd"><span class="hs-identifier hs-type">exprIsDeadEnd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1731"></span><span class="hs-comment">-- See Note [Bottoming expressions]</span><span>
</span><span id="line-1732"></span><span class="hs-comment">-- This function is, in effect, just a specialised (and hence cheap)</span><span>
</span><span id="line-1733"></span><span class="hs-comment">--    version of cheapArityType:</span><span>
</span><span id="line-1734"></span><span class="hs-comment">--    exprIsDeadEnd e = case cheapArityType e of</span><span>
</span><span id="line-1735"></span><span class="hs-comment">--                         AT lams div -&gt; null lams &amp;&amp; isDeadEndDiv div</span><span>
</span><span id="line-1736"></span><span class="hs-comment">-- See also exprBotStrictness_maybe, which uses cheapArityType</span><span>
</span><span id="line-1737"></span><span id="exprIsDeadEnd"><span class="annot"><span class="annottext">exprIsDeadEnd :: CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#exprIsDeadEnd"><span class="hs-identifier hs-var hs-var">exprIsDeadEnd</span></a></span></span><span> </span><span id="local-6989586621682707748"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707748"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-1738"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707748"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1739"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1740"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1741"></span><span>    </span><span class="hs-comment">-- (go n e) = True &lt;=&gt; expr applied to n value args is bottom</span><span>
</span><span id="line-1742"></span><span>    </span><span id="local-6989586621682707749"><span class="annot"><span class="annottext">go :: Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707749"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1743"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1744"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1745"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707752"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707752"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682707753"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707753"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682707754"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707754"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707754"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707752"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707753"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1746"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707752"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707753"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1747"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707755"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707755"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682707756"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707756"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707755"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707756"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1748"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707757"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707757"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682707758"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707758"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707757"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707758"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1749"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707759"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707759"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Bind TyVar
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682707760"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707760"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707759"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707760"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1750"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707761"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707761"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682707762"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707762"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682707763"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707763"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707762"><span class="hs-identifier hs-var">v</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; Bool
</span><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707761"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707763"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1751"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1752"></span><span>
</span><span id="line-1753"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682707764"><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707764"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt TyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707764"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1754"></span><span>       </span><span class="hs-comment">-- See Note [Empty case alternatives] in GHC.Core</span><span>
</span><span id="line-1755"></span><span>
</span><span id="line-1756"></span><span>    </span><span class="annot"><a href="#local-6989586621682707749"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707765"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707765"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682707766"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707766"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; Int -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndAppSig"><span class="hs-identifier hs-var">isDeadEndAppSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707766"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707765"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1757"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Utils.html#isEmptyTy"><span class="hs-identifier hs-var">isEmptyTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707766"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1758"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1759"></span><span>
</span><span id="line-1760"></span><span class="hs-comment">{- Note [Bottoming expressions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A bottoming expression is guaranteed to diverge, or raise an
exception.  We can test for it in two different ways, and exprIsDeadEnd
checks for both of these situations:

* Visibly-bottom computations.  For example
      (error Int &quot;Hello&quot;)
  is visibly bottom.  The strictness analyser also finds out if
  a function diverges or raises an exception, and puts that info
  in its strictness signature.

* Empty types.  If a type is empty, its only inhabitant is bottom.
  For example:
      data T
      f :: T -&gt; Bool
      f = \(x:t). case x of Bool {}
  Since T has no data constructors, the case alternatives are of course
  empty.  However note that 'x' is not bound to a visibly-bottom value;
  it's the *type* that tells us it's going to diverge.

A GADT may also be empty even though it has constructors:
        data T a where
          T1 :: a -&gt; T Bool
          T2 :: T Int
        ...(case (x::T Char) of {})...
Here (T Char) is uninhabited.  A more realistic case is (Int ~ Bool),
which is likewise uninhabited.

Note [No free join points in arityType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we call arityType on this expression (EX1)
   \x . case x of True  -&gt; \y. e
                  False -&gt; $j 3
where $j is a join point.  It really makes no sense to talk of the arity
of this expression, because it has a free join point.  In particular, we
can't eta-expand the expression because we'd have do the same thing to the
binding of $j, and we can't see that binding.

If we had (EX2)
   \x. join $j y = blah
       case x of True  -&gt; \y. e
                 False -&gt; $j 3
then it would make perfect sense: we can determine $j's ArityType, and
propagate it to the usage site as usual.

But how can we get (EX1)?  It doesn't make much sense, because $j can't
be a join point under the \x anyway.  So we make it a precondition of
arityType that the argument has no free join-point Ids.  (This is checked
with an assert in the Var case of arityType.)

Wrinkles

* We /do/ allow free join point when doing findRhsArity for join-point
  right-hand sides. See Note [Arity for recursive join bindings]
  point (5) in GHC.Core.Opt.Simplify.Utils.

* The invariant (no free join point in arityType) risks being
  invalidated by one very narrow special case: runRW#

   join $j y = blah
   runRW# (\s. case x of True  -&gt; \y. e
                         False -&gt; $j x)

  We have special magic in OccurAnal, and Simplify to allow continuations to
  move into the body of a runRW# call.

  So we are careful never to attempt to eta-expand the (\s.blah) in the
  argument to runRW#, at least not when there is a literal lambda there,
  so that OccurAnal has seen it and allowed join points bound outside.
  See Note [No eta-expansion in runRW#] in GHC.Core.Opt.Simplify.Iteration.

Note [arityType for non-recursive let-bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For non-recursive let-bindings, we just get the arityType of the RHS,
and extend the environment.  That works nicely for things like this
(#18793):
  go = \ ds. case ds_a2CF of {
               []     -&gt; id
               : y ys -&gt; case y of { GHC.Types.I# x -&gt;
                         let acc = go ys in
                         case x &gt;# 42# of {
                            __DEFAULT -&gt; acc
                            1# -&gt; \x1. acc (negate x2)

Here we want to get a good arity for `acc`, based on the ArityType
of `go`.

All this is particularly important for join points. Consider this (#18328)

  f x = join j y = case y of
                      True -&gt; \a. blah
                      False -&gt; \b. blah
        in case x of
              A -&gt; j True
              B -&gt; \c. blah
              C -&gt; j False

and suppose the join point is too big to inline.  Now, what is the
arity of f?  If we inlined the join point, we'd definitely say &quot;arity
2&quot; because we are prepared to push case-scrutinisation inside a
lambda. It's important that we extend the envt with j's ArityType, so
that we can use that information in the A/C branch of the case.

Note [arityType for recursive let-bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For /recursive/ bindings it's more difficult, to call arityType
(as we do in Note [arityType for non-recursive let-bindings])
because we don't have an ArityType to put in the envt for the
recursively bound Ids.  So for we satisfy ourselves with whizzing up
up an ArityType from the idArity of the function, via idArityType.

That is nearly equivalent to deleting the binder from the envt, at
which point we'll call idArityType at the occurrences.  But doing it
here means

  (a) we only call idArityType once, no matter how many
      occurrences, and

  (b) we can check (in the arityType (Var v) case) that
      we don't mention free join-point Ids. See
      Note [No free join points in arityType].

But see Note [Arity for recursive join bindings] in
GHC.Core.Opt.Simplify.Utils for dark corners.
-}</span><span>
</span><span id="line-1886"></span><span>
</span><span id="line-1887"></span><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
              The main eta-expander
%*                                                                      *
%************************************************************************

We go for:
   f = \x1..xn -&gt; N  ==&gt;   f = \x1..xn y1..ym -&gt; N y1..ym
                                 (n &gt;= 0)

where (in both cases)

        * The xi can include type variables

        * The yi are all value variables

        * N is a NORMAL FORM (i.e. no redexes anywhere)
          wanting a suitable number of extra args.

The biggest reason for doing this is for cases like

        f = \x -&gt; case x of
                    True  -&gt; \y -&gt; e1
                    False -&gt; \y -&gt; e2

Here we want to get the lambdas together.  A good example is the nofib
program fibheaps, which gets 25% more allocation if you don't do this
eta-expansion.

We may have to sandwich some coerces between the lambdas
to make the types work.   exprEtaExpandArity looks through coerces
when computing arity; and etaExpand adds the coerces as necessary when
actually computing the expansion.

Note [No crap in eta-expanded code]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The eta expander is careful not to introduce &quot;crap&quot;.  In particular,
given a CoreExpr satisfying the 'CpeRhs' invariant (in CorePrep), it
returns a CoreExpr satisfying the same invariant. See Note [Eta
expansion and the CorePrep invariants] in CorePrep.

This means the eta-expander has to do a bit of on-the-fly
simplification but it's not too hard.  The alternative, of relying on
a subsequent clean-up phase of the Simplifier to de-crapify the result,
means you can't really use it in CorePrep, which is painful.

Note [Eta expansion for join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The no-crap rule is very tiresome to guarantee when
we have join points. Consider eta-expanding
   let j :: Int -&gt; Int -&gt; Bool
       j x = e
   in b

The simple way is
  \(y::Int). (let j x = e in b) y

The no-crap way is
  \(y::Int). let j' :: Int -&gt; Bool
                 j' x = e y
             in b[j'/j] y
where I have written b[j'/j] to stress that j's type has
changed.  Note that (of course!) we have to push the application
inside the RHS of the join as well as into the body.  AND if j
has an unfolding we have to push it into there too.  AND j might
be recursive...

So for now I'm abandoning the no-crap rule in this case, conscious that this
causes the ugly Wrinkle (EA1) of Note [Eta expansion of arguments in CorePrep].

(Moreover, I think that casts can make the no-crap rule fail too.)

Note [Eta expansion and SCCs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note that SCCs are not treated specially by etaExpand.  If we have
        etaExpand 2 (\x -&gt; scc &quot;foo&quot; e)
        = (\xy -&gt; (scc &quot;foo&quot; e) y)
So the costs of evaluating 'e' (not 'e y') are attributed to &quot;foo&quot;

Note [Eta expansion and source notes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CorePrep puts floatable ticks outside of value applications, but not
type applications. As a result we might be trying to eta-expand an
expression like

  (src&lt;...&gt; v) @a

which we want to lead to code like

  \x -&gt; src&lt;...&gt; v @a x

This means that we need to look through type applications and be ready
to re-add floats on the top.

Note [Eta expansion with ArityType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The etaExpandAT function takes an ArityType (not just an Arity) to
guide eta-expansion.  Why? Because we want to preserve one-shot info.
Consider
  foo = \x. case x of
              True  -&gt; (\s{os}. blah) |&gt; co
              False -&gt; wubble
We'll get an ArityType for foo of \?1.T.

Then we want to eta-expand to
  foo = (\x. \eta{os}. (case x of ...as before...) eta) |&gt; some_co

That 'eta' binder is fresh, and we really want it to have the
one-shot flag from the inner \s{os}.  By expanding with the
ArityType gotten from analysing the RHS, we achieve this neatly.

This makes a big difference to the one-shot monad trick;
see Note [The one-shot state monad trick] in GHC.Utils.Monad.
-}</span><span>
</span><span id="line-2002"></span><span>
</span><span id="line-2003"></span><span class="hs-comment">-- | @etaExpand n e@ returns an expression with</span><span>
</span><span id="line-2004"></span><span class="hs-comment">-- the same meaning as @e@, but with arity @n@.</span><span>
</span><span id="line-2005"></span><span class="hs-comment">--</span><span>
</span><span id="line-2006"></span><span class="hs-comment">-- Given:</span><span>
</span><span id="line-2007"></span><span class="hs-comment">--</span><span>
</span><span id="line-2008"></span><span class="hs-comment">-- &gt; e' = etaExpand n e</span><span>
</span><span id="line-2009"></span><span class="hs-comment">--</span><span>
</span><span id="line-2010"></span><span class="hs-comment">-- We should have that:</span><span>
</span><span id="line-2011"></span><span class="hs-comment">--</span><span>
</span><span id="line-2012"></span><span class="hs-comment">-- &gt; ty = exprType e = exprType e'</span><span>
</span><span id="line-2013"></span><span>
</span><span id="line-2014"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpand"><span class="hs-identifier hs-type">etaExpand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2015"></span><span id="etaExpand"><span class="annot"><span class="annottext">etaExpand :: Int -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaExpand"><span class="hs-identifier hs-var hs-var">etaExpand</span></a></span></span><span> </span><span id="local-6989586621682707768"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707768"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682707769"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707769"><span class="hs-identifier hs-var">orig_expr</span></a></span></span><span>
</span><span id="line-2016"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [OneShotInfo] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707771"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; OneShotInfo -&gt; [OneShotInfo]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707768"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707769"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>
</span><span id="line-2017"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2018"></span><span>    </span><span id="local-6989586621682707771"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682707771"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-#SCC</span><span> </span><span class="hs-pragma">&quot;eta_expand:in-scopeX&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-2019"></span><span>               </span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707769"><span class="hs-identifier hs-var">orig_expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2020"></span><span>
</span><span id="line-2021"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier hs-type">etaExpandAT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#SafeArityType"><span class="hs-identifier hs-type">SafeArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2022"></span><span class="hs-comment">-- See Note [Eta expansion with ArityType]</span><span>
</span><span id="line-2023"></span><span class="hs-comment">--</span><span>
</span><span id="line-2024"></span><span class="hs-comment">-- We pass in the InScopeSet from the simplifier to avoid recomputing</span><span>
</span><span id="line-2025"></span><span class="hs-comment">-- it here, which can be jolly expensive if the casts are big</span><span>
</span><span id="line-2026"></span><span class="hs-comment">-- In #18223 it took 10% of compile time just to do the exprFreeVars!</span><span>
</span><span id="line-2027"></span><span id="etaExpandAT"><span class="annot"><span class="annottext">etaExpandAT :: InScopeSet -&gt; SafeArityType -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier hs-var hs-var">etaExpandAT</span></a></span></span><span> </span><span id="local-6989586621682707774"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707774"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682707775"><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707775"><span class="hs-identifier hs-var">at</span></a></span></span><span> </span><span id="local-6989586621682707776"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707776"><span class="hs-identifier hs-var">orig_expr</span></a></span></span><span>
</span><span id="line-2028"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [OneShotInfo] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707774"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SafeArityType -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.Arity.html#arityTypeOneShots"><span class="hs-identifier hs-var">arityTypeOneShots</span></a></span><span> </span><span class="annot"><span class="annottext">SafeArityType
</span><a href="#local-6989586621682707775"><span class="hs-identifier hs-var">at</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707776"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>
</span><span id="line-2029"></span><span>
</span><span id="line-2030"></span><span class="hs-comment">-- etaExpand arity e = res</span><span>
</span><span id="line-2031"></span><span class="hs-comment">-- Then 'res' has at least 'arity' lambdas at the top</span><span>
</span><span id="line-2032"></span><span class="hs-comment">--    possibly with a cast wrapped around the outside</span><span>
</span><span id="line-2033"></span><span class="hs-comment">-- See Note [Eta expansion with ArityType]</span><span>
</span><span id="line-2034"></span><span class="hs-comment">--</span><span>
</span><span id="line-2035"></span><span class="hs-comment">-- etaExpand deals with for-alls. For example:</span><span>
</span><span id="line-2036"></span><span class="hs-comment">--              etaExpand 1 E</span><span>
</span><span id="line-2037"></span><span class="hs-comment">-- where  E :: forall a. a -&gt; a</span><span>
</span><span id="line-2038"></span><span class="hs-comment">-- would return</span><span>
</span><span id="line-2039"></span><span class="hs-comment">--      (/\b. \y::a -&gt; E b y)</span><span>
</span><span id="line-2040"></span><span>
</span><span id="line-2041"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-type">eta_expand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2042"></span><span id="eta_expand"><span class="annot"><span class="annottext">eta_expand :: InScopeSet -&gt; [OneShotInfo] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var hs-var">eta_expand</span></a></span></span><span> </span><span id="local-6989586621682707777"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707777"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682707778"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707778"><span class="hs-identifier hs-var">one_shots</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682707779"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707779"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682707780"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707780"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2043"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; [OneShotInfo] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707777"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707778"><span class="hs-identifier hs-var">one_shots</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707779"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707780"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2044"></span><span>    </span><span class="hs-comment">-- This mkCast is important, because eta_expand might return an</span><span>
</span><span id="line-2045"></span><span>    </span><span class="hs-comment">-- expression with a cast at the outside; and tryCastWorkerWrapper</span><span>
</span><span id="line-2046"></span><span>    </span><span class="hs-comment">-- asssumes that we don't have nested casts. Makes a difference</span><span>
</span><span id="line-2047"></span><span>    </span><span class="hs-comment">-- in compile-time for T18223</span><span>
</span><span id="line-2048"></span><span>
</span><span id="line-2049"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span id="local-6989586621682707782"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707782"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682707783"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707783"><span class="hs-identifier hs-var">one_shots</span></a></span></span><span> </span><span id="local-6989586621682707784"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707784"><span class="hs-identifier hs-var">orig_expr</span></a></span></span><span>
</span><span id="line-2050"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [OneShotInfo] -&gt; [TyVar] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682707785"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707782"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707783"><span class="hs-identifier hs-var">one_shots</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707784"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>
</span><span id="line-2051"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2052"></span><span>      </span><span class="hs-comment">-- Strip off existing lambdas and casts before handing off to mkEtaWW</span><span>
</span><span id="line-2053"></span><span>      </span><span class="hs-comment">-- This is mainly to avoid spending time cloning binders and substituting</span><span>
</span><span id="line-2054"></span><span>      </span><span class="hs-comment">-- when there is actually nothing to do.  It's slightly awkward to deal</span><span>
</span><span id="line-2055"></span><span>      </span><span class="hs-comment">-- with casts here, apart from the topmost one, and they are rare, so</span><span>
</span><span id="line-2056"></span><span>      </span><span class="hs-comment">-- if we find one we just hand off to mkEtaWW anyway</span><span>
</span><span id="line-2057"></span><span>      </span><span class="hs-comment">-- Note [Eta expansion and SCCs]</span><span>
</span><span id="line-2058"></span><span>    </span><span id="local-6989586621682707785"><span class="annot"><span class="annottext">go :: InScopeSet -&gt; [OneShotInfo] -&gt; [TyVar] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682707785"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707784"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>  </span><span class="hs-comment">-- Already has the specified arity; no-op</span><span>
</span><span id="line-2059"></span><span>
</span><span id="line-2060"></span><span>    </span><span class="annot"><a href="#local-6989586621682707785"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707786"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707786"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682707787"><span class="annot"><span class="annottext">oss :: [OneShotInfo]
</span><a href="#local-6989586621682707787"><span class="hs-identifier hs-var">oss</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">OneShotInfo
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707788"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707788"><span class="hs-identifier hs-var">oss1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707789"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707789"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682707790"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707790"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682707791"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707791"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2061"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707790"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [OneShotInfo] -&gt; [TyVar] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682707785"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707786"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TyVar -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707790"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707787"><span class="hs-identifier hs-var">oss</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707790"><span class="hs-identifier hs-var">v</span></a></span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707789"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707791"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2062"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [OneShotInfo] -&gt; [TyVar] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682707785"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707786"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TyVar -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707790"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707788"><span class="hs-identifier hs-var">oss1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707790"><span class="hs-identifier hs-var">v</span></a></span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707789"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707791"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-2063"></span><span>
</span><span id="line-2064"></span><span>    </span><span class="annot"><a href="#local-6989586621682707785"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707793"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707793"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682707794"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707794"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621682707795"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707795"><span class="hs-identifier hs-var">rev_vs</span></a></span></span><span> </span><span id="local-6989586621682707796"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707796"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-2065"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;ee&quot; (vcat [ppr in_scope', ppr top_bndrs, ppr eis]) $</span><span>
</span><span id="line-2066"></span><span>        </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682707797"><span class="hs-identifier hs-var">retick</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2067"></span><span>        </span><span class="annot"><span class="annottext">EtaInfo -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaInfoAbs"><span class="hs-identifier hs-var">etaInfoAbs</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707799"><span class="hs-identifier hs-var">top_eis</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2068"></span><span>        </span><span class="annot"><span class="annottext">InScopeSet -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaInfoApp"><span class="hs-identifier hs-var">etaInfoApp</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707801"><span class="hs-identifier hs-var">in_scope'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707802"><span class="hs-identifier hs-var">sexpr</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707803"><span class="hs-identifier hs-var">eis</span></a></span><span>
</span><span id="line-2069"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2070"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682707801"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707801"><span class="hs-identifier hs-var">in_scope'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707803"><span class="annot"><span class="annottext">eis :: EtaInfo
</span><a href="#local-6989586621682707803"><span class="hs-identifier hs-var">eis</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621682707805"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707805"><span class="hs-identifier hs-var">eta_bndrs</span></a></span></span><span> </span><span id="local-6989586621682707806"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707806"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2071"></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
-&gt; SDoc -&gt; InScopeSet -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="GHC.Core.Opt.Arity.html#mkEtaWW"><span class="hs-identifier hs-var">mkEtaWW</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707794"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707784"><span class="hs-identifier hs-var">orig_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707793"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707796"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2072"></span><span>          </span><span id="local-6989586621682707809"><span class="annot"><span class="annottext">top_bndrs :: [TyVar]
</span><a href="#local-6989586621682707809"><span class="hs-identifier hs-var hs-var">top_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707795"><span class="hs-identifier hs-var">rev_vs</span></a></span><span>
</span><span id="line-2073"></span><span>          </span><span id="local-6989586621682707799"><span class="annot"><span class="annottext">top_eis :: EtaInfo
</span><a href="#local-6989586621682707799"><span class="hs-identifier hs-var hs-var">top_eis</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707809"><span class="hs-identifier hs-var">top_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707805"><span class="hs-identifier hs-var">eta_bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkPiMCos"><span class="hs-identifier hs-var">mkPiMCos</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707809"><span class="hs-identifier hs-var">top_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707806"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2074"></span><span>
</span><span id="line-2075"></span><span>          </span><span class="hs-comment">-- Find ticks behind type apps.</span><span>
</span><span id="line-2076"></span><span>          </span><span class="hs-comment">-- See Note [Eta expansion and source notes]</span><span>
</span><span id="line-2077"></span><span>          </span><span class="hs-comment">-- I don't really understand this code SLPJ May 21</span><span>
</span><span id="line-2078"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682707812"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707812"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707813"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682707813"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; (CoreExpr, [CoreExpr])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707796"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2079"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682707815"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682707815"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707816"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707816"><span class="hs-identifier hs-var">expr''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; CoreExpr -&gt; ([CoreTickish], CoreExpr)
forall b.
(CoreTickish -&gt; Bool) -&gt; Expr b -&gt; ([CoreTickish], Expr b)
</span><a href="GHC.Core.Utils.html#stripTicksTop"><span class="hs-identifier hs-var">stripTicksTop</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707812"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-2080"></span><span>          </span><span id="local-6989586621682707802"><span class="annot"><span class="annottext">sexpr :: CoreExpr
</span><a href="#local-6989586621682707802"><span class="hs-identifier hs-var hs-var">sexpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707816"><span class="hs-identifier hs-var">expr''</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682707813"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2081"></span><span>          </span><span id="local-6989586621682707797"><span class="annot"><span class="annottext">retick :: CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682707797"><span class="hs-identifier hs-var hs-var">retick</span></a></span></span><span> </span><span id="local-6989586621682707820"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707820"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CoreExpr -&gt; CoreExpr)
-&gt; CoreExpr -&gt; [CoreTickish] -&gt; CoreExpr
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707820"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682707815"><span class="hs-identifier hs-var">ticks</span></a></span><span>
</span><span id="line-2082"></span><span>
</span><span id="line-2083"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
              The EtaInfo mechanism
          mkEtaWW, etaInfoAbs, etaInfoApp
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-2089"></span><span>
</span><span id="line-2090"></span><span class="hs-comment">{- Note [The EtaInfo mechanism]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have (e :: ty) and we want to eta-expand it to arity N.
This what eta_expand does.  We do it in two steps:

1.  mkEtaWW: from 'ty' and 'N' build a EtaInfo which describes
    the shape of the expansion necessary to expand to arity N.

2.  Build the term
       \ v1..vn.  e v1 .. vn
    where those abstractions and applications are described by
    the same EtaInfo.  Specifically we build the term

       etaInfoAbs etas (etaInfoApp in_scope e etas)

   where etas :: EtaInfo
         etaInfoAbs builds the lambdas
         etaInfoApp builds the applications

   Note that the /same/ EtaInfo drives both etaInfoAbs and etaInfoApp

To a first approximation EtaInfo is just [Var].  But casts complicate
the question.  If we have
   newtype N a = MkN (S -&gt; a)
     axN :: N a  ~  S -&gt; a
and
   e :: N (N Int)
then the eta-expansion should look like
   (\(x::S) (y::S) -&gt; (e |&gt; co) x y) |&gt; sym co
where
  co :: N (N Int) ~ S -&gt; S -&gt; Int
  co = axN @(N Int) ; (S -&gt; axN @Int)

We want to get one cast, at the top, to account for all those
nested newtypes. This is expressed by the EtaInfo type:

   data EtaInfo = EI [Var] MCoercionR

Precisely, here is the (EtaInfo Invariant):

  EI bs co :: EtaInfo

describes a particular eta-expansion, thus:

  Abstraction:  (\b1 b2 .. bn. []) |&gt; sym co
  Application:  ([] |&gt; co) b1 b2 .. bn

  e  :: T
  co :: T ~R (t1 -&gt; t2 -&gt; .. -&gt; tn -&gt; tr)
  e = (\b1 b2 ... bn. (e |&gt; co) b1 b2 .. bn) |&gt; sym co


Note [Check for reflexive casts in eta expansion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It turns out that the casts created by the above mechanism are often Refl.
When casts are very deeply nested (as happens in #18223), the repetition
of types can make the overall term very large.  So there is a big
payoff in cancelling out casts aggressively wherever possible.
(See also Note [No crap in eta-expanded code].)

This matters particularly in etaInfoApp, where we
* Do beta-reduction on the fly
* Use getArg_maybe to get a cast out of the way,
  so that we can do beta reduction
Together this makes a big difference.  Consider when e is
   case x of
      True  -&gt; (\x -&gt; e1) |&gt; c1
      False -&gt; (\p -&gt; e2) |&gt; c2

When we eta-expand this to arity 1, say, etaInfoAbs will wrap
a (\eta) around the outside and use etaInfoApp to apply each
alternative to 'eta'.  We want to beta-reduce all that junk
away.

#18223 was a dramatic example in which the intermediate term was
grotesquely huge, even though the next Simplifier iteration squashed
it.  Better to kill it at birth.

The crucial spots in etaInfoApp are:
* `checkReflexiveMCo` in the (Cast e co) case of `go`
* `checkReflexiveMCo` in `pushCoArg`
* Less important: checkReflexiveMCo in the final case of `go`
Collectively these make a factor-of-5 difference to the total
allocation of T18223, so take care if you change this stuff!

Example:
   newtype N = MkN (Y-&gt;Z)
   f :: X -&gt; N
   f = \(x::X). ((\(y::Y). blah) |&gt; fco)

where fco :: (Y-&gt;Z) ~ N

mkEtaWW makes an EtaInfo of (EI [(eta1:X), (eta2:Y)] eta_co
  where
    eta_co :: (X-&gt;N) ~ (X-&gt;Y-&gt;Z)
    eta_co =  (&lt;X&gt; -&gt; nco)
    nco :: N ~ (Y-&gt;Z)  -- Comes from topNormaliseNewType_maybe

Now, when we push that eta_co inward in etaInfoApp:
* In the (Cast e co) case, the 'fco' and 'nco' will meet, and
  should cancel.
* When we meet the (\y.e) we want no cast on the y.

-}</span><span>
</span><span id="line-2194"></span><span>
</span><span id="line-2195"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-2196"></span><span class="hs-keyword">data</span><span> </span><span id="EtaInfo"><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-var">EtaInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EI"><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span>
</span><span id="line-2197"></span><span>     </span><span class="hs-comment">-- See Note [The EtaInfo mechanism]</span><span>
</span><span id="line-2198"></span><span>
</span><span id="line-2199"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2200"></span><span>  </span><span id="local-6989586621682707831"><span class="annot"><span class="annottext">ppr :: EtaInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621682707832"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707832"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span id="local-6989586621682707833"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707833"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;EI&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707832"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercionR -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707833"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2201"></span><span>
</span><span id="line-2202"></span><span>
</span><span id="line-2203"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaInfoApp"><span class="hs-identifier hs-type">etaInfoApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2204"></span><span class="hs-comment">-- (etaInfoApp s e (EI bs mco) returns something equivalent to</span><span>
</span><span id="line-2205"></span><span class="hs-comment">--             ((substExpr s e) |&gt; mco b1 .. bn)</span><span>
</span><span id="line-2206"></span><span class="hs-comment">-- See Note [The EtaInfo mechanism]</span><span>
</span><span id="line-2207"></span><span class="hs-comment">--</span><span>
</span><span id="line-2208"></span><span class="hs-comment">-- NB: With very deeply nested casts, this function can be expensive</span><span>
</span><span id="line-2209"></span><span class="hs-comment">--     In T18223, this function alone costs 15% of allocation, all</span><span>
</span><span id="line-2210"></span><span class="hs-comment">--     spent in the calls to substExprSC and substBindSC</span><span>
</span><span id="line-2211"></span><span>
</span><span id="line-2212"></span><span id="etaInfoApp"><span class="annot"><span class="annottext">etaInfoApp :: InScopeSet -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaInfoApp"><span class="hs-identifier hs-var hs-var">etaInfoApp</span></a></span></span><span> </span><span id="local-6989586621682707835"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707835"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682707836"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707836"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621682707837"><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707837"><span class="hs-identifier hs-var">eis</span></a></span></span><span>
</span><span id="line-2213"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707835"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707836"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707837"><span class="hs-identifier hs-var">eis</span></a></span><span>
</span><span id="line-2214"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2215"></span><span>    </span><span class="annot"><a href="#local-6989586621682707838"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2216"></span><span>    </span><span class="hs-comment">-- 'go' pushed down the eta-infos into the branch of a case</span><span>
</span><span id="line-2217"></span><span>    </span><span class="hs-comment">-- and the body of a let; and does beta-reduction if possible</span><span>
</span><span id="line-2218"></span><span>    </span><span class="hs-comment">--   go subst fun co [b1,..,bn]  returns  (subst(fun) |&gt; co) b1 .. bn</span><span>
</span><span id="line-2219"></span><span>    </span><span id="local-6989586621682707838"><span class="annot"><span class="annottext">go :: Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621682707838"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682707840"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707840"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682707841"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707841"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682707842"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707842"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707843"><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707843"><span class="hs-identifier hs-var">eis</span></a></span></span><span>
</span><span id="line-2220"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CoreTickish -&gt; CoreTickish
</span><a href="GHC.Core.Subst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707840"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707841"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707840"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707842"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707843"><span class="hs-identifier hs-var">eis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2221"></span><span>
</span><span id="line-2222"></span><span>    </span><span class="annot"><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707845"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707845"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682707846"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707846"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682707847"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707847"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621682707848"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707848"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682707849"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707849"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2223"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707845"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707846"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707848"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707850"><span class="hs-identifier hs-var">mco'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2224"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2225"></span><span>        </span><span id="local-6989586621682707850"><span class="annot"><span class="annottext">mco' :: MCoercionR
</span><a href="#local-6989586621682707850"><span class="hs-identifier hs-var hs-var">mco'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#checkReflexiveMCo"><span class="hs-identifier hs-var">checkReflexiveMCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">Core.substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707845"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707847"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkTransMCoR"><span class="hs-operator hs-var">`mkTransMCoR`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707849"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2226"></span><span>               </span><span class="hs-comment">-- See Note [Check for reflexive casts in eta expansion]</span><span>
</span><span id="line-2227"></span><span>
</span><span id="line-2228"></span><span>    </span><span class="annot"><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707854"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707854"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682707855"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707855"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682707856"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707856"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682707857"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707857"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682707858"><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707858"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707859"><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707859"><span class="hs-identifier hs-var">eis</span></a></span></span><span>
</span><span id="line-2229"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; TyVar -&gt; Type -&gt; [Alt TyVar] -&gt; CoreExpr
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExprSC"><span class="hs-identifier hs-var">Core.substExprSC</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707854"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707855"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707861"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707862"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707863"><span class="hs-identifier hs-var">alts'</span></a></span><span>
</span><span id="line-2230"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2231"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682707864"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707864"><span class="hs-identifier hs-var">subst1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707861"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707861"><span class="hs-identifier hs-var">b1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; TyVar -&gt; (Subst, TyVar)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">Core.substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707854"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707856"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2232"></span><span>        </span><span id="local-6989586621682707863"><span class="annot"><span class="annottext">alts' :: [Alt TyVar]
</span><a href="#local-6989586621682707863"><span class="hs-identifier hs-var hs-var">alts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Alt TyVar -&gt; Alt TyVar) -&gt; [Alt TyVar] -&gt; [Alt TyVar]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Alt TyVar -&gt; Alt TyVar
</span><a href="#local-6989586621682707866"><span class="hs-identifier hs-var">subst_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621682707858"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-2233"></span><span>        </span><span id="local-6989586621682707862"><span class="annot"><span class="annottext">ty' :: Type
</span><a href="#local-6989586621682707862"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; EtaInfo -&gt; Type
</span><a href="GHC.Core.Opt.Arity.html#etaInfoAppTy"><span class="hs-identifier hs-var">etaInfoAppTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707854"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707857"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707859"><span class="hs-identifier hs-var">eis</span></a></span><span>
</span><span id="line-2234"></span><span>        </span><span id="local-6989586621682707866"><span class="annot"><span class="annottext">subst_alt :: Alt TyVar -&gt; Alt TyVar
</span><a href="#local-6989586621682707866"><span class="hs-identifier hs-var hs-var">subst_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682707869"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682707869"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682707870"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707870"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682707871"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707871"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [TyVar] -&gt; CoreExpr -&gt; Alt TyVar
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682707869"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707872"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707873"><span class="hs-identifier hs-var">subst2</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707871"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707859"><span class="hs-identifier hs-var">eis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2235"></span><span>                 </span><span class="hs-keyword">where</span><span>
</span><span id="line-2236"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621682707873"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707873"><span class="hs-identifier hs-var">subst2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682707872"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707872"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [TyVar] -&gt; (Subst, [TyVar])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f TyVar -&gt; (Subst, f TyVar)
</span><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-var">Core.substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707864"><span class="hs-identifier hs-var">subst1</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707870"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-2237"></span><span>
</span><span id="line-2238"></span><span>    </span><span class="annot"><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707875"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707875"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682707876"><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621682707876"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682707877"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707877"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707878"><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707878"><span class="hs-identifier hs-var">eis</span></a></span></span><span>
</span><span id="line-2239"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bind TyVar -&gt; Bool
</span><a href="GHC.Core.Utils.html#isJoinBind"><span class="hs-identifier hs-var">isJoinBind</span></a></span><span> </span><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621682707876"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Eta expansion for join points]</span><span>
</span><span id="line-2240"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bind TyVar -&gt; CoreExpr -&gt; CoreExpr
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621682707880"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707881"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707877"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621682707878"><span class="hs-identifier hs-var">eis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2241"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2242"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682707881"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707881"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707880"><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621682707880"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Bind TyVar -&gt; (Subst, Bind TyVar)
Subst -&gt; Bind TyVar -&gt; (Subst, Bind TyVar)
</span><a href="GHC.Core.Subst.html#substBindSC"><span class="hs-identifier hs-var">Core.substBindSC</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707875"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621682707876"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2243"></span><span>
</span><span id="line-2244"></span><span>    </span><span class="hs-comment">-- Beta-reduction if possible, pushing any intervening casts past</span><span>
</span><span id="line-2245"></span><span>    </span><span class="hs-comment">-- the argument. See Note [The EtaInfo mechanism]</span><span>
</span><span id="line-2246"></span><span>    </span><span class="annot"><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707883"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707883"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682707884"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707884"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682707885"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707885"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707886"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707886"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707887"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707887"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707888"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707888"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2247"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707889"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707889"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682707890"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707890"><span class="hs-identifier hs-var">mco'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MCoercionR -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushMCoArg"><span class="hs-identifier hs-var">pushMCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707888"><span class="hs-identifier hs-var">mco</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; CoreExpr
forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707886"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2248"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; TyVar -&gt; CoreExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier hs-var">Core.extendSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707883"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707884"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707889"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707885"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707887"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707890"><span class="hs-identifier hs-var">mco'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2249"></span><span>
</span><span id="line-2250"></span><span>    </span><span class="hs-comment">-- Stop pushing down; just wrap the expression up</span><span>
</span><span id="line-2251"></span><span>    </span><span class="hs-comment">-- See Note [Check for reflexive casts in eta expansion]</span><span>
</span><span id="line-2252"></span><span>    </span><span class="annot"><a href="#local-6989586621682707838"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707894"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707894"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682707895"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707895"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621682707896"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707896"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682707897"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707897"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExprSC"><span class="hs-identifier hs-var">Core.substExprSC</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707894"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707895"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2253"></span><span>                             </span><span class="annot"><span class="annottext">CoreExpr -&gt; MCoercionR -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-operator hs-var">`mkCastMCo`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#checkReflexiveMCo"><span class="hs-identifier hs-var">checkReflexiveMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707897"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-2254"></span><span>                             </span><span class="annot"><span class="annottext">CoreExpr -&gt; [TyVar] -&gt; CoreExpr
forall b. Expr b -&gt; [TyVar] -&gt; Expr b
</span><a href="GHC.Core.html#mkVarApps"><span class="hs-operator hs-var">`mkVarApps`</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707896"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-2255"></span><span>
</span><span id="line-2256"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-2257"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaInfoAppTy"><span class="hs-identifier hs-type">etaInfoAppTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-2258"></span><span class="hs-comment">-- If                    e :: ty</span><span>
</span><span id="line-2259"></span><span class="hs-comment">-- then   etaInfoApp e eis :: etaInfoApp ty eis</span><span>
</span><span id="line-2260"></span><span id="etaInfoAppTy"><span class="annot"><span class="annottext">etaInfoAppTy :: Type -&gt; EtaInfo -&gt; Type
</span><a href="GHC.Core.Opt.Arity.html#etaInfoAppTy"><span class="hs-identifier hs-var hs-var">etaInfoAppTy</span></a></span></span><span> </span><span id="local-6989586621682707900"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707900"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621682707901"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707901"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682707902"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707902"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2261"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; SDoc -&gt; Type -&gt; [CoreExpr] -&gt; Type
SDoc -&gt; Type -&gt; [CoreExpr] -&gt; Type
</span><a href="GHC.Core.Utils.html#applyTypeToArgs"><span class="hs-identifier hs-var">applyTypeToArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;etaInfoAppTy&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707904"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TyVar -&gt; CoreExpr) -&gt; [TyVar] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; CoreExpr
forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707901"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2262"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2263"></span><span>    </span><span id="local-6989586621682707904"><span class="annot"><span class="annottext">ty1 :: Type
</span><a href="#local-6989586621682707904"><span class="hs-identifier hs-var hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707902"><span class="hs-identifier hs-var">mco</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2264"></span><span>             </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707900"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2265"></span><span>             </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682707907"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707907"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707907"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2266"></span><span>
</span><span id="line-2267"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-2268"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaInfoAbs"><span class="hs-identifier hs-type">etaInfoAbs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2269"></span><span class="hs-comment">-- See Note [The EtaInfo mechanism]</span><span>
</span><span id="line-2270"></span><span id="etaInfoAbs"><span class="annot"><span class="annottext">etaInfoAbs :: EtaInfo -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaInfoAbs"><span class="hs-identifier hs-var hs-var">etaInfoAbs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621682707909"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707909"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682707910"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707910"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707911"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707911"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; CoreExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707909"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707911"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; MCoercionR -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-operator hs-var">`mkCastMCo`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkSymMCo"><span class="hs-identifier hs-var">mkSymMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707910"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-2271"></span><span>
</span><span id="line-2272"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-2273"></span><span class="hs-comment">-- | @mkEtaWW n _ fvs ty@ will compute the 'EtaInfo' necessary for eta-expanding</span><span>
</span><span id="line-2274"></span><span class="hs-comment">-- an expression @e :: ty@ to take @n@ value arguments, where @fvs@ are the</span><span>
</span><span id="line-2275"></span><span class="hs-comment">-- free variables of @e@.</span><span>
</span><span id="line-2276"></span><span class="hs-comment">--</span><span>
</span><span id="line-2277"></span><span class="hs-comment">-- Note that this function is entirely unconcerned about cost centres and other</span><span>
</span><span id="line-2278"></span><span class="hs-comment">-- semantically-irrelevant source annotations, so call sites must take care to</span><span>
</span><span id="line-2279"></span><span class="hs-comment">-- preserve that info. See Note [Eta expansion and SCCs].</span><span>
</span><span id="line-2280"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#mkEtaWW"><span class="hs-identifier hs-type">mkEtaWW</span></a></span><span>
</span><span id="line-2281"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2282"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ How many value arguments to eta-expand</span></span><span>
</span><span id="line-2283"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-2284"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The pretty-printed original expression, for warnings.</span></span><span>
</span><span id="line-2285"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span>
</span><span id="line-2286"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ A super-set of the free vars of the expression to eta-expand.</span></span><span>
</span><span id="line-2287"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-2288"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2289"></span><span>  </span><span class="hs-comment">-- ^ The variables in 'EtaInfo' are fresh wrt. to the incoming 'InScopeSet'.</span><span>
</span><span id="line-2290"></span><span>  </span><span class="hs-comment">-- The outgoing 'InScopeSet' extends the incoming 'InScopeSet' with the</span><span>
</span><span id="line-2291"></span><span>  </span><span class="hs-comment">-- fresh variables in 'EtaInfo'.</span><span>
</span><span id="line-2292"></span><span>
</span><span id="line-2293"></span><span id="mkEtaWW"><span class="annot"><span class="annottext">mkEtaWW :: [OneShotInfo]
-&gt; SDoc -&gt; InScopeSet -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="GHC.Core.Opt.Arity.html#mkEtaWW"><span class="hs-identifier hs-var hs-var">mkEtaWW</span></a></span></span><span> </span><span id="local-6989586621682707914"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707914"><span class="hs-identifier hs-var">orig_oss</span></a></span></span><span> </span><span id="local-6989586621682707915"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682707915"><span class="hs-identifier hs-var">ppr_orig_expr</span></a></span></span><span> </span><span id="local-6989586621682707916"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707916"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682707917"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707917"><span class="hs-identifier hs-var">orig_ty</span></a></span></span><span>
</span><span id="line-2294"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [OneShotInfo] -&gt; Subst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621682707918"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707914"><span class="hs-identifier hs-var">orig_oss</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707919"><span class="hs-identifier hs-var">empty_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707917"><span class="hs-identifier hs-var">orig_ty</span></a></span><span>
</span><span id="line-2295"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2296"></span><span>    </span><span id="local-6989586621682707919"><span class="annot"><span class="annottext">empty_subst :: Subst
</span><a href="#local-6989586621682707919"><span class="hs-identifier hs-var hs-var">empty_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707916"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-2297"></span><span>
</span><span id="line-2298"></span><span>    </span><span class="annot"><a href="#local-6989586621682707918"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>                </span><span class="hs-comment">-- For fresh names</span><span>
</span><span id="line-2299"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Number of value args to expand to</span><span>
</span><span id="line-2300"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>   </span><span class="hs-comment">-- We are really looking at subst(ty)</span><span>
</span><span id="line-2301"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2302"></span><span>    </span><span class="hs-comment">-- (go [o1,..,on] subst ty) = (in_scope, EI [b1,..,bn] co)</span><span>
</span><span id="line-2303"></span><span>    </span><span class="hs-comment">--    co :: subst(ty) ~ b1_ty -&gt; ... -&gt; bn_ty -&gt; tr</span><span>
</span><span id="line-2304"></span><span>
</span><span id="line-2305"></span><span>    </span><span id="local-6989586621682707918"><span class="annot"><span class="annottext">go :: Int -&gt; [OneShotInfo] -&gt; Subst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621682707918"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621682707920"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707920"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-2306"></span><span>       </span><span class="hs-comment">----------- Done!  No more expansion needed</span><span>
</span><span id="line-2307"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier hs-var">getSubstInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707920"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2308"></span><span>
</span><span id="line-2309"></span><span>    </span><span class="annot"><a href="#local-6989586621682707918"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707922"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707922"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682707923"><span class="annot"><span class="annottext">oss :: [OneShotInfo]
</span><a href="#local-6989586621682707923"><span class="hs-identifier hs-var">oss</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621682707924"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707924"><span class="hs-identifier hs-var">one_shot</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682707925"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707925"><span class="hs-identifier hs-var">oss1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707926"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707926"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682707927"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707927"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2310"></span><span>       </span><span class="hs-comment">----------- Forall types  (forall a. ty)</span><span>
</span><span id="line-2311"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621682707929"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707929"><span class="hs-identifier hs-var">tcv</span></a></span></span><span> </span><span id="local-6989586621682707930"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682707930"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707931"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707931"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (ForAllTyBinder, Type)
</span><a href="GHC.Core.Type.html#splitForAllForAllTyBinder_maybe"><span class="hs-identifier hs-var">splitForAllForAllTyBinder_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707927"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2312"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707933"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707933"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707934"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707934"><span class="hs-identifier hs-var">tcv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; TyVar -&gt; (Subst, TyVar)
Subst -&gt; TyVar -&gt; (Subst, TyVar)
</span><a href="GHC.Core.TyCo.Subst.html#substVarBndr"><span class="hs-identifier hs-var">Type.substVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707926"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707929"><span class="hs-identifier hs-var">tcv</span></a></span><span>
</span><span id="line-2313"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682707936"><span class="annot"><span class="annottext">oss' :: [OneShotInfo]
</span><a href="#local-6989586621682707936"><span class="hs-identifier hs-var hs-var">oss'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707929"><span class="hs-identifier hs-var">tcv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707923"><span class="hs-identifier hs-var">oss</span></a></span><span>
</span><span id="line-2314"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707925"><span class="hs-identifier hs-var">oss1</span></a></span><span>
</span><span id="line-2315"></span><span>         </span><span class="hs-comment">-- A forall can bind a CoVar, in which case</span><span>
</span><span id="line-2316"></span><span>         </span><span class="hs-comment">-- we consume one of the [OneShotInfo]</span><span>
</span><span id="line-2317"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707937"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707937"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621682707938"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707938"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682707939"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707939"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [OneShotInfo] -&gt; Subst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621682707918"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707922"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707936"><span class="hs-identifier hs-var">oss'</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707933"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707931"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-2318"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707937"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707934"><span class="hs-identifier hs-var">tcv'</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707938"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForAllTyBinder -&gt; Type -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Opt.Arity.html#mkEtaForAllMCo"><span class="hs-identifier hs-var">mkEtaForAllMCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; ForAllTyFlag -&gt; ForAllTyBinder
forall var argf. var -&gt; argf -&gt; VarBndr var argf
</span><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707934"><span class="hs-identifier hs-var">tcv'</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682707930"><span class="hs-identifier hs-var">vis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707931"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707939"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2319"></span><span>
</span><span id="line-2320"></span><span>       </span><span class="hs-comment">----------- Function types  (t1 -&gt; t2)</span><span>
</span><span id="line-2321"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707941"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682707941"><span class="hs-identifier hs-var">_af</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707942"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707942"><span class="hs-identifier hs-var">mult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707943"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707943"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707944"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707944"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (FunTyFlag, Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707927"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2322"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#typeHasFixedRuntimeRep"><span class="hs-identifier hs-var">typeHasFixedRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707943"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-2323"></span><span>          </span><span class="hs-comment">-- See Note [Representation polymorphism invariants] in GHC.Core</span><span>
</span><span id="line-2324"></span><span>          </span><span class="hs-comment">-- See also test case typecheck/should_run/EtaExpandLevPoly</span><span>
</span><span id="line-2325"></span><span>
</span><span id="line-2326"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707946"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707946"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707947"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707947"><span class="hs-identifier hs-var">eta_id</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Subst -&gt; Scaled Type -&gt; (Subst, TyVar)
</span><a href="GHC.Core.Opt.Arity.html#freshEtaId"><span class="hs-identifier hs-var">freshEtaId</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707922"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707926"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Scaled Type
forall a. Type -&gt; a -&gt; Scaled a
</span><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-var">Scaled</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707942"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707943"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2327"></span><span>          </span><span class="hs-comment">-- Avoid free vars of the original expression</span><span>
</span><span id="line-2328"></span><span>
</span><span id="line-2329"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682707950"><span class="annot"><span class="annottext">eta_id' :: TyVar
</span><a href="#local-6989586621682707950"><span class="hs-identifier hs-var hs-var">eta_id'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707947"><span class="hs-identifier hs-var">eta_id</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; OneShotInfo -&gt; TyVar
</span><a href="GHC.Types.Id.html#setIdOneShotInfo"><span class="hs-operator hs-var">`setIdOneShotInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621682707924"><span class="hs-identifier hs-var">one_shot</span></a></span><span>
</span><span id="line-2330"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707952"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707952"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621682707953"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707953"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682707954"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707954"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [OneShotInfo] -&gt; Subst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621682707918"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707922"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707925"><span class="hs-identifier hs-var">oss1</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707946"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707944"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-2331"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707952"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707950"><span class="hs-identifier hs-var">eta_id'</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707953"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkFunResMCo"><span class="hs-identifier hs-var">mkFunResMCo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707950"><span class="hs-identifier hs-var">eta_id'</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707954"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2332"></span><span>
</span><span id="line-2333"></span><span>       </span><span class="hs-comment">----------- Newtypes</span><span>
</span><span id="line-2334"></span><span>       </span><span class="hs-comment">-- Given this:</span><span>
</span><span id="line-2335"></span><span>       </span><span class="hs-comment">--      newtype T = MkT ([T] -&gt; Int)</span><span>
</span><span id="line-2336"></span><span>       </span><span class="hs-comment">-- Consider eta-expanding this</span><span>
</span><span id="line-2337"></span><span>       </span><span class="hs-comment">--      eta_expand 1 e T</span><span>
</span><span id="line-2338"></span><span>       </span><span class="hs-comment">-- We want to get</span><span>
</span><span id="line-2339"></span><span>       </span><span class="hs-comment">--      coerce T (\x::[T] -&gt; (coerce ([T]-&gt;Int) e) x)</span><span>
</span><span id="line-2340"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707956"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707956"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707957"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707957"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Coercion, Type)
</span><a href="GHC.Core.Coercion.html#topNormaliseNewType_maybe"><span class="hs-identifier hs-var">topNormaliseNewType_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707927"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2341"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- co :: ty ~ ty'</span><span>
</span><span id="line-2342"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682707959"><span class="annot"><span class="annottext">co' :: Coercion
</span><a href="#local-6989586621682707959"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">Type.substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707926"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707956"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2343"></span><span>             </span><span class="hs-comment">-- Remember to apply the substitution to co (#16979)</span><span>
</span><span id="line-2344"></span><span>             </span><span class="hs-comment">-- (or we could have applied to ty, but then</span><span>
</span><span id="line-2345"></span><span>             </span><span class="hs-comment">--  we'd have had to zap it for the recursive call)</span><span>
</span><span id="line-2346"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707960"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707960"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621682707961"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707961"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682707962"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707962"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [OneShotInfo] -&gt; Subst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621682707918"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707922"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707923"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707926"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707957"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-2347"></span><span>         </span><span class="hs-comment">-- mco :: subst(ty') ~ b1_ty -&gt; ... -&gt; bn_ty -&gt; tr</span><span>
</span><span id="line-2348"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682707960"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707961"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkTransMCoR"><span class="hs-identifier hs-var">mkTransMCoR</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707959"><span class="hs-identifier hs-var">co'</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707962"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2349"></span><span>
</span><span id="line-2350"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-comment">-- We have an expression of arity &gt; 0,</span><span>
</span><span id="line-2351"></span><span>                         </span><span class="hs-comment">-- but its type isn't a function, or a binder</span><span>
</span><span id="line-2352"></span><span>                         </span><span class="hs-comment">-- does not have a fixed runtime representation</span><span>
</span><span id="line-2353"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; String -&gt; SDoc -&gt; (InScopeSet, EtaInfo) -&gt; (InScopeSet, EtaInfo)
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mkEtaWW&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621682707914"><span class="hs-identifier hs-var">orig_oss</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707917"><span class="hs-identifier hs-var">orig_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682707915"><span class="hs-identifier hs-var">ppr_orig_expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2354"></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier hs-var">getSubstInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682707926"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2355"></span><span>        </span><span class="hs-comment">-- This *can* legitimately happen:</span><span>
</span><span id="line-2356"></span><span>        </span><span class="hs-comment">-- e.g.  coerce Int (\x. x) Essentially the programmer is</span><span>
</span><span id="line-2357"></span><span>        </span><span class="hs-comment">-- playing fast and loose with types (Happy does this a lot).</span><span>
</span><span id="line-2358"></span><span>        </span><span class="hs-comment">-- So we simply decline to eta-expand.  Otherwise we'd end up</span><span>
</span><span id="line-2359"></span><span>        </span><span class="hs-comment">-- with an explicit lambda having a non-function type</span><span>
</span><span id="line-2360"></span><span>
</span><span id="line-2361"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#mkEtaForAllMCo"><span class="hs-identifier hs-type">mkEtaForAllMCo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#ForAllTyBinder"><span class="hs-identifier hs-type">ForAllTyBinder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span>
</span><span id="line-2362"></span><span id="mkEtaForAllMCo"><span class="annot"><span class="annottext">mkEtaForAllMCo :: ForAllTyBinder -&gt; Type -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Opt.Arity.html#mkEtaForAllMCo"><span class="hs-identifier hs-var hs-var">mkEtaForAllMCo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621682707964"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707964"><span class="hs-identifier hs-var">tcv</span></a></span></span><span> </span><span id="local-6989586621682707965"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682707965"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707966"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707966"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682707967"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707967"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-2363"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682707967"><span class="hs-identifier hs-var">mco</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2364"></span><span>      </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682707965"><span class="hs-identifier hs-var">vis</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; ForAllTyFlag -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="Language.Haskell.Syntax.Specificity.html#coreTyLamForAllTyFlag"><span class="hs-identifier hs-var">coreTyLamForAllTyFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-2365"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="#local-6989586621682707969"><span class="hs-identifier hs-var">mk_fco</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682707966"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2366"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682707971"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707971"><span class="hs-identifier hs-var">co</span></a></span></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="#local-6989586621682707969"><span class="hs-identifier hs-var">mk_fco</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707971"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2367"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2368"></span><span>    </span><span id="local-6989586621682707969"><span class="annot"><span class="annottext">mk_fco :: Coercion -&gt; MCoercionR
</span><a href="#local-6989586621682707969"><span class="hs-identifier hs-var hs-var">mk_fco</span></a></span></span><span> </span><span id="local-6989586621682707972"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707972"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
TyVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
TyVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707964"><span class="hs-identifier hs-var">tcv</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682707965"><span class="hs-identifier hs-var">vis</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="Language.Haskell.Syntax.Specificity.html#coreTyLamForAllTyFlag"><span class="hs-identifier hs-var">coreTyLamForAllTyFlag</span></a></span><span>
</span><span id="line-2369"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707964"><span class="hs-identifier hs-var">tcv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707972"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2370"></span><span>    </span><span class="hs-comment">-- coreTyLamForAllTyFlag: See Note [The EtaInfo mechanism], particularly</span><span>
</span><span id="line-2371"></span><span>    </span><span class="hs-comment">-- the (EtaInfo Invariant).  (sym co) wraps a lambda that always has</span><span>
</span><span id="line-2372"></span><span>    </span><span class="hs-comment">-- a ForAllTyFlag of coreTyLamForAllTyFlag; see Note [Required foralls in Core]</span><span>
</span><span id="line-2373"></span><span>    </span><span class="hs-comment">-- in GHC.Core.TyCo.Rep</span><span>
</span><span id="line-2374"></span><span>
</span><span id="line-2375"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Eta reduction
*                                                                      *
************************************************************************

Note [Eta reduction makes sense]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
GHC's eta reduction transforms
   \x y. &lt;fun&gt; x y  ---&gt;  &lt;fun&gt;
We discuss when this is /sound/ in Note [Eta reduction soundness].
But even assuming it is sound, when is it /desirable/.  That
is what we discuss here.

This test is made by `ok_fun` in tryEtaReduce.

1. We want to eta-reduce only if we get all the way to a trivial
   expression; we don't want to remove extra lambdas unless we are
   going to avoid allocating this thing altogether.

   Trivial means *including* casts and type lambdas:
     * `\x. f x |&gt; co  --&gt;  f |&gt; (ty(x) -&gt; co)` (provided `co` doesn't mention `x`)
     * `/\a. \x. f @(Maybe a) x --&gt;  /\a. f @(Maybe a)`
   See Note [Do not eta reduce PAPs] for why we insist on a trivial head.

Of course, eta reduction is not always sound. See Note [Eta reduction soundness]
for when it is.

When there are multiple arguments, we might get multiple eta-redexes. Example:
   \x y. e x y
   ==&gt; { reduce \y. (e x) y in context \x._ }
   \x. e x
   ==&gt; { reduce \x. e x in context _ }
   e
And (1) implies that we never want to stop with `\x. e x`, because that is not a
trivial expression. So in practice, the implementation works by considering a
whole group of leading lambdas to reduce.

These delicacies are why we don't simply use 'exprIsTrivial' and 'exprIsHNF'
in 'tryEtaReduce'. Alas.

Note [Eta reduction soundness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
GHC's eta reduction transforms
   \x y. &lt;fun&gt; x y  ---&gt;  &lt;fun&gt;
For soundness, we obviously require that `x` and `y`
to not occur free. But what /other/ restrictions are there for
eta reduction to be sound?

We discuss separately what it means for eta reduction to be
/desirable/, in Note [Eta reduction makes sense].

Eta reduction is *not* a sound transformation in general, because it
may change termination behavior if *value* lambdas are involved:
  `bot`  /=  `\x. bot x`   (as can be observed by a simple `seq`)
The past has shown that oversight of this fact can not only lead to endless
loops or exceptions, but also straight out *segfaults*.

Nevertheless, we can give the following criteria for when it is sound to
perform eta reduction on an expression with n leading lambdas `\xs. e xs`
(checked in 'is_eta_reduction_sound' in 'tryEtaReduce', which focuses on the
case where `e` is trivial):

(A) It is sound to eta-reduce n arguments as long as n does not exceed the
    `exprArity` of `e`. (Needs Arity analysis.)
    This criterion exploits information about how `e` is *defined*.

    Example: If `e = \x. bot` then we know it won't diverge until it is called
    with one argument. Hence it is safe to eta-reduce `\x. e x` to `e`.
    By contrast, it would be *unsound* to eta-reduce 2 args, `\x y. e x y` to `e`:
    `e 42` diverges when `(\x y. e x y) 42` does not.

(S) It is sound to eta-reduce n arguments in an evaluation context in which all
    calls happen with at least n arguments. (Needs Strictness analysis.)
    NB: This treats evaluations like a call with 0 args.
    NB: This criterion exploits information about how `e` is *used*.

    Example: Given a function `g` like
      `g c = Just (c 1 2 + c 2 3)`
    it is safe to eta-reduce the arg in `g (\x y. e x y)` to `g e` without
    knowing *anything* about `e` (perhaps it's a parameter occ itself), simply
    because `g` always calls its parameter with 2 arguments.
    It is also safe to eta-reduce just one arg, e.g., `g (\x. e x)` to `g e`.
    By contrast, it would *unsound* to eta-reduce 3 args in a call site
    like `g (\x y z. e x y z)` to `g e`, because that diverges when
    `e = \x y. bot`.

    Could we relax to &quot;*At least one call in the same trace* is with n args&quot;?
    No. Consider what happens for
      ``g2 c = c True `seq` c False 42``
    Here, `g2` will call `c` with 2 arguments (if there is a call at all).
    But it is unsound to eta-reduce the arg in `g2 (\x y. e x y)` to `g2 e`
    when `e = \x. if x then bot else id`, because the latter will diverge when
    the former would not. Fortunately, the strictness analyser will report
    &quot;Not always called with two arguments&quot; for `g2` and we won't eta-expand.

    See Note [Eta reduction based on evaluation context] for the implementation
    details. This criterion is tested extensively in T21261.

(R) Note [Eta reduction in recursive RHSs] tells us that we should not
    eta-reduce `f` in its own RHS and describes our fix.
    There we have `f = \x. f x` and we should not eta-reduce to `f=f`. Which
    might change a terminating program (think @f `seq` e@) to a non-terminating
    one.

(E) (See fun_arity in tryEtaReduce.) As a perhaps special case on the
    boundary of (A) and (S), when we know that a fun binder `f` is in
    WHNF, we simply assume it has arity 1 and apply (A).  Example:
       g f = f `seq` \x. f x
    Here it's sound eta-reduce `\x. f x` to `f`, because `f` can't be bottom
    after the `seq`. This turned up in #7542.

 T. If the binders are all type arguments, it's always safe to eta-reduce,
    regardless of the arity of f.
       /\a b. f @a @b  --&gt; f

2. Type and dictionary abstraction. Regardless of whether 'f' is a value, it
   is always sound to reduce /type lambdas/, thus:
        (/\a -&gt; f a)  --&gt;   f
   Moreover, we always want to, because it makes RULEs apply more often:
      This RULE:    `forall g. foldr (build (/\a -&gt; g a))`
      should match  `foldr (build (/\b -&gt; ...something complex...))`
   and the simplest way to do so is eta-reduce `/\a -&gt; g a` in the RULE to `g`.

   More debatably, we extend this to dictionary arguments too, because the type
   checker can insert these eta-expanded versions, with both type and dictionary
   lambdas; hence the slightly ad-hoc (all ok_lam bndrs).  That is, we eta-reduce
        \(d::Num a). f d   --&gt;   f
   regardless of f's arity. Its not clear whether or not this is important, and
   it is not in general sound.  But that's the way it is right now.

And here are a few more technical criteria for when it is *not* sound to
eta-reduce that are specific to Core and GHC:

(J) We may not undersaturate join points.
    See Note [Invariants on join points] in GHC.Core, and #20599.

(B) We may not undersaturate functions with no binding.
    See Note [Eta expanding primops].

(W) We may not undersaturate StrictWorkerIds.
    See Note [CBV Function Ids] in GHC.Types.Id.Info.

Here is a list of historic accidents surrounding unsound eta-reduction:

* Consider
        f = \x.f x
        h y = case (case y of { True -&gt; f `seq` True; False -&gt; False }) of
                True -&gt; ...; False -&gt; ...
  If we (unsoundly) eta-reduce f to get f=f, the strictness analyser
  says f=bottom, and replaces the (f `seq` True) with just
  (f `cast` unsafe-co).
  [SG in 2022: I don't think worker/wrapper would do this today.]
  BUT, as things stand, 'f' got arity 1, and it *keeps* arity 1 (perhaps also
  wrongly). So CorePrep eta-expands the definition again, so that it does not
  terminate after all.
  Result: seg-fault because the boolean case actually gets a function value.
  See #1947.

* Never *reduce* arity. For example
      f = \xy. g x y
  Then if h has arity 1 we don't want to eta-reduce because then
  f's arity would decrease, and that is bad
  [SG in 2022: I don't understand this point. There is no `h`, perhaps that
   should have been `g`. Even then, this proposed eta-reduction is invalid by
   criterion (A), which might actually be the point this anecdote is trying to
   make. Perhaps the &quot;no arity decrease&quot; idea is also related to
   Note [Arity robustness]?]

Note [Do not eta reduce PAPs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
I considered eta-reducing if the result is a PAP:
   \x. f e1 e2 x  ==&gt;   f e1 e2

This reduces clutter, sometimes a lot. See Note [Do not eta-expand PAPs]
in GHC.Core.Opt.Simplify.Utils, where we are careful not to eta-expand
a PAP.  If eta-expanding is bad, then eta-reducing is good!

Also the code generator likes eta-reduced PAPs; see GHC.CoreToStg.Prep
Note [No eta reduction needed in rhsToBody].

But note that we don't want to eta-reduce
     \x y.  f &lt;expensive&gt; x y
to
     f &lt;expensive&gt;
The former has arity 2, and repeats &lt;expensive&gt; for every call of the
function; the latter has arity 0, and shares &lt;expensive&gt;.  We don't want
to change behaviour.  Hence the call to exprIsCheap in ok_fun.

I noticed this when examining #18993 and, although it is delicate,
eta-reducing to a PAP happens to fix the regression in #18993.

HOWEVER, if we transform
   \x. f y x   ==&gt;   f y
that might mean that f isn't saturated any more, and does not inline.
This led to some other regressions.

TL;DR currently we do /not/ eta reduce if the result is a PAP.

Note [Eta reduction with casted arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    (\(x:t3). f (x |&gt; g)) :: t3 -&gt; t2
  where
    f :: t1 -&gt; t2
    g :: t3 ~ t1
This should be eta-reduced to

    f |&gt; (sym g -&gt; t2)

So we need to accumulate a coercion, pushing it inward (past
variable arguments only) thus:
   f (x |&gt; co_arg) |&gt; co  --&gt;  (f |&gt; (sym co_arg -&gt; co)) x
   f (x:t)         |&gt; co  --&gt;  (f |&gt; (t -&gt; co)) x
   f @ a           |&gt; co  --&gt;  (f |&gt; (forall a.co)) @ a
   f @ (g:t1~t2)   |&gt; co  --&gt;  (f |&gt; (t1~t2 =&gt; co)) @ (g:t1~t2)
These are the equations for ok_arg.

Note [Eta reduction with casted function]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Since we are pushing a coercion inwards, it is easy to accommodate
    (\xy. (f x |&gt; g) y)
    (\xy. (f x y) |&gt; g)

See the `(Cast e co)` equation for `go` in `tryEtaReduce`.  The
eta-expander pushes those casts outwards, so you might think we won't
ever see a cast here, but if we have
  \xy. (f x y |&gt; g)
we will call tryEtaReduce [x,y] (f x y |&gt; g), and we'd like that to
work.  This happens in GHC.Core.Opt.Simplify.Utils.mkLam, where
eta-expansion may be turned off (by sm_eta_expand).

Note [Eta reduction based on evaluation context]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note [Eta reduction soundness], criterion (S) allows us to eta-reduce
`g (\x y. e x y)` to `g e` when we know that `g` always calls its parameter with
at least 2 arguments. So how do we read that off `g`'s demand signature?

Let's take the simple example of #21261, where `g` (actually, `f`) is defined as
  g c = c 1 2 + c 3 4
Then this is how the pieces are put together:

  * Demand analysis infers `&lt;SC(S,C(1,L))&gt;` for `g`'s demand signature

  * When the Simplifier next simplifies the argument in `g (\x y. e x y)`, it
    looks up the *evaluation context* of the argument in the form of the
    sub-demand `C(S,C(1,L))` and stores it in the 'SimplCont'.
    (Why does it drop the outer evaluation cardinality of the demand, `S`?
    Because it's irrelevant! When we simplify an expression, we do so under the
    assumption that it is currently under evaluation.)
    This sub-demand literally says &quot;Whenever this expression is evaluated, it
    is called with at least two arguments, potentially multiple times&quot;.

  * Then the simplifier takes apart the lambda and simplifies the lambda group
    and then calls 'tryEtaReduce' when rebuilding the lambda, passing the
    evaluation context `C(S,C(1,L))` along. Then we simply peel off 2 call
    sub-demands `Cn` and see whether all of the n's (here: `S=C_1N` and
    `1=C_11`) were strict. And strict they are! Thus, it will eta-reduce
    `\x y. e x y` to `e`.

Note [Eta reduction in recursive RHSs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following recursive function:
  f = \x. ....g (\y. f y)....
The recursive call of f in its own RHS seems like a fine opportunity for
eta-reduction because f has arity 1. And often it is!

Alas, that is unsound in general if the eta-reduction happens in a tail context.
Making the arity visible in the RHS allows us to eta-reduce
  f = \x -&gt; f x
to
  f = f
which means we optimise terminating programs like (f `seq` ()) into
non-terminating ones. Nor is this problem just for tail calls.  Consider
  f = id (\x -&gt; f x)
where we have (for some reason) not yet inlined `id`.  We must not eta-reduce to
  f = id f
because that will then simplify to `f = f` as before.

An immediate idea might be to look at whether the called function is a local
loopbreaker and refrain from eta-expanding. But that doesn't work for mutually
recursive function like in #21652:
  f = g
  g* x = f x
Here, g* is the loopbreaker but f isn't.

What can we do?

Fix 1: Zap `idArity` when analysing recursive RHSs and re-attach the info when
    entering the let body.
    Has the disadvantage that other transformations which make use of arity
    (such as dropping of `seq`s when arity &gt; 0) will no longer work in the RHS.
    Plus it requires non-trivial refactorings to both the simple optimiser (in
    the way `subst_opt_bndr` is used) as well as the Simplifier (in the way
    `simplRecBndrs` and `simplRecJoinBndrs` is used), modifying the SimplEnv's
    substitution twice in the process. A very complicated stop-gap.

Fix 2: Pass the set of enclosing recursive binders to `tryEtaReduce`; these are
    the ones we should not eta-reduce. All call-site must maintain this set.
    Example:
      rec { f1 = ....rec { g = ... (\x. g x)...(\y. f2 y)... }...
          ; f2 = ...f1... }
    when eta-reducing those inner lambdas, we need to know that we are in the
    rec group for {f1, f2, g}.
    This is very much like the solution in Note [Speculative evaluation] in
    GHC.CoreToStg.Prep.
    It is a bit tiresome to maintain this info, because it means another field
    in SimplEnv and SimpleOptEnv.

We implement Fix (2) because of it isn't as complicated to maintain as (1).
Plus, it is the correct fix to begin with. After all, the arity is correct,
but doing the transformation isn't. The moving parts are:
  * A field `scRecIds` in `SimplEnv` tracks the enclosing recursive binders
  * We extend the `scRecIds` set in `GHC.Core.Opt.Simplify.simplRecBind`
  * We consult the set in `is_eta_reduction_sound` in `tryEtaReduce`
The situation is very similar to Note [Speculative evaluation] which has the
same fix.
-}</span><span>
</span><span id="line-2694"></span><span>
</span><span id="line-2695"></span><span class="hs-comment">-- | `tryEtaReduce [x,y,z] e sd` returns `Just e'` if `\x y z -&gt; e` is evaluated</span><span>
</span><span id="line-2696"></span><span class="hs-comment">-- according to `sd` and can soundly and gainfully be eta-reduced to `e'`.</span><span>
</span><span id="line-2697"></span><span class="hs-comment">-- See Note [Eta reduction soundness]</span><span>
</span><span id="line-2698"></span><span class="hs-comment">-- and Note [Eta reduction makes sense] when that is the case.</span><span>
</span><span id="line-2699"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#tryEtaReduce"><span class="hs-identifier hs-type">tryEtaReduce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html#UnVarSet"><span class="hs-identifier hs-type">UnVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2700"></span><span class="hs-comment">-- Return an expression equal to (\bndrs. body)</span><span>
</span><span id="line-2701"></span><span id="tryEtaReduce"><span class="annot"><span class="annottext">tryEtaReduce :: UnVarSet -&gt; [TyVar] -&gt; CoreExpr -&gt; SubDemand -&gt; Maybe CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#tryEtaReduce"><span class="hs-identifier hs-var hs-var">tryEtaReduce</span></a></span></span><span> </span><span id="local-6989586621682707976"><span class="annot"><span class="annottext">UnVarSet
</span><a href="#local-6989586621682707976"><span class="hs-identifier hs-var">rec_ids</span></a></span></span><span> </span><span id="local-6989586621682707977"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707977"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682707978"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707978"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621682707979"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682707979"><span class="hs-identifier hs-var">eval_sd</span></a></span></span><span>
</span><span id="line-2702"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; Maybe CoreExpr
</span><a href="#local-6989586621682707980"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707977"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707978"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707978"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2703"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2704"></span><span>    </span><span id="local-6989586621682707981"><span class="annot"><span class="annottext">incoming_arity :: Int
</span><a href="#local-6989586621682707981"><span class="hs-identifier hs-var hs-var">incoming_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; [TyVar] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707977"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="hs-comment">-- See Note [Eta reduction makes sense], point (2)</span><span>
</span><span id="line-2705"></span><span>
</span><span id="line-2706"></span><span>    </span><span class="annot"><a href="#local-6989586621682707980"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- Binders, innermost first, types [a3,a2,a1]</span><span>
</span><span id="line-2707"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>         </span><span class="hs-comment">-- Of type tr</span><span>
</span><span id="line-2708"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>         </span><span class="hs-comment">-- Of type tr ~ ts</span><span>
</span><span id="line-2709"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>   </span><span class="hs-comment">-- Of type a1 -&gt; a2 -&gt; a3 -&gt; ts</span><span>
</span><span id="line-2710"></span><span>    </span><span class="hs-comment">-- See Note [Eta reduction with casted arguments]</span><span>
</span><span id="line-2711"></span><span>    </span><span class="hs-comment">-- for why we have an accumulating coercion</span><span>
</span><span id="line-2712"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-2713"></span><span>    </span><span class="hs-comment">-- Invariant: (go bs body co) returns an expression</span><span>
</span><span id="line-2714"></span><span>    </span><span class="hs-comment">--            equivalent to (\(reverse bs). (body |&gt; co))</span><span>
</span><span id="line-2715"></span><span>
</span><span id="line-2716"></span><span>    </span><span class="hs-comment">-- See Note [Eta reduction with casted function]</span><span>
</span><span id="line-2717"></span><span>    </span><span id="local-6989586621682707980"><span class="annot"><span class="annottext">go :: [TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; Maybe CoreExpr
</span><a href="#local-6989586621682707980"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682707983"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707983"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682707984"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707984"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682707985"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707985"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707986"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707986"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-2718"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; Maybe CoreExpr
</span><a href="#local-6989586621682707980"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707983"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707984"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707985"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707986"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2719"></span><span>
</span><span id="line-2720"></span><span>    </span><span class="annot"><a href="#local-6989586621682707980"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682707988"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707988"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682707989"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707989"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682707990"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707990"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707991"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707991"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-2721"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707989"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-2722"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; Maybe CoreExpr -&gt; Maybe CoreExpr
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682707989"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe CoreExpr -&gt; Maybe CoreExpr)
-&gt; Maybe CoreExpr -&gt; Maybe CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; Maybe CoreExpr
</span><a href="#local-6989586621682707980"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707988"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707990"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707991"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2723"></span><span>      </span><span class="hs-comment">-- Float app ticks: \x -&gt; Tick t (e x) ==&gt; Tick t e</span><span>
</span><span id="line-2724"></span><span>
</span><span id="line-2725"></span><span>    </span><span class="annot"><a href="#local-6989586621682707980"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707992"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707992"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682707993"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707993"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682707994"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707994"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682707995"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707995"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682707996"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707996"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-2726"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682707997"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707997"><span class="hs-identifier hs-var">co'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682707998"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682707998"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVar
-&gt; CoreExpr -&gt; Coercion -&gt; Type -&gt; Maybe (Coercion, [CoreTickish])
</span><a href="#local-6989586621682707999"><span class="hs-identifier hs-var">ok_arg</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682707992"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707995"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707996"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707994"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2727"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; Maybe CoreExpr -&gt; Maybe CoreExpr
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreExpr -&gt; [CoreTickish] -&gt; CoreExpr)
-&gt; [CoreTickish] -&gt; CoreExpr -&gt; CoreExpr
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreTickish -&gt; CoreExpr -&gt; CoreExpr)
-&gt; CoreExpr -&gt; [CoreTickish] -&gt; CoreExpr
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682707998"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe CoreExpr -&gt; Maybe CoreExpr)
-&gt; Maybe CoreExpr -&gt; Maybe CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; Maybe CoreExpr
</span><a href="#local-6989586621682707980"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707993"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682707994"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682707997"><span class="hs-identifier hs-var">co'</span></a></span><span>
</span><span id="line-2728"></span><span>            </span><span class="hs-comment">-- Float arg ticks: \x -&gt; e (Tick t x) ==&gt; Tick t e</span><span>
</span><span id="line-2729"></span><span>
</span><span id="line-2730"></span><span>    </span><span class="annot"><a href="#local-6989586621682707980"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682708001"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708001"><span class="hs-identifier hs-var">remaining_bndrs</span></a></span></span><span> </span><span id="local-6989586621682708002"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708002"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682708003"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708003"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-2731"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; [TyVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708001"><span class="hs-identifier hs-var">remaining_bndrs</span></a></span><span>
</span><span id="line-2732"></span><span>            </span><span class="hs-comment">-- If all the remaining_bnrs are tyvars, then the etad_exp</span><span>
</span><span id="line-2733"></span><span>            </span><span class="hs-comment">--    will be trivial, which is what we want.</span><span>
</span><span id="line-2734"></span><span>            </span><span class="hs-comment">-- e.g. We might have  /\a \b. f [a] b, and we want to</span><span>
</span><span id="line-2735"></span><span>            </span><span class="hs-comment">--      eta-reduce to  /\a. f [a]</span><span>
</span><span id="line-2736"></span><span>            </span><span class="hs-comment">-- We don't want to give up on this one: see #20040</span><span>
</span><span id="line-2737"></span><span>            </span><span class="hs-comment">-- See Note [Eta reduction makes sense], point (1)</span><span>
</span><span id="line-2738"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708001"><span class="hs-identifier hs-var">remaining_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#ltLength"><span class="hs-operator hs-var">`ltLength`</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707977"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-2739"></span><span>            </span><span class="hs-comment">-- Only reply Just if /something/ has happened</span><span>
</span><span id="line-2740"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621682708005"><span class="hs-identifier hs-var">ok_fun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708002"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-2741"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682708006"><span class="annot"><span class="annottext">used_vars :: VarSet
</span><a href="#local-6989586621682708006"><span class="hs-identifier hs-var hs-var">used_vars</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708002"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708003"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2742"></span><span>            </span><span id="local-6989586621682708009"><span class="annot"><span class="annottext">reduced_bndrs :: VarSet
</span><a href="#local-6989586621682708009"><span class="hs-identifier hs-var hs-var">reduced_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar] -&gt; [TyVar]
forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#dropList"><span class="hs-identifier hs-var">dropList</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708001"><span class="hs-identifier hs-var">remaining_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707977"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2743"></span><span>            </span><span class="hs-comment">-- reduced_bndrs are the ones we are eta-reducing away</span><span>
</span><span id="line-2744"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682708006"><span class="hs-identifier hs-var">used_vars</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#disjointVarSet"><span class="hs-operator hs-var">`disjointVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682708009"><span class="hs-identifier hs-var">reduced_bndrs</span></a></span><span>
</span><span id="line-2745"></span><span>          </span><span class="hs-comment">-- Check for any of the reduced_bndrs (about to be dropped)</span><span>
</span><span id="line-2746"></span><span>          </span><span class="hs-comment">-- free in the result, including the accumulated coercion.</span><span>
</span><span id="line-2747"></span><span>          </span><span class="hs-comment">-- See Note [Eta reduction makes sense], intro and point (1)</span><span>
</span><span id="line-2748"></span><span>          </span><span class="hs-comment">-- NB: don't compute used_vars from exprFreeVars (mkCast fun co)</span><span>
</span><span id="line-2749"></span><span>          </span><span class="hs-comment">--     because the latter may be ill formed if the guard fails (#21801)</span><span>
</span><span id="line-2750"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe CoreExpr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; CoreExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708001"><span class="hs-identifier hs-var">remaining_bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708002"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708003"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2751"></span><span>
</span><span id="line-2752"></span><span>    </span><span class="annot"><a href="#local-6989586621682707980"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682708013"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708013"><span class="hs-identifier hs-var">_remaining_bndrs</span></a></span></span><span> </span><span id="local-6989586621682708014"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708014"><span class="hs-identifier hs-var">_fun</span></a></span></span><span>  </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;tER fail&quot; (ppr _fun $$ ppr _remaining_bndrs) $</span><span>
</span><span id="line-2753"></span><span>                                   </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2754"></span><span>
</span><span id="line-2755"></span><span>    </span><span class="hs-comment">---------------</span><span>
</span><span id="line-2756"></span><span>    </span><span class="hs-comment">-- See Note [Eta reduction makes sense], point (1)</span><span>
</span><span id="line-2757"></span><span>    </span><span id="local-6989586621682708005"><span class="annot"><span class="annottext">ok_fun :: CoreExpr -&gt; Bool
</span><a href="#local-6989586621682708005"><span class="hs-identifier hs-var hs-var">ok_fun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682708015"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708015"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621682708005"><span class="hs-identifier hs-var">ok_fun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708015"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-2758"></span><span>    </span><span class="annot"><a href="#local-6989586621682708005"><span class="hs-identifier hs-var">ok_fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682708016"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708016"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621682708005"><span class="hs-identifier hs-var">ok_fun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708016"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-2759"></span><span>    </span><span class="annot"><a href="#local-6989586621682708005"><span class="hs-identifier hs-var">ok_fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682708017"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708017"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621682708005"><span class="hs-identifier hs-var">ok_fun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708017"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2760"></span><span>    </span><span class="annot"><a href="#local-6989586621682708005"><span class="hs-identifier hs-var">ok_fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682708018"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708018"><span class="hs-identifier hs-var">fun_id</span></a></span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="#local-6989586621682708019"><span class="hs-identifier hs-var">is_eta_reduction_sound</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708018"><span class="hs-identifier hs-var">fun_id</span></a></span><span>
</span><span id="line-2761"></span><span>    </span><span class="annot"><a href="#local-6989586621682708005"><span class="hs-identifier hs-var">ok_fun</span></a></span><span> </span><span id="local-6989586621682708020"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708020"><span class="hs-identifier hs-var">_fun</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2762"></span><span>
</span><span id="line-2763"></span><span>    </span><span class="hs-comment">---------------</span><span>
</span><span id="line-2764"></span><span>    </span><span class="hs-comment">-- See Note [Eta reduction soundness], this is THE place to check soundness!</span><span>
</span><span id="line-2765"></span><span>    </span><span id="local-6989586621682708019"><span class="annot"><span class="annottext">is_eta_reduction_sound :: TyVar -&gt; Bool
</span><a href="#local-6989586621682708019"><span class="hs-identifier hs-var hs-var">is_eta_reduction_sound</span></a></span></span><span> </span><span id="local-6989586621682708021"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708021"><span class="hs-identifier hs-var">fun</span></a></span></span><span>
</span><span id="line-2766"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708021"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; UnVarSet -&gt; Bool
</span><a href="GHC.Data.Graph.UnVar.html#elemUnVarSet"><span class="hs-operator hs-var">`elemUnVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">UnVarSet
</span><a href="#local-6989586621682707976"><span class="hs-identifier hs-var">rec_ids</span></a></span><span>          </span><span class="hs-comment">-- Criterion (R)</span><span>
</span><span id="line-2767"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- Don't eta-reduce in fun in its own recursive RHSs</span><span>
</span><span id="line-2768"></span><span>
</span><span id="line-2769"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#cantEtaReduceFun"><span class="hs-identifier hs-var">cantEtaReduceFun</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708021"><span class="hs-identifier hs-var">fun</span></a></span><span>                </span><span class="hs-comment">-- Criteria (J), (W), (B)</span><span>
</span><span id="line-2770"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- Function can't be eta reduced to arity 0</span><span>
</span><span id="line-2771"></span><span>              </span><span class="hs-comment">-- without violating invariants of Core and GHC</span><span>
</span><span id="line-2772"></span><span>
</span><span id="line-2773"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2774"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Check that eta-reduction won't make the program stricter...</span><span>
</span><span id="line-2775"></span><span>        </span><span class="annot"><span class="annottext">TyVar -&gt; Int
</span><a href="#local-6989586621682708024"><span class="hs-identifier hs-var">fun_arity</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708021"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707981"><span class="hs-identifier hs-var">incoming_arity</span></a></span><span>          </span><span class="hs-comment">-- Criterion (A) and (E)</span><span>
</span><span id="line-2776"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="#local-6989586621682708025"><span class="hs-identifier hs-var">all_calls_with_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682707981"><span class="hs-identifier hs-var">incoming_arity</span></a></span><span>   </span><span class="hs-comment">-- Criterion (S)</span><span>
</span><span id="line-2777"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; [TyVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="#local-6989586621682708026"><span class="hs-identifier hs-var">ok_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682707977"><span class="hs-identifier hs-var">bndrs</span></a></span><span>                      </span><span class="hs-comment">-- Criterion (T)</span><span>
</span><span id="line-2778"></span><span>
</span><span id="line-2779"></span><span>    </span><span id="local-6989586621682708025"><span class="annot"><span class="annottext">all_calls_with_arity :: Int -&gt; Bool
</span><a href="#local-6989586621682708025"><span class="hs-identifier hs-var hs-var">all_calls_with_arity</span></a></span></span><span> </span><span id="local-6989586621682708027"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708027"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Card -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrict"><span class="hs-identifier hs-var">isStrict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Card, SubDemand) -&gt; Card
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Card, SubDemand) -&gt; Card) -&gt; (Card, SubDemand) -&gt; Card
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SubDemand -&gt; (Card, SubDemand)
</span><a href="GHC.Types.Demand.html#peelManyCalls"><span class="hs-identifier hs-var">peelManyCalls</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708027"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682707979"><span class="hs-identifier hs-var">eval_sd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2780"></span><span>       </span><span class="hs-comment">-- See Note [Eta reduction based on evaluation context]</span><span>
</span><span id="line-2781"></span><span>
</span><span id="line-2782"></span><span>    </span><span class="hs-comment">---------------</span><span>
</span><span id="line-2783"></span><span>    </span><span id="local-6989586621682708024"><span class="annot"><span class="annottext">fun_arity :: TyVar -&gt; Int
</span><a href="#local-6989586621682708024"><span class="hs-identifier hs-var hs-var">fun_arity</span></a></span></span><span> </span><span id="local-6989586621682708035"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708035"><span class="hs-identifier hs-var">fun</span></a></span></span><span>
</span><span id="line-2784"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708036"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708036"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-2785"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isEvaldUnfolding"><span class="hs-identifier hs-var">isEvaldUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708035"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2786"></span><span>           </span><span class="hs-comment">-- See Note [Eta reduction soundness], criterion (E)</span><span>
</span><span id="line-2787"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2788"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-2789"></span><span>         </span><span id="local-6989586621682708036"><span class="annot"><span class="annottext">arity :: Int
</span><a href="#local-6989586621682708036"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708035"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-2790"></span><span>
</span><span id="line-2791"></span><span>    </span><span class="hs-comment">---------------</span><span>
</span><span id="line-2792"></span><span>    </span><span id="local-6989586621682708026"><span class="annot"><span class="annottext">ok_lam :: TyVar -&gt; Bool
</span><a href="#local-6989586621682708026"><span class="hs-identifier hs-var hs-var">ok_lam</span></a></span></span><span> </span><span id="local-6989586621682708039"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708039"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708039"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isEvVar"><span class="hs-identifier hs-var">isEvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708039"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-2793"></span><span>    </span><span class="hs-comment">-- See Note [Eta reduction makes sense], point (2)</span><span>
</span><span id="line-2794"></span><span>
</span><span id="line-2795"></span><span>    </span><span class="hs-comment">---------------</span><span>
</span><span id="line-2796"></span><span>    </span><span class="annot"><a href="#local-6989586621682707999"><span class="hs-identifier hs-type">ok_arg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>              </span><span class="hs-comment">-- Of type bndr_t</span><span>
</span><span id="line-2797"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>         </span><span class="hs-comment">-- Of type arg_t</span><span>
</span><span id="line-2798"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>         </span><span class="hs-comment">-- Of kind (t1~t2)</span><span>
</span><span id="line-2799"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>             </span><span class="hs-comment">-- Type (arg_t -&gt; t1) of the function</span><span>
</span><span id="line-2800"></span><span>                               </span><span class="hs-comment">--      to which the argument is supplied</span><span>
</span><span id="line-2801"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>  </span><span class="hs-comment">-- Of type (arg_t -&gt; t1 ~  bndr_t -&gt; t2)</span><span>
</span><span id="line-2802"></span><span>                               </span><span class="hs-comment">--   (and similarly for tyvars, coercion args)</span><span>
</span><span id="line-2803"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2804"></span><span>    </span><span class="hs-comment">-- See Note [Eta reduction with casted arguments]</span><span>
</span><span id="line-2805"></span><span>    </span><span id="local-6989586621682707999"><span class="annot"><span class="annottext">ok_arg :: TyVar
-&gt; CoreExpr -&gt; Coercion -&gt; Type -&gt; Maybe (Coercion, [CoreTickish])
</span><a href="#local-6989586621682707999"><span class="hs-identifier hs-var hs-var">ok_arg</span></a></span></span><span> </span><span id="local-6989586621682708040"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708040"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682708041"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708041"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682708042"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708042"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682708043"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708043"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-2806"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682708044"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708044"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe TyVar
</span><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708041"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-2807"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708040"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; TyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708044"><span class="hs-identifier hs-var">tv</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (ForAllTyBinder, Type)
</span><a href="GHC.Core.Type.html#splitForAllForAllTyBinder_maybe"><span class="hs-identifier hs-var">splitForAllForAllTyBinder_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708043"><span class="hs-identifier hs-var">fun_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2808"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682708046"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682708046"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Coercion, [CoreTickish]) -&gt; Maybe (Coercion, [CoreTickish])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708047"><span class="hs-identifier hs-var">fco</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2809"></span><span>             </span><span class="hs-keyword">where</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682708047"><span class="annot"><span class="annottext">fco :: Coercion
</span><a href="#local-6989586621682708047"><span class="hs-identifier hs-var hs-var">fco</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
TyVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
TyVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708044"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682708046"><span class="hs-identifier hs-var">vis</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="Language.Haskell.Syntax.Specificity.html#coreTyLamForAllTyFlag"><span class="hs-identifier hs-var">coreTyLamForAllTyFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708048"><span class="hs-identifier hs-var">kco</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708042"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2810"></span><span>                   </span><span class="hs-comment">-- The lambda we are eta-reducing always has visibility</span><span>
</span><span id="line-2811"></span><span>                   </span><span class="hs-comment">-- 'coreTyLamForAllTyFlag' which may or may not match</span><span>
</span><span id="line-2812"></span><span>                   </span><span class="hs-comment">-- the visibility on the inner function (#24014)</span><span>
</span><span id="line-2813"></span><span>                   </span><span id="local-6989586621682708048"><span class="annot"><span class="annottext">kco :: Coercion
</span><a href="#local-6989586621682708048"><span class="hs-identifier hs-var hs-var">kco</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708044"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2814"></span><span>           </span><span class="annot"><span class="annottext">Maybe (ForAllTyBinder, Type)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; Maybe (Coercion, [CoreTickish])
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tryEtaReduce: type arg to non-forall type&quot;</span></span><span>
</span><span id="line-2815"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fun:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708040"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2816"></span><span>                                </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arg:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708041"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-2817"></span><span>                                </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fun_ty:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708043"><span class="hs-identifier hs-var">fun_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2818"></span><span>    </span><span class="annot"><a href="#local-6989586621682707999"><span class="hs-identifier hs-var">ok_arg</span></a></span><span> </span><span id="local-6989586621682708051"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708051"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682708052"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708052"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682708053"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708053"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682708054"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708054"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-2819"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708051"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; TyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708052"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-2820"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682708055"><span class="annot"><span class="annottext">mult :: Type
</span><a href="#local-6989586621682708055"><span class="hs-identifier hs-var hs-var">mult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-var">idMult</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708051"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2821"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708057"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682708057"><span class="hs-identifier hs-var">_af</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708058"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708058"><span class="hs-identifier hs-var">fun_mult</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (FunTyFlag, Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708054"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-2822"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708055"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708058"><span class="hs-identifier hs-var">fun_mult</span></a></span><span> </span><span class="hs-comment">-- There is no change in multiplicity, otherwise we must abort</span><span>
</span><span id="line-2823"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion, [CoreTickish]) -&gt; Maybe (Coercion, [CoreTickish])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyVar -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkFunResCo"><span class="hs-identifier hs-var">mkFunResCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708051"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708053"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2824"></span><span>    </span><span class="annot"><a href="#local-6989586621682707999"><span class="hs-identifier hs-var">ok_arg</span></a></span><span> </span><span id="local-6989586621682708061"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708061"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682708062"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708062"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682708063"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708063"><span class="hs-identifier hs-var">co_arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682708064"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708064"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682708065"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708065"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-2825"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708066"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682708066"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682708067"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708067"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; CoreExpr -&gt; ([CoreTickish], CoreExpr)
forall b.
(CoreTickish -&gt; Bool) -&gt; Expr b -&gt; ([CoreTickish], Expr b)
</span><a href="GHC.Core.Utils.html#stripTicksTop"><span class="hs-identifier hs-var">stripTicksTop</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708062"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2826"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708068"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708068"><span class="hs-identifier hs-var">fun_mult</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (FunTyFlag, Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708065"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-2827"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708061"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; TyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708067"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-2828"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708068"><span class="hs-identifier hs-var">fun_mult</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-var">idMult</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708061"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2829"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion, [CoreTickish]) -&gt; Maybe (Coercion, [CoreTickish])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
Role -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Coercion
Role -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkFunCoNoFTF"><span class="hs-identifier hs-var">mkFunCoNoFTF</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#multToCo"><span class="hs-identifier hs-var">multToCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708068"><span class="hs-identifier hs-var">fun_mult</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708063"><span class="hs-identifier hs-var">co_arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708064"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682708066"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2830"></span><span>       </span><span class="hs-comment">-- The simplifier combines multiple casts into one,</span><span>
</span><span id="line-2831"></span><span>       </span><span class="hs-comment">-- so we can have a simple-minded pattern match here</span><span>
</span><span id="line-2832"></span><span>    </span><span class="annot"><a href="#local-6989586621682707999"><span class="hs-identifier hs-var">ok_arg</span></a></span><span> </span><span id="local-6989586621682708072"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708072"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682708073"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682708073"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682708074"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708074"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682708075"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708075"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682708076"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708076"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span>
</span><span id="line-2833"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682708073"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708077"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708077"><span class="hs-identifier hs-var">co'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708078"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682708078"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVar
-&gt; CoreExpr -&gt; Coercion -&gt; Type -&gt; Maybe (Coercion, [CoreTickish])
</span><a href="#local-6989586621682707999"><span class="hs-identifier hs-var">ok_arg</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708072"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708074"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708075"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708076"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-2834"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion, [CoreTickish]) -&gt; Maybe (Coercion, [CoreTickish])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708077"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682708073"><span class="hs-identifier hs-var">t</span></a></span><span class="annot"><span class="annottext">CoreTickish -&gt; [CoreTickish] -&gt; [CoreTickish]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682708078"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2835"></span><span>
</span><span id="line-2836"></span><span>    </span><span class="annot"><a href="#local-6989586621682707999"><span class="hs-identifier hs-var">ok_arg</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Coercion, [CoreTickish])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2837"></span><span>
</span><span id="line-2838"></span><span class="hs-comment">-- | Can we eta-reduce the given function</span><span>
</span><span id="line-2839"></span><span class="hs-comment">-- See Note [Eta reduction soundness], criteria (B), (J), and (W).</span><span>
</span><span id="line-2840"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#cantEtaReduceFun"><span class="hs-identifier hs-type">cantEtaReduceFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2841"></span><span id="cantEtaReduceFun"><span class="annot"><span class="annottext">cantEtaReduceFun :: TyVar -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#cantEtaReduceFun"><span class="hs-identifier hs-var hs-var">cantEtaReduceFun</span></a></span></span><span> </span><span id="local-6989586621682708079"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708079"><span class="hs-identifier hs-var">fun</span></a></span></span><span>
</span><span id="line-2842"></span><span>  </span><span class="hs-glyph">=</span><span>    </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Id.html#hasNoBinding"><span class="hs-identifier hs-var">hasNoBinding</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708079"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-comment">-- (B)</span><span>
</span><span id="line-2843"></span><span>       </span><span class="hs-comment">-- Don't undersaturate functions with no binding.</span><span>
</span><span id="line-2844"></span><span>
</span><span id="line-2845"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>  </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708079"><span class="hs-identifier hs-var">fun</span></a></span><span>    </span><span class="hs-comment">-- (J)</span><span>
</span><span id="line-2846"></span><span>       </span><span class="hs-comment">-- Don't undersaturate join points.</span><span>
</span><span id="line-2847"></span><span>       </span><span class="hs-comment">-- See Note [Invariants on join points] in GHC.Core, and #20599</span><span>
</span><span id="line-2848"></span><span>
</span><span id="line-2849"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe [CbvMark] -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Maybe [CbvMark]
</span><a href="GHC.Types.Id.html#idCbvMarks_maybe"><span class="hs-identifier hs-var">idCbvMarks_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708079"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- (W)</span><span>
</span><span id="line-2850"></span><span>       </span><span class="hs-comment">-- Don't undersaturate StrictWorkerIds.</span><span>
</span><span id="line-2851"></span><span>       </span><span class="hs-comment">-- See Note [CBV Function Ids] in GHC.Types.Id.Info.</span><span>
</span><span id="line-2852"></span><span>
</span><span id="line-2853"></span><span>
</span><span id="line-2854"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
              The &quot;push rules&quot;
*                                                                      *
************************************************************************

Here we implement the &quot;push rules&quot; from FC papers:

* The push-argument rules, where we can move a coercion past an argument.
  We have
      (fun |&gt; co) arg
  and we want to transform it to
    (fun arg') |&gt; co'
  for some suitable co' and transformed arg'.

* The PushK rule for data constructors.  We have
       (K e1 .. en) |&gt; co
  and we want to transform to
       (K e1' .. en')
  by pushing the coercion into the arguments
-}</span></span><span>
</span><span id="line-2875"></span><span>
</span><span id="line-2876"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier hs-type">pushCoArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2877"></span><span id="pushCoArgs"><span class="annot"><span class="annottext">pushCoArgs :: Coercion -&gt; [CoreExpr] -&gt; Maybe ([CoreExpr], MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier hs-var hs-var">pushCoArgs</span></a></span></span><span> </span><span id="local-6989586621682708084"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708084"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([CoreExpr], MCoercionR) -&gt; Maybe ([CoreExpr], MCoercionR)
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708084"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2878"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier hs-var">pushCoArgs</span></a></span><span> </span><span id="local-6989586621682708085"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708085"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708086"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708086"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682708087"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708087"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708088"><span class="annot"><a href="#local-6989586621682708088"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621682708089"><span class="annot"><a href="#local-6989586621682708089"><span class="hs-identifier hs-var">m_co1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier hs-var">pushCoArg</span></a></span><span>  </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708085"><span class="hs-identifier hs-var">co</span></a></span><span>  </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708086"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2879"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682708089"><span class="hs-identifier hs-type">m_co1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2880"></span><span>                                  </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682708090"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708090"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708091"><span class="annot"><a href="#local-6989586621682708091"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708092"><span class="annot"><a href="#local-6989586621682708092"><span class="hs-identifier hs-var">m_co2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; [CoreExpr] -&gt; Maybe ([CoreExpr], MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier hs-var">pushCoArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708090"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708087"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2881"></span><span>                                                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682708088"><span class="hs-identifier hs-type">arg'</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621682708091"><span class="hs-identifier hs-type">args'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682708092"><span class="hs-identifier hs-type">m_co2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2882"></span><span>                                  </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">([CoreExpr], MCoercionR) -&gt; Maybe ([CoreExpr], MCoercionR)
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708088"><span class="hs-identifier hs-var">arg'</span></a></span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708087"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2883"></span><span>
</span><span id="line-2884"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushMCoArg"><span class="hs-identifier hs-type">pushMCoArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2885"></span><span id="pushMCoArg"><span class="annot"><span class="annottext">pushMCoArg :: MCoercionR -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushMCoArg"><span class="hs-identifier hs-var hs-var">pushMCoArg</span></a></span></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>    </span><span id="local-6989586621682708093"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708093"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr, MCoercionR) -&gt; Maybe (CoreExpr, MCoercionR)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708093"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2886"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushMCoArg"><span class="hs-identifier hs-var">pushMCoArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682708094"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708094"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682708095"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708095"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier hs-var">pushCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708094"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708095"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2887"></span><span>
</span><span id="line-2888"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier hs-type">pushCoArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2889"></span><span class="hs-comment">-- We have (fun |&gt; co) arg, and we want to transform it to</span><span>
</span><span id="line-2890"></span><span class="hs-comment">--         (fun arg) |&gt; co</span><span>
</span><span id="line-2891"></span><span class="hs-comment">-- This may fail, e.g. if (fun :: N) where N is a newtype</span><span>
</span><span id="line-2892"></span><span class="hs-comment">-- C.f. simplCast in GHC.Core.Opt.Simplify</span><span>
</span><span id="line-2893"></span><span class="hs-comment">-- 'co' is always Representational</span><span>
</span><span id="line-2894"></span><span id="pushCoArg"><span class="annot"><span class="annottext">pushCoArg :: Coercion -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier hs-var hs-var">pushCoArg</span></a></span></span><span> </span><span id="local-6989586621682708096"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708096"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682708097"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708097"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-2895"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682708098"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708098"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708097"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2896"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708099"><span class="annot"><a href="#local-6989586621682708099"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708100"><span class="annot"><a href="#local-6989586621682708100"><span class="hs-identifier hs-var">m_co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Type -&gt; Maybe (Type, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier hs-var">pushCoTyArg</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708096"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708098"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2897"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682708099"><span class="hs-identifier hs-type">ty'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682708100"><span class="hs-identifier hs-type">m_co'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2898"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2899"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708101"><span class="annot"><a href="#local-6989586621682708101"><span class="hs-identifier hs-var">arg_mco</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708102"><span class="annot"><a href="#local-6989586621682708102"><span class="hs-identifier hs-var">m_co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (MCoercionR, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier hs-var">pushCoValArg</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708096"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2900"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682708103"><span class="annot"><a href="#local-6989586621682708103"><span class="hs-identifier hs-var hs-var">arg_mco'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#checkReflexiveMCo"><span class="hs-identifier hs-var">checkReflexiveMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621682708101"><span class="hs-identifier hs-var">arg_mco</span></a></span><span>
</span><span id="line-2901"></span><span>             </span><span class="hs-comment">-- checkReflexiveMCo: see Note [Check for reflexive casts in eta expansion]</span><span>
</span><span id="line-2902"></span><span>             </span><span class="hs-comment">-- The coercion is very often (arg_co -&gt; res_co), but without</span><span>
</span><span id="line-2903"></span><span>             </span><span class="hs-comment">-- the argument coercion actually being ReflCo</span><span>
</span><span id="line-2904"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682708097"><span class="hs-identifier hs-type">arg</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-operator hs-type">`mkCastMCo`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682708103"><span class="hs-identifier hs-type">arg_mco'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682708102"><span class="hs-identifier hs-type">m_co'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2905"></span><span>
</span><span id="line-2906"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier hs-type">pushCoTyArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2907"></span><span class="hs-comment">-- We have (fun |&gt; co) @ty</span><span>
</span><span id="line-2908"></span><span class="hs-comment">-- Push the coercion through to return</span><span>
</span><span id="line-2909"></span><span class="hs-comment">--         (fun @ty') |&gt; co'</span><span>
</span><span id="line-2910"></span><span class="hs-comment">-- 'co' is always Representational</span><span>
</span><span id="line-2911"></span><span class="hs-comment">-- If the returned coercion is Nothing, then it would have been reflexive;</span><span>
</span><span id="line-2912"></span><span class="hs-comment">-- it's faster not to compute it, though.</span><span>
</span><span id="line-2913"></span><span id="pushCoTyArg"><span class="annot"><span class="annottext">pushCoTyArg :: Coercion -&gt; Type -&gt; Maybe (Type, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier hs-var hs-var">pushCoTyArg</span></a></span></span><span> </span><span id="local-6989586621682708104"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708104"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682708105"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708105"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2914"></span><span>  </span><span class="hs-comment">-- The following is inefficient - don't do `eqType` here, the coercion</span><span>
</span><span id="line-2915"></span><span>  </span><span class="hs-comment">-- optimizer will take care of it. See #14737.</span><span>
</span><span id="line-2916"></span><span>  </span><span class="hs-comment">-- -- | tyL `eqType` tyR</span><span>
</span><span id="line-2917"></span><span>  </span><span class="hs-comment">-- -- = Just (ty, Nothing)</span><span>
</span><span id="line-2918"></span><span>
</span><span id="line-2919"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708104"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2920"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type, MCoercionR) -&gt; Maybe (Type, MCoercionR)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708105"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2921"></span><span>
</span><span id="line-2922"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708108"><span class="hs-identifier hs-var">tyL</span></a></span><span>
</span><span id="line-2923"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc -&gt; Maybe (Type, MCoercionR) -&gt; Maybe (Type, MCoercionR)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708109"><span class="hs-identifier hs-var">tyR</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708104"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708105"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (Type, MCoercionR) -&gt; Maybe (Type, MCoercionR))
-&gt; Maybe (Type, MCoercionR) -&gt; Maybe (Type, MCoercionR)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2924"></span><span>    </span><span class="annot"><span class="annottext">(Type, MCoercionR) -&gt; Maybe (Type, MCoercionR)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708105"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Coercion -&gt; Type
</span><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-operator hs-var">`mkCastTy`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708111"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708112"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2925"></span><span>
</span><span id="line-2926"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2927"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Type, MCoercionR)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2928"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2929"></span><span>    </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682708108"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708108"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621682708109"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708109"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708104"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2930"></span><span>       </span><span class="hs-comment">-- co :: tyL ~R tyR</span><span>
</span><span id="line-2931"></span><span>       </span><span class="hs-comment">-- tyL = forall (a1 :: k1). ty1</span><span>
</span><span id="line-2932"></span><span>       </span><span class="hs-comment">-- tyR = forall (a2 :: k2). ty2</span><span>
</span><span id="line-2933"></span><span>
</span><span id="line-2934"></span><span>    </span><span id="local-6989586621682708111"><span class="annot"><span class="annottext">co1 :: Coercion
</span><a href="#local-6989586621682708111"><span class="hs-identifier hs-var hs-var">co1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelForAll"><span class="hs-identifier hs-var">SelForAll</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708104"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2935"></span><span>       </span><span class="hs-comment">-- co1 :: k2 ~N k1</span><span>
</span><span id="line-2936"></span><span>       </span><span class="hs-comment">-- Note that SelCo extracts a Nominal equality between the</span><span>
</span><span id="line-2937"></span><span>       </span><span class="hs-comment">-- kinds of the types related by a coercion between forall-types.</span><span>
</span><span id="line-2938"></span><span>       </span><span class="hs-comment">-- See the SelCo case in GHC.Core.Lint.</span><span>
</span><span id="line-2939"></span><span>
</span><span id="line-2940"></span><span>    </span><span id="local-6989586621682708112"><span class="annot"><span class="annottext">co2 :: Coercion
</span><a href="#local-6989586621682708112"><span class="hs-identifier hs-var hs-var">co2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708104"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkGReflLeftCo"><span class="hs-identifier hs-var">mkGReflLeftCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708105"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708111"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2941"></span><span>        </span><span class="hs-comment">-- co2 :: ty1[ (ty|&gt;co1)/a1 ] ~R ty2[ ty/a2 ]</span><span>
</span><span id="line-2942"></span><span>        </span><span class="hs-comment">-- Arg of mkInstCo is always nominal, hence Nominal</span><span>
</span><span id="line-2943"></span><span>
</span><span id="line-2944"></span><span class="hs-comment">-- | If @pushCoValArg co = Just (co_arg, co_res)@, then</span><span>
</span><span id="line-2945"></span><span class="hs-comment">--</span><span>
</span><span id="line-2946"></span><span class="hs-comment">-- &gt; (\x.body) |&gt; co  =  (\y. let { x = y |&gt; co_arg } in body) |&gt; co_res)</span><span>
</span><span id="line-2947"></span><span class="hs-comment">--</span><span>
</span><span id="line-2948"></span><span class="hs-comment">-- or, equivalently</span><span>
</span><span id="line-2949"></span><span class="hs-comment">--</span><span>
</span><span id="line-2950"></span><span class="hs-comment">-- &gt; (fun |&gt; co) arg  =  (fun (arg |&gt; co_arg)) |&gt; co_res</span><span>
</span><span id="line-2951"></span><span class="hs-comment">--</span><span>
</span><span id="line-2952"></span><span class="hs-comment">-- If the LHS is well-typed, then so is the RHS. In particular, the argument</span><span>
</span><span id="line-2953"></span><span class="hs-comment">-- @arg |&gt; co_arg@ is guaranteed to have a fixed 'RuntimeRep', in the sense of</span><span>
</span><span id="line-2954"></span><span class="hs-comment">-- Note [Fixed RuntimeRep] in GHC.Tc.Utils.Concrete.</span><span>
</span><span id="line-2955"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier hs-type">pushCoValArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2956"></span><span id="pushCoValArg"><span class="annot"><span class="annottext">pushCoValArg :: Coercion -&gt; Maybe (MCoercionR, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier hs-var hs-var">pushCoValArg</span></a></span></span><span> </span><span id="local-6989586621682708120"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708120"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-2957"></span><span>  </span><span class="hs-comment">-- The following is inefficient - don't do `eqType` here, the coercion</span><span>
</span><span id="line-2958"></span><span>  </span><span class="hs-comment">-- optimizer will take care of it. See #14737.</span><span>
</span><span id="line-2959"></span><span>  </span><span class="hs-comment">-- -- | tyL `eqType` tyR</span><span>
</span><span id="line-2960"></span><span>  </span><span class="hs-comment">-- -- = Just (mkRepReflCo arg, Nothing)</span><span>
</span><span id="line-2961"></span><span>
</span><span id="line-2962"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708120"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2963"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MCoercionR, MCoercionR) -&gt; Maybe (MCoercionR, MCoercionR)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2964"></span><span>
</span><span id="line-2965"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708122"><span class="hs-identifier hs-var">tyL</span></a></span><span>
</span><span id="line-2966"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708123"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708123"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708124"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708124"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; (Coercion, Coercion, Coercion)
Coercion -&gt; (Coercion, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708120"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2967"></span><span>      </span><span class="hs-comment">-- If   co  :: (tyL1 -&gt; tyL2) ~ (tyR1 -&gt; tyR2)</span><span>
</span><span id="line-2968"></span><span>      </span><span class="hs-comment">-- then co1 :: tyL1 ~ tyR1</span><span>
</span><span id="line-2969"></span><span>      </span><span class="hs-comment">--      co2 :: tyL2 ~ tyR2</span><span>
</span><span id="line-2970"></span><span>
</span><span id="line-2971"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#typeHasFixedRuntimeRep"><span class="hs-identifier hs-var">typeHasFixedRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708126"><span class="hs-identifier hs-var">new_arg_ty</span></a></span><span>
</span><span id="line-2972"></span><span>    </span><span class="hs-comment">-- We can't push the coercion inside if it would give rise to</span><span>
</span><span id="line-2973"></span><span>    </span><span class="hs-comment">-- a representation-polymorphic argument.</span><span>
</span><span id="line-2974"></span><span>
</span><span id="line-2975"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; Maybe (MCoercionR, MCoercionR)
-&gt; Maybe (MCoercionR, MCoercionR)
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708122"><span class="hs-identifier hs-var">tyL</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708127"><span class="hs-identifier hs-var">tyR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2976"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;co:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708120"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2977"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;old_arg_ty:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708129"><span class="hs-identifier hs-var">old_arg_ty</span></a></span><span>
</span><span id="line-2978"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;new_arg_ty:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708126"><span class="hs-identifier hs-var">new_arg_ty</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (MCoercionR, MCoercionR) -&gt; Maybe (MCoercionR, MCoercionR))
-&gt; Maybe (MCoercionR, MCoercionR) -&gt; Maybe (MCoercionR, MCoercionR)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2979"></span><span>    </span><span class="annot"><span class="annottext">(MCoercionR, MCoercionR) -&gt; Maybe (MCoercionR, MCoercionR)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#coToMCo"><span class="hs-identifier hs-var">coToMCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708123"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#coToMCo"><span class="hs-identifier hs-var">coToMCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708124"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2980"></span><span>    </span><span class="hs-comment">-- Critically, coToMCo to checks for ReflCo; the whole coercion may not</span><span>
</span><span id="line-2981"></span><span>    </span><span class="hs-comment">-- be reflexive, but either of its components might be</span><span>
</span><span id="line-2982"></span><span>    </span><span class="hs-comment">-- We could use isReflexiveCo, but it's not clear if the benefit</span><span>
</span><span id="line-2983"></span><span>    </span><span class="hs-comment">-- is worth the cost, and it makes no difference in #18223</span><span>
</span><span id="line-2984"></span><span>
</span><span id="line-2985"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2986"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (MCoercionR, MCoercionR)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2987"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2988"></span><span>    </span><span id="local-6989586621682708129"><span class="annot"><span class="annottext">old_arg_ty :: Type
</span><a href="#local-6989586621682708129"><span class="hs-identifier hs-var hs-var">old_arg_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#funArgTy"><span class="hs-identifier hs-var">funArgTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708127"><span class="hs-identifier hs-var">tyR</span></a></span><span>
</span><span id="line-2989"></span><span>    </span><span id="local-6989586621682708126"><span class="annot"><span class="annottext">new_arg_ty :: Type
</span><a href="#local-6989586621682708126"><span class="hs-identifier hs-var hs-var">new_arg_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#funArgTy"><span class="hs-identifier hs-var">funArgTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708122"><span class="hs-identifier hs-var">tyL</span></a></span><span>
</span><span id="line-2990"></span><span>    </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682708122"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708122"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621682708127"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708127"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708120"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2991"></span><span>
</span><span id="line-2992"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoercionIntoLambda"><span class="hs-identifier hs-type">pushCoercionIntoLambda</span></a></span><span>
</span><span id="line-2993"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2994"></span><span class="hs-comment">-- This implements the Push rule from the paper on coercions</span><span>
</span><span id="line-2995"></span><span class="hs-comment">--    (\x. e) |&gt; co</span><span>
</span><span id="line-2996"></span><span class="hs-comment">-- ===&gt;</span><span>
</span><span id="line-2997"></span><span class="hs-comment">--    (\x'. e |&gt; co')</span><span>
</span><span id="line-2998"></span><span id="pushCoercionIntoLambda"><span class="annot"><span class="annottext">pushCoercionIntoLambda :: HasDebugCallStack =&gt;
InScopeSet
-&gt; TyVar -&gt; CoreExpr -&gt; Coercion -&gt; Maybe (TyVar, CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#pushCoercionIntoLambda"><span class="hs-identifier hs-var hs-var">pushCoercionIntoLambda</span></a></span></span><span> </span><span id="local-6989586621682708141"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682708141"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682708142"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708142"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621682708143"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708143"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682708144"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708144"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-2999"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708142"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708142"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3000"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682708146"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708146"><span class="hs-identifier hs-var">s1s2</span></a></span></span><span> </span><span id="local-6989586621682708147"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708147"><span class="hs-identifier hs-var">t1t2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708144"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3001"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (FunTyFlag, Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708146"><span class="hs-identifier hs-var">s1s2</span></a></span><span>
</span><span id="line-3002"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708148"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708148"><span class="hs-identifier hs-var">w1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708149"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708149"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682708150"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708150"><span class="hs-identifier hs-var">_t2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (FunTyFlag, Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708147"><span class="hs-identifier hs-var">t1t2</span></a></span><span>
</span><span id="line-3003"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708151"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708151"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708152"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708152"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; (Coercion, Coercion, Coercion)
Coercion -&gt; (Coercion, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708144"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3004"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#typeHasFixedRuntimeRep"><span class="hs-identifier hs-var">typeHasFixedRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708149"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-3005"></span><span>      </span><span class="hs-comment">-- We can't push the coercion into the lambda if it would create</span><span>
</span><span id="line-3006"></span><span>      </span><span class="hs-comment">-- a representation-polymorphic binder.</span><span>
</span><span id="line-3007"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-3008"></span><span>          </span><span class="hs-comment">-- Should we optimize the coercions here?</span><span>
</span><span id="line-3009"></span><span>          </span><span class="hs-comment">-- Otherwise they might not match too well</span><span>
</span><span id="line-3010"></span><span>          </span><span id="local-6989586621682708153"><span class="annot"><span class="annottext">x' :: TyVar
</span><a href="#local-6989586621682708153"><span class="hs-identifier hs-var hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708142"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type -&gt; TyVar
</span><a href="GHC.Types.Id.html#setIdType"><span class="hs-operator hs-var">`setIdType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708149"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type -&gt; TyVar
</span><a href="GHC.Types.Var.html#setIdMult"><span class="hs-operator hs-var">`setIdMult`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708148"><span class="hs-identifier hs-var">w1</span></a></span><span>
</span><span id="line-3011"></span><span>          </span><span id="local-6989586621682708156"><span class="annot"><span class="annottext">in_scope' :: InScopeSet
</span><a href="#local-6989586621682708156"><span class="hs-identifier hs-var hs-var">in_scope'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682708141"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TyVar -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708153"><span class="hs-identifier hs-var">x'</span></a></span><span>
</span><span id="line-3012"></span><span>          </span><span id="local-6989586621682708157"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621682708157"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; TyVar -&gt; CoreExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682708156"><span class="hs-identifier hs-var">in_scope'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3013"></span><span>                                </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708142"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3014"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; CoreExpr
forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708153"><span class="hs-identifier hs-var">x'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708151"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3015"></span><span>            </span><span class="hs-comment">-- We substitute x' for x, except we need to preserve types.</span><span>
</span><span id="line-3016"></span><span>            </span><span class="hs-comment">-- The types are as follows:</span><span>
</span><span id="line-3017"></span><span>            </span><span class="hs-comment">--   x :: s1,  x' :: t1,  co1 :: s1 ~# t1,</span><span>
</span><span id="line-3018"></span><span>            </span><span class="hs-comment">-- so we extend the substitution with x |-&gt; (x' |&gt; sym co1).</span><span>
</span><span id="line-3019"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(TyVar, CoreExpr) -&gt; Maybe (TyVar, CoreExpr)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708153"><span class="hs-identifier hs-var">x'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708157"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708143"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-operator hs-var">`mkCast`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708152"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3020"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3021"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TyVar, CoreExpr)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3022"></span><span>
</span><span id="line-3023"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoDataCon"><span class="hs-identifier hs-type">pushCoDataCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span>
</span><span id="line-3024"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span>
</span><span id="line-3025"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Universal type args</span><span>
</span><span id="line-3026"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- All other args incl existentials</span><span>
</span><span id="line-3027"></span><span class="hs-comment">-- Implement the KPush reduction rule as described in &quot;Down with kinds&quot;</span><span>
</span><span id="line-3028"></span><span class="hs-comment">-- The transformation applies iff we have</span><span>
</span><span id="line-3029"></span><span class="hs-comment">--      (C e1 ... en) `cast` co</span><span>
</span><span id="line-3030"></span><span class="hs-comment">-- where co :: (T t1 .. tn) ~ to_ty</span><span>
</span><span id="line-3031"></span><span class="hs-comment">-- The left-hand one must be a T, because exprIsConApp returned True</span><span>
</span><span id="line-3032"></span><span class="hs-comment">-- but the right-hand one might not be.  (Though it usually will.)</span><span>
</span><span id="line-3033"></span><span id="pushCoDataCon"><span class="annot"><span class="annottext">pushCoDataCon :: DataCon
-&gt; [CoreExpr] -&gt; MCoercionR -&gt; Maybe (DataCon, [Type], [CoreExpr])
</span><a href="GHC.Core.Opt.Arity.html#pushCoDataCon"><span class="hs-identifier hs-var hs-var">pushCoDataCon</span></a></span></span><span> </span><span id="local-6989586621682708160"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708160"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span id="local-6989586621682708161"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708161"><span class="hs-identifier hs-var">dc_args</span></a></span></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DataCon, [Type], [CoreExpr])
-&gt; Maybe (DataCon, [Type], [CoreExpr])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">((DataCon, [Type], [CoreExpr])
 -&gt; Maybe (DataCon, [Type], [CoreExpr]))
-&gt; (DataCon, [Type], [CoreExpr])
-&gt; Maybe (DataCon, [Type], [CoreExpr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [CoreExpr] -&gt; (DataCon, [Type], [CoreExpr])
</span><a href="GHC.Core.Opt.Arity.html#push_dc_refl"><span class="hs-identifier hs-var">push_dc_refl</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708160"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708161"><span class="hs-identifier hs-var">dc_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3034"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoDataCon"><span class="hs-identifier hs-var">pushCoDataCon</span></a></span><span> </span><span id="local-6989586621682708164"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708164"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span id="local-6989586621682708165"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708165"><span class="hs-identifier hs-var">dc_args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682708166"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708166"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon
-&gt; [CoreExpr]
-&gt; Coercion
-&gt; Pair Type
-&gt; Maybe (DataCon, [Type], [CoreExpr])
</span><a href="GHC.Core.Opt.Arity.html#push_dc_gen"><span class="hs-identifier hs-var">push_dc_gen</span></a></span><span>  </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708164"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708165"><span class="hs-identifier hs-var">dc_args</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708166"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708166"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3035"></span><span>
</span><span id="line-3036"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#push_dc_refl"><span class="hs-identifier hs-type">push_dc_refl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3037"></span><span id="push_dc_refl"><span class="annot"><span class="annottext">push_dc_refl :: DataCon -&gt; [CoreExpr] -&gt; (DataCon, [Type], [CoreExpr])
</span><a href="GHC.Core.Opt.Arity.html#push_dc_refl"><span class="hs-identifier hs-var hs-var">push_dc_refl</span></a></span></span><span> </span><span id="local-6989586621682708168"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708168"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span id="local-6989586621682708169"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708169"><span class="hs-identifier hs-var">dc_args</span></a></span></span><span>
</span><span id="line-3038"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708168"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; Type) -&gt; [CoreExpr] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708171"><span class="hs-identifier hs-var">univ_ty_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708172"><span class="hs-identifier hs-var">rest_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3039"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3040"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682708171"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708171"><span class="hs-identifier hs-var">univ_ty_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708172"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708172"><span class="hs-identifier hs-var">rest_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [CoreExpr] -&gt; ([CoreExpr], [CoreExpr])
forall b a. [b] -&gt; [a] -&gt; ([a], [a])
</span><a href="GHC.Utils.Misc.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [TyVar]
</span><a href="GHC.Core.DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708168"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708169"><span class="hs-identifier hs-var">dc_args</span></a></span><span>
</span><span id="line-3041"></span><span>
</span><span id="line-3042"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#push_dc_gen"><span class="hs-identifier hs-type">push_dc_gen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-3043"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3044"></span><span id="push_dc_gen"><span class="annot"><span class="annottext">push_dc_gen :: DataCon
-&gt; [CoreExpr]
-&gt; Coercion
-&gt; Pair Type
-&gt; Maybe (DataCon, [Type], [CoreExpr])
</span><a href="GHC.Core.Opt.Arity.html#push_dc_gen"><span class="hs-identifier hs-var hs-var">push_dc_gen</span></a></span></span><span> </span><span id="local-6989586621682708175"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708175"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span id="local-6989586621682708176"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708176"><span class="hs-identifier hs-var">dc_args</span></a></span></span><span> </span><span id="local-6989586621682708177"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708177"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682708178"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708178"><span class="hs-identifier hs-var">from_ty</span></a></span></span><span> </span><span id="local-6989586621682708179"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708179"><span class="hs-identifier hs-var">to_ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3045"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708178"><span class="hs-identifier hs-var">from_ty</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708179"><span class="hs-identifier hs-var">to_ty</span></a></span><span>  </span><span class="hs-comment">-- try cheap test first</span><span>
</span><span id="line-3046"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DataCon, [Type], [CoreExpr])
-&gt; Maybe (DataCon, [Type], [CoreExpr])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">((DataCon, [Type], [CoreExpr])
 -&gt; Maybe (DataCon, [Type], [CoreExpr]))
-&gt; (DataCon, [Type], [CoreExpr])
-&gt; Maybe (DataCon, [Type], [CoreExpr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [CoreExpr] -&gt; (DataCon, [Type], [CoreExpr])
</span><a href="GHC.Core.Opt.Arity.html#push_dc_refl"><span class="hs-identifier hs-var">push_dc_refl</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708175"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708176"><span class="hs-identifier hs-var">dc_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3047"></span><span>
</span><span id="line-3048"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708180"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682708180"><span class="hs-identifier hs-var">to_tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708181"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682708181"><span class="hs-identifier hs-var">to_tc_arg_tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708179"><span class="hs-identifier hs-var">to_ty</span></a></span><span>
</span><span id="line-3049"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682708180"><span class="hs-identifier hs-var">to_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; TyCon
</span><a href="GHC.Core.DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708175"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-3050"></span><span>        </span><span class="hs-comment">-- These two tests can fail; we might see</span><span>
</span><span id="line-3051"></span><span>        </span><span class="hs-comment">--      (C x y) `cast` (g :: T a ~ S [a]),</span><span>
</span><span id="line-3052"></span><span>        </span><span class="hs-comment">-- where S is a type function.  In fact, exprIsConApp</span><span>
</span><span id="line-3053"></span><span>        </span><span class="hs-comment">-- will probably not be called in such circumstances,</span><span>
</span><span id="line-3054"></span><span>        </span><span class="hs-comment">-- but there's nothing wrong with it</span><span>
</span><span id="line-3055"></span><span>
</span><span id="line-3056"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-3057"></span><span>        </span><span id="local-6989586621682708183"><span class="annot"><span class="annottext">tc_arity :: Int
</span><a href="#local-6989586621682708183"><span class="hs-identifier hs-var hs-var">tc_arity</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Int
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682708180"><span class="hs-identifier hs-var">to_tc</span></a></span><span>
</span><span id="line-3058"></span><span>        </span><span id="local-6989586621682708184"><span class="annot"><span class="annottext">dc_univ_tyvars :: [TyVar]
</span><a href="#local-6989586621682708184"><span class="hs-identifier hs-var hs-var">dc_univ_tyvars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [TyVar]
</span><a href="GHC.Core.DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708175"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-3059"></span><span>        </span><span id="local-6989586621682708185"><span class="annot"><span class="annottext">dc_ex_tcvars :: [TyVar]
</span><a href="#local-6989586621682708185"><span class="hs-identifier hs-var hs-var">dc_ex_tcvars</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [TyVar]
</span><a href="GHC.Core.DataCon.html#dataConExTyCoVars"><span class="hs-identifier hs-var">dataConExTyCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708175"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-3060"></span><span>        </span><span id="local-6989586621682708187"><span class="annot"><span class="annottext">arg_tys :: [Scaled Type]
</span><a href="#local-6989586621682708187"><span class="hs-identifier hs-var hs-var">arg_tys</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [Scaled Type]
</span><a href="GHC.Core.DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708175"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-3061"></span><span>
</span><span id="line-3062"></span><span>        </span><span id="local-6989586621682708189"><span class="annot"><span class="annottext">non_univ_args :: [CoreExpr]
</span><a href="#local-6989586621682708189"><span class="hs-identifier hs-var hs-var">non_univ_args</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [CoreExpr] -&gt; [CoreExpr]
forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#dropList"><span class="hs-identifier hs-var">dropList</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708184"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708176"><span class="hs-identifier hs-var">dc_args</span></a></span><span>
</span><span id="line-3063"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682708190"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708190"><span class="hs-identifier hs-var">ex_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708191"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708191"><span class="hs-identifier hs-var">val_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [CoreExpr] -&gt; ([CoreExpr], [CoreExpr])
forall b a. [b] -&gt; [a] -&gt; ([a], [a])
</span><a href="GHC.Utils.Misc.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708185"><span class="hs-identifier hs-var">dc_ex_tcvars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708189"><span class="hs-identifier hs-var">non_univ_args</span></a></span><span>
</span><span id="line-3064"></span><span>
</span><span id="line-3065"></span><span>        </span><span class="hs-comment">-- Make the &quot;Psi&quot; from the paper</span><span>
</span><span id="line-3066"></span><span>        </span><span id="local-6989586621682708192"><span class="annot"><span class="annottext">omegas :: [Coercion]
</span><a href="#local-6989586621682708192"><span class="hs-identifier hs-var hs-var">omegas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Coercion -&gt; Infinite Role -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.html#decomposeCo"><span class="hs-identifier hs-var">decomposeCo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708183"><span class="hs-identifier hs-var">tc_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708177"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Infinite Role
</span><a href="GHC.Core.Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682708180"><span class="hs-identifier hs-var">to_tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3067"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682708195"><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="#local-6989586621682708195"><span class="hs-identifier hs-var">psi_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708196"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682708196"><span class="hs-identifier hs-var">to_ex_arg_tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3068"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
-&gt; [TyVar]
-&gt; [Coercion]
-&gt; [TyVar]
-&gt; [Type]
-&gt; (Type -&gt; Coercion, [Type])
</span><a href="GHC.Core.Coercion.html#liftCoSubstWithEx"><span class="hs-identifier hs-var">liftCoSubstWithEx</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span>
</span><span id="line-3069"></span><span>                              </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708184"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a></span><span>
</span><span id="line-3070"></span><span>                              </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682708192"><span class="hs-identifier hs-var">omegas</span></a></span><span>
</span><span id="line-3071"></span><span>                              </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708185"><span class="hs-identifier hs-var">dc_ex_tcvars</span></a></span><span>
</span><span id="line-3072"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreExpr -&gt; Type) -&gt; [CoreExpr] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708190"><span class="hs-identifier hs-var">ex_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3073"></span><span>
</span><span id="line-3074"></span><span>          </span><span class="hs-comment">-- Cast the value arguments (which include dictionaries)</span><span>
</span><span id="line-3075"></span><span>        </span><span id="local-6989586621682708198"><span class="annot"><span class="annottext">new_val_args :: [CoreExpr]
</span><a href="#local-6989586621682708198"><span class="hs-identifier hs-var hs-var">new_val_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; CoreExpr -&gt; CoreExpr)
-&gt; [Type] -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682708200"><span class="hs-identifier hs-var">cast_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Scaled Type -&gt; Type) -&gt; [Scaled Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Scaled Type -&gt; Type
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621682708187"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708191"><span class="hs-identifier hs-var">val_args</span></a></span><span>
</span><span id="line-3076"></span><span>        </span><span id="local-6989586621682708200"><span class="annot"><span class="annottext">cast_arg :: Type -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682708200"><span class="hs-identifier hs-var hs-var">cast_arg</span></a></span></span><span> </span><span id="local-6989586621682708202"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708202"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span> </span><span id="local-6989586621682708203"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708203"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708203"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="#local-6989586621682708195"><span class="hs-identifier hs-var">psi_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708202"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3077"></span><span>
</span><span id="line-3078"></span><span>        </span><span id="local-6989586621682708204"><span class="annot"><span class="annottext">to_ex_args :: [CoreExpr]
</span><a href="#local-6989586621682708204"><span class="hs-identifier hs-var hs-var">to_ex_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; CoreExpr) -&gt; [Type] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682708196"><span class="hs-identifier hs-var">to_ex_arg_tys</span></a></span><span>
</span><span id="line-3079"></span><span>
</span><span id="line-3080"></span><span>        </span><span id="local-6989586621682708205"><span class="annot"><span class="annottext">dump_doc :: SDoc
</span><a href="#local-6989586621682708205"><span class="hs-identifier hs-var hs-var">dump_doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DataCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708175"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">,</span><span>      </span><span class="annot"><span class="annottext">[TyVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708184"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708185"><span class="hs-identifier hs-var">dc_ex_tcvars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3081"></span><span>                         </span><span class="annot"><span class="annottext">[Scaled Type] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621682708187"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708176"><span class="hs-identifier hs-var">dc_args</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3082"></span><span>                         </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708190"><span class="hs-identifier hs-var">ex_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708191"><span class="hs-identifier hs-var">val_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708177"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708178"><span class="hs-identifier hs-var">from_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708179"><span class="hs-identifier hs-var">to_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682708180"><span class="hs-identifier hs-var">to_tc</span></a></span><span>
</span><span id="line-3083"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; SDoc) -&gt; Type -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682708180"><span class="hs-identifier hs-var">to_tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreExpr -&gt; Type) -&gt; [CoreExpr] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a></span><span> </span><span class="annot"><span class="annottext">([CoreExpr] -&gt; [Type]) -&gt; [CoreExpr] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [CoreExpr] -&gt; [CoreExpr]
forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#takeList"><span class="hs-identifier hs-var">takeList</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708184"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708176"><span class="hs-identifier hs-var">dc_args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-3084"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-3085"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; Maybe (DataCon, [Type], [CoreExpr])
-&gt; Maybe (DataCon, [Type], [CoreExpr])
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier hs-var">eqType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708178"><span class="hs-identifier hs-var">from_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682708180"><span class="hs-identifier hs-var">to_tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreExpr -&gt; Type) -&gt; [CoreExpr] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a></span><span> </span><span class="annot"><span class="annottext">([CoreExpr] -&gt; [Type]) -&gt; [CoreExpr] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [CoreExpr] -&gt; [CoreExpr]
forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#takeList"><span class="hs-identifier hs-var">takeList</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708184"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708176"><span class="hs-identifier hs-var">dc_args</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682708205"><span class="hs-identifier hs-var">dump_doc</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (DataCon, [Type], [CoreExpr])
 -&gt; Maybe (DataCon, [Type], [CoreExpr]))
-&gt; Maybe (DataCon, [Type], [CoreExpr])
-&gt; Maybe (DataCon, [Type], [CoreExpr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3086"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; Maybe (DataCon, [Type], [CoreExpr])
-&gt; Maybe (DataCon, [Type], [CoreExpr])
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreExpr] -&gt; [Scaled Type] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708191"><span class="hs-identifier hs-var">val_args</span></a></span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621682708187"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682708205"><span class="hs-identifier hs-var">dump_doc</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (DataCon, [Type], [CoreExpr])
 -&gt; Maybe (DataCon, [Type], [CoreExpr]))
-&gt; Maybe (DataCon, [Type], [CoreExpr])
-&gt; Maybe (DataCon, [Type], [CoreExpr])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3087"></span><span>    </span><span class="annot"><span class="annottext">(DataCon, [Type], [CoreExpr])
-&gt; Maybe (DataCon, [Type], [CoreExpr])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682708175"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682708181"><span class="hs-identifier hs-var">to_tc_arg_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708204"><span class="hs-identifier hs-var">to_ex_args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708198"><span class="hs-identifier hs-var">new_val_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3088"></span><span>
</span><span id="line-3089"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3090"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (DataCon, [Type], [CoreExpr])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-3091"></span><span>
</span><span id="line-3092"></span><span>
</span><span id="line-3093"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#collectBindersPushingCo"><span class="hs-identifier hs-type">collectBindersPushingCo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3094"></span><span class="hs-comment">-- Collect lambda binders, pushing coercions inside if possible</span><span>
</span><span id="line-3095"></span><span class="hs-comment">-- E.g.   (\x.e) |&gt; g         g :: &lt;Int&gt; -&gt; blah</span><span>
</span><span id="line-3096"></span><span class="hs-comment">--        = (\x. e |&gt; SelCo (SelFun SelRes) g)</span><span>
</span><span id="line-3097"></span><span class="hs-comment">--</span><span>
</span><span id="line-3098"></span><span class="hs-comment">-- That is,</span><span>
</span><span id="line-3099"></span><span class="hs-comment">--</span><span>
</span><span id="line-3100"></span><span class="hs-comment">-- collectBindersPushingCo ((\x.e) |&gt; g) === ([x], e |&gt; SelCo (SelFun SelRes) g)</span><span>
</span><span id="line-3101"></span><span id="collectBindersPushingCo"><span class="annot"><span class="annottext">collectBindersPushingCo :: CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#collectBindersPushingCo"><span class="hs-identifier hs-var hs-var">collectBindersPushingCo</span></a></span></span><span> </span><span id="local-6989586621682708208"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708208"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-3102"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708209"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708208"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-3103"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3104"></span><span>    </span><span class="hs-comment">-- Peel off lambdas until we hit a cast.</span><span>
</span><span id="line-3105"></span><span>    </span><span class="annot"><a href="#local-6989586621682708209"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3106"></span><span>    </span><span class="hs-comment">-- The accumulator is in reverse order</span><span>
</span><span id="line-3107"></span><span>    </span><span id="local-6989586621682708209"><span class="annot"><span class="annottext">go :: [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708209"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682708210"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708210"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682708211"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708211"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682708212"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708212"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708209"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708211"><span class="hs-identifier hs-var">b</span></a></span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708210"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708212"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-3108"></span><span>    </span><span class="annot"><a href="#local-6989586621682708209"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682708213"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708213"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682708214"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708214"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682708215"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708215"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708216"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708213"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708214"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708215"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3109"></span><span>    </span><span class="annot"><a href="#local-6989586621682708209"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682708217"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708217"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682708218"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708218"><span class="hs-identifier hs-var">e</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708217"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708218"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3110"></span><span>
</span><span id="line-3111"></span><span>    </span><span class="hs-comment">-- We are in a cast; peel off casts until we hit a lambda.</span><span>
</span><span id="line-3112"></span><span>    </span><span class="annot"><a href="#local-6989586621682708216"><span class="hs-identifier hs-type">go_c</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3113"></span><span>    </span><span class="hs-comment">-- (go_c bs e c) is same as (go bs e (e |&gt; c))</span><span>
</span><span id="line-3114"></span><span>    </span><span id="local-6989586621682708216"><span class="annot"><span class="annottext">go_c :: [TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708216"><span class="hs-identifier hs-var hs-var">go_c</span></a></span></span><span> </span><span id="local-6989586621682708219"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708219"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682708220"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708220"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682708221"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708221"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682708222"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708222"><span class="hs-identifier hs-var">co2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708216"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708219"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708220"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708221"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708222"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3115"></span><span>    </span><span class="annot"><a href="#local-6989586621682708216"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span id="local-6989586621682708223"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708223"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682708224"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708224"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682708225"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708225"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>    </span><span id="local-6989586621682708226"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708226"><span class="hs-identifier hs-var">co</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; TyVar -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708227"><span class="hs-identifier hs-var">go_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708223"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708224"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708225"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708226"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3116"></span><span>    </span><span class="annot"><a href="#local-6989586621682708216"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span id="local-6989586621682708228"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708228"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682708229"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708229"><span class="hs-identifier hs-var">e</span></a></span></span><span>            </span><span id="local-6989586621682708230"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708230"><span class="hs-identifier hs-var">co</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708228"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708229"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708230"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3117"></span><span>
</span><span id="line-3118"></span><span>    </span><span class="hs-comment">-- We are in a lambda under a cast; peel off lambdas and build a</span><span>
</span><span id="line-3119"></span><span>    </span><span class="hs-comment">-- new coercion for the body.</span><span>
</span><span id="line-3120"></span><span>    </span><span class="annot"><a href="#local-6989586621682708227"><span class="hs-identifier hs-type">go_lam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3121"></span><span>    </span><span class="hs-comment">-- (go_lam bs b e c) is same as (go_c bs (\b.e) c)</span><span>
</span><span id="line-3122"></span><span>    </span><span id="local-6989586621682708227"><span class="annot"><span class="annottext">go_lam :: [TyVar] -&gt; TyVar -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708227"><span class="hs-identifier hs-var hs-var">go_lam</span></a></span></span><span> </span><span id="local-6989586621682708231"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708231"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682708232"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682708233"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708233"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682708234"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-3123"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-3124"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682708235"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708235"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621682708236"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708236"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3125"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708235"><span class="hs-identifier hs-var">tyL</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3126"></span><span>        </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708236"><span class="hs-identifier hs-var">tyR</span></a></span><span>
</span><span id="line-3127"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelForAll"><span class="hs-identifier hs-var">SelForAll</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><span id="line-3128"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708216"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708231"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708233"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3129"></span><span>
</span><span id="line-3130"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-3131"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682708238"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708238"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621682708239"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708239"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3132"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy_co"><span class="hs-identifier hs-var">isForAllTy_co</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708238"><span class="hs-identifier hs-var">tyL</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3133"></span><span>        </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy_co"><span class="hs-identifier hs-var">isForAllTy_co</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708239"><span class="hs-identifier hs-var">tyR</span></a></span><span>
</span><span id="line-3134"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelForAll"><span class="hs-identifier hs-var">SelForAll</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><span id="line-3135"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682708241"><span class="annot"><span class="annottext">cov :: Coercion
</span><a href="#local-6989586621682708241"><span class="hs-identifier hs-var hs-var">cov</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-3136"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708216"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708231"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708233"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Type
</span><a href="GHC.Core.Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708241"><span class="hs-identifier hs-var">cov</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3137"></span><span>
</span><span id="line-3138"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-3139"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682708244"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708244"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621682708245"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708245"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3140"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708244"><span class="hs-identifier hs-var">tyL</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708245"><span class="hs-identifier hs-var">tyR</span></a></span><span>
</span><span id="line-3141"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708246"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708246"><span class="hs-identifier hs-var">co_mult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708247"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708247"><span class="hs-identifier hs-var">co_arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708248"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708248"><span class="hs-identifier hs-var">co_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; (Coercion, Coercion, Coercion)
Coercion -&gt; (Coercion, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3142"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708246"><span class="hs-identifier hs-var">co_mult</span></a></span><span> </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><span id="line-3143"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708247"><span class="hs-identifier hs-var">co_arg</span></a></span><span>  </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><span id="line-3144"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708216"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708231"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708233"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708248"><span class="hs-identifier hs-var">co_res</span></a></span><span>
</span><span id="line-3145"></span><span>
</span><span id="line-3146"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708231"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Coercion -&gt; CoreExpr
CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708232"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708233"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682708234"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3147"></span><span>
</span><span id="line-3148"></span><span class="hs-comment">{-

Note [collectBindersPushingCo]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We just look for coercions of form
   &lt;type&gt; % w -&gt; blah
(and similarly for foralls) to keep this function simple.  We could do
more elaborate stuff, but it'd involve substitution etc.

-}</span><span>
</span><span id="line-3158"></span><span>
</span><span id="line-3159"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                Join points
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-3164"></span><span>
</span><span id="line-3165"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-3166"></span><span class="hs-comment">-- | Split an expression into the given number of binders and a body,</span><span>
</span><span id="line-3167"></span><span class="hs-comment">-- eta-expanding if necessary. Counts value *and* type binders.</span><span>
</span><span id="line-3168"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPoint"><span class="hs-identifier hs-type">etaExpandToJoinPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3169"></span><span id="etaExpandToJoinPoint"><span class="annot"><span class="annottext">etaExpandToJoinPoint :: Int -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPoint"><span class="hs-identifier hs-var hs-var">etaExpandToJoinPoint</span></a></span></span><span> </span><span id="local-6989586621682708250"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708250"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span id="local-6989586621682708251"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708251"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-3170"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708252"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708250"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708251"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-3171"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3172"></span><span>    </span><span id="local-6989586621682708252"><span class="annot"><span class="annottext">go :: Int -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708252"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621682708257"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708257"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span id="local-6989586621682708258"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708258"><span class="hs-identifier hs-var">e</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708257"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708258"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3173"></span><span>    </span><span class="annot"><a href="#local-6989586621682708252"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682708259"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708259"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682708260"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708260"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682708261"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708261"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682708262"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708262"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708252"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708259"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708261"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708260"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708262"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-3174"></span><span>    </span><span class="annot"><a href="#local-6989586621682708252"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682708263"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708263"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682708264"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708264"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span id="local-6989586621682708265"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708265"><span class="hs-identifier hs-var">e</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#etaBodyForJoinPoint"><span class="hs-identifier hs-var">etaBodyForJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708263"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708265"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3175"></span><span>                              </span><span class="hs-special">(</span><span id="local-6989586621682708267"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708267"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708268"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708268"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708264"><span class="hs-identifier hs-var">rev_bs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708267"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708268"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3176"></span><span>
</span><span id="line-3177"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier hs-type">etaExpandToJoinPointRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span>
</span><span id="line-3178"></span><span id="etaExpandToJoinPointRule"><span class="annot"><span class="annottext">etaExpandToJoinPointRule :: Int -&gt; CoreRule -&gt; CoreRule
</span><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier hs-var hs-var">etaExpandToJoinPointRule</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682708269"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621682708269"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3179"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; CoreRule -&gt; CoreRule
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Can't eta-expand built-in rule:&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682708269"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3180"></span><span>      </span><span class="hs-comment">-- How did a local binding get a built-in rule anyway? Probably a plugin.</span><span>
</span><span id="line-3181"></span><span>    </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682708269"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-3182"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier hs-var">etaExpandToJoinPointRule</span></a></span><span> </span><span id="local-6989586621682708271"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708271"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span id="local-6989586621682708272"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621682708272"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [TyVar]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682708275"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708275"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rhs :: CoreRule -&gt; CoreExpr
</span><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682708277"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708277"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-3183"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682708279"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708279"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3184"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708280"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-3185"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682708272"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-3186"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708280"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-3187"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; CoreRule
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;etaExpandToJoinPointRule&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708271"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682708272"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3188"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3189"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682708272"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682708275"><span class="hs-identifier hs-type">bndrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682708281"><span class="hs-identifier hs-type">new_bndrs</span></a></span><span>
</span><span id="line-3190"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682708279"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682708282"><span class="hs-identifier hs-type">new_args</span></a></span><span>
</span><span id="line-3191"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682708283"><span class="hs-identifier hs-type">new_rhs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3192"></span><span>  </span><span class="hs-comment">-- new_rhs really ought to be occ-analysed (see GHC.Core Note</span><span>
</span><span id="line-3193"></span><span>  </span><span class="hs-comment">-- [OccInfo in unfoldings and rules]), but it makes a module loop to</span><span>
</span><span id="line-3194"></span><span>  </span><span class="hs-comment">-- do so; it doesn't happen often; and it doesn't really matter if</span><span>
</span><span id="line-3195"></span><span>  </span><span class="hs-comment">-- the outer binders have bogus occurrence info; and new_rhs won't</span><span>
</span><span id="line-3196"></span><span>  </span><span class="hs-comment">-- have dead code if rhs didn't.</span><span>
</span><span id="line-3197"></span><span>
</span><span id="line-3198"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3199"></span><span>    </span><span id="local-6989586621682708280"><span class="annot"><span class="annottext">need_args :: Int
</span><a href="#local-6989586621682708280"><span class="hs-identifier hs-var hs-var">need_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708271"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682708279"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-3200"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682708281"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708281"><span class="hs-identifier hs-var">new_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708283"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708283"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#etaBodyForJoinPoint"><span class="hs-identifier hs-var">etaBodyForJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708280"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708277"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3201"></span><span>    </span><span id="local-6989586621682708282"><span class="annot"><span class="annottext">new_args :: [CoreExpr]
</span><a href="#local-6989586621682708282"><span class="hs-identifier hs-var hs-var">new_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [CoreExpr]
forall b. [TyVar] -&gt; [Expr b]
</span><a href="GHC.Core.html#varsToCoreExprs"><span class="hs-identifier hs-var">varsToCoreExprs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708281"><span class="hs-identifier hs-var">new_bndrs</span></a></span><span>
</span><span id="line-3202"></span><span>
</span><span id="line-3203"></span><span class="hs-comment">-- Adds as many binders as asked for; assumes expr is not a lambda</span><span>
</span><span id="line-3204"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaBodyForJoinPoint"><span class="hs-identifier hs-type">etaBodyForJoinPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3205"></span><span id="etaBodyForJoinPoint"><span class="annot"><span class="annottext">etaBodyForJoinPoint :: Int -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#etaBodyForJoinPoint"><span class="hs-identifier hs-var hs-var">etaBodyForJoinPoint</span></a></span></span><span> </span><span id="local-6989586621682708285"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708285"><span class="hs-identifier hs-var">need_args</span></a></span></span><span> </span><span id="local-6989586621682708286"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708286"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-3206"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; Subst -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708287"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708285"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708288"><span class="hs-identifier hs-var">body_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682708289"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708286"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-3207"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3208"></span><span>    </span><span id="local-6989586621682708287"><span class="annot"><span class="annottext">go :: Int -&gt; Type -&gt; Subst -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708287"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span>  </span><span class="annot"><span class="annottext">Subst
</span><span class="hs-identifier">_</span></span><span>     </span><span id="local-6989586621682708290"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708290"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span id="local-6989586621682708291"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708291"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-3209"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [TyVar]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708290"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708291"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3210"></span><span>    </span><span class="annot"><a href="#local-6989586621682708287"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682708292"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708292"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682708293"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708293"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682708294"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708294"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682708295"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708295"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span id="local-6989586621682708296"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708296"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-3211"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708297"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708297"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708298"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708298"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (TyVar, Type)
</span><a href="GHC.Core.Type.html#splitForAllTyCoVar_maybe"><span class="hs-identifier hs-var">splitForAllTyCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708293"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3212"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708299"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708299"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708300"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708300"><span class="hs-identifier hs-var">tv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; TyVar -&gt; (Subst, TyVar)
Subst -&gt; TyVar -&gt; (Subst, TyVar)
</span><a href="GHC.Core.TyCo.Subst.html#substVarBndr"><span class="hs-identifier hs-var">substVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708294"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708297"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-3213"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; Subst -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708287"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708292"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708298"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708299"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708300"><span class="hs-identifier hs-var">tv'</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708295"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708296"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; CoreExpr
forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708300"><span class="hs-identifier hs-var">tv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3214"></span><span>        </span><span class="hs-comment">-- The varToCoreExpr is important: `tv` might be a coercion variable</span><span>
</span><span id="line-3215"></span><span>
</span><span id="line-3216"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708301"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708301"><span class="hs-identifier hs-var">mult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708302"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708302"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708303"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708303"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (FunTyFlag, Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708293"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3217"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682708304"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708304"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682708305"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708305"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Subst -&gt; Scaled Type -&gt; (Subst, TyVar)
</span><a href="GHC.Core.Opt.Arity.html#freshEtaId"><span class="hs-identifier hs-var">freshEtaId</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708292"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708294"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Scaled Type
forall a. Type -&gt; a -&gt; Scaled a
</span><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-var">Scaled</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708301"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708302"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3218"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; Subst -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621682708287"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708292"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708303"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708304"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708305"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; [TyVar] -&gt; [TyVar]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682708295"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708296"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; CoreExpr
forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708305"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3219"></span><span>        </span><span class="hs-comment">-- The varToCoreExpr is important: `b` might be a coercion variable</span><span>
</span><span id="line-3220"></span><span>
</span><span id="line-3221"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3222"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; ([TyVar], CoreExpr)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;etaBodyForJoinPoint&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; ([TyVar], CoreExpr)) -&gt; SDoc -&gt; ([TyVar], CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708285"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-3223"></span><span>                                         </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708286"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708286"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3224"></span><span>
</span><span id="line-3225"></span><span>    </span><span id="local-6989586621682708288"><span class="annot"><span class="annottext">body_ty :: Type
</span><a href="#local-6989586621682708288"><span class="hs-identifier hs-var hs-var">body_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708286"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-3226"></span><span>    </span><span id="local-6989586621682708289"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682708289"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682708286"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708288"><span class="hs-identifier hs-var">body_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3227"></span><span>    </span><span class="hs-comment">-- in_scope is a bit tricky.</span><span>
</span><span id="line-3228"></span><span>    </span><span class="hs-comment">-- - We are wrapping `body` in some value lambdas, so must not shadow</span><span>
</span><span id="line-3229"></span><span>    </span><span class="hs-comment">--   any free vars of `body`</span><span>
</span><span id="line-3230"></span><span>    </span><span class="hs-comment">-- - We are wrapping `body` in some type lambdas, so must not shadow any</span><span>
</span><span id="line-3231"></span><span>    </span><span class="hs-comment">--   tyvars in body_ty.  Example: body is just a variable</span><span>
</span><span id="line-3232"></span><span>    </span><span class="hs-comment">--            (g :: forall (a::k). T k a -&gt; Int)</span><span>
</span><span id="line-3233"></span><span>    </span><span class="hs-comment">--   We must not shadown that `k` when adding the /\a. So treat the free vars</span><span>
</span><span id="line-3234"></span><span>    </span><span class="hs-comment">--   of body_ty as in-scope.  Showed up in #23026.</span><span>
</span><span id="line-3235"></span><span>
</span><span id="line-3236"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-3237"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#freshEtaId"><span class="hs-identifier hs-type">freshEtaId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3238"></span><span class="hs-comment">-- Make a fresh Id, with specified type (after applying substitution)</span><span>
</span><span id="line-3239"></span><span class="hs-comment">-- It should be &quot;fresh&quot; in the sense that it's not in the in-scope set</span><span>
</span><span id="line-3240"></span><span class="hs-comment">-- of the TvSubstEnv; and it should itself then be added to the in-scope</span><span>
</span><span id="line-3241"></span><span class="hs-comment">-- set of the TvSubstEnv</span><span>
</span><span id="line-3242"></span><span class="hs-comment">--</span><span>
</span><span id="line-3243"></span><span class="hs-comment">-- The Int is just a reasonable starting point for generating a unique;</span><span>
</span><span id="line-3244"></span><span class="hs-comment">-- it does not necessarily have to be unique itself.</span><span>
</span><span id="line-3245"></span><span id="freshEtaId"><span class="annot"><span class="annottext">freshEtaId :: Int -&gt; Subst -&gt; Scaled Type -&gt; (Subst, TyVar)
</span><a href="GHC.Core.Opt.Arity.html#freshEtaId"><span class="hs-identifier hs-var hs-var">freshEtaId</span></a></span></span><span> </span><span id="local-6989586621682708308"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708308"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682708309"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708309"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682708310"><span class="annot"><span class="annottext">Scaled Type
</span><a href="#local-6989586621682708310"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-3246"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708311"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708312"><span class="hs-identifier hs-var">eta_id'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3247"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3248"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span id="local-6989586621682708313"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708313"><span class="hs-identifier hs-var">mult'</span></a></span></span><span> </span><span id="local-6989586621682708314"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708314"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Scaled Type -&gt; Scaled Type
Subst -&gt; Scaled Type -&gt; Scaled Type
</span><a href="GHC.Core.TyCo.Subst.html#substScaledTyUnchecked"><span class="hs-identifier hs-var">Type.substScaledTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708309"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Scaled Type
</span><a href="#local-6989586621682708310"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3249"></span><span>        </span><span id="local-6989586621682708312"><span class="annot"><span class="annottext">eta_id' :: TyVar
</span><a href="#local-6989586621682708312"><span class="hs-identifier hs-var hs-var">eta_id'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TyVar -&gt; TyVar
</span><a href="GHC.Types.Var.Env.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier hs-var">getSubstInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708309"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; TyVar) -&gt; TyVar -&gt; TyVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-3250"></span><span>                  </span><span class="annot"><span class="annottext">FastString -&gt; Unique -&gt; Type -&gt; Type -&gt; TyVar
</span><a href="GHC.Types.Id.html#mkSysLocalOrCoVar"><span class="hs-identifier hs-var">mkSysLocalOrCoVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;eta&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Unique
</span><a href="GHC.Builtin.Uniques.html#mkBuiltinUnique"><span class="hs-identifier hs-var">mkBuiltinUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682708308"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708313"><span class="hs-identifier hs-var">mult'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682708314"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-3251"></span><span>                  </span><span class="hs-comment">-- &quot;OrCoVar&quot; since this can be used to eta-expand</span><span>
</span><span id="line-3252"></span><span>                  </span><span class="hs-comment">-- coercion abstractions</span><span>
</span><span id="line-3253"></span><span>        </span><span id="local-6989586621682708311"><span class="annot"><span class="annottext">subst' :: Subst
</span><a href="#local-6989586621682708311"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; TyVar -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendSubstInScope"><span class="hs-identifier hs-var">extendSubstInScope</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682708309"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682708312"><span class="hs-identifier hs-var">eta_id'</span></a></span><span>
</span><span id="line-3254"></span></pre></body></html>