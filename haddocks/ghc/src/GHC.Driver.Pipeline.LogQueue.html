<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia #-}</span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html"><span class="hs-identifier">GHC.Driver.Pipeline.LogQueue</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier">LogQueue</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-4"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#newLogQueue"><span class="hs-identifier">newLogQueue</span></a></span><span>
</span><span id="line-5"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#finishLogQueue"><span class="hs-identifier">finishLogQueue</span></a></span><span>
</span><span id="line-6"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#writeLogQueue"><span class="hs-identifier">writeLogQueue</span></a></span><span>
</span><span id="line-7"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#parLogAction"><span class="hs-identifier">parLogAction</span></a></span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier">LogQueueQueue</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#initLogQueue"><span class="hs-identifier">initLogQueue</span></a></span><span>
</span><span id="line-11"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#allLogQueues"><span class="hs-identifier">allLogQueues</span></a></span><span>
</span><span id="line-12"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#newLogQueueQueue"><span class="hs-identifier">newLogQueueQueue</span></a></span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#logThread"><span class="hs-identifier">logThread</span></a></span><span>
</span><span id="line-15"></span><span>                                  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Concurrent.html"><span class="hs-identifier">Control.Concurrent</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Error.html"><span class="hs-identifier">GHC.Types.Error</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.html"><span class="hs-identifier">Data.IntMap</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IM</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.html"><span class="hs-identifier">Control.Concurrent.STM</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-comment">-- LogQueue Abstraction</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-comment">-- | Each module is given a unique 'LogQueue' to redirect compilation messages</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- to. A 'Nothing' value contains the result of compilation, and denotes the</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- end of the message queue.</span><span>
</span><span id="line-32"></span><span class="hs-keyword">data</span><span> </span><span id="LogQueue"><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-var">LogQueue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LogQueue"><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-var">LogQueue</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="logQueueId"><span class="annot"><span class="annottext">LogQueue -&gt; Key
</span><a href="GHC.Driver.Pipeline.LogQueue.html#logQueueId"><span class="hs-identifier hs-var hs-var">logQueueId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-33"></span><span>                         </span><span class="hs-special">,</span><span> </span><span id="logQueueMessages"><span class="annot"><span class="annottext">LogQueue -&gt; IORef [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="GHC.Driver.Pipeline.LogQueue.html#logQueueMessages"><span class="hs-identifier hs-var hs-var">logQueueMessages</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Error.html#MessageClass"><span class="hs-identifier hs-type">MessageClass</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#LogFlags"><span class="hs-identifier hs-type">LogFlags</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>                         </span><span class="hs-special">,</span><span> </span><span id="logQueueSemaphore"><span class="annot"><span class="annottext">LogQueue -&gt; MVar ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#logQueueSemaphore"><span class="hs-identifier hs-var hs-var">logQueueSemaphore</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>                         </span><span class="hs-special">}</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#newLogQueue"><span class="hs-identifier hs-type">newLogQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span>
</span><span id="line-38"></span><span id="newLogQueue"><span class="annot"><span class="annottext">newLogQueue :: Key -&gt; IO LogQueue
</span><a href="GHC.Driver.Pipeline.LogQueue.html#newLogQueue"><span class="hs-identifier hs-var hs-var">newLogQueue</span></a></span></span><span> </span><span id="local-6989586621682676067"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676067"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-39"></span><span>  </span><span id="local-6989586621682676068"><span class="annot"><a href="#local-6989586621682676068"><span class="hs-identifier hs-var">mqueue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
-&gt; IO (IORef [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)])
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-40"></span><span>  </span><span id="local-6989586621682676070"><span class="annot"><a href="#local-6989586621682676070"><span class="hs-identifier hs-var">sem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newMVar</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682676067"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682676068"><span class="hs-identifier hs-type">mqueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682676070"><span class="hs-identifier hs-type">sem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#finishLogQueue"><span class="hs-identifier hs-type">finishLogQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span id="finishLogQueue"><span class="annot"><span class="annottext">finishLogQueue :: LogQueue -&gt; IO ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#finishLogQueue"><span class="hs-identifier hs-var hs-var">finishLogQueue</span></a></span></span><span> </span><span id="local-6989586621682676072"><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676072"><span class="hs-identifier hs-var">lq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><span class="annottext">LogQueue -&gt; Maybe (MessageClass, SrcSpan, SDoc, LogFlags) -&gt; IO ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#writeLogQueueInternal"><span class="hs-identifier hs-var">writeLogQueueInternal</span></a></span><span> </span><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676072"><span class="hs-identifier hs-var">lq</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (MessageClass, SrcSpan, SDoc, LogFlags)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#writeLogQueue"><span class="hs-identifier hs-type">writeLogQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Error.html#MessageClass"><span class="hs-identifier hs-type">MessageClass</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#LogFlags"><span class="hs-identifier hs-type">LogFlags</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span id="writeLogQueue"><span class="annot"><span class="annottext">writeLogQueue :: LogQueue -&gt; (MessageClass, SrcSpan, SDoc, LogFlags) -&gt; IO ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#writeLogQueue"><span class="hs-identifier hs-var hs-var">writeLogQueue</span></a></span></span><span> </span><span id="local-6989586621682676074"><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676074"><span class="hs-identifier hs-var">lq</span></a></span></span><span> </span><span id="local-6989586621682676075"><span class="annot"><span class="annottext">(MessageClass, SrcSpan, SDoc, LogFlags)
</span><a href="#local-6989586621682676075"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><span class="annottext">LogQueue -&gt; Maybe (MessageClass, SrcSpan, SDoc, LogFlags) -&gt; IO ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#writeLogQueueInternal"><span class="hs-identifier hs-var">writeLogQueueInternal</span></a></span><span> </span><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676074"><span class="hs-identifier hs-var">lq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MessageClass, SrcSpan, SDoc, LogFlags)
-&gt; Maybe (MessageClass, SrcSpan, SDoc, LogFlags)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MessageClass, SrcSpan, SDoc, LogFlags)
</span><a href="#local-6989586621682676075"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="annot"><span class="hs-comment">-- | Internal helper for writing log messages</span></span><span>
</span><span id="line-53"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#writeLogQueueInternal"><span class="hs-identifier hs-type">writeLogQueueInternal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Error.html#MessageClass"><span class="hs-identifier hs-type">MessageClass</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#LogFlags"><span class="hs-identifier hs-type">LogFlags</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span id="writeLogQueueInternal"><span class="annot"><span class="annottext">writeLogQueueInternal :: LogQueue -&gt; Maybe (MessageClass, SrcSpan, SDoc, LogFlags) -&gt; IO ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#writeLogQueueInternal"><span class="hs-identifier hs-var hs-var">writeLogQueueInternal</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span id="local-6989586621682676076"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676076"><span class="hs-identifier hs-var">_n</span></a></span></span><span> </span><span id="local-6989586621682676077"><span class="annot"><span class="annottext">IORef [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676077"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621682676078"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621682676078"><span class="hs-identifier hs-var">sem</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682676079"><span class="annot"><span class="annottext">Maybe (MessageClass, SrcSpan, SDoc, LogFlags)
</span><a href="#local-6989586621682676079"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><span class="annottext">IORef [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
-&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
    -&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)], ()))
-&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676077"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">(([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
  -&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)], ()))
 -&gt; IO ())
-&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
    -&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)], ()))
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682676081"><span class="annot"><span class="annottext">[Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676081"><span class="hs-identifier hs-var">msgs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (MessageClass, SrcSpan, SDoc, LogFlags)
</span><a href="#local-6989586621682676079"><span class="hs-identifier hs-var">msg</span></a></span><span class="annot"><span class="annottext">Maybe (MessageClass, SrcSpan, SDoc, LogFlags)
-&gt; [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
-&gt; [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676081"><span class="hs-identifier hs-var">msgs</span></a></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; () -&gt; IO Bool
forall a. MVar a -&gt; a -&gt; IO Bool
</span><span class="hs-identifier hs-var">tryPutMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621682676078"><span class="hs-identifier hs-var">sem</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-comment">-- The log_action callback that is used to synchronize messages from a</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- worker thread.</span><span>
</span><span id="line-61"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#parLogAction"><span class="hs-identifier hs-type">parLogAction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#LogAction"><span class="hs-identifier hs-type">LogAction</span></a></span><span>
</span><span id="line-62"></span><span id="parLogAction"><span class="annot"><span class="annottext">parLogAction :: LogQueue -&gt; LogAction
</span><a href="GHC.Driver.Pipeline.LogQueue.html#parLogAction"><span class="hs-identifier hs-var hs-var">parLogAction</span></a></span></span><span> </span><span id="local-6989586621682676083"><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676083"><span class="hs-identifier hs-var">log_queue</span></a></span></span><span> </span><span id="local-6989586621682676084"><span class="annot"><span class="annottext">LogFlags
</span><a href="#local-6989586621682676084"><span class="hs-identifier hs-var">log_flags</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682676085"><span class="annot"><span class="annottext">MessageClass
</span><a href="#local-6989586621682676085"><span class="hs-identifier hs-var">msgClass</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682676086"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682676086"><span class="hs-identifier hs-var">srcSpan</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682676087"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682676087"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><span class="annottext">LogQueue -&gt; (MessageClass, SrcSpan, SDoc, LogFlags) -&gt; IO ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#writeLogQueue"><span class="hs-identifier hs-var">writeLogQueue</span></a></span><span> </span><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676083"><span class="hs-identifier hs-var">log_queue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MessageClass
</span><a href="#local-6989586621682676085"><span class="hs-identifier hs-var">msgClass</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682676086"><span class="hs-identifier hs-var">srcSpan</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682676087"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LogFlags
</span><a href="#local-6989586621682676084"><span class="hs-identifier hs-var">log_flags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">-- Print each message from the log_queue using the global logger</span><span>
</span><span id="line-66"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#printLogs"><span class="hs-identifier hs-type">printLogs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span id="printLogs"><span class="annot"><span class="annottext">printLogs :: Logger -&gt; LogQueue -&gt; IO ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#printLogs"><span class="hs-identifier hs-var hs-var">printLogs</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682676089"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682676089"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span id="local-6989586621682676090"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676090"><span class="hs-identifier hs-var">_n</span></a></span></span><span> </span><span id="local-6989586621682676091"><span class="annot"><span class="annottext">IORef [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676091"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621682676092"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621682676092"><span class="hs-identifier hs-var">sem</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621682676093"><span class="hs-identifier hs-var">read_msgs</span></a></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621682676093"><span class="annot"><span class="annottext">read_msgs :: IO ()
</span><a href="#local-6989586621682676093"><span class="hs-identifier hs-var hs-var">read_msgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-69"></span><span>            </span><span class="annot"><span class="annottext">MVar () -&gt; IO ()
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621682676092"><span class="hs-identifier hs-var">sem</span></a></span><span>
</span><span id="line-70"></span><span>            </span><span id="local-6989586621682676095"><span class="annot"><a href="#local-6989586621682676095"><span class="hs-identifier hs-var">msgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
-&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
    -&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)],
        [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]))
-&gt; IO [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676091"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">(([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
  -&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)],
      [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]))
 -&gt; IO [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)])
-&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
    -&gt; ([Maybe (MessageClass, SrcSpan, SDoc, LogFlags)],
        [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]))
-&gt; IO [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682676096"><span class="annot"><span class="annottext">[Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676096"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
-&gt; [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676096"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>            </span><span class="annot"><a href="#local-6989586621682676098"><span class="hs-identifier hs-type">print_loop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682676095"><span class="hs-identifier hs-type">msgs</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span>        </span><span id="local-6989586621682676098"><span class="annot"><span class="annottext">print_loop :: [Maybe (MessageClass, SrcSpan, SDoc, LogFlags)] -&gt; IO ()
</span><a href="#local-6989586621682676098"><span class="hs-identifier hs-var hs-var">print_loop</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621682676093"><span class="hs-identifier hs-var">read_msgs</span></a></span><span>
</span><span id="line-74"></span><span>        </span><span class="annot"><a href="#local-6989586621682676098"><span class="hs-identifier hs-var">print_loop</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682676099"><span class="annot"><span class="annottext">Maybe (MessageClass, SrcSpan, SDoc, LogFlags)
</span><a href="#local-6989586621682676099"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682676100"><span class="annot"><span class="annottext">[Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676100"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (MessageClass, SrcSpan, SDoc, LogFlags)
</span><a href="#local-6989586621682676099"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-75"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682676101"><span class="annot"><span class="annottext">MessageClass
</span><a href="#local-6989586621682676101"><span class="hs-identifier hs-var">msgClass</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682676102"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682676102"><span class="hs-identifier hs-var">srcSpan</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682676103"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682676103"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682676104"><span class="annot"><span class="annottext">LogFlags
</span><a href="#local-6989586621682676104"><span class="hs-identifier hs-var">flags</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>                </span><span class="annot"><span class="annottext">Logger -&gt; MessageClass -&gt; SrcSpan -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; LogFlags -&gt; Logger
</span><a href="GHC.Utils.Logger.html#setLogFlags"><span class="hs-identifier hs-var">setLogFlags</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682676089"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogFlags
</span><a href="#local-6989586621682676104"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MessageClass
</span><a href="#local-6989586621682676101"><span class="hs-identifier hs-var">msgClass</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682676102"><span class="hs-identifier hs-var">srcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682676103"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-77"></span><span>                </span><span class="annot"><span class="annottext">[Maybe (MessageClass, SrcSpan, SDoc, LogFlags)] -&gt; IO ()
</span><a href="#local-6989586621682676098"><span class="hs-identifier hs-var">print_loop</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe (MessageClass, SrcSpan, SDoc, LogFlags)]
</span><a href="#local-6989586621682676100"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-78"></span><span>            </span><span class="hs-comment">-- Exit the loop once we encounter the end marker.</span><span>
</span><span id="line-79"></span><span>            </span><span class="annot"><span class="annottext">Maybe (MessageClass, SrcSpan, SDoc, LogFlags)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-comment">-- The LogQueueQueue abstraction</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-keyword">data</span><span> </span><span id="LogQueueQueue"><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-var">LogQueueQueue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LogQueueQueue"><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-var">LogQueueQueue</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#IntMap"><span class="hs-identifier hs-type">IM.IntMap</span></a></span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#newLogQueueQueue"><span class="hs-identifier hs-type">newLogQueueQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span>
</span><span id="line-86"></span><span id="newLogQueueQueue"><span class="annot"><span class="annottext">newLogQueueQueue :: LogQueueQueue
</span><a href="GHC.Driver.Pipeline.LogQueue.html#newLogQueueQueue"><span class="hs-identifier hs-var hs-var">newLogQueueQueue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Key -&gt; IntMap LogQueue -&gt; LogQueueQueue
</span><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-var">LogQueueQueue</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">IntMap LogQueue
forall a. IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#empty"><span class="hs-identifier hs-var">IM.empty</span></a></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#addToQueueQueue"><span class="hs-identifier hs-type">addToQueueQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span>
</span><span id="line-89"></span><span id="addToQueueQueue"><span class="annot"><span class="annottext">addToQueueQueue :: LogQueue -&gt; LogQueueQueue -&gt; LogQueueQueue
</span><a href="GHC.Driver.Pipeline.LogQueue.html#addToQueueQueue"><span class="hs-identifier hs-var hs-var">addToQueueQueue</span></a></span></span><span> </span><span id="local-6989586621682676110"><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676110"><span class="hs-identifier hs-var">lq</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span> </span><span id="local-6989586621682676111"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676111"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682676112"><span class="annot"><span class="annottext">IntMap LogQueue
</span><a href="#local-6989586621682676112"><span class="hs-identifier hs-var">im</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Key -&gt; IntMap LogQueue -&gt; LogQueueQueue
</span><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-var">LogQueueQueue</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676111"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key -&gt; LogQueue -&gt; IntMap LogQueue -&gt; IntMap LogQueue
forall a. Key -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#insert"><span class="hs-identifier hs-var">IM.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogQueue -&gt; Key
</span><a href="GHC.Driver.Pipeline.LogQueue.html#logQueueId"><span class="hs-identifier hs-var">logQueueId</span></a></span><span> </span><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676110"><span class="hs-identifier hs-var">lq</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676110"><span class="hs-identifier hs-var">lq</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap LogQueue
</span><a href="#local-6989586621682676112"><span class="hs-identifier hs-var">im</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#initLogQueue"><span class="hs-identifier hs-type">initLogQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span id="initLogQueue"><span class="annot"><span class="annottext">initLogQueue :: TVar LogQueueQueue -&gt; LogQueue -&gt; STM ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#initLogQueue"><span class="hs-identifier hs-var hs-var">initLogQueue</span></a></span></span><span> </span><span id="local-6989586621682676114"><span class="annot"><span class="annottext">TVar LogQueueQueue
</span><a href="#local-6989586621682676114"><span class="hs-identifier hs-var">lqq</span></a></span></span><span> </span><span id="local-6989586621682676115"><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676115"><span class="hs-identifier hs-var">lq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar LogQueueQueue -&gt; (LogQueueQueue -&gt; LogQueueQueue) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><a href="../../stm-2.5.3.1-d35b/src/Control.Concurrent.STM.TVar.html#modifyTVar"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar LogQueueQueue
</span><a href="#local-6989586621682676114"><span class="hs-identifier hs-var">lqq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogQueue -&gt; LogQueueQueue -&gt; LogQueueQueue
</span><a href="GHC.Driver.Pipeline.LogQueue.html#addToQueueQueue"><span class="hs-identifier hs-var">addToQueueQueue</span></a></span><span> </span><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676115"><span class="hs-identifier hs-var">lq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="annot"><span class="hs-comment">-- | Return all items in the queue in ascending order</span></span><span>
</span><span id="line-95"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#allLogQueues"><span class="hs-identifier hs-type">allLogQueues</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-96"></span><span id="allLogQueues"><span class="annot"><span class="annottext">allLogQueues :: LogQueueQueue -&gt; [LogQueue]
</span><a href="GHC.Driver.Pipeline.LogQueue.html#allLogQueues"><span class="hs-identifier hs-var hs-var">allLogQueues</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span> </span><span id="local-6989586621682676117"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676117"><span class="hs-identifier hs-var">_n</span></a></span></span><span> </span><span id="local-6989586621682676118"><span class="annot"><span class="annottext">IntMap LogQueue
</span><a href="#local-6989586621682676118"><span class="hs-identifier hs-var">im</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap LogQueue -&gt; [LogQueue]
forall a. IntMap a -&gt; [a]
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#elems"><span class="hs-identifier hs-var">IM.elems</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap LogQueue
</span><a href="#local-6989586621682676118"><span class="hs-identifier hs-var">im</span></a></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#dequeueLogQueueQueue"><span class="hs-identifier hs-type">dequeueLogQueueQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span id="dequeueLogQueueQueue"><span class="annot"><span class="annottext">dequeueLogQueueQueue :: LogQueueQueue -&gt; Maybe (LogQueue, LogQueueQueue)
</span><a href="GHC.Driver.Pipeline.LogQueue.html#dequeueLogQueueQueue"><span class="hs-identifier hs-var hs-var">dequeueLogQueueQueue</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span> </span><span id="local-6989586621682676121"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676121"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682676122"><span class="annot"><span class="annottext">IntMap LogQueue
</span><a href="#local-6989586621682676122"><span class="hs-identifier hs-var">lqq</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IntMap LogQueue -&gt; Maybe ((Key, LogQueue), IntMap LogQueue)
forall a. IntMap a -&gt; Maybe ((Key, a), IntMap a)
</span><a href="../../containers-0.7-5a8f/src/Data.IntMap.Internal.html#minViewWithKey"><span class="hs-identifier hs-var">IM.minViewWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap LogQueue
</span><a href="#local-6989586621682676122"><span class="hs-identifier hs-var">lqq</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-100"></span><span>                                                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682676124"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676124"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682676125"><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676125"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621682676126"><span class="annot"><span class="annottext">IntMap LogQueue
</span><a href="#local-6989586621682676126"><span class="hs-identifier hs-var">lqq'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676124"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Key -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676121"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(LogQueue, LogQueueQueue) -&gt; Maybe (LogQueue, LogQueueQueue)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676125"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key -&gt; IntMap LogQueue -&gt; LogQueueQueue
</span><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-var">LogQueueQueue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621682676121"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Key -&gt; Key
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap LogQueue
</span><a href="#local-6989586621682676126"><span class="hs-identifier hs-var">lqq'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>                                                </span><span class="annot"><span class="annottext">Maybe ((Key, LogQueue), IntMap LogQueue)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (LogQueue, LogQueueQueue)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#logThread"><span class="hs-identifier hs-type">logThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-comment">-- Signal that no more new logs will be added, clear the queue and exit</span><span>
</span><span id="line-104"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#LogQueueQueue"><span class="hs-identifier hs-type">LogQueueQueue</span></a></span><span> </span><span class="hs-comment">-- Queue for logs</span><span>
</span><span id="line-105"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span id="logThread"><span class="annot"><span class="annottext">logThread :: Logger -&gt; TVar Bool -&gt; TVar LogQueueQueue -&gt; IO (IO ())
</span><a href="GHC.Driver.Pipeline.LogQueue.html#logThread"><span class="hs-identifier hs-var hs-var">logThread</span></a></span></span><span> </span><span id="local-6989586621682676128"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682676128"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621682676129"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621682676129"><span class="hs-identifier hs-var">stopped</span></a></span></span><span> </span><span id="local-6989586621682676130"><span class="annot"><span class="annottext">TVar LogQueueQueue
</span><a href="#local-6989586621682676130"><span class="hs-identifier hs-var">lqq_var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621682676131"><span class="annot"><a href="#local-6989586621682676131"><span class="hs-identifier hs-var">finished_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar ())
forall a. IO (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">forkIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621682676134"><span class="hs-identifier hs-type">print_logs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">*&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">putMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621682676131"><span class="hs-identifier hs-type">finished_var</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">takeMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621682676131"><span class="hs-identifier hs-type">finished_var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-111"></span><span>    </span><span id="local-6989586621682676136"><span class="annot"><span class="annottext">finish :: [LogQueue] -&gt; IO [()]
</span><a href="#local-6989586621682676136"><span class="hs-identifier hs-var hs-var">finish</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LogQueue -&gt; IO ()) -&gt; [LogQueue] -&gt; IO [()]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; LogQueue -&gt; IO ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#printLogs"><span class="hs-identifier hs-var">printLogs</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682676128"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>    </span><span id="local-6989586621682676134"><span class="annot"><span class="annottext">print_logs :: IO [()]
</span><a href="#local-6989586621682676134"><span class="hs-identifier hs-var hs-var">print_logs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (IO [()]) -&gt; IO [()]
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(IO (IO [()]) -&gt; IO [()]) -&gt; IO (IO [()]) -&gt; IO [()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM (IO [()]) -&gt; IO (IO [()])
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (IO [()]) -&gt; IO (IO [()])) -&gt; STM (IO [()]) -&gt; IO (IO [()])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-114"></span><span>      </span><span id="local-6989586621682676139"><span class="annot"><a href="#local-6989586621682676139"><span class="hs-identifier hs-var">lqq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar LogQueueQueue -&gt; STM LogQueueQueue
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar LogQueueQueue
</span><a href="#local-6989586621682676130"><span class="hs-identifier hs-var">lqq_var</span></a></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#dequeueLogQueueQueue"><span class="hs-identifier hs-type">dequeueLogQueueQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682676139"><span class="hs-identifier hs-type">lqq</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682676141"><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676141"><span class="hs-identifier hs-var">lq</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682676142"><span class="annot"><span class="annottext">LogQueueQueue
</span><a href="#local-6989586621682676142"><span class="hs-identifier hs-var">lqq'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>          </span><span class="annot"><span class="annottext">TVar LogQueueQueue -&gt; LogQueueQueue -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar LogQueueQueue
</span><a href="#local-6989586621682676130"><span class="hs-identifier hs-var">lqq_var</span></a></span><span> </span><span class="annot"><span class="annottext">LogQueueQueue
</span><a href="#local-6989586621682676142"><span class="hs-identifier hs-var">lqq'</span></a></span><span>
</span><span id="line-118"></span><span>          </span><span class="annot"><span class="annottext">IO [()] -&gt; STM (IO [()])
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; LogQueue -&gt; IO ()
</span><a href="GHC.Driver.Pipeline.LogQueue.html#printLogs"><span class="hs-identifier hs-var">printLogs</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621682676128"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogQueue
</span><a href="#local-6989586621682676141"><span class="hs-identifier hs-var">lq</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO [()] -&gt; IO [()]
forall a b. IO a -&gt; IO b -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO [()]
</span><a href="#local-6989586621682676134"><span class="hs-identifier hs-var">print_logs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="annottext">Maybe (LogQueue, LogQueueQueue)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-120"></span><span>          </span><span class="hs-comment">-- No log to print, check if we are finished.</span><span>
</span><span id="line-121"></span><span>          </span><span id="local-6989586621682676144"><span class="annot"><a href="#local-6989586621682676144"><span class="hs-identifier hs-var">stopped</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; STM Bool
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621682676129"><span class="hs-identifier hs-var">stopped</span></a></span><span>
</span><span id="line-122"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621682676144"><span class="hs-identifier hs-type">stopped</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">retry</span></span><span>
</span><span id="line-123"></span><span>                         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682676136"><span class="hs-identifier hs-type">finish</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Pipeline.LogQueue.html#allLogQueues"><span class="hs-identifier hs-type">allLogQueues</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682676139"><span class="hs-identifier hs-type">lqq</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-124"></span></pre></body></html>