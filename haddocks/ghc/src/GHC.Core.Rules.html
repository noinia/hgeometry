<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[CoreRules]{Rewrite rules}
-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">-- | Functions for collecting together and applying rewrite rules to a module.</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- The 'CoreRule' datatype itself is declared elsewhere.</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html"><span class="hs-identifier">GHC.Core.Rules</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-11"></span><span>        </span><span class="annot"><span class="hs-comment">-- ** Looking up rules</span></span><span>
</span><span id="line-12"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#lookupRule"><span class="hs-identifier">lookupRule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#matchExprs"><span class="hs-identifier">matchExprs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span>        </span><span class="annot"><span class="hs-comment">-- ** RuleBase, RuleEnv</span></span><span>
</span><span id="line-15"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier">RuleBase</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier">RuleEnv</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#mkRuleEnv"><span class="hs-identifier">mkRuleEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#emptyRuleEnv"><span class="hs-identifier">emptyRuleEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#updExternalPackageRules"><span class="hs-identifier">updExternalPackageRules</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#addLocalRules"><span class="hs-identifier">addLocalRules</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#updLocalRules"><span class="hs-identifier">updLocalRules</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#emptyRuleBase"><span class="hs-identifier">emptyRuleBase</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#mkRuleBase"><span class="hs-identifier">mkRuleBase</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#extendRuleBaseList"><span class="hs-identifier">extendRuleBaseList</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#pprRuleBase"><span class="hs-identifier">pprRuleBase</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>        </span><span class="annot"><span class="hs-comment">-- ** Checking rule applications</span></span><span>
</span><span id="line-21"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheckProgram"><span class="hs-identifier">ruleCheckProgram</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>        </span><span class="annot"><span class="hs-comment">-- ** Manipulating 'RuleInfo' rules</span></span><span>
</span><span id="line-24"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#extendRuleInfo"><span class="hs-identifier">extendRuleInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#addRuleInfo"><span class="hs-identifier">addRuleInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#addIdSpecialisations"><span class="hs-identifier">addIdSpecialisations</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#addRulesToId"><span class="hs-identifier">addRulesToId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>        </span><span class="annot"><span class="hs-comment">-- ** RuleBase and RuleEnv</span></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span>        </span><span class="annot"><span class="hs-comment">-- * Misc. CoreRule helpers</span></span><span>
</span><span id="line-30"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#rulesOfBinds"><span class="hs-identifier">rulesOfBinds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#getRules"><span class="hs-identifier">getRules</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#pprRulesForUser"><span class="hs-identifier">pprRulesForUser</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>        </span><span class="annot"><span class="hs-comment">-- * Making rules</span></span><span>
</span><span id="line-33"></span><span>        </span><span class="annot"><a href="GHC.Core.Rules.html#mkRule"><span class="hs-identifier">mkRule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#mkSpecRule"><span class="hs-identifier">mkSpecRule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#roughTopNames"><span class="hs-identifier">roughTopNames</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier">Module</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Env.html"><span class="hs-identifier">GHC.Unit.Module.Env</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html"><span class="hs-identifier">GHC.Unit.Module.ModGuts</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier">ModGuts</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html"><span class="hs-identifier">GHC.Unit.Module.Deps</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html#Dependencies"><span class="hs-identifier">Dependencies</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html"><span class="hs-identifier">GHC.Driver.DynFlags</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier">DynFlags</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Ppr.html"><span class="hs-identifier">GHC.Driver.Ppr</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Ppr.html#showSDoc"><span class="hs-identifier">showSDoc</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>         </span><span class="hs-comment">-- All of it</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html"><span class="hs-identifier">GHC.Core.SimpleOpt</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#exprIsLambda_maybe"><span class="hs-identifier">exprIsLambda_maybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier">exprFreeVars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#bindFreeVars"><span class="hs-identifier">bindFreeVars</span></a></span><span>
</span><span id="line-51"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#rulesFreeVarsDSet"><span class="hs-identifier">rulesFreeVarsDSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#orphNamesOfExprs"><span class="hs-identifier">orphNamesOfExprs</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier">exprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier">mkTick</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier">mkTicks</span></a></span><span>
</span><span id="line-53"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#stripTicksTopT"><span class="hs-identifier">stripTicksTopT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#stripTicksTopE"><span class="hs-identifier">stripTicksTopE</span></a></span><span>
</span><span id="line-54"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#isJoinBind"><span class="hs-identifier">isJoinBind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-identifier">mkCastMCo</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html"><span class="hs-identifier">GHC.Core.Ppr</span></a></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html#pprRules"><span class="hs-identifier">pprRules</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html"><span class="hs-identifier">GHC.Core.Unify</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Unify</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#ruleMatchTyKiX"><span class="hs-identifier">ruleMatchTyKiX</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-58"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendTvSubst"><span class="hs-identifier">extendTvSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendCvSubst"><span class="hs-identifier">extendCvSubst</span></a></span><span>
</span><span id="line-59"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier">substTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier">getTyVar_maybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html"><span class="hs-identifier">GHC.Core.TyCo.Ppr</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html#pprParendType"><span class="hs-identifier">pprParendType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Coercion</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Tidy.html"><span class="hs-identifier">GHC.Core.Tidy</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Tidy.html#tidyRules"><span class="hs-identifier">tidyRules</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Map.Expr.html"><span class="hs-identifier">GHC.Core.Map.Expr</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Map.Expr.html#eqCoreExpr"><span class="hs-identifier">eqCoreExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier">etaExpandToJoinPointRule</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Make.html#mkCoreLams"><span class="hs-identifier">mkCoreLams</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html"><span class="hs-identifier">GHC.Core.Opt.OccurAnal</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier">occurAnalyseExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier">tcSplitTyConApp_maybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#anyTypeOfKind"><span class="hs-identifier">anyTypeOfKind</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier">RuleInfo</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier">RuleInfo</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#NamedThing"><span class="hs-identifier">NamedThing</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier">nameIsLocalOrFrom</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html"><span class="hs-identifier">GHC.Types.Name.Set</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html"><span class="hs-identifier">GHC.Types.Name.Env</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Occurrence.html"><span class="hs-identifier">GHC.Types.Name.Occurrence</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Name.Occurrence.html#occNameFS"><span class="hs-identifier">occNameFS</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html"><span class="hs-identifier">GHC.Types.Unique.FM</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.List.SetOps.html"><span class="hs-identifier">GHC.Data.List.SetOps</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Data.List.SetOps.html#hasNoDups"><span class="hs-identifier">hasNoDups</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.FV.html"><span class="hs-identifier">GHC.Utils.FV</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.FV.html#filterFV"><span class="hs-identifier">filterFV</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.FV.html#fvVarSet"><span class="hs-identifier">fvVarSet</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Utils</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Constants.html"><span class="hs-identifier">GHC.Utils.Constants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier">debugIsOn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">sortBy</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapAccumL</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isPrefixOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Function.html"><span class="hs-identifier">Data.Function</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">on</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">guard</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-comment">{-
Note [Overall plumbing for rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* After the desugarer:
   - The ModGuts initially contains mg_rules :: [CoreRule] of
     locally-declared rules for imported Ids.
   - Locally-declared rules for locally-declared Ids are attached to
     the IdInfo for that Id.  See Note [Attach rules to local ids] in
     GHC.HsToCore.Binds

* GHC.Iface.Tidy strips off all the rules from local Ids and adds them to
  mg_rules, so that the ModGuts has *all* the locally-declared rules.

* The HomePackageTable contains a ModDetails for each home package
  module.  Each contains md_rules :: [CoreRule] of rules declared in
  that module.  The HomePackageTable grows as ghc --make does its
  up-sweep.  In batch mode (ghc -c), the HPT is empty; all imported modules
  are treated by the &quot;external&quot; route, discussed next, regardless of
  which package they come from.

* The ExternalPackageState has a single eps_rule_base :: RuleBase for
  Ids in other packages.  This RuleBase simply grow monotonically, as
  ghc --make compiles one module after another.

  During simplification, interface files may get demand-loaded,
  as the simplifier explores the unfoldings for Ids it has in
  its hand.  (Via an unsafePerformIO; the EPS is really a cache.)
  That in turn may make the EPS rule-base grow.  In contrast, the
  HPT never grows in this way.

* The result of all this is that during Core-to-Core optimisation
  there are four sources of rules:

    (a) Rules in the IdInfo of the Id they are a rule for.  These are
        easy: fast to look up, and if you apply a substitution then
        it'll be applied to the IdInfo as a matter of course.

    (b) Rules declared in this module for imported Ids, kept in the
        ModGuts. If you do a substitution, you'd better apply the
        substitution to these.  There are seldom many of these.

    (c) Rules declared in the HomePackageTable.  These never change.

    (d) Rules in the ExternalPackageTable. These can grow in response
        to lazy demand-loading of interfaces.

* At the moment (c) is carried in a reader-monad way by the GHC.Core.Opt.Monad.
  The HomePackageTable doesn't have a single RuleBase because technically
  we should only be able to &quot;see&quot; rules &quot;below&quot; this module; so we
  generate a RuleBase for (c) by combining rules from all the modules
  &quot;below&quot; us.  That's why we can't just select the home-package RuleBase
  from HscEnv.

  [NB: we are inconsistent here.  We should do the same for external
  packages, but we don't.  Same for type-class instances.]

* So in the outer simplifier loop (simplifyPgmIO), we combine (b &amp; c) into a single
  RuleBase, reading
     (b) from the ModGuts,
     (c) from the GHC.Core.Opt.Monad, and
  just before doing rule matching we read
     (d) from its mutable variable
  and combine it with the results from (b &amp; c).

  In a single simplifier run new rules can be added into the EPS so it matters
  to keep an up-to-date view of which rules have been loaded. For examples of
  where this went wrong and caused cryptic performance regressions
  see T19790 and !6735.


************************************************************************
*                                                                      *
\subsection[specialisation-IdInfo]{Specialisation info about an @Id@}
*                                                                      *
************************************************************************

A CoreRule holds details of one rule for an Id, which
includes its specialisations.

For example, if a rule for f is
   RULE &quot;f&quot; forall @a @b d. f @(List a) @b d = f' a b

then when we find an application of f to matching types, we simply replace
it by the matching RHS:
        f (List Int) Bool dict ===&gt;  f' Int Bool
All the stuff about how many dictionaries to discard, and what types
to apply the specialised function to, are handled by the fact that the
Rule contains a template for the result of the specialisation.
-}</span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="annot"><a href="GHC.Core.Rules.html#mkRule"><span class="hs-identifier hs-type">mkRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span>
</span><span id="line-190"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span>
</span><span id="line-191"></span><span class="hs-comment">-- ^ Used to make 'CoreRule' for an 'Id' defined in the module being</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- compiled. See also 'GHC.Core.CoreRule'</span><span>
</span><span id="line-193"></span><span id="mkRule"><span class="annot"><span class="annottext">mkRule :: Module
-&gt; Bool
-&gt; Bool
-&gt; RuleName
-&gt; Activation
-&gt; Name
-&gt; [Var]
-&gt; [CoreExpr]
-&gt; CoreExpr
-&gt; CoreRule
</span><a href="GHC.Core.Rules.html#mkRule"><span class="hs-identifier hs-var hs-var">mkRule</span></a></span></span><span> </span><span id="local-6989586621682893387"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682893387"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span id="local-6989586621682893388"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682893388"><span class="hs-identifier hs-var">is_auto</span></a></span></span><span> </span><span id="local-6989586621682893389"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682893389"><span class="hs-identifier hs-var">is_local</span></a></span></span><span> </span><span id="local-6989586621682893390"><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682893390"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621682893391"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682893391"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span id="local-6989586621682893392"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682893392"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682893393"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893393"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682893394"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893394"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682893395"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893395"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_name :: RuleName
</span><a href="GHC.Core.html#ru_name"><span class="hs-identifier hs-var">ru_name</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682893390"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-195"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_act :: Activation
</span><a href="GHC.Core.html#ru_act"><span class="hs-identifier hs-var">ru_act</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682893391"><span class="hs-identifier hs-var">act</span></a></span><span>
</span><span id="line-196"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_fn :: Name
</span><a href="GHC.Core.html#ru_fn"><span class="hs-identifier hs-var">ru_fn</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682893392"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-197"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: [Var]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893393"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-198"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893394"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-199"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rhs :: CoreExpr
</span><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893395"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-200"></span><span>                       </span><span class="hs-comment">-- See Note [OccInfo in unfoldings and rules]</span><span>
</span><span id="line-201"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rough :: [Maybe Name]
</span><a href="GHC.Core.html#ru_rough"><span class="hs-identifier hs-var">ru_rough</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; [Maybe Name]
</span><a href="GHC.Core.Rules.html#roughTopNames"><span class="hs-identifier hs-var">roughTopNames</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893394"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-202"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_origin :: Module
</span><a href="GHC.Core.html#ru_origin"><span class="hs-identifier hs-var">ru_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682893387"><span class="hs-identifier hs-var">this_mod</span></a></span><span>
</span><span id="line-203"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_orphan :: IsOrphan
</span><a href="GHC.Core.html#ru_orphan"><span class="hs-identifier hs-var">ru_orphan</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsOrphan
</span><a href="#local-6989586621682893406"><span class="hs-identifier hs-var">orph</span></a></span><span>
</span><span id="line-204"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_auto :: Bool
</span><a href="GHC.Core.html#ru_auto"><span class="hs-identifier hs-var">ru_auto</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682893388"><span class="hs-identifier hs-var">is_auto</span></a></span><span>
</span><span id="line-205"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_local :: Bool
</span><a href="GHC.Core.html#ru_local"><span class="hs-identifier hs-var">ru_local</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682893389"><span class="hs-identifier hs-var">is_local</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-207"></span><span>        </span><span class="hs-comment">-- Compute orphanhood.  See Note [Orphans] in GHC.Core.InstEnv</span><span>
</span><span id="line-208"></span><span>        </span><span class="hs-comment">-- A rule is an orphan only if none of the variables</span><span>
</span><span id="line-209"></span><span>        </span><span class="hs-comment">-- mentioned on its left-hand side are locally defined</span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621682893409"><span class="annot"><span class="annottext">lhs_names :: NameSet
</span><a href="#local-6989586621682893409"><span class="hs-identifier hs-var hs-var">lhs_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NameSet -&gt; Name -&gt; NameSet
</span><a href="GHC.Types.Name.Set.html#extendNameSet"><span class="hs-identifier hs-var">extendNameSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreExpr] -&gt; NameSet
</span><a href="GHC.Core.FVs.html#orphNamesOfExprs"><span class="hs-identifier hs-var">orphNamesOfExprs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893394"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682893392"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span>        </span><span class="hs-comment">-- Since rules get eventually attached to one of the free names</span><span>
</span><span id="line-213"></span><span>        </span><span class="hs-comment">-- from the definition when compiling the ABI hash, we should make</span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-comment">-- it deterministic. This chooses the one with minimal OccName</span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-comment">-- as opposed to uniq value.</span><span>
</span><span id="line-216"></span><span>    </span><span id="local-6989586621682893411"><span class="annot"><span class="annottext">local_lhs_names :: NameSet
</span><a href="#local-6989586621682893411"><span class="hs-identifier hs-var hs-var">local_lhs_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Bool) -&gt; NameSet -&gt; NameSet
</span><a href="GHC.Types.Name.Set.html#filterNameSet"><span class="hs-identifier hs-var">filterNameSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; Name -&gt; Bool
</span><a href="GHC.Types.Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682893387"><span class="hs-identifier hs-var">this_mod</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621682893409"><span class="hs-identifier hs-var">lhs_names</span></a></span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621682893406"><span class="annot"><span class="annottext">orph :: IsOrphan
</span><a href="#local-6989586621682893406"><span class="hs-identifier hs-var hs-var">orph</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NameSet -&gt; IsOrphan
</span><a href="GHC.Core.html#chooseOrphanAnchor"><span class="hs-identifier hs-var">chooseOrphanAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621682893411"><span class="hs-identifier hs-var">local_lhs_names</span></a></span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-220"></span><span class="annot"><a href="GHC.Core.Rules.html#mkSpecRule"><span class="hs-identifier hs-type">mkSpecRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-221"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span>
</span><span id="line-222"></span><span class="hs-comment">-- Make a specialisation rule, for Specialise or SpecConstr</span><span>
</span><span id="line-223"></span><span id="mkSpecRule"><span class="annot"><span class="annottext">mkSpecRule :: DynFlags
-&gt; Module
-&gt; Bool
-&gt; Activation
-&gt; SDoc
-&gt; Var
-&gt; [Var]
-&gt; [CoreExpr]
-&gt; CoreExpr
-&gt; CoreRule
</span><a href="GHC.Core.Rules.html#mkSpecRule"><span class="hs-identifier hs-var hs-var">mkSpecRule</span></a></span></span><span> </span><span id="local-6989586621682893414"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682893414"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621682893415"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682893415"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span id="local-6989586621682893416"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682893416"><span class="hs-identifier hs-var">is_auto</span></a></span></span><span> </span><span id="local-6989586621682893417"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682893417"><span class="hs-identifier hs-var">inl_act</span></a></span></span><span> </span><span id="local-6989586621682893418"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682893418"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span id="local-6989586621682893419"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893419"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682893420"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893420"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682893421"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893421"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682893422"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893422"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Var -&gt; JoinPointHood
</span><a href="GHC.Types.Id.html#idJoinPointHood"><span class="hs-identifier hs-var">idJoinPointHood</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893419"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-225"></span><span>      </span><span class="annot"><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-type">JoinPoint</span></a></span><span> </span><span id="local-6989586621682893425"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621682893425"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; CoreRule -&gt; CoreRule
</span><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier hs-var">etaExpandToJoinPointRule</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621682893425"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893426"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-226"></span><span>      </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-var">NotJoinPoint</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893426"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621682893426"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621682893426"><span class="hs-identifier hs-var hs-var">rule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
-&gt; Bool
-&gt; Bool
-&gt; RuleName
-&gt; Activation
-&gt; Name
-&gt; [Var]
-&gt; [CoreExpr]
-&gt; CoreExpr
-&gt; CoreRule
</span><a href="GHC.Core.Rules.html#mkRule"><span class="hs-identifier hs-var">mkRule</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682893415"><span class="hs-identifier hs-var">this_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682893416"><span class="hs-identifier hs-var">is_auto</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682893428"><span class="hs-identifier hs-var">is_local</span></a></span><span>
</span><span id="line-229"></span><span>                  </span><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682893429"><span class="hs-identifier hs-var">rule_name</span></a></span><span>
</span><span id="line-230"></span><span>                  </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682893417"><span class="hs-identifier hs-var">inl_act</span></a></span><span>       </span><span class="hs-comment">-- Note [Auto-specialisation and RULES]</span><span>
</span><span id="line-231"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893419"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>                  </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893420"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893421"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893422"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span>    </span><span id="local-6989586621682893428"><span class="annot"><span class="annottext">is_local :: Bool
</span><a href="#local-6989586621682893428"><span class="hs-identifier hs-var hs-var">is_local</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893419"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span id="local-6989586621682893429"><span class="annot"><span class="annottext">rule_name :: RuleName
</span><a href="#local-6989586621682893429"><span class="hs-identifier hs-var hs-var">rule_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; SDoc -&gt; Var -&gt; [CoreExpr] -&gt; RuleName
</span><a href="GHC.Core.Rules.html#mkSpecRuleName"><span class="hs-identifier hs-var">mkSpecRuleName</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682893414"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682893418"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893419"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893421"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span class="annot"><a href="GHC.Core.Rules.html#mkSpecRuleName"><span class="hs-identifier hs-type">mkSpecRuleName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span>
</span><span id="line-238"></span><span id="mkSpecRuleName"><span class="annot"><span class="annottext">mkSpecRuleName :: DynFlags -&gt; SDoc -&gt; Var -&gt; [CoreExpr] -&gt; RuleName
</span><a href="GHC.Core.Rules.html#mkSpecRuleName"><span class="hs-identifier hs-var hs-var">mkSpecRuleName</span></a></span></span><span> </span><span id="local-6989586621682893434"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682893434"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621682893435"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682893435"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span id="local-6989586621682893436"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893436"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682893437"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893437"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; RuleName
</span><a href="GHC.Data.FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; RuleName) -&gt; String -&gt; RuleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; SDoc -&gt; String
</span><a href="GHC.Driver.Ppr.html#showSDoc"><span class="hs-identifier hs-var">showSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682893434"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; String) -&gt; SDoc -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682893435"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RuleName -&gt; SDoc
forall doc. IsLine doc =&gt; RuleName -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccName -&gt; RuleName
</span><a href="GHC.Types.Name.Occurrence.html#occNameFS"><span class="hs-identifier hs-var">occNameFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; OccName
forall a. NamedThing a =&gt; a -&gt; OccName
</span><a href="GHC.Types.Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893436"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>                     </span><span class="hs-comment">-- This name ends up in interface files, so use occNameFS.</span><span>
</span><span id="line-242"></span><span>                     </span><span class="hs-comment">-- Otherwise uniques end up there, making builds</span><span>
</span><span id="line-243"></span><span>                     </span><span class="hs-comment">-- less deterministic (See #4012 comment:61 ff)</span><span>
</span><span id="line-244"></span><span>           </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreExpr -&gt; Maybe SDoc) -&gt; [CoreExpr] -&gt; [SDoc]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe SDoc
</span><a href="#local-6989586621682893444"><span class="hs-identifier hs-var">ppr_call_key_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893437"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><a href="#local-6989586621682893444"><span class="hs-identifier hs-type">ppr_call_key_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621682893444"><span class="annot"><span class="annottext">ppr_call_key_ty :: CoreExpr -&gt; Maybe SDoc
</span><a href="#local-6989586621682893444"><span class="hs-identifier hs-var hs-var">ppr_call_key_ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682893446"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893446"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Maybe Var
</span><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893446"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-248"></span><span>                                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Maybe SDoc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;@_&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>                                  </span><span class="annot"><span class="annottext">Maybe Var
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Maybe SDoc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; Maybe SDoc) -&gt; SDoc -&gt; Maybe SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'@'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SDoc
</span><a href="GHC.Core.TyCo.Ppr.html#pprParendType"><span class="hs-identifier hs-var">pprParendType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893446"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><a href="#local-6989586621682893444"><span class="hs-identifier hs-var">ppr_call_key_ty</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe SDoc
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-254"></span><span class="annot"><a href="GHC.Core.Rules.html#roughTopNames"><span class="hs-identifier hs-type">roughTopNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- ^ Find the \&quot;top\&quot; free names of several expressions.</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- Such names are either:</span><span>
</span><span id="line-257"></span><span class="hs-comment">--</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- 1. The function finally being applied to in an application chain</span><span>
</span><span id="line-259"></span><span class="hs-comment">--    (if that name is a GlobalId: see &quot;GHC.Types.Var#globalvslocal&quot;), or</span><span>
</span><span id="line-260"></span><span class="hs-comment">--</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- 2. The 'TyCon' if the expression is a 'Type'</span><span>
</span><span id="line-262"></span><span class="hs-comment">--</span><span>
</span><span id="line-263"></span><span class="hs-comment">-- This is used for the fast-match-check for rules;</span><span>
</span><span id="line-264"></span><span class="hs-comment">--      if the top names don't match, the rest can't</span><span>
</span><span id="line-265"></span><span id="roughTopNames"><span class="annot"><span class="annottext">roughTopNames :: [CoreExpr] -&gt; [Maybe Name]
</span><a href="GHC.Core.Rules.html#roughTopNames"><span class="hs-identifier hs-var hs-var">roughTopNames</span></a></span></span><span> </span><span id="local-6989586621682893450"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893450"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; Maybe Name) -&gt; [CoreExpr] -&gt; [Maybe Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe Name
</span><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893450"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="annot"><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-type">roughTopName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-268"></span><span id="roughTopName"><span class="annot"><span class="annottext">roughTopName :: CoreExpr -&gt; Maybe Name
</span><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var hs-var">roughTopName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682893452"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893452"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Kind -&gt; Maybe (TyCon, [Kind])
Kind -&gt; Maybe (TyCon, [Kind])
</span><a href="GHC.Core.Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893452"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-269"></span><span>                               </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893453"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682893453"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[Kind]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Name
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682893453"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>                               </span><span class="annot"><span class="annottext">Maybe (TyCon, [Kind])
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-271"></span><span class="annot"><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-272"></span><span class="annot"><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682893457"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893457"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe Name
</span><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893457"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-273"></span><span class="annot"><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893459"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893459"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Var.html#isGlobalId"><span class="hs-identifier hs-var">isGlobalId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893459"><span class="hs-identifier hs-var">f</span></a></span><span>   </span><span class="hs-comment">-- Note [Care with roughTopName]</span><span>
</span><span id="line-274"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isDataConWorkId"><span class="hs-identifier hs-var">isDataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893459"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Arity
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893459"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span>
</span><span id="line-275"></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Name
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893459"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span class="annot"><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682893466"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682893466"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682893467"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893467"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682893466"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-277"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe Name
</span><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893467"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-278"></span><span class="annot"><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCantMatch"><span class="hs-identifier hs-type">ruleCantMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-281"></span><span class="hs-comment">-- ^ @ruleCantMatch tpl actual@ returns True only if @actual@</span><span>
</span><span id="line-282"></span><span class="hs-comment">-- definitely can't match @tpl@ by instantiating @tpl@.</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- It's only a one-way match; unlike instance matching we</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- don't consider unification.</span><span>
</span><span id="line-285"></span><span class="hs-comment">--</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- Notice that [_$_]</span><span>
</span><span id="line-287"></span><span class="hs-comment">--      @ruleCantMatch [Nothing] [Just n2] = False@</span><span>
</span><span id="line-288"></span><span class="hs-comment">--      Reason: a template variable can be instantiated by a constant</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- Also:</span><span>
</span><span id="line-290"></span><span class="hs-comment">--      @ruleCantMatch [Just n1] [Nothing] = False@</span><span>
</span><span id="line-291"></span><span class="hs-comment">--      Reason: a local variable @v@ in the actuals might [_$_]</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span id="ruleCantMatch"><span class="annot"><span class="annottext">ruleCantMatch :: [Maybe Name] -&gt; [Maybe Name] -&gt; Bool
</span><a href="GHC.Core.Rules.html#ruleCantMatch"><span class="hs-identifier hs-var hs-var">ruleCantMatch</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893470"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682893470"><span class="hs-identifier hs-var">n1</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682893471"><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893471"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893472"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682893472"><span class="hs-identifier hs-var">n2</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682893473"><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893473"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682893470"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682893472"><span class="hs-identifier hs-var">n2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Name] -&gt; [Maybe Name] -&gt; Bool
</span><a href="GHC.Core.Rules.html#ruleCantMatch"><span class="hs-identifier hs-var">ruleCantMatch</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893471"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893473"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-294"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCantMatch"><span class="hs-identifier hs-var">ruleCantMatch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier">_</span></span><span>       </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682893475"><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893475"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier">_</span></span><span>       </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682893476"><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893476"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe Name] -&gt; [Maybe Name] -&gt; Bool
</span><a href="GHC.Core.Rules.html#ruleCantMatch"><span class="hs-identifier hs-var">ruleCantMatch</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893475"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893476"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-295"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCantMatch"><span class="hs-identifier hs-var">ruleCantMatch</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Name]
</span><span class="hs-identifier">_</span></span><span>              </span><span class="annot"><span class="annottext">[Maybe Name]
</span><span class="hs-identifier">_</span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">{-
Note [Care with roughTopName]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this
    module M where { x = a:b }
    module N where { ...f x...
                     RULE f (p:q) = ... }
You'd expect the rule to match, because the matcher can
look through the unfolding of 'x'.  So we must avoid roughTopName
returning 'M.x' for the call (f x), or else it'll say &quot;can't match&quot;
and we won't even try!!

However, suppose we have
         RULE g (M.h x) = ...
         foo = ...(g (M.k v))....
where k is a *function* exported by M.  We never really match
functions (lambdas) except by name, so in this case it seems like
a good idea to treat 'M.k' as a roughTopName of the call.
-}</span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span class="annot"><a href="GHC.Core.Rules.html#pprRulesForUser"><span class="hs-identifier hs-type">pprRulesForUser</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-318"></span><span class="hs-comment">-- (a) tidy the rules</span><span>
</span><span id="line-319"></span><span class="hs-comment">-- (b) sort them into order based on the rule name</span><span>
</span><span id="line-320"></span><span class="hs-comment">-- (c) suppress uniques (unless -dppr-debug is on)</span><span>
</span><span id="line-321"></span><span class="hs-comment">-- This combination makes the output stable so we can use in testing</span><span>
</span><span id="line-322"></span><span class="hs-comment">-- It's here rather than in GHC.Core.Ppr because it calls tidyRules</span><span>
</span><span id="line-323"></span><span id="pprRulesForUser"><span class="annot"><span class="annottext">pprRulesForUser :: [CoreRule] -&gt; SDoc
</span><a href="GHC.Core.Rules.html#pprRulesForUser"><span class="hs-identifier hs-var hs-var">pprRulesForUser</span></a></span></span><span> </span><span id="local-6989586621682893477"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893477"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PprStyle -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#withPprStyle"><span class="hs-identifier hs-var">withPprStyle</span></a></span><span> </span><span class="annot"><span class="annottext">PprStyle
</span><a href="GHC.Utils.Outputable.html#defaultUserStyle"><span class="hs-identifier hs-var">defaultUserStyle</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><span class="annottext">[CoreRule] -&gt; SDoc
</span><a href="GHC.Core.Ppr.html#pprRules"><span class="hs-identifier hs-var">pprRules</span></a></span><span> </span><span class="annot"><span class="annottext">([CoreRule] -&gt; SDoc) -&gt; [CoreRule] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="annottext">(CoreRule -&gt; CoreRule -&gt; Ordering) -&gt; [CoreRule] -&gt; [CoreRule]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleName -&gt; RuleName -&gt; Ordering
</span><a href="GHC.Data.FastString.html#lexicalCompareFS"><span class="hs-identifier hs-var">lexicalCompareFS</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleName -&gt; RuleName -&gt; Ordering)
-&gt; (CoreRule -&gt; RuleName) -&gt; CoreRule -&gt; CoreRule -&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; RuleName
</span><a href="GHC.Core.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([CoreRule] -&gt; [CoreRule]) -&gt; [CoreRule] -&gt; [CoreRule]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">TidyEnv -&gt; [CoreRule] -&gt; [CoreRule]
</span><a href="GHC.Core.Tidy.html#tidyRules"><span class="hs-identifier hs-var">tidyRules</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="GHC.Types.Var.Env.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893477"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                RuleInfo: the rules in an IdInfo
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="annot"><a href="GHC.Core.Rules.html#extendRuleInfo"><span class="hs-identifier hs-type">extendRuleInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span>
</span><span id="line-338"></span><span id="extendRuleInfo"><span class="annot"><span class="annottext">extendRuleInfo :: RuleInfo -&gt; [CoreRule] -&gt; RuleInfo
</span><a href="GHC.Core.Rules.html#extendRuleInfo"><span class="hs-identifier hs-var hs-var">extendRuleInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span> </span><span id="local-6989586621682893483"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893483"><span class="hs-identifier hs-var">rs1</span></a></span></span><span> </span><span id="local-6989586621682893484"><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682893484"><span class="hs-identifier hs-var">fvs1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893485"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893485"><span class="hs-identifier hs-var">rs2</span></a></span></span><span>
</span><span id="line-339"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; DVarSet -&gt; RuleInfo
</span><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893485"><span class="hs-identifier hs-var">rs2</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893483"><span class="hs-identifier hs-var">rs1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreRule] -&gt; DVarSet
</span><a href="GHC.Core.FVs.html#rulesFreeVarsDSet"><span class="hs-identifier hs-var">rulesFreeVarsDSet</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893485"><span class="hs-identifier hs-var">rs2</span></a></span><span> </span><span class="annot"><span class="annottext">DVarSet -&gt; DVarSet -&gt; DVarSet
</span><a href="GHC.Types.Var.Set.html#unionDVarSet"><span class="hs-operator hs-var">`unionDVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682893484"><span class="hs-identifier hs-var">fvs1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span class="annot"><a href="GHC.Core.Rules.html#addRuleInfo"><span class="hs-identifier hs-type">addRuleInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span>
</span><span id="line-342"></span><span id="addRuleInfo"><span class="annot"><span class="annottext">addRuleInfo :: RuleInfo -&gt; RuleInfo -&gt; RuleInfo
</span><a href="GHC.Core.Rules.html#addRuleInfo"><span class="hs-identifier hs-var hs-var">addRuleInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span> </span><span id="local-6989586621682893487"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893487"><span class="hs-identifier hs-var">rs1</span></a></span></span><span> </span><span id="local-6989586621682893488"><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682893488"><span class="hs-identifier hs-var">fvs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span> </span><span id="local-6989586621682893489"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893489"><span class="hs-identifier hs-var">rs2</span></a></span></span><span> </span><span id="local-6989586621682893490"><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682893490"><span class="hs-identifier hs-var">fvs2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; DVarSet -&gt; RuleInfo
</span><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893487"><span class="hs-identifier hs-var">rs1</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893489"><span class="hs-identifier hs-var">rs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682893488"><span class="hs-identifier hs-var">fvs1</span></a></span><span> </span><span class="annot"><span class="annottext">DVarSet -&gt; DVarSet -&gt; DVarSet
</span><a href="GHC.Types.Var.Set.html#unionDVarSet"><span class="hs-operator hs-var">`unionDVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682893490"><span class="hs-identifier hs-var">fvs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="annot"><a href="GHC.Core.Rules.html#addIdSpecialisations"><span class="hs-identifier hs-type">addIdSpecialisations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-346"></span><span id="addIdSpecialisations"><span class="annot"><span class="annottext">addIdSpecialisations :: Var -&gt; [CoreRule] -&gt; Var
</span><a href="GHC.Core.Rules.html#addIdSpecialisations"><span class="hs-identifier hs-var hs-var">addIdSpecialisations</span></a></span></span><span> </span><span id="local-6989586621682893491"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893491"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682893492"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893492"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893492"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893491"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-350"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; RuleInfo -&gt; Var
</span><a href="GHC.Types.Id.html#setIdSpecialisation"><span class="hs-identifier hs-var">setIdSpecialisation</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893491"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleInfo -&gt; Var) -&gt; RuleInfo -&gt; Var
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><span class="annottext">RuleInfo -&gt; [CoreRule] -&gt; RuleInfo
</span><a href="GHC.Core.Rules.html#extendRuleInfo"><span class="hs-identifier hs-var">extendRuleInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; RuleInfo
</span><a href="GHC.Types.Id.html#idSpecialisation"><span class="hs-identifier hs-var">idSpecialisation</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893491"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893492"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="annot"><a href="GHC.Core.Rules.html#addRulesToId"><span class="hs-identifier hs-type">addRulesToId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-354"></span><span class="hs-comment">-- Add rules in the RuleBase to the rules in the Id</span><span>
</span><span id="line-355"></span><span id="addRulesToId"><span class="annot"><span class="annottext">addRulesToId :: RuleBase -&gt; Var -&gt; Var
</span><a href="GHC.Core.Rules.html#addRulesToId"><span class="hs-identifier hs-var hs-var">addRulesToId</span></a></span></span><span> </span><span id="local-6989586621682893496"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893496"><span class="hs-identifier hs-var">rule_base</span></a></span></span><span> </span><span id="local-6989586621682893497"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893497"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893498"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893498"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; Name -&gt; Maybe [CoreRule]
forall a. NameEnv a -&gt; Name -&gt; Maybe a
</span><a href="GHC.Types.Name.Env.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893496"><span class="hs-identifier hs-var">rule_base</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893497"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893497"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; [CoreRule] -&gt; Var
</span><a href="GHC.Core.Rules.html#addIdSpecialisations"><span class="hs-operator hs-var">`addIdSpecialisations`</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893498"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893497"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span class="annot"><span class="hs-comment">-- | Gather all the rules for locally bound identifiers from the supplied bindings</span></span><span>
</span><span id="line-362"></span><span class="annot"><a href="GHC.Core.Rules.html#rulesOfBinds"><span class="hs-identifier hs-type">rulesOfBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-363"></span><span id="rulesOfBinds"><span class="annot"><span class="annottext">rulesOfBinds :: [CoreBind] -&gt; [CoreRule]
</span><a href="GHC.Core.Rules.html#rulesOfBinds"><span class="hs-identifier hs-var hs-var">rulesOfBinds</span></a></span></span><span> </span><span id="local-6989586621682893500"><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621682893500"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreBind -&gt; [CoreRule]) -&gt; [CoreBind] -&gt; [CoreRule]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Var -&gt; [CoreRule]) -&gt; [Var] -&gt; [CoreRule]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Var -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">([Var] -&gt; [CoreRule])
-&gt; (CoreBind -&gt; [Var]) -&gt; CoreBind -&gt; [CoreRule]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; [Var]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621682893500"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                RuleBase
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span class="annot"><span class="hs-comment">-- | Gathers a collection of 'CoreRule's. Maps (the name of) an 'Id' to its rules</span></span><span>
</span><span id="line-375"></span><span class="hs-keyword">type</span><span> </span><span id="RuleBase"><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-var">RuleBase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-376"></span><span>        </span><span class="hs-comment">-- The rules are unordered;</span><span>
</span><span id="line-377"></span><span>        </span><span class="hs-comment">-- we sort out any overlaps on lookup</span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span class="annot"><a href="GHC.Core.Rules.html#emptyRuleBase"><span class="hs-identifier hs-type">emptyRuleBase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span>
</span><span id="line-380"></span><span id="emptyRuleBase"><span class="annot"><span class="annottext">emptyRuleBase :: RuleBase
</span><a href="GHC.Core.Rules.html#emptyRuleBase"><span class="hs-identifier hs-var hs-var">emptyRuleBase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase
forall a. NameEnv a
</span><a href="GHC.Types.Name.Env.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="annot"><a href="GHC.Core.Rules.html#mkRuleBase"><span class="hs-identifier hs-type">mkRuleBase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span>
</span><span id="line-383"></span><span id="mkRuleBase"><span class="annot"><span class="annottext">mkRuleBase :: [CoreRule] -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#mkRuleBase"><span class="hs-identifier hs-var hs-var">mkRuleBase</span></a></span></span><span> </span><span id="local-6989586621682893506"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893506"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; [CoreRule] -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#extendRuleBaseList"><span class="hs-identifier hs-var">extendRuleBaseList</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="GHC.Core.Rules.html#emptyRuleBase"><span class="hs-identifier hs-var">emptyRuleBase</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893506"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span class="annot"><a href="GHC.Core.Rules.html#extendRuleBaseList"><span class="hs-identifier hs-type">extendRuleBaseList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span>
</span><span id="line-386"></span><span id="extendRuleBaseList"><span class="annot"><span class="annottext">extendRuleBaseList :: RuleBase -&gt; [CoreRule] -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#extendRuleBaseList"><span class="hs-identifier hs-var hs-var">extendRuleBaseList</span></a></span></span><span> </span><span id="local-6989586621682893507"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893507"><span class="hs-identifier hs-var">rule_base</span></a></span></span><span> </span><span id="local-6989586621682893508"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893508"><span class="hs-identifier hs-var">new_guys</span></a></span></span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RuleBase -&gt; CoreRule -&gt; RuleBase)
-&gt; RuleBase -&gt; [CoreRule] -&gt; RuleBase
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; CoreRule -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#extendRuleBase"><span class="hs-identifier hs-var">extendRuleBase</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893507"><span class="hs-identifier hs-var">rule_base</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893508"><span class="hs-identifier hs-var">new_guys</span></a></span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span class="annot"><a href="GHC.Core.Rules.html#extendRuleBase"><span class="hs-identifier hs-type">extendRuleBase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span>
</span><span id="line-390"></span><span id="extendRuleBase"><span class="annot"><span class="annottext">extendRuleBase :: RuleBase -&gt; CoreRule -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#extendRuleBase"><span class="hs-identifier hs-var hs-var">extendRuleBase</span></a></span></span><span> </span><span id="local-6989586621682893511"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893511"><span class="hs-identifier hs-var">rule_base</span></a></span></span><span> </span><span id="local-6989586621682893512"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893512"><span class="hs-identifier hs-var">rule</span></a></span></span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreRule -&gt; [CoreRule] -&gt; [CoreRule])
-&gt; (CoreRule -&gt; [CoreRule])
-&gt; RuleBase
-&gt; Name
-&gt; CoreRule
-&gt; RuleBase
forall a b.
(a -&gt; b -&gt; b) -&gt; (a -&gt; b) -&gt; NameEnv b -&gt; Name -&gt; a -&gt; NameEnv b
</span><a href="GHC.Types.Name.Env.html#extendNameEnv_Acc"><span class="hs-identifier hs-var">extendNameEnv_Acc</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; [CoreRule]
forall a. a -&gt; [a]
</span><a href="GHC.Utils.Misc.html#singleton"><span class="hs-identifier hs-var">Utils.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893511"><span class="hs-identifier hs-var">rule_base</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; Name
</span><a href="GHC.Core.html#ruleIdName"><span class="hs-identifier hs-var">ruleIdName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893512"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893512"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span class="annot"><a href="GHC.Core.Rules.html#pprRuleBase"><span class="hs-identifier hs-type">pprRuleBase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-394"></span><span id="pprRuleBase"><span class="annot"><span class="annottext">pprRuleBase :: RuleBase -&gt; SDoc
</span><a href="GHC.Core.Rules.html#pprRuleBase"><span class="hs-identifier hs-var hs-var">pprRuleBase</span></a></span></span><span> </span><span id="local-6989586621682893516"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893516"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; ([[CoreRule]] -&gt; SDoc) -&gt; SDoc
forall {k} (key :: k) a. UniqFM key a -&gt; ([a] -&gt; SDoc) -&gt; SDoc
</span><a href="GHC.Types.Unique.FM.html#pprUFM"><span class="hs-identifier hs-var">pprUFM</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893516"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">(([[CoreRule]] -&gt; SDoc) -&gt; SDoc) -&gt; ([[CoreRule]] -&gt; SDoc) -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682893518"><span class="annot"><span class="annottext">[[CoreRule]]
</span><a href="#local-6989586621682893518"><span class="hs-identifier hs-var">rss</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-395"></span><span>  </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; SDoc
</span><a href="GHC.Core.Ppr.html#pprRules"><span class="hs-identifier hs-var">pprRules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; [CoreRule] -&gt; [CoreRule]
</span><a href="GHC.Core.Tidy.html#tidyRules"><span class="hs-identifier hs-var">tidyRules</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="GHC.Types.Var.Env.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893520"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682893520"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893520"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[[CoreRule]]
</span><a href="#local-6989586621682893518"><span class="hs-identifier hs-var">rss</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span class="hs-comment">-- | A full rule environment which we can apply rules from.  Like a 'RuleBase',</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- but it also includes the set of visible orphans we use to filter out orphan</span><span>
</span><span id="line-400"></span><span class="hs-comment">-- rules which are not visible (even though we can see them...)</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- See Note [Orphans] in GHC.Core</span><span>
</span><span id="line-402"></span><span class="hs-keyword">data</span><span> </span><span id="RuleEnv"><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-var">RuleEnv</span></a></span></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="RuleEnv"><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-var">RuleEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="re_local_rules"><span class="annot"><span class="annottext">RuleEnv -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#re_local_rules"><span class="hs-identifier hs-var hs-var">re_local_rules</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-comment">-- Rules from this module</span><span>
</span><span id="line-404"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="re_home_rules"><span class="annot"><span class="annottext">RuleEnv -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#re_home_rules"><span class="hs-identifier hs-var hs-var">re_home_rules</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-comment">-- Rule from the home package</span><span>
</span><span id="line-405"></span><span>                                              </span><span class="hs-comment">--   (excl this module)</span><span>
</span><span id="line-406"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="re_eps_rules"><span class="annot"><span class="annottext">RuleEnv -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#re_eps_rules"><span class="hs-identifier hs-var hs-var">re_eps_rules</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-comment">-- Rules from other packages</span><span>
</span><span id="line-407"></span><span>                                              </span><span class="hs-comment">--   see Note [External package rules]</span><span>
</span><span id="line-408"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="re_visible_orphs"><span class="annot"><span class="annottext">RuleEnv -&gt; ModuleSet
</span><a href="GHC.Core.Rules.html#re_visible_orphs"><span class="hs-identifier hs-var hs-var">re_visible_orphs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Unit.Module.Env.html#ModuleSet"><span class="hs-identifier hs-type">ModuleSet</span></a></span><span>
</span><span id="line-409"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="annot"><a href="GHC.Core.Rules.html#mkRuleEnv"><span class="hs-identifier hs-type">mkRuleEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span>
</span><span id="line-412"></span><span id="mkRuleEnv"><span class="annot"><span class="annottext">mkRuleEnv :: ModGuts -&gt; RuleBase -&gt; RuleBase -&gt; RuleEnv
</span><a href="GHC.Core.Rules.html#mkRuleEnv"><span class="hs-identifier hs-var hs-var">mkRuleEnv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mg_module :: ModGuts -&gt; Module
</span><a href="GHC.Unit.Module.ModGuts.html#mg_module"><span class="hs-identifier hs-var">mg_module</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893528"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682893528"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span>
</span><span id="line-413"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mg_deps :: ModGuts -&gt; Dependencies
</span><a href="GHC.Unit.Module.ModGuts.html#mg_deps"><span class="hs-identifier hs-var">mg_deps</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893530"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621682893530"><span class="hs-identifier hs-var">deps</span></a></span></span><span>
</span><span id="line-414"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mg_rules :: ModGuts -&gt; [CoreRule]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_rules"><span class="hs-identifier hs-var">mg_rules</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893532"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893532"><span class="hs-identifier hs-var">local_rules</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>          </span><span id="local-6989586621682893533"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893533"><span class="hs-identifier hs-var">eps_rules</span></a></span></span><span> </span><span id="local-6989586621682893534"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893534"><span class="hs-identifier hs-var">hpt_rules</span></a></span></span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">re_local_rules :: RuleBase
</span><a href="GHC.Core.Rules.html#re_local_rules"><span class="hs-identifier hs-var">re_local_rules</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#mkRuleBase"><span class="hs-identifier hs-var">mkRuleBase</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893532"><span class="hs-identifier hs-var">local_rules</span></a></span><span>
</span><span id="line-417"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_home_rules :: RuleBase
</span><a href="GHC.Core.Rules.html#re_home_rules"><span class="hs-identifier hs-var">re_home_rules</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893534"><span class="hs-identifier hs-var">hpt_rules</span></a></span><span>
</span><span id="line-418"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_eps_rules :: RuleBase
</span><a href="GHC.Core.Rules.html#re_eps_rules"><span class="hs-identifier hs-var">re_eps_rules</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893533"><span class="hs-identifier hs-var">eps_rules</span></a></span><span>
</span><span id="line-419"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_visible_orphs :: ModuleSet
</span><a href="GHC.Core.Rules.html#re_visible_orphs"><span class="hs-identifier hs-var">re_visible_orphs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Module] -&gt; ModuleSet
</span><a href="GHC.Unit.Module.Env.html#mkModuleSet"><span class="hs-identifier hs-var">mkModuleSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Module]
</span><a href="#local-6989586621682893536"><span class="hs-identifier hs-var">vis_orphs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-421"></span><span>    </span><span id="local-6989586621682893536"><span class="annot"><span class="annottext">vis_orphs :: [Module]
</span><a href="#local-6989586621682893536"><span class="hs-identifier hs-var hs-var">vis_orphs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682893528"><span class="hs-identifier hs-var">this_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Module -&gt; [Module] -&gt; [Module]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Dependencies -&gt; [Module]
</span><a href="GHC.Unit.Module.Deps.html#dep_orphs"><span class="hs-identifier hs-var">dep_orphs</span></a></span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621682893530"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span class="annot"><a href="GHC.Core.Rules.html#updExternalPackageRules"><span class="hs-identifier hs-type">updExternalPackageRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span>
</span><span id="line-424"></span><span class="hs-comment">-- Completely over-ride the external rules in RuleEnv</span><span>
</span><span id="line-425"></span><span id="updExternalPackageRules"><span class="annot"><span class="annottext">updExternalPackageRules :: RuleEnv -&gt; RuleBase -&gt; RuleEnv
</span><a href="GHC.Core.Rules.html#updExternalPackageRules"><span class="hs-identifier hs-var hs-var">updExternalPackageRules</span></a></span></span><span> </span><span id="local-6989586621682893538"><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682893538"><span class="hs-identifier hs-var">rule_env</span></a></span></span><span> </span><span id="local-6989586621682893539"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893539"><span class="hs-identifier hs-var">eps_rules</span></a></span></span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682893538"><span class="hs-identifier hs-var">rule_env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#re_eps_rules"><span class="hs-identifier hs-var">re_eps_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682893539"><span class="hs-identifier hs-type">eps_rules</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span class="annot"><a href="GHC.Core.Rules.html#updLocalRules"><span class="hs-identifier hs-type">updLocalRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span>
</span><span id="line-429"></span><span class="hs-comment">-- Completely over-ride the local rules in RuleEnv</span><span>
</span><span id="line-430"></span><span id="updLocalRules"><span class="annot"><span class="annottext">updLocalRules :: RuleEnv -&gt; [CoreRule] -&gt; RuleEnv
</span><a href="GHC.Core.Rules.html#updLocalRules"><span class="hs-identifier hs-var hs-var">updLocalRules</span></a></span></span><span> </span><span id="local-6989586621682893540"><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682893540"><span class="hs-identifier hs-var">rule_env</span></a></span></span><span> </span><span id="local-6989586621682893541"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893541"><span class="hs-identifier hs-var">local_rules</span></a></span></span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682893540"><span class="hs-identifier hs-var">rule_env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#re_local_rules"><span class="hs-identifier hs-var">re_local_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#mkRuleBase"><span class="hs-identifier hs-type">mkRuleBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893541"><span class="hs-identifier hs-type">local_rules</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="annot"><a href="GHC.Core.Rules.html#addLocalRules"><span class="hs-identifier hs-type">addLocalRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span>
</span><span id="line-434"></span><span class="hs-comment">-- Add new local rules</span><span>
</span><span id="line-435"></span><span id="addLocalRules"><span class="annot"><span class="annottext">addLocalRules :: RuleEnv -&gt; [CoreRule] -&gt; RuleEnv
</span><a href="GHC.Core.Rules.html#addLocalRules"><span class="hs-identifier hs-var hs-var">addLocalRules</span></a></span></span><span> </span><span id="local-6989586621682893542"><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682893542"><span class="hs-identifier hs-var">rule_env</span></a></span></span><span> </span><span id="local-6989586621682893543"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893543"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621682893542"><span class="hs-identifier hs-var">rule_env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#re_local_rules"><span class="hs-identifier hs-var">re_local_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#extendRuleBaseList"><span class="hs-identifier hs-type">extendRuleBaseList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#re_local_rules"><span class="hs-identifier hs-var">re_local_rules</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893542"><span class="hs-identifier hs-type">rule_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682893543"><span class="hs-identifier hs-type">rules</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="annot"><a href="GHC.Core.Rules.html#emptyRuleEnv"><span class="hs-identifier hs-type">emptyRuleEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span>
</span><span id="line-439"></span><span id="emptyRuleEnv"><span class="annot"><span class="annottext">emptyRuleEnv :: RuleEnv
</span><a href="GHC.Core.Rules.html#emptyRuleEnv"><span class="hs-identifier hs-var hs-var">emptyRuleEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">re_local_rules :: RuleBase
</span><a href="GHC.Core.Rules.html#re_local_rules"><span class="hs-identifier hs-var">re_local_rules</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase
forall a. NameEnv a
</span><a href="GHC.Types.Name.Env.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a></span><span>
</span><span id="line-440"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_home_rules :: RuleBase
</span><a href="GHC.Core.Rules.html#re_home_rules"><span class="hs-identifier hs-var">re_home_rules</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase
forall a. NameEnv a
</span><a href="GHC.Types.Name.Env.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a></span><span>
</span><span id="line-441"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_eps_rules :: RuleBase
</span><a href="GHC.Core.Rules.html#re_eps_rules"><span class="hs-identifier hs-var">re_eps_rules</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase
forall a. NameEnv a
</span><a href="GHC.Types.Name.Env.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a></span><span>
</span><span id="line-442"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_visible_orphs :: ModuleSet
</span><a href="GHC.Core.Rules.html#re_visible_orphs"><span class="hs-identifier hs-var">re_visible_orphs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModuleSet
</span><a href="GHC.Unit.Module.Env.html#emptyModuleSet"><span class="hs-identifier hs-var">emptyModuleSet</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span class="annot"><a href="GHC.Core.Rules.html#getRules"><span class="hs-identifier hs-type">getRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-445"></span><span class="hs-comment">-- Given a RuleEnv and an Id, find the visible rules for that Id</span><span>
</span><span id="line-446"></span><span class="hs-comment">-- See Note [Where rules are found]</span><span>
</span><span id="line-447"></span><span class="hs-comment">--</span><span>
</span><span id="line-448"></span><span class="hs-comment">-- This function is quite heavily used, so it's worth trying to make it efficient</span><span>
</span><span id="line-449"></span><span id="getRules"><span class="annot"><span class="annottext">getRules :: RuleEnv -&gt; Var -&gt; [CoreRule]
</span><a href="GHC.Core.Rules.html#getRules"><span class="hs-identifier hs-var hs-var">getRules</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">re_local_rules :: RuleEnv -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#re_local_rules"><span class="hs-identifier hs-var">re_local_rules</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893545"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893545"><span class="hs-identifier hs-var">local_rule_base</span></a></span></span><span>
</span><span id="line-450"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_home_rules :: RuleEnv -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#re_home_rules"><span class="hs-identifier hs-var">re_home_rules</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893546"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893546"><span class="hs-identifier hs-var">home_rule_base</span></a></span></span><span>
</span><span id="line-451"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_eps_rules :: RuleEnv -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#re_eps_rules"><span class="hs-identifier hs-var">re_eps_rules</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893547"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893547"><span class="hs-identifier hs-var">eps_rule_base</span></a></span></span><span>
</span><span id="line-452"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_visible_orphs :: RuleEnv -&gt; ModuleSet
</span><a href="GHC.Core.Rules.html#re_visible_orphs"><span class="hs-identifier hs-var">re_visible_orphs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893548"><span class="annot"><span class="annottext">ModuleSet
</span><a href="#local-6989586621682893548"><span class="hs-identifier hs-var">orphs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893549"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893549"><span class="hs-identifier hs-var">fn</span></a></span></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Maybe DataCon
</span><a href="GHC.Types.Id.html#isDataConId_maybe"><span class="hs-identifier hs-var">isDataConId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893549"><span class="hs-identifier hs-var">fn</span></a></span><span>   </span><span class="hs-comment">-- Short cut for data constructor workers</span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                                </span><span class="hs-comment">-- and wrappers, which never have any rules</span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893551"><span class="annot"><span class="annottext">ExportFlag
</span><a href="#local-6989586621682893551"><span class="hs-identifier hs-var">export_flag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Maybe ExportFlag
</span><a href="GHC.Types.Var.html#isLocalId_maybe"><span class="hs-identifier hs-var">isLocalId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893549"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-458"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- LocalIds can't have rules in the local_rule_base (used for imported fns)</span><span>
</span><span id="line-459"></span><span>    </span><span class="hs-comment">-- nor external packages; but there can (just) be rules in another module</span><span>
</span><span id="line-460"></span><span>    </span><span class="hs-comment">-- in the home package, if it is exported</span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExportFlag
</span><a href="#local-6989586621682893551"><span class="hs-identifier hs-var">export_flag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-462"></span><span>      </span><span class="annot"><span class="annottext">ExportFlag
</span><a href="GHC.Types.Var.html#NotExported"><span class="hs-identifier hs-var">NotExported</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Var -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893549"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-463"></span><span>      </span><span class="annot"><span class="annottext">ExportFlag
</span><a href="GHC.Types.Var.html#Exported"><span class="hs-identifier hs-var">Exported</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; [CoreRule]
</span><a href="#local-6989586621682893555"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893546"><span class="hs-identifier hs-var">home_rule_base</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-464"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Var -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893549"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-465"></span><span>          </span><span id="local-6989586621682893556"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893556"><span class="hs-identifier hs-var">home_rules</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule]
</span><a href="#local-6989586621682893557"><span class="hs-identifier hs-var">drop_orphs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893556"><span class="hs-identifier hs-var">home_rules</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Var -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893549"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-468"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- This case expression is a fast path, to avoid calling the</span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-comment">-- recursive (++) in the common case where there are no rules at all</span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleBase -&gt; [CoreRule]
</span><a href="#local-6989586621682893555"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893545"><span class="hs-identifier hs-var">local_rule_base</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; [CoreRule]
</span><a href="#local-6989586621682893555"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893546"><span class="hs-identifier hs-var">home_rule_base</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; [CoreRule]
</span><a href="#local-6989586621682893555"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893547"><span class="hs-identifier hs-var">eps_rule_base</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-471"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Var -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893549"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-472"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621682893558"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893558"><span class="hs-identifier hs-var">local_rules</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893559"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893559"><span class="hs-identifier hs-var">home_rules</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893560"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893560"><span class="hs-identifier hs-var">eps_rules</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893558"><span class="hs-identifier hs-var">local_rules</span></a></span><span>           </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-473"></span><span>                                              </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule]
</span><a href="#local-6989586621682893557"><span class="hs-identifier hs-var">drop_orphs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893559"><span class="hs-identifier hs-var">home_rules</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-474"></span><span>                                              </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule]
</span><a href="#local-6989586621682893557"><span class="hs-identifier hs-var">drop_orphs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893560"><span class="hs-identifier hs-var">eps_rules</span></a></span><span>  </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-475"></span><span>                                              </span><span class="annot"><span class="annottext">Var -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893549"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-476"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-477"></span><span>    </span><span id="local-6989586621682893561"><span class="annot"><span class="annottext">fn_name :: Name
</span><a href="#local-6989586621682893561"><span class="hs-identifier hs-var hs-var">fn_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893549"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-478"></span><span>    </span><span id="local-6989586621682893557"><span class="annot"><span class="annottext">drop_orphs :: [CoreRule] -&gt; [CoreRule]
</span><a href="#local-6989586621682893557"><span class="hs-identifier hs-var hs-var">drop_orphs</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Fast path; avoid invoking recursive filter</span><span>
</span><span id="line-479"></span><span>    </span><span class="annot"><a href="#local-6989586621682893557"><span class="hs-identifier hs-var">drop_orphs</span></a></span><span> </span><span id="local-6989586621682893562"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893562"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreRule -&gt; Bool) -&gt; [CoreRule] -&gt; [CoreRule]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModuleSet -&gt; CoreRule -&gt; Bool
</span><a href="GHC.Core.Rules.html#ruleIsVisible"><span class="hs-identifier hs-var">ruleIsVisible</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleSet
</span><a href="#local-6989586621682893548"><span class="hs-identifier hs-var">orphs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893562"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-480"></span><span>    </span><span id="local-6989586621682893555"><span class="annot"><span class="annottext">get :: RuleBase -&gt; [CoreRule]
</span><a href="#local-6989586621682893555"><span class="hs-identifier hs-var hs-var">get</span></a></span></span><span> </span><span id="local-6989586621682893564"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893564"><span class="hs-identifier hs-var">rb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; Name -&gt; Maybe [CoreRule]
forall a. NameEnv a -&gt; Name -&gt; Maybe a
</span><a href="GHC.Types.Name.Env.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621682893564"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682893561"><span class="hs-identifier hs-var">fn_name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleIsVisible"><span class="hs-identifier hs-type">ruleIsVisible</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Env.html#ModuleSet"><span class="hs-identifier hs-type">ModuleSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-483"></span><span id="ruleIsVisible"><span class="annot"><span class="annottext">ruleIsVisible :: ModuleSet -&gt; CoreRule -&gt; Bool
</span><a href="GHC.Core.Rules.html#ruleIsVisible"><span class="hs-identifier hs-var hs-var">ruleIsVisible</span></a></span></span><span> </span><span class="annot"><span class="annottext">ModuleSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-484"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleIsVisible"><span class="hs-identifier hs-var">ruleIsVisible</span></a></span><span> </span><span id="local-6989586621682893567"><span class="annot"><span class="annottext">ModuleSet
</span><a href="#local-6989586621682893567"><span class="hs-identifier hs-var">vis_orphs</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_orphan :: CoreRule -&gt; IsOrphan
</span><a href="GHC.Core.html#ru_orphan"><span class="hs-identifier hs-var">ru_orphan</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893568"><span class="annot"><span class="annottext">IsOrphan
</span><a href="#local-6989586621682893568"><span class="hs-identifier hs-var">orph</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_origin :: CoreRule -&gt; Module
</span><a href="GHC.Core.html#ru_origin"><span class="hs-identifier hs-var">ru_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893569"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682893569"><span class="hs-identifier hs-var">origin</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-485"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsOrphan -&gt; Bool
</span><a href="GHC.Core.html#notOrphan"><span class="hs-identifier hs-var">notOrphan</span></a></span><span> </span><span class="annot"><span class="annottext">IsOrphan
</span><a href="#local-6989586621682893568"><span class="hs-identifier hs-var">orph</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682893569"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">Module -&gt; ModuleSet -&gt; Bool
</span><a href="GHC.Unit.Module.Env.html#elemModuleSet"><span class="hs-operator hs-var">`elemModuleSet`</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleSet
</span><a href="#local-6989586621682893567"><span class="hs-identifier hs-var">vis_orphs</span></a></span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span class="hs-comment">{- Note [Where rules are found]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The rules for an Id come from two places:
  (a) the ones it is born with, stored inside the Id itself (idCoreRules fn),
  (b) rules added in other modules, stored in the global RuleBase (imp_rules)

It's tempting to think that
     - LocalIds have only (a)
     - non-LocalIds have only (b)

but that isn't quite right:

     - PrimOps and ClassOps are born with a bunch of rules inside the Id,
       even when they are imported

     - The rules in GHC.Core.Opt.ConstantFold.builtinRules should be active even
       in the module defining the Id (when it's a LocalId), but
       the rules are kept in the global RuleBase

 Note [External package rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In Note [Overall plumbing for rules], it is explained that the final
RuleBase which we must consider is combined from 4 different sources.

During simplifier runs, the fourth source of rules is constantly being updated
as new interfaces are loaded into the EPS. Therefore just before we check to see
if any rules match we get the EPS RuleBase and combine it with the existing RuleBase
and then perform exactly 1 lookup into the new map.

It is more efficient to avoid combining the environments and store the uncombined
environments as we can instead perform 1 lookup into each environment and then combine
the results.

Essentially we use the identity:

&gt; lookupNameEnv n (plusNameEnv_C (++) rb1 rb2)
&gt;   = lookupNameEnv n rb1 ++ lookupNameEnv n rb2

The latter being more efficient as we don't construct an intermediate
map.
-}</span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                        Matching
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span class="hs-comment">-- | The main rule matching function. Attempts to apply all (active)</span><span>
</span><span id="line-538"></span><span class="hs-comment">-- supplied rules to this instance of an application in a given</span><span>
</span><span id="line-539"></span><span class="hs-comment">-- context, returning the rule applied and the resulting expression if</span><span>
</span><span id="line-540"></span><span class="hs-comment">-- successful.</span><span>
</span><span id="line-541"></span><span class="annot"><a href="GHC.Core.Rules.html#lookupRule"><span class="hs-identifier hs-type">lookupRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.Config.html#RuleOpts"><span class="hs-identifier hs-type">RuleOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a></span><span>
</span><span id="line-542"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- When rule is active</span><span>
</span><span id="line-543"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-comment">-- Function head</span><span>
</span><span id="line-544"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Args</span><span>
</span><span id="line-545"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Rules</span><span>
</span><span id="line-546"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>
</span><span id="line-548"></span><span class="hs-comment">-- See Note [Extra args in the target]</span><span>
</span><span id="line-549"></span><span class="hs-comment">-- See comments on matchRule</span><span>
</span><span id="line-550"></span><span id="lookupRule"><span class="annot"><span class="annottext">lookupRule :: RuleOpts
-&gt; InScopeEnv
-&gt; (Activation -&gt; Bool)
-&gt; Var
-&gt; [CoreExpr]
-&gt; [CoreRule]
-&gt; Maybe (CoreRule, CoreExpr)
</span><a href="GHC.Core.Rules.html#lookupRule"><span class="hs-identifier hs-var hs-var">lookupRule</span></a></span></span><span> </span><span id="local-6989586621682893572"><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621682893572"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682893573"><span class="annot"><span class="annottext">rule_env :: InScopeEnv
</span><a href="#local-6989586621682893573"><span class="hs-identifier hs-var">rule_env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#ISE"><span class="hs-identifier hs-type">ISE</span></a></span><span> </span><span id="local-6989586621682893575"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893575"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893576"><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682893576"><span class="hs-identifier hs-var">is_active</span></a></span></span><span> </span><span id="local-6989586621682893577"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893577"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682893578"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893578"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682893579"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893579"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-551"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;lookupRule&quot; (ppr fn &lt;+&gt; ppr args $$ ppr rules $$ ppr in_scope) $</span><span>
</span><span id="line-552"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)] -&gt; [CoreRule] -&gt; [(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893580"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893579"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-553"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (CoreRule, CoreExpr)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-554"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682893581"><span class="annot"><span class="annottext">(CoreRule, CoreExpr)
</span><a href="#local-6989586621682893581"><span class="hs-identifier hs-var">m</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682893582"><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893582"><span class="hs-identifier hs-var">ms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(CoreRule, CoreExpr) -&gt; Maybe (CoreRule, CoreExpr)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
-&gt; (Var, [CoreExpr])
-&gt; (CoreRule, CoreExpr)
-&gt; [(CoreRule, CoreExpr)]
-&gt; (CoreRule, CoreExpr)
</span><a href="GHC.Core.Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893575"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893577"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893584"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CoreRule, CoreExpr)
</span><a href="#local-6989586621682893581"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893582"><span class="hs-identifier hs-var">ms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-556"></span><span>    </span><span id="local-6989586621682893585"><span class="annot"><span class="annottext">rough_args :: [Maybe Name]
</span><a href="#local-6989586621682893585"><span class="hs-identifier hs-var hs-var">rough_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; Maybe Name) -&gt; [CoreExpr] -&gt; [Maybe Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe Name
</span><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893578"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-557"></span><span>
</span><span id="line-558"></span><span>    </span><span class="hs-comment">-- Strip ticks from arguments, see Note [Tick annotations in RULE</span><span>
</span><span id="line-559"></span><span>    </span><span class="hs-comment">-- matching]. We only collect ticks if a rule actually matches -</span><span>
</span><span id="line-560"></span><span>    </span><span class="hs-comment">-- this matters for performance tests.</span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621682893584"><span class="annot"><span class="annottext">args' :: [CoreExpr]
</span><a href="#local-6989586621682893584"><span class="hs-identifier hs-var hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; CoreExpr -&gt; CoreExpr
forall b. (CoreTickish -&gt; Bool) -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.Utils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893578"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-562"></span><span>    </span><span id="local-6989586621682893586"><span class="annot"><span class="annottext">ticks :: [CoreTickish]
</span><a href="#local-6989586621682893586"><span class="hs-identifier hs-var hs-var">ticks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; [CoreTickish]) -&gt; [CoreExpr] -&gt; [CoreTickish]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; CoreExpr -&gt; [CoreTickish]
forall b. (CoreTickish -&gt; Bool) -&gt; Expr b -&gt; [CoreTickish]
</span><a href="GHC.Core.Utils.html#stripTicksTopT"><span class="hs-identifier hs-var">stripTicksTopT</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893578"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span>    </span><span class="annot"><a href="#local-6989586621682893580"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-565"></span><span>    </span><span id="local-6989586621682893580"><span class="annot"><span class="annottext">go :: [(CoreRule, CoreExpr)] -&gt; [CoreRule] -&gt; [(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893580"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682893587"><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893587"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893587"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-566"></span><span>    </span><span class="annot"><a href="#local-6989586621682893580"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682893588"><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893588"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893589"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893589"><span class="hs-identifier hs-var">r</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682893590"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893590"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-567"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893591"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893591"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleOpts
-&gt; InScopeEnv
-&gt; (Activation -&gt; Bool)
-&gt; Var
-&gt; [CoreExpr]
-&gt; [Maybe Name]
-&gt; CoreRule
-&gt; Maybe CoreExpr
</span><a href="GHC.Core.Rules.html#matchRule"><span class="hs-identifier hs-var">matchRule</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621682893572"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682893573"><span class="hs-identifier hs-var">rule_env</span></a></span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682893576"><span class="hs-identifier hs-var">is_active</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893577"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893584"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893585"><span class="hs-identifier hs-var">rough_args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893589"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-568"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)] -&gt; [CoreRule] -&gt; [(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893580"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893589"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682893586"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893591"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(CoreRule, CoreExpr)
-&gt; [(CoreRule, CoreExpr)] -&gt; [(CoreRule, CoreExpr)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893588"><span class="hs-identifier hs-var">ms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893590"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-569"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-570"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;match failed&quot; (ppr r $$ ppr args $$</span><span>
</span><span id="line-571"></span><span>        </span><span class="hs-comment">--   ppr [ (arg_id, unfoldingTemplate unf)</span><span>
</span><span id="line-572"></span><span>        </span><span class="hs-comment">--       | Var arg_id &lt;- args</span><span>
</span><span id="line-573"></span><span>        </span><span class="hs-comment">--       , let unf = idUnfolding arg_id</span><span>
</span><span id="line-574"></span><span>        </span><span class="hs-comment">--       , isCheapUnfolding unf] )</span><span>
</span><span id="line-575"></span><span>        </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)] -&gt; [CoreRule] -&gt; [(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893580"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893588"><span class="hs-identifier hs-var">ms</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682893590"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-576"></span><span>
</span><span id="line-577"></span><span class="annot"><a href="GHC.Core.Rules.html#findBest"><span class="hs-identifier hs-type">findBest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span class="hs-comment">-- All these pairs matched the expression</span><span>
</span><span id="line-580"></span><span class="hs-comment">-- Return the pair the most specific rule</span><span>
</span><span id="line-581"></span><span class="hs-comment">-- The (fn,args) is just for overlap reporting</span><span>
</span><span id="line-582"></span><span>
</span><span id="line-583"></span><span id="findBest"><span class="annot"><span class="annottext">findBest :: InScopeSet
-&gt; (Var, [CoreExpr])
-&gt; (CoreRule, CoreExpr)
-&gt; [(CoreRule, CoreExpr)]
-&gt; (CoreRule, CoreExpr)
</span><a href="GHC.Core.Rules.html#findBest"><span class="hs-identifier hs-var hs-var">findBest</span></a></span></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span>        </span><span class="annot"><span class="annottext">(Var, [CoreExpr])
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621682893593"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893593"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682893594"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893594"><span class="hs-identifier hs-var">ans</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893593"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893594"><span class="hs-identifier hs-var">ans</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span class="annot"><a href="GHC.Core.Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a></span><span> </span><span id="local-6989586621682893595"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893595"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682893596"><span class="annot"><span class="annottext">(Var, [CoreExpr])
</span><a href="#local-6989586621682893596"><span class="hs-identifier hs-var">target</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893597"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893597"><span class="hs-identifier hs-var">rule1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682893598"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893598"><span class="hs-identifier hs-var">ans1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682893599"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893599"><span class="hs-identifier hs-var">rule2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682893600"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893600"><span class="hs-identifier hs-var">ans2</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682893601"><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893601"><span class="hs-identifier hs-var">prs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; CoreRule -&gt; CoreRule -&gt; Bool
</span><a href="GHC.Core.Rules.html#isMoreSpecific"><span class="hs-identifier hs-var">isMoreSpecific</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893595"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893597"><span class="hs-identifier hs-var">rule1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893599"><span class="hs-identifier hs-var">rule2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
-&gt; (Var, [CoreExpr])
-&gt; (CoreRule, CoreExpr)
-&gt; [(CoreRule, CoreExpr)]
-&gt; (CoreRule, CoreExpr)
</span><a href="GHC.Core.Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893595"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(Var, [CoreExpr])
</span><a href="#local-6989586621682893596"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893597"><span class="hs-identifier hs-var">rule1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893598"><span class="hs-identifier hs-var">ans1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893601"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-586"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; CoreRule -&gt; CoreRule -&gt; Bool
</span><a href="GHC.Core.Rules.html#isMoreSpecific"><span class="hs-identifier hs-var">isMoreSpecific</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893595"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893599"><span class="hs-identifier hs-var">rule2</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893597"><span class="hs-identifier hs-var">rule1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
-&gt; (Var, [CoreExpr])
-&gt; (CoreRule, CoreExpr)
-&gt; [(CoreRule, CoreExpr)]
-&gt; (CoreRule, CoreExpr)
</span><a href="GHC.Core.Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893595"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(Var, [CoreExpr])
</span><a href="#local-6989586621682893596"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893599"><span class="hs-identifier hs-var">rule2</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893600"><span class="hs-identifier hs-var">ans2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893601"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-587"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682893608"><span class="annot"><span class="annottext">pp_rule :: CoreRule -&gt; SDoc
</span><a href="#local-6989586621682893608"><span class="hs-identifier hs-var hs-var">pp_rule</span></a></span></span><span> </span><span id="local-6989586621682893609"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893609"><span class="hs-identifier hs-var">rule</span></a></span></span><span>
</span><span id="line-588"></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsOutput doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ifPprDebug"><span class="hs-identifier hs-var">ifPprDebug</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893609"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-589"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleName -&gt; SDoc
forall doc. IsLine doc =&gt; RuleName -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; RuleName
</span><a href="GHC.Core.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893609"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-590"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; (CoreRule, CoreExpr) -&gt; (CoreRule, CoreExpr)
forall a. String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rules.findBest: rule overlap (Rule 1 wins)&quot;</span></span><span>
</span><span id="line-591"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsOutput doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#whenPprDebug"><span class="hs-identifier hs-var">whenPprDebug</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-592"></span><span>                                 </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Expression to match:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893615"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-593"></span><span>                                 </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreExpr -&gt; SDoc) -&gt; [CoreExpr] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893617"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-594"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rule 1:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
</span><a href="#local-6989586621682893608"><span class="hs-identifier hs-var">pp_rule</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893597"><span class="hs-identifier hs-var">rule1</span></a></span><span>
</span><span id="line-595"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rule 2:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
</span><a href="#local-6989586621682893608"><span class="hs-identifier hs-var">pp_rule</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893599"><span class="hs-identifier hs-var">rule2</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((CoreRule, CoreExpr) -&gt; (CoreRule, CoreExpr))
-&gt; (CoreRule, CoreExpr) -&gt; (CoreRule, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-596"></span><span>                </span><span class="annot"><span class="annottext">InScopeSet
-&gt; (Var, [CoreExpr])
-&gt; (CoreRule, CoreExpr)
-&gt; [(CoreRule, CoreExpr)]
-&gt; (CoreRule, CoreExpr)
</span><a href="GHC.Core.Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893595"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(Var, [CoreExpr])
</span><a href="#local-6989586621682893596"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893597"><span class="hs-identifier hs-var">rule1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893598"><span class="hs-identifier hs-var">ans1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893601"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-597"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
-&gt; (Var, [CoreExpr])
-&gt; (CoreRule, CoreExpr)
-&gt; [(CoreRule, CoreExpr)]
-&gt; (CoreRule, CoreExpr)
</span><a href="GHC.Core.Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893595"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(Var, [CoreExpr])
</span><a href="#local-6989586621682893596"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682893597"><span class="hs-identifier hs-var">rule1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893598"><span class="hs-identifier hs-var">ans1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CoreRule, CoreExpr)]
</span><a href="#local-6989586621682893601"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-598"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-599"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682893615"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893615"><span class="hs-identifier hs-var">fn</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682893617"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893617"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Var, [CoreExpr])
</span><a href="#local-6989586621682893596"><span class="hs-identifier hs-var">target</span></a></span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span class="annot"><a href="GHC.Core.Rules.html#isMoreSpecific"><span class="hs-identifier hs-type">isMoreSpecific</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-602"></span><span class="hs-comment">-- The call (rule1 `isMoreSpecific` rule2)</span><span>
</span><span id="line-603"></span><span class="hs-comment">-- sees if rule2 can be instantiated to look like rule1</span><span>
</span><span id="line-604"></span><span class="hs-comment">-- See Note [isMoreSpecific]</span><span>
</span><span id="line-605"></span><span id="isMoreSpecific"><span class="annot"><span class="annottext">isMoreSpecific :: InScopeSet -&gt; CoreRule -&gt; CoreRule -&gt; Bool
</span><a href="GHC.Core.Rules.html#isMoreSpecific"><span class="hs-identifier hs-var hs-var">isMoreSpecific</span></a></span></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-606"></span><span class="annot"><a href="GHC.Core.Rules.html#isMoreSpecific"><span class="hs-identifier hs-var">isMoreSpecific</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-607"></span><span class="annot"><a href="GHC.Core.Rules.html#isMoreSpecific"><span class="hs-identifier hs-var">isMoreSpecific</span></a></span><span> </span><span id="local-6989586621682893618"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893618"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [Var]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893619"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893619"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893620"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893620"><span class="hs-identifier hs-var">args1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-608"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [Var]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893621"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893621"><span class="hs-identifier hs-var">bndrs2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893622"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893622"><span class="hs-identifier hs-var">args2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (CoreExpr -&gt; CoreExpr, [CoreExpr]) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeEnv
-&gt; [Var]
-&gt; [CoreExpr]
-&gt; [CoreExpr]
-&gt; Maybe (CoreExpr -&gt; CoreExpr, [CoreExpr])
</span><a href="GHC.Core.Rules.html#matchExprs"><span class="hs-identifier hs-var">matchExprs</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682893624"><span class="hs-identifier hs-var">in_scope_env</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893621"><span class="hs-identifier hs-var">bndrs2</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893622"><span class="hs-identifier hs-var">args2</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893620"><span class="hs-identifier hs-var">args1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-611"></span><span>   </span><span id="local-6989586621682893625"><span class="annot"><span class="annottext">full_in_scope :: InScopeSet
</span><a href="#local-6989586621682893625"><span class="hs-identifier hs-var hs-var">full_in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893618"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [Var] -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSetList"><span class="hs-operator hs-var">`extendInScopeSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893619"><span class="hs-identifier hs-var">bndrs1</span></a></span><span>
</span><span id="line-612"></span><span>   </span><span id="local-6989586621682893624"><span class="annot"><span class="annottext">in_scope_env :: InScopeEnv
</span><a href="#local-6989586621682893624"><span class="hs-identifier hs-var hs-var">in_scope_env</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdUnfoldingFun -&gt; InScopeEnv
</span><a href="GHC.Core.html#ISE"><span class="hs-identifier hs-var">ISE</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893625"><span class="hs-identifier hs-var">full_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#noUnfoldingFun"><span class="hs-identifier hs-var">noUnfoldingFun</span></a></span><span>
</span><span id="line-613"></span><span>                   </span><span class="hs-comment">-- noUnfoldingFun: don't expand in templates</span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span class="annot"><a href="GHC.Core.Rules.html#noBlackList"><span class="hs-identifier hs-type">noBlackList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-616"></span><span id="noBlackList"><span class="annot"><span class="annottext">noBlackList :: Activation -&gt; Bool
</span><a href="GHC.Core.Rules.html#noBlackList"><span class="hs-identifier hs-var hs-var">noBlackList</span></a></span></span><span> </span><span class="annot"><span class="annottext">Activation
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>           </span><span class="hs-comment">-- Nothing is black listed</span><span>
</span><span id="line-617"></span><span>
</span><span id="line-618"></span><span class="hs-comment">{- Note [isMoreSpecific]
~~~~~~~~~~~~~~~~~~~~~~~~
The call (rule1 `isMoreSpecific` rule2)
sees if rule2 can be instantiated to look like rule1.

Wrinkle:

* We take the view that a BuiltinRule is less specific than
  anything else, because we want user-defined rules to &quot;win&quot;
  In particular, class ops have a built-in rule, but we
  prefer any user-specific rules to win:
    eg (#4397)
       truncate :: (RealFrac a, Integral b) =&gt; a -&gt; b
       {-# RULES &quot;truncate/Double-&gt;Int&quot; truncate = double2Int #-}
       double2Int :: Double -&gt; Int
  We want the specific RULE to beat the built-in class-op rule

Note [Extra args in the target]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we find a matching rule, we return (Just (rule, rhs)),
/but/ the rule firing has only consumed as many of the input args
as the ruleArity says.  The unused arguments are handled by the code in
GHC.Core.Opt.Simplify.tryRules, using the arity of the returned rule.

E.g. Rule &quot;foo&quot;:  forall a b.  f p1 p2 = rhs
     Target:      f e1 e2 e3

Then lookupRule returns Just (Rule &quot;foo&quot;, rhs), where Rule &quot;foo&quot;
has ruleArity 2.  The real rewrite is
        f e1 e2 e3 ==&gt; rhs e3

You might think it'd be cleaner for lookupRule to deal with the
leftover arguments, by applying 'rhs' to them, but the main call
in the Simplifier works better as it is.  Reason: the 'args' passed
to lookupRule are the result of a lazy substitution

Historical note:

At one stage I tried to match even if there are more args in the
/template/ than the target.  I now think this is probably a bad idea.
Should the template (map f xs) match (map g)?  I think not.  For a
start, in general eta expansion wastes work.  SLPJ July 99
-}</span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span class="hs-comment">------------------------------------</span><span>
</span><span id="line-663"></span><span class="annot"><a href="GHC.Core.Rules.html#matchRule"><span class="hs-identifier hs-type">matchRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.Config.html#RuleOpts"><span class="hs-identifier hs-type">RuleOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-664"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-665"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-666"></span><span>
</span><span id="line-667"></span><span class="hs-comment">-- If (matchRule rule args) returns Just (name,rhs)</span><span>
</span><span id="line-668"></span><span class="hs-comment">-- then (f args) matches the rule, and the corresponding</span><span>
</span><span id="line-669"></span><span class="hs-comment">-- rewritten RHS is rhs</span><span>
</span><span id="line-670"></span><span class="hs-comment">--</span><span>
</span><span id="line-671"></span><span class="hs-comment">-- The returned expression is occurrence-analysed</span><span>
</span><span id="line-672"></span><span class="hs-comment">--</span><span>
</span><span id="line-673"></span><span class="hs-comment">--      Example</span><span>
</span><span id="line-674"></span><span class="hs-comment">--</span><span>
</span><span id="line-675"></span><span class="hs-comment">-- The rule</span><span>
</span><span id="line-676"></span><span class="hs-comment">--      forall f g x. map f (map g x) ==&gt; map (f . g) x</span><span>
</span><span id="line-677"></span><span class="hs-comment">-- is stored</span><span>
</span><span id="line-678"></span><span class="hs-comment">--      CoreRule &quot;map/map&quot;</span><span>
</span><span id="line-679"></span><span class="hs-comment">--               [f,g,x]                -- tpl_vars</span><span>
</span><span id="line-680"></span><span class="hs-comment">--               [f,map g x]            -- tpl_args</span><span>
</span><span id="line-681"></span><span class="hs-comment">--               map (f.g) x)           -- rhs</span><span>
</span><span id="line-682"></span><span class="hs-comment">--</span><span>
</span><span id="line-683"></span><span class="hs-comment">-- Then the expression</span><span>
</span><span id="line-684"></span><span class="hs-comment">--      map e1 (map e2 e3) e4</span><span>
</span><span id="line-685"></span><span class="hs-comment">-- results in a call to</span><span>
</span><span id="line-686"></span><span class="hs-comment">--      matchRule the_rule [e1,map e2 e3,e4]</span><span>
</span><span id="line-687"></span><span class="hs-comment">--        = Just (&quot;map/map&quot;, (\f,g,x -&gt; rhs) e1 e2 e3)</span><span>
</span><span id="line-688"></span><span class="hs-comment">--</span><span>
</span><span id="line-689"></span><span class="hs-comment">-- NB: The 'surplus' argument e4 in the input is simply dropped.</span><span>
</span><span id="line-690"></span><span class="hs-comment">-- See Note [Extra args in the target]</span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span id="matchRule"><span class="annot"><span class="annottext">matchRule :: RuleOpts
-&gt; InScopeEnv
-&gt; (Activation -&gt; Bool)
-&gt; Var
-&gt; [CoreExpr]
-&gt; [Maybe Name]
-&gt; CoreRule
-&gt; Maybe CoreExpr
</span><a href="GHC.Core.Rules.html#matchRule"><span class="hs-identifier hs-var hs-var">matchRule</span></a></span></span><span> </span><span id="local-6989586621682893629"><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621682893629"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682893630"><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682893630"><span class="hs-identifier hs-var">rule_env</span></a></span></span><span> </span><span id="local-6989586621682893631"><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682893631"><span class="hs-identifier hs-var">_is_active</span></a></span></span><span> </span><span id="local-6989586621682893632"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893632"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682893633"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893633"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682893634"><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893634"><span class="hs-identifier hs-var">_rough_args</span></a></span></span><span>
</span><span id="line-693"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_try :: CoreRule -&gt; RuleFun
</span><a href="GHC.Core.html#ru_try"><span class="hs-identifier hs-var">ru_try</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893636"><span class="annot"><span class="annottext">RuleFun
</span><a href="#local-6989586621682893636"><span class="hs-identifier hs-var">match_fn</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-694"></span><span class="hs-comment">-- Built-in rules can't be switched off, it seems</span><span>
</span><span id="line-695"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RuleFun
</span><a href="#local-6989586621682893636"><span class="hs-identifier hs-var">match_fn</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621682893629"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682893630"><span class="hs-identifier hs-var">rule_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893632"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893633"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-696"></span><span>        </span><span class="annot"><span class="annottext">Maybe CoreExpr
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-697"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893637"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893637"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe CoreExpr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893637"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-698"></span><span>
</span><span id="line-699"></span><span class="annot"><a href="GHC.Core.Rules.html#matchRule"><span class="hs-identifier hs-var">matchRule</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOpts
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682893638"><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682893638"><span class="hs-identifier hs-var">rule_env</span></a></span></span><span> </span><span id="local-6989586621682893639"><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682893639"><span class="hs-identifier hs-var">is_active</span></a></span></span><span> </span><span class="annot"><span class="annottext">Var
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682893640"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893640"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682893641"><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893641"><span class="hs-identifier hs-var">rough_args</span></a></span></span><span>
</span><span id="line-700"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_name :: CoreRule -&gt; RuleName
</span><a href="GHC.Core.html#ru_name"><span class="hs-identifier hs-var">ru_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893642"><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682893642"><span class="hs-identifier hs-var">rule_name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_act :: CoreRule -&gt; Activation
</span><a href="GHC.Core.html#ru_act"><span class="hs-identifier hs-var">ru_act</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893643"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682893643"><span class="hs-identifier hs-var">act</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rough :: CoreRule -&gt; [Maybe Name]
</span><a href="GHC.Core.html#ru_rough"><span class="hs-identifier hs-var">ru_rough</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893644"><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893644"><span class="hs-identifier hs-var">tpl_tops</span></a></span></span><span>
</span><span id="line-701"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [Var]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893645"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893645"><span class="hs-identifier hs-var">tpl_vars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893646"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893646"><span class="hs-identifier hs-var">tpl_args</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rhs :: CoreRule -&gt; CoreExpr
</span><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893647"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893647"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621682893639"><span class="hs-identifier hs-var">is_active</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682893643"><span class="hs-identifier hs-var">act</span></a></span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-703"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Maybe Name] -&gt; [Maybe Name] -&gt; Bool
</span><a href="GHC.Core.Rules.html#ruleCantMatch"><span class="hs-identifier hs-var">ruleCantMatch</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893644"><span class="hs-identifier hs-var">tpl_tops</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682893641"><span class="hs-identifier hs-var">rough_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CoreExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-704"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeEnv
-&gt; RuleName
-&gt; [Var]
-&gt; [CoreExpr]
-&gt; [CoreExpr]
-&gt; CoreExpr
-&gt; Maybe CoreExpr
</span><a href="GHC.Core.Rules.html#matchN"><span class="hs-identifier hs-var">matchN</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682893638"><span class="hs-identifier hs-var">rule_env</span></a></span><span> </span><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682893642"><span class="hs-identifier hs-var">rule_name</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893645"><span class="hs-identifier hs-var">tpl_vars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893646"><span class="hs-identifier hs-var">tpl_args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893640"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893647"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-705"></span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span class="hs-comment">---------------------------------------</span><span>
</span><span id="line-708"></span><span class="annot"><a href="GHC.Core.Rules.html#matchN"><span class="hs-identifier hs-type">matchN</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a></span><span>
</span><span id="line-709"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-710"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>           </span><span class="annot"><span class="hs-comment">-- ^ Target; can have more elements than the template</span></span><span>
</span><span id="line-711"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-712"></span><span class="hs-comment">-- For a given match template and context, find bindings to wrap around</span><span>
</span><span id="line-713"></span><span class="hs-comment">-- the entire result and what should be substituted for each template variable.</span><span>
</span><span id="line-714"></span><span class="hs-comment">--</span><span>
</span><span id="line-715"></span><span class="hs-comment">-- Fail if there are too few actual arguments from the target to match the template</span><span>
</span><span id="line-716"></span><span class="hs-comment">--</span><span>
</span><span id="line-717"></span><span class="hs-comment">-- See Note [Extra args in the target]</span><span>
</span><span id="line-718"></span><span class="hs-comment">-- If there are too /many/ actual arguments, we simply ignore the</span><span>
</span><span id="line-719"></span><span class="hs-comment">-- trailing ones, returning the result of applying the rule to a prefix</span><span>
</span><span id="line-720"></span><span class="hs-comment">-- of the actual arguments.</span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span id="matchN"><span class="annot"><span class="annottext">matchN :: InScopeEnv
-&gt; RuleName
-&gt; [Var]
-&gt; [CoreExpr]
-&gt; [CoreExpr]
-&gt; CoreExpr
-&gt; Maybe CoreExpr
</span><a href="GHC.Core.Rules.html#matchN"><span class="hs-identifier hs-var hs-var">matchN</span></a></span></span><span> </span><span id="local-6989586621682893650"><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682893650"><span class="hs-identifier hs-var">ise</span></a></span></span><span> </span><span id="local-6989586621682893651"><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682893651"><span class="hs-identifier hs-var">_rule_name</span></a></span></span><span> </span><span id="local-6989586621682893652"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893652"><span class="hs-identifier hs-var">tmpl_vars</span></a></span></span><span> </span><span id="local-6989586621682893653"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893653"><span class="hs-identifier hs-var">tmpl_es</span></a></span></span><span> </span><span id="local-6989586621682893654"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893654"><span class="hs-identifier hs-var">target_es</span></a></span></span><span> </span><span id="local-6989586621682893655"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893655"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-723"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893656"><span class="annot"><a href="#local-6989586621682893656"><span class="hs-identifier hs-var">bind_wrapper</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893657"><span class="annot"><a href="#local-6989586621682893657"><span class="hs-identifier hs-var">matched_es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InScopeEnv
-&gt; [Var]
-&gt; [CoreExpr]
-&gt; [CoreExpr]
-&gt; Maybe (CoreExpr -&gt; CoreExpr, [CoreExpr])
</span><a href="GHC.Core.Rules.html#matchExprs"><span class="hs-identifier hs-var">matchExprs</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682893650"><span class="hs-identifier hs-var">ise</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893652"><span class="hs-identifier hs-var">tmpl_vars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893653"><span class="hs-identifier hs-var">tmpl_es</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893654"><span class="hs-identifier hs-var">target_es</span></a></span><span>
</span><span id="line-724"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682893656"><span class="hs-identifier hs-type">bind_wrapper</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-725"></span><span>                 </span><span class="annot"><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-type">mkLams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893652"><span class="hs-identifier hs-type">tmpl_vars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893655"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#mkApps"><span class="hs-operator hs-type">`mkApps`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893657"><span class="hs-identifier hs-type">matched_es</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-726"></span><span>
</span><span id="line-727"></span><span class="annot"><a href="GHC.Core.Rules.html#matchExprs"><span class="hs-identifier hs-type">matchExprs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-728"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#BindWrapper"><span class="hs-identifier hs-type">BindWrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- 1-1 with the [Var]</span><span>
</span><span id="line-729"></span><span id="matchExprs"><span class="annot"><span class="annottext">matchExprs :: InScopeEnv
-&gt; [Var]
-&gt; [CoreExpr]
-&gt; [CoreExpr]
-&gt; Maybe (CoreExpr -&gt; CoreExpr, [CoreExpr])
</span><a href="GHC.Core.Rules.html#matchExprs"><span class="hs-identifier hs-var hs-var">matchExprs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#ISE"><span class="hs-identifier hs-type">ISE</span></a></span><span> </span><span id="local-6989586621682893661"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893661"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682893662"><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="#local-6989586621682893662"><span class="hs-identifier hs-var">id_unf</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893663"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893663"><span class="hs-identifier hs-var">tmpl_vars</span></a></span></span><span> </span><span id="local-6989586621682893664"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893664"><span class="hs-identifier hs-var">tmpl_es</span></a></span></span><span> </span><span id="local-6989586621682893665"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893665"><span class="hs-identifier hs-var">target_es</span></a></span></span><span>
</span><span id="line-730"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682893666"><span class="annot"><a href="#local-6989586621682893666"><span class="hs-identifier hs-var">rule_subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst -&gt; [CoreExpr] -&gt; [CoreExpr] -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_exprs"><span class="hs-identifier hs-var">match_exprs</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893668"><span class="hs-identifier hs-var">init_menv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="GHC.Core.Rules.html#emptyRuleSubst"><span class="hs-identifier hs-var">emptyRuleSubst</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893664"><span class="hs-identifier hs-var">tmpl_es</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893665"><span class="hs-identifier hs-var">target_es</span></a></span><span>
</span><span id="line-731"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893670"><span class="annot"><a href="#local-6989586621682893670"><span class="hs-identifier hs-var">matched_es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapAccumL</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682893671"><span class="hs-identifier hs-type">lookup_tmpl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893666"><span class="hs-identifier hs-type">rule_subst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-732"></span><span>                                          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-type">mkEmptySubst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893661"><span class="hs-identifier hs-type">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-733"></span><span>                                </span><span class="annot"><a href="#local-6989586621682893663"><span class="hs-identifier hs-type">tmpl_vars</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`zip`</span></span><span> </span><span class="annot"><a href="#local-6989586621682893673"><span class="hs-identifier hs-type">tmpl_vars1</span></a></span><span>
</span><span id="line-734"></span><span>
</span><span id="line-735"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682893674"><span class="annot"><a href="#local-6989586621682893674"><span class="hs-identifier hs-var hs-var">bind_wrapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleSubst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Rules.html#rs_binds"><span class="hs-identifier hs-var">rs_binds</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893666"><span class="hs-identifier hs-var">rule_subst</span></a></span><span>
</span><span id="line-736"></span><span>                             </span><span class="hs-comment">-- Floated bindings; see Note [Matching lets]</span><span>
</span><span id="line-737"></span><span>
</span><span id="line-738"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682893674"><span class="hs-identifier hs-type">bind_wrapper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682893670"><span class="hs-identifier hs-type">matched_es</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-739"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-740"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682893676"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893676"><span class="hs-identifier hs-var">init_rn_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893673"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893673"><span class="hs-identifier hs-var">tmpl_vars1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RnEnv2 -&gt; Var -&gt; (RnEnv2, Var))
-&gt; RnEnv2 -&gt; [Var] -&gt; (RnEnv2, [Var])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; (RnEnv2, Var)
</span><a href="GHC.Types.Var.Env.html#rnBndrL"><span class="hs-identifier hs-var">rnBndrL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; RnEnv2
</span><a href="GHC.Types.Var.Env.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893661"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893663"><span class="hs-identifier hs-var">tmpl_vars</span></a></span><span>
</span><span id="line-741"></span><span>                  </span><span class="hs-comment">-- See Note [Cloning the template binders]</span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span>    </span><span id="local-6989586621682893668"><span class="annot"><span class="annottext">init_menv :: RuleMatchEnv
</span><a href="#local-6989586621682893668"><span class="hs-identifier hs-var hs-var">init_menv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RV"><span class="hs-identifier hs-type">RV</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rv_tmpls :: VarSet
</span><a href="GHC.Core.Rules.html#rv_tmpls"><span class="hs-identifier hs-var">rv_tmpls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893673"><span class="hs-identifier hs-var">tmpl_vars1</span></a></span><span>
</span><span id="line-744"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_lcl :: RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893676"><span class="hs-identifier hs-var">init_rn_env</span></a></span><span>
</span><span id="line-745"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_fltR :: Subst
</span><a href="GHC.Core.Rules.html#rv_fltR"><span class="hs-identifier hs-var">rv_fltR</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RnEnv2 -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#rnInScopeSet"><span class="hs-identifier hs-var">rnInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893676"><span class="hs-identifier hs-var">init_rn_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-746"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_unf :: IdUnfoldingFun
</span><a href="GHC.Core.Rules.html#rv_unf"><span class="hs-identifier hs-var">rv_unf</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="#local-6989586621682893662"><span class="hs-identifier hs-var">id_unf</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span>    </span><span class="annot"><a href="#local-6989586621682893671"><span class="hs-identifier hs-type">lookup_tmpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-749"></span><span>                   </span><span class="hs-comment">-- Need to return a RuleSubst solely for the benefit of fake_ty</span><span>
</span><span id="line-750"></span><span>    </span><span id="local-6989586621682893671"><span class="annot"><span class="annottext">lookup_tmpl :: RuleSubst -&gt; Subst -&gt; (Var, Var) -&gt; (Subst, CoreExpr)
</span><a href="#local-6989586621682893671"><span class="hs-identifier hs-var hs-var">lookup_tmpl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RS"><span class="hs-identifier hs-type">RS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rs_tv_subst :: RuleSubst -&gt; TvSubstEnv
</span><a href="GHC.Core.Rules.html#rs_tv_subst"><span class="hs-identifier hs-var">rs_tv_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893690"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682893690"><span class="hs-identifier hs-var">tv_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rs_id_subst :: RuleSubst -&gt; IdSubstEnv
</span><a href="GHC.Core.Rules.html#rs_id_subst"><span class="hs-identifier hs-var">rs_id_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893692"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682893692"><span class="hs-identifier hs-var">id_subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-751"></span><span>                </span><span id="local-6989586621682893693"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893693"><span class="hs-identifier hs-var">tcv_subst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893694"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893694"><span class="hs-identifier hs-var">tmpl_var</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893695"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893695"><span class="hs-identifier hs-var">tmpl_var1</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-752"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893695"><span class="hs-identifier hs-var">tmpl_var1</span></a></span><span>
</span><span id="line-753"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Var -&gt; Maybe CoreExpr
forall a. VarEnv a -&gt; Var -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682893692"><span class="hs-identifier hs-var">id_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893695"><span class="hs-identifier hs-var">tmpl_var1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-754"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893698"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893698"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682893699"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893699"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893698"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-755"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Var -&gt; Coercion -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendCvSubst"><span class="hs-identifier hs-var">Type.extendCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893693"><span class="hs-identifier hs-var">tcv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893695"><span class="hs-identifier hs-var">tmpl_var1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893699"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893699"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-756"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-757"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893693"><span class="hs-identifier hs-var">tcv_subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893698"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-758"></span><span>            </span><span class="annot"><span class="annottext">Maybe CoreExpr
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893700"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893700"><span class="hs-identifier hs-var">refl_co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.html#isReflCoVar_maybe"><span class="hs-identifier hs-var">isReflCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893695"><span class="hs-identifier hs-var">tmpl_var1</span></a></span><span>
</span><span id="line-759"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682893702"><span class="annot"><span class="annottext">co :: Coercion
</span><a href="#local-6989586621682893702"><span class="hs-identifier hs-var hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">Coercion.substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893693"><span class="hs-identifier hs-var">tcv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893700"><span class="hs-identifier hs-var">refl_co</span></a></span><span>
</span><span id="line-760"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- See Note [Unbound RULE binders]</span><span>
</span><span id="line-761"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Var -&gt; Coercion -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendCvSubst"><span class="hs-identifier hs-var">Type.extendCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893693"><span class="hs-identifier hs-var">tcv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893695"><span class="hs-identifier hs-var">tmpl_var1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893702"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893702"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-763"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Var -&gt; (Subst, CoreExpr)
</span><a href="#local-6989586621682893704"><span class="hs-identifier hs-var">unbound</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893694"><span class="hs-identifier hs-var">tmpl_var</span></a></span><span>
</span><span id="line-764"></span><span>
</span><span id="line-765"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-766"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Var -&gt; Kind -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendTvSubst"><span class="hs-identifier hs-var">Type.extendTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893693"><span class="hs-identifier hs-var">tcv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893695"><span class="hs-identifier hs-var">tmpl_var1</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893705"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; CoreExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893705"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-768"></span><span>          </span><span id="local-6989586621682893705"><span class="annot"><span class="annottext">ty' :: Kind
</span><a href="#local-6989586621682893705"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Var -&gt; Maybe Kind
forall a. VarEnv a -&gt; Var -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682893690"><span class="hs-identifier hs-var">tv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893695"><span class="hs-identifier hs-var">tmpl_var1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-769"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893706"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893706"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893706"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-770"></span><span>                  </span><span class="annot"><span class="annottext">Maybe Kind
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893707"><span class="hs-identifier hs-var">fake_ty</span></a></span><span>   </span><span class="hs-comment">-- See Note [Unbound RULE binders]</span><span>
</span><span id="line-771"></span><span>          </span><span id="local-6989586621682893707"><span class="annot"><span class="annottext">fake_ty :: Kind
</span><a href="#local-6989586621682893707"><span class="hs-identifier hs-var hs-var">fake_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Kind
</span><a href="GHC.Builtin.Types.html#anyTypeOfKind"><span class="hs-identifier hs-var">anyTypeOfKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Kind -&gt; Kind
Subst -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">Type.substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893693"><span class="hs-identifier hs-var">tcv_subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Kind
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893695"><span class="hs-identifier hs-var">tmpl_var1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>                    </span><span class="hs-comment">-- This substitution is the sole reason we accumulate</span><span>
</span><span id="line-773"></span><span>                    </span><span class="hs-comment">-- TCvSubst in lookup_tmpl</span><span>
</span><span id="line-774"></span><span>
</span><span id="line-775"></span><span>    </span><span id="local-6989586621682893704"><span class="annot"><span class="annottext">unbound :: Var -&gt; (Subst, CoreExpr)
</span><a href="#local-6989586621682893704"><span class="hs-identifier hs-var hs-var">unbound</span></a></span></span><span> </span><span id="local-6989586621682893709"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893709"><span class="hs-identifier hs-var">tmpl_var</span></a></span></span><span>
</span><span id="line-776"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; (Subst, CoreExpr)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Template variable unbound in rewrite rule&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; (Subst, CoreExpr)) -&gt; SDoc -&gt; (Subst, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-777"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Variable:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893709"><span class="hs-identifier hs-var">tmpl_var</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.Utils.Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Kind
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893709"><span class="hs-identifier hs-var">tmpl_var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rule bndrs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893663"><span class="hs-identifier hs-var">tmpl_vars</span></a></span><span>
</span><span id="line-779"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;LHS args:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893664"><span class="hs-identifier hs-var">tmpl_es</span></a></span><span>
</span><span id="line-780"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Actual args:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893665"><span class="hs-identifier hs-var">target_es</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-781"></span><span>
</span><span id="line-782"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-783"></span><span class="annot"><a href="GHC.Core.Rules.html#match_exprs"><span class="hs-identifier hs-type">match_exprs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-784"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Templates</span><span>
</span><span id="line-785"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Targets</span><span>
</span><span id="line-786"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-787"></span><span class="hs-comment">-- If the targets are longer than templates, succeed, simply ignoring</span><span>
</span><span id="line-788"></span><span class="hs-comment">-- the leftover targets. This matters in the call in matchN.</span><span>
</span><span id="line-789"></span><span class="hs-comment">--</span><span>
</span><span id="line-790"></span><span class="hs-comment">-- Precondition: corresponding elements of es1 and es2 have the same</span><span>
</span><span id="line-791"></span><span class="hs-comment">--               type, assuming earlier elements match.</span><span>
</span><span id="line-792"></span><span class="hs-comment">-- Example:  f :: forall v. v -&gt; blah</span><span>
</span><span id="line-793"></span><span class="hs-comment">--   match_exprs [Type a, y::a] [Type Int, 3]</span><span>
</span><span id="line-794"></span><span class="hs-comment">-- Then, after matching Type a against Type Int,</span><span>
</span><span id="line-795"></span><span class="hs-comment">-- the type of (y::a) matches that of (3::Int)</span><span>
</span><span id="line-796"></span><span id="match_exprs"><span class="annot"><span class="annottext">match_exprs :: RuleMatchEnv
-&gt; RuleSubst -&gt; [CoreExpr] -&gt; [CoreExpr] -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_exprs"><span class="hs-identifier hs-var hs-var">match_exprs</span></a></span></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682893713"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893713"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-797"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleSubst -&gt; Maybe RuleSubst
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893713"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-798"></span><span class="annot"><a href="GHC.Core.Rules.html#match_exprs"><span class="hs-identifier hs-var">match_exprs</span></a></span><span> </span><span id="local-6989586621682893714"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893714"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893715"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893715"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893716"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893716"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682893717"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893717"><span class="hs-identifier hs-var">es1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893718"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893718"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682893719"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893719"><span class="hs-identifier hs-var">es2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-799"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682893720"><span class="annot"><a href="#local-6989586621682893720"><span class="hs-identifier hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893714"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893715"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893716"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893718"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-800"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#match_exprs"><span class="hs-identifier hs-type">match_exprs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893714"><span class="hs-identifier hs-type">renv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893720"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893717"><span class="hs-identifier hs-type">es1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893719"><span class="hs-identifier hs-type">es2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-801"></span><span class="annot"><a href="GHC.Core.Rules.html#match_exprs"><span class="hs-identifier hs-var">match_exprs</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-802"></span><span>
</span><span id="line-803"></span><span>
</span><span id="line-804"></span><span class="hs-comment">{- Note [Unbound RULE binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It can be the case that the binder in a rule is not actually
bound on the LHS:

* Type variables.  Type synonyms with phantom args can give rise to
  unbound template type variables.  Consider this (#10689,
  simplCore/should_compile/T10689):

    type Foo a b = b

    f :: Eq a =&gt; a -&gt; Bool
    f x = x==x

    {-# RULES &quot;foo&quot; forall (x :: Foo a Char). f x = True #-}
    finkle = f 'c'

  The rule looks like
    forall (a::*) (d::Eq Char) (x :: Foo a Char).
         f (Foo a Char) d x = True

  Matching the rule won't bind 'a', and legitimately so.  We fudge by
  pretending that 'a' is bound to (Any :: *).

* Coercion variables.  On the LHS of a RULE for a local binder
  we might have
    RULE forall (c :: a~b). f (x |&gt; c) = e
  Now, if that binding is inlined, so that a=b=Int, we'd get
    RULE forall (c :: Int~Int). f (x |&gt; c) = e
  and now when we simplify the LHS (Simplify.simplRule) we
  optCoercion (look at the CoVarCo case) will turn that 'c' into Refl:
    RULE forall (c :: Int~Int). f (x |&gt; &lt;Int&gt;) = e
  and then perhaps drop it altogether.  Now 'c' is unbound.

  It's tricky to be sure this never happens, so instead I
  say it's OK to have an unbound coercion binder in a RULE
  provided its type is (c :: t~t).  Then, when the RULE
  fires we can substitute &lt;t&gt; for c.

  This actually happened (in a RULE for a local function)
  in #13410, and also in test T10602.

Note [Cloning the template binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following match (example 1):
        Template:  forall x.  f x
        Target:               f (x+1)
This should succeed, because the template variable 'x' has nothing to
do with the 'x' in the target.

Likewise this one (example 2):
        Template:  forall x. f (\x.x)
        Target:              f (\y.y)

We achieve this simply by using rnBndrL to clone the template
binders if they are already in scope.

------ Historical note -------
At one point I tried simply adding the template binders to the
in-scope set /without/ cloning them, but that failed in a horribly
obscure way in #14777.  Problem was that during matching we look
up target-term variables in the in-scope set (see Note [Lookup
in-scope]).  If a target-term variable happens to name-clash with a
template variable, that lookup will find the template variable, which
is /utterly/ bogus.  In #14777, this transformed a term variable
into a type variable, and then crashed when we wanted its idInfo.
------ End of historical note -------


************************************************************************
*                                                                      *
                   The main matcher
*                                                                      *
********************************************************************* -}</span><span>
</span><span id="line-878"></span><span>
</span><span id="line-879"></span><span class="hs-keyword">data</span><span> </span><span id="RuleMatchEnv"><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-var">RuleMatchEnv</span></a></span></span><span>
</span><span id="line-880"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="RV"><span class="annot"><a href="GHC.Core.Rules.html#RV"><span class="hs-identifier hs-var">RV</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="rv_lcl"><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var hs-var">rv_lcl</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a></span><span>          </span><span class="hs-comment">-- Renamings for *local bindings*</span><span>
</span><span id="line-881"></span><span>                                     </span><span class="hs-comment">--   (lambda/case)</span><span>
</span><span id="line-882"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="rv_tmpls"><span class="annot"><span class="annottext">RuleMatchEnv -&gt; VarSet
</span><a href="GHC.Core.Rules.html#rv_tmpls"><span class="hs-identifier hs-var hs-var">rv_tmpls</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>          </span><span class="hs-comment">-- Template variables</span><span>
</span><span id="line-883"></span><span>                                     </span><span class="hs-comment">--   (after applying envL of rv_lcl)</span><span>
</span><span id="line-884"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="rv_fltR"><span class="annot"><span class="annottext">RuleMatchEnv -&gt; Subst
</span><a href="GHC.Core.Rules.html#rv_fltR"><span class="hs-identifier hs-var hs-var">rv_fltR</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>           </span><span class="hs-comment">-- Renamings for floated let-bindings</span><span>
</span><span id="line-885"></span><span>                                     </span><span class="hs-comment">--   (domain disjoint from envR of rv_lcl)</span><span>
</span><span id="line-886"></span><span>                                     </span><span class="hs-comment">-- See Note [Matching lets]</span><span>
</span><span id="line-887"></span><span>                                     </span><span class="hs-comment">-- N.B. The InScopeSet of rv_fltR is always ignored;</span><span>
</span><span id="line-888"></span><span>                                     </span><span class="hs-comment">-- see (4) in Note [Matching lets].</span><span>
</span><span id="line-889"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="rv_unf"><span class="annot"><span class="annottext">RuleMatchEnv -&gt; IdUnfoldingFun
</span><a href="GHC.Core.Rules.html#rv_unf"><span class="hs-identifier hs-var hs-var">rv_unf</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#IdUnfoldingFun"><span class="hs-identifier hs-type">IdUnfoldingFun</span></a></span><span>
</span><span id="line-890"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-891"></span><span>
</span><span id="line-892"></span><span class="hs-comment">{- Note [rv_lcl in RuleMatchEnv]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider matching
  Template: \x-&gt;f
  Target:   \f-&gt;f

where 'f' is free in the template. When we meet the lambdas we must
remember to rename f :-&gt; f' in the target, as well as x :-&gt; f
in the template.  The rv_lcl::RnEnv2 does that.

Similarly, consider matching
     Template: {a}  \b-&gt;b
     Target:        \a-&gt;3
We must rename the \a.  Otherwise when we meet the lambdas we might
substitute [b :-&gt; a] in the template, and then erroneously succeed in
matching what looks like the template variable 'a' against 3.

So we must add the template vars to the in-scope set before starting;
see `init_menv` in `matchN`.
-}</span><span>
</span><span id="line-912"></span><span>
</span><span id="line-913"></span><span class="annot"><span class="hs-comment">-- * The domain of the TvSubstEnv and IdSubstEnv are the template</span></span><span>
</span><span id="line-914"></span><span class="hs-comment">--   variables passed into the match.</span><span>
</span><span id="line-915"></span><span class="hs-comment">--</span><span>
</span><span id="line-916"></span><span class="annot"><span class="hs-comment">-- * The BindWrapper in a RuleSubst are the bindings floated out</span></span><span>
</span><span id="line-917"></span><span class="hs-comment">--   from nested matches; see the Let case of match, below</span><span>
</span><span id="line-918"></span><span class="hs-comment">--</span><span>
</span><span id="line-919"></span><span class="hs-keyword">data</span><span> </span><span id="RuleSubst"><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-var">RuleSubst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RS"><span class="annot"><a href="GHC.Core.Rules.html#RS"><span class="hs-identifier hs-var">RS</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Substitution; applied only to the template, not the target</span><span>
</span><span id="line-920"></span><span>                      </span><span class="hs-comment">-- Domain is the template variables</span><span>
</span><span id="line-921"></span><span>                      </span><span class="hs-comment">-- Range never includes template variables</span><span>
</span><span id="line-922"></span><span>                      </span><span id="rs_tv_subst"><span class="annot"><span class="annottext">RuleSubst -&gt; TvSubstEnv
</span><a href="GHC.Core.Rules.html#rs_tv_subst"><span class="hs-identifier hs-var hs-var">rs_tv_subst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span>
</span><span id="line-923"></span><span>                    </span><span class="hs-special">,</span><span> </span><span id="rs_id_subst"><span class="annot"><span class="annottext">RuleSubst -&gt; IdSubstEnv
</span><a href="GHC.Core.Rules.html#rs_id_subst"><span class="hs-identifier hs-var hs-var">rs_id_subst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#IdSubstEnv"><span class="hs-identifier hs-type">IdSubstEnv</span></a></span><span>
</span><span id="line-924"></span><span>
</span><span id="line-925"></span><span>                      </span><span class="hs-comment">-- Floated bindings</span><span>
</span><span id="line-926"></span><span>                    </span><span class="hs-special">,</span><span> </span><span id="rs_binds"><span class="annot"><span class="annottext">RuleSubst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Rules.html#rs_binds"><span class="hs-identifier hs-var hs-var">rs_binds</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#BindWrapper"><span class="hs-identifier hs-type">BindWrapper</span></a></span><span>  </span><span class="hs-comment">-- Floated bindings</span><span>
</span><span id="line-927"></span><span>                    </span><span class="hs-special">,</span><span> </span><span id="rs_bndrs"><span class="annot"><span class="annottext">RuleSubst -&gt; [Var]
</span><a href="GHC.Core.Rules.html#rs_bndrs"><span class="hs-identifier hs-var hs-var">rs_bndrs</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Variables bound by floated lets</span><span>
</span><span id="line-928"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span class="hs-keyword">type</span><span> </span><span id="BindWrapper"><span class="annot"><a href="GHC.Core.Rules.html#BindWrapper"><span class="hs-identifier hs-var">BindWrapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-931"></span><span>  </span><span class="hs-comment">-- See Notes [Matching lets] and [Matching cases]</span><span>
</span><span id="line-932"></span><span>  </span><span class="hs-comment">-- we represent the floated bindings as a core-to-core function</span><span>
</span><span id="line-933"></span><span>
</span><span id="line-934"></span><span class="annot"><a href="GHC.Core.Rules.html#emptyRuleSubst"><span class="hs-identifier hs-type">emptyRuleSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-935"></span><span id="emptyRuleSubst"><span class="annot"><span class="annottext">emptyRuleSubst :: RuleSubst
</span><a href="GHC.Core.Rules.html#emptyRuleSubst"><span class="hs-identifier hs-var hs-var">emptyRuleSubst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RS"><span class="hs-identifier hs-type">RS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rs_tv_subst :: TvSubstEnv
</span><a href="GHC.Core.Rules.html#rs_tv_subst"><span class="hs-identifier hs-var">rs_tv_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rs_id_subst :: IdSubstEnv
</span><a href="GHC.Core.Rules.html#rs_id_subst"><span class="hs-identifier hs-var">rs_id_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-936"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rs_binds :: CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Rules.html#rs_binds"><span class="hs-identifier hs-var">rs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682893725"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893725"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893725"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rs_bndrs :: [Var]
</span><a href="GHC.Core.Rules.html#rs_bndrs"><span class="hs-identifier hs-var">rs_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-937"></span><span>
</span><span id="line-938"></span><span>
</span><span id="line-939"></span><span class="hs-comment">{- Note [Casts in the target]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
As far as possible we don't want casts in the target to get in the way of
matching.  E.g.
* (let bind in e)  |&gt; co
* (case e of alts) |&gt; co
* (\ a b. f a b)   |&gt; co

In the first two cases we want to float the cast inwards so we can match on
the let/case.  This is not important in practice because the Simplifier does
this anyway.

But the third case /is/ important: we don't want the cast to get in the way
of eta-reduction.  See Note [Cancel reflexive casts] for a real life example.

The most convenient thing is to make 'match' take an MCoercion argument, thus:

* The main matching function
      match env subst template target mco
  matches   template ~ (target |&gt; mco)

* Invariant: typeof( subst(template) ) = typeof( target |&gt; mco )

Note that for applications
     (e1 e2) ~ (d1 d2) |&gt; co
where 'co' is non-reflexive, we simply fail.  You might wonder about
     (e1 e2) ~ ((d1 |&gt; co1) d2) |&gt; co2
but the Simplifer pushes the casts in an application to to the
right, if it can, so this doesn't really arise.

Note [Casts in the template]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This Note concerns `matchTemplateCast`.  Consider the definition
  f x = e,
and SpecConstr on call pattern
  f ((e1,e2) |&gt; co)

The danger is that We'll make a RULE
   RULE forall a,b,g.  f ((a,b)|&gt; g) = $sf a b g
   $sf a b g = e[ ((a,b)|&gt; g) / x ]

This requires the rule-matcher to bind the coercion variable `g`.
That is Very Deeply Suspicious:

* It would be unreasonable to match on a structured coercion in a pattern,
  such as    RULE   forall g.  f (x |&gt; Sym g) = ...
  because the strucure of a coercion is arbitrary and may change -- it's their
  /type/ that matters.

* We considered insisting that in a template, in a cast (e |&gt; co), the the cast
  `co` is always a /variable/ cv.  That looks a bit more plausible, but #23209
  (and related tickets) shows that it's very fragile.  For example suppose `e`
  is a variable `f`, and the simplifier has an unconditional substitution
     [f :-&gt; g |&gt; co2]
  Now the rule LHS becomes (f |&gt; (co2 ; cv)); not a coercion variable any more!

In short, it is Very Deeply Suspicious for a rule to quantify over a coercion
variable.  And SpecConstr no longer does so: see Note [SpecConstr and casts] in
SpecConstr.

It is, however, OK for a cast to appear in a template.  For example
    newtype N a = MkN (a,a)    -- Axiom ax:N a :: (a,a) ~R N a
    f :: N a -&gt; bah
    RULE forall b x:b y:b. f @b ((x,y) |&gt; (axN @b)) = ...

When matching we can just move these casts to the other side:
    match (tmpl |&gt; co) tgt  --&gt;   match tmpl (tgt |&gt; sym co)
See matchTemplateCast.

Wrinkles:

(CT1) We need to be careful about scoping, and to match left-to-right, so that we
  know the substitution [a :-&gt; b] before we meet (co :: (a,a) ~R N a), and so we
  can apply that substitition

(CT2) Annoyingly, we still want support one case in which the RULE quantifies
  over a coercion variable: the dreaded map/coerce RULE.
  See Note [Getting the map/coerce RULE to work] in GHC.Core.SimpleOpt.

  Since that can happen, matchTemplateCast laboriously checks whether the
  coercion mentions a template coercion variable; and if so does the Very Deeply
  Suspicious `match_co` instead.  It works fine for map/coerce, where the
  coercion is always a variable and will (robustly) remain so.

See also
* Note [Coercion arguments]
* Note [Matching coercion variables] in GHC.Core.Unify.
* Note [Cast swizzling on rule LHSs] in GHC.Core.Opt.Simplify.Utils:
  sm_cast_swizzle is switched off in the template of a RULE

Note [Coercion arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~
What if we have (f (Coercion co)) in the template, where the 'co' is a coercion
argument to f?  Right now we have nothing in place to ensure that a
coercion /argument/ in the template is a variable.  We really should,
perhaps by abstracting over that variable.

C.f. the treatment of dictionaries in GHC.HsToCore.Binds.decompseRuleLhs.

For now, though, we simply behave badly, by failing in match_co.
We really should never rely on matching the structure of a coercion
(which is just a proof).
-}</span><span>
</span><span id="line-1042"></span><span>
</span><span id="line-1043"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1044"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-type">match</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span>
</span><span id="line-1045"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>              </span><span class="hs-comment">-- Substitution applies to template only</span><span>
</span><span id="line-1046"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>               </span><span class="hs-comment">-- Template</span><span>
</span><span id="line-1047"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>               </span><span class="hs-comment">-- Target</span><span>
</span><span id="line-1048"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span>
</span><span id="line-1049"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1050"></span><span>
</span><span id="line-1051"></span><span class="hs-comment">-- Postcondition (TypeInv): if matching succeeds, then</span><span>
</span><span id="line-1052"></span><span class="hs-comment">--                          typeof( subst(template) ) = typeof( target |&gt; mco )</span><span>
</span><span id="line-1053"></span><span class="hs-comment">--     But this is /not/ a pre-condition! The types of template and target</span><span>
</span><span id="line-1054"></span><span class="hs-comment">--     may differ, see the (App e1 e2) case</span><span>
</span><span id="line-1055"></span><span class="hs-comment">--</span><span>
</span><span id="line-1056"></span><span class="hs-comment">-- Invariant (CoInv):   if mco :: ty ~ ty, then it is MRefl, not MCo co</span><span>
</span><span id="line-1057"></span><span class="hs-comment">--                      See Note [Cancel reflexive casts]</span><span>
</span><span id="line-1058"></span><span class="hs-comment">--</span><span>
</span><span id="line-1059"></span><span class="hs-comment">-- See the notes with Unify.match, which matches types</span><span>
</span><span id="line-1060"></span><span class="hs-comment">-- Everything is very similar for terms</span><span>
</span><span id="line-1061"></span><span>
</span><span id="line-1062"></span><span>
</span><span id="line-1063"></span><span class="hs-comment">------------------------ Ticks ---------------------</span><span>
</span><span id="line-1064"></span><span class="hs-comment">-- We look through certain ticks. See Note [Tick annotations in RULE matching]</span><span>
</span><span id="line-1065"></span><span id="match"><span class="annot"><span class="annottext">match :: RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var hs-var">match</span></a></span></span><span> </span><span id="local-6989586621682893726"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893726"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893727"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893727"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682893728"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893728"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682893729"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682893729"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682893730"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893730"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893731"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893731"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1066"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682893729"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1067"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893726"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893732"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893728"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893730"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893731"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1068"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1069"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1070"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1071"></span><span>    </span><span id="local-6989586621682893732"><span class="annot"><span class="annottext">subst' :: RuleSubst
</span><a href="#local-6989586621682893732"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893727"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_binds"><span class="hs-identifier hs-var">rs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_binds"><span class="hs-identifier hs-var">rs_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893727"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-type">mkTick</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893729"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1072"></span><span>
</span><span id="line-1073"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893733"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893733"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893734"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893734"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682893735"><span class="annot"><span class="annottext">e :: CoreExpr
</span><a href="#local-6989586621682893735"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682893736"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682893736"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682893737"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893737"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893738"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893738"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621682893739"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893739"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1074"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682893736"><span class="hs-identifier hs-var">t</span></a></span><span>  </span><span class="hs-comment">-- Ignore floatable ticks in rule template.</span><span>
</span><span id="line-1075"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893733"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893734"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893737"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893738"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893739"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1076"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1077"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; Maybe RuleSubst
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Tick in rule&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893735"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1078"></span><span>
</span><span id="line-1079"></span><span class="hs-comment">------------------------ Types ---------------------</span><span>
</span><span id="line-1080"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893740"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893740"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893741"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893741"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682893742"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893742"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682893743"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893743"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893744"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893744"><span class="hs-identifier hs-var">_mco</span></a></span></span><span>
</span><span id="line-1081"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RuleSubst -&gt; Kind -&gt; Kind -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_ty"><span class="hs-identifier hs-var">match_ty</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893740"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893741"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893742"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893743"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1082"></span><span>
</span><span id="line-1083"></span><span class="hs-comment">------------------------ Coercions ---------------------</span><span>
</span><span id="line-1084"></span><span class="hs-comment">-- See Note [Coercion arguments] for why this isn't really right</span><span>
</span><span id="line-1085"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893746"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893746"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893747"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893747"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682893748"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893748"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682893749"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893749"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-1086"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst -&gt; Coercion -&gt; Coercion -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_co"><span class="hs-identifier hs-var">match_co</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893746"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893747"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893748"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893749"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1087"></span><span>  </span><span class="hs-comment">-- The MCo case corresponds to matching  co ~ (co2 |&gt; co3)</span><span>
</span><span id="line-1088"></span><span>  </span><span class="hs-comment">-- and I have no idea what to do there -- or even if it can occur</span><span>
</span><span id="line-1089"></span><span>  </span><span class="hs-comment">-- Failing seems the simplest thing to do; it's certainly safe.</span><span>
</span><span id="line-1090"></span><span>
</span><span id="line-1091"></span><span class="hs-comment">------------------------ Casts ---------------------</span><span>
</span><span id="line-1092"></span><span class="hs-comment">-- See Note [Casts in the template]</span><span>
</span><span id="line-1093"></span><span class="hs-comment">--     Note [Casts in the target]</span><span>
</span><span id="line-1094"></span><span class="hs-comment">--     Note [Cancel reflexive casts]</span><span>
</span><span id="line-1095"></span><span>
</span><span id="line-1096"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893751"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893751"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893752"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893752"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682893753"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893753"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682893755"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893755"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621682893756"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893756"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893757"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893757"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1097"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893751"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893752"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893753"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893755"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercion -&gt; MCoercion
</span><a href="GHC.Core.Coercion.html#checkReflexiveMCo"><span class="hs-identifier hs-var">checkReflexiveMCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; MCoercion -&gt; MCoercion
</span><a href="GHC.Core.Coercion.html#mkTransMCoR"><span class="hs-identifier hs-var">mkTransMCoR</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893756"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893757"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1098"></span><span>    </span><span class="hs-comment">-- checkReflexiveMCo: cancel casts if possible</span><span>
</span><span id="line-1099"></span><span>    </span><span class="hs-comment">-- This is important: see Note [Cancel reflexive casts]</span><span>
</span><span id="line-1100"></span><span>
</span><span id="line-1101"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893760"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893760"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893761"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893761"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682893762"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893762"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621682893763"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893763"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893764"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893764"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621682893765"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893765"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1102"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; Coercion
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#matchTemplateCast"><span class="hs-identifier hs-var">matchTemplateCast</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893760"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893761"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893762"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893763"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893764"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893765"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1103"></span><span>
</span><span id="line-1104"></span><span class="hs-comment">------------------------ Literals ---------------------</span><span>
</span><span id="line-1105"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682893767"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893767"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682893769"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682893769"><span class="hs-identifier hs-var">lit1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682893770"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682893770"><span class="hs-identifier hs-var">lit2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893771"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893771"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1106"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682893769"><span class="hs-identifier hs-var">lit1</span></a></span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Literal -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682893770"><span class="hs-identifier hs-var">lit2</span></a></span><span>
</span><span id="line-1107"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Maybe RuleSubst -&gt; Maybe RuleSubst
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflMCo"><span class="hs-identifier hs-var">isReflMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893771"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893771"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe RuleSubst -&gt; Maybe RuleSubst)
-&gt; Maybe RuleSubst -&gt; Maybe RuleSubst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1108"></span><span>    </span><span class="annot"><span class="annottext">RuleSubst -&gt; Maybe RuleSubst
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893767"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1109"></span><span>
</span><span id="line-1110"></span><span class="hs-comment">------------------------ Variables ---------------------</span><span>
</span><span id="line-1111"></span><span class="hs-comment">-- The Var case follows closely what happens in GHC.Core.Unify.match</span><span>
</span><span id="line-1112"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893774"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893774"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893775"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893775"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893776"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893776"><span class="hs-identifier hs-var">v1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893777"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893777"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621682893778"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893778"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1113"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RuleSubst -&gt; Var -&gt; CoreExpr -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_var"><span class="hs-identifier hs-var">match_var</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893774"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893775"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893776"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; MCoercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-identifier hs-var">mkCastMCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893777"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893778"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1114"></span><span>
</span><span id="line-1115"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893780"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893780"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893781"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893781"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682893782"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893782"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893783"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893783"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893784"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893784"><span class="hs-identifier hs-var">mco</span></a></span></span><span>  </span><span class="hs-comment">-- Note [Expanding variables]</span><span>
</span><span id="line-1116"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#inRnEnvR"><span class="hs-identifier hs-var">inRnEnvR</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893786"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893783"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Note [Do not expand locally-bound variables]</span><span>
</span><span id="line-1117"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893787"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893787"><span class="hs-identifier hs-var">e2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Maybe CoreExpr
</span><a href="GHC.Core.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; IdUnfoldingFun
</span><a href="GHC.Core.Rules.html#rv_unf"><span class="hs-identifier hs-var">rv_unf</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893780"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893789"><span class="hs-identifier hs-var">v2'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1118"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893780"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#nukeRnEnvR"><span class="hs-identifier hs-type">nukeRnEnvR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893786"><span class="hs-identifier hs-type">rn_env</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893781"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893782"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893787"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893784"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1119"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1120"></span><span>    </span><span id="local-6989586621682893789"><span class="annot"><span class="annottext">v2' :: Var
</span><a href="#local-6989586621682893789"><span class="hs-identifier hs-var hs-var">v2'</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Var
</span><a href="GHC.Types.Var.Env.html#lookupRnInScope"><span class="hs-identifier hs-var">lookupRnInScope</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893786"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893783"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-1121"></span><span>    </span><span id="local-6989586621682893786"><span class="annot"><span class="annottext">rn_env :: RnEnv2
</span><a href="#local-6989586621682893786"><span class="hs-identifier hs-var hs-var">rn_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893780"><span class="hs-identifier hs-var">renv</span></a></span><span>
</span><span id="line-1122"></span><span>        </span><span class="hs-comment">-- Notice that we look up v2 in the in-scope set</span><span>
</span><span id="line-1123"></span><span>        </span><span class="hs-comment">-- See Note [Lookup in-scope]</span><span>
</span><span id="line-1124"></span><span>        </span><span class="hs-comment">-- No need to apply any renaming first (hence no rnOccR)</span><span>
</span><span id="line-1125"></span><span>        </span><span class="hs-comment">-- because of the not-inRnEnvR</span><span>
</span><span id="line-1126"></span><span>
</span><span id="line-1127"></span><span class="hs-comment">------------------------ Applications ---------------------</span><span>
</span><span id="line-1128"></span><span class="hs-comment">-- See Note [Matching higher order patterns]</span><span>
</span><span id="line-1129"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893792"><span class="annot"><span class="annottext">renv :: RuleMatchEnv
</span><a href="#local-6989586621682893792"><span class="hs-identifier hs-var">renv</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RV"><span class="hs-identifier hs-type">RV</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rv_tmpls :: RuleMatchEnv -&gt; VarSet
</span><a href="GHC.Core.Rules.html#rv_tmpls"><span class="hs-identifier hs-var">rv_tmpls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893793"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682893793"><span class="hs-identifier hs-var">tmpls</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_lcl :: RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893794"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893794"><span class="hs-identifier hs-var">rn_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1130"></span><span>      </span><span id="local-6989586621682893795"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893795"><span class="hs-identifier hs-var">subst</span></a></span></span><span>  </span><span id="local-6989586621682893796"><span class="annot"><span class="annottext">e1 :: CoreExpr
</span><a href="#local-6989586621682893796"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span id="local-6989586621682893797"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893797"><span class="hs-identifier hs-var">e2</span></a></span></span><span>
</span><span id="line-1131"></span><span>      </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>               </span><span class="hs-comment">-- Like the App case we insist on Refl here</span><span>
</span><span id="line-1132"></span><span>                          </span><span class="hs-comment">-- See Note [Casts in the target]</span><span>
</span><span id="line-1133"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893798"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893798"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893799"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893799"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; (CoreExpr, [CoreExpr])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893796"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-1134"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682893801"><span class="annot"><span class="annottext">f' :: Var
</span><a href="#local-6989586621682893801"><span class="hs-identifier hs-var hs-var">f'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Var
</span><a href="GHC.Types.Var.Env.html#rnOccL"><span class="hs-identifier hs-var">rnOccL</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893794"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893798"><span class="hs-identifier hs-var">f</span></a></span><span>   </span><span class="hs-comment">-- See similar rnOccL in match_var</span><span>
</span><span id="line-1135"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893801"><span class="hs-identifier hs-var">f'</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682893793"><span class="hs-identifier hs-var">tmpls</span></a></span><span>                     </span><span class="hs-comment">-- (HOP1)</span><span>
</span><span id="line-1136"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893804"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893804"><span class="hs-identifier hs-var">vs2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; Maybe Var) -&gt; [CoreExpr] -&gt; Maybe [Var]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe Var
</span><a href="#local-6989586621682893806"><span class="hs-identifier hs-var">arg_as_lcl_var</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682893799"><span class="hs-identifier hs-var">args</span></a></span><span>  </span><span class="hs-comment">-- (HOP2), (HOP3)</span><span>
</span><span id="line-1137"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; Bool
</span><a href="GHC.Data.List.SetOps.html#hasNoDups"><span class="hs-identifier hs-var">hasNoDups</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893804"><span class="hs-identifier hs-var">vs2</span></a></span><span>                             </span><span class="hs-comment">-- (HOP4)</span><span>
</span><span id="line-1138"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682893807"><span class="hs-identifier hs-var">can_decompose_app_instead</span></a></span><span>
</span><span id="line-1139"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RuleSubst -&gt; Var -&gt; CoreExpr -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_tmpl_var"><span class="hs-identifier hs-var">match_tmpl_var</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893792"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893795"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893801"><span class="hs-identifier hs-var">f'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Var] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkCoreLams"><span class="hs-identifier hs-var">mkCoreLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893804"><span class="hs-identifier hs-var">vs2</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893797"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1140"></span><span>    </span><span class="hs-comment">-- match_tmpl_var checks (HOP5) and (HOP6)</span><span>
</span><span id="line-1141"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1142"></span><span>    </span><span class="annot"><a href="#local-6989586621682893806"><span class="hs-identifier hs-type">arg_as_lcl_var</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>
</span><span id="line-1143"></span><span>    </span><span id="local-6989586621682893806"><span class="annot"><span class="annottext">arg_as_lcl_var :: CoreExpr -&gt; Maybe Var
</span><a href="#local-6989586621682893806"><span class="hs-identifier hs-var hs-var">arg_as_lcl_var</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893809"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893809"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1144"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893810"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893810"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Maybe Var
</span><a href="GHC.Types.Var.Env.html#rnOccL_maybe"><span class="hs-identifier hs-var">rnOccL_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893794"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893809"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1145"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893810"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682893793"><span class="hs-identifier hs-var">tmpls</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- rnEnvL contains the template variables</span><span>
</span><span id="line-1146"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Maybe Var
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="#local-6989586621682893812"><span class="hs-identifier hs-var">to_target</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893810"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- to_target: see (W1)</span><span>
</span><span id="line-1147"></span><span>                                     </span><span class="hs-comment">--   in Note [Matching higher order patterns]</span><span>
</span><span id="line-1148"></span><span>    </span><span class="annot"><a href="#local-6989586621682893806"><span class="hs-identifier hs-var">arg_as_lcl_var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Var
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1149"></span><span>
</span><span id="line-1150"></span><span>    </span><span id="local-6989586621682893807"><span class="annot"><span class="annottext">can_decompose_app_instead :: Bool
</span><a href="#local-6989586621682893807"><span class="hs-identifier hs-var hs-var">can_decompose_app_instead</span></a></span></span><span> </span><span class="hs-comment">-- Template (e1 v), target (e2 v), and v # fvs(e2)</span><span>
</span><span id="line-1151"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893796"><span class="hs-identifier hs-var">e1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893797"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>      </span><span class="hs-comment">-- See (W2) in Note [Matching higher order patterns]</span><span>
</span><span id="line-1152"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893813"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893813"><span class="hs-identifier hs-var">v1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682893814"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893814"><span class="hs-identifier hs-var">f2</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893815"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893815"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1153"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Var
</span><a href="GHC.Types.Var.Env.html#rnOccL"><span class="hs-identifier hs-var">rnOccL</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893794"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893813"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Var
</span><a href="GHC.Types.Var.Env.html#rnOccR"><span class="hs-identifier hs-var">rnOccR</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893794"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893815"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-1154"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893815"><span class="hs-identifier hs-var">v2</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893814"><span class="hs-identifier hs-var">f2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1155"></span><span>           </span><span class="annot"><span class="annottext">(CoreExpr, CoreExpr)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1156"></span><span>
</span><span id="line-1157"></span><span>    </span><span class="hs-comment">----------------</span><span>
</span><span id="line-1158"></span><span>    </span><span class="hs-comment">-- to_target: see (W1) in Note [Matching higher order patterns]</span><span>
</span><span id="line-1159"></span><span>    </span><span class="annot"><a href="#local-6989586621682893812"><span class="hs-identifier hs-type">to_target</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>   </span><span class="hs-comment">-- From canonical variable back to target-expr variable</span><span>
</span><span id="line-1160"></span><span>    </span><span id="local-6989586621682893812"><span class="annot"><span class="annottext">to_target :: Var -&gt; Var
</span><a href="#local-6989586621682893812"><span class="hs-identifier hs-var hs-var">to_target</span></a></span></span><span> </span><span id="local-6989586621682893818"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893818"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv Var -&gt; Var -&gt; Maybe Var
forall a. VarEnv a -&gt; Var -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Var
</span><a href="#local-6989586621682893819"><span class="hs-identifier hs-var">rev_envR</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893818"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Var -&gt; Var -&gt; Var
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893818"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1161"></span><span>
</span><span id="line-1162"></span><span>    </span><span class="annot"><a href="#local-6989586621682893819"><span class="hs-identifier hs-type">rev_envR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>   </span><span class="hs-comment">-- Inverts rnEnvR: from canonical variable</span><span>
</span><span id="line-1163"></span><span>                             </span><span class="hs-comment">-- back to target-expr variable</span><span>
</span><span id="line-1164"></span><span>    </span><span id="local-6989586621682893819"><span class="annot"><span class="annottext">rev_envR :: VarEnv Var
</span><a href="#local-6989586621682893819"><span class="hs-identifier hs-var hs-var">rev_envR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; Var -&gt; VarEnv Var -&gt; VarEnv Var)
-&gt; VarEnv Var -&gt; VarEnv Var -&gt; VarEnv Var
forall a r. (Unique -&gt; a -&gt; r -&gt; r) -&gt; r -&gt; VarEnv a -&gt; r
</span><a href="GHC.Types.Var.Env.html#nonDetStrictFoldVarEnv_Directly"><span class="hs-identifier hs-var">nonDetStrictFoldVarEnv_Directly</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Var -&gt; VarEnv Var -&gt; VarEnv Var
</span><a href="#local-6989586621682893821"><span class="hs-identifier hs-var">add_one</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Var
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RnEnv2 -&gt; VarEnv Var
</span><a href="GHC.Types.Var.Env.html#rnEnvR"><span class="hs-identifier hs-var">rnEnvR</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893794"><span class="hs-identifier hs-var">rn_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1165"></span><span>    </span><span id="local-6989586621682893821"><span class="annot"><span class="annottext">add_one :: Unique -&gt; Var -&gt; VarEnv Var -&gt; VarEnv Var
</span><a href="#local-6989586621682893821"><span class="hs-identifier hs-var hs-var">add_one</span></a></span></span><span> </span><span id="local-6989586621682893823"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682893823"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span id="local-6989586621682893824"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893824"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621682893825"><span class="annot"><span class="annottext">VarEnv Var
</span><a href="#local-6989586621682893825"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv Var -&gt; Var -&gt; Var -&gt; VarEnv Var
forall a. VarEnv a -&gt; Var -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Var
</span><a href="#local-6989586621682893825"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893824"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893824"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Unique -&gt; Var
</span><a href="GHC.Types.Var.html#setVarUnique"><span class="hs-operator hs-var">`setVarUnique`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682893823"><span class="hs-identifier hs-var">uniq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1166"></span><span>
</span><span id="line-1167"></span><span class="hs-comment">{- Note [Matching higher order patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Higher order patterns provide a limited form of higher order matching.
See GHC Proposal #555
  https://github.com/ghc-proposals/ghc-proposals/blob/master/proposals/0555-template-patterns.rst
and #22465 for more details and related work.

Consider the potential match:

   Template: forall f. foo (\x -&gt; f x)
   Target:             foo (\x -&gt; x*2 + x)

The expression `x*2 + x` in the target is not literally an application of a
function to the variable `x`, so the simple application rule does not apply.
However, we can match them modulo beta equivalence with the substitution:

   [f :-&gt; \x -&gt; x*2 + x]

The general problem of higher order matching is tricky to implement, but
the subproblem which we call /higher order pattern matching/ is sufficient
for the given example and much easier to implement.

Design:

We start with terminology.

* /Template variables/. The forall'd variables are called the template
  variables. In the example match above, `f` is a template variable.

* /Local binders/. The local binders of a rule are the variables bound
  inside the template. In the example match above, `x` is a local binder.
  Note that local binders can be term variables and type variables.

A /higher order pattern/ (HOP) is a sub-expression of the template,
of form (f x y z) where:

* (HOP1) f is a template variable
* (HOP2) x, y, z are local binders (like y in rule &quot;wombat&quot; above; see definitions).
* (HOP3) The arguments x, y, z are term variables
* (HOP4) The arguments x, y, z are distinct (no duplicates)

Matching of higher order patterns (HOP-matching). A higher order pattern (f x y z)
(in the template) matches any target expression e provided:

* (HOP5) The target has the same type as the template
* (HOP6) No local binder is free in e, other than x, y, z.

If these two condition hold, the higher order pattern (f x y z) matches
the target expression e, yielding the substitution [f :-&gt; \x y z. e].
Notice that this substitution is type preserving, and the RHS
of the substitution has no free local binders.

HOP matching is small enough to be done in-line in the `match` function.
Two wrinkles:

(W1) Consider the potential match:
        Template:    forall f. foo (\x -&gt; f x)
        Target:                foo (\y -&gt; (y, y))
     During matching we make `x` the canonical variable for the lambdas
     and then we see:
        Template:    f x       rnEnvL = []
        Target:      (y, y)    rnEnvR = [y :-&gt; x]
     We could bind [f :-&gt; \x. (x,x)], by applying rnEnvR substitution to the target
     expression.  But that is tiresome (a) because it involves a traversal, and
     (b) because rnEnvR is a VarEnv Var, and we don't have a substitution function
     for that.

     So instead, we invert rnEnvR, and apply it to the binders, to get
     [f :-&gt; \y. (y,y)].  This is done by `to_target` in the HOP-matching case.
     It takes a little bit of thinking to be sure this will work right in the case
     of shadowing.  E.g.  Template (\x y. f x y)   Target  (\p p. p*p)
     Here rnEnvR will be just [p :-&gt; y], so after inversion we'll get
          [f :-&gt; \x p. p*p]
     but that is fine.

(W2) This wrinkle concerns the overlap between the new HOP rule and the existing
     decompose-application rule.  See 3.1 of GHC Proposal #555 for a discussion.

     Consider potential match:
        Template: forall f.   foo (\x y. Just (f y x))
        Target:               foo (\p q. Just (h (1+q) p)))
     During matching we will encounter:
        Template:    f x y
        Target:      h (1+q) p    rnEnvR = [p:-&gt;x, q:-&gt;y]
     The rnEnvR renaming `[p:-&gt;x, q:-&gt;y]` is done by the matcher (today) on the fly,
     to make the bound variables of the template and target &quot;line up&quot;.
     But now we can:
     * Either use the new HOP rule to succeed with
          [f :-&gt; \x y. h (1+x) y]
     * Or use the existing decompose-application rule to match
          (f x) against (h (1+q)) and `y` against `p`.
       This will succeed with
          [f :-&gt; \y. h (1+y)]

     Note that the result of the HOP rule will always be eta-equivalent to
     the result of the decompose-application rule.  But the proposal specifies
     that we should use the decompose-application rule because it involves
     less eta-expansion.

     But take care:
        Template: forall f.   foo (\x y. Just (f y x))
        Target:               foo (\p q. Just (h (p+q) p)))
     Then during matching we will encounter:
        Template:    f x y
        Target:      h (p+q) p      rnEnvR = [p:-&gt;x, q:-&gt;y]
     Now, we cannot use the decompose-application rule, because p is free in
     (h (p+q)). So, we can only use the new HOP rule.

(W3) You might wonder if a HOP can have /type/ arguments, thus (in Core)
        RULE forall h.
             f (\(MkT @b (d::Num b) (x::b)) -&gt; h @b d x) = ...
     where the HOP is (h @b d x). In principle this might be possible, but
     it seems fragile; e.g. we would still need to insist that the (invisible)
     @b was a type variable.  And since `h` gets a polymoprhic type, that
     type would have to be declared by the programmer.

     Maybe one day.  But for now, we insist (in `arg_as_lcl_var`)that a HOP
     has only term-variable arguments.
-}</span><span>
</span><span id="line-1286"></span><span>
</span><span id="line-1287"></span><span class="hs-comment">-- Note the match on MRefl!  We fail if there is a cast in the target</span><span>
</span><span id="line-1288"></span><span class="hs-comment">--     (e1 e2) ~ (d1 d2) |&gt; co</span><span>
</span><span id="line-1289"></span><span class="hs-comment">-- See Note [Cancel reflexive casts]: in the Cast equations for 'match'</span><span>
</span><span id="line-1290"></span><span class="hs-comment">-- we aggressively ensure that if MCo is reflective, it really is MRefl.</span><span>
</span><span id="line-1291"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893828"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893828"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893829"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893829"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682893830"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893830"><span class="hs-identifier hs-var">f1</span></a></span></span><span> </span><span id="local-6989586621682893831"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893831"><span class="hs-identifier hs-var">a1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682893832"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893832"><span class="hs-identifier hs-var">f2</span></a></span></span><span> </span><span id="local-6989586621682893833"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893833"><span class="hs-identifier hs-var">a2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-1292"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682893834"><span class="annot"><a href="#local-6989586621682893834"><span class="hs-identifier hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893828"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893829"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893830"><span class="hs-identifier hs-var">f1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893832"><span class="hs-identifier hs-var">f2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-1293"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-type">match</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893828"><span class="hs-identifier hs-type">renv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893834"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893831"><span class="hs-identifier hs-type">a1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893833"><span class="hs-identifier hs-type">a2</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-type">MRefl</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1294"></span><span>
</span><span id="line-1295"></span><span class="hs-comment">------------------------ Float lets ---------------------</span><span>
</span><span id="line-1296"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893835"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893835"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893836"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893836"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682893837"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893837"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682893839"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682893839"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621682893840"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893840"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893841"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893841"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1297"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- pprTrace &quot;match:Let&quot; (vcat [ppr bind, ppr $ okToFloat (rv_lcl renv) (bindFreeVars bind)]) $</span><span>
</span><span id="line-1298"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBind -&gt; Bool
</span><a href="GHC.Core.Utils.html#isJoinBind"><span class="hs-identifier hs-var">isJoinBind</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682893839"><span class="hs-identifier hs-var">bind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- can't float join point out of argument position</span><span>
</span><span id="line-1299"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; VarSet -&gt; Bool
</span><a href="GHC.Core.Rules.html#okToFloat"><span class="hs-identifier hs-var">okToFloat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893835"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBind -&gt; VarSet
</span><a href="GHC.Core.FVs.html#bindFreeVars"><span class="hs-identifier hs-var">bindFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682893839"><span class="hs-identifier hs-var">bind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Matching lets]</span><span>
</span><span id="line-1300"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893835"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rv_fltR"><span class="hs-identifier hs-var">rv_fltR</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682893843"><span class="hs-identifier hs-type">flt_subst'</span></a></span><span>
</span><span id="line-1301"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893835"><span class="hs-identifier hs-type">renv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendRnInScopeSetList"><span class="hs-operator hs-type">`extendRnInScopeSetList`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893845"><span class="hs-identifier hs-type">new_bndrs</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1302"></span><span>                </span><span class="hs-comment">-- We are floating the let-binding out, as if it had enclosed</span><span>
</span><span id="line-1303"></span><span>                </span><span class="hs-comment">-- the entire target from Day 1.  So we must add its binders to</span><span>
</span><span id="line-1304"></span><span>                </span><span class="hs-comment">-- the in-scope set (#20200)</span><span>
</span><span id="line-1305"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893836"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_binds"><span class="hs-identifier hs-var">rs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_binds"><span class="hs-identifier hs-var">rs_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893836"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893846"><span class="hs-identifier hs-type">bind'</span></a></span><span>
</span><span id="line-1306"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_bndrs"><span class="hs-identifier hs-var">rs_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682893845"><span class="hs-identifier hs-type">new_bndrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_bndrs"><span class="hs-identifier hs-var">rs_bndrs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893836"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1307"></span><span>          </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893837"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893840"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893841"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1308"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1309"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1310"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1311"></span><span>    </span><span id="local-6989586621682893847"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682893847"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#rnInScopeSet"><span class="hs-identifier hs-var">rnInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893835"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [Var] -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSetList"><span class="hs-operator hs-var">`extendInScopeSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst -&gt; [Var]
</span><a href="GHC.Core.Rules.html#rs_bndrs"><span class="hs-identifier hs-var">rs_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893836"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1312"></span><span>                </span><span class="hs-comment">-- in_scope: see (4) in Note [Matching lets]</span><span>
</span><span id="line-1313"></span><span>    </span><span id="local-6989586621682893848"><span class="annot"><span class="annottext">flt_subst :: Subst
</span><a href="#local-6989586621682893848"><span class="hs-identifier hs-var hs-var">flt_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; Subst
</span><a href="GHC.Core.Rules.html#rv_fltR"><span class="hs-identifier hs-var">rv_fltR</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893835"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#setInScope"><span class="hs-operator hs-var">`setInScope`</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893847"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-1314"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682893843"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893843"><span class="hs-identifier hs-var">flt_subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893846"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682893846"><span class="hs-identifier hs-var">bind'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreBind -&gt; (Subst, CoreBind)
Subst -&gt; CoreBind -&gt; (Subst, CoreBind)
</span><a href="GHC.Core.Subst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893848"><span class="hs-identifier hs-var">flt_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682893839"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-1315"></span><span>    </span><span id="local-6989586621682893845"><span class="annot"><span class="annottext">new_bndrs :: [Var]
</span><a href="#local-6989586621682893845"><span class="hs-identifier hs-var hs-var">new_bndrs</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; [Var]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682893846"><span class="hs-identifier hs-var">bind'</span></a></span><span>
</span><span id="line-1316"></span><span>
</span><span id="line-1317"></span><span class="hs-comment">------------------------  Lambdas ---------------------</span><span>
</span><span id="line-1318"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893851"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893851"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893852"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893852"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682893854"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893854"><span class="hs-identifier hs-var">x1</span></a></span></span><span> </span><span id="local-6989586621682893855"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893855"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893856"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893856"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621682893857"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893857"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1319"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682893858"><span class="annot"><span class="annottext">casted_e2 :: CoreExpr
</span><a href="#local-6989586621682893858"><span class="hs-identifier hs-var hs-var">casted_e2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; MCoercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-identifier hs-var">mkCastMCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893856"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893857"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1320"></span><span>        </span><span id="local-6989586621682893859"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682893859"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSetSet"><span class="hs-identifier hs-var">extendInScopeSetSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RnEnv2 -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#rnInScopeSet"><span class="hs-identifier hs-var">rnInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893851"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1321"></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893858"><span class="hs-identifier hs-var">casted_e2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1322"></span><span>        </span><span id="local-6989586621682893861"><span class="annot"><span class="annottext">in_scope_env :: InScopeEnv
</span><a href="#local-6989586621682893861"><span class="hs-identifier hs-var hs-var">in_scope_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdUnfoldingFun -&gt; InScopeEnv
</span><a href="GHC.Core.html#ISE"><span class="hs-identifier hs-var">ISE</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682893859"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; IdUnfoldingFun
</span><a href="GHC.Core.Rules.html#rv_unf"><span class="hs-identifier hs-var">rv_unf</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893851"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1323"></span><span>        </span><span class="hs-comment">-- extendInScopeSetSet: The InScopeSet of rn_env is not necessarily</span><span>
</span><span id="line-1324"></span><span>        </span><span class="hs-comment">-- a superset of the free vars of e2; it is only guaranteed a superset of</span><span>
</span><span id="line-1325"></span><span>        </span><span class="hs-comment">-- applying the (rnEnvR rn_env) substitution to e2. But exprIsLambda_maybe</span><span>
</span><span id="line-1326"></span><span>        </span><span class="hs-comment">-- wants an in-scope set that includes all the free vars of its argument.</span><span>
</span><span id="line-1327"></span><span>        </span><span class="hs-comment">-- Hence adding adding (exprFreeVars casted_e2) to the in-scope set (#23630)</span><span>
</span><span id="line-1328"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893862"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893862"><span class="hs-identifier hs-var">x2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893863"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893863"><span class="hs-identifier hs-var">e2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893864"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621682893864"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeEnv -&gt; CoreExpr -&gt; Maybe (Var, CoreExpr, [CoreTickish])
InScopeEnv -&gt; CoreExpr -&gt; Maybe (Var, CoreExpr, [CoreTickish])
</span><a href="GHC.Core.SimpleOpt.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682893861"><span class="hs-identifier hs-var">in_scope_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893858"><span class="hs-identifier hs-var">casted_e2</span></a></span><span>
</span><span id="line-1329"></span><span>    </span><span class="hs-comment">-- See Note [Lambdas in the template]</span><span>
</span><span id="line-1330"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682893865"><span class="annot"><span class="annottext">renv' :: RuleMatchEnv
</span><a href="#local-6989586621682893865"><span class="hs-identifier hs-var hs-var">renv'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; Var -&gt; Var -&gt; RuleMatchEnv
</span><a href="GHC.Core.Rules.html#rnMatchBndr2"><span class="hs-identifier hs-var">rnMatchBndr2</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893851"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893854"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893862"><span class="hs-identifier hs-var">x2</span></a></span><span>
</span><span id="line-1331"></span><span>        </span><span id="local-6989586621682893867"><span class="annot"><span class="annottext">subst' :: RuleSubst
</span><a href="#local-6989586621682893867"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893852"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_binds"><span class="hs-identifier hs-var">rs_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_binds"><span class="hs-identifier hs-var">rs_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893852"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">foldr</span></span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-type">mkTick</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682893864"><span class="hs-identifier hs-type">ts</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1332"></span><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893865"><span class="hs-identifier hs-var">renv'</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893867"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893855"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893863"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-1333"></span><span>
</span><span id="line-1334"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893870"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893870"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893871"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893871"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682893872"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893872"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621682893873"><span class="annot"><span class="annottext">e2 :: CoreExpr
</span><a href="#local-6989586621682893873"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893874"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893874"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1335"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893875"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893875"><span class="hs-identifier hs-var">renv'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893876"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893876"><span class="hs-identifier hs-var">e2'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; CoreExpr -&gt; Maybe (RuleMatchEnv, CoreExpr)
</span><a href="GHC.Core.Rules.html#eta_reduce"><span class="hs-identifier hs-var">eta_reduce</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893870"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893873"><span class="hs-identifier hs-var">e2</span></a></span><span>  </span><span class="hs-comment">-- See Note [Eta reduction in the target]</span><span>
</span><span id="line-1336"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893875"><span class="hs-identifier hs-var">renv'</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893871"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893872"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893876"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893874"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1337"></span><span>
</span><span id="line-1338"></span><span class="hs-comment">{- Note [Lambdas in the template]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we match
   Template:   (\x. blah_template)
   Target:     (\y. blah_target)
then we want to match inside the lambdas, using rv_lcl to match up
x and y.

But what about this?
   Template   (\x. (blah1 |&gt; cv))
   Target     (\y. blah2) |&gt; co

This happens quite readily, because the Simplifier generally moves
casts outside lambdas: see Note [Casts and lambdas] in
GHC.Core.Opt.Simplify.Utils. So, tiresomely, we want to push `co`
back inside, which is what `exprIsLambda_maybe` does.  But we've
stripped off that cast, so now we need to put it back, hence mkCastMCo.

Unlike the target, where we attempt eta-reduction, we do not attempt
to eta-reduce the template, and may therefore fail on
  Template:   \x. f True x
  Target      f True

It's not especially easy to deal with eta reducing the template,
and never happens, because no one write eta-expanded left-hand-sides.
-}</span><span>
</span><span id="line-1364"></span><span>
</span><span id="line-1365"></span><span class="hs-comment">------------------------ Case expression ---------------------</span><span>
</span><span id="line-1366"></span><span class="hs-comment">{- Disabled: see Note [Matching cases] below
match renv (tv_subst, id_subst, binds) e1
      (Case scrut case_bndr ty [(con, alt_bndrs, rhs)])
  | exprOkForSpeculation scrut  -- See Note [Matching cases]
  , okToFloat rn_env bndrs (exprFreeVars scrut)
  = match (renv { me_env = rn_env' })
          (tv_subst, id_subst, binds . case_wrap)
          e1 rhs
  where
    rn_env   = me_env renv
    rn_env'  = extendRnInScopeList rn_env bndrs
    bndrs    = case_bndr : alt_bndrs
    case_wrap rhs' = Case scrut case_bndr ty [(con, alt_bndrs, rhs')]
-}</span><span>
</span><span id="line-1380"></span><span>
</span><span id="line-1381"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span id="local-6989586621682893878"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893878"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893879"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893879"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682893881"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893881"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621682893882"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893882"><span class="hs-identifier hs-var">x1</span></a></span></span><span> </span><span id="local-6989586621682893883"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893883"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682893884"><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621682893884"><span class="hs-identifier hs-var">alts1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682893885"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893885"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621682893886"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893886"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span id="local-6989586621682893887"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893887"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621682893888"><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621682893888"><span class="hs-identifier hs-var">alts2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893889"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893889"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1382"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682893890"><span class="annot"><a href="#local-6989586621682893890"><span class="hs-identifier hs-var">subst1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RuleSubst -&gt; Kind -&gt; Kind -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_ty"><span class="hs-identifier hs-var">match_ty</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893878"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893879"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893883"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893887"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1383"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682893891"><span class="annot"><a href="#local-6989586621682893891"><span class="hs-identifier hs-var">subst2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-type">match</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893878"><span class="hs-identifier hs-type">renv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893890"><span class="hs-identifier hs-type">subst1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893881"><span class="hs-identifier hs-type">e1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893885"><span class="hs-identifier hs-type">e2</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-type">MRefl</span></a></span><span>
</span><span id="line-1384"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682893892"><span class="annot"><a href="#local-6989586621682893892"><span class="hs-identifier hs-var hs-var">renv'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; Var -&gt; Var -&gt; RuleMatchEnv
</span><a href="GHC.Core.Rules.html#rnMatchBndr2"><span class="hs-identifier hs-var">rnMatchBndr2</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893878"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893882"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893886"><span class="hs-identifier hs-var">x2</span></a></span><span>
</span><span id="line-1385"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#match_alts"><span class="hs-identifier hs-type">match_alts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893892"><span class="hs-identifier hs-type">renv'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893891"><span class="hs-identifier hs-type">subst2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893884"><span class="hs-identifier hs-type">alts1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893888"><span class="hs-identifier hs-type">alts2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893889"><span class="hs-identifier hs-type">mco</span></a></span><span>   </span><span class="hs-comment">-- Alts are both sorted</span><span>
</span><span id="line-1386"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1387"></span><span>
</span><span id="line-1388"></span><span class="hs-comment">-- Everything else fails</span><span>
</span><span id="line-1389"></span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682893894"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893894"><span class="hs-identifier hs-var">_e1</span></a></span></span><span> </span><span id="local-6989586621682893895"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893895"><span class="hs-identifier hs-var">_e2</span></a></span></span><span> </span><span id="local-6989586621682893896"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893896"><span class="hs-identifier hs-var">_mco</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;Failing at&quot; ((text &quot;e1:&quot; &lt;+&gt; ppr _e1) $$ (text &quot;e2:&quot; &lt;+&gt; ppr _e2)) $</span><span>
</span><span id="line-1390"></span><span>                         </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1391"></span><span>
</span><span id="line-1392"></span><span class="hs-comment">-------------</span><span>
</span><span id="line-1393"></span><span class="annot"><a href="GHC.Core.Rules.html#eta_reduce"><span class="hs-identifier hs-type">eta_reduce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1394"></span><span class="hs-comment">-- See Note [Eta reduction in the target]</span><span>
</span><span id="line-1395"></span><span id="eta_reduce"><span class="annot"><span class="annottext">eta_reduce :: RuleMatchEnv -&gt; CoreExpr -&gt; Maybe (RuleMatchEnv, CoreExpr)
</span><a href="GHC.Core.Rules.html#eta_reduce"><span class="hs-identifier hs-var hs-var">eta_reduce</span></a></span></span><span> </span><span id="local-6989586621682893897"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893897"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893898"><span class="annot"><span class="annottext">e :: CoreExpr
</span><a href="#local-6989586621682893898"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1396"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; (CoreExpr -&gt; CoreExpr)
-&gt; [Var]
-&gt; CoreExpr
-&gt; Maybe (RuleMatchEnv, CoreExpr)
</span><a href="#local-6989586621682893899"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893897"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893898"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1397"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1398"></span><span>    </span><span class="annot"><a href="#local-6989586621682893899"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#BindWrapper"><span class="hs-identifier hs-type">BindWrapper</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1399"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1400"></span><span>    </span><span id="local-6989586621682893899"><span class="annot"><span class="annottext">go :: RuleMatchEnv
-&gt; (CoreExpr -&gt; CoreExpr)
-&gt; [Var]
-&gt; CoreExpr
-&gt; Maybe (RuleMatchEnv, CoreExpr)
</span><a href="#local-6989586621682893899"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682893901"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893901"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893902"><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682893902"><span class="hs-identifier hs-var">bw</span></a></span></span><span> </span><span id="local-6989586621682893903"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893903"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682893904"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682893904"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682893905"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893905"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; (CoreExpr -&gt; CoreExpr)
-&gt; [Var]
-&gt; CoreExpr
-&gt; Maybe (RuleMatchEnv, CoreExpr)
</span><a href="#local-6989586621682893899"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893901"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682893902"><span class="hs-identifier hs-var">bw</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr)
-&gt; (CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreExpr -&gt; CoreExpr
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682893904"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893903"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893905"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1401"></span><span>
</span><span id="line-1402"></span><span>    </span><span class="annot"><a href="#local-6989586621682893899"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682893906"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893906"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893907"><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682893907"><span class="hs-identifier hs-var">bw</span></a></span></span><span> </span><span id="local-6989586621682893908"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893908"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682893909"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893909"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682893910"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893910"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; (CoreExpr -&gt; CoreExpr)
-&gt; [Var]
-&gt; CoreExpr
-&gt; Maybe (RuleMatchEnv, CoreExpr)
</span><a href="#local-6989586621682893899"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893911"><span class="hs-identifier hs-var">renv'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682893907"><span class="hs-identifier hs-var">bw</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893912"><span class="hs-identifier hs-var">v'</span></a></span><span class="annot"><span class="annottext">Var -&gt; [Var] -&gt; [Var]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893908"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893910"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1403"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1404"></span><span>         </span><span class="hs-special">(</span><span id="local-6989586621682893913"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893913"><span class="hs-identifier hs-var">rn_env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893912"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893912"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; (RnEnv2, Var)
</span><a href="GHC.Types.Var.Env.html#rnBndrR"><span class="hs-identifier hs-var">rnBndrR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893906"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893909"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1405"></span><span>         </span><span id="local-6989586621682893911"><span class="annot"><span class="annottext">renv' :: RuleMatchEnv
</span><a href="#local-6989586621682893911"><span class="hs-identifier hs-var hs-var">renv'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893906"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682893913"><span class="hs-identifier hs-type">rn_env'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1406"></span><span>
</span><span id="line-1407"></span><span>    </span><span class="annot"><a href="#local-6989586621682893899"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682893915"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893915"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893916"><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682893916"><span class="hs-identifier hs-var">bw</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893917"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893917"><span class="hs-identifier hs-var">v</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682893918"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893918"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682893919"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893919"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682893920"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893920"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1408"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893921"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893921"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893920"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893917"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Var
</span><a href="GHC.Types.Var.Env.html#rnOccR"><span class="hs-identifier hs-var">rnOccR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893915"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893921"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1409"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; (CoreExpr -&gt; CoreExpr)
-&gt; [Var]
-&gt; CoreExpr
-&gt; Maybe (RuleMatchEnv, CoreExpr)
</span><a href="#local-6989586621682893899"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893915"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682893916"><span class="hs-identifier hs-var">bw</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893918"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893919"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1410"></span><span>
</span><span id="line-1411"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682893922"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893922"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893920"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893923"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893923"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Maybe Var
</span><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893922"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1412"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893917"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Var
</span><a href="GHC.Types.Var.Env.html#rnOccR"><span class="hs-identifier hs-var">rnOccR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893915"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893923"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-1413"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; (CoreExpr -&gt; CoreExpr)
-&gt; [Var]
-&gt; CoreExpr
-&gt; Maybe (RuleMatchEnv, CoreExpr)
</span><a href="#local-6989586621682893899"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893915"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682893916"><span class="hs-identifier hs-var">bw</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893918"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893919"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1414"></span><span>
</span><span id="line-1415"></span><span>    </span><span class="annot"><a href="#local-6989586621682893899"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682893924"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893924"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893925"><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682893925"><span class="hs-identifier hs-var">bw</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span id="local-6989586621682893926"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893926"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RuleMatchEnv, CoreExpr) -&gt; Maybe (RuleMatchEnv, CoreExpr)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893924"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682893925"><span class="hs-identifier hs-var">bw</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893926"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1416"></span><span>    </span><span class="annot"><a href="#local-6989586621682893899"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><span class="hs-identifier">_</span></span><span>    </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Var]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (RuleMatchEnv, CoreExpr)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1417"></span><span>
</span><span id="line-1418"></span><span class="annot"><a href="GHC.Core.Rules.html#eta_reduce"><span class="hs-identifier hs-var">eta_reduce</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (RuleMatchEnv, CoreExpr)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1419"></span><span>
</span><span id="line-1420"></span><span class="hs-comment">{- Note [Eta reduction in the target]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we are faced with this (#19790)
   Template {x}  f x
   Target        (\a b c. let blah in f x a b c)

You might wonder why we have an eta-expanded target (see first subtle
point below), but regardless of how it came about, we'd like
eta-expansion not to impede matching.

So eta_reduce does on-the-fly eta-reduction of the target expression.
Given (\a b c. let blah in e a b c), it returns (let blah in e).

Subtle points:
* Consider a target:  \x. f &lt;expensive&gt; x
  In the main eta-reducer we do not eta-reduce this, because doing so
  might reduce the arity of the expression (from 1 to zero, because of
  &lt;expensive&gt;).  But for rule-matching we /do/ want to match template
  (f a) against target (\x. f &lt;expensive&gt; x), with a := &lt;expensive&gt;

  This is a compelling reason for not relying on the Simplifier's
  eta-reducer.

* The Lam case of eta_reduce renames as it goes. Consider
  (\x. \x. f x x).  We should not eta-reduce this.  As we go we rename
  the first x to x1, and the second to x2; then both argument x's are x2.

* eta_reduce does /not/ need to check that the bindings 'blah'
  and expression 'e' don't mention a b c; but it /does/ extend the
  rv_lcl RnEnv2 (see rn_bndr in eta_reduce).
  * If 'blah' mentions the binders, the let-float rule won't
    fire; and
  * if 'e' mentions the binders we we'll also fail to match
    e.g. because of the exprFreeVars test in match_tmpl_var.

  Example: Template: {x}  f a         -- Some top-level 'a'
           Target:   (\a b. f a a b)  -- The \a shadows top level 'a'
  Then eta_reduce will /succeed/, with
      (rnEnvR = [a :-&gt; a'], f a)
  The returned RnEnv will map [a :-&gt; a'], where a' is fresh. (There is
  no need to rename 'b' because (in this example) it is not in scope.
  So it's as if we'd returned (f a') from eta_reduce; the renaming applied
  to the target is simply deferred.

Note [Cancel reflexive casts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is an example (from #19790) which we want to catch
   (f x) ~ (\a b. (f x |&gt; co) a b) |&gt; sym co
where
   f :: Int -&gt; Stream
   co :: Stream ~ T1 -&gt; T2 -&gt; T3

when we eta-reduce (\a b. blah a b) to 'blah', we'll get
  (f x) ~ (f x) |&gt; co |&gt; sym co

and we really want to spot that the co/sym-co cancels out.
Hence
  * We keep an invariant that the MCoercion is always MRefl
    if the MCoercion is reflexive
  * We maintain this invariant via the call to checkReflexiveMCo
    in the Cast case of 'match'.
-}</span><span>
</span><span id="line-1482"></span><span>
</span><span id="line-1483"></span><span class="hs-comment">-------------</span><span>
</span><span id="line-1484"></span><span class="annot"><a href="GHC.Core.Rules.html#matchTemplateCast"><span class="hs-identifier hs-type">matchTemplateCast</span></a></span><span>
</span><span id="line-1485"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1486"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1487"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span>
</span><span id="line-1488"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1489"></span><span id="matchTemplateCast"><span class="annot"><span class="annottext">matchTemplateCast :: RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; Coercion
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#matchTemplateCast"><span class="hs-identifier hs-var hs-var">matchTemplateCast</span></a></span></span><span> </span><span id="local-6989586621682893927"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893927"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893928"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893928"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682893929"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893929"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621682893930"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893930"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682893931"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893931"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621682893932"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893932"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1490"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; Bool) -&gt; VarSet -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FV -&gt; VarSet
</span><a href="GHC.Utils.FV.html#fvVarSet"><span class="hs-identifier hs-var">fvVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(FV -&gt; VarSet) -&gt; FV -&gt; VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1491"></span><span>    </span><span class="annot"><span class="annottext">(Var -&gt; Bool) -&gt; FV -&gt; FV
</span><a href="GHC.Utils.FV.html#filterFV"><span class="hs-identifier hs-var">filterFV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; VarSet
</span><a href="GHC.Core.Rules.html#rv_tmpls"><span class="hs-identifier hs-var">rv_tmpls</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893927"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FV -&gt; FV) -&gt; FV -&gt; FV
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>    </span><span class="hs-comment">-- Check that the coercion does not</span><span>
</span><span id="line-1492"></span><span>    </span><span class="annot"><span class="annottext">Coercion -&gt; FV
</span><a href="GHC.Core.TyCo.FVs.html#tyCoFVsOfCo"><span class="hs-identifier hs-var">tyCoFVsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893935"><span class="hs-identifier hs-var">substed_co</span></a></span><span>                     </span><span class="hs-comment">-- mention any of the template variables</span><span>
</span><span id="line-1493"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- This is the good path</span><span>
</span><span id="line-1494"></span><span>    </span><span class="hs-comment">-- See Note [Casts in the template]</span><span>
</span><span id="line-1495"></span><span>    </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893927"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893928"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893929"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893931"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercion -&gt; MCoercion
</span><a href="GHC.Core.Coercion.html#checkReflexiveMCo"><span class="hs-identifier hs-var">checkReflexiveMCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercion -&gt; Coercion -&gt; MCoercion
</span><a href="GHC.Core.Coercion.html#mkTransMCoL"><span class="hs-identifier hs-var">mkTransMCoL</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893932"><span class="hs-identifier hs-var">mco</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893935"><span class="hs-identifier hs-var">substed_co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1496"></span><span>
</span><span id="line-1497"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1498"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- This is the Deeply Suspicious Path</span><span>
</span><span id="line-1499"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682893938"><span class="annot"><span class="annottext">co2 :: Coercion
</span><a href="#local-6989586621682893938"><span class="hs-identifier hs-var hs-var hs-var">co2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893932"><span class="hs-identifier hs-var">mco</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1500"></span><span>                     </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893931"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1501"></span><span>                     </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682893941"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893941"><span class="hs-identifier hs-var">co2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893941"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1502"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682893942"><span class="annot"><a href="#local-6989586621682893942"><span class="hs-identifier hs-var">subst1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst -&gt; Coercion -&gt; Coercion -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_co"><span class="hs-identifier hs-var">match_co</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893927"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893928"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893930"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893938"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1503"></span><span>         </span><span class="hs-comment">-- If match_co succeeds, then (exprType e1) = (exprType e2)</span><span>
</span><span id="line-1504"></span><span>         </span><span class="hs-comment">-- Hence the MRefl in the next line</span><span>
</span><span id="line-1505"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-type">match</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893927"><span class="hs-identifier hs-type">renv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893942"><span class="hs-identifier hs-type">subst1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893929"><span class="hs-identifier hs-type">e1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893931"><span class="hs-identifier hs-type">e2</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-type">MRefl</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1506"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1507"></span><span>    </span><span id="local-6989586621682893935"><span class="annot"><span class="annottext">substed_co :: Coercion
</span><a href="#local-6989586621682893935"><span class="hs-identifier hs-var hs-var">substed_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893943"><span class="hs-identifier hs-var">current_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893930"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-1508"></span><span>
</span><span id="line-1509"></span><span>    </span><span class="annot"><a href="#local-6989586621682893943"><span class="hs-identifier hs-type">current_subst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-1510"></span><span>    </span><span id="local-6989586621682893943"><span class="annot"><span class="annottext">current_subst :: Subst
</span><a href="#local-6989586621682893943"><span class="hs-identifier hs-var hs-var">current_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkTCvSubst"><span class="hs-identifier hs-var">mkTCvSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RnEnv2 -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#rnInScopeSet"><span class="hs-identifier hs-var">rnInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893927"><span class="hs-identifier hs-var">renv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1511"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleSubst -&gt; TvSubstEnv
</span><a href="GHC.Core.Rules.html#rs_tv_subst"><span class="hs-identifier hs-var">rs_tv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893928"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1512"></span><span>                               </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyCvSubstEnv"><span class="hs-identifier hs-var">emptyCvSubstEnv</span></a></span><span>
</span><span id="line-1513"></span><span>       </span><span class="hs-comment">-- emptyCvSubstEnv: ugh!</span><span>
</span><span id="line-1514"></span><span>       </span><span class="hs-comment">-- If there were any CoVar substitutions they would be in</span><span>
</span><span id="line-1515"></span><span>       </span><span class="hs-comment">-- rs_id_subst; but we don't expect there to be any; see</span><span>
</span><span id="line-1516"></span><span>       </span><span class="hs-comment">-- Note [Casts in the template]</span><span>
</span><span id="line-1517"></span><span>
</span><span id="line-1518"></span><span class="annot"><a href="GHC.Core.Rules.html#match_co"><span class="hs-identifier hs-type">match_co</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span>
</span><span id="line-1519"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1520"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1521"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1522"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1523"></span><span class="hs-comment">-- We only match if the template is a coercion variable or Refl:</span><span>
</span><span id="line-1524"></span><span class="hs-comment">--   see Note [Casts in the template]</span><span>
</span><span id="line-1525"></span><span class="hs-comment">-- Like 'match' it is /not/ guaranteed that</span><span>
</span><span id="line-1526"></span><span class="hs-comment">--     coercionKind template  =  coercionKind target</span><span>
</span><span id="line-1527"></span><span class="hs-comment">-- But if match_co succeeds, it /is/ guaranteed that</span><span>
</span><span id="line-1528"></span><span class="hs-comment">--     coercionKind (subst template) = coercionKind target</span><span>
</span><span id="line-1529"></span><span>
</span><span id="line-1530"></span><span id="match_co"><span class="annot"><span class="annottext">match_co :: RuleMatchEnv
-&gt; RuleSubst -&gt; Coercion -&gt; Coercion -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_co"><span class="hs-identifier hs-var hs-var">match_co</span></a></span></span><span> </span><span id="local-6989586621682893946"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893946"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893947"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893947"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682893948"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893948"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682893949"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893949"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-1531"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893950"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893950"><span class="hs-identifier hs-var">cv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe Var
</span><a href="GHC.Core.Coercion.html#getCoVar_maybe"><span class="hs-identifier hs-var">getCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893948"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-1532"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RuleSubst -&gt; Var -&gt; CoreExpr -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_var"><span class="hs-identifier hs-var">match_var</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893946"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893947"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893950"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893949"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1533"></span><span>
</span><span id="line-1534"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893952"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682893952"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893953"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682893953"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (Kind, Role)
</span><a href="GHC.Core.Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893948"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-1535"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893955"><span class="annot"><a href="#local-6989586621682893955"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682893956"><span class="annot"><a href="#local-6989586621682893956"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (Kind, Role)
</span><a href="GHC.Core.Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893949"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1536"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682893953"><span class="hs-identifier hs-type">r1</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><a href="#local-6989586621682893956"><span class="hs-identifier hs-type">r2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1537"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#match_ty"><span class="hs-identifier hs-type">match_ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893946"><span class="hs-identifier hs-type">renv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893947"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893952"><span class="hs-identifier hs-type">ty1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893955"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1538"></span><span>
</span><span id="line-1539"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a></span><span>
</span><span id="line-1540"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; Maybe RuleSubst -&gt; Maybe RuleSubst
forall a. String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;match_co: needs more cases&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893948"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682893949"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1541"></span><span>    </span><span class="hs-comment">-- Currently just deals with CoVarCo and Refl</span><span>
</span><span id="line-1542"></span><span>
</span><span id="line-1543"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1544"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1545"></span><span>
</span><span id="line-1546"></span><span class="hs-comment">-------------</span><span>
</span><span id="line-1547"></span><span class="annot"><a href="GHC.Core.Rules.html#rnMatchBndr2"><span class="hs-identifier hs-type">rnMatchBndr2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span>
</span><span id="line-1548"></span><span id="rnMatchBndr2"><span class="annot"><span class="annottext">rnMatchBndr2 :: RuleMatchEnv -&gt; Var -&gt; Var -&gt; RuleMatchEnv
</span><a href="GHC.Core.Rules.html#rnMatchBndr2"><span class="hs-identifier hs-var hs-var">rnMatchBndr2</span></a></span></span><span> </span><span id="local-6989586621682893958"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893958"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893959"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893959"><span class="hs-identifier hs-var">x1</span></a></span></span><span> </span><span id="local-6989586621682893960"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893960"><span class="hs-identifier hs-var">x2</span></a></span></span><span>
</span><span id="line-1549"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893958"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#rnBndr2"><span class="hs-identifier hs-type">rnBndr2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893958"><span class="hs-identifier hs-type">renv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682893959"><span class="hs-identifier hs-type">x1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893960"><span class="hs-identifier hs-type">x2</span></a></span><span>
</span><span id="line-1550"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rv_fltR"><span class="hs-identifier hs-var">rv_fltR</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#delBndr"><span class="hs-identifier hs-type">delBndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#rv_fltR"><span class="hs-identifier hs-var">rv_fltR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893958"><span class="hs-identifier hs-type">renv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682893960"><span class="hs-identifier hs-type">x2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1551"></span><span>
</span><span id="line-1552"></span><span>
</span><span id="line-1553"></span><span class="hs-comment">------------------------------------------</span><span>
</span><span id="line-1554"></span><span class="annot"><a href="GHC.Core.Rules.html#match_alts"><span class="hs-identifier hs-type">match_alts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span>
</span><span id="line-1555"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1556"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- Template</span><span>
</span><span id="line-1557"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span>    </span><span class="hs-comment">-- Target</span><span>
</span><span id="line-1558"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1559"></span><span id="match_alts"><span class="annot"><span class="annottext">match_alts :: RuleMatchEnv
-&gt; RuleSubst
-&gt; [Alt Var]
-&gt; [Alt Var]
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_alts"><span class="hs-identifier hs-var hs-var">match_alts</span></a></span></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682893964"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893964"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1560"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleSubst -&gt; Maybe RuleSubst
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893964"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1561"></span><span class="annot"><a href="GHC.Core.Rules.html#match_alts"><span class="hs-identifier hs-var">match_alts</span></a></span><span> </span><span id="local-6989586621682893965"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893965"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span id="local-6989586621682893966"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893966"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682893968"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682893968"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span id="local-6989586621682893969"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893969"><span class="hs-identifier hs-var">vs1</span></a></span></span><span> </span><span id="local-6989586621682893970"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893970"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682893971"><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621682893971"><span class="hs-identifier hs-var">alts1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682893972"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682893972"><span class="hs-identifier hs-var">c2</span></a></span></span><span> </span><span id="local-6989586621682893973"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893973"><span class="hs-identifier hs-var">vs2</span></a></span></span><span> </span><span id="local-6989586621682893974"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893974"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682893975"><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621682893975"><span class="hs-identifier hs-var">alts2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682893976"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893976"><span class="hs-identifier hs-var">mco</span></a></span></span><span>
</span><span id="line-1562"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682893968"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; AltCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682893972"><span class="hs-identifier hs-var">c2</span></a></span><span>
</span><span id="line-1563"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682893977"><span class="annot"><a href="#local-6989586621682893977"><span class="hs-identifier hs-var">subst1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893978"><span class="hs-identifier hs-var">renv'</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893966"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893970"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893974"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682893976"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1564"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#match_alts"><span class="hs-identifier hs-type">match_alts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893965"><span class="hs-identifier hs-type">renv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893977"><span class="hs-identifier hs-type">subst1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893971"><span class="hs-identifier hs-type">alts1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893975"><span class="hs-identifier hs-type">alts2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682893976"><span class="hs-identifier hs-type">mco</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1565"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1566"></span><span>    </span><span id="local-6989586621682893978"><span class="annot"><span class="annottext">renv' :: RuleMatchEnv
</span><a href="#local-6989586621682893978"><span class="hs-identifier hs-var hs-var">renv'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RuleMatchEnv -&gt; (Var, Var) -&gt; RuleMatchEnv)
-&gt; RuleMatchEnv -&gt; [(Var, Var)] -&gt; RuleMatchEnv
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; (Var, Var) -&gt; RuleMatchEnv
</span><a href="#local-6989586621682893979"><span class="hs-identifier hs-var">mb</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893965"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893969"><span class="hs-identifier hs-var">vs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; [Var] -&gt; [(Var, Var)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682893973"><span class="hs-identifier hs-var">vs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1567"></span><span>    </span><span id="local-6989586621682893979"><span class="annot"><span class="annottext">mb :: RuleMatchEnv -&gt; (Var, Var) -&gt; RuleMatchEnv
</span><a href="#local-6989586621682893979"><span class="hs-identifier hs-var hs-var">mb</span></a></span></span><span> </span><span id="local-6989586621682893980"><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893980"><span class="hs-identifier hs-var">renv</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682893981"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893981"><span class="hs-identifier hs-var">v1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682893982"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893982"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; Var -&gt; Var -&gt; RuleMatchEnv
</span><a href="GHC.Core.Rules.html#rnMatchBndr2"><span class="hs-identifier hs-var">rnMatchBndr2</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893980"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893981"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893982"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-1568"></span><span>
</span><span id="line-1569"></span><span class="annot"><a href="GHC.Core.Rules.html#match_alts"><span class="hs-identifier hs-var">match_alts</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Alt Var]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Alt Var]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1570"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1571"></span><span>
</span><span id="line-1572"></span><span class="hs-comment">------------------------------------------</span><span>
</span><span id="line-1573"></span><span class="annot"><a href="GHC.Core.Rules.html#okToFloat"><span class="hs-identifier hs-type">okToFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1574"></span><span id="okToFloat"><span class="annot"><span class="annottext">okToFloat :: RnEnv2 -&gt; VarSet -&gt; Bool
</span><a href="GHC.Core.Rules.html#okToFloat"><span class="hs-identifier hs-var hs-var">okToFloat</span></a></span></span><span> </span><span id="local-6989586621682893983"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893983"><span class="hs-identifier hs-var">rn_env</span></a></span></span><span> </span><span id="local-6989586621682893984"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682893984"><span class="hs-identifier hs-var">bind_fvs</span></a></span></span><span>
</span><span id="line-1575"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Bool) -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#allVarSet"><span class="hs-identifier hs-var">allVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="#local-6989586621682893986"><span class="hs-identifier hs-var">not_captured</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682893984"><span class="hs-identifier hs-var">bind_fvs</span></a></span><span>
</span><span id="line-1576"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1577"></span><span>    </span><span id="local-6989586621682893986"><span class="annot"><span class="annottext">not_captured :: Var -&gt; Bool
</span><a href="#local-6989586621682893986"><span class="hs-identifier hs-var hs-var">not_captured</span></a></span></span><span> </span><span id="local-6989586621682893987"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893987"><span class="hs-identifier hs-var">fv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#inRnEnvR"><span class="hs-identifier hs-var">inRnEnvR</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893983"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893987"><span class="hs-identifier hs-var">fv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1578"></span><span>
</span><span id="line-1579"></span><span class="hs-comment">------------------------------------------</span><span>
</span><span id="line-1580"></span><span class="annot"><a href="GHC.Core.Rules.html#match_var"><span class="hs-identifier hs-type">match_var</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span>
</span><span id="line-1581"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1582"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>        </span><span class="hs-comment">-- Template</span><span>
</span><span id="line-1583"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>   </span><span class="hs-comment">-- Target</span><span>
</span><span id="line-1584"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1585"></span><span id="match_var"><span class="annot"><span class="annottext">match_var :: RuleMatchEnv -&gt; RuleSubst -&gt; Var -&gt; CoreExpr -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_var"><span class="hs-identifier hs-var hs-var">match_var</span></a></span></span><span> </span><span id="local-6989586621682893988"><span class="annot"><span class="annottext">renv :: RuleMatchEnv
</span><a href="#local-6989586621682893988"><span class="hs-identifier hs-var">renv</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RV"><span class="hs-identifier hs-type">RV</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rv_tmpls :: RuleMatchEnv -&gt; VarSet
</span><a href="GHC.Core.Rules.html#rv_tmpls"><span class="hs-identifier hs-var">rv_tmpls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893989"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682893989"><span class="hs-identifier hs-var">tmpls</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_lcl :: RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893990"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893990"><span class="hs-identifier hs-var">rn_env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_fltR :: RuleMatchEnv -&gt; Subst
</span><a href="GHC.Core.Rules.html#rv_fltR"><span class="hs-identifier hs-var">rv_fltR</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682893991"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893991"><span class="hs-identifier hs-var">flt_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1586"></span><span>          </span><span id="local-6989586621682893992"><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893992"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682893993"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893993"><span class="hs-identifier hs-var">v1</span></a></span></span><span> </span><span id="local-6989586621682893994"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893994"><span class="hs-identifier hs-var">e2</span></a></span></span><span>
</span><span id="line-1587"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893995"><span class="hs-identifier hs-var">v1'</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682893989"><span class="hs-identifier hs-var">tmpls</span></a></span><span>
</span><span id="line-1588"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RuleSubst -&gt; Var -&gt; CoreExpr -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_tmpl_var"><span class="hs-identifier hs-var">match_tmpl_var</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682893988"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893992"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893995"><span class="hs-identifier hs-var">v1'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893994"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-1589"></span><span>
</span><span id="line-1590"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-comment">-- v1' is not a template variable; check for an exact match with e2</span><span>
</span><span id="line-1591"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682893994"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Remember, envR of rn_env is disjoint from rv_fltR</span><span>
</span><span id="line-1592"></span><span>       </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893996"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893996"><span class="hs-identifier hs-var">v2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682893997"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893997"><span class="hs-identifier hs-var">v2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Maybe Var
</span><a href="GHC.Types.Var.Env.html#rnOccR_maybe"><span class="hs-identifier hs-var">rnOccR_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893990"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893996"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-1593"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- v2 was bound by a nested lambda or case</span><span>
</span><span id="line-1594"></span><span>                 </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893995"><span class="hs-identifier hs-var">v1'</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893997"><span class="hs-identifier hs-var">v2'</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RuleSubst -&gt; Maybe RuleSubst
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893992"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1595"></span><span>                               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1596"></span><span>
</span><span id="line-1597"></span><span>              </span><span class="hs-comment">-- v2 is not bound nestedly; it is free</span><span>
</span><span id="line-1598"></span><span>              </span><span class="hs-comment">-- in the whole expression being matched</span><span>
</span><span id="line-1599"></span><span>              </span><span class="hs-comment">-- So it will be in the InScopeSet for flt_env (#20200)</span><span>
</span><span id="line-1600"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682893999"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893999"><span class="hs-identifier hs-var">v2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Var -&gt; CoreExpr
Subst -&gt; Var -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682893991"><span class="hs-identifier hs-var">flt_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893996"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-1601"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893995"><span class="hs-identifier hs-var">v1'</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893999"><span class="hs-identifier hs-var">v2'</span></a></span><span>
</span><span id="line-1602"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RuleSubst -&gt; Maybe RuleSubst
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682893992"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1603"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1604"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1605"></span><span>
</span><span id="line-1606"></span><span>       </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1607"></span><span>
</span><span id="line-1608"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1609"></span><span>    </span><span id="local-6989586621682893995"><span class="annot"><span class="annottext">v1' :: Var
</span><a href="#local-6989586621682893995"><span class="hs-identifier hs-var hs-var">v1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; Var -&gt; Var
</span><a href="GHC.Types.Var.Env.html#rnOccL"><span class="hs-identifier hs-var">rnOccL</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682893990"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682893993"><span class="hs-identifier hs-var">v1</span></a></span><span>
</span><span id="line-1610"></span><span>        </span><span class="hs-comment">-- If the template is</span><span>
</span><span id="line-1611"></span><span>        </span><span class="hs-comment">--      forall x. f x (\x -&gt; x) = ...</span><span>
</span><span id="line-1612"></span><span>        </span><span class="hs-comment">-- Then the x inside the lambda isn't the</span><span>
</span><span id="line-1613"></span><span>        </span><span class="hs-comment">-- template x, so we must rename first!</span><span>
</span><span id="line-1614"></span><span>
</span><span id="line-1615"></span><span class="hs-comment">------------------------------------------</span><span>
</span><span id="line-1616"></span><span class="annot"><a href="GHC.Core.Rules.html#match_tmpl_var"><span class="hs-identifier hs-type">match_tmpl_var</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span>
</span><span id="line-1617"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1618"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>                </span><span class="hs-comment">-- Template</span><span>
</span><span id="line-1619"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>           </span><span class="hs-comment">-- Target</span><span>
</span><span id="line-1620"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1621"></span><span>
</span><span id="line-1622"></span><span id="match_tmpl_var"><span class="annot"><span class="annottext">match_tmpl_var :: RuleMatchEnv -&gt; RuleSubst -&gt; Var -&gt; CoreExpr -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_tmpl_var"><span class="hs-identifier hs-var hs-var">match_tmpl_var</span></a></span></span><span> </span><span id="local-6989586621682894001"><span class="annot"><span class="annottext">renv :: RuleMatchEnv
</span><a href="#local-6989586621682894001"><span class="hs-identifier hs-var">renv</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RV"><span class="hs-identifier hs-type">RV</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rv_lcl :: RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894002"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682894002"><span class="hs-identifier hs-var">rn_env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_fltR :: RuleMatchEnv -&gt; Subst
</span><a href="GHC.Core.Rules.html#rv_fltR"><span class="hs-identifier hs-var">rv_fltR</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894003"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682894003"><span class="hs-identifier hs-var">flt_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1623"></span><span>               </span><span id="local-6989586621682894004"><span class="annot"><span class="annottext">subst :: RuleSubst
</span><a href="#local-6989586621682894004"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RS"><span class="hs-identifier hs-type">RS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rs_id_subst :: RuleSubst -&gt; IdSubstEnv
</span><a href="GHC.Core.Rules.html#rs_id_subst"><span class="hs-identifier hs-var">rs_id_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894005"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682894005"><span class="hs-identifier hs-var">id_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rs_bndrs :: RuleSubst -&gt; [Var]
</span><a href="GHC.Core.Rules.html#rs_bndrs"><span class="hs-identifier hs-var">rs_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894006"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682894006"><span class="hs-identifier hs-var">let_bndrs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1624"></span><span>               </span><span id="local-6989586621682894007"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894007"><span class="hs-identifier hs-var">v1'</span></a></span></span><span> </span><span id="local-6989586621682894008"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894008"><span class="hs-identifier hs-var">e2</span></a></span></span><span>
</span><span id="line-1625"></span><span>  </span><span class="hs-comment">-- anyInRnEnvR is lazy in the 2nd arg which allows us to avoid computing fvs</span><span>
</span><span id="line-1626"></span><span>  </span><span class="hs-comment">-- if the right side of the env is empty.</span><span>
</span><span id="line-1627"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#anyInRnEnvR"><span class="hs-identifier hs-var">anyInRnEnvR</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682894002"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894008"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1628"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-comment">-- Skolem-escape failure</span><span>
</span><span id="line-1629"></span><span>                </span><span class="hs-comment">-- e.g. match forall a. (\x -&gt; a) against (\y -&gt; y)</span><span>
</span><span id="line-1630"></span><span>
</span><span id="line-1631"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682894010"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894010"><span class="hs-identifier hs-var">e1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Var -&gt; Maybe CoreExpr
forall a. VarEnv a -&gt; Var -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682894005"><span class="hs-identifier hs-var">id_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894007"><span class="hs-identifier hs-var">v1'</span></a></span><span>
</span><span id="line-1632"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Map.Expr.html#eqCoreExpr"><span class="hs-identifier hs-var">eqCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894010"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894011"><span class="hs-identifier hs-var">e2'</span></a></span><span>
</span><span id="line-1633"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RuleSubst -&gt; Maybe RuleSubst
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682894004"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1634"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe RuleSubst
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1635"></span><span>
</span><span id="line-1636"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-comment">-- See Note [Matching variable types]</span><span>
</span><span id="line-1637"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682894012"><span class="annot"><a href="#local-6989586621682894012"><span class="hs-identifier hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv -&gt; RuleSubst -&gt; Kind -&gt; Kind -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_ty"><span class="hs-identifier hs-var">match_ty</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682894001"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682894004"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894007"><span class="hs-identifier hs-var">v1'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Kind
CoreExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894008"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1638"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682894012"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_id_subst"><span class="hs-identifier hs-var">rs_id_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682894014"><span class="hs-identifier hs-type">id_subst'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1639"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1640"></span><span>    </span><span class="hs-comment">-- e2' is the result of applying flt_env to e2</span><span>
</span><span id="line-1641"></span><span>    </span><span id="local-6989586621682894011"><span class="annot"><span class="annottext">e2' :: CoreExpr
</span><a href="#local-6989586621682894011"><span class="hs-identifier hs-var hs-var">e2'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682894006"><span class="hs-identifier hs-var">let_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894008"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-1642"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682894003"><span class="hs-identifier hs-var">flt_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894008"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-1643"></span><span>
</span><span id="line-1644"></span><span>    </span><span id="local-6989586621682894014"><span class="annot"><span class="annottext">id_subst' :: IdSubstEnv
</span><a href="#local-6989586621682894014"><span class="hs-identifier hs-var hs-var">id_subst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Var -&gt; CoreExpr -&gt; IdSubstEnv
forall a. VarEnv a -&gt; Var -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleSubst -&gt; IdSubstEnv
</span><a href="GHC.Core.Rules.html#rs_id_subst"><span class="hs-identifier hs-var">rs_id_subst</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="#local-6989586621682894004"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894007"><span class="hs-identifier hs-var">v1'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894011"><span class="hs-identifier hs-var">e2'</span></a></span><span>
</span><span id="line-1645"></span><span>         </span><span class="hs-comment">-- No further renaming to do on e2',</span><span>
</span><span id="line-1646"></span><span>         </span><span class="hs-comment">-- because no free var of e2' is in the rnEnvR of the envt</span><span>
</span><span id="line-1647"></span><span>
</span><span id="line-1648"></span><span class="hs-comment">------------------------------------------</span><span>
</span><span id="line-1649"></span><span>
</span><span id="line-1650"></span><span class="annot"><a href="GHC.Core.Rules.html#match_ty"><span class="hs-identifier hs-type">match_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a></span><span>
</span><span id="line-1651"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1652"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>                </span><span class="hs-comment">-- Template</span><span>
</span><span id="line-1653"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>                </span><span class="hs-comment">-- Target</span><span>
</span><span id="line-1654"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a></span><span>
</span><span id="line-1655"></span><span class="hs-comment">-- Matching Core types: use the matcher in GHC.Tc.Utils.TcType.</span><span>
</span><span id="line-1656"></span><span class="hs-comment">-- Notice that we treat newtypes as opaque.  For example, suppose</span><span>
</span><span id="line-1657"></span><span class="hs-comment">-- we have a specialised version of a function at a newtype, say</span><span>
</span><span id="line-1658"></span><span class="hs-comment">--      newtype T = MkT Int</span><span>
</span><span id="line-1659"></span><span class="hs-comment">-- We only want to replace (f T) with f', not (f Int).</span><span>
</span><span id="line-1660"></span><span>
</span><span id="line-1661"></span><span id="match_ty"><span class="annot"><span class="annottext">match_ty :: RuleMatchEnv -&gt; RuleSubst -&gt; Kind -&gt; Kind -&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match_ty"><span class="hs-identifier hs-var hs-var">match_ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RV"><span class="hs-identifier hs-type">RV</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rv_tmpls :: RuleMatchEnv -&gt; VarSet
</span><a href="GHC.Core.Rules.html#rv_tmpls"><span class="hs-identifier hs-var">rv_tmpls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894016"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682894016"><span class="hs-identifier hs-var">tmpls</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_lcl :: RuleMatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894017"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682894017"><span class="hs-identifier hs-var">rn_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1662"></span><span>         </span><span id="local-6989586621682894018"><span class="annot"><span class="annottext">subst :: RuleSubst
</span><a href="#local-6989586621682894018"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RS"><span class="hs-identifier hs-type">RS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rs_tv_subst :: RuleSubst -&gt; TvSubstEnv
</span><a href="GHC.Core.Rules.html#rs_tv_subst"><span class="hs-identifier hs-var">rs_tv_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894019"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682894019"><span class="hs-identifier hs-var">tv_subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1663"></span><span>         </span><span id="local-6989586621682894020"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682894020"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682894021"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682894021"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-1664"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682894022"><span class="annot"><a href="#local-6989586621682894022"><span class="hs-identifier hs-var">tv_subst'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; RnEnv2 -&gt; TvSubstEnv -&gt; Kind -&gt; Kind -&gt; Maybe TvSubstEnv
</span><a href="GHC.Core.Unify.html#ruleMatchTyKiX"><span class="hs-identifier hs-var">Unify.ruleMatchTyKiX</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682894016"><span class="hs-identifier hs-var">tmpls</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621682894017"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682894019"><span class="hs-identifier hs-var">tv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682894020"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621682894021"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1665"></span><span>               </span><span class="hs-comment">-- NB: ruleMatchTyKiX applis tv_subst to ty1 only</span><span>
</span><span id="line-1666"></span><span>               </span><span class="hs-comment">--     and of course only binds 'tmpls'</span><span>
</span><span id="line-1667"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682894018"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rs_tv_subst"><span class="hs-identifier hs-var">rs_tv_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682894022"><span class="hs-identifier hs-type">tv_subst'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1668"></span><span>
</span><span id="line-1669"></span><span class="hs-comment">{- Note [Matching variable types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When matching x ~ e, where 'x' is a template variable, we must check that
x's type matches e's type, to establish (TypeInv).  For example
  forall (c::Char-&gt;Int) (x::Char).
     f (c x) = &quot;RULE FIRED&quot;
We must not match on, say (f (pred (3::Int))).

It's actually quite difficult to come up with an example that shows
you need type matching, esp since matching is left-to-right, so type
args get matched first.  But it's possible (e.g. simplrun008) and this
is the Right Thing to do.

An alternative would be to make (TypeInf) into a /pre-condition/.  It
is threatened only by the App rule.  So when matching an application
(e1 e2) ~ (d1 d2) would be to collect args of the application chain,
match the types of the head, then match arg-by-arg.

However that alternative seems a bit more complicated.  And by
matching types at variables we do one match_ty for each template
variable, rather than one for each application chain.  Usually there are
fewer template variables, although for simple rules it could be the other
way around.

Note [Expanding variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is another Very Important rule: if the term being matched is a
variable, we expand it so long as its unfolding is &quot;expandable&quot;. (Its
occurrence information is not necessarily up to date, so we don't use
it.)  By &quot;expandable&quot; we mean a WHNF or a &quot;constructor-like&quot; application.
This is the key reason for &quot;constructor-like&quot; Ids.  If we have
     {-# NOINLINE [1] CONLIKE g #-}
     {-# RULE f (g x) = h x #-}
then in the term
   let v = g 3 in ....(f v)....
we want to make the rule fire, to replace (f v) with (h 3).

Note [Do not expand locally-bound variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Do *not* expand locally-bound variables, else there's a worry that the
unfolding might mention variables that are themselves renamed.
Example
          case x of y { (p,q) -&gt; ...y... }
Don't expand 'y' to (p,q) because p,q might themselves have been
renamed.  Essentially we only expand unfoldings that are &quot;outside&quot;
the entire match.

Hence, (a) the guard (not (isLocallyBoundR v2))
       (b) when we expand we nuke the renaming envt (nukeRnEnvR).

Note [Tick annotations in RULE matching]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to unconditionally look through ticks in both template and
expression being matched. This is actually illegal for counting or
cost-centre-scoped ticks, because we have no place to put them without
changing entry counts and/or costs. So now we just fail the match in
these cases.

On the other hand, where we are allowed to insert new cost into the
tick scope, we can float them upwards to the rule application site.

Moreover, we may encounter ticks in the template of a rule. There are a few
ways in which these may be introduced (e.g. #18162, #17619). Such ticks are
ignored by the matcher. See Note [Simplifying rules] in
GHC.Core.Opt.Simplify.Utils for details.

cf Note [Tick annotations in call patterns] in GHC.Core.Opt.SpecConstr


Note [Matching lets]
~~~~~~~~~~~~~~~~~~~~
Matching a let-expression.  Consider
        RULE forall x.  f (g x) = &lt;rhs&gt;
and target expression
        f (let { w=R } in g E))
Then we'd like the rule to match, to generate
        let { w=R } in (\x. &lt;rhs&gt;) E
In effect, we want to float the let-binding outward, to enable
the match to happen.  This is the WHOLE REASON for accumulating
bindings in the RuleSubst

We can only do this if the free variables of R are not bound by the
part of the target expression outside the let binding; e.g.
        f (\v. let w = v+1 in g E)
Here we obviously cannot float the let-binding for w.  Hence the
use of okToFloat.

There are a couple of tricky points:
  (a) What if floating the binding captures a variable that is
      free in the entire expression?
        f (let v = x+1 in v) v
      --&gt; NOT!
        let v = x+1 in f (x+1) v

  (b) What if the let shadows a local binding?
        f (\v -&gt; (v, let v = x+1 in (v,v))
      --&gt; NOT!
        let v = x+1 in f (\v -&gt; (v, (v,v)))

  (c) What if two non-nested let bindings bind the same variable?
        f (let v = e1 in b1) (let v = e2 in b2)
      --&gt; NOT!
        let v = e1 in let v = e2 in (f b2 b2)
      See testsuite test `T4814`.

Our cunning plan is this:
  (1) Along with the growing substitution for template variables
      we maintain a growing set of floated let-bindings (rs_binds)
      plus the set of variables thus bound (rs_bndrs).

  (2) The RnEnv2 in the MatchEnv binds only the local binders
      in the term (lambdas, case), not the floated let-bndrs.

  (3) When we encounter a `let` in the term to be matched, in the Let
      case of `match`, we use `okToFloat` to check that it does not mention any
      locally bound (lambda, case) variables.  If so we fail.

  (4) In the Let case of `match`, we use GHC.Core.Subst.substBind to
      freshen the binding (which, remember (3), mentions no locally
      bound variables), in a lexically-scoped way (via rv_fltR in
      MatchEnv).

      The subtle point is that we want an in-scope set for this
      substitution that includes /two/ sets:
      * The in-scope variables at this point, so that we avoid using
        those local names for the floated binding; points (a) and (b) above.
      * All &quot;earlier&quot; floated bindings, so that we avoid using the
        same name for two different floated bindings; point (c) above.

      Because we have to compute the in-scope set here, the in-scope set
      stored in `rv_fltR` is always ignored; we leave it only because it's
      convenient to have `rv_fltR :: Subst` (with an always-ignored `InScopeSet`)
      rather than storing three separate substitutions.

  (5) We apply that freshening substitution, in a lexically-scoped
      way to the term, although lazily; this is the rv_fltR field.

See #4814, which is an issue resulting from getting this wrong.

Note [Matching cases]
~~~~~~~~~~~~~~~~~~~~~
{- NOTE: This idea is currently disabled.  It really only works if
         the primops involved are OkForSpeculation, and, since
         they have side effects readIntOfAddr and touch are not.
         Maybe we'll get back to this later .  -}

Consider
   f (case readIntOffAddr# p# i# realWorld# of { (# s#, n# #) -&gt;
      case touch# fp s# of { _ -&gt;
      I# n# } } )
This happened in a tight loop generated by stream fusion that
Roman encountered.  We'd like to treat this just like the let
case, because the primops concerned are ok-for-speculation.
That is, we'd like to behave as if it had been
   case readIntOffAddr# p# i# realWorld# of { (# s#, n# #) -&gt;
   case touch# fp s# of { _ -&gt;
   f (I# n# } } )

Note [Lookup in-scope]
~~~~~~~~~~~~~~~~~~~~~~
Consider this example
        foo :: Int -&gt; Maybe Int -&gt; Int
        foo 0 (Just n) = n
        foo m (Just n) = foo (m-n) (Just n)

SpecConstr sees this fragment:

        case w_smT of wild_Xf [Just A] {
          Data.Maybe.Nothing -&gt; lvl_smf;
          Data.Maybe.Just n_acT [Just S(L)] -&gt;
            case n_acT of wild1_ams [Just A] { GHC.Base.I# y_amr [Just L] -&gt;
              $wfoo_smW (GHC.Prim.-# ds_Xmb y_amr) wild_Xf
            }};

and correctly generates the rule

        RULES: &quot;SC:$wfoo1&quot; [0] __forall {y_amr [Just L] :: GHC.Prim.Int#
                                          sc_snn :: GHC.Prim.Int#}
          $wfoo_smW sc_snn (Data.Maybe.Just @ GHC.Base.Int (GHC.Base.I# y_amr))
          = $s$wfoo_sno y_amr sc_snn ;]

BUT we must ensure that this rule matches in the original function!
Note that the call to $wfoo is
            $wfoo_smW (GHC.Prim.-# ds_Xmb y_amr) wild_Xf

During matching we expand wild_Xf to (Just n_acT).  But then we must also
expand n_acT to (I# y_amr).  And we can only do that if we look up n_acT
in the in-scope set, because in wild_Xf's unfolding it won't have an unfolding
at all.

That is why the 'lookupRnInScope' call in the (Var v2) case of 'match'
is so important.


************************************************************************
*                                                                      *
                   Rule-check the program
*                                                                      *
************************************************************************

   We want to know what sites have rules that could have fired but didn't.
   This pass runs over the tree (without changing it) and reports such.
-}</span><span>
</span><span id="line-1872"></span><span>
</span><span id="line-1873"></span><span class="hs-comment">-- | Report partial matches for rules beginning with the specified</span><span>
</span><span id="line-1874"></span><span class="hs-comment">-- string for the purposes of error reporting</span><span>
</span><span id="line-1875"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheckProgram"><span class="hs-identifier hs-type">ruleCheckProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.Config.html#RuleOpts"><span class="hs-identifier hs-type">RuleOpts</span></a></span><span>                    </span><span class="annot"><span class="hs-comment">-- ^ Rule options</span></span><span>
</span><span id="line-1876"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#CompilerPhase"><span class="hs-identifier hs-type">CompilerPhase</span></a></span><span>               </span><span class="annot"><span class="hs-comment">-- ^ Rule activation test</span></span><span>
</span><span id="line-1877"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>                      </span><span class="annot"><span class="hs-comment">-- ^ Rule pattern</span></span><span>
</span><span id="line-1878"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>          </span><span class="annot"><span class="hs-comment">-- ^ Rules for an Id</span></span><span>
</span><span id="line-1879"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>                 </span><span class="annot"><span class="hs-comment">-- ^ Bindings to check in</span></span><span>
</span><span id="line-1880"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>                        </span><span class="annot"><span class="hs-comment">-- ^ Resulting check message</span></span><span>
</span><span id="line-1881"></span><span id="ruleCheckProgram"><span class="annot"><span class="annottext">ruleCheckProgram :: RuleOpts
-&gt; CompilerPhase
-&gt; String
-&gt; (Var -&gt; [CoreRule])
-&gt; [CoreBind]
-&gt; SDoc
</span><a href="GHC.Core.Rules.html#ruleCheckProgram"><span class="hs-identifier hs-var hs-var">ruleCheckProgram</span></a></span></span><span> </span><span id="local-6989586621682894024"><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621682894024"><span class="hs-identifier hs-var">ropts</span></a></span></span><span> </span><span id="local-6989586621682894025"><span class="annot"><span class="annottext">CompilerPhase
</span><a href="#local-6989586621682894025"><span class="hs-identifier hs-var">phase</span></a></span></span><span> </span><span id="local-6989586621682894026"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682894026"><span class="hs-identifier hs-var">rule_pat</span></a></span></span><span> </span><span id="local-6989586621682894027"><span class="annot"><span class="annottext">Var -&gt; [CoreRule]
</span><a href="#local-6989586621682894027"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span id="local-6989586621682894028"><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621682894028"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-1882"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bag SDoc -&gt; Bool
forall a. Bag a -&gt; Bool
</span><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Bag SDoc
</span><a href="#local-6989586621682894030"><span class="hs-identifier hs-var">results</span></a></span><span>
</span><span id="line-1883"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rule check results: no rule application sites&quot;</span></span><span>
</span><span id="line-1884"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1885"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rule check results:&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-1886"></span><span>          </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682894031"><span class="hs-identifier hs-var">line</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1887"></span><span>          </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682894032"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682894031"><span class="hs-identifier hs-var">line</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682894032"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682894032"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bag SDoc -&gt; [SDoc]
forall a. Bag a -&gt; [a]
</span><a href="GHC.Data.Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a></span><span> </span><span class="annot"><span class="annottext">Bag SDoc
</span><a href="#local-6989586621682894030"><span class="hs-identifier hs-var">results</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1888"></span><span>         </span><span class="hs-special">]</span><span>
</span><span id="line-1889"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1890"></span><span>    </span><span id="local-6989586621682894031"><span class="annot"><span class="annottext">line :: SDoc
</span><a href="#local-6989586621682894031"><span class="hs-identifier hs-var hs-var">line</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity -&gt; Char -&gt; String
forall a. Arity -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'-'</span></span><span class="hs-special">)</span><span>
</span><span id="line-1891"></span><span>    </span><span id="local-6989586621682894037"><span class="annot"><span class="annottext">env :: RuleCheckEnv
</span><a href="#local-6989586621682894037"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rc_is_active :: Activation -&gt; Bool
</span><a href="GHC.Core.Rules.html#rc_is_active"><span class="hs-identifier hs-var">rc_is_active</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isActive"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="#local-6989586621682894025"><span class="hs-identifier hs-var">phase</span></a></span><span>
</span><span id="line-1892"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rc_id_unf :: IdUnfoldingFun
</span><a href="GHC.Core.Rules.html#rc_id_unf"><span class="hs-identifier hs-var">rc_id_unf</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span>     </span><span class="hs-comment">-- Not quite right</span><span>
</span><span id="line-1893"></span><span>                                                        </span><span class="hs-comment">-- Should use activeUnfolding</span><span>
</span><span id="line-1894"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rc_pattern :: String
</span><a href="GHC.Core.Rules.html#rc_pattern"><span class="hs-identifier hs-var">rc_pattern</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682894026"><span class="hs-identifier hs-var">rule_pat</span></a></span><span>
</span><span id="line-1895"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rc_rules :: Var -&gt; [CoreRule]
</span><a href="GHC.Core.Rules.html#rc_rules"><span class="hs-identifier hs-var">rc_rules</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; [CoreRule]
</span><a href="#local-6989586621682894027"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-1896"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rc_ropts :: RuleOpts
</span><a href="GHC.Core.Rules.html#rc_ropts"><span class="hs-identifier hs-var">rc_ropts</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621682894024"><span class="hs-identifier hs-var">ropts</span></a></span><span>
</span><span id="line-1897"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rc_in_scope :: InScopeSet
</span><a href="GHC.Core.Rules.html#rc_in_scope"><span class="hs-identifier hs-var">rc_in_scope</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="GHC.Types.Var.Env.html#emptyInScopeSet"><span class="hs-identifier hs-var">emptyInScopeSet</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1898"></span><span>
</span><span id="line-1899"></span><span>    </span><span id="local-6989586621682894030"><span class="annot"><span class="annottext">results :: Bag SDoc
</span><a href="#local-6989586621682894030"><span class="hs-identifier hs-var hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; [CoreBind] -&gt; Bag SDoc
</span><a href="#local-6989586621682894048"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894037"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621682894028"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-1900"></span><span>
</span><span id="line-1901"></span><span>    </span><span id="local-6989586621682894048"><span class="annot"><span class="annottext">go :: RuleCheckEnv -&gt; [CoreBind] -&gt; Bag SDoc
</span><a href="#local-6989586621682894048"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag SDoc
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-1902"></span><span>    </span><span class="annot"><a href="#local-6989586621682894048"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682894050"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894050"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682894051"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682894051"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682894052"><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621682894052"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682894053"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894053"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682894054"><span class="annot"><span class="annottext">Bag SDoc
</span><a href="#local-6989586621682894054"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreBind -&gt; (RuleCheckEnv, Bag SDoc)
</span><a href="GHC.Core.Rules.html#ruleCheckBind"><span class="hs-identifier hs-var">ruleCheckBind</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894050"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682894051"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-1903"></span><span>                          </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Bag SDoc
</span><a href="#local-6989586621682894054"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">Bag SDoc -&gt; Bag SDoc -&gt; Bag SDoc
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; [CoreBind] -&gt; Bag SDoc
</span><a href="#local-6989586621682894048"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894053"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreBind]
</span><a href="#local-6989586621682894052"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-1904"></span><span>
</span><span id="line-1905"></span><span class="hs-keyword">data</span><span> </span><span id="RuleCheckEnv"><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-var">RuleCheckEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RuleCheckEnv"><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-var">RuleCheckEnv</span></a></span></span><span>
</span><span id="line-1906"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="rc_is_active"><span class="annot"><span class="annottext">RuleCheckEnv -&gt; Activation -&gt; Bool
</span><a href="GHC.Core.Rules.html#rc_is_active"><span class="hs-identifier hs-var hs-var">rc_is_active</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Activation"><span class="hs-identifier hs-type">Activation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1907"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="rc_id_unf"><span class="annot"><span class="annottext">RuleCheckEnv -&gt; IdUnfoldingFun
</span><a href="GHC.Core.Rules.html#rc_id_unf"><span class="hs-identifier hs-var hs-var">rc_id_unf</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#IdUnfoldingFun"><span class="hs-identifier hs-type">IdUnfoldingFun</span></a></span><span>
</span><span id="line-1908"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="rc_pattern"><span class="annot"><span class="annottext">RuleCheckEnv -&gt; String
</span><a href="GHC.Core.Rules.html#rc_pattern"><span class="hs-identifier hs-var hs-var">rc_pattern</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-1909"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="rc_rules"><span class="annot"><span class="annottext">RuleCheckEnv -&gt; Var -&gt; [CoreRule]
</span><a href="GHC.Core.Rules.html#rc_rules"><span class="hs-identifier hs-var hs-var">rc_rules</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1910"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="rc_ropts"><span class="annot"><span class="annottext">RuleCheckEnv -&gt; RuleOpts
</span><a href="GHC.Core.Rules.html#rc_ropts"><span class="hs-identifier hs-var hs-var">rc_ropts</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.Config.html#RuleOpts"><span class="hs-identifier hs-type">RuleOpts</span></a></span><span>
</span><span id="line-1911"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="rc_in_scope"><span class="annot"><span class="annottext">RuleCheckEnv -&gt; InScopeSet
</span><a href="GHC.Core.Rules.html#rc_in_scope"><span class="hs-identifier hs-var hs-var">rc_in_scope</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1912"></span><span>
</span><span id="line-1913"></span><span class="annot"><a href="GHC.Core.Rules.html#extendInScopeRC"><span class="hs-identifier hs-type">extendInScopeRC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span>
</span><span id="line-1914"></span><span id="extendInScopeRC"><span class="annot"><span class="annottext">extendInScopeRC :: RuleCheckEnv -&gt; Var -&gt; RuleCheckEnv
</span><a href="GHC.Core.Rules.html#extendInScopeRC"><span class="hs-identifier hs-var hs-var">extendInScopeRC</span></a></span></span><span> </span><span id="local-6989586621682894058"><span class="annot"><span class="annottext">env :: RuleCheckEnv
</span><a href="#local-6989586621682894058"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rc_in_scope :: RuleCheckEnv -&gt; InScopeSet
</span><a href="GHC.Core.Rules.html#rc_in_scope"><span class="hs-identifier hs-var">rc_in_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894059"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682894059"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682894060"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894060"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-1915"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894058"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rc_in_scope"><span class="hs-identifier hs-var">rc_in_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682894059"><span class="hs-identifier hs-type">in_scope</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-type">`extendInScopeSet`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682894060"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1916"></span><span>
</span><span id="line-1917"></span><span class="annot"><a href="GHC.Core.Rules.html#extendInScopeListRC"><span class="hs-identifier hs-type">extendInScopeListRC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span>
</span><span id="line-1918"></span><span id="extendInScopeListRC"><span class="annot"><span class="annottext">extendInScopeListRC :: RuleCheckEnv -&gt; [Var] -&gt; RuleCheckEnv
</span><a href="GHC.Core.Rules.html#extendInScopeListRC"><span class="hs-identifier hs-var hs-var">extendInScopeListRC</span></a></span></span><span> </span><span id="local-6989586621682894063"><span class="annot"><span class="annottext">env :: RuleCheckEnv
</span><a href="#local-6989586621682894063"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rc_in_scope :: RuleCheckEnv -&gt; InScopeSet
</span><a href="GHC.Core.Rules.html#rc_in_scope"><span class="hs-identifier hs-var">rc_in_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894064"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682894064"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682894065"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682894065"><span class="hs-identifier hs-var">vs</span></a></span></span><span>
</span><span id="line-1919"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894063"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#rc_in_scope"><span class="hs-identifier hs-var">rc_in_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682894064"><span class="hs-identifier hs-type">in_scope</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendInScopeSetList"><span class="hs-operator hs-type">`extendInScopeSetList`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682894065"><span class="hs-identifier hs-type">vs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1920"></span><span>
</span><span id="line-1921"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheckBind"><span class="hs-identifier hs-type">ruleCheckBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1922"></span><span>   </span><span class="hs-comment">-- The Bag returned has one SDoc for each call site found</span><span>
</span><span id="line-1923"></span><span id="ruleCheckBind"><span class="annot"><span class="annottext">ruleCheckBind :: RuleCheckEnv -&gt; CoreBind -&gt; (RuleCheckEnv, Bag SDoc)
</span><a href="GHC.Core.Rules.html#ruleCheckBind"><span class="hs-identifier hs-var hs-var">ruleCheckBind</span></a></span></span><span> </span><span id="local-6989586621682894066"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894066"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682894068"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894068"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682894069"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894069"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894066"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; Var -&gt; RuleCheckEnv
</span><a href="GHC.Core.Rules.html#extendInScopeRC"><span class="hs-operator hs-var">`extendInScopeRC`</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894068"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894066"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894069"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1924"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheckBind"><span class="hs-identifier hs-var">ruleCheckBind</span></a></span><span> </span><span id="local-6989586621682894071"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894071"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682894073"><span class="annot"><span class="annottext">[(Var, CoreExpr)]
</span><a href="#local-6989586621682894073"><span class="hs-identifier hs-var">prs</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894074"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Bag SDoc] -&gt; Bag SDoc
forall a. [Bag a] -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionManyBags"><span class="hs-identifier hs-var">unionManyBags</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreExpr -&gt; Bag SDoc) -&gt; [CoreExpr] -&gt; [Bag SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894074"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894076"><span class="hs-identifier hs-var">rhss</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1925"></span><span>                               </span><span class="hs-keyword">where</span><span>
</span><span id="line-1926"></span><span>                                 </span><span class="hs-special">(</span><span id="local-6989586621682894077"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682894077"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682894076"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894076"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; ([Var], [CoreExpr])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)]
</span><a href="#local-6989586621682894073"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-1927"></span><span>                                 </span><span id="local-6989586621682894074"><span class="annot"><span class="annottext">env' :: RuleCheckEnv
</span><a href="#local-6989586621682894074"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894071"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; [Var] -&gt; RuleCheckEnv
</span><a href="GHC.Core.Rules.html#extendInScopeListRC"><span class="hs-operator hs-var">`extendInScopeListRC`</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682894077"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-1928"></span><span>
</span><span id="line-1929"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-type">ruleCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-1930"></span><span id="ruleCheck"><span class="annot"><span class="annottext">ruleCheck :: RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var hs-var">ruleCheck</span></a></span></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag SDoc
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-1931"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag SDoc
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-1932"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag SDoc
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-1933"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag SDoc
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-1934"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span id="local-6989586621682894079"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894079"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682894080"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894080"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682894081"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894081"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; [CoreExpr] -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheckApp"><span class="hs-identifier hs-var">ruleCheckApp</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894079"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894080"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894081"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1935"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span id="local-6989586621682894083"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894083"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682894084"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894084"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894083"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894084"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1936"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span id="local-6989586621682894085"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894085"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682894086"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894086"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894085"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894086"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1937"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span id="local-6989586621682894087"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894087"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682894088"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682894088"><span class="hs-identifier hs-var">bd</span></a></span></span><span> </span><span id="local-6989586621682894089"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894089"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682894090"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894090"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682894091"><span class="annot"><span class="annottext">Bag SDoc
</span><a href="#local-6989586621682894091"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreBind -&gt; (RuleCheckEnv, Bag SDoc)
</span><a href="GHC.Core.Rules.html#ruleCheckBind"><span class="hs-identifier hs-var">ruleCheckBind</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894087"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682894088"><span class="hs-identifier hs-var">bd</span></a></span><span>
</span><span id="line-1938"></span><span>                                </span><span class="hs-keyword">in</span><span>  </span><span class="annot"><span class="annottext">Bag SDoc
</span><a href="#local-6989586621682894091"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">Bag SDoc -&gt; Bag SDoc -&gt; Bag SDoc
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894090"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894089"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1939"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span id="local-6989586621682894092"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894092"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682894093"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894093"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682894094"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894094"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894092"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; Var -&gt; RuleCheckEnv
</span><a href="GHC.Core.Rules.html#extendInScopeRC"><span class="hs-operator hs-var">`extendInScopeRC`</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894093"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894094"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1940"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span id="local-6989586621682894095"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894095"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682894096"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894096"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682894097"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894097"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">Kind
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682894098"><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621682894098"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894095"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894096"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Bag SDoc -&gt; Bag SDoc -&gt; Bag SDoc
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span>
</span><span id="line-1941"></span><span>                                </span><span class="annot"><span class="annottext">[Bag SDoc] -&gt; Bag SDoc
forall a. [Bag a] -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionManyBags"><span class="hs-identifier hs-var">unionManyBags</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894095"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; [Var] -&gt; RuleCheckEnv
</span><a href="GHC.Core.Rules.html#extendInScopeListRC"><span class="hs-operator hs-var">`extendInScopeListRC`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894097"><span class="hs-identifier hs-var">b</span></a></span><span class="annot"><span class="annottext">Var -&gt; [Var] -&gt; [Var]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682894099"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894100"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1942"></span><span>                                              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682894099"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682894099"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682894100"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894100"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621682894098"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1943"></span><span>
</span><span id="line-1944"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheckApp"><span class="hs-identifier hs-type">ruleCheckApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Expr"><span class="hs-identifier hs-type">Expr</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Arg"><span class="hs-identifier hs-type">Arg</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-1945"></span><span id="ruleCheckApp"><span class="annot"><span class="annottext">ruleCheckApp :: RuleCheckEnv -&gt; CoreExpr -&gt; [CoreExpr] -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheckApp"><span class="hs-identifier hs-var hs-var">ruleCheckApp</span></a></span></span><span> </span><span id="local-6989586621682894102"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894102"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682894103"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894103"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682894104"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894104"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682894105"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894105"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894102"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894104"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Bag SDoc -&gt; Bag SDoc -&gt; Bag SDoc
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; [CoreExpr] -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheckApp"><span class="hs-identifier hs-var">ruleCheckApp</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894102"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894103"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894104"><span class="hs-identifier hs-var">a</span></a></span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894105"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1946"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheckApp"><span class="hs-identifier hs-var">ruleCheckApp</span></a></span><span> </span><span id="local-6989586621682894106"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894106"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682894107"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894107"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682894108"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894108"><span class="hs-keyword hs-var">as</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; Var -&gt; [CoreExpr] -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheckFun"><span class="hs-identifier hs-var">ruleCheckFun</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894106"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894107"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894108"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-1947"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheckApp"><span class="hs-identifier hs-var">ruleCheckApp</span></a></span><span> </span><span id="local-6989586621682894110"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894110"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682894111"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894111"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; CoreExpr -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894110"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894111"><span class="hs-identifier hs-var">other</span></a></span><span>
</span><span id="line-1948"></span><span>
</span><span id="line-1949"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleCheckFun"><span class="hs-identifier hs-type">ruleCheckFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-1950"></span><span class="hs-comment">-- Produce a report for all rules matching the predicate</span><span>
</span><span id="line-1951"></span><span class="hs-comment">-- saying why it doesn't match the specified application</span><span>
</span><span id="line-1952"></span><span>
</span><span id="line-1953"></span><span id="ruleCheckFun"><span class="annot"><span class="annottext">ruleCheckFun :: RuleCheckEnv -&gt; Var -&gt; [CoreExpr] -&gt; Bag SDoc
</span><a href="GHC.Core.Rules.html#ruleCheckFun"><span class="hs-identifier hs-var hs-var">ruleCheckFun</span></a></span></span><span> </span><span id="local-6989586621682894112"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894112"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682894113"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894113"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682894114"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894114"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-1954"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682894115"><span class="hs-identifier hs-var">name_match_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag SDoc
forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-1955"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Bag SDoc
forall a. a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unitBag"><span class="hs-identifier hs-var">unitBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; Var -&gt; [CoreExpr] -&gt; [CoreRule] -&gt; SDoc
</span><a href="GHC.Core.Rules.html#ruleAppCheck_help"><span class="hs-identifier hs-var">ruleAppCheck_help</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894112"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894113"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894114"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682894115"><span class="hs-identifier hs-var">name_match_rules</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1956"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1957"></span><span>    </span><span id="local-6989586621682894115"><span class="annot"><span class="annottext">name_match_rules :: [CoreRule]
</span><a href="#local-6989586621682894115"><span class="hs-identifier hs-var hs-var">name_match_rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreRule -&gt; Bool) -&gt; [CoreRule] -&gt; [CoreRule]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; Bool
</span><a href="#local-6989586621682894118"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; Var -&gt; [CoreRule]
</span><a href="GHC.Core.Rules.html#rc_rules"><span class="hs-identifier hs-var">rc_rules</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894112"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894113"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1958"></span><span>    </span><span id="local-6989586621682894118"><span class="annot"><span class="annottext">match :: CoreRule -&gt; Bool
</span><a href="#local-6989586621682894118"><span class="hs-identifier hs-var hs-var">match</span></a></span></span><span> </span><span id="local-6989586621682894119"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682894119"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; String
</span><a href="GHC.Core.Rules.html#rc_pattern"><span class="hs-identifier hs-var">rc_pattern</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894112"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Bool
</span><span class="hs-operator hs-var">`isPrefixOf`</span></span><span> </span><span class="annot"><span class="annottext">RuleName -&gt; String
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; RuleName
</span><a href="GHC.Core.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682894119"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1959"></span><span>
</span><span id="line-1960"></span><span class="annot"><a href="GHC.Core.Rules.html#ruleAppCheck_help"><span class="hs-identifier hs-type">ruleAppCheck_help</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-1961"></span><span id="ruleAppCheck_help"><span class="annot"><span class="annottext">ruleAppCheck_help :: RuleCheckEnv -&gt; Var -&gt; [CoreExpr] -&gt; [CoreRule] -&gt; SDoc
</span><a href="GHC.Core.Rules.html#ruleAppCheck_help"><span class="hs-identifier hs-var hs-var">ruleAppCheck_help</span></a></span></span><span> </span><span id="local-6989586621682894121"><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894121"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682894122"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894122"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682894123"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894123"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682894124"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682894124"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-1962"></span><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- The rules match the pattern, so we want to print something</span><span>
</span><span id="line-1963"></span><span>    </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Expression:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; CoreExpr
forall b. Var -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894122"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894123"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1964"></span><span>          </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreRule -&gt; SDoc) -&gt; [CoreRule] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
</span><a href="#local-6989586621682894125"><span class="hs-identifier hs-var">check_rule</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682894124"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1965"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1966"></span><span>    </span><span id="local-6989586621682894126"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682894126"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; InScopeSet
</span><a href="GHC.Core.Rules.html#rc_in_scope"><span class="hs-identifier hs-var">rc_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894121"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1967"></span><span>    </span><span id="local-6989586621682894127"><span class="annot"><span class="annottext">n_args :: Arity
</span><a href="#local-6989586621682894127"><span class="hs-identifier hs-var hs-var">n_args</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894123"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1968"></span><span>    </span><span id="local-6989586621682894129"><span class="annot"><span class="annottext">i_args :: [(CoreExpr, Arity)]
</span><a href="#local-6989586621682894129"><span class="hs-identifier hs-var hs-var">i_args</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894123"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; [Arity] -&gt; [(CoreExpr, Arity)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-1969"></span><span>    </span><span id="local-6989586621682894130"><span class="annot"><span class="annottext">rough_args :: [Maybe Name]
</span><a href="#local-6989586621682894130"><span class="hs-identifier hs-var hs-var">rough_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; Maybe Name) -&gt; [CoreExpr] -&gt; [Maybe Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe Name
</span><a href="GHC.Core.Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894123"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1970"></span><span>
</span><span id="line-1971"></span><span>    </span><span id="local-6989586621682894125"><span class="annot"><span class="annottext">check_rule :: CoreRule -&gt; SDoc
</span><a href="#local-6989586621682894125"><span class="hs-identifier hs-var hs-var">check_rule</span></a></span></span><span> </span><span id="local-6989586621682894131"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682894131"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
forall {doc}. IsLine doc =&gt; CoreRule -&gt; doc
</span><a href="#local-6989586621682894132"><span class="hs-identifier hs-var">rule_herald</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682894131"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOpts -&gt; CoreRule -&gt; SDoc
</span><a href="#local-6989586621682894134"><span class="hs-identifier hs-var">rule_info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; RuleOpts
</span><a href="GHC.Core.Rules.html#rc_ropts"><span class="hs-identifier hs-var">rc_ropts</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894121"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682894131"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-1972"></span><span>
</span><span id="line-1973"></span><span>    </span><span id="local-6989586621682894132"><span class="annot"><span class="annottext">rule_herald :: CoreRule -&gt; doc
</span><a href="#local-6989586621682894132"><span class="hs-identifier hs-var hs-var">rule_herald</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_name :: CoreRule -&gt; RuleName
</span><a href="GHC.Core.html#ru_name"><span class="hs-identifier hs-var">ru_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894147"><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682894147"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1974"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Builtin rule&quot;</span></span><span> </span><span class="annot"><span class="annottext">doc -&gt; doc -&gt; doc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">doc -&gt; doc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleName -&gt; doc
forall doc. IsLine doc =&gt; RuleName -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a></span><span> </span><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682894147"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1975"></span><span>    </span><span class="annot"><a href="#local-6989586621682894132"><span class="hs-identifier hs-var">rule_herald</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_name :: CoreRule -&gt; RuleName
</span><a href="GHC.Core.html#ru_name"><span class="hs-identifier hs-var">ru_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894148"><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682894148"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1976"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; doc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Rule&quot;</span></span><span> </span><span class="annot"><span class="annottext">doc -&gt; doc -&gt; doc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">doc -&gt; doc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleName -&gt; doc
forall doc. IsLine doc =&gt; RuleName -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a></span><span> </span><span class="annot"><span class="annottext">RuleName
</span><a href="#local-6989586621682894148"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1977"></span><span>
</span><span id="line-1978"></span><span>    </span><span id="local-6989586621682894134"><span class="annot"><span class="annottext">rule_info :: RuleOpts -&gt; CoreRule -&gt; SDoc
</span><a href="#local-6989586621682894134"><span class="hs-identifier hs-var hs-var">rule_info</span></a></span></span><span> </span><span id="local-6989586621682894149"><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621682894149"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682894150"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682894150"><span class="hs-identifier hs-var">rule</span></a></span></span><span>
</span><span id="line-1979"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleOpts
-&gt; InScopeEnv
-&gt; (Activation -&gt; Bool)
-&gt; Var
-&gt; [CoreExpr]
-&gt; [Maybe Name]
-&gt; CoreRule
-&gt; Maybe CoreExpr
</span><a href="GHC.Core.Rules.html#matchRule"><span class="hs-identifier hs-var">matchRule</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621682894149"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; IdUnfoldingFun -&gt; InScopeEnv
</span><a href="GHC.Core.html#ISE"><span class="hs-identifier hs-var">ISE</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="GHC.Types.Var.Env.html#emptyInScopeSet"><span class="hs-identifier hs-var">emptyInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; IdUnfoldingFun
</span><a href="GHC.Core.Rules.html#rc_id_unf"><span class="hs-identifier hs-var">rc_id_unf</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894121"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1980"></span><span>                              </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="GHC.Core.Rules.html#noBlackList"><span class="hs-identifier hs-var">noBlackList</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621682894122"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894123"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Name]
</span><a href="#local-6989586621682894130"><span class="hs-identifier hs-var">rough_args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682894150"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-1981"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;matches (which is very peculiar!)&quot;</span></span><span>
</span><span id="line-1982"></span><span>
</span><span id="line-1983"></span><span>    </span><span class="annot"><a href="#local-6989586621682894134"><span class="hs-identifier hs-var">rule_info</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOpts
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;does not match&quot;</span></span><span>
</span><span id="line-1984"></span><span>
</span><span id="line-1985"></span><span>    </span><span class="annot"><a href="#local-6989586621682894134"><span class="hs-identifier hs-var">rule_info</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOpts
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_act :: CoreRule -&gt; Activation
</span><a href="GHC.Core.html#ru_act"><span class="hs-identifier hs-var">ru_act</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894151"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682894151"><span class="hs-identifier hs-var">act</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1986"></span><span>                        </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [Var]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894152"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682894152"><span class="hs-identifier hs-var">rule_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682894153"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894153"><span class="hs-identifier hs-var">rule_args</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1987"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; Activation -&gt; Bool
</span><a href="GHC.Core.Rules.html#rc_is_active"><span class="hs-identifier hs-var">rc_is_active</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894121"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682894151"><span class="hs-identifier hs-var">act</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;active only in later phase&quot;</span></span><span>
</span><span id="line-1988"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621682894127"><span class="hs-identifier hs-var">n_args</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621682894155"><span class="hs-identifier hs-var">n_rule_args</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;too few arguments&quot;</span></span><span>
</span><span id="line-1989"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621682894156"><span class="hs-identifier hs-var">n_mismatches</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621682894155"><span class="hs-identifier hs-var">n_rule_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no arguments match&quot;</span></span><span>
</span><span id="line-1990"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621682894156"><span class="hs-identifier hs-var">n_mismatches</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;all arguments match (considered individually), but rule as a whole does not&quot;</span></span><span>
</span><span id="line-1991"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arguments&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Arity] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Arity]
</span><a href="#local-6989586621682894157"><span class="hs-identifier hs-var">mismatches</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;do not match (1-indexing)&quot;</span></span><span>
</span><span id="line-1992"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1993"></span><span>          </span><span id="local-6989586621682894155"><span class="annot"><span class="annottext">n_rule_args :: Arity
</span><a href="#local-6989586621682894155"><span class="hs-identifier hs-var hs-var">n_rule_args</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894153"><span class="hs-identifier hs-var">rule_args</span></a></span><span>
</span><span id="line-1994"></span><span>          </span><span id="local-6989586621682894156"><span class="annot"><span class="annottext">n_mismatches :: Arity
</span><a href="#local-6989586621682894156"><span class="hs-identifier hs-var hs-var">n_mismatches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Arity] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Arity]
</span><a href="#local-6989586621682894157"><span class="hs-identifier hs-var">mismatches</span></a></span><span>
</span><span id="line-1995"></span><span>          </span><span id="local-6989586621682894157"><span class="annot"><span class="annottext">mismatches :: [Arity]
</span><a href="#local-6989586621682894157"><span class="hs-identifier hs-var hs-var">mismatches</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621682894158"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682894159"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894159"><span class="hs-identifier hs-var">rule_arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682894160"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894160"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682894158"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621682894158"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682894153"><span class="hs-identifier hs-var">rule_args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
-&gt; [(CoreExpr, Arity)] -&gt; [(CoreExpr, (CoreExpr, Arity))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[(CoreExpr, Arity)]
</span><a href="#local-6989586621682894129"><span class="hs-identifier hs-var">i_args</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1996"></span><span>                              </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe RuleSubst -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; Maybe RuleSubst
</span><a href="#local-6989586621682894161"><span class="hs-identifier hs-var">match_fn</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894159"><span class="hs-identifier hs-var">rule_arg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894160"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1997"></span><span>
</span><span id="line-1998"></span><span>          </span><span id="local-6989586621682894161"><span class="annot"><span class="annottext">match_fn :: CoreExpr -&gt; CoreExpr -&gt; Maybe RuleSubst
</span><a href="#local-6989586621682894161"><span class="hs-identifier hs-var hs-var">match_fn</span></a></span></span><span> </span><span id="local-6989586621682894162"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894162"><span class="hs-identifier hs-var">rule_arg</span></a></span></span><span> </span><span id="local-6989586621682894163"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894163"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
-&gt; RuleSubst
-&gt; CoreExpr
-&gt; CoreExpr
-&gt; MCoercion
-&gt; Maybe RuleSubst
</span><a href="GHC.Core.Rules.html#match"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">RuleMatchEnv
</span><a href="#local-6989586621682894164"><span class="hs-identifier hs-var">renv</span></a></span><span> </span><span class="annot"><span class="annottext">RuleSubst
</span><a href="GHC.Core.Rules.html#emptyRuleSubst"><span class="hs-identifier hs-var">emptyRuleSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894162"><span class="hs-identifier hs-var">rule_arg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682894163"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-1999"></span><span>                </span><span class="hs-keyword">where</span><span>
</span><span id="line-2000"></span><span>                  </span><span id="local-6989586621682894164"><span class="annot"><span class="annottext">renv :: RuleMatchEnv
</span><a href="#local-6989586621682894164"><span class="hs-identifier hs-var hs-var">renv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RV"><span class="hs-identifier hs-type">RV</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rv_lcl :: RnEnv2
</span><a href="GHC.Core.Rules.html#rv_lcl"><span class="hs-identifier hs-var">rv_lcl</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; RnEnv2
</span><a href="GHC.Types.Var.Env.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682894126"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-2001"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_tmpls :: VarSet
</span><a href="GHC.Core.Rules.html#rv_tmpls"><span class="hs-identifier hs-var">rv_tmpls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621682894152"><span class="hs-identifier hs-var">rule_bndrs</span></a></span><span>
</span><span id="line-2002"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_fltR :: Subst
</span><a href="GHC.Core.Rules.html#rv_fltR"><span class="hs-identifier hs-var">rv_fltR</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682894126"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-2003"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rv_unf :: IdUnfoldingFun
</span><a href="GHC.Core.Rules.html#rv_unf"><span class="hs-identifier hs-var">rv_unf</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv -&gt; IdUnfoldingFun
</span><a href="GHC.Core.Rules.html#rc_id_unf"><span class="hs-identifier hs-var">rc_id_unf</span></a></span><span> </span><span class="annot"><span class="annottext">RuleCheckEnv
</span><a href="#local-6989586621682894121"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2004"></span></pre></body></html>