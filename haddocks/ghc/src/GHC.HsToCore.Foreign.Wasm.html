<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html"><span class="hs-identifier">GHC.HsToCore.Foreign.Wasm</span></a></span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSImport"><span class="hs-identifier">dsWasmJSImport</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSExport"><span class="hs-identifier">dsWasmJSExport</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">intercalate</span></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><span class="hs-identifier">stripPrefix</span></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html"><span class="hs-identifier">GHC.Builtin.Types.Prim</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Hs.html"><span class="hs-identifier">GHC.Hs</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Call.html"><span class="hs-identifier">GHC.HsToCore.Foreign.Call</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Utils.html"><span class="hs-identifier">GHC.HsToCore.Foreign.Utils</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html"><span class="hs-identifier">GHC.HsToCore.Monad</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html"><span class="hs-identifier">GHC.HsToCore.Types</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Iface.Env.html"><span class="hs-identifier">GHC.Iface.Env</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html"><span class="hs-identifier">GHC.Tc.Utils.Env</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.ForeignCall.html"><span class="hs-identifier">GHC.Types.ForeignCall</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html"><span class="hs-identifier">GHC.Types.ForeignStubs</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SourceText.html"><span class="hs-identifier">GHC.Types.SourceText</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.html"><span class="hs-identifier">GHC.Unit</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html"><span class="hs-identifier">Language.Haskell.Syntax.Basic</span></a></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSImport"><span class="hs-identifier hs-type">dsWasmJSImport</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#CImportSpec"><span class="hs-identifier hs-type">CImportSpec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><a href="GHC.Types.ForeignCall.html#Safety"><span class="hs-identifier hs-type">Safety</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.HsToCore.Foreign.Utils.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CHeader"><span class="hs-identifier hs-type">CHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CStub"><span class="hs-identifier hs-type">CStub</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span id="dsWasmJSImport"><span class="annot"><span class="annottext">dsWasmJSImport :: Id
-&gt; Coercion
-&gt; CImportSpec
-&gt; Safety
-&gt; DsM ([Binding], CHeader, CStub, [Id])
</span><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSImport"><span class="hs-identifier hs-var hs-var">dsWasmJSImport</span></a></span></span><span> </span><span id="local-6989586621683123966"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123966"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621683123967"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683123967"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Decls.html#CFunction"><span class="hs-identifier hs-type">CFunction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.ForeignCall.html#StaticTarget"><span class="hs-identifier hs-type">StaticTarget</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683123970"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683123970"><span class="hs-identifier hs-var">js_src</span></a></span></span><span> </span><span id="local-6989586621683123971"><span class="annot"><span class="annottext">Maybe Unit
</span><a href="#local-6989586621683123971"><span class="hs-identifier hs-var">mUnitId</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683123972"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621683123972"><span class="hs-identifier hs-var">safety</span></a></span></span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683123970"><span class="hs-identifier hs-var">js_src</span></a></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; FastString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FastString
</span><span class="hs-string">&quot;wrapper&quot;</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
-&gt; Coercion -&gt; Maybe Unit -&gt; DsM ([Binding], CHeader, CStub, [Id])
</span><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSDynamicExport"><span class="hs-identifier hs-var">dsWasmJSDynamicExport</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123966"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683123967"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Unit
</span><a href="#local-6989586621683123971"><span class="hs-identifier hs-var">mUnitId</span></a></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-58"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683123974"><span class="annot"><a href="#local-6989586621683123974"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683123975"><span class="annot"><a href="#local-6989586621683123975"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683123976"><span class="annot"><a href="#local-6989586621683123976"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id
-&gt; Coercion
-&gt; [Char]
-&gt; Maybe Unit
-&gt; Safety
-&gt; DsM ([Binding], CHeader, CStub)
</span><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSStaticImport"><span class="hs-identifier hs-var">dsWasmJSStaticImport</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123966"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683123967"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; [Char]
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683123970"><span class="hs-identifier hs-var">js_src</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Unit
</span><a href="#local-6989586621683123971"><span class="hs-identifier hs-var">mUnitId</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621683123972"><span class="hs-identifier hs-var">safety</span></a></span><span>
</span><span id="line-59"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683123974"><span class="hs-identifier hs-type">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683123975"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683123976"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSImport"><span class="hs-identifier hs-var">dsWasmJSImport</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CImportSpec
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; DsM ([Binding], CHeader, CStub, [Id])
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;dsWasmJSImport: unreachable&quot;</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-comment">{-

Note [Desugaring JSFFI dynamic export]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A JSFFI dynamic export wraps a Haskell function as a JavaScript
callback:

foreign import javascript &quot;wrapper&quot;
  mk_wrapper :: HsFuncType -&gt; IO JSVal

We desugar it to three bindings under the hood:

1. The worker function

mk_wrapper_worker :: StablePtr HsFuncType -&gt; HsFuncType
mk_wrapper_worker sp = unsafeDupablePerformIO (deRefStablePtr sp)

No need to bother with eta-expansion here. Also, the worker function
is marked as a JSFFI static export.

2. The adjustor function

foreign import javascript unsafe &quot;(...args) =&gt; __exports.mk_wrapper_worker($1, ...args)&quot;
  mk_wrapper_adjustor :: StablePtr HsFuncType -&gt; IO JSVal

It generates a JavaScript callback that captures the stable pointer.
When the callback is invoked later, it calls our worker function and
passes the stable pointer as well as the rest of the arguments.

3. The wrapper function

mk_wrapper :: HsFuncType -&gt; IO JSVal
mk_wrapper = mkJSCallback mk_wrapper_adjustor

This is the user-facing mk_wrapper binding. It allocates a stable
pointer for the Haskell function closure, then calls the adjustor
function to fetch the JSVal that represents the JavaScript callback.
The JSVal as returned by the adjustor is not returned directly; it has
a StablePtr# field which is NULL by default, but for JSFFI dynamic
exports, it's set to the Haskell function's stable pointer. This way,
when we call freeJSVal, the Haskell function can be freed as well.

-}</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSDynamicExport"><span class="hs-identifier hs-type">dsWasmJSDynamicExport</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Unit"><span class="hs-identifier hs-type">Unit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.HsToCore.Foreign.Utils.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CHeader"><span class="hs-identifier hs-type">CHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CStub"><span class="hs-identifier hs-type">CStub</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span id="dsWasmJSDynamicExport"><span class="annot"><span class="annottext">dsWasmJSDynamicExport :: Id
-&gt; Coercion -&gt; Maybe Unit -&gt; DsM ([Binding], CHeader, CStub, [Id])
</span><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSDynamicExport"><span class="hs-identifier hs-var hs-var">dsWasmJSDynamicExport</span></a></span></span><span> </span><span id="local-6989586621683123980"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123980"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span> </span><span id="local-6989586621683123981"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683123981"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621683123982"><span class="annot"><span class="annottext">Maybe Unit
</span><a href="#local-6989586621683123982"><span class="hs-identifier hs-var">mUnitId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-110"></span><span>  </span><span id="local-6989586621683123983"><span class="annot"><a href="#local-6989586621683123983"><span class="hs-identifier hs-var">sp_tycon</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DsM TyCon
</span><a href="GHC.HsToCore.Monad.html#dsLookupTyCon"><span class="hs-identifier hs-var">dsLookupTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#stablePtrTyConName"><span class="hs-identifier hs-var">stablePtrTyConName</span></a></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683123986"><span class="annot"><a href="#local-6989586621683123986"><span class="hs-identifier hs-var hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683123981"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683123988"><span class="annot"><a href="#local-6989586621683123988"><span class="hs-identifier hs-var">tv_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683123989"><span class="annot"><a href="#local-6989586621683123989"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitForAllTyVarBinders"><span class="hs-identifier hs-type">tcSplitForAllTyVarBinders</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683123986"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-type">ManyTy</span></a></span><span> </span><span id="local-6989586621683123993"><span class="annot"><a href="#local-6989586621683123993"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621683123994"><span class="annot"><a href="#local-6989586621683123994"><span class="hs-identifier hs-var">io_jsval_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitFunTys"><span class="hs-identifier hs-type">tcSplitFunTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683123989"><span class="hs-identifier hs-type">fun_ty</span></a></span><span>
</span><span id="line-114"></span><span>      </span><span id="local-6989586621683123996"><span class="annot"><a href="#local-6989586621683123996"><span class="hs-identifier hs-var hs-var">sp_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683123983"><span class="hs-identifier hs-var">sp_tycon</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683123993"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683123998"><span class="annot"><a href="#local-6989586621683123998"><span class="hs-identifier hs-var">real_arg_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitFunTys"><span class="hs-identifier hs-type">tcSplitFunTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683123993"><span class="hs-identifier hs-type">arg_ty</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span id="local-6989586621683123999"><span class="annot"><a href="#local-6989586621683123999"><span class="hs-identifier hs-var">sp_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#newSysLocalMDs"><span class="hs-identifier hs-type">newSysLocalMDs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683123996"><span class="hs-identifier hs-type">sp_ty</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span id="local-6989586621683124001"><span class="annot"><a href="#local-6989586621683124001"><span class="hs-identifier hs-var">work_uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#newUnique"><span class="hs-identifier hs-type">newUnique</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span id="local-6989586621683124003"><span class="annot"><a href="#local-6989586621683124003"><span class="hs-identifier hs-var">work_export_name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#uniqueCFunName"><span class="hs-identifier hs-type">uniqueCFunName</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span id="local-6989586621683124005"><span class="annot"><a href="#local-6989586621683124005"><span class="hs-identifier hs-var">deRefStablePtr_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.Stable&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;deRefStablePtr&quot;</span></span><span>
</span><span id="line-120"></span><span>  </span><span id="local-6989586621683124007"><span class="annot"><a href="#local-6989586621683124007"><span class="hs-identifier hs-var">unsafeDupablePerformIO_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-121"></span><span>    </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span>
</span><span id="line-122"></span><span>      </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.IO.Unsafe&quot;</span></span><span>
</span><span id="line-123"></span><span>      </span><span class="annot"><span class="hs-string">&quot;unsafeDupablePerformIO&quot;</span></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683124008"><span class="annot"><a href="#local-6989586621683124008"><span class="hs-identifier hs-var hs-var">work_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-125"></span><span>        </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Id
</span><a href="GHC.Types.Id.html#mkExportedVanillaId"><span class="hs-identifier hs-var">mkExportedVanillaId</span></a></span><span>
</span><span id="line-126"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Module -&gt; OccName -&gt; SrcSpan -&gt; Name
</span><a href="GHC.Types.Name.html#mkExternalName"><span class="hs-identifier hs-var">mkExternalName</span></a></span><span>
</span><span id="line-127"></span><span>              </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621683124001"><span class="hs-identifier hs-var">work_uniq</span></a></span><span>
</span><span id="line-128"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Module) -&gt; Name -&gt; Module
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123980"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkVarOcc"><span class="hs-identifier hs-var">mkVarOcc</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; OccName) -&gt; [Char] -&gt; OccName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;jsffi_&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">OccName -&gt; [Char]
</span><a href="GHC.Types.Name.Occurrence.html#occNameString"><span class="hs-identifier hs-var">occNameString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccName
forall a. NamedThing a =&gt; a -&gt; OccName
</span><a href="GHC.Types.Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123980"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_work&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>              </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#generatedSrcSpan"><span class="hs-identifier hs-var">generatedSrcSpan</span></a></span><span>
</span><span id="line-131"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>          </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124017"><span class="hs-identifier hs-var">work_ty</span></a></span><span>
</span><span id="line-133"></span><span>      </span><span id="local-6989586621683124018"><span class="annot"><a href="#local-6989586621683124018"><span class="hs-identifier hs-var hs-var">work_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-134"></span><span>        </span><span class="annot"><span class="annottext">[Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkCoreLams"><span class="hs-identifier hs-var">mkCoreLams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124020"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621683124020"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124020"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683123988"><span class="hs-identifier hs-var">tv_bndrs</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123999"><span class="hs-identifier hs-var">sp_id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>          </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span>
</span><span id="line-136"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124007"><span class="hs-identifier hs-var">unsafeDupablePerformIO_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>            </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683123993"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124005"><span class="hs-identifier hs-var">deRefStablePtr_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683123993"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123999"><span class="hs-identifier hs-var">sp_id</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-138"></span><span>      </span><span id="local-6989586621683124017"><span class="annot"><a href="#local-6989586621683124017"><span class="hs-identifier hs-var hs-var">work_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124018"><span class="hs-identifier hs-var">work_rhs</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621683124026"><span class="annot"><a href="#local-6989586621683124026"><span class="hs-identifier hs-var">work_h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124027"><span class="annot"><a href="#local-6989586621683124027"><span class="hs-identifier hs-var">work_c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124028"><span class="annot"><a href="#local-6989586621683124028"><span class="hs-identifier hs-var">work_ids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124029"><span class="annot"><a href="#local-6989586621683124029"><span class="hs-identifier hs-var">work_bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSExport"><span class="hs-identifier hs-type">dsWasmJSExport</span></a></span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><a href="#local-6989586621683124008"><span class="hs-identifier hs-type">work_id</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkRepReflCo"><span class="hs-identifier hs-type">mkRepReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124017"><span class="hs-identifier hs-type">work_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><a href="#local-6989586621683124003"><span class="hs-identifier hs-type">work_export_name</span></a></span><span>
</span><span id="line-144"></span><span>  </span><span id="local-6989586621683124031"><span class="annot"><a href="#local-6989586621683124031"><span class="hs-identifier hs-var">adjustor_uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#newUnique"><span class="hs-identifier hs-type">newUnique</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683124032"><span class="annot"><a href="#local-6989586621683124032"><span class="hs-identifier hs-var hs-var">adjustor_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-146"></span><span>        </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Id
</span><a href="GHC.Types.Id.html#mkExportedVanillaId"><span class="hs-identifier hs-var">mkExportedVanillaId</span></a></span><span>
</span><span id="line-147"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Module -&gt; OccName -&gt; SrcSpan -&gt; Name
</span><a href="GHC.Types.Name.html#mkExternalName"><span class="hs-identifier hs-var">mkExternalName</span></a></span><span>
</span><span id="line-148"></span><span>              </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621683124031"><span class="hs-identifier hs-var">adjustor_uniq</span></a></span><span>
</span><span id="line-149"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Module) -&gt; Name -&gt; Module
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123980"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkVarOcc"><span class="hs-identifier hs-var">mkVarOcc</span></a></span><span>
</span><span id="line-151"></span><span>                  </span><span class="annot"><span class="annottext">([Char] -&gt; OccName) -&gt; [Char] -&gt; OccName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;jsffi_&quot;</span></span><span>
</span><span id="line-152"></span><span>                  </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">OccName -&gt; [Char]
</span><a href="GHC.Types.Name.Occurrence.html#occNameString"><span class="hs-identifier hs-var">occNameString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccName
forall a. NamedThing a =&gt; a -&gt; OccName
</span><a href="GHC.Types.Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683123980"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>                  </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_adjustor&quot;</span></span><span>
</span><span id="line-154"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>              </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#generatedSrcSpan"><span class="hs-identifier hs-var">generatedSrcSpan</span></a></span><span>
</span><span id="line-156"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>          </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124033"><span class="hs-identifier hs-var">adjustor_ty</span></a></span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621683124033"><span class="annot"><a href="#local-6989586621683124033"><span class="hs-identifier hs-var hs-var">adjustor_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVarBinder] -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkForAllTys"><span class="hs-identifier hs-var">mkForAllTys</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683123988"><span class="hs-identifier hs-var">tv_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkVisFunTysMany"><span class="hs-identifier hs-var">mkVisFunTysMany</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683123996"><span class="hs-identifier hs-var">sp_ty</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683123994"><span class="hs-identifier hs-var">io_jsval_ty</span></a></span><span>
</span><span id="line-159"></span><span>      </span><span id="local-6989586621683124036"><span class="annot"><a href="#local-6989586621683124036"><span class="hs-identifier hs-var hs-var">adjustor_js_src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>        </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;(&quot;</span></span><span>
</span><span id="line-161"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [[Char]] -&gt; [Char]
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">intercalate</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;,&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;a&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124038"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683124038"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124038"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[Scaled Type] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683123998"><span class="hs-identifier hs-var">real_arg_tys</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-162"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;) =&gt; __exports.&quot;</span></span><span>
</span><span id="line-163"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; [Char]
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124003"><span class="hs-identifier hs-var">work_export_name</span></a></span><span>
</span><span id="line-164"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;($1&quot;</span></span><span>
</span><span id="line-165"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;,a&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124040"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683124040"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124040"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[Scaled Type] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683123998"><span class="hs-identifier hs-var">real_arg_tys</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-166"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621683124041"><span class="annot"><a href="#local-6989586621683124041"><span class="hs-identifier hs-var">adjustor_bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124042"><span class="annot"><a href="#local-6989586621683124042"><span class="hs-identifier hs-var">adjustor_h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124043"><span class="annot"><a href="#local-6989586621683124043"><span class="hs-identifier hs-var">adjustor_c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-168"></span><span>    </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSStaticImport"><span class="hs-identifier hs-type">dsWasmJSStaticImport</span></a></span><span>
</span><span id="line-169"></span><span>      </span><span class="annot"><a href="#local-6989586621683124032"><span class="hs-identifier hs-type">adjustor_id</span></a></span><span>
</span><span id="line-170"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#mkRepReflCo"><span class="hs-identifier hs-type">mkRepReflCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124033"><span class="hs-identifier hs-type">adjustor_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>      </span><span class="annot"><a href="#local-6989586621683124036"><span class="hs-identifier hs-type">adjustor_js_src</span></a></span><span>
</span><span id="line-172"></span><span>      </span><span class="annot"><a href="#local-6989586621683123982"><span class="hs-identifier hs-type">mUnitId</span></a></span><span>
</span><span id="line-173"></span><span>      </span><span class="annot"><a href="GHC.Types.ForeignCall.html#PlayRisky"><span class="hs-identifier hs-type">PlayRisky</span></a></span><span>
</span><span id="line-174"></span><span>  </span><span id="local-6989586621683124045"><span class="annot"><a href="#local-6989586621683124045"><span class="hs-identifier hs-var">mkJSCallback_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.Wasm.Prim.Exports&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;mkJSCallback&quot;</span></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683124046"><span class="annot"><a href="#local-6989586621683124046"><span class="hs-identifier hs-var hs-var">wrap_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>        </span><span class="annot"><span class="annottext">[Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkCoreLams"><span class="hs-identifier hs-var">mkCoreLams</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124047"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621683124047"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124047"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683123988"><span class="hs-identifier hs-var">tv_bndrs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-177"></span><span>          </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span>
</span><span id="line-178"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124045"><span class="hs-identifier hs-var">mkJSCallback_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683123993"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-180"></span><span>              </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span>
</span><span id="line-181"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124032"><span class="hs-identifier hs-var">adjustor_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; CoreExpr) -&gt; Type -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124049"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621683124049"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124049"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683123988"><span class="hs-identifier hs-var">tv_bndrs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-183"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683123980"><span class="hs-identifier hs-type">fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124046"><span class="hs-identifier hs-type">wrap_rhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683123981"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683124008"><span class="hs-identifier hs-type">work_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683124018"><span class="hs-identifier hs-type">work_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683124029"><span class="hs-identifier hs-type">work_bs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683124041"><span class="hs-identifier hs-type">adjustor_bs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-186"></span><span>      </span><span class="annot"><a href="#local-6989586621683124026"><span class="hs-identifier hs-type">work_h</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`mappend`</span></span><span> </span><span class="annot"><a href="#local-6989586621683124042"><span class="hs-identifier hs-type">adjustor_h</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-187"></span><span>      </span><span class="annot"><a href="#local-6989586621683124027"><span class="hs-identifier hs-type">work_c</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`mappend`</span></span><span> </span><span class="annot"><a href="#local-6989586621683124043"><span class="hs-identifier hs-type">adjustor_c</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><a href="#local-6989586621683124028"><span class="hs-identifier hs-type">work_ids</span></a></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-comment">{-

Note [Desugaring JSFFI import]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The simplest case is JSFFI sync import, those marked as unsafe. It is
implemented on top of C FFI unsafe import.

Unlike C FFI which generates a worker/wrapper pair that unboxes the
arguments and boxes the result in Haskell, we only desugar to a single
Haskell binding that case-binds the arguments to ensure they're
evaluated, then passes the boxed arguments directly to C and receive
the boxed result from C as well.

This is of course less efficient than how C FFI does it, and unboxed
FFI types aren't supported, but it's the easiest way to implement it,
especially since leaving all the boxing/unboxing business to C unifies
the implementation of JSFFI imports and exports.

Now, each sync import calls a generated C function with a unique
symbol. The C function uses rts_get* to unbox the arguments, call into
JavaScript, then boxes the result with rts_mk* and returns it to
Haskell. But wait, how on earth is C able to call into JavaScript
here!? The secret is using a wasm import:

__attribute__((import_module(&quot;ghc_wasm_jsffi&quot;), import_name(&quot;my_js_func&quot;)))
HsJSVal worker_func(HsInt a1, HsJSVal a2);

Wasm imports live in the same namespace as other wasm functions, so
our C wrapper function can call into this imported worker function,
which will literally be the user written JavaScript function with
binders $1, $2, etc.

So far so good, but how does the source code snippet go from Haskell
source files to the JavaScript module which provides the
ghc_wasm_jsffi imports to be used by the wasm module at runtime? The
secret is embedding the source code snippets in a wasm custom section
named ghc_wasm_jsffi:

.section .custom_section.ghc_wasm_jsffi,&quot;&quot;,@
.asciz my_js_func
.asciz ($1, $2)
.asciz js_code_containing($1, $2)

At link time, for all object files touched by wasm-ld, all
ghc_wasm_jsffi sections are concatenated into a single ghc_wasm_jsffi
section in the output wasm module. And then, a simple &quot;post-linker&quot;
program can parse the payload of that section and emit a JavaScript
module. Note that above is assembly source file, but we're only
generating a C stub, so we need to smuggle the assembly code into C
via __asm__.

JSFFI async import is implemented on top of JSFFI sync import. We
still desugar it to a single Haskell binding that calls C, with some
subtle differences:

- The C result type is always a boxed JSVal that represents the
  JavaScript Promise, instead of the actual Haskell result type.
- In the custom section payload, we emit &quot;async ($1, $2)&quot; instead of
  &quot;($1, $2)&quot;. As you can see, it is the arrow function binder, and the
  post-linker will respect the async binder and allow await in the
  function body.
- The C import is also marked as safe. This is required since the
  JavaScript code may re-enter Haskell. If re-entrance only happens in
  future event loop tasks, it's fine to mark the C import as unsafe
  since the current Haskell execution context has already been freed
  at that point, but there's no such guarantee, so better safe than
  sorry here.

Now we have the Promise JSVal, we apply stg_blockPromise to it to get
a thunk with the desired return type. When the thunk is forced, it
will block the forcing thread and wait for the Promise to resolve or
reject. See Note [stg_blockPromise] for detailed explanation of how it
works.

-}</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSStaticImport"><span class="hs-identifier hs-type">dsWasmJSStaticImport</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-272"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Unit"><span class="hs-identifier hs-type">Unit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-273"></span><span>  </span><span class="annot"><a href="GHC.Types.ForeignCall.html#Safety"><span class="hs-identifier hs-type">Safety</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.HsToCore.Foreign.Utils.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CHeader"><span class="hs-identifier hs-type">CHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CStub"><span class="hs-identifier hs-type">CStub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span id="dsWasmJSStaticImport"><span class="annot"><span class="annottext">dsWasmJSStaticImport :: Id
-&gt; Coercion
-&gt; [Char]
-&gt; Maybe Unit
-&gt; Safety
-&gt; DsM ([Binding], CHeader, CStub)
</span><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSStaticImport"><span class="hs-identifier hs-var hs-var">dsWasmJSStaticImport</span></a></span></span><span> </span><span id="local-6989586621683124051"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124051"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span> </span><span id="local-6989586621683124052"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683124052"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621683124053"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124053"><span class="hs-identifier hs-var">js_src'</span></a></span></span><span> </span><span id="local-6989586621683124054"><span class="annot"><span class="annottext">Maybe Unit
</span><a href="#local-6989586621683124054"><span class="hs-identifier hs-var">mUnitId</span></a></span></span><span> </span><span id="local-6989586621683124055"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621683124055"><span class="hs-identifier hs-var">safety</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>  </span><span id="local-6989586621683124056"><span class="annot"><a href="#local-6989586621683124056"><span class="hs-identifier hs-var">cfun_name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DsM FastString
</span><a href="GHC.HsToCore.Foreign.Wasm.html#uniqueCFunName"><span class="hs-identifier hs-var">uniqueCFunName</span></a></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683124057"><span class="annot"><a href="#local-6989586621683124057"><span class="hs-identifier hs-var hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683124052"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683124058"><span class="annot"><a href="#local-6989586621683124058"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124059"><span class="annot"><a href="#local-6989586621683124059"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitForAllInvisTyVars"><span class="hs-identifier hs-type">tcSplitForAllInvisTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124057"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-279"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683124061"><span class="annot"><a href="#local-6989586621683124061"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124062"><span class="annot"><a href="#local-6989586621683124062"><span class="hs-identifier hs-var">orig_res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitFunTys"><span class="hs-identifier hs-type">tcSplitFunTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124059"><span class="hs-identifier hs-type">fun_ty</span></a></span><span>
</span><span id="line-280"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683124063"><span class="annot"><a href="#local-6989586621683124063"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124064"><span class="annot"><a href="#local-6989586621683124064"><span class="hs-identifier hs-var">is_io</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitIOType_maybe"><span class="hs-identifier hs-type">tcSplitIOType_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124062"><span class="hs-identifier hs-type">orig_res_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-281"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124066"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124066"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124066"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TyCon, Type)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124062"><span class="hs-identifier hs-var">orig_res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>      </span><span id="local-6989586621683124067"><span class="annot"><a href="#local-6989586621683124067"><span class="hs-identifier hs-var hs-var">js_src</span></a></span></span><span>
</span><span id="line-284"></span><span>        </span><span class="hs-comment">-- Just desugar it to a JSFFI import with source text &quot;$1($2,</span><span>
</span><span id="line-285"></span><span>        </span><span class="hs-comment">-- ...)&quot;, with the same type signature and safety annotation.</span><span>
</span><span id="line-286"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124053"><span class="hs-identifier hs-var">js_src'</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;dynamic&quot;</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-287"></span><span>            </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;$1(&quot;</span></span><span>
</span><span id="line-288"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [[Char]] -&gt; [Char]
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">intercalate</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;,&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;$&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124068"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683124068"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124068"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[Scaled Type] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683124061"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-289"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-290"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-291"></span><span>            </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124053"><span class="hs-identifier hs-var">js_src'</span></a></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683124055"><span class="hs-identifier hs-type">safety</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="annottext">Safety
</span><a href="GHC.Types.ForeignCall.html#PlayRisky"><span class="hs-identifier hs-var">PlayRisky</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-294"></span><span>      </span><span id="local-6989586621683124069"><span class="annot"><a href="#local-6989586621683124069"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">Maybe Unit
-&gt; Safety
-&gt; FastString
-&gt; [Id]
-&gt; [Scaled Type]
-&gt; Type
-&gt; (CoreExpr -&gt; CoreExpr)
-&gt; DsM CoreExpr
</span><a href="GHC.HsToCore.Foreign.Wasm.html#importBindingRHS"><span class="hs-identifier hs-var">importBindingRHS</span></a></span><span>
</span><span id="line-296"></span><span>          </span><span class="annot"><span class="annottext">Maybe Unit
</span><a href="#local-6989586621683124054"><span class="hs-identifier hs-var">mUnitId</span></a></span><span>
</span><span id="line-297"></span><span>          </span><span class="annot"><span class="annottext">Safety
</span><a href="GHC.Types.ForeignCall.html#PlayRisky"><span class="hs-identifier hs-var">PlayRisky</span></a></span><span>
</span><span id="line-298"></span><span>          </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124056"><span class="hs-identifier hs-var">cfun_name</span></a></span><span>
</span><span id="line-299"></span><span>          </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124058"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-300"></span><span>          </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683124061"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-301"></span><span>          </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124062"><span class="hs-identifier hs-var">orig_res_ty</span></a></span><span>
</span><span id="line-302"></span><span>          </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-303"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span>
</span><span id="line-304"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683124051"><span class="hs-identifier hs-type">fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124069"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124052"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-305"></span><span>          </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CHeader"><span class="hs-identifier hs-type">CHeader</span></a></span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#commonCDecls"><span class="hs-identifier hs-type">commonCDecls</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-306"></span><span>          </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#importCStub"><span class="hs-identifier hs-type">importCStub</span></a></span><span>
</span><span id="line-307"></span><span>            </span><span class="annot"><a href="GHC.Types.ForeignCall.html#PlayRisky"><span class="hs-identifier hs-type">PlayRisky</span></a></span><span>
</span><span id="line-308"></span><span>            </span><span class="annot"><a href="#local-6989586621683124056"><span class="hs-identifier hs-type">cfun_name</span></a></span><span>
</span><span id="line-309"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-type">scaledThing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124061"><span class="hs-identifier hs-type">arg_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>            </span><span class="annot"><a href="#local-6989586621683124063"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-311"></span><span>            </span><span class="annot"><a href="#local-6989586621683124067"><span class="hs-identifier hs-type">js_src</span></a></span><span>
</span><span id="line-312"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-314"></span><span>      </span><span id="local-6989586621683124076"><span class="annot"><a href="#local-6989586621683124076"><span class="hs-identifier hs-var">io_tycon</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DsM TyCon
</span><a href="GHC.HsToCore.Monad.html#dsLookupTyCon"><span class="hs-identifier hs-var">dsLookupTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#ioTyConName"><span class="hs-identifier hs-var">ioTyConName</span></a></span><span>
</span><span id="line-315"></span><span>      </span><span id="local-6989586621683124078"><span class="annot"><a href="#local-6989586621683124078"><span class="hs-identifier hs-var">jsval_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#mkTyConTy"><span class="hs-identifier hs-type">mkTyConTy</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalTyCon"><span class="hs-identifier hs-type">lookupGhcInternalTyCon</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.Wasm.Prim.Types&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;JSVal&quot;</span></span><span>
</span><span id="line-316"></span><span>      </span><span id="local-6989586621683124082"><span class="annot"><a href="#local-6989586621683124082"><span class="hs-identifier hs-var">bindIO_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#dsLookupGlobalId"><span class="hs-identifier hs-type">dsLookupGlobalId</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#bindIOName"><span class="hs-identifier hs-type">bindIOName</span></a></span><span>
</span><span id="line-317"></span><span>      </span><span id="local-6989586621683124085"><span class="annot"><a href="#local-6989586621683124085"><span class="hs-identifier hs-var">returnIO_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#dsLookupGlobalId"><span class="hs-identifier hs-type">dsLookupGlobalId</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#returnIOName"><span class="hs-identifier hs-type">returnIOName</span></a></span><span>
</span><span id="line-318"></span><span>      </span><span id="local-6989586621683124087"><span class="annot"><a href="#local-6989586621683124087"><span class="hs-identifier hs-var">promise_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#newSysLocalMDs"><span class="hs-identifier hs-type">newSysLocalMDs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124078"><span class="hs-identifier hs-type">jsval_ty</span></a></span><span>
</span><span id="line-319"></span><span>      </span><span id="local-6989586621683124088"><span class="annot"><a href="#local-6989586621683124088"><span class="hs-identifier hs-var">blockPromise_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.Wasm.Prim.Imports&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;stg_blockPromise&quot;</span></span><span>
</span><span id="line-320"></span><span>      </span><span id="local-6989586621683124089"><span class="annot"><a href="#local-6989586621683124089"><span class="hs-identifier hs-var">msgPromise_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-321"></span><span>        </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.Wasm.Prim.Imports&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;stg_messagePromise&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-type">ffiType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124063"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-322"></span><span>      </span><span id="local-6989586621683124091"><span class="annot"><a href="#local-6989586621683124091"><span class="hs-identifier hs-var">unsafeDupablePerformIO_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-323"></span><span>        </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span>
</span><span id="line-324"></span><span>          </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.IO.Unsafe&quot;</span></span><span>
</span><span id="line-325"></span><span>          </span><span class="annot"><span class="hs-string">&quot;unsafeDupablePerformIO&quot;</span></span><span>
</span><span id="line-326"></span><span>      </span><span id="local-6989586621683124092"><span class="annot"><a href="#local-6989586621683124092"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-327"></span><span>        </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#importBindingRHS"><span class="hs-identifier hs-type">importBindingRHS</span></a></span><span>
</span><span id="line-328"></span><span>          </span><span class="annot"><a href="#local-6989586621683124054"><span class="hs-identifier hs-type">mUnitId</span></a></span><span>
</span><span id="line-329"></span><span>          </span><span class="annot"><a href="GHC.Types.ForeignCall.html#PlaySafe"><span class="hs-identifier hs-type">PlaySafe</span></a></span><span>
</span><span id="line-330"></span><span>          </span><span class="annot"><a href="#local-6989586621683124056"><span class="hs-identifier hs-type">cfun_name</span></a></span><span>
</span><span id="line-331"></span><span>          </span><span class="annot"><a href="#local-6989586621683124058"><span class="hs-identifier hs-type">tvs</span></a></span><span>
</span><span id="line-332"></span><span>          </span><span class="annot"><a href="#local-6989586621683124061"><span class="hs-identifier hs-type">arg_tys</span></a></span><span>
</span><span id="line-333"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-type">mkTyConApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124076"><span class="hs-identifier hs-type">io_tycon</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683124078"><span class="hs-identifier hs-type">jsval_ty</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683124064"><span class="hs-identifier hs-type">is_io</span></a></span><span>
</span><span id="line-335"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier hs-type">id</span></span><span>
</span><span id="line-336"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683124094"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124094"><span class="hs-identifier hs-var">m_res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-337"></span><span>                  </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124091"><span class="hs-identifier hs-var">unsafeDupablePerformIO_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124063"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124094"><span class="hs-identifier hs-var">m_res</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-338"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>          </span><span class="hs-comment">-- (m_promise :: IO JSVal) &gt;&gt;= (\promise -&gt; return (stg_blockPromise promise msgPromise))</span><span>
</span><span id="line-340"></span><span>          </span><span class="hs-comment">-- stg_blockPromise returns the thunk</span><span>
</span><span id="line-341"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683124096"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124096"><span class="hs-identifier hs-var">m_promise</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-342"></span><span>                </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span>
</span><span id="line-343"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124082"><span class="hs-identifier hs-var">bindIO_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124078"><span class="hs-identifier hs-var">jsval_ty</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-345"></span><span>                    </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124063"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-346"></span><span>                    </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124096"><span class="hs-identifier hs-var">m_promise</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-347"></span><span>                    </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124087"><span class="hs-identifier hs-var">promise_id</span></a></span><span>
</span><span id="line-348"></span><span>                      </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span>
</span><span id="line-349"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124085"><span class="hs-identifier hs-var">returnIO_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124063"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-351"></span><span>                          </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span>
</span><span id="line-352"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124088"><span class="hs-identifier hs-var">blockPromise_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>                            </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124063"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124087"><span class="hs-identifier hs-var">promise_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124089"><span class="hs-identifier hs-var">msgPromise_id</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-354"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-355"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-356"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span>
</span><span id="line-358"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683124051"><span class="hs-identifier hs-type">fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124092"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124052"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-359"></span><span>          </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CHeader"><span class="hs-identifier hs-type">CHeader</span></a></span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#commonCDecls"><span class="hs-identifier hs-type">commonCDecls</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-360"></span><span>          </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#importCStub"><span class="hs-identifier hs-type">importCStub</span></a></span><span>
</span><span id="line-361"></span><span>            </span><span class="annot"><a href="GHC.Types.ForeignCall.html#PlaySafe"><span class="hs-identifier hs-type">PlaySafe</span></a></span><span>
</span><span id="line-362"></span><span>            </span><span class="annot"><a href="#local-6989586621683124056"><span class="hs-identifier hs-type">cfun_name</span></a></span><span>
</span><span id="line-363"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-type">scaledThing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124061"><span class="hs-identifier hs-type">arg_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>            </span><span class="annot"><a href="#local-6989586621683124078"><span class="hs-identifier hs-type">jsval_ty</span></a></span><span>
</span><span id="line-365"></span><span>            </span><span class="annot"><a href="#local-6989586621683124067"><span class="hs-identifier hs-type">js_src</span></a></span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#uniqueCFunName"><span class="hs-identifier hs-type">uniqueCFunName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span>
</span><span id="line-369"></span><span id="uniqueCFunName"><span class="annot"><span class="annottext">uniqueCFunName :: DsM FastString
</span><a href="GHC.HsToCore.Foreign.Wasm.html#uniqueCFunName"><span class="hs-identifier hs-var hs-var">uniqueCFunName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-370"></span><span>  </span><span id="local-6989586621683124098"><span class="annot"><a href="#local-6989586621683124098"><span class="hs-identifier hs-var">cfun_num</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DsGblEnv -&gt; IORef (ModuleEnv Int)
</span><a href="GHC.HsToCore.Types.html#ds_next_wrapper_num"><span class="hs-identifier hs-var">ds_next_wrapper_num</span></a></span><span> </span><span class="annot"><span class="annottext">(DsGblEnv -&gt; IORef (ModuleEnv Int))
-&gt; IOEnv (Env DsGblEnv DsLclEnv) DsGblEnv
-&gt; IOEnv (Env DsGblEnv DsLclEnv) (IORef (ModuleEnv Int))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IOEnv (Env DsGblEnv DsLclEnv) DsGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-371"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Env.html#mkWrapperName"><span class="hs-identifier hs-type">mkWrapperName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124098"><span class="hs-identifier hs-type">cfun_num</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;ghc_wasm_jsffi&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#importBindingRHS"><span class="hs-identifier hs-type">importBindingRHS</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-374"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Unit"><span class="hs-identifier hs-type">Unit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-375"></span><span>  </span><span class="annot"><a href="GHC.Types.ForeignCall.html#Safety"><span class="hs-identifier hs-type">Safety</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-376"></span><span>  </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-379"></span><span>  </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-380"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-381"></span><span>  </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-382"></span><span id="importBindingRHS"><span class="annot"><span class="annottext">importBindingRHS :: Maybe Unit
-&gt; Safety
-&gt; FastString
-&gt; [Id]
-&gt; [Scaled Type]
-&gt; Type
-&gt; (CoreExpr -&gt; CoreExpr)
-&gt; DsM CoreExpr
</span><a href="GHC.HsToCore.Foreign.Wasm.html#importBindingRHS"><span class="hs-identifier hs-var hs-var">importBindingRHS</span></a></span></span><span> </span><span id="local-6989586621683124103"><span class="annot"><span class="annottext">Maybe Unit
</span><a href="#local-6989586621683124103"><span class="hs-identifier hs-var">mUnitId</span></a></span></span><span> </span><span id="local-6989586621683124104"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621683124104"><span class="hs-identifier hs-var">safety</span></a></span></span><span> </span><span id="local-6989586621683124105"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124105"><span class="hs-identifier hs-var">cfun_name</span></a></span></span><span> </span><span id="local-6989586621683124106"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124106"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621683124107"><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683124107"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span> </span><span id="local-6989586621683124108"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124108"><span class="hs-identifier hs-var">orig_res_ty</span></a></span></span><span> </span><span id="local-6989586621683124109"><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621683124109"><span class="hs-identifier hs-var">res_trans</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-384"></span><span>    </span><span id="local-6989586621683124110"><span class="annot"><a href="#local-6989586621683124110"><span class="hs-identifier hs-var">ccall_uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf DsGblEnv DsLclEnv Unique
forall gbl lcl. TcRnIf gbl lcl Unique
</span><a href="GHC.Tc.Utils.Monad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a></span><span>
</span><span id="line-385"></span><span>    </span><span id="local-6989586621683124111"><span class="annot"><a href="#local-6989586621683124111"><span class="hs-identifier hs-var">args_unevaled</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#newSysLocalsDs"><span class="hs-identifier hs-type">newSysLocalsDs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124107"><span class="hs-identifier hs-type">arg_tys</span></a></span><span>
</span><span id="line-386"></span><span>    </span><span id="local-6989586621683124113"><span class="annot"><a href="#local-6989586621683124113"><span class="hs-identifier hs-var">args_evaled</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#newSysLocalsDs"><span class="hs-identifier hs-type">newSysLocalsDs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124107"><span class="hs-identifier hs-type">arg_tys</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-comment">-- ccall_action_ty: type of the_call, State# RealWorld -&gt; (# State# RealWorld, a #)</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-comment">-- res_wrapper: turn the_call to (IO a) or a</span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683124114"><span class="annot"><a href="#local-6989586621683124114"><span class="hs-identifier hs-var">ccall_action_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124115"><span class="annot"><a href="#local-6989586621683124115"><span class="hs-identifier hs-var">res_wrapper</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitIOType_maybe"><span class="hs-identifier hs-type">tcSplitIOType_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124108"><span class="hs-identifier hs-type">orig_res_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-390"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683124116"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683124116"><span class="hs-identifier hs-var">io_tycon</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124117"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124117"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-391"></span><span>        </span><span id="local-6989586621683124118"><span class="annot"><a href="#local-6989586621683124118"><span class="hs-identifier hs-var">s0_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; DsM Id
</span><a href="GHC.HsToCore.Monad.html#newSysLocalMDs"><span class="hs-identifier hs-var">newSysLocalMDs</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-var">realWorldStatePrimTy</span></a></span><span>
</span><span id="line-392"></span><span>        </span><span id="local-6989586621683124120"><span class="annot"><a href="#local-6989586621683124120"><span class="hs-identifier hs-var">s1_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#newSysLocalMDs"><span class="hs-identifier hs-type">newSysLocalMDs</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span>
</span><span id="line-393"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683124121"><span class="annot"><a href="#local-6989586621683124121"><span class="hs-identifier hs-var hs-var">io_data_con</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; DataCon
</span><a href="GHC.Core.TyCon.html#tyConSingleDataCon"><span class="hs-identifier hs-var">tyConSingleDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683124116"><span class="hs-identifier hs-var">io_tycon</span></a></span><span>
</span><span id="line-394"></span><span>            </span><span id="local-6989586621683124123"><span class="annot"><a href="#local-6989586621683124123"><span class="hs-identifier hs-var hs-var">toIOCon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Id
</span><a href="GHC.Core.DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683124121"><span class="hs-identifier hs-var">io_data_con</span></a></span><span>
</span><span id="line-395"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621683124125"><span class="annot"><a href="#local-6989586621683124125"><span class="hs-identifier hs-var">ccall_res_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124126"><span class="annot"><a href="#local-6989586621683124126"><span class="hs-identifier hs-var">wrap</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="#local-6989586621683124117"><span class="hs-identifier hs-type">res_ty</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-type">`eqType`</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#unitTy"><span class="hs-identifier hs-type">unitTy</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-397"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#mkTupleTy"><span class="hs-identifier hs-type">mkTupleTy</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-type">Unboxed</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-398"></span><span>                    </span><span class="hs-glyph">\</span><span id="local-6989586621683124131"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124131"><span class="hs-identifier hs-var">the_call</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-399"></span><span>                      </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span>
</span><span id="line-400"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124123"><span class="hs-identifier hs-var">toIOCon</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124117"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-402"></span><span>                          </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124118"><span class="hs-identifier hs-var">s0_id</span></a></span><span>
</span><span id="line-403"></span><span>                            </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Scaled Type -&gt; Type -&gt; [CoreAlt] -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkWildCase"><span class="hs-identifier hs-var">mkWildCase</span></a></span><span>
</span><span id="line-404"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124131"><span class="hs-identifier hs-var">the_call</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124118"><span class="hs-identifier hs-var">s0_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Scaled Type
forall a. a -&gt; Scaled a
</span><a href="GHC.Core.Type.html#unrestricted"><span class="hs-identifier hs-var">unrestricted</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124125"><span class="hs-identifier hs-var">ccall_res_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Boxity -&gt; [Type] -&gt; Type
</span><a href="GHC.Builtin.Types.html#mkTupleTy"><span class="hs-identifier hs-var">mkTupleTy</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-var">realWorldStatePrimTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#unitTy"><span class="hs-identifier hs-var">unitTy</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>                              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; CoreExpr -&gt; CoreAlt
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span>
</span><span id="line-408"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Boxity -&gt; Int -&gt; DataCon
</span><a href="GHC.Builtin.Types.html#tupleDataCon"><span class="hs-identifier hs-var">tupleDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>                                  </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124120"><span class="hs-identifier hs-var">s1_id</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-410"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreExpr] -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkCoreUnboxedTuple"><span class="hs-identifier hs-var">mkCoreUnboxedTuple</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124120"><span class="hs-identifier hs-var">s1_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="GHC.Core.Make.html#unitExpr"><span class="hs-identifier hs-var">unitExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>                              </span><span class="hs-special">]</span><span>
</span><span id="line-412"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-413"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-415"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#mkTupleTy"><span class="hs-identifier hs-type">mkTupleTy</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-type">Unboxed</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683124117"><span class="hs-identifier hs-type">res_ty</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-416"></span><span>                    </span><span class="hs-glyph">\</span><span id="local-6989586621683124140"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124140"><span class="hs-identifier hs-var">the_call</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124123"><span class="hs-identifier hs-var">toIOCon</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124117"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124140"><span class="hs-identifier hs-var">the_call</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-417"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkVisFunTyMany"><span class="hs-operator hs-type">`mkVisFunTyMany`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124125"><span class="hs-identifier hs-type">ccall_res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683124126"><span class="hs-identifier hs-type">wrap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TyCon, Type)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-420"></span><span>        </span><span id="local-6989586621683124142"><span class="annot"><a href="#local-6989586621683124142"><span class="hs-identifier hs-var">unsafeDupablePerformIO_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-421"></span><span>          </span><span class="annot"><span class="annottext">FastString -&gt; [Char] -&gt; DsM Id
</span><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-var">lookupGhcInternalVarId</span></a></span><span>
</span><span id="line-422"></span><span>            </span><span class="annot"><span class="annottext">FastString
</span><span class="hs-string">&quot;GHC.Internal.IO.Unsafe&quot;</span></span><span>
</span><span id="line-423"></span><span>            </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;unsafeDupablePerformIO&quot;</span></span><span>
</span><span id="line-424"></span><span>        </span><span id="local-6989586621683124143"><span class="annot"><a href="#local-6989586621683124143"><span class="hs-identifier hs-var">io_data_con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#dsLookupDataCon"><span class="hs-identifier hs-type">dsLookupDataCon</span></a></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#ioDataConName"><span class="hs-identifier hs-type">ioDataConName</span></a></span><span>
</span><span id="line-425"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683124146"><span class="annot"><a href="#local-6989586621683124146"><span class="hs-identifier hs-var hs-var">ccall_res_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-426"></span><span>              </span><span class="annot"><span class="annottext">Boxity -&gt; [Type] -&gt; Type
</span><a href="GHC.Builtin.Types.html#mkTupleTy"><span class="hs-identifier hs-var">mkTupleTy</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-var">realWorldStatePrimTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124108"><span class="hs-identifier hs-var">orig_res_ty</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-427"></span><span>            </span><span id="local-6989586621683124147"><span class="annot"><a href="#local-6989586621683124147"><span class="hs-identifier hs-var hs-var">toIOCon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Id
</span><a href="GHC.Core.DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621683124143"><span class="hs-identifier hs-var">io_data_con</span></a></span><span>
</span><span id="line-428"></span><span>            </span><span id="local-6989586621683124148"><span class="annot"><a href="#local-6989586621683124148"><span class="hs-identifier hs-var hs-var">wrap</span></a></span></span><span> </span><span id="local-6989586621683124149"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124149"><span class="hs-identifier hs-var">the_call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-429"></span><span>              </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span>
</span><span id="line-430"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124142"><span class="hs-identifier hs-var">unsafeDupablePerformIO_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124108"><span class="hs-identifier hs-var">orig_res_ty</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-432"></span><span>                  </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124147"><span class="hs-identifier hs-var">toIOCon</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124108"><span class="hs-identifier hs-var">orig_res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124149"><span class="hs-identifier hs-var">the_call</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-433"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-434"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-type">realWorldStatePrimTy</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#mkVisFunTyMany"><span class="hs-operator hs-type">`mkVisFunTyMany`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124146"><span class="hs-identifier hs-type">ccall_res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683124148"><span class="hs-identifier hs-type">wrap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683124150"><span class="annot"><a href="#local-6989586621683124150"><span class="hs-identifier hs-var hs-var">cfun_fcall</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-436"></span><span>          </span><span class="annot"><span class="annottext">CCallSpec -&gt; ForeignCall
</span><a href="GHC.Types.ForeignCall.html#CCall"><span class="hs-identifier hs-var">CCall</span></a></span><span>
</span><span id="line-437"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CCallTarget -&gt; CCallConv -&gt; Safety -&gt; CCallSpec
</span><a href="GHC.Types.ForeignCall.html#CCallSpec"><span class="hs-identifier hs-var">CCallSpec</span></a></span><span>
</span><span id="line-438"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceText -&gt; FastString -&gt; Maybe Unit -&gt; Bool -&gt; CCallTarget
</span><a href="GHC.Types.ForeignCall.html#StaticTarget"><span class="hs-identifier hs-var">StaticTarget</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><a href="GHC.Types.SourceText.html#NoSourceText"><span class="hs-identifier hs-var">NoSourceText</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124105"><span class="hs-identifier hs-var">cfun_name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Unit
</span><a href="#local-6989586621683124103"><span class="hs-identifier hs-var">mUnitId</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>                </span><span class="annot"><span class="annottext">CCallConv
</span><a href="GHC.Types.ForeignCall.html#CCallConv"><span class="hs-identifier hs-var">CCallConv</span></a></span><span>
</span><span id="line-440"></span><span>                </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621683124104"><span class="hs-identifier hs-var">safety</span></a></span><span>
</span><span id="line-441"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span>        </span><span id="local-6989586621683124155"><span class="annot"><a href="#local-6989586621683124155"><span class="hs-identifier hs-var hs-var">call_app</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-443"></span><span>          </span><span class="annot"><span class="annottext">Unique -&gt; ForeignCall -&gt; [CoreExpr] -&gt; Type -&gt; CoreExpr
</span><a href="GHC.HsToCore.Foreign.Call.html#mkFCall"><span class="hs-identifier hs-var">mkFCall</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621683124110"><span class="hs-identifier hs-var">ccall_uniq</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignCall
</span><a href="#local-6989586621683124150"><span class="hs-identifier hs-var">cfun_fcall</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; CoreExpr) -&gt; [Id] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124113"><span class="hs-identifier hs-var">args_evaled</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124114"><span class="hs-identifier hs-var">ccall_action_ty</span></a></span><span>
</span><span id="line-444"></span><span>        </span><span id="local-6989586621683124157"><span class="annot"><a href="#local-6989586621683124157"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-445"></span><span>          </span><span class="annot"><span class="annottext">[Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkCoreLams"><span class="hs-identifier hs-var">mkCoreLams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124106"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124111"><span class="hs-identifier hs-var">args_unevaled</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>            </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Id, Id) -&gt; CoreExpr -&gt; CoreExpr)
-&gt; CoreExpr -&gt; [(Id, Id)] -&gt; CoreExpr
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span>
</span><span id="line-447"></span><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621683124159"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124159"><span class="hs-identifier hs-var">arg_u</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124160"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124160"><span class="hs-identifier hs-var">arg_e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683124161"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124161"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkDefaultCase"><span class="hs-identifier hs-var">mkDefaultCase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124159"><span class="hs-identifier hs-var">arg_u</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124160"><span class="hs-identifier hs-var">arg_e</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124161"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>              </span><span class="hs-comment">-- res_trans transforms the result. When desugaring</span><span>
</span><span id="line-449"></span><span>              </span><span class="hs-comment">-- JSFFI sync imports, the result is just (IO a) or a,</span><span>
</span><span id="line-450"></span><span>              </span><span class="hs-comment">-- and res_trans is id; for async cases, the result is</span><span>
</span><span id="line-451"></span><span>              </span><span class="hs-comment">-- always (IO JSVal), and res_trans will wrap it in a</span><span>
</span><span id="line-452"></span><span>              </span><span class="hs-comment">-- thunk that has the original return type. This way, we</span><span>
</span><span id="line-453"></span><span>              </span><span class="hs-comment">-- can reuse most of the RHS generation logic for both</span><span>
</span><span id="line-454"></span><span>              </span><span class="hs-comment">-- sync/async imports.</span><span>
</span><span id="line-455"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621683124109"><span class="hs-identifier hs-var">res_trans</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621683124115"><span class="hs-identifier hs-var">res_wrapper</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124155"><span class="hs-identifier hs-var">call_app</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [(Id, Id)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124111"><span class="hs-identifier hs-var">args_unevaled</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124113"><span class="hs-identifier hs-var">args_evaled</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621683124157"><span class="hs-identifier hs-type">rhs</span></a></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#importCStub"><span class="hs-identifier hs-type">importCStub</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.ForeignCall.html#Safety"><span class="hs-identifier hs-type">Safety</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CStub"><span class="hs-identifier hs-type">CStub</span></a></span><span>
</span><span id="line-460"></span><span id="importCStub"><span class="annot"><span class="annottext">importCStub :: Safety -&gt; FastString -&gt; [Type] -&gt; Type -&gt; [Char] -&gt; CStub
</span><a href="GHC.HsToCore.Foreign.Wasm.html#importCStub"><span class="hs-identifier hs-var hs-var">importCStub</span></a></span></span><span> </span><span id="local-6989586621683124163"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621683124163"><span class="hs-identifier hs-var">safety</span></a></span></span><span> </span><span id="local-6989586621683124164"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124164"><span class="hs-identifier hs-var">cfun_name</span></a></span></span><span> </span><span id="local-6989586621683124165"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683124165"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span> </span><span id="local-6989586621683124166"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124166"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span id="local-6989586621683124167"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124167"><span class="hs-identifier hs-var">js_src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [CLabel] -&gt; [CLabel] -&gt; CStub
</span><a href="GHC.Types.ForeignStubs.html#CStub"><span class="hs-identifier hs-var">CStub</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124169"><span class="hs-identifier hs-var">c_doc</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-462"></span><span>    </span><span id="local-6989586621683124170"><span class="annot"><span class="annottext">import_name :: [Char]
</span><a href="#local-6989586621683124170"><span class="hs-identifier hs-var hs-var">import_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [Char] -&gt; [Char]
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe [Char] -&gt; [Char]) -&gt; Maybe [Char] -&gt; [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; Maybe [Char]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Maybe [a]
</span><span class="hs-identifier hs-var">stripPrefix</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ghczuwasmzujsffi&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; [Char]
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124164"><span class="hs-identifier hs-var">cfun_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>    </span><span id="local-6989586621683124172"><span class="annot"><span class="annottext">import_asm :: SDoc
</span><a href="#local-6989586621683124172"><span class="hs-identifier hs-var hs-var">import_asm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-464"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__asm__&quot;</span></span><span>
</span><span id="line-465"></span><span>        </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span>
</span><span id="line-466"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-467"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124177"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683124177"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124177"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-469"></span><span>                    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;.section .custom_section.ghc_wasm_jsffi,\&quot;\&quot;,@\n&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-470"></span><span>                      </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;.asciz \&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124170"><span class="hs-identifier hs-var">import_name</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;\&quot;\n&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-471"></span><span>                      </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;.asciz \&quot;&quot;</span></span><span>
</span><span id="line-472"></span><span>                        </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621683124163"><span class="hs-identifier hs-var">safety</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-473"></span><span>                               </span><span class="annot"><span class="annottext">Safety
</span><a href="GHC.Types.ForeignCall.html#PlayRisky"><span class="hs-identifier hs-var">PlayRisky</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;(&quot;</span></span><span>
</span><span id="line-474"></span><span>                               </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;async (&quot;</span></span><span>
</span><span id="line-475"></span><span>                           </span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>                        </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [[Char]] -&gt; [Char]
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">intercalate</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;,&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;$&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124178"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683124178"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124178"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683124165"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-477"></span><span>                        </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;)\&quot;\n&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-478"></span><span>                      </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;.asciz &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124167"><span class="hs-identifier hs-var">js_src</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-479"></span><span>                    </span><span class="hs-special">]</span><span>
</span><span id="line-480"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-481"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>        </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#semi"><span class="hs-identifier hs-var">semi</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span id="local-6989586621683124180"><span class="annot"><span class="annottext">import_attr :: SDoc
</span><a href="#local-6989586621683124180"><span class="hs-identifier hs-var hs-var">import_attr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-484"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__attribute__&quot;</span></span><span>
</span><span id="line-485"></span><span>        </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span>
</span><span id="line-486"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span>
</span><span id="line-487"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span>
</span><span id="line-488"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span>
</span><span id="line-489"></span><span>                      </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span>
</span><span id="line-490"></span><span>                      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124184"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124186"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683124184"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124184"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124186"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124186"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-492"></span><span>                            </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;import_module&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ghc_wasm_jsffi&quot;</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;import_name&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124170"><span class="hs-identifier hs-var">import_name</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-493"></span><span>                      </span><span class="hs-special">]</span><span>
</span><span id="line-494"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-496"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>    </span><span id="local-6989586621683124187"><span class="annot"><span class="annottext">import_proto :: SDoc
</span><a href="#local-6989586621683124187"><span class="hs-identifier hs-var hs-var">import_proto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-498"></span><span>      </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124188"><span class="hs-identifier hs-var">import_res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124170"><span class="hs-identifier hs-var">import_name</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124190"><span class="hs-identifier hs-var">import_args</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#semi"><span class="hs-identifier hs-var">semi</span></a></span><span>
</span><span id="line-499"></span><span>    </span><span id="local-6989586621683124188"><span class="annot"><span class="annottext">import_res_ty :: SDoc
</span><a href="#local-6989586621683124188"><span class="hs-identifier hs-var hs-var">import_res_ty</span></a></span></span><span>
</span><span id="line-500"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124166"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#unitTy"><span class="hs-identifier hs-var">unitTy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;void&quot;</span></span><span>
</span><span id="line-501"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Hs&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Char]
</span><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-var">ffiType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124166"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>    </span><span id="local-6989586621683124191"><span class="annot"><span class="annottext">import_arg_list :: [SDoc]
</span><a href="#local-6989586621683124191"><span class="hs-identifier hs-var hs-var">import_arg_list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-503"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Hs&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Char]
</span><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-var">ffiType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124192"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'a'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124195"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-504"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683124195"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124195"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124192"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124192"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Type] -&gt; [(Int, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683124165"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-505"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-506"></span><span>    </span><span id="local-6989586621683124190"><span class="annot"><span class="annottext">import_args :: SDoc
</span><a href="#local-6989586621683124190"><span class="hs-identifier hs-var hs-var">import_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621683124191"><span class="hs-identifier hs-var">import_arg_list</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-507"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;void&quot;</span></span><span>
</span><span id="line-508"></span><span>      </span><span class="annot"><span class="annottext">[SDoc]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621683124191"><span class="hs-identifier hs-var">import_arg_list</span></a></span><span>
</span><span id="line-509"></span><span>    </span><span id="local-6989586621683124196"><span class="annot"><span class="annottext">cfun_proto :: SDoc
</span><a href="#local-6989586621683124196"><span class="hs-identifier hs-var hs-var">cfun_proto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124197"><span class="hs-identifier hs-var">cfun_res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124164"><span class="hs-identifier hs-var">cfun_name</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124199"><span class="hs-identifier hs-var">cfun_args</span></a></span><span>
</span><span id="line-510"></span><span>    </span><span id="local-6989586621683124200"><span class="annot"><span class="annottext">cfun_ret :: SDoc
</span><a href="#local-6989586621683124200"><span class="hs-identifier hs-var hs-var">cfun_ret</span></a></span></span><span>
</span><span id="line-511"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124166"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#unitTy"><span class="hs-identifier hs-var">unitTy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124201"><span class="hs-identifier hs-var">cfun_call_import</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#semi"><span class="hs-identifier hs-var">semi</span></a></span><span>
</span><span id="line-512"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;return&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124201"><span class="hs-identifier hs-var">cfun_call_import</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#semi"><span class="hs-identifier hs-var">semi</span></a></span><span>
</span><span id="line-513"></span><span>    </span><span id="local-6989586621683124211"><span class="annot"><span class="annottext">cfun_make_arg :: Type -&gt; doc -&gt; doc
</span><a href="#local-6989586621683124211"><span class="hs-identifier hs-var hs-var">cfun_make_arg</span></a></span></span><span> </span><span id="local-6989586621683124212"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124212"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span> </span><span id="local-6989586621683124213"><span class="annot"><span class="annottext">doc
</span><a href="#local-6989586621683124213"><span class="hs-identifier hs-var">arg_val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-514"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; doc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rts_get&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Char]
</span><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-var">ffiType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124212"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">doc -&gt; doc -&gt; doc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">doc -&gt; doc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="annot"><span class="annottext">doc
</span><a href="#local-6989586621683124213"><span class="hs-identifier hs-var">arg_val</span></a></span><span>
</span><span id="line-515"></span><span>    </span><span id="local-6989586621683124214"><span class="annot"><span class="annottext">cfun_make_ret :: SDoc -&gt; SDoc
</span><a href="#local-6989586621683124214"><span class="hs-identifier hs-var hs-var">cfun_make_ret</span></a></span></span><span> </span><span id="local-6989586621683124215"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124215"><span class="hs-identifier hs-var">ret_val</span></a></span></span><span>
</span><span id="line-516"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124166"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#unitTy"><span class="hs-identifier hs-var">unitTy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124215"><span class="hs-identifier hs-var">ret_val</span></a></span><span>
</span><span id="line-517"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-518"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rts_mk&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Char]
</span><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-var">ffiType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124166"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>            </span><span class="hs-comment">-- We can cheat a little bit here since there's only</span><span>
</span><span id="line-520"></span><span>            </span><span class="hs-comment">-- MainCapability in the single-threaded RTS anyway, so no</span><span>
</span><span id="line-521"></span><span>            </span><span class="hs-comment">-- need to call rts_unsafeGetMyCapability().</span><span>
</span><span id="line-522"></span><span>            </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;&amp;MainCapability&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124215"><span class="hs-identifier hs-var">ret_val</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>    </span><span id="local-6989586621683124201"><span class="annot"><span class="annottext">cfun_call_import :: SDoc
</span><a href="#local-6989586621683124201"><span class="hs-identifier hs-var hs-var">cfun_call_import</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-524"></span><span>      </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="#local-6989586621683124214"><span class="hs-identifier hs-var">cfun_make_ret</span></a></span><span>
</span><span id="line-525"></span><span>        </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124170"><span class="hs-identifier hs-var">import_name</span></a></span><span>
</span><span id="line-526"></span><span>        </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span>
</span><span id="line-527"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span>
</span><span id="line-528"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span>
</span><span id="line-529"></span><span>                  </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span>
</span><span id="line-530"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc -&gt; SDoc
forall {doc}. IsLine doc =&gt; Type -&gt; doc -&gt; doc
</span><a href="#local-6989586621683124211"><span class="hs-identifier hs-var">cfun_make_arg</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124216"><span class="hs-identifier hs-var">arg_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'a'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124217"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683124216"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124216"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124217"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124217"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Int] -&gt; [(Type, Int)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683124165"><span class="hs-identifier hs-var">arg_tys</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-532"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-533"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>    </span><span id="local-6989586621683124197"><span class="annot"><span class="annottext">cfun_res_ty :: SDoc
</span><a href="#local-6989586621683124197"><span class="hs-identifier hs-var hs-var">cfun_res_ty</span></a></span></span><span>
</span><span id="line-536"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124166"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#unitTy"><span class="hs-identifier hs-var">unitTy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;void&quot;</span></span><span>
</span><span id="line-537"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;HaskellObj&quot;</span></span><span>
</span><span id="line-538"></span><span>    </span><span id="local-6989586621683124218"><span class="annot"><span class="annottext">cfun_arg_list :: [SDoc]
</span><a href="#local-6989586621683124218"><span class="hs-identifier hs-var hs-var">cfun_arg_list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-539"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;HaskellObj&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'a'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124219"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683124219"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124219"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683124165"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-540"></span><span>    </span><span id="local-6989586621683124199"><span class="annot"><span class="annottext">cfun_args :: SDoc
</span><a href="#local-6989586621683124199"><span class="hs-identifier hs-var hs-var">cfun_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621683124218"><span class="hs-identifier hs-var">cfun_arg_list</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-541"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;void&quot;</span></span><span>
</span><span id="line-542"></span><span>      </span><span class="annot"><span class="annottext">[SDoc]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621683124218"><span class="hs-identifier hs-var">cfun_arg_list</span></a></span><span>
</span><span id="line-543"></span><span>    </span><span id="local-6989586621683124169"><span class="annot"><span class="annottext">c_doc :: SDoc
</span><a href="#local-6989586621683124169"><span class="hs-identifier hs-var hs-var">c_doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-544"></span><span>      </span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.HsToCore.Foreign.Wasm.html#commonCDecls"><span class="hs-identifier hs-var">commonCDecls</span></a></span><span>
</span><span id="line-545"></span><span>        </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124172"><span class="hs-identifier hs-var">import_asm</span></a></span><span>
</span><span id="line-546"></span><span>        </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124180"><span class="hs-identifier hs-var">import_attr</span></a></span><span>
</span><span id="line-547"></span><span>        </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124187"><span class="hs-identifier hs-var">import_proto</span></a></span><span>
</span><span id="line-548"></span><span>        </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124196"><span class="hs-identifier hs-var">cfun_proto</span></a></span><span>
</span><span id="line-549"></span><span>        </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124200"><span class="hs-identifier hs-var">cfun_ret</span></a></span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span class="hs-comment">{-

Note [Desugaring JSFFI static export]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A JSFFI static export wraps a top-level Haskell binding as a wasm
module export that can be called in JavaScript as an async function:

foreign export javascript &quot;plus&quot;
  (+) :: Int -&gt; Int -&gt; Int

Just like generating C stub for a JSFFI import, we need to generate C
stub for a JSFFI export as well:

__attribute__((export_name(&quot;plus&quot;)))
HsJSVal plus(HsInt a1, HsInt a2) { ... }

At link time, you need to pass -optl-Wl,--export=plus,--export=... to
specify your entrypoint function symbols as roots of wasm-ld link-time
garbage collection. As for the auto-generated exports when desugaring
the JSFFI dynamic exports, they will be transitively included as well
due to the export_name attribute.

For each JSFFI static export, we create an internal worker function
which takes the same arguments as the exported Haskell binding, but
always returns (IO JSVal). Its RHS simply applies the arguments to the
original binding, then applies a runIO/runNonIO top handler function
to the result. The top handler creates a JavaScript Promise that
stands for Haskell evaluation result, schedules Haskell computation to
happen, and the Promise will eventually be resolved with the result or
rejected with an exception. That Promise is what we return in the C
stub function. See Note [Async JSFFI scheduler] for detailed
explanation.

There's nothing else to explain about the C stub function body; just
like C FFI exports, it calls rts_mk* to box the arguments, rts_apply
to apply them to the worker function, evaluates the result, then
unboxes the resulting Promise using rts_getJSVal and returns it.

Now, in JavaScript, once the wasm instance is initialized, you can
directly call these exports and await them, as if they're real
JavaScript async functions.

-}</span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSExport"><span class="hs-identifier hs-type">dsWasmJSExport</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-597"></span><span>  </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-598"></span><span>  </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-599"></span><span>  </span><span class="annot"><a href="GHC.Types.ForeignCall.html#CLabelString"><span class="hs-identifier hs-type">CLabelString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-600"></span><span>  </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CHeader"><span class="hs-identifier hs-type">CHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CStub"><span class="hs-identifier hs-type">CStub</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.HsToCore.Foreign.Utils.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-601"></span><span id="dsWasmJSExport"><span class="annot"><span class="annottext">dsWasmJSExport :: Id
-&gt; Coercion
-&gt; FastString
-&gt; DsM (CHeader, CStub, [Char], [Id], [Binding])
</span><a href="GHC.HsToCore.Foreign.Wasm.html#dsWasmJSExport"><span class="hs-identifier hs-var hs-var">dsWasmJSExport</span></a></span></span><span> </span><span id="local-6989586621683124223"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124223"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span> </span><span id="local-6989586621683124224"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683124224"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621683124225"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124225"><span class="hs-identifier hs-var">ext_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-602"></span><span>  </span><span id="local-6989586621683124226"><span class="annot"><a href="#local-6989586621683124226"><span class="hs-identifier hs-var">work_uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRnIf DsGblEnv DsLclEnv Unique
forall gbl lcl. TcRnIf gbl lcl Unique
</span><a href="GHC.Tc.Utils.Monad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a></span><span>
</span><span id="line-603"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683124227"><span class="annot"><a href="#local-6989586621683124227"><span class="hs-identifier hs-var hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683124224"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-604"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683124229"><span class="annot"><a href="#local-6989586621683124229"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124230"><span class="annot"><a href="#local-6989586621683124230"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitForAllInvisTyVars"><span class="hs-identifier hs-type">tcSplitForAllInvisTyVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124227"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-605"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683124231"><span class="annot"><a href="#local-6989586621683124231"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124232"><span class="annot"><a href="#local-6989586621683124232"><span class="hs-identifier hs-var">orig_res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitFunTys"><span class="hs-identifier hs-type">tcSplitFunTys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124230"><span class="hs-identifier hs-type">fun_ty</span></a></span><span>
</span><span id="line-606"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621683124233"><span class="annot"><a href="#local-6989586621683124233"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124234"><span class="annot"><a href="#local-6989586621683124234"><span class="hs-identifier hs-var">is_io</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcSplitIOType_maybe"><span class="hs-identifier hs-type">tcSplitIOType_maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124232"><span class="hs-identifier hs-type">orig_res_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-607"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124235"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124235"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124235"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-608"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TyCon, Type)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124232"><span class="hs-identifier hs-var">orig_res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124236"><span class="annot"><a href="#local-6989586621683124236"><span class="hs-identifier hs-var">res_ty_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#splitTyConApp"><span class="hs-identifier hs-type">splitTyConApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124233"><span class="hs-identifier hs-type">res_ty</span></a></span><span>
</span><span id="line-610"></span><span>      </span><span id="local-6989586621683124238"><span class="annot"><a href="#local-6989586621683124238"><span class="hs-identifier hs-var hs-var">res_ty_str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Char]
</span><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-var">ffiType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124233"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-611"></span><span>  </span><span id="local-6989586621683124239"><span class="annot"><a href="#local-6989586621683124239"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Monad.html#newSysLocalsDs"><span class="hs-identifier hs-type">newSysLocalsDs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124231"><span class="hs-identifier hs-type">arg_tys</span></a></span><span>
</span><span id="line-612"></span><span>  </span><span id="local-6989586621683124240"><span class="annot"><a href="#local-6989586621683124240"><span class="hs-identifier hs-var">promiseRes_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-613"></span><span>    </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.Wasm.Prim.Exports&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;js_promiseResolve&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621683124238"><span class="hs-identifier hs-type">res_ty_str</span></a></span><span>
</span><span id="line-614"></span><span>  </span><span id="local-6989586621683124241"><span class="annot"><a href="#local-6989586621683124241"><span class="hs-identifier hs-var">runIO_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.Wasm.Prim.Exports&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;runIO&quot;</span></span><span>
</span><span id="line-615"></span><span>  </span><span id="local-6989586621683124242"><span class="annot"><a href="#local-6989586621683124242"><span class="hs-identifier hs-var">runNonIO_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;GHC.Internal.Wasm.Prim.Exports&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;runNonIO&quot;</span></span><span>
</span><span id="line-616"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683124243"><span class="annot"><a href="#local-6989586621683124243"><span class="hs-identifier hs-var hs-var">work_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-617"></span><span>        </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Id
</span><a href="GHC.Types.Id.html#mkExportedVanillaId"><span class="hs-identifier hs-var">mkExportedVanillaId</span></a></span><span>
</span><span id="line-618"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Module -&gt; OccName -&gt; SrcSpan -&gt; Name
</span><a href="GHC.Types.Name.html#mkExternalName"><span class="hs-identifier hs-var">mkExternalName</span></a></span><span>
</span><span id="line-619"></span><span>              </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621683124226"><span class="hs-identifier hs-var">work_uniq</span></a></span><span>
</span><span id="line-620"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Module) -&gt; Name -&gt; Module
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124223"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkVarOcc"><span class="hs-identifier hs-var">mkVarOcc</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; OccName) -&gt; [Char] -&gt; OccName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;jsffi_&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">OccName -&gt; [Char]
</span><a href="GHC.Types.Name.Occurrence.html#occNameString"><span class="hs-identifier hs-var">occNameString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccName
forall a. NamedThing a =&gt; a -&gt; OccName
</span><a href="GHC.Types.Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124223"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-622"></span><span>              </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#generatedSrcSpan"><span class="hs-identifier hs-var">generatedSrcSpan</span></a></span><span>
</span><span id="line-623"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621683124244"><span class="hs-identifier hs-var">work_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span>      </span><span id="local-6989586621683124244"><span class="annot"><a href="#local-6989586621683124244"><span class="hs-identifier hs-var hs-var">work_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-626"></span><span>        </span><span class="annot"><span class="annottext">[Id] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Make.html#mkCoreLams"><span class="hs-identifier hs-var">mkCoreLams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124229"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124239"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-627"></span><span>          </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; CoreExpr -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span>
</span><span id="line-628"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; CoreExpr) -&gt; Id -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683124234"><span class="hs-identifier hs-var">is_io</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124241"><span class="hs-identifier hs-var">runIO_id</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124242"><span class="hs-identifier hs-var">runNonIO_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683124233"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-630"></span><span>              </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124240"><span class="hs-identifier hs-var">promiseRes_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([CoreExpr] -&gt; CoreExpr) -&gt; [CoreExpr] -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; CoreExpr) -&gt; [Type] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683124236"><span class="hs-identifier hs-var">res_ty_args</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-631"></span><span>              </span><span class="annot"><span class="annottext">CoreExpr -&gt; [CoreExpr] -&gt; CoreExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Coercion -&gt; CoreExpr
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124223"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621683124224"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>                </span><span class="annot"><span class="annottext">([CoreExpr] -&gt; CoreExpr) -&gt; [CoreExpr] -&gt; CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; CoreExpr) -&gt; [Id] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; CoreExpr) -&gt; (Id -&gt; Type) -&gt; Id -&gt; CoreExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124229"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-633"></span><span>                </span><span class="annot"><span class="annottext">[CoreExpr] -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; CoreExpr) -&gt; [Id] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621683124239"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-634"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-635"></span><span>      </span><span id="local-6989586621683124245"><span class="annot"><a href="#local-6989586621683124245"><span class="hs-identifier hs-var hs-var">work_closure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621683124243"><span class="hs-identifier hs-var">work_id</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_closure&quot;</span></span><span>
</span><span id="line-636"></span><span>      </span><span id="local-6989586621683124246"><span class="annot"><a href="#local-6989586621683124246"><span class="hs-identifier hs-var hs-var">work_closure_decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;extern StgClosure&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124245"><span class="hs-identifier hs-var">work_closure</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#semi"><span class="hs-identifier hs-var">semi</span></a></span><span>
</span><span id="line-637"></span><span>      </span><span id="local-6989586621683124247"><span class="annot"><a href="#local-6989586621683124247"><span class="hs-identifier hs-var hs-var">cstub_attr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-638"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__attribute__&quot;</span></span><span>
</span><span id="line-639"></span><span>          </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span>
</span><span id="line-640"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;export_name&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; SDoc
forall doc. IsLine doc =&gt; FastString -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124225"><span class="hs-identifier hs-var">ext_name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-641"></span><span>      </span><span id="local-6989586621683124249"><span class="annot"><a href="#local-6989586621683124249"><span class="hs-identifier hs-var hs-var">cstub_arg_list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-642"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Hs&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Char]
</span><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-var">ffiType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scaled Type -&gt; Type
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span> </span><span class="annot"><span class="annottext">Scaled Type
</span><a href="#local-6989586621683124250"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'a'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124251"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-643"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683124251"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124251"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124250"><span class="annot"><span class="annottext">Scaled Type
</span><a href="#local-6989586621683124250"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Scaled Type] -&gt; [(Int, Scaled Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683124231"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-644"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-645"></span><span>      </span><span id="local-6989586621683124252"><span class="annot"><a href="#local-6989586621683124252"><span class="hs-identifier hs-var hs-var">cstub_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621683124249"><span class="hs-identifier hs-var">cstub_arg_list</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-646"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;void&quot;</span></span><span>
</span><span id="line-647"></span><span>        </span><span class="annot"><span class="annottext">[SDoc]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc]
</span><a href="#local-6989586621683124249"><span class="hs-identifier hs-var">cstub_arg_list</span></a></span><span>
</span><span id="line-648"></span><span>      </span><span id="local-6989586621683124253"><span class="annot"><a href="#local-6989586621683124253"><span class="hs-identifier hs-var hs-var">cstub_proto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;HsJSVal&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; SDoc
forall doc. IsLine doc =&gt; FastString -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124225"><span class="hs-identifier hs-var">ext_name</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124252"><span class="hs-identifier hs-var">cstub_args</span></a></span><span>
</span><span id="line-649"></span><span>      </span><span id="local-6989586621683124254"><span class="annot"><a href="#local-6989586621683124254"><span class="hs-identifier hs-var hs-var">cstub_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-650"></span><span>        </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-651"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#lbrace"><span class="hs-identifier hs-var">lbrace</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-652"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Capability *cap = rts_lock();&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-653"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;HaskellObj ret;&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-654"></span><span>            </span><span class="hs-comment">-- rts_evalLazyIO is fine, the top handler always returns</span><span>
</span><span id="line-655"></span><span>            </span><span class="hs-comment">-- an evaluated result</span><span>
</span><span id="line-656"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rts_evalLazyIO&quot;</span></span><span>
</span><span id="line-657"></span><span>              </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span>
</span><span id="line-658"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span>
</span><span id="line-659"></span><span>                    </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span>
</span><span id="line-660"></span><span>                      </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span>
</span><span id="line-661"></span><span>                      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;&amp;cap&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-662"></span><span>                        </span><span class="annot"><span class="annottext">(SDoc -&gt; (Int, Scaled Type) -&gt; SDoc)
-&gt; SDoc -&gt; [(Int, Scaled Type)] -&gt; SDoc
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span>
</span><span id="line-663"></span><span>                          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621683124257"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124257"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683124258"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124258"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683124259"><span class="annot"><span class="annottext">Scaled Type
</span><a href="#local-6989586621683124259"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-664"></span><span>                              </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rts_apply&quot;</span></span><span>
</span><span id="line-665"></span><span>                                </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span>
</span><span id="line-666"></span><span>                                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span>
</span><span id="line-667"></span><span>                                      </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span>
</span><span id="line-668"></span><span>                                        </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span>
</span><span id="line-669"></span><span>                                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cap&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-670"></span><span>                                          </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124257"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-671"></span><span>                                          </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rts_mk&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Char]
</span><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-var">ffiType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scaled Type -&gt; Type
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span> </span><span class="annot"><span class="annottext">Scaled Type
</span><a href="#local-6989586621683124259"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-672"></span><span>                                            </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span>
</span><span id="line-673"></span><span>                                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cap&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'a'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683124258"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-674"></span><span>                                        </span><span class="hs-special">]</span><span>
</span><span id="line-675"></span><span>                                  </span><span class="hs-special">)</span><span>
</span><span id="line-676"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'&amp;'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124245"><span class="hs-identifier hs-var">work_closure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span>                          </span><span class="annot"><span class="annottext">([(Int, Scaled Type)] -&gt; SDoc) -&gt; [(Int, Scaled Type)] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Scaled Type] -&gt; [(Int, Scaled Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621683124231"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-679"></span><span>                        </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;&amp;ret&quot;</span></span><span>
</span><span id="line-680"></span><span>                      </span><span class="hs-special">]</span><span>
</span><span id="line-681"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-682"></span><span>              </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#semi"><span class="hs-identifier hs-var">semi</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-683"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rts_checkSchedStatus&quot;</span></span><span>
</span><span id="line-684"></span><span>              </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; SDoc
forall doc. IsLine doc =&gt; FastString -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124225"><span class="hs-identifier hs-var">ext_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cap&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-685"></span><span>              </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#semi"><span class="hs-identifier hs-var">semi</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-686"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rts_unlock(cap);&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-687"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;return rts_getJSVal(ret);&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-688"></span><span>            </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#rbrace"><span class="hs-identifier hs-var">rbrace</span></a></span><span>
</span><span id="line-689"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-690"></span><span>      </span><span id="local-6989586621683124261"><span class="annot"><a href="#local-6989586621683124261"><span class="hs-identifier hs-var hs-var">cstub</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-691"></span><span>        </span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.HsToCore.Foreign.Wasm.html#commonCDecls"><span class="hs-identifier hs-var">commonCDecls</span></a></span><span>
</span><span id="line-692"></span><span>          </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124246"><span class="hs-identifier hs-var">work_closure_decl</span></a></span><span>
</span><span id="line-693"></span><span>          </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124247"><span class="hs-identifier hs-var">cstub_attr</span></a></span><span>
</span><span id="line-694"></span><span>          </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124253"><span class="hs-identifier hs-var">cstub_proto</span></a></span><span>
</span><span id="line-695"></span><span>          </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683124254"><span class="hs-identifier hs-var">cstub_body</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span>
</span><span id="line-697"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CHeader"><span class="hs-identifier hs-type">CHeader</span></a></span><span> </span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#commonCDecls"><span class="hs-identifier hs-type">commonCDecls</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-698"></span><span>      </span><span class="annot"><a href="GHC.Types.ForeignStubs.html#CStub"><span class="hs-identifier hs-type">CStub</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124261"><span class="hs-identifier hs-type">cstub</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-699"></span><span>      </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-700"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621683124243"><span class="hs-identifier hs-type">work_id</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-701"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683124243"><span class="hs-identifier hs-type">work_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683124244"><span class="hs-identifier hs-type">work_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-702"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-type">lookupGhcInternalVarId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-705"></span><span id="lookupGhcInternalVarId"><span class="annot"><span class="annottext">lookupGhcInternalVarId :: FastString -&gt; [Char] -&gt; DsM Id
</span><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalVarId"><span class="hs-identifier hs-var hs-var">lookupGhcInternalVarId</span></a></span></span><span> </span><span id="local-6989586621683124262"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124262"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621683124263"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124263"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-706"></span><span>  </span><span id="local-6989586621683124264"><span class="annot"><a href="#local-6989586621683124264"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Module -&gt; OccName -&gt; TcRnIf DsGblEnv DsLclEnv Name
forall a b. Module -&gt; OccName -&gt; TcRnIf a b Name
</span><a href="GHC.Iface.Env.html#lookupOrig"><span class="hs-identifier hs-var">lookupOrig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; Module
</span><a href="GHC.Builtin.Names.html#mkGhcInternalModule"><span class="hs-identifier hs-var">mkGhcInternalModule</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124262"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkVarOcc"><span class="hs-identifier hs-var">mkVarOcc</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124263"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-707"></span><span>  </span><span class="annot"><a href="GHC.HsToCore.Monad.html#dsLookupGlobalId"><span class="hs-identifier hs-type">dsLookupGlobalId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124264"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-708"></span><span>
</span><span id="line-709"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalTyCon"><span class="hs-identifier hs-type">lookupGhcInternalTyCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.HsToCore.Types.html#DsM"><span class="hs-identifier hs-type">DsM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>
</span><span id="line-710"></span><span id="lookupGhcInternalTyCon"><span class="annot"><span class="annottext">lookupGhcInternalTyCon :: FastString -&gt; [Char] -&gt; DsM TyCon
</span><a href="GHC.HsToCore.Foreign.Wasm.html#lookupGhcInternalTyCon"><span class="hs-identifier hs-var hs-var">lookupGhcInternalTyCon</span></a></span></span><span> </span><span id="local-6989586621683124267"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124267"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621683124268"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124268"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-711"></span><span>  </span><span id="local-6989586621683124269"><span class="annot"><a href="#local-6989586621683124269"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Module -&gt; OccName -&gt; TcRnIf DsGblEnv DsLclEnv Name
forall a b. Module -&gt; OccName -&gt; TcRnIf a b Name
</span><a href="GHC.Iface.Env.html#lookupOrig"><span class="hs-identifier hs-var">lookupOrig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; Module
</span><a href="GHC.Builtin.Names.html#mkGhcInternalModule"><span class="hs-identifier hs-var">mkGhcInternalModule</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683124267"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkTcOcc"><span class="hs-identifier hs-var">mkTcOcc</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621683124268"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-712"></span><span>  </span><span class="annot"><a href="GHC.HsToCore.Monad.html#dsLookupTyCon"><span class="hs-identifier hs-type">dsLookupTyCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683124269"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-type">ffiType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-715"></span><span id="ffiType"><span class="annot"><span class="annottext">ffiType :: Type -&gt; [Char]
</span><a href="GHC.HsToCore.Foreign.Wasm.html#ffiType"><span class="hs-identifier hs-var hs-var">ffiType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; [Char]
</span><a href="GHC.Types.Name.Occurrence.html#occNameString"><span class="hs-identifier hs-var">occNameString</span></a></span><span> </span><span class="annot"><span class="annottext">(OccName -&gt; [Char]) -&gt; (Type -&gt; OccName) -&gt; Type -&gt; [Char]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; OccName
forall a. NamedThing a =&gt; a -&gt; OccName
</span><a href="GHC.Types.Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a></span><span> </span><span class="annot"><span class="annottext">(TyCon -&gt; OccName) -&gt; (Type -&gt; TyCon) -&gt; Type -&gt; OccName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TyCon, [Type]) -&gt; TyCon
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((TyCon, [Type]) -&gt; TyCon)
-&gt; (Type -&gt; (TyCon, [Type])) -&gt; Type -&gt; TyCon
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp"><span class="hs-identifier hs-var">splitTyConApp</span></a></span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span class="annot"><a href="GHC.HsToCore.Foreign.Wasm.html#commonCDecls"><span class="hs-identifier hs-type">commonCDecls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-718"></span><span id="commonCDecls"><span class="annot"><span class="annottext">commonCDecls :: SDoc
</span><a href="GHC.HsToCore.Foreign.Wasm.html#commonCDecls"><span class="hs-identifier hs-var hs-var">commonCDecls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-719"></span><span>  </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-720"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;typedef __externref_t HsJSVal;&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-721"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;HsJSVal rts_getJSVal(HaskellObj);&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-722"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; SDoc
forall doc. IsLine doc =&gt; [Char] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;HaskellObj rts_mkJSVal(Capability*, HsJSVal);&quot;</span></span><span>
</span><span id="line-723"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-724"></span></pre></body></html>