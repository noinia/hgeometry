<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- (c) The University of Glasgow 2006</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html"><span class="hs-identifier">GHC.Core.Coercion.Opt</span></a></span><span>
</span><span id="line-6"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#optCoercion"><span class="hs-identifier">optCoercion</span></a></span><span>
</span><span id="line-7"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#OptCoercionOpts"><span class="hs-identifier">OptCoercionOpts</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#exactTyCoVarsOfType"><span class="hs-identifier">exactTyCoVarsOfType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html"><span class="hs-identifier">GHC.Core.TyCo.Subst</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html"><span class="hs-identifier">GHC.Core.TyCo.Compare</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier">eqType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqForAllVis"><span class="hs-identifier">eqForAllVis</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTyVarBndr"><span class="hs-identifier">substTyVarBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier">substTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html"><span class="hs-identifier">GHC.Core.Coercion.Axiom</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html"><span class="hs-identifier">GHC.Core.Unify</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier">SwapFlag</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#flipSwap"><span class="hs-identifier">flipSwap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#isSwapped"><span class="hs-identifier">isSwapped</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#pickSwap"><span class="hs-identifier">pickSwap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#notSwapped"><span class="hs-identifier">notSwapped</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html"><span class="hs-identifier">GHC.Data.Pair</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Constants.html"><span class="hs-identifier">GHC.Utils.Constants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier">debugIsOn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">zipWithM</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
                 Optimising coercions
%*                                                                      *
%************************************************************************

This module does coercion optimisation.  See the paper

   Evidence normalization in Systtem FV (RTA'13)
   https://simon.peytonjones.org/evidence-normalization/

The paper is also in the GHC repo, in docs/opt-coercion.

Note [Optimising coercion optimisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Looking up a coercion's role or kind is linear in the size of the
coercion. Thus, doing this repeatedly during the recursive descent
of coercion optimisation is disastrous. We must be careful to avoid
doing this if at all possible.

Because it is generally easy to know a coercion's components' roles
from the role of the outer coercion, we pass down the known role of
the input in the algorithm below. We also keep functions opt_co2
and opt_co3 separate from opt_co4, so that the former two do Phantom
checks that opt_co4 can avoid. This is a big win because Phantom coercions
rarely appear within non-phantom coercions -- only in some TyConAppCos
and some AxiomInstCos. We handle these cases specially by calling
opt_co2.

Note [Optimising InstCo]
~~~~~~~~~~~~~~~~~~~~~~~~
Optimising InstCo is pretty subtle: #15725, #25387.

(1) tv is a type variable. We want to optimise

  InstCo (ForAllCo tv kco g) g2  --&gt;   S(g)

where S is some substitution. Let's look at the typing rules.

    kco : k1 ~ k2
    tv:k1 |- g : t1 ~ t2
    -----------------------------
    ForAllCo tv kco g : (all tv:k1.t1) ~ (all tv:k2.t2[tv |-&gt; tv |&gt; sym kco])

    g1 : (all tv:k1.t1') ~ (all tv:k2.t2')
    g2 : (s1:k1) ~ (s2:k2)
    --------------------
    InstCo g1 g2 : t1'[tv |-&gt; s1] ~ t2'[tv |-&gt; s2]

Putting these two together

    kco : k1 ~ k2
    tv:k1 |- g : t1 ~ t2
    g2 : (s1:k1) ~ (s2:k2)
    --------------------
    InstCo (ForAllCo tv kco g) g2 : t1[tv |-&gt; s1] ~ t2[tv |-&gt; s2 |&gt; sym kco]

We thus want S(g) to have kind

  S(g) :: (t1[tv |-&gt; s1]) ~ (t2[tv |-&gt; s2 |&gt; sym kco])

All we need do is to substitute the coercion tv_co for tv:
  S = [tv :-&gt; tv_co]
where
  tv_co : s1 ~ (s2 |&gt; sym kco)
This looks bizarre, because we're substituting a /type variable/ with a
/coercion/. However, this operation already exists: it's called *lifting*, and
defined in GHC.Core.Coercion.  We just need to enhance the lifting operation to
be able to deal with an ambient substitution, which is why a LiftingContext
stores a TCvSubst.

In general if
  S = [tv :-&gt; tv_co]
  tv_co : r1 ~ r2
  g     : t1 ~ t2
then
  S(g) : t1[tv :-&gt; r1] ~ t2[tv :-&gt; r2]

The substitution S is embodied in the LiftingContext argument of `opt_co4`;
See Note [The LiftingContext in optCoercion]

(2) cv is a coercion variable
Now consider we have (InstCo (ForAllCo cv h g) g2), we want to optimise.

h : (t1 ~r t2) ~N (t3 ~r t4)
cv : t1 ~r t2 |- g : t1' ~r2 t2'
n1 = nth r 2 (downgradeRole r N h) :: t1 ~r t3
n2 = nth r 3 (downgradeRole r N h) :: t2 ~r t4
------------------------------------------------
ForAllCo cv h g : (all cv:t1 ~r t2. t1') ~r2
                  (all cv:t3 ~r t4. t2'[cv |-&gt; n1 ; cv ; sym n2])

g1 : (all cv:t1 ~r t2. t1') ~ (all cv: t3 ~r t4. t2')
g2 : h1 ~N h2
h1 : t1 ~r t2
h2 : t3 ~r t4
------------------------------------------------
InstCo g1 g2 : t1'[cv |-&gt; h1] ~ t2'[cv |-&gt; h2]

We thus want some coercion proving this:

  t1'[cv |-&gt; h1] ~ t2'[cv |-&gt; n1 ; h2; sym n2]

So we substitute the coercion variable c for the coercion
(h1 ~N (n1; h2; sym n2)) in g.

Note [The LiftingContext in optCoercion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
To suppport Note [Optimising InstCo] the coercion optimiser carries a
GHC.Core.Coercion.LiftingContext, which comprises
  * An ordinary Subst
  * The `lc_env`: a mapping from /type variables/ to /coercions/

We don't actually have a separate function
   liftCoSubstCo :: LiftingContext -&gt; Coercion -&gt; Coercion
The substitution of a type variable by a coercion is done by the calls to
`liftCoSubst` (on a type) in the Refl and GRefl cases of `opt_co4`.

We use the following invariants:
 (LC1) The coercions in the range of `lc_env` have already had all substitutions
       applied; they are &quot;OutCoercions&quot;.  If you re-optimise these coercions, you
       must zap the LiftingContext first.

 (LC2) However they have /not/ had the &quot;ambient sym&quot; (the second argument of
       `opt_co4`) applied.  The ambient sym applies to the entire coercion not
       to the little bits being substituted.
-}</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="annot"><span class="hs-comment">-- | Coercion optimisation options</span></span><span>
</span><span id="line-168"></span><span class="hs-keyword">newtype</span><span> </span><span id="OptCoercionOpts"><span class="annot"><a href="GHC.Core.Coercion.Opt.html#OptCoercionOpts"><span class="hs-identifier hs-var">OptCoercionOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="OptCoercionOpts"><span class="annot"><a href="GHC.Core.Coercion.Opt.html#OptCoercionOpts"><span class="hs-identifier hs-var">OptCoercionOpts</span></a></span></span><span>
</span><span id="line-169"></span><span>   </span><span class="hs-special">{</span><span> </span><span id="optCoercionEnabled"><span class="annot"><span class="annottext">OptCoercionOpts -&gt; Bool
</span><a href="GHC.Core.Coercion.Opt.html#optCoercionEnabled"><span class="hs-identifier hs-var hs-var">optCoercionEnabled</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Enable coercion optimisation (reduce its size)</span></span><span>
</span><span id="line-170"></span><span>   </span><span class="hs-special">}</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#optCoercion"><span class="hs-identifier hs-type">optCoercion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#OptCoercionOpts"><span class="hs-identifier hs-type">OptCoercionOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-173"></span><span class="hs-comment">-- ^ optCoercion applies a substitution to a coercion,</span><span>
</span><span id="line-174"></span><span class="hs-comment">--   *and* optimises it to reduce its size</span><span>
</span><span id="line-175"></span><span id="optCoercion"><span class="annot"><span class="annottext">optCoercion :: OptCoercionOpts -&gt; Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#optCoercion"><span class="hs-identifier hs-var hs-var">optCoercion</span></a></span></span><span> </span><span id="local-6989586621682600061"><span class="annot"><span class="annottext">OptCoercionOpts
</span><a href="#local-6989586621682600061"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621682600062"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682600062"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600063"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600063"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OptCoercionOpts -&gt; Bool
</span><a href="GHC.Core.Coercion.Opt.html#optCoercionEnabled"><span class="hs-identifier hs-var">optCoercionEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">OptCoercionOpts
</span><a href="#local-6989586621682600061"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#optCoercion%27"><span class="hs-identifier hs-var">optCoercion'</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682600062"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600063"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span class="hs-comment">{-
  = pprTrace &quot;optCoercion {&quot; (text &quot;Co:&quot; &lt;&gt; ppr (coercionSize co)) $
    let result = optCoercion' env co in
    pprTrace &quot;optCoercion }&quot;
       (vcat [ text &quot;Co:&quot;    &lt;+&gt; ppr (coercionSize co)
             , text &quot;Optco:&quot; &lt;+&gt; ppWhen (isReflCo result) (text &quot;(refl)&quot;)
                             &lt;+&gt; ppr (coercionSize result) ]) $
    result
-}</span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682600062"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600063"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#optCoercion%27"><span class="hs-identifier hs-type">optCoercion'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-193"></span><span id="optCoercion%27"><span class="annot"><span class="annottext">optCoercion' :: Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#optCoercion%27"><span class="hs-identifier hs-var hs-var">optCoercion'</span></a></span></span><span> </span><span id="local-6989586621682600066"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682600066"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600067"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600067"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600068"><span class="annot"><span class="annottext">out_co :: Coercion
</span><a href="#local-6989586621682600068"><span class="hs-identifier hs-var hs-var">out_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600070"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600067"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-196"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682600073"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600073"><span class="hs-identifier hs-var">in_ty1</span></a></span></span><span>  </span><span id="local-6989586621682600074"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600074"><span class="hs-identifier hs-var">in_ty2</span></a></span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621682600075"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600075"><span class="hs-identifier hs-var">in_role</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; (Pair Type, Role)
</span><a href="GHC.Core.Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600067"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-197"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682600077"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600077"><span class="hs-identifier hs-var">out_ty1</span></a></span></span><span> </span><span id="local-6989586621682600078"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600078"><span class="hs-identifier hs-var">out_ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600079"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600079"><span class="hs-identifier hs-var">out_role</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; (Pair Type, Role)
</span><a href="GHC.Core.Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600068"><span class="hs-identifier hs-var">out_co</span></a></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span>        </span><span id="local-6989586621682600080"><span class="annot"><span class="annottext">details :: SDoc
</span><a href="#local-6989586621682600080"><span class="hs-identifier hs-var hs-var">details</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in_co:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600067"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-200"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in_ty1:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600073"><span class="hs-identifier hs-var">in_ty1</span></a></span><span>
</span><span id="line-201"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in_ty2:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600074"><span class="hs-identifier hs-var">in_ty2</span></a></span><span>
</span><span id="line-202"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;out_co:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600068"><span class="hs-identifier hs-var">out_co</span></a></span><span>
</span><span id="line-203"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;out_ty1:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600077"><span class="hs-identifier hs-var">out_ty1</span></a></span><span>
</span><span id="line-204"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;out_ty2:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600078"><span class="hs-identifier hs-var">out_ty2</span></a></span><span>
</span><span id="line-205"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in_role:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600075"><span class="hs-identifier hs-var">in_role</span></a></span><span>
</span><span id="line-206"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;out_role:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600079"><span class="hs-identifier hs-var">out_role</span></a></span><span>
</span><span id="line-207"></span><span>                       </span><span class="hs-special">]</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600068"><span class="hs-identifier hs-var">out_co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflexiveCo"><span class="hs-identifier hs-var">isReflexiveCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600068"><span class="hs-identifier hs-var">out_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>                 </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;optCoercion: reflexive but not refl&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682600080"><span class="hs-identifier hs-var">details</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-211"></span><span class="hs-comment">--    assertPpr (substTyUnchecked env in_ty1 `eqType` out_ty1 &amp;&amp;</span><span>
</span><span id="line-212"></span><span class="hs-comment">--               substTyUnchecked env in_ty2 `eqType` out_ty2 &amp;&amp;</span><span>
</span><span id="line-213"></span><span class="hs-comment">--               in_role == out_role)</span><span>
</span><span id="line-214"></span><span class="hs-comment">--              (hang (text &quot;optCoercion changed types!&quot;) 2 details) $</span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600068"><span class="hs-identifier hs-var">out_co</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600070"><span class="hs-identifier hs-var">lc</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600067"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-220"></span><span>    </span><span id="local-6989586621682600070"><span class="annot"><span class="annottext">lc :: LiftingContext
</span><a href="#local-6989586621682600070"><span class="hs-identifier hs-var hs-var">lc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#mkSubstLiftingContext"><span class="hs-identifier hs-var">mkSubstLiftingContext</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682600066"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-221"></span><span class="hs-comment">--    ppr_one cv = ppr cv &lt;+&gt; dcolon &lt;+&gt; ppr (coVarKind cv)</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-keyword">type</span><span> </span><span id="NormalCo"><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-var">NormalCo</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-comment">-- Invariants:</span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-comment">--  * The substitution has been fully applied</span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-comment">--  * For trans coercions (co1 `trans` co2)</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-comment">--       co1 is not a trans, and neither co1 nor co2 is identity</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-keyword">type</span><span> </span><span id="NormalNonIdCo"><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalNonIdCo"><span class="hs-identifier hs-var">NormalNonIdCo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>  </span><span class="hs-comment">-- Extra invariant: not the identity</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="annot"><span class="hs-comment">-- | Do we force the result to be representational?</span></span><span>
</span><span id="line-233"></span><span class="hs-keyword">type</span><span> </span><span id="ReprFlag"><span class="annot"><a href="GHC.Core.Coercion.Opt.html#ReprFlag"><span class="hs-identifier hs-var">ReprFlag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="hs-comment">-- | Optimize a coercion, making no assumptions. All coercions in</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- the lifting context are already optimized (and sym'd if nec'y)</span><span>
</span><span id="line-237"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co1"><span class="hs-identifier hs-type">opt_co1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span>
</span><span id="line-238"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>   </span><span class="hs-comment">-- IsSwapped =&gt; apply Sym to the result</span><span>
</span><span id="line-239"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-240"></span><span id="opt_co1"><span class="annot"><span class="annottext">opt_co1 :: LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co1"><span class="hs-identifier hs-var hs-var">opt_co1</span></a></span></span><span> </span><span id="local-6989586621682600093"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600093"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600094"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600094"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600095"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600095"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co2"><span class="hs-identifier hs-var">opt_co2</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600093"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600094"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Role
</span><a href="GHC.Core.Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600095"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600095"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><span id="line-243"></span><span class="annot"><span class="hs-comment">-- | Optimize a coercion, knowing the coercion's role. No other assumptions.</span></span><span>
</span><span id="line-244"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co2"><span class="hs-identifier hs-type">opt_co2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^IsSwapped =&gt; apply Sym to the result</span></span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>       </span><span class="annot"><span class="hs-comment">-- ^ The role of the input coercion</span></span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-248"></span><span id="opt_co2"><span class="annot"><span class="annottext">opt_co2 :: LiftingContext -&gt; SwapFlag -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co2"><span class="hs-identifier hs-var hs-var">opt_co2</span></a></span></span><span> </span><span id="local-6989586621682600098"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600098"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600099"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600099"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span> </span><span id="local-6989586621682600101"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600101"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_phantom"><span class="hs-identifier hs-var">opt_phantom</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600098"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600099"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600101"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-249"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co2"><span class="hs-identifier hs-var">opt_co2</span></a></span><span> </span><span id="local-6989586621682600103"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600103"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600104"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600104"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600105"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600105"><span class="hs-identifier hs-var">r</span></a></span></span><span>       </span><span id="local-6989586621682600106"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600106"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600103"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600104"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600105"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600106"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- | Optimize a coercion, knowing the coercion's non-Phantom role,</span><span>
</span><span id="line-253"></span><span class="hs-comment">--   and with an optional downgrade</span><span>
</span><span id="line-254"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co3"><span class="hs-identifier hs-type">opt_co3</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-255"></span><span id="opt_co3"><span class="annot"><span class="annottext">opt_co3 :: LiftingContext
-&gt; SwapFlag -&gt; Maybe Role -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co3"><span class="hs-identifier hs-var hs-var">opt_co3</span></a></span></span><span> </span><span id="local-6989586621682600109"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600109"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600110"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600110"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span class="hs-special">)</span><span>          </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682600111"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600111"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_phantom"><span class="hs-identifier hs-var">opt_phantom</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600109"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600110"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600111"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-256"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co3"><span class="hs-identifier hs-var">opt_co3</span></a></span><span> </span><span id="local-6989586621682600112"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600112"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600113"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600113"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600115"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600115"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621682600116"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600116"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600112"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600113"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600115"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600116"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-comment">-- if mrole is Just Nominal, that can't be a downgrade, so we can ignore</span><span>
</span><span id="line-258"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co3"><span class="hs-identifier hs-var">opt_co3</span></a></span><span> </span><span id="local-6989586621682600117"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600117"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600118"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600118"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Role
</span><span class="hs-identifier">_</span></span><span>                       </span><span id="local-6989586621682600119"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600119"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621682600120"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600120"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600117"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600118"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600119"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600120"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><span id="line-261"></span><span class="annot"><span class="hs-comment">-- | Optimize a non-phantom coercion.</span></span><span>
</span><span id="line-262"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-type">opt_co4</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-type">opt_co4'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#ReprFlag"><span class="hs-identifier hs-type">ReprFlag</span></a></span><span>
</span><span id="line-263"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-264"></span><span class="hs-comment">-- Precondition:  In every call (opt_co4 lc sym rep role co)</span><span>
</span><span id="line-265"></span><span class="hs-comment">--                we should have role = coercionRole co</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- Precondition:  role is not Phantom</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- Postcondition: The resulting coercion is equivalant to</span><span>
</span><span id="line-268"></span><span class="hs-comment">--                     wrapsub (wrapsym (mksub co)</span><span>
</span><span id="line-269"></span><span class="hs-comment">--                 where wrapsym is SymCo if sym=True</span><span>
</span><span id="line-270"></span><span class="hs-comment">--                       wrapsub is SubCo if rep=True</span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span class="hs-comment">-- opt_co4 is there just to support tracing, when debugging</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- Usually it just goes straight to opt_co4'</span><span>
</span><span id="line-274"></span><span id="opt_co4"><span class="annot"><span class="annottext">opt_co4 :: LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var hs-var">opt_co4</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="hs-comment">{-
opt_co4 env sym rep r co
  = pprTrace &quot;opt_co4 {&quot;
   ( vcat [ text &quot;Sym:&quot; &lt;+&gt; ppr sym
          , text &quot;Rep:&quot; &lt;+&gt; ppr rep
          , text &quot;Role:&quot; &lt;+&gt; ppr r
          , text &quot;Co:&quot; &lt;+&gt; ppr co ]) $
   assert (r == coercionRole co )    $
   let result = opt_co4' env sym rep r co in
   pprTrace &quot;opt_co4 }&quot; (ppr co $$ text &quot;---&quot; $$ ppr result) $
   assertPpr (res_role == coercionRole result)
             (vcat [ text &quot;Role:&quot; &lt;+&gt; ppr r
                   , text &quot;Result: &quot; &lt;+&gt;  ppr result
                   , text &quot;Result type:&quot; &lt;+&gt; ppr (coercionType result) ]) $
   result

  where
    res_role | rep       = Representational
             | otherwise = r
-}</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span id="opt_co4%27"><span class="annot"><span class="annottext">opt_co4' :: LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var hs-var">opt_co4'</span></a></span></span><span> </span><span id="local-6989586621682600122"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600122"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600123"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600123"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600124"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600124"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600125"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600125"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Refl"><span class="hs-identifier hs-type">Refl</span></a></span><span> </span><span id="local-6989586621682600127"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600127"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600125"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Expected role:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600125"><span class="hs-identifier hs-var">r</span></a></span><span>    </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-300"></span><span>               </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Found role:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-301"></span><span>               </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Type:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600127"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><span class="annottext">SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600123"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; LiftingContext -&gt; Type -&gt; Coercion
Role -&gt; LiftingContext -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Role
</span><a href="GHC.Core.Coercion.Opt.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600124"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600125"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600122"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600127"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-comment">-- wrapSym: see (LC2) of Note [The LiftingContext in optCoercion]</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600134"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600134"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600135"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600135"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600136"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600136"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600137"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600137"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#GRefl"><span class="hs-identifier hs-type">GRefl</span></a></span><span> </span><span id="local-6989586621682600139"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600139"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span id="local-6989586621682600140"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600140"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600137"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600139"><span class="hs-identifier hs-var">_r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Expected role:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600137"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-308"></span><span>               </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Found role:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600139"><span class="hs-identifier hs-var">_r</span></a></span><span>   </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-309"></span><span>               </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Type:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600140"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-310"></span><span>    </span><span class="annot"><span class="annottext">SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600135"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; LiftingContext -&gt; Type -&gt; Coercion
Role -&gt; LiftingContext -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Role
</span><a href="GHC.Core.Coercion.Opt.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600136"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600137"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600134"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600140"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-311"></span><span>        </span><span class="hs-comment">-- wrapSym: see (LC2) of Note [The LiftingContext in optCoercion]</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600142"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600142"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600143"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600143"><span class="hs-identifier hs-var">sym</span></a></span></span><span>  </span><span id="local-6989586621682600144"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600144"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600145"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600145"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#GRefl"><span class="hs-identifier hs-type">GRefl</span></a></span><span> </span><span id="local-6989586621682600146"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600146"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span id="local-6989586621682600147"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600147"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682600149"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600149"><span class="hs-identifier hs-var">kco</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600145"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600146"><span class="hs-identifier hs-var">_r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Expected role:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600145"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-316"></span><span>               </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Found role:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600146"><span class="hs-identifier hs-var">_r</span></a></span><span>   </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-317"></span><span>               </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Type:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600147"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600149"><span class="hs-identifier hs-var">kco</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600152"><span class="hs-identifier hs-var">kco'</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600143"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600153"><span class="hs-identifier hs-var">ty_co</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600143"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_coherence_right_co"><span class="hs-identifier hs-var">mk_coherence_right_co</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600155"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600153"><span class="hs-identifier hs-var">ty_co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600152"><span class="hs-identifier hs-var">kco'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600153"><span class="hs-identifier hs-var">ty_co</span></a></span><span>
</span><span id="line-321"></span><span>            </span><span class="hs-comment">-- ty :: k1</span><span>
</span><span id="line-322"></span><span>            </span><span class="hs-comment">-- kco :: k1 ~ k2</span><span>
</span><span id="line-323"></span><span>            </span><span class="hs-comment">-- Desired result coercion:   ty ~ ty |&gt; co</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-325"></span><span>    </span><span id="local-6989586621682600155"><span class="annot"><span class="annottext">r' :: Role
</span><a href="#local-6989586621682600155"><span class="hs-identifier hs-var hs-var">r'</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Role
</span><a href="GHC.Core.Coercion.Opt.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600144"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600145"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621682600153"><span class="annot"><span class="annottext">ty_co :: Coercion
</span><a href="#local-6989586621682600153"><span class="hs-identifier hs-var hs-var">ty_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; LiftingContext -&gt; Type -&gt; Coercion
Role -&gt; LiftingContext -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600155"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600142"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600147"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span id="local-6989586621682600152"><span class="annot"><span class="annottext">kco' :: Coercion
</span><a href="#local-6989586621682600152"><span class="hs-identifier hs-var hs-var">kco'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600142"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600149"><span class="hs-identifier hs-var">kco</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600157"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600157"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600158"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600158"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600159"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600159"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600160"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600160"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SymCo"><span class="hs-identifier hs-type">SymCo</span></a></span><span> </span><span id="local-6989586621682600162"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600162"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600157"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag -&gt; SwapFlag
</span><a href="GHC.Types.Basic.html#flipSwap"><span class="hs-identifier hs-var">flipSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600158"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600159"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600160"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600162"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-330"></span><span>  </span><span class="hs-comment">-- surprisingly, we don't have to do anything to the env here. This is</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-comment">-- because any &quot;lifting&quot; substitutions in the env are tied to ForAllCos,</span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-comment">-- which treat their left and right sides differently. We don't want to</span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-comment">-- exchange them.</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600163"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600163"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600164"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600164"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600165"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600165"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600166"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600166"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621682600167"><span class="annot"><span class="annottext">g :: Coercion
</span><a href="#local-6989586621682600167"><span class="hs-identifier hs-var">g</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConAppCo"><span class="hs-identifier hs-type">TyConAppCo</span></a></span><span> </span><span id="local-6989586621682600169"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600169"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span id="local-6989586621682600170"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600170"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682600171"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600171"><span class="hs-identifier hs-var">cos</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600166"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600169"><span class="hs-identifier hs-var">_r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600165"><span class="hs-identifier hs-var">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600166"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-338"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-339"></span><span>        </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600170"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-340"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe Role -&gt; Role -&gt; Coercion -&gt; Coercion)
-&gt; [Maybe Role] -&gt; [Role] -&gt; [Coercion] -&gt; [Coercion]
forall a b c d. (a -&gt; b -&gt; c -&gt; d) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d]
</span><span class="hs-identifier hs-var">zipWith3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext
-&gt; SwapFlag -&gt; Maybe Role -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co3"><span class="hs-identifier hs-var">opt_co3</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600163"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600164"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Role -&gt; Maybe Role) -&gt; [Role] -&gt; [Maybe Role]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Maybe Role
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Role]
</span><a href="GHC.Core.Coercion.html#tyConRoleListRepresentational"><span class="hs-identifier hs-var">tyConRoleListRepresentational</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600170"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; [Role]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>                               </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600171"><span class="hs-identifier hs-var">cos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600170"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; [Coercion] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600163"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600164"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600171"><span class="hs-identifier hs-var">cos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-347"></span><span>                      </span><span class="hs-comment">-- must use opt_co2 here, because some roles may be P</span><span>
</span><span id="line-348"></span><span>                      </span><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><span id="line-349"></span><span>        </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600166"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600170"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Role -&gt; Coercion -&gt; Coercion)
-&gt; [Role] -&gt; [Coercion] -&gt; [Coercion]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co2"><span class="hs-identifier hs-var">opt_co2</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600163"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600164"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Role]
</span><a href="GHC.Core.Coercion.html#tyConRoleListRepresentational"><span class="hs-identifier hs-var">tyConRoleListRepresentational</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600170"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- the current roles</span><span>
</span><span id="line-351"></span><span>                                   </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600171"><span class="hs-identifier hs-var">cos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; Coercion
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;opt_co4 sees a phantom!&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600167"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600179"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600179"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600180"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600180"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600181"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600181"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600182"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600182"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppCo"><span class="hs-identifier hs-type">AppCo</span></a></span><span> </span><span id="local-6989586621682600184"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600184"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600185"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600185"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600179"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600180"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600181"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600182"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600184"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600179"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600180"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600185"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600187"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600187"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600188"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600188"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600189"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600189"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600190"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600190"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllCo"><span class="hs-identifier hs-type">ForAllCo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fco_tcv :: Coercion -&gt; CoVar
</span><a href="GHC.Core.TyCo.Rep.html#fco_tcv"><span class="hs-identifier hs-var">fco_tcv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600193"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600193"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fco_visL :: Coercion -&gt; ForAllTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#fco_visL"><span class="hs-identifier hs-var">fco_visL</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600195"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600195"><span class="hs-identifier hs-var">visL</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fco_visR :: Coercion -&gt; ForAllTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#fco_visR"><span class="hs-identifier hs-var">fco_visR</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600197"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600197"><span class="hs-identifier hs-var">visR</span></a></span></span><span>
</span><span id="line-359"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fco_kind :: Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#fco_kind"><span class="hs-identifier hs-var">fco_kind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600199"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600199"><span class="hs-identifier hs-var">k_co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fco_body :: Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#fco_body"><span class="hs-identifier hs-var">fco_body</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600201"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600201"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LiftingContext
-&gt; SwapFlag
-&gt; CoVar
-&gt; Coercion
-&gt; (LiftingContext, CoVar, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#optForAllCoBndr"><span class="hs-identifier hs-var">optForAllCoBndr</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600187"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600188"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600193"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600199"><span class="hs-identifier hs-var">k_co</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621682600203"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600203"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600204"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600204"><span class="hs-identifier hs-var">tv'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600205"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600205"><span class="hs-identifier hs-var">k_co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
CoVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
CoVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600204"><span class="hs-identifier hs-var">tv'</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600207"><span class="hs-identifier hs-var">visL'</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600208"><span class="hs-identifier hs-var">visR'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600205"><span class="hs-identifier hs-var">k_co'</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-362"></span><span>                            </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600203"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600188"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600189"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600190"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600201"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-363"></span><span>     </span><span class="hs-comment">-- Use the &quot;mk&quot; functions to check for nested Refls</span><span>
</span><span id="line-364"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682600207"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600207"><span class="hs-identifier hs-var">visL'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600208"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600208"><span class="hs-identifier hs-var">visR'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag
-&gt; (ForAllTyFlag, ForAllTyFlag) -&gt; (ForAllTyFlag, ForAllTyFlag)
forall a. SwapFlag -&gt; (a, a) -&gt; (a, a)
</span><a href="GHC.Core.Coercion.Opt.html#swapSym"><span class="hs-identifier hs-var">swapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600188"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600195"><span class="hs-identifier hs-var">visL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600197"><span class="hs-identifier hs-var">visR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600210"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600210"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600211"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600211"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600212"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600212"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600213"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600213"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunCo"><span class="hs-identifier hs-type">FunCo</span></a></span><span> </span><span id="local-6989586621682600215"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600215"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span id="local-6989586621682600216"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600216"><span class="hs-identifier hs-var">afl</span></a></span></span><span> </span><span id="local-6989586621682600217"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600217"><span class="hs-identifier hs-var">afr</span></a></span></span><span> </span><span id="local-6989586621682600218"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600218"><span class="hs-identifier hs-var">cow</span></a></span></span><span> </span><span id="local-6989586621682600219"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600219"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600220"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600220"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600213"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600215"><span class="hs-identifier hs-var">_r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-369"></span><span>    </span><span class="annot"><span class="annottext">Role
-&gt; FunTyFlag
-&gt; FunTyFlag
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkFunCo2"><span class="hs-identifier hs-var">mkFunCo2</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600222"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600223"><span class="hs-identifier hs-var">afl'</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600224"><span class="hs-identifier hs-var">afr'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600225"><span class="hs-identifier hs-var">cow'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600226"><span class="hs-identifier hs-var">co1'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600227"><span class="hs-identifier hs-var">co2'</span></a></span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-371"></span><span>    </span><span id="local-6989586621682600226"><span class="annot"><span class="annottext">co1' :: Coercion
</span><a href="#local-6989586621682600226"><span class="hs-identifier hs-var hs-var">co1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600210"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600211"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600212"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600213"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600219"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-372"></span><span>    </span><span id="local-6989586621682600227"><span class="annot"><span class="annottext">co2' :: Coercion
</span><a href="#local-6989586621682600227"><span class="hs-identifier hs-var hs-var">co2'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600210"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600211"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600212"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600213"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600220"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span id="local-6989586621682600225"><span class="annot"><span class="annottext">cow' :: Coercion
</span><a href="#local-6989586621682600225"><span class="hs-identifier hs-var hs-var">cow'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600210"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600211"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600218"><span class="hs-identifier hs-var">cow</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682600222"><span class="annot"><span class="annottext">r' :: Role
</span><a href="#local-6989586621682600222"><span class="hs-identifier hs-var hs-var">r'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600212"><span class="hs-identifier hs-var">rep</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span>
</span><span id="line-375"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600213"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682600223"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600223"><span class="hs-identifier hs-var">afl'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600224"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600224"><span class="hs-identifier hs-var">afr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; (FunTyFlag, FunTyFlag) -&gt; (FunTyFlag, FunTyFlag)
forall a. SwapFlag -&gt; (a, a) -&gt; (a, a)
</span><a href="GHC.Core.Coercion.Opt.html#swapSym"><span class="hs-identifier hs-var">swapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600211"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600216"><span class="hs-identifier hs-var">afl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600217"><span class="hs-identifier hs-var">afr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600228"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600228"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600229"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600229"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600230"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600230"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600231"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600231"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoVarCo"><span class="hs-identifier hs-type">CoVarCo</span></a></span><span> </span><span id="local-6989586621682600233"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600233"><span class="hs-identifier hs-var">cv</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600234"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600234"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; CoVar -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.html#lcLookupCoVar"><span class="hs-identifier hs-var">lcLookupCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600228"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600233"><span class="hs-identifier hs-var">cv</span></a></span><span>   </span><span class="hs-comment">-- see Note [Forall over coercion] for why</span><span>
</span><span id="line-380"></span><span>                                      </span><span class="hs-comment">-- this is the right thing here</span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;CoVarCo&quot; (ppr cv $$ ppr co) $</span><span>
</span><span id="line-382"></span><span>    </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600228"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600229"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600230"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600231"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600234"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600237"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600238"><span class="hs-identifier hs-var">ty2</span></a></span><span>   </span><span class="hs-comment">-- See Note [Optimise CoVarCo to Refl]</span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Role
</span><a href="GHC.Core.Coercion.Opt.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600230"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600231"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600237"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600241"><span class="hs-identifier hs-var">cv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-389"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600230"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600231"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600229"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-390"></span><span>    </span><span class="annot"><span class="annottext">CoVar -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600241"><span class="hs-identifier hs-var">cv1</span></a></span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682600237"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600237"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682600238"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600238"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoVar -&gt; Pair Type
CoVar -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coVarTypes"><span class="hs-identifier hs-var">coVarTypes</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600241"><span class="hs-identifier hs-var">cv1</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>    </span><span id="local-6989586621682600241"><span class="annot"><span class="annottext">cv1 :: CoVar
</span><a href="#local-6989586621682600241"><span class="hs-identifier hs-var hs-var">cv1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; CoVar -&gt; Maybe CoVar
</span><a href="GHC.Types.Var.Env.html#lookupInScope"><span class="hs-identifier hs-var">lookupInScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; InScopeSet
</span><a href="GHC.Core.Coercion.html#lcInScopeSet"><span class="hs-identifier hs-var">lcInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600228"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600233"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-396"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600246"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600246"><span class="hs-identifier hs-var">cv1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600246"><span class="hs-identifier hs-var">cv1</span></a></span><span>
</span><span id="line-397"></span><span>             </span><span class="annot"><span class="annottext">Maybe CoVar
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; CoVar -&gt; CoVar
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-398"></span><span>                          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;opt_co: not in scope&quot;</span></span><span>
</span><span id="line-399"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600233"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600228"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>                          </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600233"><span class="hs-identifier hs-var">cv</span></a></span><span>
</span><span id="line-401"></span><span>          </span><span class="hs-comment">-- cv1 might have a substituted kind!</span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#HoleCo"><span class="hs-identifier hs-type">HoleCo</span></a></span><span> </span><span id="local-6989586621682600248"><span class="annot"><span class="annottext">CoercionHole
</span><a href="#local-6989586621682600248"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; Coercion
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;opt_univ fell into a hole&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionHole -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionHole
</span><a href="#local-6989586621682600248"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600249"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600249"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600250"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600250"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600251"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600251"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600252"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600252"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AxiomCo"><span class="hs-identifier hs-type">AxiomCo</span></a></span><span> </span><span id="local-6989586621682600254"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600254"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682600255"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600255"><span class="hs-identifier hs-var">cos</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-comment">-- Do *not* push sym inside top-level axioms</span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-comment">-- e.g. if g is a top-level axiom</span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-comment">--   g a : f a ~ a</span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-comment">-- then (sym (g ty)) /= g (sym ty) !!</span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (Bool -&gt; Role -&gt; Coercion -&gt; Coercion)
-&gt; Bool
-&gt; Role
-&gt; Coercion
-&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600252"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; Role
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomRuleRole"><span class="hs-identifier hs-var">coAxiomRuleRole</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600254"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600251"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiomRule -&gt; Role
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomRuleRole"><span class="hs-identifier hs-var">coAxiomRuleRole</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600254"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-413"></span><span>    </span><span class="annot"><span class="annottext">SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600250"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-414"></span><span>                       </span><span class="hs-comment">-- some sub-cos might be P: use opt_co2</span><span>
</span><span id="line-415"></span><span>                       </span><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><span id="line-416"></span><span>    </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#AxiomCo"><span class="hs-identifier hs-var">AxiomCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600254"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Role -&gt; Coercion -&gt; Coercion)
-&gt; [Role] -&gt; [Coercion] -&gt; [Coercion]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co2"><span class="hs-identifier hs-var">opt_co2</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600249"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiomRule -&gt; [Role]
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomRuleArgRoles"><span class="hs-identifier hs-var">coAxiomRuleArgRoles</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600254"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>                         </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600255"><span class="hs-identifier hs-var">cos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>      </span><span class="hs-comment">-- Note that the_co does *not* have sym pushed into it</span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600258"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600258"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600259"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600259"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600260"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600260"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600261"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600261"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#UnivCo"><span class="hs-identifier hs-type">UnivCo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uco_prov :: Coercion -&gt; UnivCoProvenance
</span><a href="GHC.Core.TyCo.Rep.html#uco_prov"><span class="hs-identifier hs-var">uco_prov</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600264"><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600264"><span class="hs-identifier hs-var">prov</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_lty :: Coercion -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#uco_lty"><span class="hs-identifier hs-var">uco_lty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600266"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600266"><span class="hs-identifier hs-var">t1</span></a></span></span><span>
</span><span id="line-422"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_rty :: Coercion -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#uco_rty"><span class="hs-identifier hs-var">uco_rty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600268"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600268"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_deps :: Coercion -&gt; [Coercion]
</span><a href="GHC.Core.TyCo.Rep.html#uco_deps"><span class="hs-identifier hs-var">uco_deps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600270"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600270"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext
-&gt; SwapFlag
-&gt; UnivCoProvenance
-&gt; [Coercion]
-&gt; Role
-&gt; Type
-&gt; Type
-&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_univ"><span class="hs-identifier hs-var">opt_univ</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600258"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600259"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600264"><span class="hs-identifier hs-var">prov</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600270"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Role
</span><a href="GHC.Core.Coercion.Opt.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600260"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600261"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600266"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600268"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600272"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600272"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600273"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600273"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600274"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600274"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600275"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600275"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TransCo"><span class="hs-identifier hs-type">TransCo</span></a></span><span> </span><span id="local-6989586621682600277"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600277"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600278"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600278"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-comment">-- sym (g `o` h) = sym h `o` sym g</span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isSwapped"><span class="hs-identifier hs-var">isSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600273"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600280"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600281"><span class="hs-identifier hs-var">co2'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600282"><span class="hs-identifier hs-var">co1'</span></a></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600280"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600282"><span class="hs-identifier hs-var">co1'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600281"><span class="hs-identifier hs-var">co2'</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-430"></span><span>    </span><span id="local-6989586621682600282"><span class="annot"><span class="annottext">co1' :: Coercion
</span><a href="#local-6989586621682600282"><span class="hs-identifier hs-var hs-var">co1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600272"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600273"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600274"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600275"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600277"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-431"></span><span>    </span><span id="local-6989586621682600281"><span class="annot"><span class="annottext">co2' :: Coercion
</span><a href="#local-6989586621682600281"><span class="hs-identifier hs-var hs-var">co2'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600272"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600273"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600274"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600275"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600278"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-432"></span><span>    </span><span id="local-6989586621682600280"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682600280"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; InScopeSet
</span><a href="GHC.Core.Coercion.html#lcInScopeSet"><span class="hs-identifier hs-var">lcInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600272"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600283"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600283"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600284"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600284"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600285"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600285"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600286"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600286"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SelCo"><span class="hs-identifier hs-type">SelCo</span></a></span><span> </span><span id="local-6989586621682600288"><span class="annot"><span class="annottext">CoSel
</span><a href="#local-6989586621682600288"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621682600289"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600289"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-comment">-- Historical note 1: we used to check `co` for Refl, TyConAppCo etc</span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-comment">-- before optimising `co`; but actually the SelCo will have been built</span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-comment">-- with mkSelCo, so these tests always fail.</span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-comment">-- Historical note 2: if rep=True and r=Nominal, we used to recursively</span><span>
</span><span id="line-440"></span><span>  </span><span class="hs-comment">-- call opt_co4 to re-optimse the result. But (a) that is inefficient</span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-comment">-- and (b) wrapRole uses mkSubCo which does much the same job</span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600285"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600286"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoSel
</span><a href="#local-6989586621682600288"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600283"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600284"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600289"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600291"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600291"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600292"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600292"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600293"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600293"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600294"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600294"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LRCo"><span class="hs-identifier hs-type">LRCo</span></a></span><span> </span><span id="local-6989586621682600296"><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600296"><span class="hs-identifier hs-var">lr</span></a></span></span><span> </span><span id="local-6989586621682600297"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600297"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600298"><span class="annot"><span class="annottext">(Coercion, Coercion)
</span><a href="#local-6989586621682600298"><span class="hs-identifier hs-var">pr_co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600297"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (LiftingContext
    -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion)
-&gt; LiftingContext
-&gt; SwapFlag
-&gt; Bool
-&gt; Role
-&gt; Coercion
-&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600294"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600291"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600292"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600293"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LeftOrRight -&gt; (Coercion, Coercion) -&gt; Coercion
forall {a}. LeftOrRight -&gt; (a, a) -&gt; a
</span><a href="#local-6989586621682600300"><span class="hs-identifier hs-var">pick_lr</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600296"><span class="hs-identifier hs-var">lr</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion, Coercion)
</span><a href="#local-6989586621682600298"><span class="hs-identifier hs-var">pr_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600301"><span class="annot"><span class="annottext">(Coercion, Coercion)
</span><a href="#local-6989586621682600301"><span class="hs-identifier hs-var">pr_co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600302"><span class="hs-identifier hs-var">co'</span></a></span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600294"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600293"><span class="hs-identifier hs-var">rep</span></a></span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600291"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LeftOrRight -&gt; (Coercion, Coercion) -&gt; Coercion
forall {a}. LeftOrRight -&gt; (a, a) -&gt; a
</span><a href="#local-6989586621682600300"><span class="hs-identifier hs-var">pick_lr</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600296"><span class="hs-identifier hs-var">lr</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion, Coercion)
</span><a href="#local-6989586621682600301"><span class="hs-identifier hs-var">pr_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">LeftOrRight -&gt; (Coercion, Coercion) -&gt; Coercion
forall {a}. LeftOrRight -&gt; (a, a) -&gt; a
</span><a href="#local-6989586621682600300"><span class="hs-identifier hs-var">pick_lr</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600296"><span class="hs-identifier hs-var">lr</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion, Coercion)
</span><a href="#local-6989586621682600301"><span class="hs-identifier hs-var">pr_co</span></a></span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-454"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600293"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LeftOrRight -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600296"><span class="hs-identifier hs-var">lr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600302"><span class="hs-identifier hs-var">co'</span></a></span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-456"></span><span>    </span><span id="local-6989586621682600302"><span class="annot"><span class="annottext">co' :: Coercion
</span><a href="#local-6989586621682600302"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600291"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600292"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600297"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>    </span><span id="local-6989586621682600300"><span class="annot"><span class="annottext">pick_lr :: LeftOrRight -&gt; (a, a) -&gt; a
</span><a href="#local-6989586621682600300"><span class="hs-identifier hs-var hs-var">pick_lr</span></a></span></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="GHC.Types.Basic.html#CLeft"><span class="hs-identifier hs-var">CLeft</span></a></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682600304"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600304"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600304"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-459"></span><span>    </span><span class="annot"><a href="#local-6989586621682600300"><span class="hs-identifier hs-var">pick_lr</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="GHC.Types.Basic.html#CRight"><span class="hs-identifier hs-var">CRight</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600306"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600306"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600306"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span class="hs-comment">{-
Note [Forall over coercion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Example:
  type (:~:) :: forall k. k -&gt; k -&gt; Type
  Refl :: forall k (a :: k) (b :: k). forall (cv :: (~#) k k a b). (:~:) k a b
  k1,k2,k3,k4 :: Type
  eta :: (k1 ~# k2) ~# (k3 ~# k4)    ==    ((~#) Type Type k1 k2) ~# ((~#) Type Type k3 k4)
  co1_3 :: k1 ~# k3
  co2_4 :: k2 ~# k4
  nth 2 eta :: k1 ~# k3
  nth 3 eta :: k2 ~# k4
  co11_31 :: &lt;k1&gt; ~# (sym co1_3)
  co22_24 :: &lt;k2&gt; ~# co2_4
  (forall (cv :: eta). Refl &lt;Type&gt; co1_3 co2_4 (co11_31 ;; cv ;; co22_24)) ::
    (forall (cv :: k1 ~# k2). Refl Type k1 k2 (&lt;k1&gt; ;; cv ;; &lt;k2&gt;) ~#
    (forall (cv :: k3 ~# k4). Refl Type k3 k4
       (sym co1_3 ;; nth 2 eta ;; cv ;; sym (nth 3 eta) ;; co2_4))
  co1_2 :: k1 ~# k2
  co3_4 :: k3 ~# k4
  co5 :: co1_2 ~# co3_4
  InstCo (forall (cv :: eta). Refl &lt;Type&gt; co1_3 co2_4 (co11_31 ;; cv ;; co22_24)) co5 ::
   (Refl Type k1 k2 (&lt;k1&gt; ;; cv ;; &lt;k2&gt;))[cv |-&gt; co1_2] ~#
   (Refl Type k3 k4 (sym co1_3 ;; nth 2 eta ;; cv ;; sym (nth 3 eta) ;; co2_4))[cv |-&gt; co3_4]
      ==
   (Refl Type k1 k2 (&lt;k1&gt; ;; co1_2 ;; &lt;k2&gt;)) ~#
    (Refl Type k3 k4 (sym co1_3 ;; nth 2 eta ;; co3_4 ;; sym (nth 3 eta) ;; co2_4))
      ==&gt;
   Refl &lt;Type&gt; co1_3 co2_4 (co11_31 ;; co1_2 ;; co22_24)
Conclusion: Because of the way this all works, we want to put in the *left-hand*
coercion in co5's type. (In the code, co5 is called `arg`.)
So we extend the environment binding cv to arg's left-hand type.
-}</span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="hs-comment">-- See Note [Optimising InstCo]</span><span>
</span><span id="line-496"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600307"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600308"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600308"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600309"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600309"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span id="local-6989586621682600310"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600310"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#InstCo"><span class="hs-identifier hs-type">InstCo</span></a></span><span> </span><span id="local-6989586621682600312"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600312"><span class="hs-identifier hs-var">fun_co</span></a></span></span><span> </span><span id="local-6989586621682600313"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600313"><span class="hs-identifier hs-var">arg_co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>    </span><span class="hs-comment">-- forall over type...</span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600314"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600314"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600315"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600315"><span class="hs-identifier hs-var">_visL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600316"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600316"><span class="hs-identifier hs-var">_visR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600317"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600317"><span class="hs-identifier hs-var">k_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600318"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600318"><span class="hs-identifier hs-var">body_co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_ty_maybe"><span class="hs-identifier hs-var">splitForAllCo_ty_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600312"><span class="hs-identifier hs-var">fun_co</span></a></span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-comment">-- tv      :: k1</span><span>
</span><span id="line-500"></span><span>    </span><span class="hs-comment">-- k_co    :: k1 ~ k2</span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-comment">-- body_co :: t1 ~ t2</span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-comment">-- arg_co  :: (s1:k1) ~ (s2:k2)</span><span>
</span><span id="line-503"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600320"><span class="annot"><span class="annottext">arg_co' :: Coercion
</span><a href="#local-6989586621682600320"><span class="hs-identifier hs-var hs-var">arg_co'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600313"><span class="hs-identifier hs-var">arg_co</span></a></span><span>
</span><span id="line-504"></span><span>                  </span><span class="hs-comment">-- Do /not/ push Sym into the arg_co, hence sym=False</span><span>
</span><span id="line-505"></span><span>                  </span><span class="hs-comment">-- see (LC2) of Note [The LiftingContext in optCoercion]</span><span>
</span><span id="line-506"></span><span>        </span><span id="local-6989586621682600321"><span class="annot"><span class="annottext">k_co' :: Coercion
</span><a href="#local-6989586621682600321"><span class="hs-identifier hs-var hs-var">k_co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600317"><span class="hs-identifier hs-var">k_co</span></a></span><span>
</span><span id="line-507"></span><span>        </span><span id="local-6989586621682600322"><span class="annot"><span class="annottext">s2' :: Type
</span><a href="#local-6989586621682600322"><span class="hs-identifier hs-var hs-var">s2'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600320"><span class="hs-identifier hs-var">arg_co'</span></a></span><span>
</span><span id="line-508"></span><span>        </span><span id="local-6989586621682600323"><span class="annot"><span class="annottext">tv_co :: Coercion
</span><a href="#local-6989586621682600323"><span class="hs-identifier hs-var hs-var">tv_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_coherence_right_co"><span class="hs-identifier hs-var">mk_coherence_right_co</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600322"><span class="hs-identifier hs-var">s2'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600321"><span class="hs-identifier hs-var">k_co'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600320"><span class="hs-identifier hs-var">arg_co'</span></a></span><span>
</span><span id="line-509"></span><span>                   </span><span class="hs-comment">-- mkSymCo kind_co :: k2 ~ k1</span><span>
</span><span id="line-510"></span><span>                   </span><span class="hs-comment">-- tv_co   :: (s1 :: k1) ~ (((s2 :: k2) |&gt; (sym kind_co)) :: k1)</span><span>
</span><span id="line-511"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; CoVar -&gt; Coercion -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#extendLiftingContext"><span class="hs-identifier hs-var">extendLiftingContext</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600314"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600323"><span class="hs-identifier hs-var">tv_co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600308"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600309"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600310"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600318"><span class="hs-identifier hs-var">body_co</span></a></span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-comment">-- See Note [Forall over coercion]</span><span>
</span><span id="line-514"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600326"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600326"><span class="hs-identifier hs-var">cv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600327"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600327"><span class="hs-identifier hs-var">_visL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600328"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600328"><span class="hs-identifier hs-var">_visR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600329"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600329"><span class="hs-identifier hs-var">_kind_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600330"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600330"><span class="hs-identifier hs-var">body_co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_co_maybe"><span class="hs-identifier hs-var">splitForAllCo_co_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600312"><span class="hs-identifier hs-var">fun_co</span></a></span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621682600333"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600333"><span class="hs-identifier hs-var">h1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600313"><span class="hs-identifier hs-var">arg_co</span></a></span><span>
</span><span id="line-516"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600335"><span class="annot"><span class="annottext">h1' :: Coercion
</span><a href="#local-6989586621682600335"><span class="hs-identifier hs-var hs-var">h1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600333"><span class="hs-identifier hs-var">h1</span></a></span><span>
</span><span id="line-517"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; CoVar -&gt; Coercion -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#extendLiftingContextCvSubst"><span class="hs-identifier hs-var">extendLiftingContextCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600326"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600335"><span class="hs-identifier hs-var">h1'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600308"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600309"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600310"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600330"><span class="hs-identifier hs-var">body_co</span></a></span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span>  </span><span class="hs-comment">-- OK so those cases didn't work.  See if it is a forall /after/ optimization</span><span>
</span><span id="line-520"></span><span>  </span><span class="hs-comment">-- If so, do an inefficient one-variable substitution, then re-optimize</span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-comment">-- forall over type...</span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600337"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600337"><span class="hs-identifier hs-var">tv'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600338"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600338"><span class="hs-identifier hs-var">_visL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600339"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600339"><span class="hs-identifier hs-var">_visR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600340"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600340"><span class="hs-identifier hs-var">k_co'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600341"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600341"><span class="hs-identifier hs-var">body_co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_ty_maybe"><span class="hs-identifier hs-var">splitForAllCo_ty_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600342"><span class="hs-identifier hs-var">fun_co'</span></a></span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600343"><span class="annot"><span class="annottext">s2' :: Type
</span><a href="#local-6989586621682600343"><span class="hs-identifier hs-var hs-var">s2'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600344"><span class="hs-identifier hs-var">arg_co'</span></a></span><span>
</span><span id="line-525"></span><span>        </span><span id="local-6989586621682600345"><span class="annot"><span class="annottext">tv_co :: Coercion
</span><a href="#local-6989586621682600345"><span class="hs-identifier hs-var hs-var">tv_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_coherence_right_co"><span class="hs-identifier hs-var">mk_coherence_right_co</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600343"><span class="hs-identifier hs-var">s2'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600340"><span class="hs-identifier hs-var">k_co'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600344"><span class="hs-identifier hs-var">arg_co'</span></a></span><span>
</span><span id="line-526"></span><span>        </span><span id="local-6989586621682600346"><span class="annot"><span class="annottext">env' :: LiftingContext
</span><a href="#local-6989586621682600346"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; CoVar -&gt; Coercion -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#extendLiftingContext"><span class="hs-identifier hs-var">extendLiftingContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600337"><span class="hs-identifier hs-var">tv'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600345"><span class="hs-identifier hs-var">tv_co</span></a></span><span>
</span><span id="line-527"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600346"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600347"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600341"><span class="hs-identifier hs-var">body_co'</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>    </span><span class="hs-comment">-- See Note [Forall over coercion]</span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600348"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600348"><span class="hs-identifier hs-var">cv'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600349"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600349"><span class="hs-identifier hs-var">_visL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600350"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600350"><span class="hs-identifier hs-var">_visR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600351"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600351"><span class="hs-identifier hs-var">_kind_co'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600352"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600352"><span class="hs-identifier hs-var">body_co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_co_maybe"><span class="hs-identifier hs-var">splitForAllCo_co_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600342"><span class="hs-identifier hs-var">fun_co'</span></a></span><span>
</span><span id="line-531"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621682600353"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600353"><span class="hs-identifier hs-var">h1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600344"><span class="hs-identifier hs-var">arg_co'</span></a></span><span>
</span><span id="line-532"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600354"><span class="annot"><span class="annottext">env' :: LiftingContext
</span><a href="#local-6989586621682600354"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; CoVar -&gt; Coercion -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#extendLiftingContextCvSubst"><span class="hs-identifier hs-var">extendLiftingContextCvSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600348"><span class="hs-identifier hs-var">cv'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600353"><span class="hs-identifier hs-var">h1'</span></a></span><span>
</span><span id="line-533"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600354"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600347"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600352"><span class="hs-identifier hs-var">body_co'</span></a></span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span>  </span><span class="hs-comment">-- Those cases didn't work either, so rebuild the InstCo</span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-comment">-- Push Sym into /both/ function /and/ arg_coument</span><span>
</span><span id="line-537"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600342"><span class="hs-identifier hs-var">fun_co'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600344"><span class="hs-identifier hs-var">arg_co'</span></a></span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-540"></span><span>    </span><span class="hs-comment">-- fun_co' arg_co' are both optimised, /and/ we have pushed `sym` into both</span><span>
</span><span id="line-541"></span><span>    </span><span class="hs-comment">-- So no more sym'ing on th results of fun_co' arg_co'</span><span>
</span><span id="line-542"></span><span>    </span><span id="local-6989586621682600342"><span class="annot"><span class="annottext">fun_co' :: Coercion
</span><a href="#local-6989586621682600342"><span class="hs-identifier hs-var hs-var">fun_co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600308"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600309"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600310"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600312"><span class="hs-identifier hs-var">fun_co</span></a></span><span>
</span><span id="line-543"></span><span>    </span><span id="local-6989586621682600344"><span class="annot"><span class="annottext">arg_co' :: Coercion
</span><a href="#local-6989586621682600344"><span class="hs-identifier hs-var hs-var">arg_co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600307"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600308"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600313"><span class="hs-identifier hs-var">arg_co</span></a></span><span>
</span><span id="line-544"></span><span>    </span><span id="local-6989586621682600347"><span class="annot"><span class="annottext">r' :: Role
</span><a href="#local-6989586621682600347"><span class="hs-identifier hs-var hs-var">r'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Role -&gt; Role
</span><a href="GHC.Core.Coercion.Opt.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600309"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600310"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600355"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600355"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600356"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600356"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600357"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600357"><span class="hs-identifier hs-var">_rep</span></a></span></span><span> </span><span id="local-6989586621682600358"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600358"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#KindCo"><span class="hs-identifier hs-type">KindCo</span></a></span><span> </span><span id="local-6989586621682600360"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600360"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600358"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600361"><span class="annot"><span class="annottext">kco' :: Coercion
</span><a href="#local-6989586621682600361"><span class="hs-identifier hs-var hs-var">kco'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600360"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-549"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600361"><span class="hs-identifier hs-var">kco'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-550"></span><span>      </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#KindCo"><span class="hs-identifier hs-type">KindCo</span></a></span><span> </span><span id="local-6989586621682600363"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600363"><span class="hs-identifier hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600355"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600356"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600363"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>      </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600355"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600356"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600361"><span class="hs-identifier hs-var">kco'</span></a></span><span>
</span><span id="line-552"></span><span>  </span><span class="hs-comment">-- This might be able to be optimized more to do the promotion</span><span>
</span><span id="line-553"></span><span>  </span><span class="hs-comment">-- and substitution/optimization at the same time</span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_co4%27"><span class="hs-identifier hs-var">opt_co4'</span></a></span><span> </span><span id="local-6989586621682600364"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600364"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600365"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600365"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682600366"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600366"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SubCo"><span class="hs-identifier hs-type">SubCo</span></a></span><span> </span><span id="local-6989586621682600368"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600368"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600366"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-557"></span><span>    </span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600364"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600365"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600368"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span class="hs-comment">{- Note [Optimise CoVarCo to Refl]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have (c :: t~t) we can optimise it to Refl. That increases the
chances of floating the Refl upwards; e.g. Maybe c --&gt; Refl (Maybe t)

We do so here in optCoercion, not in mkCoVarCo; see Note [mkCoVarCo]
in GHC.Core.Coercion.
-}</span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span class="hs-comment">-------------</span><span>
</span><span id="line-569"></span><span class="hs-comment">-- | Optimize a phantom coercion. The input coercion may not necessarily</span><span>
</span><span id="line-570"></span><span class="hs-comment">-- be a phantom, but the output sure will be.</span><span>
</span><span id="line-571"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_phantom"><span class="hs-identifier hs-type">opt_phantom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-572"></span><span id="opt_phantom"><span class="annot"><span class="annottext">opt_phantom :: LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_phantom"><span class="hs-identifier hs-var hs-var">opt_phantom</span></a></span></span><span> </span><span id="local-6989586621682600369"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600369"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600370"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600370"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#UnivCo"><span class="hs-identifier hs-type">UnivCo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uco_prov :: Coercion -&gt; UnivCoProvenance
</span><a href="GHC.Core.TyCo.Rep.html#uco_prov"><span class="hs-identifier hs-var">uco_prov</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600371"><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600371"><span class="hs-identifier hs-var">prov</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_lty :: Coercion -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#uco_lty"><span class="hs-identifier hs-var">uco_lty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600372"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600372"><span class="hs-identifier hs-var">t1</span></a></span></span><span>
</span><span id="line-573"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_rty :: Coercion -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#uco_rty"><span class="hs-identifier hs-var">uco_rty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600373"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600373"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_deps :: Coercion -&gt; [Coercion]
</span><a href="GHC.Core.TyCo.Rep.html#uco_deps"><span class="hs-identifier hs-var">uco_deps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600374"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600374"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext
-&gt; SwapFlag
-&gt; UnivCoProvenance
-&gt; [Coercion]
-&gt; Role
-&gt; Type
-&gt; Type
-&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_univ"><span class="hs-identifier hs-var">opt_univ</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600369"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600370"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600371"><span class="hs-identifier hs-var">prov</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600374"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600372"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600373"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-575"></span><span>
</span><span id="line-576"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_phantom"><span class="hs-identifier hs-var">opt_phantom</span></a></span><span> </span><span id="local-6989586621682600375"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600375"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600376"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600376"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600377"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600377"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-577"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftingContext
-&gt; SwapFlag
-&gt; UnivCoProvenance
-&gt; [Coercion]
-&gt; Role
-&gt; Type
-&gt; Type
-&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_univ"><span class="hs-identifier hs-var">opt_univ</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600375"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600376"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="GHC.Core.TyCo.Rep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600377"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600380"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600381"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-578"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-579"></span><span>    </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682600380"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600380"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682600381"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600381"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600377"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span class="hs-comment">{- Note [Differing kinds]
   ~~~~~~~~~~~~~~~~~~~~~~
The two types may not have the same kind (although that would be very unusual).
But even if they have the same kind, and the same type constructor, the number
of arguments in a `CoTyConApp` can differ. Consider

  Any :: forall k. k

  Any @Type Int                :: Type
  Any @(Type-&gt;Type) Maybe Int  :: Type

Hence the need to compare argument lengths; see #13658

Note [opt_univ needs injectivity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If opt_univ sees a coercion between `T a1 a2` and `T b1 b2` it will optimize it
by producing a TyConAppCo for T, and pushing the UnivCo into the arguments.  But
this works only if T is injective. Otherwise we can have something like

  type family F x where
    F Int  = Int
    F Bool = Int

where `UnivCo :: F Int ~ F Bool` is reasonable (it is effectively just an
alternative representation for a couple of uses of AxiomInstCos) but we do not
want to produce `F (UnivCo :: Int ~ Bool)` where the inner coercion is clearly
inconsistent.  Hence the opt_univ case for TyConApps checks isInjectiveTyCon.
See #19509.

 -}</span><span>
</span><span id="line-611"></span><span>
</span><span id="line-612"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_univ"><span class="hs-identifier hs-type">opt_univ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#UnivCoProvenance"><span class="hs-identifier hs-type">UnivCoProvenance</span></a></span><span>
</span><span id="line-613"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-614"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-615"></span><span id="opt_univ"><span class="annot"><span class="annottext">opt_univ :: LiftingContext
-&gt; SwapFlag
-&gt; UnivCoProvenance
-&gt; [Coercion]
-&gt; Role
-&gt; Type
-&gt; Type
-&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_univ"><span class="hs-identifier hs-var hs-var">opt_univ</span></a></span></span><span> </span><span id="local-6989586621682600383"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600383"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600384"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600384"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600385"><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600385"><span class="hs-identifier hs-var">prov</span></a></span></span><span> </span><span id="local-6989586621682600386"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600386"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span id="local-6989586621682600387"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600387"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621682600388"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600388"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682600389"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600389"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-616"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600390"><span class="annot"><span class="annottext">ty1' :: Type
</span><a href="#local-6989586621682600390"><span class="hs-identifier hs-var hs-var">ty1'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; Subst
</span><a href="GHC.Core.Coercion.html#lcSubstLeft"><span class="hs-identifier hs-var">lcSubstLeft</span></a></span><span>  </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600383"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600388"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-617"></span><span>        </span><span id="local-6989586621682600393"><span class="annot"><span class="annottext">ty2' :: Type
</span><a href="#local-6989586621682600393"><span class="hs-identifier hs-var hs-var">ty2'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; Subst
</span><a href="GHC.Core.Coercion.html#lcSubstRight"><span class="hs-identifier hs-var">lcSubstRight</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600383"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600389"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-618"></span><span>        </span><span id="local-6989586621682600395"><span class="annot"><span class="annottext">deps' :: [Coercion]
</span><a href="#local-6989586621682600395"><span class="hs-identifier hs-var hs-var">deps'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; [Coercion] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600383"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600384"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600386"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-619"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682600396"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600396"><span class="hs-identifier hs-var">ty1''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600397"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600397"><span class="hs-identifier hs-var">ty2''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; (Type, Type) -&gt; (Type, Type)
forall a. SwapFlag -&gt; (a, a) -&gt; (a, a)
</span><a href="GHC.Core.Coercion.Opt.html#swapSym"><span class="hs-identifier hs-var">swapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600384"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600390"><span class="hs-identifier hs-var">ty1'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600393"><span class="hs-identifier hs-var">ty2'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-621"></span><span>    </span><span class="annot"><span class="annottext">UnivCoProvenance -&gt; [Coercion] -&gt; Role -&gt; Type -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a></span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600385"><span class="hs-identifier hs-var">prov</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600395"><span class="hs-identifier hs-var">deps'</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600387"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600396"><span class="hs-identifier hs-var">ty1''</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600397"><span class="hs-identifier hs-var">ty2''</span></a></span><span>
</span><span id="line-622"></span><span>
</span><span id="line-623"></span><span class="hs-comment">{-
opt_univ env PhantomProv cvs _r ty1 ty2
  = mkUnivCo PhantomProv cvs Phantom ty1' ty2'
  where
    ty1' = substTy (lcSubstLeft  env) ty1
    ty2' = substTy (lcSubstRight env) ty2

opt_univ1 env prov cvs' role oty1 oty2
  | Just (tc1, tys1) &lt;- splitTyConApp_maybe oty1
  , Just (tc2, tys2) &lt;- splitTyConApp_maybe oty2
  , tc1 == tc2
  , isInjectiveTyCon tc1 role  -- see Note [opt_univ needs injectivity]
  , equalLength tys1 tys2 -- see Note [Differing kinds]
      -- NB: prov must not be the two interesting ones (ProofIrrel &amp; Phantom);
      -- Phantom is already taken care of, and ProofIrrel doesn't relate tyconapps
  = let roles    = tyConRoleListX role tc1
        arg_cos  = zipWith3 (mkUnivCo prov cvs') roles tys1 tys2
        arg_cos' = zipWith (opt_co4 env False False) roles arg_cos
    in
    mkTyConAppCo role tc1 arg_cos'

  -- can't optimize the AppTy case because we can't build the kind coercions.

  | Just (Bndr tv1 vis1, ty1) &lt;- splitForAllForAllTyBinder_maybe oty1
  , isTyVar tv1
  , Just (Bndr tv2 vis2, ty2) &lt;- splitForAllForAllTyBinder_maybe oty2
  , isTyVar tv2
      -- NB: prov isn't interesting here either
  = let k1   = tyVarKind tv1
        k2   = tyVarKind tv2
        eta  = mkUnivCo prov cvs' Nominal k1 k2
          -- eta gets opt'ed soon, but not yet.
        ty2' = substTyWith [tv2] [TyVarTy tv1 `mkCastTy` eta] ty2

        (env', tv1', eta') = optForAllCoBndr env False tv1 eta
    in
    mkForAllCo tv1' vis1 vis2 eta' (opt_univ1 env' prov cvs' role ty1 ty2')

  | Just (Bndr cv1 vis1, ty1) &lt;- splitForAllForAllTyBinder_maybe oty1
  , isCoVar cv1
  , Just (Bndr cv2 vis2, ty2) &lt;- splitForAllForAllTyBinder_maybe oty2
  , isCoVar cv2
      -- NB: prov isn't interesting here either
  = let k1    = varType cv1
        k2    = varType cv2
        r'    = coVarRole cv1
        eta   = mkUnivCo prov cvs' Nominal k1 k2
        eta_d = downgradeRole r' Nominal eta
          -- eta gets opt'ed soon, but not yet.
        n_co  = (mkSymCo $ mkSelCo (SelTyCon 2 r') eta_d) `mkTransCo`
                (mkCoVarCo cv1) `mkTransCo`
                (mkSelCo (SelTyCon 3 r') eta_d)
        ty2'  = substTyWithCoVars [cv2] [n_co] ty2

        (env', cv1', eta') = optForAllCoBndr env False cv1 eta
    in
    mkForAllCo cv1' vis1 vis2 eta' (opt_univ1 env' prov cvs' role ty1 ty2')

  | otherwise
  = let ty1 = substTyUnchecked (lcSubstLeft  env) oty1
        ty2 = substTyUnchecked (lcSubstRight env) oty2
    in
    mkUnivCo prov cvs' role ty1 ty2
-}</span><span>
</span><span id="line-687"></span><span>
</span><span id="line-688"></span><span class="hs-comment">-------------</span><span>
</span><span id="line-689"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-type">opt_transList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-690"></span><span id="opt_transList"><span class="annot"><span class="annottext">opt_transList :: HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var hs-var">opt_transList</span></a></span></span><span> </span><span id="local-6989586621682600403"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600403"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; (Coercion -&gt; Coercion -&gt; Coercion)
-&gt; [Coercion]
-&gt; [Coercion]
-&gt; [Coercion]
forall a b c.
HasDebugCallStack =&gt;
String -&gt; (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="GHC.Utils.Misc.html#zipWithEqual"><span class="hs-identifier hs-var">zipWithEqual</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;opt_transList&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600403"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-691"></span><span>  </span><span class="hs-comment">-- The input lists must have identical length.</span><span>
</span><span id="line-692"></span><span>
</span><span id="line-693"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-type">opt_trans</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-694"></span><span>
</span><span id="line-695"></span><span class="hs-comment">-- opt_trans just allows us to add some debug tracing</span><span>
</span><span id="line-696"></span><span class="hs-comment">-- Usually it just goes to opt_trans'</span><span>
</span><span id="line-697"></span><span id="opt_trans"><span class="annot"><span class="annottext">opt_trans :: HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var hs-var">opt_trans</span></a></span></span><span> </span><span id="local-6989586621682600407"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600407"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600408"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600408"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600409"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600409"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- (if coercionRKind co1 `eqType` coercionLKind co2</span><span>
</span><span id="line-699"></span><span>    </span><span class="hs-comment">--  then (\x -&gt; x) else</span><span>
</span><span id="line-700"></span><span>    </span><span class="hs-comment">--  pprTrace &quot;opt_trans&quot; (vcat [ text &quot;co1&quot; &lt;+&gt; ppr co1</span><span>
</span><span id="line-701"></span><span>    </span><span class="hs-comment">--                             , text &quot;co2&quot; &lt;+&gt; ppr co2</span><span>
</span><span id="line-702"></span><span>    </span><span class="hs-comment">--                             , text &quot;co1 kind&quot; &lt;+&gt; ppr (coercionKind co1)</span><span>
</span><span id="line-703"></span><span>    </span><span class="hs-comment">--                             , text &quot;co2 kind&quot; &lt;+&gt; ppr (coercionKind co2)</span><span>
</span><span id="line-704"></span><span>    </span><span class="hs-comment">--                             , callStackDoc ])) $</span><span>
</span><span id="line-705"></span><span>    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans%27"><span class="hs-identifier hs-var">opt_trans'</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600407"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600408"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600409"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span class="hs-comment">{-
opt_trans is co1 co2
  = assertPpr (r1==r2) (vcat [ ppr r1 &lt;+&gt; ppr co1, ppr r2 &lt;+&gt; ppr co2]) $
    assertPpr (rres == r1) (vcat [ ppr r1 &lt;+&gt; ppr co1, ppr r2 &lt;+&gt; ppr co2, text &quot;res&quot; &lt;+&gt; ppr rres &lt;+&gt; ppr res ]) $
    res
  where
    res = opt_trans' is co1 co2
    rres = coercionRole res
    r1 = coercionRole co1
    r2 = coercionRole co1
-}</span><span>
</span><span id="line-718"></span><span>
</span><span id="line-719"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans%27"><span class="hs-identifier hs-type">opt_trans'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-720"></span><span id="opt_trans%27"><span class="annot"><span class="annottext">opt_trans' :: HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans%27"><span class="hs-identifier hs-var hs-var">opt_trans'</span></a></span></span><span> </span><span id="local-6989586621682600413"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600413"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600414"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600414"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600415"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600415"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-721"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600414"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600415"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-722"></span><span>    </span><span class="hs-comment">-- optimize when co1 is a Refl Co</span><span>
</span><span id="line-723"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans1"><span class="hs-identifier hs-var">opt_trans1</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600413"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600414"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600415"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans1"><span class="hs-identifier hs-type">opt_trans1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-726"></span><span class="hs-comment">-- First arg is not the identity</span><span>
</span><span id="line-727"></span><span id="opt_trans1"><span class="annot"><span class="annottext">opt_trans1 :: HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans1"><span class="hs-identifier hs-var hs-var">opt_trans1</span></a></span></span><span> </span><span id="local-6989586621682600419"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600419"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600420"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600420"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600421"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600421"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-728"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600421"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600420"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-729"></span><span>    </span><span class="hs-comment">-- optimize when co2 is a Refl Co</span><span>
</span><span id="line-730"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans2"><span class="hs-identifier hs-var">opt_trans2</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600419"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600420"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600421"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans2"><span class="hs-identifier hs-type">opt_trans2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-733"></span><span class="hs-comment">-- Neither arg is the identity</span><span>
</span><span id="line-734"></span><span id="opt_trans2"><span class="annot"><span class="annottext">opt_trans2 :: HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans2"><span class="hs-identifier hs-var hs-var">opt_trans2</span></a></span></span><span> </span><span id="local-6989586621682600430"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600430"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TransCo"><span class="hs-identifier hs-type">TransCo</span></a></span><span> </span><span id="local-6989586621682600431"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600431"><span class="hs-identifier hs-var">co1a</span></a></span></span><span> </span><span id="local-6989586621682600432"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600432"><span class="hs-identifier hs-var">co1b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600433"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600433"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-735"></span><span>    </span><span class="hs-comment">-- Don't know whether the sub-coercions are the identity</span><span>
</span><span id="line-736"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600430"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600431"><span class="hs-identifier hs-var">co1a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600430"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600432"><span class="hs-identifier hs-var">co1b</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600433"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>
</span><span id="line-738"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans2"><span class="hs-identifier hs-var">opt_trans2</span></a></span><span> </span><span id="local-6989586621682600434"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600434"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600435"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600435"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600436"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600436"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-739"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600437"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600437"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600434"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600435"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600436"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-740"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600437"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans2"><span class="hs-identifier hs-var">opt_trans2</span></a></span><span> </span><span id="local-6989586621682600439"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600439"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600440"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600440"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TransCo"><span class="hs-identifier hs-type">TransCo</span></a></span><span> </span><span id="local-6989586621682600441"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600441"><span class="hs-identifier hs-var">co2a</span></a></span></span><span> </span><span id="local-6989586621682600442"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600442"><span class="hs-identifier hs-var">co2b</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-743"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600443"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600443"><span class="hs-identifier hs-var">co1_2a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600439"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600440"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600441"><span class="hs-identifier hs-var">co2a</span></a></span><span>
</span><span id="line-744"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600443"><span class="hs-identifier hs-var">co1_2a</span></a></span><span>
</span><span id="line-745"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600442"><span class="hs-identifier hs-var">co2b</span></a></span><span>
</span><span id="line-746"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans1"><span class="hs-identifier hs-var">opt_trans1</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600439"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600443"><span class="hs-identifier hs-var">co1_2a</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600442"><span class="hs-identifier hs-var">co2b</span></a></span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans2"><span class="hs-identifier hs-var">opt_trans2</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682600444"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600444"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600445"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600445"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-749"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_trans_co"><span class="hs-identifier hs-var">mk_trans_co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600444"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600445"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-750"></span><span>
</span><span id="line-751"></span><span>
</span><span id="line-752"></span><span class="hs-comment">------</span><span>
</span><span id="line-753"></span><span class="hs-comment">-- Optimize coercions with a top-level use of transitivity.</span><span>
</span><span id="line-754"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-type">opt_trans_rule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a></span><span>
</span><span id="line-755"></span><span>
</span><span id="line-756"></span><span id="opt_trans_rule"><span class="annot"><span class="annottext">opt_trans_rule :: HasDebugCallStack =&gt;
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var hs-var">opt_trans_rule</span></a></span></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682600538"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600538"><span class="hs-identifier hs-var">in_co1</span></a></span></span><span> </span><span id="local-6989586621682600539"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600539"><span class="hs-identifier hs-var">in_co2</span></a></span></span><span>
</span><span id="line-757"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600538"><span class="hs-identifier hs-var">in_co1</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600539"><span class="hs-identifier hs-var">in_co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-758"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in_co1&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600538"><span class="hs-identifier hs-var">in_co1</span></a></span><span>
</span><span id="line-759"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in_co2&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600539"><span class="hs-identifier hs-var">in_co2</span></a></span><span>
</span><span id="line-760"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in_co1 kind&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Pair Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600538"><span class="hs-identifier hs-var">in_co1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-761"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in_co2 kind&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Pair Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600539"><span class="hs-identifier hs-var">in_co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SDoc
HasCallStack =&gt; SDoc
</span><a href="GHC.Utils.Panic.html#callStackDoc"><span class="hs-identifier hs-var">callStackDoc</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-763"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-764"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Coercion
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;opt_trans_rule&quot;</span></span><span>  </span><span class="hs-comment">-- This entire equation is purely assertion checking</span><span>
</span><span id="line-765"></span><span>
</span><span id="line-766"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600542"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600542"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600543"><span class="annot"><span class="annottext">in_co1 :: Coercion
</span><a href="#local-6989586621682600543"><span class="hs-identifier hs-var">in_co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#GRefl"><span class="hs-identifier hs-type">GRefl</span></a></span><span> </span><span id="local-6989586621682600544"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600544"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621682600545"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600545"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682600546"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600546"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600547"><span class="annot"><span class="annottext">in_co2 :: Coercion
</span><a href="#local-6989586621682600547"><span class="hs-identifier hs-var">in_co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#GRefl"><span class="hs-identifier hs-type">GRefl</span></a></span><span> </span><span id="local-6989586621682600548"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600548"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span id="local-6989586621682600549"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600549"><span class="hs-identifier hs-var">_t2</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621682600550"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600550"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Coercion -&gt; Maybe Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600544"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600548"><span class="hs-identifier hs-var">r2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Coercion -&gt; Maybe Coercion)
-&gt; Maybe Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-768"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GRefl&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600543"><span class="hs-identifier hs-var">in_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600547"><span class="hs-identifier hs-var">in_co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-769"></span><span>    </span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_grefl_right_co"><span class="hs-identifier hs-var">mk_grefl_right_co</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600544"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600545"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600542"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600546"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600550"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>
</span><span id="line-771"></span><span class="hs-comment">-- Push transitivity through matching destructors</span><span>
</span><span id="line-772"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600553"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600553"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600554"><span class="annot"><span class="annottext">in_co1 :: Coercion
</span><a href="#local-6989586621682600554"><span class="hs-identifier hs-var">in_co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SelCo"><span class="hs-identifier hs-type">SelCo</span></a></span><span> </span><span id="local-6989586621682600555"><span class="annot"><span class="annottext">CoSel
</span><a href="#local-6989586621682600555"><span class="hs-identifier hs-var">d1</span></a></span></span><span> </span><span id="local-6989586621682600556"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600556"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600557"><span class="annot"><span class="annottext">in_co2 :: Coercion
</span><a href="#local-6989586621682600557"><span class="hs-identifier hs-var">in_co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SelCo"><span class="hs-identifier hs-type">SelCo</span></a></span><span> </span><span id="local-6989586621682600558"><span class="annot"><span class="annottext">CoSel
</span><a href="#local-6989586621682600558"><span class="hs-identifier hs-var">d2</span></a></span></span><span> </span><span id="local-6989586621682600559"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600559"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoSel
</span><a href="#local-6989586621682600555"><span class="hs-identifier hs-var">d1</span></a></span><span> </span><span class="annot"><span class="annottext">CoSel -&gt; CoSel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CoSel
</span><a href="#local-6989586621682600558"><span class="hs-identifier hs-var">d2</span></a></span><span>
</span><span id="line-774"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Role
</span><a href="GHC.Core.Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600556"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Role
</span><a href="GHC.Core.Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600559"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-775"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600556"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.Opt.html#compatible_co"><span class="hs-operator hs-var">`compatible_co`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600559"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-776"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PushNth&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600554"><span class="hs-identifier hs-var">in_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600557"><span class="hs-identifier hs-var">in_co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-777"></span><span>    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoSel
</span><a href="#local-6989586621682600555"><span class="hs-identifier hs-var">d1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600553"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600556"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600559"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span>
</span><span id="line-779"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600561"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600561"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600562"><span class="annot"><span class="annottext">in_co1 :: Coercion
</span><a href="#local-6989586621682600562"><span class="hs-identifier hs-var">in_co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LRCo"><span class="hs-identifier hs-type">LRCo</span></a></span><span> </span><span id="local-6989586621682600563"><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600563"><span class="hs-identifier hs-var">d1</span></a></span></span><span> </span><span id="local-6989586621682600564"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600564"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600565"><span class="annot"><span class="annottext">in_co2 :: Coercion
</span><a href="#local-6989586621682600565"><span class="hs-identifier hs-var">in_co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LRCo"><span class="hs-identifier hs-type">LRCo</span></a></span><span> </span><span id="local-6989586621682600566"><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600566"><span class="hs-identifier hs-var">d2</span></a></span></span><span> </span><span id="local-6989586621682600567"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600567"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-780"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600563"><span class="hs-identifier hs-var">d1</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight -&gt; LeftOrRight -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600566"><span class="hs-identifier hs-var">d2</span></a></span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600564"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.Opt.html#compatible_co"><span class="hs-operator hs-var">`compatible_co`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600567"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-782"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PushLR&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600562"><span class="hs-identifier hs-var">in_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600565"><span class="hs-identifier hs-var">in_co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-783"></span><span>    </span><span class="annot"><span class="annottext">LeftOrRight -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkLRCo"><span class="hs-identifier hs-var">mkLRCo</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="#local-6989586621682600563"><span class="hs-identifier hs-var">d1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600561"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600564"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600567"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-784"></span><span>
</span><span id="line-785"></span><span class="hs-comment">-- Push transitivity inside instantiation</span><span>
</span><span id="line-786"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600569"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600569"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600570"><span class="annot"><span class="annottext">in_co1 :: Coercion
</span><a href="#local-6989586621682600570"><span class="hs-identifier hs-var">in_co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#InstCo"><span class="hs-identifier hs-type">InstCo</span></a></span><span> </span><span id="local-6989586621682600571"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600571"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600572"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600572"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600573"><span class="annot"><span class="annottext">in_co2 :: Coercion
</span><a href="#local-6989586621682600573"><span class="hs-identifier hs-var">in_co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#InstCo"><span class="hs-identifier hs-type">InstCo</span></a></span><span> </span><span id="local-6989586621682600574"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600574"><span class="hs-identifier hs-var">co2</span></a></span></span><span> </span><span id="local-6989586621682600575"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600575"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-787"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600572"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#eqCoercion"><span class="hs-operator hs-var">`eqCoercion`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600575"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-788"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600571"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.Opt.html#compatible_co"><span class="hs-operator hs-var">`compatible_co`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600574"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-789"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TrPushInst&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600570"><span class="hs-identifier hs-var">in_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600573"><span class="hs-identifier hs-var">in_co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-790"></span><span>    </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600569"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600571"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600574"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600572"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-791"></span><span>
</span><span id="line-792"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-793"></span><span>    </span><span id="local-6989586621682600578"><span class="annot"><span class="annottext">in_co1 :: Coercion
</span><a href="#local-6989586621682600578"><span class="hs-identifier hs-var">in_co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#UnivCo"><span class="hs-identifier hs-type">UnivCo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uco_prov :: Coercion -&gt; UnivCoProvenance
</span><a href="GHC.Core.TyCo.Rep.html#uco_prov"><span class="hs-identifier hs-var">uco_prov</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600579"><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600579"><span class="hs-identifier hs-var">p1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_role :: Coercion -&gt; Role
</span><a href="GHC.Core.TyCo.Rep.html#uco_role"><span class="hs-identifier hs-var">uco_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600581"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600581"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_lty :: Coercion -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#uco_lty"><span class="hs-identifier hs-var">uco_lty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600582"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600582"><span class="hs-identifier hs-var">tyl1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_deps :: Coercion -&gt; [Coercion]
</span><a href="GHC.Core.TyCo.Rep.html#uco_deps"><span class="hs-identifier hs-var">uco_deps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600583"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600583"><span class="hs-identifier hs-var">deps1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>    </span><span id="local-6989586621682600584"><span class="annot"><span class="annottext">in_co2 :: Coercion
</span><a href="#local-6989586621682600584"><span class="hs-identifier hs-var">in_co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#UnivCo"><span class="hs-identifier hs-type">UnivCo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uco_prov :: Coercion -&gt; UnivCoProvenance
</span><a href="GHC.Core.TyCo.Rep.html#uco_prov"><span class="hs-identifier hs-var">uco_prov</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600585"><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600585"><span class="hs-identifier hs-var">p2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_role :: Coercion -&gt; Role
</span><a href="GHC.Core.TyCo.Rep.html#uco_role"><span class="hs-identifier hs-var">uco_role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600586"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600586"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_rty :: Coercion -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#uco_rty"><span class="hs-identifier hs-var">uco_rty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600587"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600587"><span class="hs-identifier hs-var">tyr2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uco_deps :: Coercion -&gt; [Coercion]
</span><a href="GHC.Core.TyCo.Rep.html#uco_deps"><span class="hs-identifier hs-var">uco_deps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600588"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600588"><span class="hs-identifier hs-var">deps2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-795"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600579"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance -&gt; UnivCoProvenance -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600585"><span class="hs-identifier hs-var">p2</span></a></span><span>    </span><span class="hs-comment">-- If the provenances are different, opt'ing will be very confusing</span><span>
</span><span id="line-796"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Coercion -&gt; Maybe Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600581"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600586"><span class="hs-identifier hs-var">r2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Coercion -&gt; Maybe Coercion)
-&gt; Maybe Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-797"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UnivCo&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600578"><span class="hs-identifier hs-var">in_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600584"><span class="hs-identifier hs-var">in_co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-798"></span><span>    </span><span class="annot"><span class="annottext">UnivCoProvenance -&gt; [Coercion] -&gt; Role -&gt; Type -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a></span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621682600579"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600583"><span class="hs-identifier hs-var">deps1</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion] -&gt; [Coercion] -&gt; [Coercion]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600588"><span class="hs-identifier hs-var">deps2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600581"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600582"><span class="hs-identifier hs-var">tyl1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600587"><span class="hs-identifier hs-var">tyr2</span></a></span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span class="hs-comment">-- Push transitivity down through matching top-level constructors.</span><span>
</span><span id="line-801"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600589"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600589"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600590"><span class="annot"><span class="annottext">in_co1 :: Coercion
</span><a href="#local-6989586621682600590"><span class="hs-identifier hs-var">in_co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConAppCo"><span class="hs-identifier hs-type">TyConAppCo</span></a></span><span> </span><span id="local-6989586621682600591"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600591"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621682600592"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600592"><span class="hs-identifier hs-var">tc1</span></a></span></span><span> </span><span id="local-6989586621682600593"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600593"><span class="hs-identifier hs-var">cos1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600594"><span class="annot"><span class="annottext">in_co2 :: Coercion
</span><a href="#local-6989586621682600594"><span class="hs-identifier hs-var">in_co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConAppCo"><span class="hs-identifier hs-type">TyConAppCo</span></a></span><span> </span><span id="local-6989586621682600595"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600595"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span id="local-6989586621682600596"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600596"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span id="local-6989586621682600597"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600597"><span class="hs-identifier hs-var">cos2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600592"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600596"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-803"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Coercion -&gt; Maybe Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600591"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600595"><span class="hs-identifier hs-var">r2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Coercion -&gt; Maybe Coercion)
-&gt; Maybe Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-804"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PushTyConApp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600590"><span class="hs-identifier hs-var">in_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600594"><span class="hs-identifier hs-var">in_co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-805"></span><span>    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600591"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600592"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600589"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600593"><span class="hs-identifier hs-var">cos1</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600597"><span class="hs-identifier hs-var">cos2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600598"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600598"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600599"><span class="annot"><span class="annottext">in_co1 :: Coercion
</span><a href="#local-6989586621682600599"><span class="hs-identifier hs-var">in_co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunCo"><span class="hs-identifier hs-type">FunCo</span></a></span><span> </span><span id="local-6989586621682600600"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600600"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621682600601"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600601"><span class="hs-identifier hs-var">afl1</span></a></span></span><span> </span><span id="local-6989586621682600602"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600602"><span class="hs-identifier hs-var">afr1</span></a></span></span><span> </span><span id="local-6989586621682600603"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600603"><span class="hs-identifier hs-var">w1</span></a></span></span><span> </span><span id="local-6989586621682600604"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600604"><span class="hs-identifier hs-var">co1a</span></a></span></span><span> </span><span id="local-6989586621682600605"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600605"><span class="hs-identifier hs-var">co1b</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-808"></span><span>                  </span><span id="local-6989586621682600606"><span class="annot"><span class="annottext">in_co2 :: Coercion
</span><a href="#local-6989586621682600606"><span class="hs-identifier hs-var">in_co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunCo"><span class="hs-identifier hs-type">FunCo</span></a></span><span> </span><span id="local-6989586621682600607"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600607"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span id="local-6989586621682600608"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600608"><span class="hs-identifier hs-var">afl2</span></a></span></span><span> </span><span id="local-6989586621682600609"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600609"><span class="hs-identifier hs-var">afr2</span></a></span></span><span> </span><span id="local-6989586621682600610"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600610"><span class="hs-identifier hs-var">w2</span></a></span></span><span> </span><span id="local-6989586621682600611"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600611"><span class="hs-identifier hs-var">co2a</span></a></span></span><span> </span><span id="local-6989586621682600612"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600612"><span class="hs-identifier hs-var">co2b</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-809"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Coercion -&gt; Maybe Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600600"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600607"><span class="hs-identifier hs-var">r2</span></a></span><span class="hs-special">)</span><span>     </span><span class="annot"><span class="annottext">(Maybe Coercion -&gt; Maybe Coercion)
-&gt; Maybe Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>     </span><span class="hs-comment">-- Just like the TyConAppCo/TyConAppCo case</span><span>
</span><span id="line-810"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Coercion -&gt; Maybe Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600602"><span class="hs-identifier hs-var">afr1</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; FunTyFlag -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600608"><span class="hs-identifier hs-var">afl2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Coercion -&gt; Maybe Coercion)
-&gt; Maybe Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-811"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PushFun&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600599"><span class="hs-identifier hs-var">in_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600606"><span class="hs-identifier hs-var">in_co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-812"></span><span>    </span><span class="annot"><span class="annottext">Role
-&gt; FunTyFlag
-&gt; FunTyFlag
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkFunCo2"><span class="hs-identifier hs-var">mkFunCo2</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600600"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600601"><span class="hs-identifier hs-var">afl1</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682600609"><span class="hs-identifier hs-var">afr2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600598"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600603"><span class="hs-identifier hs-var">w1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600610"><span class="hs-identifier hs-var">w2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-813"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600598"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600604"><span class="hs-identifier hs-var">co1a</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600611"><span class="hs-identifier hs-var">co2a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-814"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600598"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600605"><span class="hs-identifier hs-var">co1b</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600612"><span class="hs-identifier hs-var">co2b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>
</span><span id="line-816"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600613"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600613"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600614"><span class="annot"><span class="annottext">in_co1 :: Coercion
</span><a href="#local-6989586621682600614"><span class="hs-identifier hs-var">in_co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppCo"><span class="hs-identifier hs-type">AppCo</span></a></span><span> </span><span id="local-6989586621682600615"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600615"><span class="hs-identifier hs-var">co1a</span></a></span></span><span> </span><span id="local-6989586621682600616"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600616"><span class="hs-identifier hs-var">co1b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600617"><span class="annot"><span class="annottext">in_co2 :: Coercion
</span><a href="#local-6989586621682600617"><span class="hs-identifier hs-var">in_co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppCo"><span class="hs-identifier hs-type">AppCo</span></a></span><span> </span><span id="local-6989586621682600618"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600618"><span class="hs-identifier hs-var">co2a</span></a></span></span><span> </span><span id="local-6989586621682600619"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600619"><span class="hs-identifier hs-var">co2b</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span>  </span><span class="hs-comment">-- Must call opt_trans_rule_app; see Note [EtaAppCo]</span><span>
</span><span id="line-818"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
-&gt; [Coercion]
-&gt; Coercion
-&gt; [Coercion]
-&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule_app"><span class="hs-identifier hs-var">opt_trans_rule_app</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600613"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600614"><span class="hs-identifier hs-var">in_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600617"><span class="hs-identifier hs-var">in_co2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600615"><span class="hs-identifier hs-var">co1a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600616"><span class="hs-identifier hs-var">co1b</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600618"><span class="hs-identifier hs-var">co2a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600619"><span class="hs-identifier hs-var">co2b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-819"></span><span>
</span><span id="line-820"></span><span class="hs-comment">-- Eta rules</span><span>
</span><span id="line-821"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600621"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600621"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600622"><span class="annot"><span class="annottext">co1 :: Coercion
</span><a href="#local-6989586621682600622"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConAppCo"><span class="hs-identifier hs-type">TyConAppCo</span></a></span><span> </span><span id="local-6989586621682600623"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600623"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621682600624"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600624"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682600625"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600625"><span class="hs-identifier hs-var">cos1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600626"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600626"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-822"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600627"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600627"><span class="hs-identifier hs-var">cos2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Coercion -&gt; Maybe [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#etaTyConAppCo_maybe"><span class="hs-identifier hs-var">etaTyConAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600624"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600626"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-823"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;EtaCompL&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600622"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600626"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-824"></span><span>    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600623"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600624"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600621"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600625"><span class="hs-identifier hs-var">cos1</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600627"><span class="hs-identifier hs-var">cos2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600629"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600629"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600630"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600630"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600631"><span class="annot"><span class="annottext">co2 :: Coercion
</span><a href="#local-6989586621682600631"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConAppCo"><span class="hs-identifier hs-type">TyConAppCo</span></a></span><span> </span><span id="local-6989586621682600632"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600632"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621682600633"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600633"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682600634"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600634"><span class="hs-identifier hs-var">cos2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-827"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600635"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600635"><span class="hs-identifier hs-var">cos1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Coercion -&gt; Maybe [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#etaTyConAppCo_maybe"><span class="hs-identifier hs-var">etaTyConAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600633"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600630"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-828"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;EtaCompR&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600630"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600631"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-829"></span><span>    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600632"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600633"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600629"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600635"><span class="hs-identifier hs-var">cos1</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600634"><span class="hs-identifier hs-var">cos2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-830"></span><span>
</span><span id="line-831"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600636"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600636"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600637"><span class="annot"><span class="annottext">co1 :: Coercion
</span><a href="#local-6989586621682600637"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppCo"><span class="hs-identifier hs-type">AppCo</span></a></span><span> </span><span id="local-6989586621682600638"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600638"><span class="hs-identifier hs-var">co1a</span></a></span></span><span> </span><span id="local-6989586621682600639"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600639"><span class="hs-identifier hs-var">co1b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682600640"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600640"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-832"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600641"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600641"><span class="hs-identifier hs-var">co2a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682600642"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600642"><span class="hs-identifier hs-var">co2b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaAppCo_maybe"><span class="hs-identifier hs-var">etaAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600640"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-833"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
-&gt; [Coercion]
-&gt; Coercion
-&gt; [Coercion]
-&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule_app"><span class="hs-identifier hs-var">opt_trans_rule_app</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600636"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600637"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600640"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600638"><span class="hs-identifier hs-var">co1a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600639"><span class="hs-identifier hs-var">co1b</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600641"><span class="hs-identifier hs-var">co2a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600642"><span class="hs-identifier hs-var">co2b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-834"></span><span>
</span><span id="line-835"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600644"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600644"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600645"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600645"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600646"><span class="annot"><span class="annottext">co2 :: Coercion
</span><a href="#local-6989586621682600646"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppCo"><span class="hs-identifier hs-type">AppCo</span></a></span><span> </span><span id="local-6989586621682600647"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600647"><span class="hs-identifier hs-var">co2a</span></a></span></span><span> </span><span id="local-6989586621682600648"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600648"><span class="hs-identifier hs-var">co2b</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-836"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600649"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600649"><span class="hs-identifier hs-var">co1a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682600650"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600650"><span class="hs-identifier hs-var">co1b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaAppCo_maybe"><span class="hs-identifier hs-var">etaAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600645"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-837"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
-&gt; [Coercion]
-&gt; Coercion
-&gt; [Coercion]
-&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule_app"><span class="hs-identifier hs-var">opt_trans_rule_app</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600644"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600645"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600646"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600649"><span class="hs-identifier hs-var">co1a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600650"><span class="hs-identifier hs-var">co1b</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600647"><span class="hs-identifier hs-var">co2a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600648"><span class="hs-identifier hs-var">co2b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span class="hs-comment">-- Push transitivity inside forall</span><span>
</span><span id="line-840"></span><span class="hs-comment">-- forall over types.</span><span>
</span><span id="line-841"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600651"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600651"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600652"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600652"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600653"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600653"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-842"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600654"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600654"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600655"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600655"><span class="hs-identifier hs-var">visL1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600656"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600656"><span class="hs-identifier hs-var">_visR1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600657"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600657"><span class="hs-identifier hs-var">eta1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600658"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600658"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_ty_maybe"><span class="hs-identifier hs-var">splitForAllCo_ty_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600652"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-843"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600659"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600659"><span class="hs-identifier hs-var">tv2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600660"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600660"><span class="hs-identifier hs-var">_visL2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600661"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600661"><span class="hs-identifier hs-var">visR2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600662"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600662"><span class="hs-identifier hs-var">eta2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600663"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600663"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaForAllCo_ty_maybe"><span class="hs-identifier hs-var">etaForAllCo_ty_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600653"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-844"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; ForAllTyFlag
-&gt; ForAllTyFlag
-&gt; Maybe Coercion
</span><a href="#local-6989586621682600665"><span class="hs-identifier hs-var">push_trans</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600654"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600657"><span class="hs-identifier hs-var">eta1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600658"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600659"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600662"><span class="hs-identifier hs-var">eta2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600663"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600655"><span class="hs-identifier hs-var">visL1</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600661"><span class="hs-identifier hs-var">visR2</span></a></span><span>
</span><span id="line-845"></span><span>
</span><span id="line-846"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600666"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600666"><span class="hs-identifier hs-var">tv2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600667"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600667"><span class="hs-identifier hs-var">_visL2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600668"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600668"><span class="hs-identifier hs-var">visR2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600669"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600669"><span class="hs-identifier hs-var">eta2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600670"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600670"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_ty_maybe"><span class="hs-identifier hs-var">splitForAllCo_ty_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600653"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-847"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600671"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600671"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600672"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600672"><span class="hs-identifier hs-var">visL1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600673"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600673"><span class="hs-identifier hs-var">_visR1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600674"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600674"><span class="hs-identifier hs-var">eta1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600675"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600675"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaForAllCo_ty_maybe"><span class="hs-identifier hs-var">etaForAllCo_ty_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600652"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-848"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; ForAllTyFlag
-&gt; ForAllTyFlag
-&gt; Maybe Coercion
</span><a href="#local-6989586621682600665"><span class="hs-identifier hs-var">push_trans</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600671"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600674"><span class="hs-identifier hs-var">eta1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600675"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600666"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600669"><span class="hs-identifier hs-var">eta2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600670"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600672"><span class="hs-identifier hs-var">visL1</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600668"><span class="hs-identifier hs-var">visR2</span></a></span><span>
</span><span id="line-849"></span><span>
</span><span id="line-850"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-851"></span><span>  </span><span id="local-6989586621682600665"><span class="annot"><span class="annottext">push_trans :: CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; ForAllTyFlag
-&gt; ForAllTyFlag
-&gt; Maybe Coercion
</span><a href="#local-6989586621682600665"><span class="hs-identifier hs-var hs-var">push_trans</span></a></span></span><span> </span><span id="local-6989586621682600676"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600676"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621682600677"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600677"><span class="hs-identifier hs-var">eta1</span></a></span></span><span> </span><span id="local-6989586621682600678"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600678"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621682600679"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600679"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span id="local-6989586621682600680"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600680"><span class="hs-identifier hs-var">eta2</span></a></span></span><span> </span><span id="local-6989586621682600681"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600681"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span id="local-6989586621682600682"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600682"><span class="hs-identifier hs-var">visL</span></a></span></span><span> </span><span id="local-6989586621682600683"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600683"><span class="hs-identifier hs-var">visR</span></a></span></span><span>
</span><span id="line-852"></span><span>    </span><span class="hs-comment">-- Given:</span><span>
</span><span id="line-853"></span><span>    </span><span class="hs-comment">--   co1 = /\ tv1 : eta1 &lt;visL, visM&gt;. r1</span><span>
</span><span id="line-854"></span><span>    </span><span class="hs-comment">--   co2 = /\ tv2 : eta2 &lt;visM, visR&gt;. r2</span><span>
</span><span id="line-855"></span><span>    </span><span class="hs-comment">-- Wanted:</span><span>
</span><span id="line-856"></span><span>    </span><span class="hs-comment">--   /\tv1 : (eta1;eta2) &lt;visL, visR&gt;.  (r1; r2[tv2 |-&gt; tv1 |&gt; eta1])</span><span>
</span><span id="line-857"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;EtaAllTy_ty&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600652"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600653"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-858"></span><span>      </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
CoVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
CoVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600676"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600682"><span class="hs-identifier hs-var">visL</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600683"><span class="hs-identifier hs-var">visR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600651"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600677"><span class="hs-identifier hs-var">eta1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600680"><span class="hs-identifier hs-var">eta2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600684"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600678"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600685"><span class="hs-identifier hs-var">r2'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-859"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-860"></span><span>      </span><span id="local-6989586621682600684"><span class="annot"><span class="annottext">is' :: InScopeSet
</span><a href="#local-6989586621682600684"><span class="hs-identifier hs-var hs-var">is'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600651"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; CoVar -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600676"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-861"></span><span>      </span><span id="local-6989586621682600685"><span class="annot"><span class="annottext">r2' :: Coercion
</span><a href="#local-6989586621682600685"><span class="hs-identifier hs-var hs-var">r2'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoVar] -&gt; [Type] -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCoWithUnchecked"><span class="hs-identifier hs-var">substCoWithUnchecked</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600679"><span class="hs-identifier hs-var">tv2</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; Coercion -&gt; Type
</span><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600676"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600677"><span class="hs-identifier hs-var">eta1</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600681"><span class="hs-identifier hs-var">r2</span></a></span><span>
</span><span id="line-862"></span><span>
</span><span id="line-863"></span><span class="hs-comment">-- Push transitivity inside forall</span><span>
</span><span id="line-864"></span><span class="hs-comment">-- forall over coercions.</span><span>
</span><span id="line-865"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600690"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600690"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600691"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600691"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600692"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600692"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-866"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600693"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600693"><span class="hs-identifier hs-var">cv1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600694"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600694"><span class="hs-identifier hs-var">visL1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600695"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600695"><span class="hs-identifier hs-var">_visR1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600696"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600696"><span class="hs-identifier hs-var">eta1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600697"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600697"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_co_maybe"><span class="hs-identifier hs-var">splitForAllCo_co_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600691"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-867"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600698"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600698"><span class="hs-identifier hs-var">cv2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600699"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600699"><span class="hs-identifier hs-var">_visL2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600700"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600700"><span class="hs-identifier hs-var">visR2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600701"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600701"><span class="hs-identifier hs-var">eta2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600702"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600702"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaForAllCo_co_maybe"><span class="hs-identifier hs-var">etaForAllCo_co_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600692"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-868"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; ForAllTyFlag
-&gt; ForAllTyFlag
-&gt; Maybe Coercion
</span><a href="#local-6989586621682600704"><span class="hs-identifier hs-var">push_trans</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600693"><span class="hs-identifier hs-var">cv1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600696"><span class="hs-identifier hs-var">eta1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600697"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600698"><span class="hs-identifier hs-var">cv2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600701"><span class="hs-identifier hs-var">eta2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600702"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600694"><span class="hs-identifier hs-var">visL1</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600700"><span class="hs-identifier hs-var">visR2</span></a></span><span>
</span><span id="line-869"></span><span>
</span><span id="line-870"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600705"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600705"><span class="hs-identifier hs-var">cv2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600706"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600706"><span class="hs-identifier hs-var">_visL2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600707"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600707"><span class="hs-identifier hs-var">visR2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600708"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600708"><span class="hs-identifier hs-var">eta2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600709"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600709"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_co_maybe"><span class="hs-identifier hs-var">splitForAllCo_co_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600692"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-871"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600710"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600710"><span class="hs-identifier hs-var">cv1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600711"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600711"><span class="hs-identifier hs-var">visL1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600712"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600712"><span class="hs-identifier hs-var">_visR1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600713"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600713"><span class="hs-identifier hs-var">eta1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600714"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600714"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaForAllCo_co_maybe"><span class="hs-identifier hs-var">etaForAllCo_co_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600691"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-872"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; ForAllTyFlag
-&gt; ForAllTyFlag
-&gt; Maybe Coercion
</span><a href="#local-6989586621682600704"><span class="hs-identifier hs-var">push_trans</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600710"><span class="hs-identifier hs-var">cv1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600713"><span class="hs-identifier hs-var">eta1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600714"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600705"><span class="hs-identifier hs-var">cv2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600708"><span class="hs-identifier hs-var">eta2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600709"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600711"><span class="hs-identifier hs-var">visL1</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600707"><span class="hs-identifier hs-var">visR2</span></a></span><span>
</span><span id="line-873"></span><span>
</span><span id="line-874"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-875"></span><span>  </span><span id="local-6989586621682600704"><span class="annot"><span class="annottext">push_trans :: CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; CoVar
-&gt; Coercion
-&gt; Coercion
-&gt; ForAllTyFlag
-&gt; ForAllTyFlag
-&gt; Maybe Coercion
</span><a href="#local-6989586621682600704"><span class="hs-identifier hs-var hs-var">push_trans</span></a></span></span><span> </span><span id="local-6989586621682600715"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600715"><span class="hs-identifier hs-var">cv1</span></a></span></span><span> </span><span id="local-6989586621682600716"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600716"><span class="hs-identifier hs-var">eta1</span></a></span></span><span> </span><span id="local-6989586621682600717"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600717"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621682600718"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600718"><span class="hs-identifier hs-var">cv2</span></a></span></span><span> </span><span id="local-6989586621682600719"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600719"><span class="hs-identifier hs-var">eta2</span></a></span></span><span> </span><span id="local-6989586621682600720"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600720"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span id="local-6989586621682600721"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600721"><span class="hs-identifier hs-var">visL</span></a></span></span><span> </span><span id="local-6989586621682600722"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600722"><span class="hs-identifier hs-var">visR</span></a></span></span><span>
</span><span id="line-876"></span><span>    </span><span class="hs-comment">-- Given:</span><span>
</span><span id="line-877"></span><span>    </span><span class="hs-comment">--   co1 = /\ (cv1 : eta1) &lt;visL, visM&gt;. r1</span><span>
</span><span id="line-878"></span><span>    </span><span class="hs-comment">--   co2 = /\ (cv2 : eta2) &lt;visM, visR&gt;. r2</span><span>
</span><span id="line-879"></span><span>    </span><span class="hs-comment">-- Wanted:</span><span>
</span><span id="line-880"></span><span>    </span><span class="hs-comment">--   n1 = nth 2 eta1</span><span>
</span><span id="line-881"></span><span>    </span><span class="hs-comment">--   n2 = nth 3 eta1</span><span>
</span><span id="line-882"></span><span>    </span><span class="hs-comment">--   nco = /\ cv1 : (eta1;eta2). (r1; r2[cv2 |-&gt; (sym n1);cv1;n2])</span><span>
</span><span id="line-883"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;EtaAllTy_co&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600691"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600692"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-884"></span><span>      </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
CoVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
CoVar
-&gt; ForAllTyFlag -&gt; ForAllTyFlag -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600715"><span class="hs-identifier hs-var">cv1</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600721"><span class="hs-identifier hs-var">visL</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600722"><span class="hs-identifier hs-var">visR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600690"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600716"><span class="hs-identifier hs-var">eta1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600719"><span class="hs-identifier hs-var">eta2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600723"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600717"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600724"><span class="hs-identifier hs-var">r2'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-885"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-886"></span><span>      </span><span id="local-6989586621682600723"><span class="annot"><span class="annottext">is' :: InScopeSet
</span><a href="#local-6989586621682600723"><span class="hs-identifier hs-var hs-var">is'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600690"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; CoVar -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600715"><span class="hs-identifier hs-var">cv1</span></a></span><span>
</span><span id="line-887"></span><span>      </span><span id="local-6989586621682600725"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621682600725"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoVar -&gt; Role
</span><a href="GHC.Core.Coercion.html#coVarRole"><span class="hs-identifier hs-var">coVarRole</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600715"><span class="hs-identifier hs-var">cv1</span></a></span><span>
</span><span id="line-888"></span><span>      </span><span id="local-6989586621682600727"><span class="annot"><span class="annottext">eta1' :: Coercion
</span><a href="#local-6989586621682600727"><span class="hs-identifier hs-var hs-var">eta1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600725"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600716"><span class="hs-identifier hs-var">eta1</span></a></span><span>
</span><span id="line-889"></span><span>      </span><span id="local-6989586621682600729"><span class="annot"><span class="annottext">n1 :: Coercion
</span><a href="#local-6989586621682600729"><span class="hs-identifier hs-var hs-var">n1</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Role -&gt; CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelTyCon"><span class="hs-identifier hs-var">SelTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600725"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600727"><span class="hs-identifier hs-var">eta1'</span></a></span><span>
</span><span id="line-890"></span><span>      </span><span id="local-6989586621682600731"><span class="annot"><span class="annottext">n2 :: Coercion
</span><a href="#local-6989586621682600731"><span class="hs-identifier hs-var hs-var">n2</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Role -&gt; CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelTyCon"><span class="hs-identifier hs-var">SelTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600725"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600727"><span class="hs-identifier hs-var">eta1'</span></a></span><span>
</span><span id="line-891"></span><span>      </span><span id="local-6989586621682600724"><span class="annot"><span class="annottext">r2' :: Coercion
</span><a href="#local-6989586621682600724"><span class="hs-identifier hs-var hs-var">r2'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoVar] -&gt; [Coercion] -&gt; Subst
HasDebugCallStack =&gt; [CoVar] -&gt; [Coercion] -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#zipCvSubst"><span class="hs-identifier hs-var">zipCvSubst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600718"><span class="hs-identifier hs-var">cv2</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600729"><span class="hs-identifier hs-var">n1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_trans_co"><span class="hs-operator hs-var">`mk_trans_co`</span></a></span><span>
</span><span id="line-892"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoVar -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600715"><span class="hs-identifier hs-var">cv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_trans_co"><span class="hs-operator hs-var">`mk_trans_co`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600731"><span class="hs-identifier hs-var">n2</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-893"></span><span>                    </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600720"><span class="hs-identifier hs-var">r2</span></a></span><span>
</span><span id="line-894"></span><span>
</span><span id="line-895"></span><span class="hs-comment">-- Push transitivity inside axioms</span><span>
</span><span id="line-896"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span id="local-6989586621682600734"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600734"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600735"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600736"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span>  </span><span class="hs-comment">-- TrPushAxSym/TrPushSymAx</span><span>
</span><span id="line-899"></span><span>  </span><span class="hs-comment">-- Put this first!  Otherwise (#23619) we get</span><span>
</span><span id="line-900"></span><span>  </span><span class="hs-comment">--    newtype N a = MkN a</span><span>
</span><span id="line-901"></span><span>  </span><span class="hs-comment">--    axN :: forall a. N a ~ a</span><span>
</span><span id="line-902"></span><span>  </span><span class="hs-comment">-- Now consider (axN ty ; sym (axN ty))</span><span>
</span><span id="line-903"></span><span>  </span><span class="hs-comment">-- If we put TrPushSymAxR first, we'll get</span><span>
</span><span id="line-904"></span><span>  </span><span class="hs-comment">--    (axN ty ; sym (axN ty)) :: N ty ~ N ty -- Obviously Refl</span><span>
</span><span id="line-905"></span><span>  </span><span class="hs-comment">--    --&gt; axN (sym (axN ty))  :: N ty ~ N ty -- Very stupid</span><span>
</span><span id="line-906"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600737"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600737"><span class="hs-identifier hs-var">sym1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600738"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600738"><span class="hs-identifier hs-var">axr1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600739"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600739"><span class="hs-identifier hs-var">cos1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (SwapFlag, CoAxiomRule, [Coercion])
</span><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-var">isAxiomCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-907"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600741"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600741"><span class="hs-identifier hs-var">sym2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600742"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600742"><span class="hs-identifier hs-var">axr2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600743"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600743"><span class="hs-identifier hs-var">cos2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (SwapFlag, CoAxiomRule, [Coercion])
</span><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-var">isAxiomCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-908"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600738"><span class="hs-identifier hs-var">axr1</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; CoAxiomRule -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600742"><span class="hs-identifier hs-var">axr2</span></a></span><span>
</span><span id="line-909"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600737"><span class="hs-identifier hs-var">sym1</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; SwapFlag -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; SwapFlag
</span><a href="GHC.Types.Basic.html#flipSwap"><span class="hs-identifier hs-var">flipSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600741"><span class="hs-identifier hs-var">sym2</span></a></span><span>
</span><span id="line-910"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600744"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600744"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600745"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600745"><span class="hs-keyword hs-var">role</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600746"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682600746"><span class="hs-identifier hs-var">branch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; Maybe (TyCon, Role, CoAxBranch)
</span><a href="GHC.Core.Coercion.Axiom.html#coAxiomRuleBranch_maybe"><span class="hs-identifier hs-var">coAxiomRuleBranch_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600738"><span class="hs-identifier hs-var">axr1</span></a></span><span>
</span><span id="line-911"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600748"><span class="annot"><span class="annottext">qtvs :: [CoVar]
</span><a href="#local-6989586621682600748"><span class="hs-identifier hs-var hs-var">qtvs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [CoVar]
</span><a href="GHC.Core.Coercion.Axiom.html#coAxBranchTyVars"><span class="hs-identifier hs-var">coAxBranchTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682600746"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="annot"><span class="annottext">[CoVar] -&gt; [CoVar] -&gt; [CoVar]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [CoVar]
</span><a href="GHC.Core.Coercion.Axiom.html#coAxBranchCoVars"><span class="hs-identifier hs-var">coAxBranchCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682600746"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-912"></span><span>        </span><span id="local-6989586621682600751"><span class="annot"><span class="annottext">lhs :: Type
</span><a href="#local-6989586621682600751"><span class="hs-identifier hs-var hs-var">lhs</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600744"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682600746"><span class="hs-identifier hs-var">branch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span>        </span><span id="local-6989586621682600754"><span class="annot"><span class="annottext">rhs :: Type
</span><a href="#local-6989586621682600754"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#coAxBranchRHS"><span class="hs-identifier hs-var">coAxBranchRHS</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682600746"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-914"></span><span>        </span><span id="local-6989586621682600756"><span class="annot"><span class="annottext">pivot_tvs :: TyCoVarSet
</span><a href="#local-6989586621682600756"><span class="hs-identifier hs-var hs-var">pivot_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TyCoVarSet
</span><a href="GHC.Tc.Utils.TcType.html#exactTyCoVarsOfType"><span class="hs-identifier hs-var">exactTyCoVarsOfType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag -&gt; Type -&gt; Type -&gt; Type
forall a. SwapFlag -&gt; a -&gt; a -&gt; a
</span><a href="GHC.Types.Basic.html#pickSwap"><span class="hs-identifier hs-var">pickSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600741"><span class="hs-identifier hs-var">sym2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600751"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600754"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-915"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(CoVar -&gt; Bool) -&gt; [CoVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoVar -&gt; TyCoVarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoVarSet
</span><a href="#local-6989586621682600756"><span class="hs-identifier hs-var">pivot_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoVar]
</span><a href="#local-6989586621682600748"><span class="hs-identifier hs-var">qtvs</span></a></span><span>
</span><span id="line-916"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TrPushAxSym&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-917"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isSwapped"><span class="hs-identifier hs-var">isSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600741"><span class="hs-identifier hs-var">sym2</span></a></span><span>
</span><span id="line-918"></span><span>       </span><span class="hs-comment">-- TrPushAxSym</span><span>
</span><span id="line-919"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Role -&gt; [CoVar] -&gt; [Coercion] -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#liftCoSubstWith"><span class="hs-identifier hs-var">liftCoSubstWith</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600745"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">[CoVar]
</span><a href="#local-6989586621682600748"><span class="hs-identifier hs-var">qtvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600734"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600739"><span class="hs-identifier hs-var">cos1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; [Coercion] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600743"><span class="hs-identifier hs-var">cos2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600751"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-920"></span><span>       </span><span class="hs-comment">-- TrPushSymAx</span><span>
</span><span id="line-921"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Role -&gt; [CoVar] -&gt; [Coercion] -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#liftCoSubstWith"><span class="hs-identifier hs-var">liftCoSubstWith</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600745"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">[CoVar]
</span><a href="#local-6989586621682600748"><span class="hs-identifier hs-var">qtvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600734"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; [Coercion] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600739"><span class="hs-identifier hs-var">cos1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600743"><span class="hs-identifier hs-var">cos2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600754"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-922"></span><span>
</span><span id="line-923"></span><span>  </span><span class="hs-comment">-- See Note [Push transitivity inside axioms] and</span><span>
</span><span id="line-924"></span><span>  </span><span class="hs-comment">-- Note [Push transitivity inside newtype axioms only]</span><span>
</span><span id="line-925"></span><span>  </span><span class="hs-comment">-- TrPushSymAxR</span><span>
</span><span id="line-926"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600760"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600760"><span class="hs-identifier hs-var">sym</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600761"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600761"><span class="hs-identifier hs-var">axr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600762"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600762"><span class="hs-identifier hs-var">cos1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (SwapFlag, CoAxiomRule, [Coercion])
</span><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-var">isAxiomCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-927"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isSwapped"><span class="hs-identifier hs-var">isSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600760"><span class="hs-identifier hs-var">sym</span></a></span><span>
</span><span id="line-928"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600763"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600763"><span class="hs-identifier hs-var">cos2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; CoAxiomRule -&gt; Coercion -&gt; Maybe [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#matchNewtypeBranch"><span class="hs-identifier hs-var">matchNewtypeBranch</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600760"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600761"><span class="hs-identifier hs-var">axr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-929"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600765"><span class="annot"><span class="annottext">newAxInst :: Coercion
</span><a href="#local-6989586621682600765"><span class="hs-identifier hs-var hs-var">newAxInst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#AxiomCo"><span class="hs-identifier hs-var">AxiomCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600761"><span class="hs-identifier hs-var">axr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600734"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; [Coercion] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600763"><span class="hs-identifier hs-var">cos2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600762"><span class="hs-identifier hs-var">cos1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-930"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TrPushSymAxR&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600765"><span class="hs-identifier hs-var">newAxInst</span></a></span><span>
</span><span id="line-931"></span><span>
</span><span id="line-932"></span><span>  </span><span class="hs-comment">-- TrPushAxR</span><span>
</span><span id="line-933"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600766"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600766"><span class="hs-identifier hs-var">sym</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600767"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600767"><span class="hs-identifier hs-var">axr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600768"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600768"><span class="hs-identifier hs-var">cos1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (SwapFlag, CoAxiomRule, [Coercion])
</span><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-var">isAxiomCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-934"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#notSwapped"><span class="hs-identifier hs-var">notSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600766"><span class="hs-identifier hs-var">sym</span></a></span><span>
</span><span id="line-935"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600769"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600769"><span class="hs-identifier hs-var">cos2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; CoAxiomRule -&gt; Coercion -&gt; Maybe [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#matchNewtypeBranch"><span class="hs-identifier hs-var">matchNewtypeBranch</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600766"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600767"><span class="hs-identifier hs-var">axr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-936"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600770"><span class="annot"><span class="annottext">newAxInst :: Coercion
</span><a href="#local-6989586621682600770"><span class="hs-identifier hs-var hs-var">newAxInst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#AxiomCo"><span class="hs-identifier hs-var">AxiomCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600767"><span class="hs-identifier hs-var">axr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600734"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600768"><span class="hs-identifier hs-var">cos1</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600769"><span class="hs-identifier hs-var">cos2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TrPushAxR&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600770"><span class="hs-identifier hs-var">newAxInst</span></a></span><span>
</span><span id="line-938"></span><span>
</span><span id="line-939"></span><span>  </span><span class="hs-comment">-- TrPushSymAxL</span><span>
</span><span id="line-940"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600771"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600771"><span class="hs-identifier hs-var">sym</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600772"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600772"><span class="hs-identifier hs-var">axr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600773"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600773"><span class="hs-identifier hs-var">cos2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (SwapFlag, CoAxiomRule, [Coercion])
</span><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-var">isAxiomCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-941"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isSwapped"><span class="hs-identifier hs-var">isSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600771"><span class="hs-identifier hs-var">sym</span></a></span><span>
</span><span id="line-942"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600774"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600774"><span class="hs-identifier hs-var">cos1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; CoAxiomRule -&gt; Coercion -&gt; Maybe [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#matchNewtypeBranch"><span class="hs-identifier hs-var">matchNewtypeBranch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag -&gt; SwapFlag
</span><a href="GHC.Types.Basic.html#flipSwap"><span class="hs-identifier hs-var">flipSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600771"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600772"><span class="hs-identifier hs-var">axr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-943"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600775"><span class="annot"><span class="annottext">newAxInst :: Coercion
</span><a href="#local-6989586621682600775"><span class="hs-identifier hs-var hs-var">newAxInst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#AxiomCo"><span class="hs-identifier hs-var">AxiomCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600772"><span class="hs-identifier hs-var">axr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600734"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600773"><span class="hs-identifier hs-var">cos2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; [Coercion] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600774"><span class="hs-identifier hs-var">cos1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TrPushSymAxL&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600775"><span class="hs-identifier hs-var">newAxInst</span></a></span><span>
</span><span id="line-945"></span><span>
</span><span id="line-946"></span><span>  </span><span class="hs-comment">-- TrPushAxL</span><span>
</span><span id="line-947"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600776"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600776"><span class="hs-identifier hs-var">sym</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600777"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600777"><span class="hs-identifier hs-var">axr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600778"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600778"><span class="hs-identifier hs-var">cos2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (SwapFlag, CoAxiomRule, [Coercion])
</span><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-var">isAxiomCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-948"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#notSwapped"><span class="hs-identifier hs-var">notSwapped</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600776"><span class="hs-identifier hs-var">sym</span></a></span><span>
</span><span id="line-949"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600779"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600779"><span class="hs-identifier hs-var">cos1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; CoAxiomRule -&gt; Coercion -&gt; Maybe [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#matchNewtypeBranch"><span class="hs-identifier hs-var">matchNewtypeBranch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag -&gt; SwapFlag
</span><a href="GHC.Types.Basic.html#flipSwap"><span class="hs-identifier hs-var">flipSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600776"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600777"><span class="hs-identifier hs-var">axr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-950"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600780"><span class="annot"><span class="annottext">newAxInst :: Coercion
</span><a href="#local-6989586621682600780"><span class="hs-identifier hs-var hs-var">newAxInst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#AxiomCo"><span class="hs-identifier hs-var">AxiomCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600777"><span class="hs-identifier hs-var">axr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
InScopeSet -&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600734"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600779"><span class="hs-identifier hs-var">cos1</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600778"><span class="hs-identifier hs-var">cos2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-951"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TrPushAxL&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600735"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600736"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600780"><span class="hs-identifier hs-var">newAxInst</span></a></span><span>
</span><span id="line-952"></span><span>
</span><span id="line-953"></span><span>
</span><span id="line-954"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682600781"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600781"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600782"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600782"><span class="hs-identifier hs-var">co2</span></a></span></span><span>        </span><span class="hs-comment">-- Identity rule</span><span>
</span><span id="line-955"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600783"><span class="annot"><span class="annottext">ty1 :: Type
</span><a href="#local-6989586621682600783"><span class="hs-identifier hs-var hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600781"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-956"></span><span>        </span><span id="local-6989586621682600784"><span class="annot"><span class="annottext">r :: Role
</span><a href="#local-6989586621682600784"><span class="hs-identifier hs-var hs-var">r</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Role
</span><a href="GHC.Core.Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600781"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-957"></span><span>        </span><span id="local-6989586621682600785"><span class="annot"><span class="annottext">ty2 :: Type
</span><a href="#local-6989586621682600785"><span class="hs-identifier hs-var hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600782"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-958"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600783"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600785"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-959"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RedTypeDirRefl&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600781"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600782"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-960"></span><span>    </span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600784"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600785"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-961"></span><span>
</span><span id="line-962"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Coercion
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-963"></span><span>
</span><span id="line-964"></span><span class="hs-comment">-- See Note [EtaAppCo]</span><span>
</span><span id="line-965"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule_app"><span class="hs-identifier hs-type">opt_trans_rule_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span>
</span><span id="line-966"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>   </span><span class="hs-comment">-- original left-hand coercion (printing only)</span><span>
</span><span id="line-967"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>   </span><span class="hs-comment">-- original right-hand coercion (printing only)</span><span>
</span><span id="line-968"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>   </span><span class="hs-comment">-- left-hand coercion &quot;function&quot;</span><span>
</span><span id="line-969"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- left-hand coercion &quot;args&quot;</span><span>
</span><span id="line-970"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>   </span><span class="hs-comment">-- right-hand coercion &quot;function&quot;</span><span>
</span><span id="line-971"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- right-hand coercion &quot;args&quot;</span><span>
</span><span id="line-972"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-973"></span><span id="opt_trans_rule_app"><span class="annot"><span class="annottext">opt_trans_rule_app :: InScopeSet
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
-&gt; [Coercion]
-&gt; Coercion
-&gt; [Coercion]
-&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule_app"><span class="hs-identifier hs-var hs-var">opt_trans_rule_app</span></a></span></span><span> </span><span id="local-6989586621682600786"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600786"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682600787"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600787"><span class="hs-identifier hs-var">orig_co1</span></a></span></span><span> </span><span id="local-6989586621682600788"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600788"><span class="hs-identifier hs-var">orig_co2</span></a></span></span><span> </span><span id="local-6989586621682600789"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600789"><span class="hs-identifier hs-var">co1a</span></a></span></span><span> </span><span id="local-6989586621682600790"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600790"><span class="hs-identifier hs-var">co1bs</span></a></span></span><span> </span><span id="local-6989586621682600791"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600791"><span class="hs-identifier hs-var">co2a</span></a></span></span><span> </span><span id="local-6989586621682600792"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600792"><span class="hs-identifier hs-var">co2bs</span></a></span></span><span>
</span><span id="line-974"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppCo"><span class="hs-identifier hs-type">AppCo</span></a></span><span> </span><span id="local-6989586621682600793"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600793"><span class="hs-identifier hs-var">co1aa</span></a></span></span><span> </span><span id="local-6989586621682600794"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600794"><span class="hs-identifier hs-var">co1ab</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600789"><span class="hs-identifier hs-var">co1a</span></a></span><span>
</span><span id="line-975"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600795"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600795"><span class="hs-identifier hs-var">co2aa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600796"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600796"><span class="hs-identifier hs-var">co2ab</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaAppCo_maybe"><span class="hs-identifier hs-var">etaAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600791"><span class="hs-identifier hs-var">co2a</span></a></span><span>
</span><span id="line-976"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
-&gt; [Coercion]
-&gt; Coercion
-&gt; [Coercion]
-&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule_app"><span class="hs-identifier hs-var">opt_trans_rule_app</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600786"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600787"><span class="hs-identifier hs-var">orig_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600788"><span class="hs-identifier hs-var">orig_co2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600793"><span class="hs-identifier hs-var">co1aa</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600794"><span class="hs-identifier hs-var">co1ab</span></a></span><span class="annot"><span class="annottext">Coercion -&gt; [Coercion] -&gt; [Coercion]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600790"><span class="hs-identifier hs-var">co1bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600795"><span class="hs-identifier hs-var">co2aa</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600796"><span class="hs-identifier hs-var">co2ab</span></a></span><span class="annot"><span class="annottext">Coercion -&gt; [Coercion] -&gt; [Coercion]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600792"><span class="hs-identifier hs-var">co2bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-977"></span><span>
</span><span id="line-978"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppCo"><span class="hs-identifier hs-type">AppCo</span></a></span><span> </span><span id="local-6989586621682600797"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600797"><span class="hs-identifier hs-var">co2aa</span></a></span></span><span> </span><span id="local-6989586621682600798"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600798"><span class="hs-identifier hs-var">co2ab</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600791"><span class="hs-identifier hs-var">co2a</span></a></span><span>
</span><span id="line-979"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600799"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600799"><span class="hs-identifier hs-var">co1aa</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600800"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600800"><span class="hs-identifier hs-var">co1ab</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaAppCo_maybe"><span class="hs-identifier hs-var">etaAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600789"><span class="hs-identifier hs-var">co1a</span></a></span><span>
</span><span id="line-980"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
-&gt; Coercion
-&gt; Coercion
-&gt; Coercion
-&gt; [Coercion]
-&gt; Coercion
-&gt; [Coercion]
-&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans_rule_app"><span class="hs-identifier hs-var">opt_trans_rule_app</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600786"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600787"><span class="hs-identifier hs-var">orig_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600788"><span class="hs-identifier hs-var">orig_co2</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600799"><span class="hs-identifier hs-var">co1aa</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600800"><span class="hs-identifier hs-var">co1ab</span></a></span><span class="annot"><span class="annottext">Coercion -&gt; [Coercion] -&gt; [Coercion]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600790"><span class="hs-identifier hs-var">co1bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600797"><span class="hs-identifier hs-var">co2aa</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600798"><span class="hs-identifier hs-var">co2ab</span></a></span><span class="annot"><span class="annottext">Coercion -&gt; [Coercion] -&gt; [Coercion]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600792"><span class="hs-identifier hs-var">co2bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-981"></span><span>
</span><span id="line-982"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-983"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Coercion -&gt; Maybe Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600790"><span class="hs-identifier hs-var">co1bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion] -&gt; [Coercion] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-operator hs-var">`equalLength`</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600792"><span class="hs-identifier hs-var">co2bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Coercion -&gt; Maybe Coercion)
-&gt; Maybe Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-984"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;EtaApps:&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Coercion] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600790"><span class="hs-identifier hs-var">co1bs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600787"><span class="hs-identifier hs-var">orig_co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600788"><span class="hs-identifier hs-var">orig_co2</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Maybe Coercion) -&gt; Coercion -&gt; Maybe Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-985"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600804"><span class="annot"><span class="annottext">rt1a :: Type
</span><a href="#local-6989586621682600804"><span class="hs-identifier hs-var hs-var">rt1a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600789"><span class="hs-identifier hs-var">co1a</span></a></span><span>
</span><span id="line-986"></span><span>
</span><span id="line-987"></span><span>        </span><span id="local-6989586621682600805"><span class="annot"><span class="annottext">lt2a :: Type
</span><a href="#local-6989586621682600805"><span class="hs-identifier hs-var hs-var">lt2a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600791"><span class="hs-identifier hs-var">co2a</span></a></span><span>
</span><span id="line-988"></span><span>        </span><span id="local-6989586621682600806"><span class="annot"><span class="annottext">rt2a :: Role
</span><a href="#local-6989586621682600806"><span class="hs-identifier hs-var hs-var">rt2a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Role
</span><a href="GHC.Core.Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a></span><span>  </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600791"><span class="hs-identifier hs-var">co2a</span></a></span><span>
</span><span id="line-989"></span><span>
</span><span id="line-990"></span><span>        </span><span id="local-6989586621682600807"><span class="annot"><span class="annottext">rt1bs :: [Type]
</span><a href="#local-6989586621682600807"><span class="hs-identifier hs-var hs-var">rt1bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Type) -&gt; [Coercion] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600790"><span class="hs-identifier hs-var">co1bs</span></a></span><span>
</span><span id="line-991"></span><span>        </span><span id="local-6989586621682600808"><span class="annot"><span class="annottext">lt2bs :: [Type]
</span><a href="#local-6989586621682600808"><span class="hs-identifier hs-var hs-var">lt2bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Type) -&gt; [Coercion] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600792"><span class="hs-identifier hs-var">co2bs</span></a></span><span>
</span><span id="line-992"></span><span>        </span><span id="local-6989586621682600809"><span class="annot"><span class="annottext">rt2bs :: [Role]
</span><a href="#local-6989586621682600809"><span class="hs-identifier hs-var hs-var">rt2bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Role) -&gt; [Coercion] -&gt; [Role]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Role
</span><a href="GHC.Core.Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600792"><span class="hs-identifier hs-var">co2bs</span></a></span><span>
</span><span id="line-993"></span><span>
</span><span id="line-994"></span><span>        </span><span id="local-6989586621682600810"><span class="annot"><span class="annottext">kcoa :: Coercion
</span><a href="#local-6989586621682600810"><span class="hs-identifier hs-var hs-var">kcoa</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type -&gt; Coercion
Type -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#buildCoercion"><span class="hs-identifier hs-var">buildCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600805"><span class="hs-identifier hs-var">lt2a</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600804"><span class="hs-identifier hs-var">rt1a</span></a></span><span>
</span><span id="line-995"></span><span>        </span><span id="local-6989586621682600812"><span class="annot"><span class="annottext">kcobs :: [Coercion]
</span><a href="#local-6989586621682600812"><span class="hs-identifier hs-var hs-var">kcobs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; [Coercion] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a></span><span> </span><span class="annot"><span class="annottext">([Coercion] -&gt; [Coercion]) -&gt; [Coercion] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type -&gt; Coercion) -&gt; [Type] -&gt; [Type] -&gt; [Coercion]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type -&gt; Coercion
Type -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#buildCoercion"><span class="hs-identifier hs-var">buildCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682600808"><span class="hs-identifier hs-var">lt2bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682600807"><span class="hs-identifier hs-var">rt1bs</span></a></span><span>
</span><span id="line-996"></span><span>
</span><span id="line-997"></span><span>        </span><span id="local-6989586621682600813"><span class="annot"><span class="annottext">co2a' :: Coercion
</span><a href="#local-6989586621682600813"><span class="hs-identifier hs-var hs-var">co2a'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-var">mkCoherenceLeftCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600806"><span class="hs-identifier hs-var">rt2a</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600805"><span class="hs-identifier hs-var">lt2a</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600810"><span class="hs-identifier hs-var">kcoa</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600791"><span class="hs-identifier hs-var">co2a</span></a></span><span>
</span><span id="line-998"></span><span>        </span><span id="local-6989586621682600815"><span class="annot"><span class="annottext">co2bs' :: [Coercion]
</span><a href="#local-6989586621682600815"><span class="hs-identifier hs-var hs-var">co2bs'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Role -&gt; Type -&gt; Coercion -&gt; Coercion)
-&gt; [Role] -&gt; [Type] -&gt; [Coercion] -&gt; [Coercion]
forall a b c d. (a -&gt; b -&gt; c -&gt; d) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d]
</span><span class="hs-identifier hs-var">zipWith3</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkGReflLeftCo"><span class="hs-identifier hs-var">mkGReflLeftCo</span></a></span><span> </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621682600809"><span class="hs-identifier hs-var">rt2bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682600808"><span class="hs-identifier hs-var">lt2bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600812"><span class="hs-identifier hs-var">kcobs</span></a></span><span>
</span><span id="line-999"></span><span>        </span><span id="local-6989586621682600817"><span class="annot"><span class="annottext">co2bs'' :: [Coercion]
</span><a href="#local-6989586621682600817"><span class="hs-identifier hs-var hs-var">co2bs''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion -&gt; Coercion)
-&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_trans_co"><span class="hs-identifier hs-var">mk_trans_co</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600815"><span class="hs-identifier hs-var">co2bs'</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600792"><span class="hs-identifier hs-var">co2bs</span></a></span><span>
</span><span id="line-1000"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-1001"></span><span>    </span><span class="annot"><span class="annottext">Coercion -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkAppCos"><span class="hs-identifier hs-var">mkAppCos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600786"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600789"><span class="hs-identifier hs-var">co1a</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600813"><span class="hs-identifier hs-var">co2a'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion -&gt; Coercion)
-&gt; [Coercion] -&gt; [Coercion] -&gt; [Coercion]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
InScopeSet -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682600786"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600790"><span class="hs-identifier hs-var">co1bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600817"><span class="hs-identifier hs-var">co2bs''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1003"></span><span>
</span><span id="line-1004"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-type">fireTransRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1005"></span><span id="fireTransRule"><span class="annot"><span class="annottext">fireTransRule :: String -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.Opt.html#fireTransRule"><span class="hs-identifier hs-var hs-var">fireTransRule</span></a></span></span><span> </span><span id="local-6989586621682600819"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682600819"><span class="hs-identifier hs-var">_rule</span></a></span></span><span> </span><span id="local-6989586621682600820"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600820"><span class="hs-identifier hs-var">_co1</span></a></span></span><span> </span><span id="local-6989586621682600821"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600821"><span class="hs-identifier hs-var">_co2</span></a></span></span><span> </span><span id="local-6989586621682600822"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600822"><span class="hs-identifier hs-var">res</span></a></span></span><span>
</span><span id="line-1006"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe Coercion
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600822"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-1007"></span><span>
</span><span id="line-1008"></span><span class="hs-comment">{-
Note [Push transitivity inside axioms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
opt_trans_rule tries to push transitivity inside axioms to deal with cases like
the following:

    newtype N a = MkN a

    axN :: N a ~R# a

    covar :: a ~R# b
    co1 = axN &lt;a&gt; :: N a ~R# a
    co2 = axN &lt;b&gt; :: N b ~R# b

    co :: a ~R# b
    co = sym co1 ; N covar ; co2

When we are optimising co, we want to notice that the two axiom instantiations
cancel out. This is implemented by rules such as TrPushSymAxR, which transforms
    sym (axN &lt;a&gt;) ; N covar
into
    sym (axN covar)
so that TrPushSymAx can subsequently transform
    sym (axN covar) ; axN &lt;b&gt;
into
    covar
which is much more compact. In some perf test cases this kind of pattern can be
generated repeatedly during simplification, so it is very important we squash it
to stop coercions growing exponentially.  For more details see the paper:

    Evidence normalisation in System FC
    Dimitrios Vytiniotis and Simon Peyton Jones
    RTA'13, 2013
    https://www.microsoft.com/en-us/research/publication/evidence-normalization-system-fc-2/


Note [Push transitivity inside newtype axioms only]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The optimization described in Note [Push transitivity inside axioms] is possible
for both newtype and type family axioms.  However, for type family axioms it is
relatively common to have transitive sequences of axioms instantiations, for
example:

    data Nat = Zero | Suc Nat

    type family Index (n :: Nat) (xs :: [Type]) :: Type where
      Index Zero    (x : xs) = x
      Index (Suc n) (x : xs) = Index n xs

    axIndex :: { forall x::Type. forall xs::[Type]. Index Zero (x : xs) ~ x
               ; forall n::Nat. forall x::Type. forall xs::[Type]. Index (Suc n) (x : xs) ~ Index n xs }

    co :: Index (Suc (Suc Zero)) [a, b, c] ~ c
    co = axIndex[1] &lt;Suc Zero&gt; &lt;a&gt; &lt;[b, c]&gt;
       ; axIndex[1] &lt;Zero&gt; &lt;b&gt; &lt;[c]&gt;
       ; axIndex[0] &lt;c&gt; &lt;[]&gt;

Not only are there no cancellation opportunities here, but calling matchAxiom
repeatedly down the transitive chain is very expensive.  Hence we do not attempt
to push transitivity inside type family axioms.  See #8095, !9210 and related tickets.

This is implemented by opt_trans_rule checking that the axiom is for a newtype
constructor (i.e. not a type family).  Adding these guards substantially
improved performance (reduced bytes allocated by more than 10%) for the tests
CoOpt_Singletons, LargeRecord, T12227, T12545, T13386, T15703, T5030, T8095.

A side benefit is that we do not risk accidentally creating an ill-typed
coercion; see Note [Why call checkAxInstCo during optimisation].

There may exist programs that previously relied on pushing transitivity inside
type family axioms to avoid creating huge coercions, which will regress in
compile time performance as a result of this change.  We do not currently know
of any examples, but if any come to light we may need to reconsider this
behaviour.


Note [Why call checkAxInstCo during optimisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NB: The following is no longer relevant, because we no longer push transitivity
into type family axioms (Note [Push transitivity inside newtype axioms only]).
It is retained for reference in case we change this behaviour in the future.

It is possible that otherwise-good-looking optimisations meet with disaster
in the presence of axioms with multiple equations. Consider

type family Equal (a :: *) (b :: *) :: Bool where
  Equal a a = True
  Equal a b = False
type family Id (a :: *) :: * where
  Id a = a

axEq :: { [a::*].       Equal a a ~ True
        ; [a::*, b::*]. Equal a b ~ False }
axId :: [a::*]. Id a ~ a

co1 = Equal (axId[0] Int) (axId[0] Bool)
  :: Equal (Id Int) (Id Bool) ~  Equal Int Bool
co2 = axEq[1] &lt;Int&gt; &lt;Bool&gt;
  :: Equal Int Bool ~ False

We wish to optimise (co1 ; co2). We end up in rule TrPushAxL, noting that
co2 is an axiom and that matchAxiom succeeds when looking at co1. But, what
happens when we push the coercions inside? We get

co3 = axEq[1] (axId[0] Int) (axId[0] Bool)
  :: Equal (Id Int) (Id Bool) ~ False

which is bogus! This is because the type system isn't smart enough to know
that (Id Int) and (Id Bool) are Surely Apart, as they're headed by type
families. At the time of writing, I (Richard Eisenberg) couldn't think of
a way of detecting this any more efficient than just building the optimised
coercion and checking.

Note [EtaAppCo]
~~~~~~~~~~~~~~~
Suppose we're trying to optimize (co1a co1b ; co2a co2b). Ideally, we'd
like to rewrite this to (co1a ; co2a) (co1b ; co2b). The problem is that
the resultant coercions might not be well kinded. Here is an example (things
labeled with x don't matter in this example):

  k1 :: Type
  k2 :: Type

  a :: k1 -&gt; Type
  b :: k1

  h :: k1 ~ k2

  co1a :: x1 ~ (a |&gt; (h -&gt; &lt;Type&gt;)
  co1b :: x2 ~ (b |&gt; h)

  co2a :: a ~ x3
  co2b :: b ~ x4

First, convince yourself of the following:

  co1a co1b :: x1 x2 ~ (a |&gt; (h -&gt; &lt;Type&gt;)) (b |&gt; h)
  co2a co2b :: a b   ~ x3 x4

  (a |&gt; (h -&gt; &lt;Type&gt;)) (b |&gt; h) `eqType` a b

That last fact is due to Note [Non-trivial definitional equality] in GHC.Core.TyCo.Rep,
where we ignore coercions in types as long as two types' kinds are the same.
In our case, we meet this last condition, because

  (a |&gt; (h -&gt; &lt;Type&gt;)) (b |&gt; h) :: Type
    and
  a b :: Type

So the input coercion (co1a co1b ; co2a co2b) is well-formed. But the
suggested output coercions (co1a ; co2a) and (co1b ; co2b) are not -- the
kinds don't match up.

The solution here is to twiddle the kinds in the output coercions. First, we
need to find coercions

  ak :: kind(a |&gt; (h -&gt; &lt;Type&gt;)) ~ kind(a)
  bk :: kind(b |&gt; h)             ~ kind(b)

This can be done with mkKindCo and buildCoercion. The latter assumes two
types are identical modulo casts and builds a coercion between them.

Then, we build (co1a ; co2a |&gt; sym ak) and (co1b ; co2b |&gt; sym bk) as the
output coercions. These are well-kinded.

Also, note that all of this is done after accumulated any nested AppCo
parameters. This step is to avoid quadratic behavior in calling coercionKind.

The problem described here was first found in dependent/should_compile/dynamic-paper.

-}</span><span>
</span><span id="line-1179"></span><span>
</span><span id="line-1180"></span><span class="hs-comment">-----------</span><span>
</span><span id="line-1181"></span><span id="local-6989586621682599818"><span class="annot"><a href="GHC.Core.Coercion.Opt.html#swapSym"><span class="hs-identifier hs-type">swapSym</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682599818"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682599818"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682599818"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682599818"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1182"></span><span id="swapSym"><span class="annot"><span class="annottext">swapSym :: forall a. SwapFlag -&gt; (a, a) -&gt; (a, a)
</span><a href="GHC.Core.Coercion.Opt.html#swapSym"><span class="hs-identifier hs-var hs-var">swapSym</span></a></span></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682600824"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600824"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682600825"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600825"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600825"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600824"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1183"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#swapSym"><span class="hs-identifier hs-var">swapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600826"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600826"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682600827"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600827"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600826"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682600827"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1184"></span><span>
</span><span id="line-1185"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#wrapSym"><span class="hs-identifier hs-type">wrapSym</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1186"></span><span id="wrapSym"><span class="annot"><span class="annottext">wrapSym :: SwapFlag -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapSym"><span class="hs-identifier hs-var hs-var">wrapSym</span></a></span></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span>  </span><span id="local-6989586621682600828"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600828"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600828"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1187"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span id="local-6989586621682600829"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600829"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600829"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1188"></span><span>
</span><span id="line-1189"></span><span class="annot"><span class="hs-comment">-- | Conditionally set a role to be representational</span></span><span>
</span><span id="line-1190"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#wrapRole"><span class="hs-identifier hs-type">wrapRole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#ReprFlag"><span class="hs-identifier hs-type">ReprFlag</span></a></span><span>
</span><span id="line-1191"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>         </span><span class="annot"><span class="hs-comment">-- ^ current role</span></span><span>
</span><span id="line-1192"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1193"></span><span id="wrapRole"><span class="annot"><span class="annottext">wrapRole :: Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#wrapRole"><span class="hs-identifier hs-var hs-var">wrapRole</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-1194"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span id="local-6989586621682600831"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600831"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600831"><span class="hs-identifier hs-var">current</span></a></span><span>
</span><span id="line-1195"></span><span>
</span><span id="line-1196"></span><span class="hs-comment">-- | If we require a representational role, return that. Otherwise,</span><span>
</span><span id="line-1197"></span><span class="hs-comment">-- return the &quot;default&quot; role provided.</span><span>
</span><span id="line-1198"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#chooseRole"><span class="hs-identifier hs-type">chooseRole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#ReprFlag"><span class="hs-identifier hs-type">ReprFlag</span></a></span><span>
</span><span id="line-1199"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ &quot;default&quot; role</span></span><span>
</span><span id="line-1200"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>
</span><span id="line-1201"></span><span id="chooseRole"><span class="annot"><span class="annottext">chooseRole :: Bool -&gt; Role -&gt; Role
</span><a href="GHC.Core.Coercion.Opt.html#chooseRole"><span class="hs-identifier hs-var hs-var">chooseRole</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span>
</span><span id="line-1202"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span>    </span><span id="local-6989586621682600832"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600832"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600832"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1203"></span><span>
</span><span id="line-1204"></span><span class="hs-comment">-----------</span><span>
</span><span id="line-1205"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-type">isAxiomCo_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiomRule"><span class="hs-identifier hs-type">CoAxiomRule</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1206"></span><span class="hs-comment">-- We don't expect to see nested SymCo; and that lets us write a simple,</span><span>
</span><span id="line-1207"></span><span class="hs-comment">-- non-recursive function. (If we see a nested SymCo we'll just fail,</span><span>
</span><span id="line-1208"></span><span class="hs-comment">-- which is ok.)</span><span>
</span><span id="line-1209"></span><span id="isAxiomCo_maybe"><span class="annot"><span class="annottext">isAxiomCo_maybe :: Coercion -&gt; Maybe (SwapFlag, CoAxiomRule, [Coercion])
</span><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-var hs-var">isAxiomCo_maybe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SymCo"><span class="hs-identifier hs-type">SymCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AxiomCo"><span class="hs-identifier hs-type">AxiomCo</span></a></span><span> </span><span id="local-6989586621682600833"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600833"><span class="hs-identifier hs-var">ax</span></a></span></span><span> </span><span id="local-6989586621682600834"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600834"><span class="hs-identifier hs-var">cos</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SwapFlag, CoAxiomRule, [Coercion])
-&gt; Maybe (SwapFlag, CoAxiomRule, [Coercion])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600833"><span class="hs-identifier hs-var">ax</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600834"><span class="hs-identifier hs-var">cos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1210"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-var">isAxiomCo_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AxiomCo"><span class="hs-identifier hs-type">AxiomCo</span></a></span><span> </span><span id="local-6989586621682600835"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600835"><span class="hs-identifier hs-var">ax</span></a></span></span><span> </span><span id="local-6989586621682600836"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600836"><span class="hs-identifier hs-var">cos</span></a></span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SwapFlag, CoAxiomRule, [Coercion])
-&gt; Maybe (SwapFlag, CoAxiomRule, [Coercion])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600835"><span class="hs-identifier hs-var">ax</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600836"><span class="hs-identifier hs-var">cos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1211"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#isAxiomCo_maybe"><span class="hs-identifier hs-var">isAxiomCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (SwapFlag, CoAxiomRule, [Coercion])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1212"></span><span>
</span><span id="line-1213"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#matchNewtypeBranch"><span class="hs-identifier hs-type">matchNewtypeBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-comment">-- IsSwapped = match LHS, NotSwapped = match RHS</span><span>
</span><span id="line-1214"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiomRule"><span class="hs-identifier hs-type">CoAxiomRule</span></a></span><span>
</span><span id="line-1215"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1216"></span><span id="matchNewtypeBranch"><span class="annot"><span class="annottext">matchNewtypeBranch :: SwapFlag -&gt; CoAxiomRule -&gt; Coercion -&gt; Maybe [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#matchNewtypeBranch"><span class="hs-identifier hs-var hs-var">matchNewtypeBranch</span></a></span></span><span> </span><span id="local-6989586621682600837"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600837"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span id="local-6989586621682600838"><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600838"><span class="hs-identifier hs-var">axr</span></a></span></span><span> </span><span id="local-6989586621682600839"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600839"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1217"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600840"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600840"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682600841"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682600841"><span class="hs-identifier hs-var">branch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoAxiomRule -&gt; Maybe (TyCon, CoAxBranch)
</span><a href="GHC.Core.Coercion.Axiom.html#isNewtypeAxiomRule_maybe"><span class="hs-identifier hs-var">isNewtypeAxiomRule_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiomRule
</span><a href="#local-6989586621682600838"><span class="hs-identifier hs-var">axr</span></a></span><span>
</span><span id="line-1218"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_tvs :: CoAxBranch -&gt; [CoVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600845"><span class="annot"><span class="annottext">[CoVar]
</span><a href="#local-6989586621682600845"><span class="hs-identifier hs-var">qtvs</span></a></span></span><span>
</span><span id="line-1219"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_cvs :: CoAxBranch -&gt; [CoVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_cvs"><span class="hs-identifier hs-var">cab_cvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- can't infer these, so fail if there are any</span><span>
</span><span id="line-1220"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_roles :: CoAxBranch -&gt; [Role]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_roles"><span class="hs-identifier hs-var">cab_roles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600848"><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621682600848"><span class="hs-identifier hs-var">roles</span></a></span></span><span>
</span><span id="line-1221"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600850"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682600850"><span class="hs-identifier hs-var">lhs</span></a></span></span><span>
</span><span id="line-1222"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682600852"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600852"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621682600841"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-1223"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682600853"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600853"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCoVarSet -&gt; Type -&gt; Coercion -&gt; Maybe LiftingContext
</span><a href="GHC.Core.Unify.html#liftCoMatch"><span class="hs-identifier hs-var">liftCoMatch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoVar] -&gt; TyCoVarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[CoVar]
</span><a href="#local-6989586621682600845"><span class="hs-identifier hs-var">qtvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1224"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag -&gt; Type -&gt; Type -&gt; Type
forall a. SwapFlag -&gt; a -&gt; a -&gt; a
</span><a href="GHC.Types.Basic.html#pickSwap"><span class="hs-identifier hs-var">pickSwap</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600837"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600852"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600840"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682600850"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1225"></span><span>                              </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600839"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1226"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(CoVar -&gt; Bool) -&gt; [CoVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoVar -&gt; LiftingContext -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isMappedByLC"><span class="hs-operator hs-var">`isMappedByLC`</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600853"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoVar]
</span><a href="#local-6989586621682600845"><span class="hs-identifier hs-var">qtvs</span></a></span><span>
</span><span id="line-1227"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Role -&gt; CoVar -&gt; Maybe Coercion)
-&gt; [Role] -&gt; [CoVar] -&gt; Maybe [Coercion]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; Role -&gt; CoVar -&gt; Maybe Coercion
</span><a href="GHC.Core.Coercion.html#liftCoSubstTyVar"><span class="hs-identifier hs-var">liftCoSubstTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600853"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Role]
</span><a href="#local-6989586621682600848"><span class="hs-identifier hs-var">roles</span></a></span><span> </span><span class="annot"><span class="annottext">[CoVar]
</span><a href="#local-6989586621682600845"><span class="hs-identifier hs-var">qtvs</span></a></span><span>
</span><span id="line-1228"></span><span>
</span><span id="line-1229"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1230"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [Coercion]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1231"></span><span>
</span><span id="line-1232"></span><span class="hs-comment">-------------</span><span>
</span><span id="line-1233"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#compatible_co"><span class="hs-identifier hs-type">compatible_co</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1234"></span><span class="hs-comment">-- Check whether (co1 . co2) will be well-kinded</span><span>
</span><span id="line-1235"></span><span id="compatible_co"><span class="annot"><span class="annottext">compatible_co :: Coercion -&gt; Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.Opt.html#compatible_co"><span class="hs-identifier hs-var hs-var">compatible_co</span></a></span></span><span> </span><span id="local-6989586621682600858"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600858"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600859"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600859"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-1236"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600860"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600861"><span class="hs-identifier hs-var">x2</span></a></span><span>
</span><span id="line-1237"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1238"></span><span>    </span><span id="local-6989586621682600860"><span class="annot"><span class="annottext">x1 :: Type
</span><a href="#local-6989586621682600860"><span class="hs-identifier hs-var hs-var">x1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600858"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-1239"></span><span>    </span><span id="local-6989586621682600861"><span class="annot"><span class="annottext">x2 :: Type
</span><a href="#local-6989586621682600861"><span class="hs-identifier hs-var hs-var">x2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600859"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1240"></span><span>
</span><span id="line-1241"></span><span class="hs-comment">-------------</span><span>
</span><span id="line-1242"></span><span class="hs-comment">{-
etaForAllCo
~~~~~~~~~~~~~~~~~
(1) etaForAllCo_ty_maybe
Suppose we have

  g : all a1:k1.t1  ~  all a2:k2.t2

but g is *not* a ForAllCo. We want to eta-expand it. So, we do this:

  g' = all a1:(ForAllKindCo g).(InstCo g (a1 ~ a1 |&gt; ForAllKindCo g))

Call the kind coercion h1 and the body coercion h2. We can see that

  h2 : t1 ~ t2[a2 |-&gt; (a1 |&gt; h1)]

According to the typing rule for ForAllCo, we get that

  g' : all a1:k1.t1  ~  all a1:k2.(t2[a2 |-&gt; (a1 |&gt; h1)][a1 |-&gt; a1 |&gt; sym h1])

or

  g' : all a1:k1.t1  ~  all a1:k2.(t2[a2 |-&gt; a1])

as desired.

(2) etaForAllCo_co_maybe
Suppose we have

  g : all c1:(s1~s2). t1 ~ all c2:(s3~s4). t2

Similarly, we do this

  g' = all c1:h1. h2
     : all c1:(s1~s2). t1 ~ all c1:(s3~s4). t2[c2 |-&gt; (sym eta1;c1;eta2)]
                                              [c1 |-&gt; eta1;c1;sym eta2]

Here,

  h1   = mkSelCo Nominal 0 g       :: (s1~s2)~(s3~s4)
  eta1 = mkSelCo (SelTyCon 2 r) h1 :: (s1 ~ s3)
  eta2 = mkSelCo (SelTyCon 3 r) h1 :: (s2 ~ s4)
  h2   = mkInstCo g (cv1 ~ (sym eta1;c1;eta2))
-}</span><span>
</span><span id="line-1286"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#etaForAllCo_ty_maybe"><span class="hs-identifier hs-type">etaForAllCo_ty_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">ForAllTyFlag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">ForAllTyFlag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1287"></span><span class="hs-comment">-- Try to make the coercion be of form (forall tv:kind_co. co)</span><span>
</span><span id="line-1288"></span><span id="etaForAllCo_ty_maybe"><span class="annot"><span class="annottext">etaForAllCo_ty_maybe :: Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaForAllCo_ty_maybe"><span class="hs-identifier hs-var hs-var">etaForAllCo_ty_maybe</span></a></span></span><span> </span><span id="local-6989586621682600863"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600863"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1289"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600864"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600864"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600865"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600865"><span class="hs-identifier hs-var">visL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600866"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600866"><span class="hs-identifier hs-var">visR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600867"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600867"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600868"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600868"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_ty_maybe"><span class="hs-identifier hs-var">splitForAllCo_ty_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600863"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1290"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600864"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600865"><span class="hs-identifier hs-var">visL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600866"><span class="hs-identifier hs-var">visR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600867"><span class="hs-identifier hs-var">kind_co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600868"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1291"></span><span>
</span><span id="line-1292"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682600869"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600869"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682600870"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600870"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600871"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600871"><span class="hs-keyword hs-var">role</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; (Pair Type, Role)
</span><a href="GHC.Core.Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600863"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1293"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621682600873"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600873"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621682600874"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600874"><span class="hs-identifier hs-var">vis1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (ForAllTyBinder, Type)
</span><a href="GHC.Core.Type.html#splitForAllForAllTyBinder_maybe"><span class="hs-identifier hs-var">splitForAllForAllTyBinder_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600869"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1294"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600873"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-1295"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621682600877"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600877"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span id="local-6989586621682600878"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600878"><span class="hs-identifier hs-var">vis2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (ForAllTyBinder, Type)
</span><a href="GHC.Core.Type.html#splitForAllForAllTyBinder_maybe"><span class="hs-identifier hs-var">splitForAllForAllTyBinder_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600870"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1296"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600877"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-1297"></span><span>  </span><span class="hs-comment">-- can't eta-expand at nominal role unless visibilities match</span><span>
</span><span id="line-1298"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600871"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600874"><span class="hs-identifier hs-var">vis1</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; ForAllTyFlag -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqForAllVis"><span class="hs-operator hs-var">`eqForAllVis`</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600878"><span class="hs-identifier hs-var">vis2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1299"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600880"><span class="annot"><span class="annottext">kind_co :: Coercion
</span><a href="#local-6989586621682600880"><span class="hs-identifier hs-var hs-var">kind_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelForAll"><span class="hs-identifier hs-var">SelForAll</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600863"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1300"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600873"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600874"><span class="hs-identifier hs-var">vis1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600878"><span class="hs-identifier hs-var">vis2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600880"><span class="hs-identifier hs-var">kind_co</span></a></span><span>
</span><span id="line-1301"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600863"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_grefl_right_co"><span class="hs-identifier hs-var">mk_grefl_right_co</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600873"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600880"><span class="hs-identifier hs-var">kind_co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1302"></span><span>
</span><span id="line-1303"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1304"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1305"></span><span>
</span><span id="line-1306"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#etaForAllCo_co_maybe"><span class="hs-identifier hs-type">etaForAllCo_co_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">ForAllTyFlag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">ForAllTyFlag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1307"></span><span class="hs-comment">-- Try to make the coercion be of form (forall cv:kind_co. co)</span><span>
</span><span id="line-1308"></span><span id="etaForAllCo_co_maybe"><span class="annot"><span class="annottext">etaForAllCo_co_maybe :: Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaForAllCo_co_maybe"><span class="hs-identifier hs-var hs-var">etaForAllCo_co_maybe</span></a></span></span><span> </span><span id="local-6989586621682600882"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600882"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1309"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600883"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600883"><span class="hs-identifier hs-var">cv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600884"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600884"><span class="hs-identifier hs-var">visL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600885"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600885"><span class="hs-identifier hs-var">visR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600886"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600886"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600887"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600887"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitForAllCo_co_maybe"><span class="hs-identifier hs-var">splitForAllCo_co_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600882"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1310"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600883"><span class="hs-identifier hs-var">cv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600884"><span class="hs-identifier hs-var">visL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600885"><span class="hs-identifier hs-var">visR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600886"><span class="hs-identifier hs-var">kind_co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600887"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1311"></span><span>
</span><span id="line-1312"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682600888"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600888"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682600889"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600889"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600890"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600890"><span class="hs-keyword hs-var">role</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; (Pair Type, Role)
</span><a href="GHC.Core.Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600882"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1313"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621682600891"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600891"><span class="hs-identifier hs-var">cv1</span></a></span></span><span> </span><span id="local-6989586621682600892"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600892"><span class="hs-identifier hs-var">vis1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (ForAllTyBinder, Type)
</span><a href="GHC.Core.Type.html#splitForAllForAllTyBinder_maybe"><span class="hs-identifier hs-var">splitForAllForAllTyBinder_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600888"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1314"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600891"><span class="hs-identifier hs-var">cv1</span></a></span><span>
</span><span id="line-1315"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621682600893"><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600893"><span class="hs-identifier hs-var">cv2</span></a></span></span><span> </span><span id="local-6989586621682600894"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600894"><span class="hs-identifier hs-var">vis2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (ForAllTyBinder, Type)
</span><a href="GHC.Core.Type.html#splitForAllForAllTyBinder_maybe"><span class="hs-identifier hs-var">splitForAllForAllTyBinder_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600889"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1316"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600893"><span class="hs-identifier hs-var">cv2</span></a></span><span>
</span><span id="line-1317"></span><span>  </span><span class="hs-comment">-- can't eta-expand at nominal role unless visibilities match</span><span>
</span><span id="line-1318"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600890"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1319"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600895"><span class="annot"><span class="annottext">kind_co :: Coercion
</span><a href="#local-6989586621682600895"><span class="hs-identifier hs-var hs-var">kind_co</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelForAll"><span class="hs-identifier hs-var">SelForAll</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600882"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1320"></span><span>        </span><span id="local-6989586621682600896"><span class="annot"><span class="annottext">r :: Role
</span><a href="#local-6989586621682600896"><span class="hs-identifier hs-var hs-var">r</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoVar -&gt; Role
</span><a href="GHC.Core.Coercion.html#coVarRole"><span class="hs-identifier hs-var">coVarRole</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600891"><span class="hs-identifier hs-var">cv1</span></a></span><span>
</span><span id="line-1321"></span><span>        </span><span id="local-6989586621682600897"><span class="annot"><span class="annottext">l_co :: Coercion
</span><a href="#local-6989586621682600897"><span class="hs-identifier hs-var hs-var">l_co</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoVar -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600891"><span class="hs-identifier hs-var">cv1</span></a></span><span>
</span><span id="line-1322"></span><span>        </span><span id="local-6989586621682600898"><span class="annot"><span class="annottext">kind_co' :: Coercion
</span><a href="#local-6989586621682600898"><span class="hs-identifier hs-var hs-var">kind_co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600896"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600895"><span class="hs-identifier hs-var">kind_co</span></a></span><span>
</span><span id="line-1323"></span><span>        </span><span id="local-6989586621682600899"><span class="annot"><span class="annottext">r_co :: Coercion
</span><a href="#local-6989586621682600899"><span class="hs-identifier hs-var hs-var">r_co</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Role -&gt; CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelTyCon"><span class="hs-identifier hs-var">SelTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600896"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600898"><span class="hs-identifier hs-var">kind_co'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1324"></span><span>                   </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_trans_co"><span class="hs-operator hs-var">`mk_trans_co`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600897"><span class="hs-identifier hs-var">l_co</span></a></span><span>
</span><span id="line-1325"></span><span>                   </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_trans_co"><span class="hs-operator hs-var">`mk_trans_co`</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; CoSel -&gt; Coercion -&gt; Coercion
CoSel -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSelCo"><span class="hs-identifier hs-var">mkSelCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Role -&gt; CoSel
</span><a href="GHC.Core.TyCo.Rep.html#SelTyCon"><span class="hs-identifier hs-var">SelTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600896"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600898"><span class="hs-identifier hs-var">kind_co'</span></a></span><span>
</span><span id="line-1326"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
-&gt; Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CoVar
</span><a href="#local-6989586621682600891"><span class="hs-identifier hs-var">cv1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600892"><span class="hs-identifier hs-var">vis1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682600894"><span class="hs-identifier hs-var">vis2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600895"><span class="hs-identifier hs-var">kind_co</span></a></span><span>
</span><span id="line-1327"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600882"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Coercion -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkProofIrrelCo"><span class="hs-identifier hs-var">mkProofIrrelCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600895"><span class="hs-identifier hs-var">kind_co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600897"><span class="hs-identifier hs-var">l_co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600899"><span class="hs-identifier hs-var">r_co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1328"></span><span>
</span><span id="line-1329"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1330"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (CoVar, ForAllTyFlag, ForAllTyFlag, Coercion, Coercion)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1331"></span><span>
</span><span id="line-1332"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#etaAppCo_maybe"><span class="hs-identifier hs-type">etaAppCo_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1333"></span><span class="hs-comment">-- If possible, split a coercion</span><span>
</span><span id="line-1334"></span><span class="hs-comment">--   g :: t1a t1b ~ t2a t2b</span><span>
</span><span id="line-1335"></span><span class="hs-comment">-- into a pair of coercions (left g, right g)</span><span>
</span><span id="line-1336"></span><span id="etaAppCo_maybe"><span class="annot"><span class="annottext">etaAppCo_maybe :: Coercion -&gt; Maybe (Coercion, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#etaAppCo_maybe"><span class="hs-identifier hs-var hs-var">etaAppCo_maybe</span></a></span></span><span> </span><span id="local-6989586621682600901"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600901"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1337"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600902"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600902"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682600903"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600903"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600901"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1338"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion, Coercion) -&gt; Maybe (Coercion, Coercion)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600902"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600903"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1339"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682600904"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600904"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682600905"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600905"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; (Pair Type, Role)
</span><a href="GHC.Core.Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600901"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1340"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621682600906"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600906"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#splitAppTy_maybe"><span class="hs-identifier hs-var">splitAppTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600904"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1341"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621682600908"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600908"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#splitAppTy_maybe"><span class="hs-identifier hs-var">splitAppTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600905"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1342"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600909"><span class="annot"><span class="annottext">isco1 :: Bool
</span><a href="#local-6989586621682600909"><span class="hs-identifier hs-var hs-var">isco1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isCoercionTy"><span class="hs-identifier hs-var">isCoercionTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600906"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-1343"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600911"><span class="annot"><span class="annottext">isco2 :: Bool
</span><a href="#local-6989586621682600911"><span class="hs-identifier hs-var hs-var">isco2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isCoercionTy"><span class="hs-identifier hs-var">isCoercionTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600908"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-1344"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600909"><span class="hs-identifier hs-var">isco1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682600911"><span class="hs-identifier hs-var">isco2</span></a></span><span>
</span><span id="line-1345"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coercion, Coercion) -&gt; Maybe (Coercion, Coercion)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LeftOrRight -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="GHC.Types.Basic.html#CLeft"><span class="hs-identifier hs-var">CLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600901"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LeftOrRight -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Rep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrRight
</span><a href="GHC.Types.Basic.html#CRight"><span class="hs-identifier hs-var">CRight</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600901"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1346"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1347"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Coercion, Coercion)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1348"></span><span>
</span><span id="line-1349"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#etaTyConAppCo_maybe"><span class="hs-identifier hs-type">etaTyConAppCo_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1350"></span><span class="hs-comment">-- If possible, split a coercion</span><span>
</span><span id="line-1351"></span><span class="hs-comment">--       g :: T s1 .. sn ~ T t1 .. tn</span><span>
</span><span id="line-1352"></span><span class="hs-comment">-- into [ SelCo (SelTyCon 0)     g :: s1~t1</span><span>
</span><span id="line-1353"></span><span class="hs-comment">--      , ...</span><span>
</span><span id="line-1354"></span><span class="hs-comment">--      , SelCo (SelTyCon (n-1)) g :: sn~tn ]</span><span>
</span><span id="line-1355"></span><span id="etaTyConAppCo_maybe"><span class="annot"><span class="annottext">etaTyConAppCo_maybe :: TyCon -&gt; Coercion -&gt; Maybe [Coercion]
</span><a href="GHC.Core.Coercion.Opt.html#etaTyConAppCo_maybe"><span class="hs-identifier hs-var hs-var">etaTyConAppCo_maybe</span></a></span></span><span> </span><span id="local-6989586621682600912"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600912"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConAppCo"><span class="hs-identifier hs-type">TyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682600913"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600913"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span id="local-6989586621682600914"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600914"><span class="hs-identifier hs-var">cos2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1356"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe [Coercion] -&gt; Maybe [Coercion]
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600912"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600913"><span class="hs-identifier hs-var">tc2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe [Coercion] -&gt; Maybe [Coercion])
-&gt; Maybe [Coercion] -&gt; Maybe [Coercion]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Coercion] -&gt; Maybe [Coercion]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682600914"><span class="hs-identifier hs-var">cos2</span></a></span><span>
</span><span id="line-1357"></span><span>
</span><span id="line-1358"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#etaTyConAppCo_maybe"><span class="hs-identifier hs-var">etaTyConAppCo_maybe</span></a></span><span> </span><span id="local-6989586621682600915"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600915"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682600916"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600916"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1359"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#tyConMustBeSaturated"><span class="hs-identifier hs-var">tyConMustBeSaturated</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600915"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1360"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682600918"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600918"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682600919"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600919"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600920"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600920"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; (Pair Type, Role)
</span><a href="GHC.Core.Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600916"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1361"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600921"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600921"><span class="hs-identifier hs-var">tc1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600922"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682600922"><span class="hs-identifier hs-var">tys1</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600918"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1362"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682600924"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600924"><span class="hs-identifier hs-var">tc2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682600925"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682600925"><span class="hs-identifier hs-var">tys2</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600919"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1363"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600921"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600924"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-1364"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Role -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isInjectiveTyCon"><span class="hs-identifier hs-var">isInjectiveTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600915"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600920"><span class="hs-identifier hs-var">r</span></a></span><span>  </span><span class="hs-comment">-- See Note [SelCo and newtypes] in GHC.Core.TyCo.Rep</span><span>
</span><span id="line-1365"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682600927"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621682600927"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682600922"><span class="hs-identifier hs-var">tys1</span></a></span><span>
</span><span id="line-1366"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621682600925"><span class="hs-identifier hs-var">tys2</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthIs"><span class="hs-operator hs-var">`lengthIs`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682600927"><span class="hs-identifier hs-var">n</span></a></span><span>      </span><span class="hs-comment">-- This can fail in an erroneous program</span><span>
</span><span id="line-1367"></span><span>                           </span><span class="hs-comment">-- E.g. T a ~# T a b</span><span>
</span><span id="line-1368"></span><span>                           </span><span class="hs-comment">-- #14607</span><span>
</span><span id="line-1369"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe [Coercion] -&gt; Maybe [Coercion]
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600915"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600921"><span class="hs-identifier hs-var">tc1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe [Coercion] -&gt; Maybe [Coercion])
-&gt; Maybe [Coercion] -&gt; Maybe [Coercion]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1370"></span><span>    </span><span class="annot"><span class="annottext">[Coercion] -&gt; Maybe [Coercion]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Coercion -&gt; Infinite Role -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.html#decomposeCo"><span class="hs-identifier hs-var">decomposeCo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682600927"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600916"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; Infinite Role
</span><a href="GHC.Core.Coercion.html#tyConRolesX"><span class="hs-identifier hs-var">tyConRolesX</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600920"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682600921"><span class="hs-identifier hs-var">tc1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1371"></span><span>    </span><span class="hs-comment">-- NB: n might be &lt;&gt; tyConArity tc</span><span>
</span><span id="line-1372"></span><span>    </span><span class="hs-comment">-- e.g.   data family T a :: * -&gt; *</span><span>
</span><span id="line-1373"></span><span>    </span><span class="hs-comment">--        g :: T a b ~ T c d</span><span>
</span><span id="line-1374"></span><span>
</span><span id="line-1375"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1376"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [Coercion]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1377"></span><span>
</span><span id="line-1378"></span><span class="hs-comment">{-
Note [Eta for AppCo]
~~~~~~~~~~~~~~~~~~~~
Suppose we have
   g :: s1 t1 ~ s2 t2

Then we can't necessarily make
   left  g :: s1 ~ s2
   right g :: t1 ~ t2
because it's possible that
   s1 :: * -&gt; *         t1 :: *
   s2 :: (*-&gt;*) -&gt; *    t2 :: * -&gt; *
and in that case (left g) does not have the same
kind on either side.

It's enough to check that
  kind t1 = kind t2
because if g is well-kinded then
  kind (s1 t2) = kind (s2 t2)
and these two imply
  kind s1 = kind s2

-}</span><span>
</span><span id="line-1401"></span><span>
</span><span id="line-1402"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#optForAllCoBndr"><span class="hs-identifier hs-type">optForAllCoBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span>
</span><span id="line-1403"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1404"></span><span id="optForAllCoBndr"><span class="annot"><span class="annottext">optForAllCoBndr :: LiftingContext
-&gt; SwapFlag
-&gt; CoVar
-&gt; Coercion
-&gt; (LiftingContext, CoVar, Coercion)
</span><a href="GHC.Core.Coercion.Opt.html#optForAllCoBndr"><span class="hs-identifier hs-var hs-var">optForAllCoBndr</span></a></span></span><span> </span><span id="local-6989586621682600932"><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600932"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682600933"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600933"><span class="hs-identifier hs-var">sym</span></a></span></span><span>
</span><span id="line-1405"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag
-&gt; (Coercion -&gt; Coercion)
-&gt; LiftingContext
-&gt; CoVar
-&gt; Coercion
-&gt; (LiftingContext, CoVar, Coercion)
</span><a href="GHC.Core.Coercion.html#substForAllCoBndrUsingLC"><span class="hs-identifier hs-var">substForAllCoBndrUsingLC</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600933"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftingContext -&gt; SwapFlag -&gt; Bool -&gt; Role -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a></span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600932"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621682600933"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LiftingContext
</span><a href="#local-6989586621682600932"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1406"></span><span>
</span><span id="line-1407"></span><span>
</span><span id="line-1408"></span><span class="annot"><span class="hs-comment">{- **********************************************************************
%*                                                                      *
       Assertion-checking versions of functions in Coercion.hs
%*                                                                      *
%********************************************************************* -}</span></span><span>
</span><span id="line-1413"></span><span>
</span><span id="line-1414"></span><span class="hs-comment">-- We can't check the assertions in the &quot;main&quot; functions of these</span><span>
</span><span id="line-1415"></span><span class="hs-comment">-- functions, because the assertions don't hold during zonking.</span><span>
</span><span id="line-1416"></span><span class="hs-comment">-- But they are fantastically helpful in finding bugs in the coercion</span><span>
</span><span id="line-1417"></span><span class="hs-comment">-- optimiser itself, so I have copied them here with assertions.</span><span>
</span><span id="line-1418"></span><span>
</span><span id="line-1419"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#mk_trans_co"><span class="hs-identifier hs-type">mk_trans_co</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1420"></span><span class="hs-comment">-- Do assertion checking in mk_trans_co</span><span>
</span><span id="line-1421"></span><span id="mk_trans_co"><span class="annot"><span class="annottext">mk_trans_co :: HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_trans_co"><span class="hs-identifier hs-var hs-var">mk_trans_co</span></a></span></span><span> </span><span id="local-6989586621682600960"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600960"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621682600961"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600961"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-1422"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600960"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600961"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1423"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;co1&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600960"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-1424"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;co2&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600961"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1425"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;co1 kind&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Pair Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600960"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1426"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;co2 kind&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Pair Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600961"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1427"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SDoc
HasCallStack =&gt; SDoc
</span><a href="GHC.Utils.Panic.html#callStackDoc"><span class="hs-identifier hs-var">callStackDoc</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1428"></span><span>    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600960"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600961"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1429"></span><span>
</span><span id="line-1430"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#mk_coherence_right_co"><span class="hs-identifier hs-type">mk_coherence_right_co</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1431"></span><span id="mk_coherence_right_co"><span class="annot"><span class="annottext">mk_coherence_right_co :: HasDebugCallStack =&gt;
Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_coherence_right_co"><span class="hs-identifier hs-var hs-var">mk_coherence_right_co</span></a></span></span><span> </span><span id="local-6989586621682600967"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600967"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621682600968"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600968"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682600969"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600969"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682600970"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600970"><span class="hs-identifier hs-var">co2</span></a></span></span><span>
</span><span id="line-1432"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
forall r. HasDebugCallStack =&gt; Type -&gt; Coercion -&gt; r -&gt; r
</span><a href="GHC.Core.Coercion.Opt.html#assertGRefl"><span class="hs-identifier hs-var">assertGRefl</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600968"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600969"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1433"></span><span>    </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
Role -&gt; Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600967"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600968"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600969"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600970"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1434"></span><span>
</span><span id="line-1435"></span><span id="local-6989586621682599850"><span class="annot"><a href="GHC.Core.Coercion.Opt.html#assertGRefl"><span class="hs-identifier hs-type">assertGRefl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682599850"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682599850"><span class="hs-identifier hs-type">r</span></a></span></span><span>
</span><span id="line-1436"></span><span id="assertGRefl"><span class="annot"><span class="annottext">assertGRefl :: forall r. HasDebugCallStack =&gt; Type -&gt; Coercion -&gt; r -&gt; r
</span><a href="GHC.Core.Coercion.Opt.html#assertGRefl"><span class="hs-identifier hs-var hs-var">assertGRefl</span></a></span></span><span> </span><span id="local-6989586621682600983"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600983"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682600984"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600984"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682600985"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682600985"><span class="hs-identifier hs-var">res</span></a></span></span><span>
</span><span id="line-1437"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; r -&gt; r
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600983"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Type
Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionLKind"><span class="hs-identifier hs-var">coercionLKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600984"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1438"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; SDoc
</span><a href="GHC.Core.Coercion.Opt.html#pp_ty"><span class="hs-identifier hs-var">pp_ty</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ty&quot;</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600983"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1439"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Coercion -&gt; SDoc
</span><a href="GHC.Core.Coercion.Opt.html#pp_co"><span class="hs-identifier hs-var">pp_co</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;co&quot;</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600984"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1440"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SDoc
HasCallStack =&gt; SDoc
</span><a href="GHC.Utils.Panic.html#callStackDoc"><span class="hs-identifier hs-var">callStackDoc</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(r -&gt; r) -&gt; r -&gt; r
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1441"></span><span>    </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621682600985"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-1442"></span><span>
</span><span id="line-1443"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#mk_grefl_right_co"><span class="hs-identifier hs-type">mk_grefl_right_co</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1444"></span><span id="mk_grefl_right_co"><span class="annot"><span class="annottext">mk_grefl_right_co :: Role -&gt; Type -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.Opt.html#mk_grefl_right_co"><span class="hs-identifier hs-var hs-var">mk_grefl_right_co</span></a></span></span><span> </span><span id="local-6989586621682600989"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600989"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621682600990"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600990"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682600991"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600991"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1445"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Coercion -&gt; Coercion -&gt; Coercion
forall r. HasDebugCallStack =&gt; Type -&gt; Coercion -&gt; r -&gt; r
</span><a href="GHC.Core.Coercion.Opt.html#assertGRefl"><span class="hs-identifier hs-var">assertGRefl</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600990"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600991"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">(Coercion -&gt; Coercion) -&gt; Coercion -&gt; Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1446"></span><span>    </span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkGReflRightCo"><span class="hs-identifier hs-var">mkGReflRightCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682600989"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600990"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600991"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1447"></span><span>
</span><span id="line-1448"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#pp_co"><span class="hs-identifier hs-type">pp_co</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-1449"></span><span id="pp_co"><span class="annot"><span class="annottext">pp_co :: String -&gt; Coercion -&gt; SDoc
</span><a href="GHC.Core.Coercion.Opt.html#pp_co"><span class="hs-identifier hs-var hs-var">pp_co</span></a></span></span><span> </span><span id="local-6989586621682600993"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682600993"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621682600994"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600994"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682600993"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600994"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.Utils.Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Pair Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; Pair Type
Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682600994"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1450"></span><span>
</span><span id="line-1451"></span><span class="annot"><a href="GHC.Core.Coercion.Opt.html#pp_ty"><span class="hs-identifier hs-type">pp_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-1452"></span><span id="pp_ty"><span class="annot"><span class="annottext">pp_ty :: String -&gt; Type -&gt; SDoc
</span><a href="GHC.Core.Coercion.Opt.html#pp_ty"><span class="hs-identifier hs-var hs-var">pp_ty</span></a></span></span><span> </span><span id="local-6989586621682600997"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682600997"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621682600998"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600998"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682600997"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600998"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.Utils.Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682600998"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1453"></span><span>
</span><span id="line-1454"></span></pre></body></html>