<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Utility functions on @Core@ syntax
-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-10"></span><span>        </span><span class="annot"><span class="hs-comment">-- * Main data types</span></span><span>
</span><span id="line-11"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier">Subst</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Implementation exported for supercompiler's Renaming.hs only</span><span>
</span><span id="line-12"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier">TvSubstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#IdSubstEnv"><span class="hs-identifier">IdSubstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier">InScopeSet</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span>        </span><span class="annot"><span class="hs-comment">-- ** Substituting into expressions and related types</span></span><span>
</span><span id="line-15"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#deShadowBinds"><span class="hs-identifier">deShadowBinds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substRuleInfo"><span class="hs-identifier">substRuleInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substRulesForImportedIds"><span class="hs-identifier">substRulesForImportedIds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier">substTyUnchecked</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier">substCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier">substExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substExprSC"><span class="hs-identifier">substExprSC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substBind"><span class="hs-identifier">substBind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substBindSC"><span class="hs-identifier">substBindSC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#substUnfolding"><span class="hs-identifier">substUnfolding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substUnfoldingSC"><span class="hs-identifier">substUnfoldingSC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier">lookupIdSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#lookupIdSubst_maybe"><span class="hs-identifier">lookupIdSubst_maybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substIdType"><span class="hs-identifier">substIdType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substIdOcc"><span class="hs-identifier">substIdOcc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#substTickish"><span class="hs-identifier">substTickish</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substDVarSet"><span class="hs-identifier">substDVarSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substIdInfo"><span class="hs-identifier">substIdInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span>        </span><span class="annot"><span class="hs-comment">-- ** Operations on substitutions</span></span><span>
</span><span id="line-22"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#emptySubst"><span class="hs-identifier">emptySubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier">mkEmptySubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#mkTCvSubst"><span class="hs-identifier">mkTCvSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#mkOpenSubst"><span class="hs-identifier">mkOpenSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#isEmptySubst"><span class="hs-identifier">isEmptySubst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier">extendIdSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#extendIdSubstList"><span class="hs-identifier">extendIdSubstList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendTCvSubst"><span class="hs-identifier">extendTCvSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendTvSubstList"><span class="hs-identifier">extendTvSubstList</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#extendIdSubstWithClone"><span class="hs-identifier">extendIdSubstWithClone</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier">extendSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#extendSubstList"><span class="hs-identifier">extendSubstList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#extendSubstWithVar"><span class="hs-identifier">extendSubstWithVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendSubstInScope"><span class="hs-identifier">extendSubstInScope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendSubstInScopeList"><span class="hs-identifier">extendSubstInScopeList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendSubstInScopeSet"><span class="hs-identifier">extendSubstInScopeSet</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#isInScope"><span class="hs-identifier">isInScope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#setInScope"><span class="hs-identifier">setInScope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier">getSubstInScope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendTvSubst"><span class="hs-identifier">extendTvSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendCvSubst"><span class="hs-identifier">extendCvSubst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#delBndr"><span class="hs-identifier">delBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#delBndrs"><span class="hs-identifier">delBndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#zapSubst"><span class="hs-identifier">zapSubst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>        </span><span class="annot"><span class="hs-comment">-- ** Substituting and cloning binders</span></span><span>
</span><span id="line-32"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier">substBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier">substBndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substRecBndrs"><span class="hs-identifier">substRecBndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTyVarBndr"><span class="hs-identifier">substTyVarBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCoVarBndr"><span class="hs-identifier">substCoVarBndr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>        </span><span class="annot"><a href="GHC.Core.Subst.html#cloneBndr"><span class="hs-identifier">cloneBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#cloneBndrs"><span class="hs-identifier">cloneBndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#cloneIdBndr"><span class="hs-identifier">cloneIdBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#cloneIdBndrs"><span class="hs-identifier">cloneIdBndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#cloneRecIdBndrs"><span class="hs-identifier">cloneRecIdBndrs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Seq.html"><span class="hs-identifier">GHC.Core.Seq</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span>        </span><span class="hs-comment">-- We are defining local versions</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier">substTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#tyCoFVsOfCo"><span class="hs-identifier">tyCoFVsOfCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier">mkCoVarCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCoVarBndr"><span class="hs-identifier">substCoVarBndr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InScopeSet</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier">Name</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html"><span class="hs-identifier">GHC.Types.Unique.Supply</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Functor.Identity.html"><span class="hs-identifier">Data.Functor.Identity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Identity</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mapAccumL</span></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Substitutions}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">{-
Note [Extending the IdSubstEnv]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We make a different choice for Ids than we do for TyVars.

For TyVars, see Note [Extending the TvSubstEnv and CvSubstEnv] in GHC.Core.TyCo.Subst.

For Ids, we have a different invariant
        The IdSubstEnv is extended *only* when the Unique on an Id changes
        Otherwise, we just extend the InScopeSet

In consequence:

* If all subst envs are empty, substExpr would be a
  no-op, so substExprSC (&quot;short cut&quot;) does nothing.

  However, substExpr still goes ahead and substitutes.  Reason: we may
  want to replace existing Ids with new ones from the in-scope set, to
  avoid space leaks.

* In substIdBndr, we extend the IdSubstEnv only when the unique changes

* If the CvSubstEnv, TvSubstEnv and IdSubstEnv are all empty,
  substExpr does nothing (Note that the above rule for substIdBndr
  maintains this property.  If the incoming envts are both empty, then
  substituting the type and IdInfo can't change anything.)

* In lookupIdSubst, we *must* look up the Id in the in-scope set, because
  it may contain non-trivial changes.  Example:
        (/\a. \x:a. ...x...) Int
  We extend the TvSubstEnv with [a |-&gt; Int]; but x's unique does not change
  so we only extend the in-scope set.  Then we must look up in the in-scope
  set when we find the occurrence of x.

* The requirement to look up the Id in the in-scope set means that we
  must NOT take no-op short cut when the IdSubst is empty.
  We must still look up every Id in the in-scope set.

* (However, we don't need to do so for expressions found in the IdSubst
  itself, whose range is assumed to be correct wrt the in-scope set.)

Why do we make a different choice for the IdSubstEnv than the
TvSubstEnv and CvSubstEnv?

* For Ids, we change the IdInfo all the time (e.g. deleting the
  unfolding), and adding it back later, so using the TyVar convention
  would entail extending the substitution almost all the time

* The simplifier wants to look up in the in-scope set anyway, in case it
  can see a better unfolding from an enclosing case expression

* For TyVars, only coercion variables can possibly change, and they are
  easy to spot
-}</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">-- We keep GHC.Core.Subst separate from GHC.Core.TyCo.Subst to avoid creating</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- circular dependencies. Functions in this file that don't depend on</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- the definition of CoreExpr can be moved to GHC.Core.TyCo.Subst, as long</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- as it does not require importing too many additional hs-boot files and</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- cause a significant drop in performance.</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-comment">-- | Add a substitution for an 'Id' to the 'Subst': you must ensure that the in-scope set is</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- such that TyCoSubst Note [The substitution invariant]</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- holds after extending the substitution like this</span><span>
</span><span id="line-142"></span><span class="annot"><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier hs-type">extendIdSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-143"></span><span class="hs-comment">-- ToDo: add an ASSERT that fvs(subst-result) is already in the in-scope set</span><span>
</span><span id="line-144"></span><span id="extendIdSubst"><span class="annot"><span class="annottext">extendIdSubst :: Subst -&gt; Id -&gt; CoreExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier hs-var hs-var">extendIdSubst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621682705085"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705085"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682705086"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705086"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682705087"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705087"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682705088"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705088"><span class="hs-identifier hs-var">cvs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705089"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705089"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682705090"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705090"><span class="hs-identifier hs-var">r</span></a></span></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isNonCoVarId"><span class="hs-identifier hs-var">isNonCoVarId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705089"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705089"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705090"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705085"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Id -&gt; CoreExpr -&gt; IdSubstEnv
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705086"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705089"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705090"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705087"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705088"><span class="hs-identifier hs-var">cvs</span></a></span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="annot"><a href="GHC.Core.Subst.html#extendIdSubstWithClone"><span class="hs-identifier hs-type">extendIdSubstWithClone</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-149"></span><span id="extendIdSubstWithClone"><span class="annot"><span class="annottext">extendIdSubstWithClone :: Subst -&gt; Id -&gt; Id -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubstWithClone"><span class="hs-identifier hs-var hs-var">extendIdSubstWithClone</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621682705096"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705096"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682705097"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705097"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682705098"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705098"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682705099"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705099"><span class="hs-identifier hs-var">cvs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705100"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705100"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682705101"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705101"><span class="hs-identifier hs-var">v'</span></a></span></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isNonCoVarId"><span class="hs-identifier hs-var">isNonCoVarId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705100"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705100"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705101"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSetSet"><span class="hs-identifier hs-var">extendInScopeSetSet</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705096"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682705103"><span class="hs-identifier hs-var">new_in_scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Id -&gt; CoreExpr -&gt; IdSubstEnv
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705097"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705100"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705101"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705098"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705099"><span class="hs-identifier hs-var">cvs</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-154"></span><span>      </span><span id="local-6989586621682705103"><span class="annot"><span class="annottext">new_in_scope :: VarSet
</span><a href="#local-6989586621682705103"><span class="hs-identifier hs-var hs-var">new_in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705101"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; Id -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSet"><span class="hs-operator hs-var">`extendVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705101"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="annot"><span class="hs-comment">-- | Adds multiple 'Id' substitutions to the 'Subst': see also 'extendIdSubst'</span></span><span>
</span><span id="line-157"></span><span class="annot"><a href="GHC.Core.Subst.html#extendIdSubstList"><span class="hs-identifier hs-type">extendIdSubstList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-158"></span><span id="extendIdSubstList"><span class="annot"><span class="annottext">extendIdSubstList :: Subst -&gt; [(Id, CoreExpr)] -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubstList"><span class="hs-identifier hs-var hs-var">extendIdSubstList</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621682705108"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705108"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682705109"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705109"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682705110"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705110"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682705111"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705111"><span class="hs-identifier hs-var">cvs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705112"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705112"><span class="hs-identifier hs-var">prs</span></a></span></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Bool) -&gt; [(Id, CoreExpr)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isNonCoVarId"><span class="hs-identifier hs-var">isNonCoVarId</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; ((Id, CoreExpr) -&gt; Id) -&gt; (Id, CoreExpr) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705112"><span class="hs-identifier hs-var">prs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705108"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdSubstEnv -&gt; [(Id, CoreExpr)] -&gt; IdSubstEnv
forall a. VarEnv a -&gt; [(Id, a)] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnvList"><span class="hs-identifier hs-var">extendVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705109"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705112"><span class="hs-identifier hs-var">prs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705110"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705111"><span class="hs-identifier hs-var">cvs</span></a></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | Add a substitution appropriate to the thing being substituted</span><span>
</span><span id="line-163"></span><span class="hs-comment">--   (whether an expression, type, or coercion). See also</span><span>
</span><span id="line-164"></span><span class="hs-comment">--   'extendIdSubst', 'extendTvSubst', 'extendCvSubst'</span><span>
</span><span id="line-165"></span><span class="annot"><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier hs-type">extendSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-166"></span><span id="extendSubst"><span class="annot"><span class="annottext">extendSubst :: Subst -&gt; Id -&gt; CoreExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier hs-var hs-var">extendSubst</span></a></span></span><span> </span><span id="local-6989586621682705120"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705120"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705121"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705121"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621682705122"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705122"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705122"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-168"></span><span>      </span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682705124"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705124"><span class="hs-identifier hs-var">ty</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705121"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; Type -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705120"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705121"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705124"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-169"></span><span>      </span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682705127"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682705127"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705121"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; Coercion -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705120"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705121"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682705127"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-170"></span><span>      </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span>    </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705121"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; CoreExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705120"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705121"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705122"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="annot"><a href="GHC.Core.Subst.html#extendSubstWithVar"><span class="hs-identifier hs-type">extendSubstWithVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-173"></span><span id="extendSubstWithVar"><span class="annot"><span class="annottext">extendSubstWithVar :: Subst -&gt; Id -&gt; Id -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendSubstWithVar"><span class="hs-identifier hs-var hs-var">extendSubstWithVar</span></a></span></span><span> </span><span id="local-6989586621682705130"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705130"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705131"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705131"><span class="hs-identifier hs-var">v1</span></a></span></span><span> </span><span id="local-6989586621682705132"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705132"><span class="hs-identifier hs-var">v2</span></a></span></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705131"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705132"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; Type -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705130"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705131"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705132"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705131"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705132"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; Coercion -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705130"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705131"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705132"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span>    </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705132"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; CoreExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705130"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705131"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705132"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">-- | Add a substitution as appropriate to each of the terms being</span><span>
</span><span id="line-179"></span><span class="hs-comment">--   substituted (whether expressions, types, or coercions). See also</span><span>
</span><span id="line-180"></span><span class="hs-comment">--   'extendSubst'.</span><span>
</span><span id="line-181"></span><span class="annot"><a href="GHC.Core.Subst.html#extendSubstList"><span class="hs-identifier hs-type">extendSubstList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-182"></span><span id="extendSubstList"><span class="annot"><span class="annottext">extendSubstList :: Subst -&gt; [(Id, CoreExpr)] -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendSubstList"><span class="hs-identifier hs-var hs-var">extendSubstList</span></a></span></span><span> </span><span id="local-6989586621682705135"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705135"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705135"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-183"></span><span class="annot"><a href="GHC.Core.Subst.html#extendSubstList"><span class="hs-identifier hs-var">extendSubstList</span></a></span><span> </span><span id="local-6989586621682705136"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705136"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621682705137"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705137"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682705138"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705138"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682705139"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705139"><span class="hs-identifier hs-var">prs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [(Id, CoreExpr)] -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendSubstList"><span class="hs-identifier hs-var">extendSubstList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; CoreExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier hs-var">extendSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705136"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705137"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705138"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705139"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- | Find the substitution for an 'Id' in the 'Subst'</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- The Id should not be a CoVar</span><span>
</span><span id="line-187"></span><span class="annot"><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-type">lookupIdSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-188"></span><span id="lookupIdSubst"><span class="annot"><span class="annottext">lookupIdSubst :: HasDebugCallStack =&gt; Subst -&gt; Id -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-var hs-var">lookupIdSubst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621682705150"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705150"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682705151"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705151"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705152"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705152"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; (Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705152"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705152"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705152"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705152"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705152"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682705156"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705156"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Id -&gt; Maybe CoreExpr
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705151"><span class="hs-identifier hs-var">ids</span></a></span><span>       </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705152"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705156"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682705158"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705158"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Id -&gt; Maybe Id
</span><a href="GHC.Types.Var.Env.html#lookupInScope"><span class="hs-identifier hs-var">lookupInScope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705150"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705152"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705158"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-193"></span><span>        </span><span class="hs-comment">-- Vital! See Note [Extending the IdSubstEnv]</span><span>
</span><span id="line-194"></span><span>        </span><span class="hs-comment">-- If v isn't in the InScopeSet, we panic, because</span><span>
</span><span id="line-195"></span><span>        </span><span class="hs-comment">-- it's a bad bug and we really want to know</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; CoreExpr
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lookupIdSubst&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705152"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705150"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="annot"><a href="GHC.Core.Subst.html#lookupIdSubst_maybe"><span class="hs-identifier hs-type">lookupIdSubst_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-199"></span><span class="hs-comment">-- Just look up in the substitution; do not check the in-scope set</span><span>
</span><span id="line-200"></span><span id="lookupIdSubst_maybe"><span class="annot"><span class="annottext">lookupIdSubst_maybe :: HasDebugCallStack =&gt; Subst -&gt; Id -&gt; Maybe CoreExpr
</span><a href="GHC.Core.Subst.html#lookupIdSubst_maybe"><span class="hs-identifier hs-var hs-var">lookupIdSubst_maybe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682705165"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705165"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705166"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705166"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Maybe CoreExpr -&gt; Maybe CoreExpr
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705166"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705166"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705166"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe CoreExpr -&gt; Maybe CoreExpr)
-&gt; Maybe CoreExpr -&gt; Maybe CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Id -&gt; Maybe CoreExpr
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705165"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705166"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="annot"><a href="GHC.Core.Subst.html#delBndr"><span class="hs-identifier hs-type">delBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-205"></span><span id="delBndr"><span class="annot"><span class="annottext">delBndr :: Subst -&gt; Id -&gt; Subst
</span><a href="GHC.Core.Subst.html#delBndr"><span class="hs-identifier hs-var hs-var">delBndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621682705167"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705167"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682705168"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705168"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682705169"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705169"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682705170"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705170"><span class="hs-identifier hs-var">cvs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705171"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705171"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705171"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705167"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705168"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705169"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Id -&gt; CvSubstEnv
forall a. VarEnv a -&gt; Id -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705170"><span class="hs-identifier hs-var">cvs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705171"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705171"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705167"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705168"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Id -&gt; TvSubstEnv
forall a. VarEnv a -&gt; Id -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705169"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705171"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705170"><span class="hs-identifier hs-var">cvs</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705167"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Id -&gt; IdSubstEnv
forall a. VarEnv a -&gt; Id -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705168"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705171"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705169"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705170"><span class="hs-identifier hs-var">cvs</span></a></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="annot"><a href="GHC.Core.Subst.html#delBndrs"><span class="hs-identifier hs-type">delBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-211"></span><span id="delBndrs"><span class="annot"><span class="annottext">delBndrs :: Subst -&gt; [Id] -&gt; Subst
</span><a href="GHC.Core.Subst.html#delBndrs"><span class="hs-identifier hs-var hs-var">delBndrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621682705173"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705173"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682705174"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705174"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682705175"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705175"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682705176"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705176"><span class="hs-identifier hs-var">cvs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705177"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705177"><span class="hs-identifier hs-var">vs</span></a></span></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705173"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdSubstEnv -&gt; [Id] -&gt; IdSubstEnv
forall a. VarEnv a -&gt; [Id] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705174"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705177"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TvSubstEnv -&gt; [Id] -&gt; TvSubstEnv
forall a. VarEnv a -&gt; [Id] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705175"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705177"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CvSubstEnv -&gt; [Id] -&gt; CvSubstEnv
forall a. VarEnv a -&gt; [Id] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705176"><span class="hs-identifier hs-var">cvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705177"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>      </span><span class="hs-comment">-- Easiest thing is just delete all from all!</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-comment">-- | Simultaneously substitute for a bunch of variables</span><span>
</span><span id="line-216"></span><span class="hs-comment">--   No left-right shadowing</span><span>
</span><span id="line-217"></span><span class="hs-comment">--   ie the substitution for   (\x \y. e) a1 a2</span><span>
</span><span id="line-218"></span><span class="hs-comment">--      so neither x nor y scope over a1 a2</span><span>
</span><span id="line-219"></span><span class="annot"><a href="GHC.Core.Subst.html#mkOpenSubst"><span class="hs-identifier hs-type">mkOpenSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-220"></span><span id="mkOpenSubst"><span class="annot"><span class="annottext">mkOpenSubst :: InScopeSet -&gt; [(Id, CoreExpr)] -&gt; Subst
</span><a href="GHC.Core.Subst.html#mkOpenSubst"><span class="hs-identifier hs-var hs-var">mkOpenSubst</span></a></span></span><span> </span><span id="local-6989586621682705179"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705179"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682705180"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705180"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705179"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-221"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; IdSubstEnv
forall a. [(Id, a)] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705182"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705183"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682705182"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705182"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705183"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705183"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705180"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705182"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, Type)] -&gt; TvSubstEnv
forall a. [(Id, a)] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705184"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705185"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682705184"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705184"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682705185"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705185"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705180"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, Coercion)] -&gt; CvSubstEnv
forall a. [(Id, a)] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705186"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682705187"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682705186"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705186"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682705187"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682705187"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705180"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Substituting expressions
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="annot"><a href="GHC.Core.Subst.html#substExprSC"><span class="hs-identifier hs-type">substExprSC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-236"></span><span class="hs-comment">-- Just like substExpr, but a no-op if the substitution is empty</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- Note that this does /not/ replace occurrences of free vars with</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- their canonical representatives in the in-scope set</span><span>
</span><span id="line-239"></span><span id="substExprSC"><span class="annot"><span class="annottext">substExprSC :: HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExprSC"><span class="hs-identifier hs-var hs-var">substExprSC</span></a></span></span><span> </span><span id="local-6989586621682705190"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705190"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705191"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705191"><span class="hs-identifier hs-var">orig_expr</span></a></span></span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Bool
</span><a href="GHC.Core.TyCo.Subst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705190"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705191"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;enter subst-expr&quot; (doc $$ ppr orig_expr) $</span><span>
</span><span id="line-242"></span><span>                         </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705190"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705191"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">-- | substExpr applies a substitution to an entire 'CoreExpr'. Remember,</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- you may only apply the substitution /once/:</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- See Note [Substitutions apply only once] in &quot;GHC.Core.TyCo.Subst&quot;</span><span>
</span><span id="line-247"></span><span class="hs-comment">--</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- Do *not* attempt to short-cut in the case of an empty substitution!</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- See Note [Extending the IdSubstEnv]</span><span>
</span><span id="line-250"></span><span class="annot"><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-type">substExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-251"></span><span>   </span><span class="hs-comment">-- HasDebugCallStack so we can track failures in lookupIdSubst</span><span>
</span><span id="line-252"></span><span id="substExpr"><span class="annot"><span class="annottext">substExpr :: HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var hs-var">substExpr</span></a></span></span><span> </span><span id="local-6989586621682705199"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705200"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705200"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705200"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621682705201"><span class="annot"><span class="annottext">go :: CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682705201"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682705202"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705202"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Id -&gt; CoreExpr
Subst -&gt; Id -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705202"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682705203"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705203"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705203"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>    </span><span class="annot"><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682705204"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682705204"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682705204"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682705206"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682705206"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; CoreExpr
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682705206"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="annot"><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682705208"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705208"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621682705209"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705209"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705208"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705209"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682705211"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682705211"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621682705212"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705212"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CoreTickish -&gt; CoreTickish
</span><a href="GHC.Core.Subst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682705211"><span class="hs-identifier hs-var">tickish</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705212"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682705215"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705215"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682705216"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682705216"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Coercion -&gt; CoreExpr
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705215"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682705216"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>       </span><span class="hs-comment">-- Do not optimise even identity coercions</span><span>
</span><span id="line-263"></span><span>       </span><span class="hs-comment">-- Reason: substitution applies to the LHS of RULES, and</span><span>
</span><span id="line-264"></span><span>       </span><span class="hs-comment">--         if you &quot;optimise&quot; an identity coercion, you may</span><span>
</span><span id="line-265"></span><span>       </span><span class="hs-comment">--         lose a binder. We optimise the LHS of rules at</span><span>
</span><span id="line-266"></span><span>       </span><span class="hs-comment">--         construction time</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682705218"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705218"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682705219"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705219"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705220"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705221"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705219"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>                       </span><span class="hs-keyword">where</span><span>
</span><span id="line-270"></span><span>                         </span><span class="hs-special">(</span><span id="local-6989586621682705221"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705221"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705220"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705220"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705218"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682705223"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621682705223"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621682705224"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705224"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bind Id -&gt; CoreExpr -&gt; CoreExpr
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621682705225"><span class="hs-identifier hs-var">bind'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705226"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705224"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>                       </span><span class="hs-keyword">where</span><span>
</span><span id="line-274"></span><span>                         </span><span class="hs-special">(</span><span id="local-6989586621682705226"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705226"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705225"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621682705225"><span class="hs-identifier hs-var">bind'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Bind Id -&gt; (Subst, Bind Id)
Subst -&gt; Bind Id -&gt; (Subst, Bind Id)
</span><a href="GHC.Core.Subst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621682705223"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682705228"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705228"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682705229"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705229"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682705230"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705230"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682705231"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682705231"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; Type -&gt; [Alt Id] -&gt; CoreExpr
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621682705201"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705228"><span class="hs-identifier hs-var">scrut</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705232"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705230"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Alt Id -&gt; Alt Id) -&gt; [Alt Id] -&gt; [Alt Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Alt Id -&gt; Alt Id
</span><a href="#local-6989586621682705233"><span class="hs-identifier hs-var">go_alt</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705234"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682705231"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>                                 </span><span class="hs-keyword">where</span><span>
</span><span id="line-278"></span><span>                                 </span><span class="hs-special">(</span><span id="local-6989586621682705234"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705234"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705232"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705232"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705199"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705229"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>    </span><span id="local-6989586621682705233"><span class="annot"><span class="annottext">go_alt :: Subst -&gt; Alt Id -&gt; Alt Id
</span><a href="#local-6989586621682705233"><span class="hs-identifier hs-var hs-var">go_alt</span></a></span></span><span> </span><span id="local-6989586621682705237"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705237"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682705239"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682705239"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682705240"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705240"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682705241"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705241"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; CoreExpr -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682705239"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705242"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705243"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705241"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>                                 </span><span class="hs-keyword">where</span><span>
</span><span id="line-282"></span><span>                                   </span><span class="hs-special">(</span><span id="local-6989586621682705243"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705243"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705242"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705242"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; (Subst, [Id])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705237"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705240"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="hs-comment">-- | Apply a substitution to an entire 'CoreBind', additionally returning an updated 'Subst'</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- that should be used by subsequent substitutions.</span><span>
</span><span id="line-286"></span><span class="annot"><a href="GHC.Core.Subst.html#substBind"><span class="hs-identifier hs-type">substBind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substBindSC"><span class="hs-identifier hs-type">substBindSC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span id="substBindSC"><span class="annot"><span class="annottext">substBindSC :: HasDebugCallStack =&gt; Subst -&gt; Bind Id -&gt; (Subst, Bind Id)
</span><a href="GHC.Core.Subst.html#substBindSC"><span class="hs-identifier hs-var hs-var">substBindSC</span></a></span></span><span> </span><span id="local-6989586621682705249"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705249"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705250"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621682705250"><span class="hs-identifier hs-var">bind</span></a></span></span><span>    </span><span class="hs-comment">-- Short-cut if the substitution is empty</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Bool
</span><a href="GHC.Core.TyCo.Subst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705249"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Bind Id -&gt; (Subst, Bind Id)
Subst -&gt; Bind Id -&gt; (Subst, Bind Id)
</span><a href="GHC.Core.Subst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705249"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621682705250"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621682705250"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-293"></span><span>       </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682705252"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705252"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682705253"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705253"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705254"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; Bind Id
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705255"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705253"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-295"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621682705254"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705254"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705255"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705255"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705249"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705252"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-296"></span><span>       </span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682705257"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705257"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705258"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; Bind Id
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705259"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [CoreExpr] -&gt; [(Id, CoreExpr)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705260"><span class="hs-identifier hs-var">rhss'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-298"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621682705261"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705261"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705262"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705262"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; ([Id], [CoreExpr])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705257"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-299"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621682705258"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705258"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705259"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705259"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; (Subst, [Id])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705249"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705261"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-300"></span><span>            </span><span id="local-6989586621682705260"><span class="annot"><span class="annottext">rhss' :: [CoreExpr]
</span><a href="#local-6989586621682705260"><span class="hs-identifier hs-var hs-var">rhss'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Bool
</span><a href="GHC.Core.TyCo.Subst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705258"><span class="hs-identifier hs-var">subst'</span></a></span><span>
</span><span id="line-301"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705262"><span class="hs-identifier hs-var">rhss</span></a></span><span>
</span><span id="line-302"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-303"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705258"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705262"><span class="hs-identifier hs-var">rhss</span></a></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span id="substBind"><span class="annot"><span class="annottext">substBind :: HasDebugCallStack =&gt; Subst -&gt; Bind Id -&gt; (Subst, Bind Id)
</span><a href="GHC.Core.Subst.html#substBind"><span class="hs-identifier hs-var hs-var">substBind</span></a></span></span><span> </span><span id="local-6989586621682705268"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705268"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682705269"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705269"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682705270"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705270"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705271"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; Bind Id
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705272"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705268"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705270"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682705271"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705271"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705272"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705272"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705268"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705269"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span class="annot"><a href="GHC.Core.Subst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a></span><span> </span><span id="local-6989586621682705273"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705273"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682705274"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705274"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705275"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; Bind Id
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705276"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [CoreExpr] -&gt; [(Id, CoreExpr)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705277"><span class="hs-identifier hs-var">rhss'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-313"></span><span>       </span><span class="hs-special">(</span><span id="local-6989586621682705278"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705278"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705279"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705279"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; ([Id], [CoreExpr])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621682705274"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-314"></span><span>       </span><span class="hs-special">(</span><span id="local-6989586621682705275"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705275"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705276"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705276"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; (Subst, [Id])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705273"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705278"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-315"></span><span>       </span><span id="local-6989586621682705277"><span class="annot"><span class="annottext">rhss' :: [CoreExpr]
</span><a href="#local-6989586621682705277"><span class="hs-identifier hs-var hs-var">rhss'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705275"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705279"><span class="hs-identifier hs-var">rhss</span></a></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span class="hs-comment">-- | De-shadowing the program is sometimes a useful pre-pass. It can be done simply</span><span>
</span><span id="line-318"></span><span class="hs-comment">-- by running over the bindings with an empty substitution, because substitution</span><span>
</span><span id="line-319"></span><span class="hs-comment">-- returns a result that has no-shadowing guaranteed.</span><span>
</span><span id="line-320"></span><span class="hs-comment">--</span><span>
</span><span id="line-321"></span><span class="hs-comment">-- (Actually, within a single /type/ there might still be shadowing, because</span><span>
</span><span id="line-322"></span><span class="hs-comment">-- 'substTy' is a no-op for the empty substitution, but that's probably OK.)</span><span>
</span><span id="line-323"></span><span class="hs-comment">--</span><span>
</span><span id="line-324"></span><span class="hs-comment">-- [Aug 09] This function is not used in GHC at the moment, but seems so</span><span>
</span><span id="line-325"></span><span class="hs-comment">--          short and simple that I'm going to leave it here</span><span>
</span><span id="line-326"></span><span class="annot"><a href="GHC.Core.Subst.html#deShadowBinds"><span class="hs-identifier hs-type">deShadowBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>
</span><span id="line-327"></span><span id="deShadowBinds"><span class="annot"><span class="annottext">deShadowBinds :: CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Subst.html#deShadowBinds"><span class="hs-identifier hs-var hs-var">deShadowBinds</span></a></span></span><span> </span><span id="local-6989586621682705280"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682705280"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Subst, CoreProgram) -&gt; CoreProgram
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Subst -&gt; Bind Id -&gt; (Subst, Bind Id))
-&gt; Subst -&gt; CoreProgram -&gt; (Subst, CoreProgram)
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Bind Id -&gt; (Subst, Bind Id)
Subst -&gt; Bind Id -&gt; (Subst, Bind Id)
</span><a href="GHC.Core.Subst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="GHC.Core.TyCo.Subst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621682705280"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Substituting binders
*                                                                      *
************************************************************************

Remember that substBndr and friends are used when doing expression
substitution only.  Their only business is substitution, so they
preserve all IdInfo (suitably substituted).  For example, we *want* to
preserve occ info in rules.
-}</span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span class="hs-comment">-- | Substitutes a 'Var' for another one according to the 'Subst' given, returning</span><span>
</span><span id="line-343"></span><span class="hs-comment">-- the result and an updated 'Subst' that should be used by subsequent substitutions.</span><span>
</span><span id="line-344"></span><span class="hs-comment">-- 'IdInfo' is preserved by this process, although it is substituted into appropriately.</span><span>
</span><span id="line-345"></span><span class="annot"><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-type">substBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span id="substBndr"><span class="annot"><span class="annottext">substBndr :: Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var hs-var">substBndr</span></a></span></span><span> </span><span id="local-6989586621682705282"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705282"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705283"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705283"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705283"><span class="hs-identifier hs-var">bndr</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Id -&gt; (Subst, Id)
Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.TyCo.Subst.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705282"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705283"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705283"><span class="hs-identifier hs-var">bndr</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Id -&gt; (Subst, Id)
Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.TyCo.Subst.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705282"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705283"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Subst -&gt; Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;var-bndr&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705282"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705282"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705283"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span class="annot"><span class="hs-comment">-- | Applies 'substBndr' to a number of 'Var's, accumulating a new 'Subst' left-to-right</span></span><span>
</span><span id="line-352"></span><span id="local-6989586621682704905"><span class="annot"><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-type">substBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversable</span></span><span> </span><span class="annot"><a href="#local-6989586621682704905"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682704905"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682704905"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-353"></span><span id="substBndrs"><span class="annot"><span class="annottext">substBndrs :: forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-var hs-var">substBndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Id -&gt; (Subst, Id)) -&gt; Subst -&gt; f Id -&gt; (Subst, f Id)
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span>
</span><span id="line-354"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-pragma hs-type">substBndrs</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span class="annot"><span class="hs-comment">-- | Substitute in a mutually recursive group of 'Id's</span></span><span>
</span><span id="line-357"></span><span id="local-6989586621682705288"><span class="annot"><a href="GHC.Core.Subst.html#substRecBndrs"><span class="hs-identifier hs-type">substRecBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversable</span></span><span> </span><span class="annot"><a href="#local-6989586621682705288"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682705288"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682705288"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-358"></span><span id="substRecBndrs"><span class="annot"><span class="annottext">substRecBndrs :: forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substRecBndrs"><span class="hs-identifier hs-var hs-var">substRecBndrs</span></a></span></span><span> </span><span id="local-6989586621682705292"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705292"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705293"><span class="annot"><span class="annottext">f Id
</span><a href="#local-6989586621682705293"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705294"><span class="hs-identifier hs-var">new_subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">f Id
</span><a href="#local-6989586621682705295"><span class="hs-identifier hs-var">new_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>  </span><span class="hs-keyword">where</span><span>         </span><span class="hs-comment">-- Here's the reason we need to pass rec_subst to subst_id</span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682705294"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705294"><span class="hs-identifier hs-var">new_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705295"><span class="annot"><span class="annottext">f Id
</span><a href="#local-6989586621682705295"><span class="hs-identifier hs-var">new_bndrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Id -&gt; (Subst, Id)) -&gt; Subst -&gt; f Id -&gt; (Subst, f Id)
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; Subst -&gt; Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rec-bndr&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705294"><span class="hs-identifier hs-var">new_subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705292"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">f Id
</span><a href="#local-6989586621682705293"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-362"></span><span class="hs-pragma">{-# SPECIALIZE</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substRecBndrs"><span class="hs-pragma hs-type">substRecBndrs</span></a></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-pragma hs-type">Subst</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-pragma hs-type">Id</span></a></span><span class="hs-pragma">]</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-pragma hs-type">Subst</span></a></span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-pragma hs-type">Id</span></a></span><span class="hs-pragma">]</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-363"></span><span class="hs-pragma">{-# SPECIALIZE</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substRecBndrs"><span class="hs-pragma hs-type">substRecBndrs</span></a></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-pragma hs-type">Subst</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><span class="hs-pragma hs-type">Identity</span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-pragma hs-type">Id</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-pragma hs-type">Subst</span></a></span><span class="hs-pragma">,</span><span> </span><span class="annot"><span class="hs-pragma hs-type">Identity</span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-pragma hs-type">Id</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span class="annot"><a href="GHC.Core.Subst.html#substIdBndr"><span class="hs-identifier hs-type">substIdBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-366"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>            </span><span class="annot"><span class="hs-comment">-- ^ Substitution to use for the IdInfo</span></span><span>
</span><span id="line-367"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Substitution and Id to transform</span></span><span>
</span><span id="line-368"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- ^ Transformed pair</span><span>
</span><span id="line-369"></span><span>                                </span><span class="hs-comment">-- NB: unfolding may be zapped</span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span id="substIdBndr"><span class="annot"><span class="annottext">substIdBndr :: SDoc -&gt; Subst -&gt; Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substIdBndr"><span class="hs-identifier hs-var hs-var">substIdBndr</span></a></span></span><span> </span><span id="local-6989586621682705296"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682705296"><span class="hs-identifier hs-var">_doc</span></a></span></span><span> </span><span id="local-6989586621682705297"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705297"><span class="hs-identifier hs-var">rec_subst</span></a></span></span><span> </span><span id="local-6989586621682705298"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621682705298"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621682705299"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705299"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682705300"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705300"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682705301"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705301"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682705302"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705302"><span class="hs-identifier hs-var">cvs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705303"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705303"><span class="hs-identifier hs-var">old_id</span></a></span></span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;substIdBndr&quot; (doc $$ ppr old_id $$ ppr in_scope) $</span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705304"><span class="hs-identifier hs-var">new_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705305"><span class="hs-identifier hs-var">new_env</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705301"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705302"><span class="hs-identifier hs-var">cvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705306"><span class="hs-identifier hs-var">new_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-375"></span><span>    </span><span id="local-6989586621682705307"><span class="annot"><span class="annottext">id1 :: Id
</span><a href="#local-6989586621682705307"><span class="hs-identifier hs-var hs-var">id1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Id -&gt; Id
</span><a href="GHC.Types.Var.Env.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705299"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705303"><span class="hs-identifier hs-var">old_id</span></a></span><span>      </span><span class="hs-comment">-- id1 is cloned if necessary</span><span>
</span><span id="line-376"></span><span>    </span><span id="local-6989586621682705309"><span class="annot"><span class="annottext">id2 :: Id
</span><a href="#local-6989586621682705309"><span class="hs-identifier hs-var hs-var">id2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682705310"><span class="hs-identifier hs-var">no_type_change</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705307"><span class="hs-identifier hs-var">id1</span></a></span><span>
</span><span id="line-377"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Id -&gt; Id
</span><a href="GHC.Types.Var.html#updateIdTypeAndMult"><span class="hs-identifier hs-var">updateIdTypeAndMult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705298"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705307"><span class="hs-identifier hs-var">id1</span></a></span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span>    </span><span id="local-6989586621682705312"><span class="annot"><span class="annottext">old_ty :: Type
</span><a href="#local-6989586621682705312"><span class="hs-identifier hs-var hs-var">old_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705303"><span class="hs-identifier hs-var">old_id</span></a></span><span>
</span><span id="line-380"></span><span>    </span><span id="local-6989586621682705314"><span class="annot"><span class="annottext">old_w :: Type
</span><a href="#local-6989586621682705314"><span class="hs-identifier hs-var hs-var">old_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-var">idMult</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705303"><span class="hs-identifier hs-var">old_id</span></a></span><span>
</span><span id="line-381"></span><span>    </span><span id="local-6989586621682705310"><span class="annot"><span class="annottext">no_type_change :: Bool
</span><a href="#local-6989586621682705310"><span class="hs-identifier hs-var hs-var">no_type_change</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705301"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705302"><span class="hs-identifier hs-var">cvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-382"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.TyCo.FVs.html#noFreeVarsOfType"><span class="hs-identifier hs-var">noFreeVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705312"><span class="hs-identifier hs-var">old_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.TyCo.FVs.html#noFreeVarsOfType"><span class="hs-identifier hs-var">noFreeVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705314"><span class="hs-identifier hs-var">old_w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-comment">-- new_id has the right IdInfo</span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-comment">-- The lazy-set is because we're in a loop here, with</span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-comment">-- rec_subst, when dealing with a mutually-recursive group</span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682705306"><span class="annot"><span class="annottext">new_id :: Id
</span><a href="#local-6989586621682705306"><span class="hs-identifier hs-var hs-var">new_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe IdInfo -&gt; Id -&gt; Id
</span><a href="GHC.Types.Id.html#maybeModifyIdInfo"><span class="hs-identifier hs-var">maybeModifyIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe IdInfo
</span><a href="#local-6989586621682705320"><span class="hs-identifier hs-var">mb_new_info</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705309"><span class="hs-identifier hs-var">id2</span></a></span><span>
</span><span id="line-388"></span><span>    </span><span id="local-6989586621682705320"><span class="annot"><span class="annottext">mb_new_info :: Maybe IdInfo
</span><a href="#local-6989586621682705320"><span class="hs-identifier hs-var hs-var">mb_new_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; IdInfo -&gt; Maybe IdInfo
</span><a href="GHC.Core.Subst.html#substIdInfo"><span class="hs-identifier hs-var">substIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705297"><span class="hs-identifier hs-var">rec_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705309"><span class="hs-identifier hs-var">id2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Id -&gt; IdInfo
Id -&gt; IdInfo
</span><a href="GHC.Types.Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705309"><span class="hs-identifier hs-var">id2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>        </span><span class="hs-comment">-- NB: unfolding info may be zapped</span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-comment">-- Extend the substitution if the unique has changed</span><span>
</span><span id="line-392"></span><span>        </span><span class="hs-comment">-- See the notes with substTyVarBndr for the delVarEnv</span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682705304"><span class="annot"><span class="annottext">new_in_scope :: InScopeSet
</span><a href="#local-6989586621682705304"><span class="hs-identifier hs-var hs-var">new_in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705299"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Id -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`InScopeSet.extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705306"><span class="hs-identifier hs-var">new_id</span></a></span><span>
</span><span id="line-394"></span><span>        </span><span class="hs-comment">-- Forcing new_in_scope improves T9675 by 1.7%</span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682705305"><span class="annot"><span class="annottext">new_env :: IdSubstEnv
</span><a href="#local-6989586621682705305"><span class="hs-identifier hs-var hs-var">new_env</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682705323"><span class="hs-identifier hs-var">no_change</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Id -&gt; IdSubstEnv
forall a. VarEnv a -&gt; Id -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705300"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705303"><span class="hs-identifier hs-var">old_id</span></a></span><span>
</span><span id="line-396"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Id -&gt; CoreExpr -&gt; IdSubstEnv
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705300"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705303"><span class="hs-identifier hs-var">old_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705306"><span class="hs-identifier hs-var">new_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span>    </span><span id="local-6989586621682705323"><span class="annot"><span class="annottext">no_change :: Bool
</span><a href="#local-6989586621682705323"><span class="hs-identifier hs-var hs-var">no_change</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705307"><span class="hs-identifier hs-var">id1</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705303"><span class="hs-identifier hs-var">old_id</span></a></span><span>
</span><span id="line-399"></span><span>        </span><span class="hs-comment">-- See Note [Extending the IdSubstEnv]</span><span>
</span><span id="line-400"></span><span>        </span><span class="hs-comment">-- it's /not/ necessary to check mb_new_info and no_type_change</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-comment">{-
Now a variant that unconditionally allocates a new unique.
It also unconditionally zaps the OccInfo.
-}</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span class="hs-comment">-- | Very similar to 'substBndr', but it always allocates a new 'Unique' for</span><span>
</span><span id="line-408"></span><span class="hs-comment">-- each variable in its output.  It substitutes the IdInfo though.</span><span>
</span><span id="line-409"></span><span class="hs-comment">-- Discards non-Stable unfoldings</span><span>
</span><span id="line-410"></span><span class="annot"><a href="GHC.Core.Subst.html#cloneIdBndr"><span class="hs-identifier hs-type">cloneIdBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span id="cloneIdBndr"><span class="annot"><span class="annottext">cloneIdBndr :: Subst -&gt; UniqSupply -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#cloneIdBndr"><span class="hs-identifier hs-var hs-var">cloneIdBndr</span></a></span></span><span> </span><span id="local-6989586621682705324"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705324"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705325"><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621682705325"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span id="local-6989586621682705326"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705326"><span class="hs-identifier hs-var">old_id</span></a></span></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Subst -&gt; (Id, Unique) -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705324"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705324"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705326"><span class="hs-identifier hs-var">old_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UniqSupply -&gt; Unique
</span><a href="GHC.Types.Unique.Supply.html#uniqFromSupply"><span class="hs-identifier hs-var">uniqFromSupply</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621682705325"><span class="hs-identifier hs-var">us</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span class="hs-comment">-- | Applies 'cloneIdBndr' to a number of 'Id's, accumulating a final</span><span>
</span><span id="line-415"></span><span class="hs-comment">-- substitution from left to right</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- Discards non-Stable unfoldings</span><span>
</span><span id="line-417"></span><span class="annot"><a href="GHC.Core.Subst.html#cloneIdBndrs"><span class="hs-identifier hs-type">cloneIdBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span id="cloneIdBndrs"><span class="annot"><span class="annottext">cloneIdBndrs :: Subst -&gt; UniqSupply -&gt; [Id] -&gt; (Subst, [Id])
</span><a href="GHC.Core.Subst.html#cloneIdBndrs"><span class="hs-identifier hs-var hs-var">cloneIdBndrs</span></a></span></span><span> </span><span id="local-6989586621682705329"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705329"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705330"><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621682705330"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span id="local-6989586621682705331"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705331"><span class="hs-identifier hs-var">ids</span></a></span></span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; (Id, Unique) -&gt; (Subst, Id))
-&gt; Subst -&gt; [(Id, Unique)] -&gt; (Subst, [Id])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Subst -&gt; (Id, Unique) -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705329"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705329"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705331"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Unique] -&gt; [(Id, Unique)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">UniqSupply -&gt; [Unique]
</span><a href="GHC.Types.Unique.Supply.html#uniqsFromSupply"><span class="hs-identifier hs-var">uniqsFromSupply</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621682705330"><span class="hs-identifier hs-var">us</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span id="local-6989586621682704926"><span class="annot"><a href="GHC.Core.Subst.html#cloneBndrs"><span class="hs-identifier hs-type">cloneBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#MonadUnique"><span class="hs-identifier hs-type">MonadUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682704926"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682704926"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-422"></span><span class="hs-comment">-- Works for all kinds of variables (typically case binders)</span><span>
</span><span id="line-423"></span><span class="hs-comment">-- not just Ids</span><span>
</span><span id="line-424"></span><span id="cloneBndrs"><span class="annot"><span class="annottext">cloneBndrs :: forall (m :: * -&gt; *).
MonadUnique m =&gt;
Subst -&gt; [Id] -&gt; m (Subst, [Id])
</span><a href="GHC.Core.Subst.html#cloneBndrs"><span class="hs-identifier hs-var hs-var">cloneBndrs</span></a></span></span><span> </span><span id="local-6989586621682705342"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705342"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705343"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705343"><span class="hs-identifier hs-var">vs</span></a></span></span><span>
</span><span id="line-425"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621682705344"><span class="annot"><a href="#local-6989586621682705344"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [Unique]
forall (m :: * -&gt; *). MonadUnique m =&gt; m [Unique]
</span><a href="GHC.Types.Unique.Supply.html#getUniquesM"><span class="hs-identifier hs-var">getUniquesM</span></a></span><span>
</span><span id="line-426"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapAccumL</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682705346"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705346"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682705347"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705347"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705348"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682705348"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Unique -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#cloneBndr"><span class="hs-identifier hs-var">cloneBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705346"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682705348"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705347"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682705342"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682705343"><span class="hs-identifier hs-type">vs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`zip`</span></span><span> </span><span class="annot"><a href="#local-6989586621682705344"><span class="hs-identifier hs-type">us</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span class="annot"><a href="GHC.Core.Subst.html#cloneBndr"><span class="hs-identifier hs-type">cloneBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span id="cloneBndr"><span class="annot"><span class="annottext">cloneBndr :: Subst -&gt; Unique -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#cloneBndr"><span class="hs-identifier hs-var hs-var">cloneBndr</span></a></span></span><span> </span><span id="local-6989586621682705349"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705349"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705350"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682705350"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span id="local-6989586621682705351"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705351"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705351"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; Unique -&gt; (Subst, Id)
</span><a href="GHC.Core.TyCo.Subst.html#cloneTyVarBndr"><span class="hs-identifier hs-var">cloneTyVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705349"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705351"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682705350"><span class="hs-identifier hs-var">uniq</span></a></span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Subst -&gt; (Id, Unique) -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705349"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705349"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705351"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682705350"><span class="hs-identifier hs-var">uniq</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Works for coercion variables too</span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="annot"><span class="hs-comment">-- | Clone a mutually recursive group of 'Id's</span></span><span>
</span><span id="line-434"></span><span id="local-6989586621682705353"><span class="annot"><a href="GHC.Core.Subst.html#cloneRecIdBndrs"><span class="hs-identifier hs-type">cloneRecIdBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#MonadUnique"><span class="hs-identifier hs-type">MonadUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682705353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682705353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-435"></span><span id="cloneRecIdBndrs"><span class="annot"><span class="annottext">cloneRecIdBndrs :: forall (m :: * -&gt; *).
MonadUnique m =&gt;
Subst -&gt; [Id] -&gt; m (Subst, [Id])
</span><a href="GHC.Core.Subst.html#cloneRecIdBndrs"><span class="hs-identifier hs-var hs-var">cloneRecIdBndrs</span></a></span></span><span> </span><span id="local-6989586621682705361"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705361"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705362"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705362"><span class="hs-identifier hs-var">ids</span></a></span></span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621682705363"><span class="annot"><a href="#local-6989586621682705363"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [Unique]
forall (m :: * -&gt; *). MonadUnique m =&gt; m [Unique]
</span><a href="GHC.Types.Unique.Supply.html#getUniquesM"><span class="hs-identifier hs-var">getUniquesM</span></a></span><span>
</span><span id="line-437"></span><span>       </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682705364"><span class="annot"><a href="#local-6989586621682705364"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705365"><span class="annot"><a href="#local-6989586621682705365"><span class="hs-identifier hs-var">ids'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapAccumL</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Subst.html#clone_id"><span class="hs-identifier hs-type">clone_id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682705364"><span class="hs-identifier hs-type">subst'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682705361"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682705362"><span class="hs-identifier hs-type">ids</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`zip`</span></span><span> </span><span class="annot"><a href="#local-6989586621682705363"><span class="hs-identifier hs-type">us</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682705364"><span class="hs-identifier hs-type">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682705365"><span class="hs-identifier hs-type">ids'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span class="hs-comment">-- Just like substIdBndr, except that it always makes a new unique</span><span>
</span><span id="line-441"></span><span class="hs-comment">-- It is given the unique to use</span><span>
</span><span id="line-442"></span><span class="hs-comment">-- Discards non-Stable unfoldings</span><span>
</span><span id="line-443"></span><span class="annot"><a href="GHC.Core.Subst.html#clone_id"><span class="hs-identifier hs-type">clone_id</span></a></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>                    </span><span class="hs-comment">-- Substitution for the IdInfo</span><span>
</span><span id="line-444"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Substitution and Id to transform</span><span>
</span><span id="line-445"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- Transformed pair</span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span id="clone_id"><span class="annot"><span class="annottext">clone_id :: Subst -&gt; Subst -&gt; (Id, Unique) -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#clone_id"><span class="hs-identifier hs-var hs-var">clone_id</span></a></span></span><span> </span><span id="local-6989586621682705366"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705366"><span class="hs-identifier hs-var">rec_subst</span></a></span></span><span> </span><span id="local-6989586621682705367"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621682705367"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621682705368"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705368"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682705369"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705369"><span class="hs-identifier hs-var">idvs</span></a></span></span><span> </span><span id="local-6989586621682705370"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705370"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621682705371"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705371"><span class="hs-identifier hs-var">cvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682705372"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705372"><span class="hs-identifier hs-var">old_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705373"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682705373"><span class="hs-identifier hs-var">uniq</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705374"><span class="hs-identifier hs-var">new_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705375"><span class="hs-identifier hs-var">new_idvs</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705370"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705376"><span class="hs-identifier hs-var">new_cvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705377"><span class="hs-identifier hs-var">new_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-450"></span><span>    </span><span id="local-6989586621682705378"><span class="annot"><span class="annottext">id1 :: Id
</span><a href="#local-6989586621682705378"><span class="hs-identifier hs-var hs-var">id1</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Id
</span><a href="GHC.Types.Var.html#setVarUnique"><span class="hs-identifier hs-var">setVarUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705372"><span class="hs-identifier hs-var">old_id</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682705373"><span class="hs-identifier hs-var">uniq</span></a></span><span>
</span><span id="line-451"></span><span>    </span><span id="local-6989586621682705380"><span class="annot"><span class="annottext">id2 :: Id
</span><a href="#local-6989586621682705380"><span class="hs-identifier hs-var hs-var">id2</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; Id
</span><a href="GHC.Core.Subst.html#substIdType"><span class="hs-identifier hs-var">substIdType</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705367"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705378"><span class="hs-identifier hs-var">id1</span></a></span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682705377"><span class="annot"><span class="annottext">new_id :: Id
</span><a href="#local-6989586621682705377"><span class="hs-identifier hs-var hs-var">new_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe IdInfo -&gt; Id -&gt; Id
</span><a href="GHC.Types.Id.html#maybeModifyIdInfo"><span class="hs-identifier hs-var">maybeModifyIdInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; IdInfo -&gt; Maybe IdInfo
</span><a href="GHC.Core.Subst.html#substIdInfo"><span class="hs-identifier hs-var">substIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705366"><span class="hs-identifier hs-var">rec_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705380"><span class="hs-identifier hs-var">id2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Id -&gt; IdInfo
Id -&gt; IdInfo
</span><a href="GHC.Types.Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705372"><span class="hs-identifier hs-var">old_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705380"><span class="hs-identifier hs-var">id2</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682705374"><span class="annot"><span class="annottext">new_in_scope :: InScopeSet
</span><a href="#local-6989586621682705374"><span class="hs-identifier hs-var hs-var">new_in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682705368"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Id -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`InScopeSet.extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705377"><span class="hs-identifier hs-var">new_id</span></a></span><span>
</span><span id="line-454"></span><span>        </span><span class="hs-comment">-- Forcing new_in_scope improves T9675 by 1.7%</span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621682705375"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705375"><span class="hs-identifier hs-var">new_idvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682705376"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705376"><span class="hs-identifier hs-var">new_cvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705372"><span class="hs-identifier hs-var">old_id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705369"><span class="hs-identifier hs-var">idvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Id -&gt; Coercion -&gt; CvSubstEnv
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705371"><span class="hs-identifier hs-var">cvs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705372"><span class="hs-identifier hs-var">old_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705377"><span class="hs-identifier hs-var">new_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Id -&gt; CoreExpr -&gt; IdSubstEnv
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621682705369"><span class="hs-identifier hs-var">idvs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705372"><span class="hs-identifier hs-var">old_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705377"><span class="hs-identifier hs-var">new_id</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705371"><span class="hs-identifier hs-var">cvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Types and Coercions
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\section{IdInfo substitution}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span class="annot"><a href="GHC.Core.Subst.html#substIdType"><span class="hs-identifier hs-type">substIdType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-475"></span><span id="substIdType"><span class="annot"><span class="annottext">substIdType :: Subst -&gt; Id -&gt; Id
</span><a href="GHC.Core.Subst.html#substIdType"><span class="hs-identifier hs-var hs-var">substIdType</span></a></span></span><span> </span><span id="local-6989586621682705381"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621682705381"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682705382"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705382"><span class="hs-identifier hs-var">tv_env</span></a></span></span><span> </span><span id="local-6989586621682705383"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705383"><span class="hs-identifier hs-var">cv_env</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705384"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705384"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-476"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705382"><span class="hs-identifier hs-var">tv_env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705383"><span class="hs-identifier hs-var">cv_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.TyCo.FVs.html#noFreeVarsOfType"><span class="hs-identifier hs-var">noFreeVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705385"><span class="hs-identifier hs-var">old_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.TyCo.FVs.html#noFreeVarsOfType"><span class="hs-identifier hs-var">noFreeVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705386"><span class="hs-identifier hs-var">old_w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705384"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-478"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span>
</span><span id="line-479"></span><span>      </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Id -&gt; Id
</span><a href="GHC.Types.Var.html#updateIdTypeAndMult"><span class="hs-identifier hs-var">updateIdTypeAndMult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705381"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705384"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-comment">-- The tyCoVarsOfType is cheaper than it looks</span><span>
</span><span id="line-481"></span><span>        </span><span class="hs-comment">-- because we cache the free tyvars of the type</span><span>
</span><span id="line-482"></span><span>        </span><span class="hs-comment">-- in a Note in the id's type itself</span><span>
</span><span id="line-483"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-484"></span><span>    </span><span id="local-6989586621682705385"><span class="annot"><span class="annottext">old_ty :: Type
</span><a href="#local-6989586621682705385"><span class="hs-identifier hs-var hs-var">old_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705384"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-485"></span><span>    </span><span id="local-6989586621682705386"><span class="annot"><span class="annottext">old_w :: Type
</span><a href="#local-6989586621682705386"><span class="hs-identifier hs-var hs-var">old_w</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Var.html#varMult"><span class="hs-identifier hs-var">varMult</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705384"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-488"></span><span class="hs-comment">-- | Substitute into some 'IdInfo' with regard to the supplied new 'Id'.</span><span>
</span><span id="line-489"></span><span class="hs-comment">-- Discards unfoldings, unless they are Stable</span><span>
</span><span id="line-490"></span><span class="annot"><a href="GHC.Core.Subst.html#substIdInfo"><span class="hs-identifier hs-type">substIdInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a></span><span>
</span><span id="line-491"></span><span id="substIdInfo"><span class="annot"><span class="annottext">substIdInfo :: Subst -&gt; Id -&gt; IdInfo -&gt; Maybe IdInfo
</span><a href="GHC.Core.Subst.html#substIdInfo"><span class="hs-identifier hs-var hs-var">substIdInfo</span></a></span></span><span> </span><span id="local-6989586621682705388"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705388"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705389"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705389"><span class="hs-identifier hs-var">new_id</span></a></span></span><span> </span><span id="local-6989586621682705390"><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682705390"><span class="hs-identifier hs-var">info</span></a></span></span><span>
</span><span id="line-492"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682705391"><span class="hs-identifier hs-var">nothing_to_do</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe IdInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-493"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Maybe IdInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682705390"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; RuleInfo -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setRuleInfo"><span class="hs-operator hs-var">`setRuleInfo`</span></a></span><span>      </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; RuleInfo -&gt; RuleInfo
</span><a href="GHC.Core.Subst.html#substRuleInfo"><span class="hs-identifier hs-var">substRuleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705388"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705389"><span class="hs-identifier hs-var">new_id</span></a></span><span> </span><span class="annot"><span class="annottext">RuleInfo
</span><a href="#local-6989586621682705393"><span class="hs-identifier hs-var">old_rules</span></a></span><span>
</span><span id="line-494"></span><span>                               </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setUnfoldingInfo"><span class="hs-operator hs-var">`setUnfoldingInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Unfolding -&gt; Unfolding
</span><a href="GHC.Core.Subst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705388"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682705395"><span class="hs-identifier hs-var">old_unf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-496"></span><span>    </span><span id="local-6989586621682705393"><span class="annot"><span class="annottext">old_rules :: RuleInfo
</span><a href="#local-6989586621682705393"><span class="hs-identifier hs-var hs-var">old_rules</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; RuleInfo
</span><a href="GHC.Types.Id.Info.html#ruleInfo"><span class="hs-identifier hs-var">ruleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682705390"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-497"></span><span>    </span><span id="local-6989586621682705395"><span class="annot"><span class="annottext">old_unf :: Unfolding
</span><a href="#local-6989586621682705395"><span class="hs-identifier hs-var hs-var">old_unf</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding
</span><a href="GHC.Types.Id.Info.html#realUnfoldingInfo"><span class="hs-identifier hs-var">realUnfoldingInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621682705390"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-498"></span><span>    </span><span id="local-6989586621682705391"><span class="annot"><span class="annottext">nothing_to_do :: Bool
</span><a href="#local-6989586621682705391"><span class="hs-identifier hs-var hs-var">nothing_to_do</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleInfo -&gt; Bool
</span><a href="GHC.Types.Id.Info.html#isEmptyRuleInfo"><span class="hs-identifier hs-var">isEmptyRuleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RuleInfo
</span><a href="#local-6989586621682705393"><span class="hs-identifier hs-var">old_rules</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#hasCoreUnfolding"><span class="hs-identifier hs-var">hasCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682705395"><span class="hs-identifier hs-var">old_unf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-501"></span><span class="hs-comment">-- | Substitutes for the 'Id's within an unfolding</span><span>
</span><span id="line-502"></span><span class="hs-comment">-- NB: substUnfolding /discards/ any unfolding without</span><span>
</span><span id="line-503"></span><span class="hs-comment">--     without a Stable source.  This is usually what we want,</span><span>
</span><span id="line-504"></span><span class="hs-comment">--     but it may be a bit unexpected</span><span>
</span><span id="line-505"></span><span class="annot"><a href="GHC.Core.Subst.html#substUnfolding"><span class="hs-identifier hs-type">substUnfolding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substUnfoldingSC"><span class="hs-identifier hs-type">substUnfoldingSC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-506"></span><span>        </span><span class="hs-comment">-- Seq'ing on the returned Unfolding is enough to cause</span><span>
</span><span id="line-507"></span><span>        </span><span class="hs-comment">-- all the substitutions to happen completely</span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span id="substUnfoldingSC"><span class="annot"><span class="annottext">substUnfoldingSC :: Subst -&gt; Unfolding -&gt; Unfolding
</span><a href="GHC.Core.Subst.html#substUnfoldingSC"><span class="hs-identifier hs-var hs-var">substUnfoldingSC</span></a></span></span><span> </span><span id="local-6989586621682705400"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705400"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705401"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682705401"><span class="hs-identifier hs-var">unf</span></a></span></span><span>       </span><span class="hs-comment">-- Short-cut version</span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Bool
</span><a href="GHC.Core.TyCo.Subst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705400"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682705401"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-511"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Unfolding -&gt; Unfolding
</span><a href="GHC.Core.Subst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705400"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682705401"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span id="substUnfolding"><span class="annot"><span class="annottext">substUnfolding :: Subst -&gt; Unfolding -&gt; Unfolding
</span><a href="GHC.Core.Subst.html#substUnfolding"><span class="hs-identifier hs-var hs-var">substUnfolding</span></a></span></span><span> </span><span id="local-6989586621682705402"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705402"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705403"><span class="annot"><span class="annottext">df :: Unfolding
</span><a href="#local-6989586621682705403"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DFunUnfolding"><span class="hs-identifier hs-type">DFunUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">df_bndrs :: Unfolding -&gt; [Id]
</span><a href="GHC.Core.html#df_bndrs"><span class="hs-identifier hs-var">df_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682705406"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705406"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">df_args :: Unfolding -&gt; [CoreExpr]
</span><a href="GHC.Core.html#df_args"><span class="hs-identifier hs-var">df_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682705408"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705408"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682705403"><span class="hs-identifier hs-var">df</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#df_bndrs"><span class="hs-identifier hs-var">df_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682705409"><span class="hs-identifier hs-type">bndrs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#df_args"><span class="hs-identifier hs-var">df_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682705410"><span class="hs-identifier hs-type">args'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-516"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682705411"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705411"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682705409"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705409"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; (Subst, [Id])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705402"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705406"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-517"></span><span>    </span><span id="local-6989586621682705410"><span class="annot"><span class="annottext">args' :: [CoreExpr]
</span><a href="#local-6989586621682705410"><span class="hs-identifier hs-var hs-var">args'</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; [CoreExpr] -&gt; [CoreExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705411"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705408"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span class="annot"><a href="GHC.Core.Subst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a></span><span> </span><span id="local-6989586621682705412"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705412"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705413"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682705413"><span class="hs-identifier hs-var">unf</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: Unfolding -&gt; CoreExpr
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682705416"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705416"><span class="hs-identifier hs-var">tmpl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_src :: Unfolding -&gt; UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682705418"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682705418"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>  </span><span class="hs-comment">-- Retain stable unfoldings</span><span>
</span><span id="line-521"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621682705418"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Zap an unstable unfolding, to save substitution work</span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a></span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                 </span><span class="hs-comment">-- But keep a stable one!</span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ()
</span><a href="GHC.Core.Seq.html#seqExpr"><span class="hs-identifier hs-var">seqExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705422"><span class="hs-identifier hs-var">new_tmpl</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; Unfolding -&gt; Unfolding
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span>
</span><span id="line-525"></span><span>    </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682705413"><span class="hs-identifier hs-var">unf</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682705422"><span class="hs-identifier hs-type">new_tmpl</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-526"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-527"></span><span>    </span><span id="local-6989586621682705422"><span class="annot"><span class="annottext">new_tmpl :: CoreExpr
</span><a href="#local-6989586621682705422"><span class="hs-identifier hs-var hs-var">new_tmpl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705412"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705416"><span class="hs-identifier hs-var">tmpl</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span class="annot"><a href="GHC.Core.Subst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682705423"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682705423"><span class="hs-identifier hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682705423"><span class="hs-identifier hs-var">unf</span></a></span><span>      </span><span class="hs-comment">-- NoUnfolding, OtherCon</span><span>
</span><span id="line-530"></span><span>
</span><span id="line-531"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-532"></span><span class="annot"><a href="GHC.Core.Subst.html#substIdOcc"><span class="hs-identifier hs-type">substIdOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-533"></span><span class="hs-comment">-- These Ids should not be substituted to non-Ids</span><span>
</span><span id="line-534"></span><span id="substIdOcc"><span class="annot"><span class="annottext">substIdOcc :: Subst -&gt; Id -&gt; Id
</span><a href="GHC.Core.Subst.html#substIdOcc"><span class="hs-identifier hs-var hs-var">substIdOcc</span></a></span></span><span> </span><span id="local-6989586621682705424"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705424"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705425"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705425"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Id -&gt; CoreExpr
Subst -&gt; Id -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705424"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705425"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-535"></span><span>                        </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682705426"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705426"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705426"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-536"></span><span>                        </span><span id="local-6989586621682705427"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705427"><span class="hs-identifier hs-var">other</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; Id
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;substIdOcc&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705425"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705427"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705424"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-539"></span><span class="annot"><span class="hs-comment">-- | Substitutes for the 'Id's within the 'RuleInfo' given the new function 'Id'</span></span><span>
</span><span id="line-540"></span><span class="annot"><a href="GHC.Core.Subst.html#substRuleInfo"><span class="hs-identifier hs-type">substRuleInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span>
</span><span id="line-541"></span><span id="substRuleInfo"><span class="annot"><span class="annottext">substRuleInfo :: Subst -&gt; Id -&gt; RuleInfo -&gt; RuleInfo
</span><a href="GHC.Core.Subst.html#substRuleInfo"><span class="hs-identifier hs-var hs-var">substRuleInfo</span></a></span></span><span> </span><span id="local-6989586621682705431"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705431"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705432"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705432"><span class="hs-identifier hs-var">new_id</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a></span><span> </span><span id="local-6989586621682705433"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682705433"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span id="local-6989586621682705434"><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682705434"><span class="hs-identifier hs-var">rhs_fvs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; DVarSet -&gt; RuleInfo
</span><a href="GHC.Types.Id.Info.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreRule -&gt; CoreRule) -&gt; [CoreRule] -&gt; [CoreRule]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; (Name -&gt; Name) -&gt; CoreRule -&gt; CoreRule
</span><a href="GHC.Core.Subst.html#substRule"><span class="hs-identifier hs-var">substRule</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705431"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="#local-6989586621682705436"><span class="hs-identifier hs-var">subst_ru_fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682705433"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; DVarSet -&gt; DVarSet
Subst -&gt; DVarSet -&gt; DVarSet
</span><a href="GHC.Core.Subst.html#substDVarSet"><span class="hs-identifier hs-var">substDVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705431"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682705434"><span class="hs-identifier hs-var">rhs_fvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-545"></span><span>    </span><span id="local-6989586621682705436"><span class="annot"><span class="annottext">subst_ru_fn :: Name -&gt; Name
</span><a href="#local-6989586621682705436"><span class="hs-identifier hs-var hs-var">subst_ru_fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705432"><span class="hs-identifier hs-var">new_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-548"></span><span class="annot"><a href="GHC.Core.Subst.html#substRulesForImportedIds"><span class="hs-identifier hs-type">substRulesForImportedIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-549"></span><span id="substRulesForImportedIds"><span class="annot"><span class="annottext">substRulesForImportedIds :: Subst -&gt; [CoreRule] -&gt; [CoreRule]
</span><a href="GHC.Core.Subst.html#substRulesForImportedIds"><span class="hs-identifier hs-var hs-var">substRulesForImportedIds</span></a></span></span><span> </span><span id="local-6989586621682705439"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705439"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705440"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682705440"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-550"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreRule -&gt; CoreRule) -&gt; [CoreRule] -&gt; [CoreRule]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; (Name -&gt; Name) -&gt; CoreRule -&gt; CoreRule
</span><a href="GHC.Core.Subst.html#substRule"><span class="hs-identifier hs-var">substRule</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705439"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
forall {a} {a}. Outputable a =&gt; a -&gt; a
</span><a href="#local-6989586621682705441"><span class="hs-identifier hs-var">not_needed</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682705440"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-551"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-552"></span><span>    </span><span id="local-6989586621682705441"><span class="annot"><span class="annottext">not_needed :: a -&gt; a
</span><a href="#local-6989586621682705441"><span class="hs-identifier hs-var hs-var">not_needed</span></a></span></span><span> </span><span id="local-6989586621682705446"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682705446"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; a
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;substRulesForImportedIds&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682705446"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-555"></span><span class="annot"><a href="GHC.Core.Subst.html#substRule"><span class="hs-identifier hs-type">substRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span>
</span><span id="line-556"></span><span>
</span><span id="line-557"></span><span class="hs-comment">-- The subst_ru_fn argument is applied to substitute the ru_fn field</span><span>
</span><span id="line-558"></span><span class="hs-comment">-- of the rule:</span><span>
</span><span id="line-559"></span><span class="hs-comment">--    - Rules for *imported* Ids never change ru_fn</span><span>
</span><span id="line-560"></span><span class="hs-comment">--    - Rules for *local* Ids are in the IdInfo for that Id,</span><span>
</span><span id="line-561"></span><span class="hs-comment">--      and the ru_fn field is simply replaced by the new name</span><span>
</span><span id="line-562"></span><span class="hs-comment">--      of the Id</span><span>
</span><span id="line-563"></span><span id="substRule"><span class="annot"><span class="annottext">substRule :: Subst -&gt; (Name -&gt; Name) -&gt; CoreRule -&gt; CoreRule
</span><a href="GHC.Core.Subst.html#substRule"><span class="hs-identifier hs-var hs-var">substRule</span></a></span></span><span> </span><span class="annot"><span class="annottext">Subst
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682705447"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621682705447"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682705447"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-564"></span><span class="annot"><a href="GHC.Core.Subst.html#substRule"><span class="hs-identifier hs-var">substRule</span></a></span><span> </span><span id="local-6989586621682705449"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705449"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621682705450"><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="#local-6989586621682705450"><span class="hs-identifier hs-var">subst_ru_fn</span></a></span></span><span> </span><span id="local-6989586621682705451"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621682705451"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [Id]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682705454"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705454"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682705456"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621682705456"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-565"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_fn :: CoreRule -&gt; Name
</span><a href="GHC.Core.html#ru_fn"><span class="hs-identifier hs-var">ru_fn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682705458"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682705458"><span class="hs-identifier hs-var">fn_name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rhs :: CoreRule -&gt; CoreExpr
</span><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682705460"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705460"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-566"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_local :: CoreRule -&gt; Bool
</span><a href="GHC.Core.html#ru_local"><span class="hs-identifier hs-var">ru_local</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682705462"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682705462"><span class="hs-identifier hs-var">is_local</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-567"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682705451"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682705463"><span class="hs-identifier hs-type">bndrs'</span></a></span><span>
</span><span id="line-568"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_fn"><span class="hs-identifier hs-var">ru_fn</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621682705462"><span class="hs-identifier hs-type">is_local</span></a></span><span>
</span><span id="line-569"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="#local-6989586621682705450"><span class="hs-identifier hs-type">subst_ru_fn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682705458"><span class="hs-identifier hs-type">fn_name</span></a></span><span>
</span><span id="line-570"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="#local-6989586621682705458"><span class="hs-identifier hs-type">fn_name</span></a></span><span>
</span><span id="line-571"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-type">substExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682705464"><span class="hs-identifier hs-type">subst'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682705456"><span class="hs-identifier hs-type">args</span></a></span><span>
</span><span id="line-572"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-type">substExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682705464"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682705460"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-573"></span><span>           </span><span class="hs-comment">-- Do NOT optimise the RHS (previously we did simplOptExpr here)</span><span>
</span><span id="line-574"></span><span>           </span><span class="hs-comment">-- See Note [Substitute lazily]</span><span>
</span><span id="line-575"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-576"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682705464"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705464"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682705463"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705463"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; (Subst, [Id])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705449"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682705454"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-577"></span><span>
</span><span id="line-578"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-579"></span><span class="annot"><a href="GHC.Core.Subst.html#substDVarSet"><span class="hs-identifier hs-type">substDVarSet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#DVarSet"><span class="hs-identifier hs-type">DVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#DVarSet"><span class="hs-identifier hs-type">DVarSet</span></a></span><span>
</span><span id="line-580"></span><span id="substDVarSet"><span class="annot"><span class="annottext">substDVarSet :: HasDebugCallStack =&gt; Subst -&gt; DVarSet -&gt; DVarSet
</span><a href="GHC.Core.Subst.html#substDVarSet"><span class="hs-identifier hs-var hs-var">substDVarSet</span></a></span></span><span> </span><span id="local-6989586621682705468"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621682705468"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682705469"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705469"><span class="hs-identifier hs-var">tv_env</span></a></span></span><span> </span><span id="local-6989586621682705470"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705470"><span class="hs-identifier hs-var">cv_env</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682705471"><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682705471"><span class="hs-identifier hs-var">fvs</span></a></span></span><span>
</span><span id="line-581"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; DVarSet
</span><a href="GHC.Types.Var.Set.html#mkDVarSet"><span class="hs-identifier hs-var">mkDVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; DVarSet) -&gt; [Id] -&gt; DVarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Id], VarSet) -&gt; [Id]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(([Id], VarSet) -&gt; [Id]) -&gt; ([Id], VarSet) -&gt; [Id]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; ([Id], VarSet) -&gt; ([Id], VarSet))
-&gt; ([Id], VarSet) -&gt; [Id] -&gt; ([Id], VarSet)
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; ([Id], VarSet) -&gt; ([Id], VarSet)
</span><a href="#local-6989586621682705474"><span class="hs-identifier hs-var">subst_fv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; ([Id], VarSet)) -&gt; [Id] -&gt; ([Id], VarSet)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DVarSet -&gt; [Id]
</span><a href="GHC.Types.Var.Set.html#dVarSetElems"><span class="hs-identifier hs-var">dVarSetElems</span></a></span><span> </span><span class="annot"><span class="annottext">DVarSet
</span><a href="#local-6989586621682705471"><span class="hs-identifier hs-var">fvs</span></a></span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-583"></span><span>  </span><span class="annot"><a href="#local-6989586621682705474"><span class="hs-identifier hs-type">subst_fv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>  </span><span id="local-6989586621682705474"><span class="annot"><span class="annottext">subst_fv :: Id -&gt; ([Id], VarSet) -&gt; ([Id], VarSet)
</span><a href="#local-6989586621682705474"><span class="hs-identifier hs-var hs-var">subst_fv</span></a></span></span><span> </span><span id="local-6989586621682705477"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705477"><span class="hs-identifier hs-var">fv</span></a></span></span><span> </span><span id="local-6989586621682705478"><span class="annot"><span class="annottext">([Id], VarSet)
</span><a href="#local-6989586621682705478"><span class="hs-identifier hs-var">acc</span></a></span></span><span>
</span><span id="line-585"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705477"><span class="hs-identifier hs-var">fv</span></a></span><span>
</span><span id="line-586"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682705479"><span class="annot"><span class="annottext">fv_ty :: Type
</span><a href="#local-6989586621682705479"><span class="hs-identifier hs-var hs-var">fv_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Id -&gt; Maybe Type
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621682705469"><span class="hs-identifier hs-var">tv_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705477"><span class="hs-identifier hs-var">fv</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Type -&gt; Type -&gt; Type
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705477"><span class="hs-identifier hs-var">fv</span></a></span><span>
</span><span id="line-587"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; FV
</span><a href="GHC.Core.TyCo.FVs.html#tyCoFVsOfType"><span class="hs-identifier hs-var">tyCoFVsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621682705479"><span class="hs-identifier hs-var">fv_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Id -&gt; Bool
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(([Id], VarSet) -&gt; ([Id], VarSet))
-&gt; ([Id], VarSet) -&gt; ([Id], VarSet)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">([Id], VarSet)
</span><a href="#local-6989586621682705478"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-588"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705477"><span class="hs-identifier hs-var">fv</span></a></span><span>
</span><span id="line-589"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682705483"><span class="annot"><span class="annottext">fv_co :: Coercion
</span><a href="#local-6989586621682705483"><span class="hs-identifier hs-var hs-var">fv_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Id -&gt; Maybe Coercion
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621682705470"><span class="hs-identifier hs-var">cv_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705477"><span class="hs-identifier hs-var">fv</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Coercion -&gt; Coercion -&gt; Coercion
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705477"><span class="hs-identifier hs-var">fv</span></a></span><span>
</span><span id="line-590"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; FV
</span><a href="GHC.Core.TyCo.FVs.html#tyCoFVsOfCo"><span class="hs-identifier hs-var">tyCoFVsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682705483"><span class="hs-identifier hs-var">fv_co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Id -&gt; Bool
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(([Id], VarSet) -&gt; ([Id], VarSet))
-&gt; ([Id], VarSet) -&gt; ([Id], VarSet)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">([Id], VarSet)
</span><a href="#local-6989586621682705478"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-591"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-592"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682705484"><span class="annot"><span class="annottext">fv_expr :: CoreExpr
</span><a href="#local-6989586621682705484"><span class="hs-identifier hs-var hs-var">fv_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Id -&gt; CoreExpr
Subst -&gt; Id -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705468"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682705477"><span class="hs-identifier hs-var">fv</span></a></span><span>
</span><span id="line-593"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; FV
</span><a href="GHC.Core.FVs.html#exprFVs"><span class="hs-identifier hs-var">exprFVs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682705484"><span class="hs-identifier hs-var">fv_expr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Id -&gt; Bool
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(([Id], VarSet) -&gt; ([Id], VarSet))
-&gt; ([Id], VarSet) -&gt; ([Id], VarSet)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">([Id], VarSet)
</span><a href="#local-6989586621682705478"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-594"></span><span>
</span><span id="line-595"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-596"></span><span class="annot"><span class="hs-comment">-- | Drop free vars from the breakpoint if they have a non-variable substitution.</span></span><span>
</span><span id="line-597"></span><span class="annot"><a href="GHC.Core.Subst.html#substTickish"><span class="hs-identifier hs-type">substTickish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span>
</span><span id="line-598"></span><span id="substTickish"><span class="annot"><span class="annottext">substTickish :: Subst -&gt; CoreTickish -&gt; CoreTickish
</span><a href="GHC.Core.Subst.html#substTickish"><span class="hs-identifier hs-var hs-var">substTickish</span></a></span></span><span> </span><span id="local-6989586621682705486"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705486"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-type">Breakpoint</span></a></span><span> </span><span id="local-6989586621682705488"><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
</span><a href="#local-6989586621682705488"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621682705489"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682705489"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682705490"><span class="annot"><span class="annottext">[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621682705490"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621682705491"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682705491"><span class="hs-identifier hs-var">modl</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
-&gt; Int -&gt; [XTickishId 'TickishPassCore] -&gt; Module -&gt; CoreTickish
forall (pass :: TickishPass).
XBreakpoint pass
-&gt; Int -&gt; [XTickishId pass] -&gt; Module -&gt; GenTickish pass
</span><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a></span><span> </span><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
</span><a href="#local-6989586621682705488"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682705489"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; Maybe Id) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe Id
</span><a href="#local-6989586621682705493"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621682705490"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682705491"><span class="hs-identifier hs-var">modl</span></a></span><span>
</span><span id="line-600"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-601"></span><span>    </span><span id="local-6989586621682705493"><span class="annot"><span class="annottext">do_one :: Id -&gt; Maybe Id
</span><a href="#local-6989586621682705493"><span class="hs-identifier hs-var hs-var">do_one</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Maybe Id
</span><a href="GHC.Core.Utils.html#getIdFromTrivialExpr_maybe"><span class="hs-identifier hs-var">getIdFromTrivialExpr_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; Maybe Id) -&gt; (Id -&gt; CoreExpr) -&gt; Id -&gt; Maybe Id
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Id -&gt; CoreExpr
Subst -&gt; Id -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705486"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span class="annot"><a href="GHC.Core.Subst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a></span><span> </span><span id="local-6989586621682705495"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682705495"><span class="hs-identifier hs-var">_subst</span></a></span></span><span> </span><span id="local-6989586621682705496"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682705496"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682705496"><span class="hs-identifier hs-var">other</span></a></span><span>
</span><span id="line-604"></span><span>
</span><span id="line-605"></span><span class="hs-comment">{- Note [Substitute lazily]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
The functions that substitute over IdInfo must be pretty lazy, because
they are knot-tied by substRecBndrs.

One case in point was #10627 in which a rule for a function 'f'
referred to 'f' (at a different type) on the RHS.  But instead of just
substituting in the rhs of the rule, we were calling simpleOptExpr, which
looked at the idInfo for 'f'; result &lt;&lt;loop&gt;&gt;.

In any case we don't need to optimise the RHS of rules, or unfoldings,
because the simplifier will do that.

Another place this went wrong was in `substRuleInfo`, which would immediately force
the lazy call to substExpr, which led to an infinite loop (as reported by #20112).

This time the call stack looked something like:

* `substRecBndrs`
* `substIdBndr`
* `substIdInfo`
* `substRuleInfo`
* `substRule`
* `substExpr`
* `mkTick`
* `isSaturatedConApp`
* Look at `IdInfo` for thing we are currently substituting because the rule is attached to `transpose` and mentions it in the `RHS` of the rule.

and the rule was

{-# RULES
&quot;transpose/overlays1&quot; forall xs. transpose (overlays1 xs) = overlays1 (fmap transpose xs) #-}

This rule was attached to `transpose`, but also mentions itself in the RHS so we have
to be careful to not force the `IdInfo` for transpose when dealing with the RHS of the rule.



Note [substTickish]
~~~~~~~~~~~~~~~~~~~~~~
A Breakpoint contains a list of Ids.  What happens if we ever want to
substitute an expression for one of these Ids?

First, we ensure that we only ever substitute trivial expressions for
these Ids, by marking them as NoOccInfo in the occurrence analyser.
Then, when substituting for the Id, we unwrap any type applications
and abstractions to get back to an Id, with getIdFromTrivialExpr.

Second, we have to ensure that we never try to substitute a literal
for an Id in a breakpoint.  We ensure this by never storing an Id with
an unlifted type in a Breakpoint - see GHC.HsToCore.Ticks.mkTickish.
Breakpoints can't handle free variables with unlifted types anyway.

These measures are only reliable with unoptimized code.
Since we can now enable optimizations for GHCi with
@-fno-unoptimized-core-for-interpreter -O@, nontrivial expressions can be
substituted, e.g. by specializations.
Therefore we resort to discarding free variables from breakpoints when this
situation occurs.
-}</span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span class="hs-comment">{-
Note [Worker inlining]
~~~~~~~~~~~~~~~~~~~~~~
A worker can get substituted away entirely.
        - it might be trivial
        - it might simply be very small
We do not treat an InlWrapper as an 'occurrence' in the occurrence
analyser, so it's possible that the worker is not even in scope any more.

In all these cases we simply drop the special case, returning to
InlVanilla.  The WARN is just so I can see if it happens a lot.
-}</span><span>
</span><span id="line-678"></span></pre></body></html>