<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-record-updates #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns   #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html"><span class="hs-identifier">GHC.Tc.Validity</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-13"></span><span>  </span><span class="annot"><a href="GHC.Tc.Types.Rank.html#Rank"><span class="hs-identifier">Rank</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier">UserTypeCtxt</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidType"><span class="hs-identifier">checkValidType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidMonoType"><span class="hs-identifier">checkValidMonoType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>  </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidTheta"><span class="hs-identifier">checkValidTheta</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>  </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidInstance"><span class="hs-identifier">checkValidInstance</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidInstHead"><span class="hs-identifier">checkValidInstHead</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#validDerivPred"><span class="hs-identifier">validDerivPred</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="annot"><a href="GHC.Tc.Validity.html#checkTySynRhs"><span class="hs-identifier">checkTySynRhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkEscapingKind"><span class="hs-identifier">checkEscapingKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>  </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidCoAxiom"><span class="hs-identifier">checkValidCoAxiom</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidCoAxBranch"><span class="hs-identifier">checkValidCoAxBranch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><a href="GHC.Tc.Validity.html#checkFamPatBinders"><span class="hs-identifier">checkFamPatBinders</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkTyFamEqnValidityInfo"><span class="hs-identifier">checkTyFamEqnValidityInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>  </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidTyFamEqn"><span class="hs-identifier">checkValidTyFamEqn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidAssocTyFamDeflt"><span class="hs-identifier">checkValidAssocTyFamDeflt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkConsistentFamInst"><span class="hs-identifier">checkConsistentFamInst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><a href="GHC.Tc.Validity.html#checkTyConTelescope"><span class="hs-identifier">checkTyConTelescope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-comment">-- friends:</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html"><span class="hs-identifier">GHC.Tc.Utils.Unify</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypeAmbiguity"><span class="hs-identifier">tcSubTypeAmbiguity</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html"><span class="hs-identifier">GHC.Tc.Solver</span></a></span><span>         </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyAmbiguityCheck"><span class="hs-identifier">simplifyAmbiguityCheck</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html"><span class="hs-identifier">GHC.Tc.Instance.Class</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#matchGlobalInst"><span class="hs-identifier">matchGlobalInst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#ClsInstResult"><span class="hs-identifier">ClsInstResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#AssocInstInfo"><span class="hs-identifier">AssocInstInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html"><span class="hs-identifier">GHC.Tc.Types.Origin</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Rank.html"><span class="hs-identifier">GHC.Tc.Types.Rank</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html"><span class="hs-identifier">GHC.Tc.Errors.Types</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html"><span class="hs-identifier">GHC.Tc.Instance.FunDeps</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Family.html"><span class="hs-identifier">GHC.Tc.Instance.Family</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html"><span class="hs-identifier">GHC.Tc.Zonk.TcType</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Uniques.html"><span class="hs-identifier">GHC.Builtin.Uniques</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Uniques.html#mkAlphaTyVarUnique"><span class="hs-identifier">mkAlphaTyVarUnique</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html"><span class="hs-identifier">GHC.Core.Unify</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#typesAreApart"><span class="hs-identifier">typesAreApart</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyX_BM"><span class="hs-identifier">tcMatchTyX_BM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFlag"><span class="hs-identifier">BindFlag</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html"><span class="hs-identifier">GHC.Core.Coercion.Axiom</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Class.html"><span class="hs-identifier">GHC.Core.Class</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html"><span class="hs-identifier">GHC.Core.TyCo.FVs</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html"><span class="hs-identifier">GHC.Core.TyCo.Ppr</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#isDominatedBy"><span class="hs-identifier">isDominatedBy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#injectiveBranches"><span class="hs-identifier">injectiveBranches</span></a></span><span>
</span><span id="line-56"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#InjectivityCheckResult"><span class="hs-identifier">InjectivityCheckResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Hs.html"><span class="hs-identifier">GHC.Hs</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html"><span class="hs-identifier">GHC.Driver.Session</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC.LanguageExtensions</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LangExt</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Error.html"><span class="hs-identifier">GHC.Types.Error</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TypeOrKind"><span class="hs-identifier">TypeOrKind</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnboxedTupleOrSum"><span class="hs-identifier">UnboxedTupleOrSum</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#unboxedTupleOrSumExtension"><span class="hs-identifier">unboxedTupleOrSumExtension</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#VarBndr"><span class="hs-identifier">VarBndr</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#isInvisibleFunArg"><span class="hs-identifier">isInvisibleFunArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#mkTyVar"><span class="hs-identifier">mkTyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#tyVarName"><span class="hs-identifier">tyVarName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SourceFile.html"><span class="hs-identifier">GHC.Types.SourceFile</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.TyThing.html"><span class="hs-identifier">GHC.Types.TyThing</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.TyThing.html#TyThing"><span class="hs-identifier">TyThing</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Set.html"><span class="hs-identifier">GHC.Types.Unique.Set</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Set.html#isEmptyUniqSet"><span class="hs-identifier">isEmptyUniqSet</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.FV.html"><span class="hs-identifier">GHC.Utils.FV</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Outputable</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.List.SetOps.html"><span class="hs-identifier">GHC.Data.List.SetOps</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html"><span class="hs-identifier">Language.Haskell.Syntax.Basic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#FieldLabelString"><span class="hs-identifier">FieldLabelString</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Function.html"><span class="hs-identifier">Data.Function</span></a></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-operator">(\\)</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
          Checking for ambiguity
*                                                                      *
************************************************************************

Note [The ambiguity check for type signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
checkAmbiguity is a check on *user-supplied type signatures*.  It is
*purely* there to report functions that cannot possibly be called.  So for
example we want to reject:
   f :: C a =&gt; Int
The idea is there can be no legal calls to 'f' because every call will
give rise to an ambiguous constraint.  We could soundly omit the
ambiguity check on type signatures entirely, at the expense of
delaying ambiguity errors to call sites.  Indeed, the flag
-XAllowAmbiguousTypes switches off the ambiguity check.

What about things like this:
   class D a b | a -&gt; b where ..
   h :: D Int b =&gt; Int
The Int may well fix 'b' at the call site, so that signature should
not be rejected.  Moreover, using *visible* fundeps is too
conservative.  Consider
   class X a b where ...
   class D a b | a -&gt; b where ...
   instance D a b =&gt; X [a] b where...
   h :: X a b =&gt; a -&gt; a
Here h's type looks ambiguous in 'b', but here's a legal call:
   ...(h [True])...
That gives rise to a (X [Bool] beta) constraint, and using the
instance means we need (D Bool beta) and that fixes 'beta' via D's
fundep!

Behind all these special cases there is a simple guiding principle.
Consider

  f :: &lt;type&gt;
  f = ...blah...

  g :: &lt;type&gt;
  g = f

You would think that the definition of g would surely typecheck!
After all f has exactly the same type, and g=f. But in fact f's type
is instantiated and the instantiated constraints are solved against
the originals, so in the case of an ambiguous type it won't work.
Consider our earlier example f :: C a =&gt; Int.  Then in g's definition,
we'll instantiate to (C alpha) and try to deduce (C alpha) from (C a),
and fail.

So in fact we use this as our *definition* of ambiguity.  We use a
very similar test for *inferred* types, to ensure that they are
unambiguous. See Note [Impedance matching] in GHC.Tc.Gen.Bind.

This test is very conveniently implemented by calling
    tcSubType &lt;type&gt; &lt;type&gt;
This neatly takes account of the functional dependency stuff above,
and implicit parameter (see Note [Implicit parameters and ambiguity]).
And this is what checkAmbiguity does.

Note [The squishiness of the ambiguity check]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What about this?
   g :: C [a] =&gt; Int
Is every call to 'g' ambiguous?  After all, we might have
   instance C [a] where ...
at the call site.  So maybe that type is ok!  Indeed even f's
quintessentially ambiguous type might, just possibly be callable:
with -XFlexibleInstances we could have
  instance C a where ...
and now a call could be legal after all!  Well, we'll reject this
unless the instance is available *here*.

But even that's not quite right. Even a function with an utterly-ambiguous
type like f :: Eq a =&gt; Int -&gt; Int
is still callable if you are prepared to use visible type application,
thus (f @Bool x).

In short, the ambiguity check is a good-faith attempt to say &quot;you are likely
to have trouble if your function has this type&quot;; it is NOT the case that
&quot;you can't call this function without giving a type error&quot;.

See also Note [Ambiguity check and deep subsumption] in GHC.Tc.Utils.Unify.

Note [When to call checkAmbiguity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We call checkAmbiguity
   (a) on user-specified type signatures
   (b) in checkValidType

Conncerning (b), you might wonder about nested foralls.  What about
    f :: forall b. (forall a. Eq a =&gt; b) -&gt; b
The nested forall is ambiguous.  Originally we called checkAmbiguity
in the forall case of check_type, but that had two bad consequences:
  * We got two error messages about (Eq b) in a nested forall like this:
       g :: forall a. Eq a =&gt; forall b. Eq b =&gt; a -&gt; a
  * If we try to check for ambiguity of a nested forall like
    (forall a. Eq a =&gt; b), the implication constraint doesn't bind
    all the skolems, which results in &quot;No skolem info&quot; in error
    messages (see #10432).

To avoid this, we call checkAmbiguity once, at the top, in checkValidType.
(I'm still a bit worried about unbound skolems when the type mentions
in-scope type variables.)

In fact, because of the co/contra-variance implemented in tcSubType,
this *does* catch function f above. too.

Concerning (a) the ambiguity check is only used for *user* types, not
for types coming from interface files.  The latter can legitimately
have ambiguous types. Example

   class S a where s :: a -&gt; (Int,Int)
   instance S Char where s _ = (1,1)
   f:: S a =&gt; [a] -&gt; Int -&gt; (Int,Int)
   f (_::[a]) x = (a*x,b)
        where (a,b) = s (undefined::a)

Here the worker for f gets the type
        fw :: forall a. S a =&gt; Int -&gt; (# Int, Int #)


Note [Implicit parameters and ambiguity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Only a *class* predicate can give rise to ambiguity
An *implicit parameter* cannot.  For example:
        foo :: (?x :: [a]) =&gt; Int
        foo = length ?x
is fine.  The call site will supply a particular 'x'

Furthermore, the type variables fixed by an implicit parameter
propagate to the others.  E.g.
        foo :: (Show a, ?x::[a]) =&gt; Int
        foo = show (?x++?x)
The type of foo looks ambiguous.  But it isn't, because at a call site
we might have
        let ?x = 5::Int in foo
and all is well.  In effect, implicit parameters are, well, parameters,
so we can take their type variables into account as part of the
&quot;tau-tvs&quot; stuff.  This is done in the function 'GHC.Tc.Instance.FunDeps.grow'.
-}</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkAmbiguity"><span class="hs-identifier hs-type">checkAmbiguity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span id="checkAmbiguity"><span class="annot"><span class="annottext">checkAmbiguity :: UserTypeCtxt -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkAmbiguity"><span class="hs-identifier hs-var hs-var">checkAmbiguity</span></a></span></span><span> </span><span id="local-6989586621683048494"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048494"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048495"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048495"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#wantAmbiguityCheck"><span class="hs-identifier hs-var">wantAmbiguityCheck</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048494"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Ambiguity check for {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048495"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>         </span><span class="hs-comment">-- Solve the constraints eagerly because an ambiguous type</span><span>
</span><span id="line-240"></span><span>         </span><span class="hs-comment">-- can cause a cascade of further errors.  Since the free</span><span>
</span><span id="line-241"></span><span>         </span><span class="hs-comment">-- tyvars are skolemised, we can safely use tcSimplifyTop</span><span>
</span><span id="line-242"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048499"><span class="annot"><a href="#local-6989586621683048499"><span class="hs-identifier hs-var">allow_ambiguous</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.AllowAmbiguousTypes</span></span><span>
</span><span id="line-243"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="annot"><a href="#local-6989586621683048499"><span class="hs-identifier hs-type">allow_ambiguous</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-244"></span><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683048503"><span class="annot"><a href="#local-6989586621683048503"><span class="hs-identifier hs-var">_wrap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683048504"><span class="annot"><a href="#local-6989586621683048504"><span class="hs-identifier hs-var">wanted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-type">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048506"><span class="hs-identifier hs-type">mk_msg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048499"><span class="hs-identifier hs-type">allow_ambiguous</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-245"></span><span>                                 </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#captureConstraints"><span class="hs-identifier hs-type">captureConstraints</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-246"></span><span>                                 </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#tcSubTypeAmbiguity"><span class="hs-identifier hs-type">tcSubTypeAmbiguity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048494"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048495"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048495"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-247"></span><span>                                 </span><span class="hs-comment">-- See Note [Ambiguity check and deep subsumption]</span><span>
</span><span id="line-248"></span><span>                                 </span><span class="hs-comment">-- in GHC.Tc.Utils.Unify</span><span>
</span><span id="line-249"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html#simplifyAmbiguityCheck"><span class="hs-identifier hs-type">simplifyAmbiguityCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048495"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048504"><span class="hs-identifier hs-type">wanted</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;} Done ambiguity check for&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048495"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-256"></span><span>   </span><span id="local-6989586621683048506"><span class="annot"><span class="annottext">mk_msg :: Bool -&gt; SDoc
</span><a href="#local-6989586621683048506"><span class="hs-identifier hs-var hs-var">mk_msg</span></a></span></span><span> </span><span id="local-6989586621683048508"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048508"><span class="hs-identifier hs-var">allow_ambiguous</span></a></span></span><span>
</span><span id="line-257"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the ambiguity check for&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683048512"><span class="hs-identifier hs-var">what</span></a></span><span>
</span><span id="line-258"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; SDoc
forall doc. IsOutput doc =&gt; Bool -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#ppUnless"><span class="hs-identifier hs-var">ppUnless</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048508"><span class="hs-identifier hs-var">allow_ambiguous</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683048514"><span class="hs-identifier hs-var">ambig_msg</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-259"></span><span>   </span><span id="local-6989586621683048514"><span class="annot"><span class="annottext">ambig_msg :: SDoc
</span><a href="#local-6989586621683048514"><span class="hs-identifier hs-var hs-var">ambig_msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;To defer the ambiguity check to use sites, enable AllowAmbiguousTypes&quot;</span></span><span>
</span><span id="line-260"></span><span>   </span><span id="local-6989586621683048512"><span class="annot"><span class="annottext">what :: SDoc
</span><a href="#local-6989586621683048512"><span class="hs-identifier hs-var hs-var">what</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683048517"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683048517"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; Maybe Name
</span><a href="GHC.Tc.Types.Origin.html#isSigMaybe"><span class="hs-identifier hs-var">isSigMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048494"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683048517"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; SDoc
</span><a href="GHC.Tc.Types.Origin.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048494"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="annot"><a href="GHC.Tc.Validity.html#wantAmbiguityCheck"><span class="hs-identifier hs-type">wantAmbiguityCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-264"></span><span id="wantAmbiguityCheck"><span class="annot"><span class="annottext">wantAmbiguityCheck :: UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#wantAmbiguityCheck"><span class="hs-identifier hs-var hs-var">wantAmbiguityCheck</span></a></span></span><span> </span><span id="local-6989586621683048521"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048521"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048521"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- See Note [When we don't check for ambiguity]</span><span>
</span><span id="line-266"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GhciCtxt"><span class="hs-identifier hs-type">GhciCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-267"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TySynCtxt"><span class="hs-identifier hs-type">TySynCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-268"></span><span>      </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#TypeAppCtxt"><span class="hs-identifier hs-var">TypeAppCtxt</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-269"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#StandaloneKindSigCtxt"><span class="hs-identifier hs-type">StandaloneKindSigCtxt</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-270"></span><span>      </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span class="hs-comment">-- | Check whether the type signature contains custom type errors,</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- and fail if so.</span><span>
</span><span id="line-274"></span><span class="hs-comment">--</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- Note that some custom type errors are acceptable:</span><span>
</span><span id="line-276"></span><span class="hs-comment">--</span><span>
</span><span id="line-277"></span><span class="hs-comment">--   - in the RHS of a type synonym, e.g. to allow users to define</span><span>
</span><span id="line-278"></span><span class="hs-comment">--     type synonyms for custom type errors with large messages (#20181),</span><span>
</span><span id="line-279"></span><span class="hs-comment">--   - inside a type family application, as a custom type error</span><span>
</span><span id="line-280"></span><span class="hs-comment">--     might evaporate after performing type family reduction (#20241).</span><span>
</span><span id="line-281"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkUserTypeError"><span class="hs-identifier hs-type">checkUserTypeError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span class="hs-comment">-- Very unsatisfactorily (#11144) we need to tidy the type</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- because it may have come from an /inferred/ signature, not a</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- user-supplied one.  This is really only a half-baked fix;</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- the other errors in checkValidType don't do tidying, and so</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- may give bad error messages when given an inferred type.</span><span>
</span><span id="line-287"></span><span id="checkUserTypeError"><span class="annot"><span class="annottext">checkUserTypeError :: UserTypeCtxt -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkUserTypeError"><span class="hs-identifier hs-var hs-var">checkUserTypeError</span></a></span></span><span> </span><span id="local-6989586621683048527"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048527"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048528"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048528"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TySynCtxt"><span class="hs-identifier hs-type">TySynCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048527"><span class="hs-identifier hs-var">ctxt</span></a></span><span>  </span><span class="hs-comment">-- Do not complain about TypeError on the</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- RHS of type synonyms. See #20181</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683048529"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048529"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
</span><a href="GHC.Core.Type.html#deepUserTypeError_maybe"><span class="hs-identifier hs-var">deepUserTypeError_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048528"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048531"><span class="annot"><a href="#local-6989586621683048531"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM TidyEnv -&gt; TcM TidyEnv
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">ZonkM TidyEnv
</span><a href="GHC.Tc.Zonk.TcType.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a></span><span>
</span><span id="line-293"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683048534"><span class="annot"><a href="#local-6989586621683048534"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683048535"><span class="annot"><a href="#local-6989586621683048535"><span class="hs-identifier hs-var">tidy_msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Tidy.html#tidyOpenTypeX"><span class="hs-identifier hs-type">tidyOpenTypeX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048531"><span class="hs-identifier hs-type">env0</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048529"><span class="hs-identifier hs-type">msg</span></a></span><span>
</span><span id="line-294"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#failWithTcM"><span class="hs-identifier hs-type">failWithTcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048534"><span class="hs-identifier hs-type">env1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnUserTypeError"><span class="hs-identifier hs-type">TcRnUserTypeError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048535"><span class="hs-identifier hs-type">tidy_msg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="hs-comment">{- Note [When we don't check for ambiguity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a few places we do not want to check a user-specified type for ambiguity

* GhciCtxt: Allow ambiguous types in GHCi's :kind command
  E.g.   type family T a :: *  -- T :: forall k. k -&gt; *
  Then :k T should work in GHCi, not complain that
  (T k) is ambiguous!

* TySynCtxt: type T a b = C a b =&gt; blah
  It may be that when we /use/ T, we'll give an 'a' or 'b' that somehow
  cure the ambiguity.  So we defer the ambiguity check to the use site.

  There is also an implementation reason (#11608).  In the RHS of
  a type synonym we don't (currently) instantiate 'a' and 'b' with
  TcTyVars before calling checkValidType, so we get assertion failures
  from doing an ambiguity check on a type with TyVars in it.  Fixing this
  would not be hard, but let's wait till there's a reason.

* TypeAppCtxt: visible type application
     f @ty
  No need to check ty for ambiguity

* StandaloneKindSigCtxt: type T :: ksig
  Kinds need a different ambiguity check than types, and the currently
  implemented check is only good for types. See #14419, in particular
  https://gitlab.haskell.org/ghc/ghc/issues/14419#note_160844

************************************************************************
*                                                                      *
          Checking validity of a user-defined type
*                                                                      *
************************************************************************

When dealing with a user-written type, we first translate it from an HsType
to a Type, performing kind checking, and then check various things that should
be true about it.  We don't want to perform these checks at the same time
as the initial translation because (a) they are unnecessary for interface-file
types and (b) when checking a mutually recursive group of type and class decls,
we can't &quot;look&quot; at the tycons/classes yet.  Also, the checks are rather
diverse, and used to really mess up the other code.

One thing we check for is 'rank'.

        Rank 0:         monotypes (no foralls)
        Rank 1:         foralls at the front only, Rank 0 inside
        Rank 2:         foralls at the front, Rank 1 on left of fn arrow,

        basic ::= tyvar | T basic ... basic

        r2  ::= forall tvs. cxt =&gt; r2a
        r2a ::= r1 -&gt; r2a | basic
        r1  ::= forall tvs. cxt =&gt; r0
        r0  ::= r0 -&gt; r0 | basic

Another thing is to check that type synonyms are saturated.
This might not necessarily show up in kind checking.
        type A i = i
        data T k = MkT (k Int)
        f :: T A        -- BAD!
-}</span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidType"><span class="hs-identifier hs-type">checkValidType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- Checks that a user-written type is valid for the given context</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- Assumes argument is fully zonked</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- Assumes argument is well-kinded;</span><span>
</span><span id="line-365"></span><span class="hs-comment">--    that is, checkValidType doesn't need to do kind checking</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- Not used for instance decls; checkValidInstance instead</span><span>
</span><span id="line-367"></span><span id="checkValidType"><span class="annot"><span class="annottext">checkValidType :: UserTypeCtxt -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidType"><span class="hs-identifier hs-var hs-var">checkValidType</span></a></span></span><span> </span><span id="local-6989586621683048539"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048539"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048540"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048540"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkValidType&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048540"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;::&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048540"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048542"><span class="annot"><a href="#local-6989586621683048542"><span class="hs-identifier hs-var">rankn_flag</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.RankNTypes</span></span><span>
</span><span id="line-370"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048544"><span class="annot"><a href="#local-6989586621683048544"><span class="hs-identifier hs-var">impred_flag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-type">xoptM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LangExt.ImpredicativeTypes</span></span><span>
</span><span id="line-371"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621683048546"><span class="hs-identifier hs-type">gen_rank</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Rank.html#Rank"><span class="hs-identifier hs-type">Rank</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Rank.html#Rank"><span class="hs-identifier hs-type">Rank</span></a></span><span>
</span><span id="line-372"></span><span>             </span><span id="local-6989586621683048546"><span class="annot"><a href="#local-6989586621683048546"><span class="hs-identifier hs-var hs-var">gen_rank</span></a></span></span><span> </span><span id="local-6989586621683048547"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048547"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048542"><span class="hs-identifier hs-var">rankn_flag</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a></span><span>
</span><span id="line-373"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048547"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>             </span><span id="local-6989586621683048549"><span class="annot"><a href="#local-6989586621683048549"><span class="hs-identifier hs-var hs-var">rank1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank -&gt; Rank
</span><a href="#local-6989586621683048546"><span class="hs-identifier hs-var">gen_rank</span></a></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048550"><span class="hs-identifier hs-var">r1</span></a></span><span>
</span><span id="line-376"></span><span>             </span><span id="local-6989586621683048551"><span class="annot"><a href="#local-6989586621683048551"><span class="hs-identifier hs-var hs-var">rank0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank -&gt; Rank
</span><a href="#local-6989586621683048546"><span class="hs-identifier hs-var">gen_rank</span></a></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MonoTypeRankZero"><span class="hs-identifier hs-var">MonoTypeRankZero</span></a></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span>             </span><span id="local-6989586621683048550"><span class="annot"><a href="#local-6989586621683048550"><span class="hs-identifier hs-var hs-var">r1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Rank -&gt; Rank
</span><a href="GHC.Tc.Types.Rank.html#LimitedRank"><span class="hs-identifier hs-var">LimitedRank</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MonoTypeRankZero"><span class="hs-identifier hs-var">MonoTypeRankZero</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>             </span><span id="local-6989586621683048554"><span class="annot"><a href="#local-6989586621683048554"><span class="hs-identifier hs-var hs-var">rank</span></a></span></span><span>
</span><span id="line-381"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048539"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-382"></span><span>                 </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#DefaultDeclCtxt"><span class="hs-identifier hs-var">DefaultDeclCtxt</span></a></span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MustBeMonoType"><span class="hs-identifier hs-var">MustBeMonoType</span></a></span><span>
</span><span id="line-383"></span><span>                 </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#PatSigCtxt"><span class="hs-identifier hs-var">PatSigCtxt</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048551"><span class="hs-identifier hs-var">rank0</span></a></span><span>
</span><span id="line-384"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#RuleSigCtxt"><span class="hs-identifier hs-type">RuleSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-385"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TySynCtxt"><span class="hs-identifier hs-type">TySynCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048551"><span class="hs-identifier hs-var">rank0</span></a></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExprSigCtxt"><span class="hs-identifier hs-type">ExprSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-388"></span><span>                 </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#KindSigCtxt"><span class="hs-identifier hs-var">KindSigCtxt</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-389"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#StandaloneKindSigCtxt"><span class="hs-identifier hs-type">StandaloneKindSigCtxt</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-390"></span><span>                 </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#TypeAppCtxt"><span class="hs-identifier hs-var">TypeAppCtxt</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048544"><span class="hs-identifier hs-var">impred_flag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a></span><span>
</span><span id="line-391"></span><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MonoTypeTyConArg"><span class="hs-identifier hs-var">MonoTypeTyConArg</span></a></span><span>
</span><span id="line-392"></span><span>                    </span><span class="hs-comment">-- Normally, ImpredicativeTypes is handled in check_arg_type,</span><span>
</span><span id="line-393"></span><span>                    </span><span class="hs-comment">-- but visible type applications don't go through there.</span><span>
</span><span id="line-394"></span><span>                    </span><span class="hs-comment">-- So we do this check here.</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FunSigCtxt"><span class="hs-identifier hs-type">FunSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-397"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InfSigCtxt"><span class="hs-identifier hs-type">InfSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span> </span><span class="hs-comment">-- Inferred types should obey the</span><span>
</span><span id="line-398"></span><span>                                         </span><span class="hs-comment">-- same rules as declared ones</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ConArgCtxt"><span class="hs-identifier hs-type">ConArgCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span> </span><span class="hs-comment">-- We are given the type of the entire</span><span>
</span><span id="line-401"></span><span>                                         </span><span class="hs-comment">-- constructor, hence rank 1</span><span>
</span><span id="line-402"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#PatSynCtxt"><span class="hs-identifier hs-type">PatSynCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ForSigCtxt"><span class="hs-identifier hs-type">ForSigCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-405"></span><span>                 </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SpecInstCtxt"><span class="hs-identifier hs-var">SpecInstCtxt</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-406"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GhciCtxt"><span class="hs-identifier hs-type">GhciCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TyVarBndrKindCtxt"><span class="hs-identifier hs-type">TyVarBndrKindCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048551"><span class="hs-identifier hs-var">rank0</span></a></span><span>
</span><span id="line-409"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#DataKindCtxt"><span class="hs-identifier hs-type">DataKindCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-410"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TySynKindCtxt"><span class="hs-identifier hs-type">TySynKindCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-411"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TyFamResKindCtxt"><span class="hs-identifier hs-type">TyFamResKindCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048549"><span class="hs-identifier hs-var">rank1</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span>                 </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Rank
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkValidType&quot;</span></span><span>
</span><span id="line-414"></span><span>                                          </span><span class="hs-comment">-- Can't happen; not used for *user* sigs</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048573"><span class="annot"><a href="#local-6989586621683048573"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-type">liftZonkM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.TcType.html#tcInitOpenTidyEnv"><span class="hs-identifier hs-type">tcInitOpenTidyEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypeList"><span class="hs-identifier hs-type">tyCoVarsOfTypeList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048540"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048576"><span class="annot"><a href="#local-6989586621683048576"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#initialExpandMode"><span class="hs-identifier hs-type">initialExpandMode</span></a></span><span>
</span><span id="line-418"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683048578"><span class="annot"><a href="#local-6989586621683048578"><span class="hs-identifier hs-var hs-var">ve</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ve_tidy_env :: TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048573"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_ctxt :: UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048539"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-419"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_rank :: Rank
</span><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048554"><span class="hs-identifier hs-var">rank</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_expand :: ExpandMode
</span><a href="GHC.Tc.Validity.html#ve_expand"><span class="hs-identifier hs-var">ve_expand</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048576"><span class="hs-identifier hs-var">expand</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span>       </span><span class="hs-comment">-- Check the internal validity of the type itself</span><span>
</span><span id="line-422"></span><span>       </span><span class="hs-comment">-- Fail if bad things happen, else we misleading</span><span>
</span><span id="line-423"></span><span>       </span><span class="hs-comment">-- (and more complicated) errors in checkAmbiguity</span><span>
</span><span id="line-424"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-type">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-425"></span><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-type">check_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048578"><span class="hs-identifier hs-type">ve</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048540"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-426"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkUserTypeError"><span class="hs-identifier hs-type">checkUserTypeError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048539"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048540"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-427"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;done ct&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048540"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>       </span><span class="hs-comment">-- Check for ambiguous types.  See Note [When to call checkAmbiguity]</span><span>
</span><span id="line-430"></span><span>       </span><span class="hs-comment">-- NB: this will happen even for monotypes, but that should be cheap;</span><span>
</span><span id="line-431"></span><span>       </span><span class="hs-comment">--     and there may be nested foralls for the subtype test to examine</span><span>
</span><span id="line-432"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkAmbiguity"><span class="hs-identifier hs-type">checkAmbiguity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048539"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048540"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;checkValidType done&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048540"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;::&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-type">typeKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048540"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidMonoType"><span class="hs-identifier hs-type">checkValidMonoType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span class="hs-comment">-- Assumes argument is fully zonked</span><span>
</span><span id="line-438"></span><span id="checkValidMonoType"><span class="annot"><span class="annottext">checkValidMonoType :: Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidMonoType"><span class="hs-identifier hs-var hs-var">checkValidMonoType</span></a></span></span><span> </span><span id="local-6989586621683048586"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048586"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048587"><span class="annot"><a href="#local-6989586621683048587"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM TidyEnv -&gt; TcM TidyEnv
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM TidyEnv -&gt; TcM TidyEnv) -&gt; ZonkM TidyEnv -&gt; TcM TidyEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; ZonkM TidyEnv
</span><a href="GHC.Tc.Zonk.TcType.html#tcInitOpenTidyEnv"><span class="hs-identifier hs-var">tcInitOpenTidyEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [Var]
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypeList"><span class="hs-identifier hs-var">tyCoVarsOfTypeList</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048586"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048588"><span class="annot"><a href="#local-6989586621683048588"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#initialExpandMode"><span class="hs-identifier hs-type">initialExpandMode</span></a></span><span>
</span><span id="line-441"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683048589"><span class="annot"><a href="#local-6989586621683048589"><span class="hs-identifier hs-var hs-var">ve</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ve_tidy_env :: TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048587"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_ctxt :: UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a></span><span>
</span><span id="line-442"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_rank :: Rank
</span><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MustBeMonoType"><span class="hs-identifier hs-var">MustBeMonoType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_expand :: ExpandMode
</span><a href="GHC.Tc.Validity.html#ve_expand"><span class="hs-identifier hs-var">ve_expand</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048588"><span class="hs-identifier hs-var">expand</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-443"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-type">check_type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048589"><span class="hs-identifier hs-type">ve</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048586"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkTySynRhs"><span class="hs-identifier hs-type">checkTySynRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span id="checkTySynRhs"><span class="annot"><span class="annottext">checkTySynRhs :: UserTypeCtxt -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkTySynRhs"><span class="hs-identifier hs-var hs-var">checkTySynRhs</span></a></span></span><span> </span><span id="local-6989586621683048592"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048592"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048593"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048593"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#returnsConstraintKind"><span class="hs-identifier hs-var">returnsConstraintKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048595"><span class="hs-identifier hs-var">actual_kind</span></a></span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048596"><span class="annot"><a href="#local-6989586621683048596"><span class="hs-identifier hs-var">ck</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.ConstraintKinds</span></span><span>
</span><span id="line-449"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683048596"><span class="hs-identifier hs-type">ck</span></a></span><span>
</span><span id="line-450"></span><span>         </span><span class="hs-keyword">then</span><span>  </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Type.html#isConstraintLikeKind"><span class="hs-identifier hs-type">isConstraintLikeKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048595"><span class="hs-identifier hs-type">actual_kind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>                    </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048600"><span class="annot"><a href="#local-6989586621683048600"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-type">getDynFlags</span></a></span><span>
</span><span id="line-452"></span><span>                        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048602"><span class="annot"><a href="#local-6989586621683048602"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#initialExpandMode"><span class="hs-identifier hs-type">initialExpandMode</span></a></span><span>
</span><span id="line-453"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#check_pred_ty"><span class="hs-identifier hs-type">check_pred_ty</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#emptyTidyEnv"><span class="hs-identifier hs-type">emptyTidyEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048600"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048592"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048602"><span class="hs-identifier hs-type">expand</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048593"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#addErrTcM"><span class="hs-identifier hs-type">addErrTcM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#emptyTidyEnv"><span class="hs-identifier hs-type">emptyTidyEnv</span></a></span><span>
</span><span id="line-455"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnIllegalConstraintSynonymOfKind"><span class="hs-identifier hs-type">TcRnIllegalConstraintSynonymOfKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-type">tidyType</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#emptyTidyEnv"><span class="hs-identifier hs-type">emptyTidyEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048595"><span class="hs-identifier hs-type">actual_kind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>                        </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-459"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-461"></span><span>    </span><span id="local-6989586621683048595"><span class="annot"><span class="annottext">actual_kind :: Type
</span><a href="#local-6989586621683048595"><span class="hs-identifier hs-var hs-var">actual_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048593"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span class="hs-comment">{- Note [Check for escaping result kind]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:
  type T :: TYPE (BoxedRep l)
  data T = MkT
This is not OK: we get
  MkT :: forall l. T @l :: TYPE (BoxedRep l)
which is ill-kinded.

For ordinary /user-written/ type signatures f :: blah, we make this
check as part of kind-checking the type signature in tcHsSigType; see
Note [Escaping kind in type signatures] in GHC.Tc.Gen.HsType.

But in two other places we need to check for an escaping result kind:

* For data constructors we check the type piecemeal, and there is no
  very convenient place to do it.  For example, note that it only
  applies for /nullary/ constructors.  If we had
    data T = MkT Int
  then the type of MkT would be MkT :: forall l. Int -&gt; T @l, which is fine.

  So we make the check in checkValidDataCon.

* When inferring the type of a function, there is no user-written type
  that we are checking.  Forgetting this led to #22743.  Now we call
  checkEscapingKind in GHC.Tc.Gen.Bind.mkInferredPolyId

Historical note: we used to do the escaping-kind check in
checkValidType (#20929 discusses), but that is now redundant.
-}</span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkEscapingKind"><span class="hs-identifier hs-type">checkEscapingKind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span class="hs-comment">-- Give a sigma-type (forall a1 .. an. ty), where (ty :: ki),</span><span>
</span><span id="line-496"></span><span class="hs-comment">-- check that `ki` does not mention any of the binders a1..an.</span><span>
</span><span id="line-497"></span><span class="hs-comment">-- Otherwise the type is ill-kinded</span><span>
</span><span id="line-498"></span><span class="hs-comment">-- See Note [Check for escaping result kind]</span><span>
</span><span id="line-499"></span><span id="checkEscapingKind"><span class="annot"><span class="annottext">checkEscapingKind :: Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkEscapingKind"><span class="hs-identifier hs-var hs-var">checkEscapingKind</span></a></span></span><span> </span><span id="local-6989586621683048608"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048608"><span class="hs-identifier hs-var">poly_ty</span></a></span></span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683048609"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683048609"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683048610"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048610"><span class="hs-identifier hs-var">tau</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([Var], Type)
</span><a href="GHC.Core.Type.html#splitForAllTyVars"><span class="hs-identifier hs-var">splitForAllTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048608"><span class="hs-identifier hs-var">poly_ty</span></a></span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683048612"><span class="annot"><span class="annottext">tau_kind :: Type
</span><a href="#local-6989586621683048612"><span class="hs-identifier hs-var hs-var">tau_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048610"><span class="hs-identifier hs-var">tau</span></a></span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Type
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; Type -&gt; Maybe Type
</span><a href="GHC.Core.TyCo.FVs.html#occCheckExpand"><span class="hs-identifier hs-var">occCheckExpand</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683048609"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048612"><span class="hs-identifier hs-var">tau_kind</span></a></span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-comment">-- Ensure that none of the tvs occur in the kind of the forall</span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-comment">-- /after/ expanding type synonyms.</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-comment">-- See Note [Phantom type variables in kinds] in GHC.Core.Type</span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnForAllEscapeError"><span class="hs-identifier hs-var">TcRnForAllEscapeError</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048608"><span class="hs-identifier hs-var">poly_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048612"><span class="hs-identifier hs-var">tau_kind</span></a></span><span>
</span><span id="line-507"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span class="annot"><a href="GHC.Tc.Validity.html#funArgResRank"><span class="hs-identifier hs-type">funArgResRank</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Rank.html#Rank"><span class="hs-identifier hs-type">Rank</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Rank.html#Rank"><span class="hs-identifier hs-type">Rank</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Rank.html#Rank"><span class="hs-identifier hs-type">Rank</span></a></span><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- Function argument and result</span><span>
</span><span id="line-511"></span><span id="funArgResRank"><span class="annot"><span class="annottext">funArgResRank :: Rank -&gt; (Rank, Rank)
</span><a href="GHC.Tc.Validity.html#funArgResRank"><span class="hs-identifier hs-var hs-var">funArgResRank</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Rank.html#LimitedRank"><span class="hs-identifier hs-type">LimitedRank</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683048617"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048617"><span class="hs-identifier hs-var">arg_rank</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048617"><span class="hs-identifier hs-var">arg_rank</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Rank -&gt; Rank
</span><a href="GHC.Tc.Types.Rank.html#LimitedRank"><span class="hs-identifier hs-var">LimitedRank</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rank -&gt; Bool
</span><a href="GHC.Tc.Validity.html#forAllAllowed"><span class="hs-identifier hs-var">forAllAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048617"><span class="hs-identifier hs-var">arg_rank</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048617"><span class="hs-identifier hs-var">arg_rank</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span class="annot"><a href="GHC.Tc.Validity.html#funArgResRank"><span class="hs-identifier hs-var">funArgResRank</span></a></span><span> </span><span id="local-6989586621683048619"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048619"><span class="hs-identifier hs-var">other_rank</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048619"><span class="hs-identifier hs-var">other_rank</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048619"><span class="hs-identifier hs-var">other_rank</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span class="annot"><a href="GHC.Tc.Validity.html#forAllAllowed"><span class="hs-identifier hs-type">forAllAllowed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Rank.html#Rank"><span class="hs-identifier hs-type">Rank</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-515"></span><span id="forAllAllowed"><span class="annot"><span class="annottext">forAllAllowed :: Rank -&gt; Bool
</span><a href="GHC.Tc.Validity.html#forAllAllowed"><span class="hs-identifier hs-var hs-var">forAllAllowed</span></a></span></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-516"></span><span class="annot"><a href="GHC.Tc.Validity.html#forAllAllowed"><span class="hs-identifier hs-var">forAllAllowed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Rank.html#LimitedRank"><span class="hs-identifier hs-type">LimitedRank</span></a></span><span> </span><span id="local-6989586621683048620"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048620"><span class="hs-identifier hs-var">forall_ok</span></a></span></span><span> </span><span class="annot"><span class="annottext">Rank
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048620"><span class="hs-identifier hs-var">forall_ok</span></a></span><span>
</span><span id="line-517"></span><span class="annot"><a href="GHC.Tc.Validity.html#forAllAllowed"><span class="hs-identifier hs-var">forAllAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">Rank
</span><span class="hs-identifier">_</span></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span class="hs-comment">-- | Indicates whether a 'UserTypeCtxt' represents type-level contexts,</span><span>
</span><span id="line-520"></span><span class="hs-comment">-- kind-level contexts, or both.</span><span>
</span><span id="line-521"></span><span class="hs-keyword">data</span><span> </span><span id="TypeOrKindCtxt"><span class="annot"><a href="GHC.Tc.Validity.html#TypeOrKindCtxt"><span class="hs-identifier hs-var">TypeOrKindCtxt</span></a></span></span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="OnlyTypeCtxt"><span class="annot"><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span></span><span>
</span><span id="line-523"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ A 'UserTypeCtxt' that only represents type-level positions.</span></span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="OnlyKindCtxt"><span class="annot"><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span></span><span>
</span><span id="line-525"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ A 'UserTypeCtxt' that only represents kind-level positions.</span></span><span>
</span><span id="line-526"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="BothTypeAndKindCtxt"><span class="annot"><a href="GHC.Tc.Validity.html#BothTypeAndKindCtxt"><span class="hs-identifier hs-var">BothTypeAndKindCtxt</span></a></span></span><span>
</span><span id="line-527"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ A 'UserTypeCtxt' that can represent both type- and kind-level positions.</span></span><span>
</span><span id="line-528"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621683048625"><span id="local-6989586621683048630"><span class="annot"><span class="annottext">TypeOrKindCtxt -&gt; TypeOrKindCtxt -&gt; Bool
(TypeOrKindCtxt -&gt; TypeOrKindCtxt -&gt; Bool)
-&gt; (TypeOrKindCtxt -&gt; TypeOrKindCtxt -&gt; Bool) -&gt; Eq TypeOrKindCtxt
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: TypeOrKindCtxt -&gt; TypeOrKindCtxt -&gt; Bool
== :: TypeOrKindCtxt -&gt; TypeOrKindCtxt -&gt; Bool
$c/= :: TypeOrKindCtxt -&gt; TypeOrKindCtxt -&gt; Bool
/= :: TypeOrKindCtxt -&gt; TypeOrKindCtxt -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#TypeOrKindCtxt"><span class="hs-identifier hs-type">TypeOrKindCtxt</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-531"></span><span>  </span><span id="local-6989586621683048638"><span class="annot"><span class="annottext">ppr :: TypeOrKindCtxt -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span id="local-6989586621683048639"><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="#local-6989586621683048639"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SDoc) -&gt; String -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="#local-6989586621683048639"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-532"></span><span>    </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;OnlyTypeCtxt&quot;</span></span><span>
</span><span id="line-533"></span><span>    </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;OnlyKindCtxt&quot;</span></span><span>
</span><span id="line-534"></span><span>    </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#BothTypeAndKindCtxt"><span class="hs-identifier hs-var">BothTypeAndKindCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BothTypeAndKindCtxt&quot;</span></span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span class="hs-comment">-- | Determine whether a 'UserTypeCtxt' can represent type-level contexts,</span><span>
</span><span id="line-537"></span><span class="hs-comment">-- kind-level contexts, or both.</span><span>
</span><span id="line-538"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-type">typeOrKindCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#TypeOrKindCtxt"><span class="hs-identifier hs-type">TypeOrKindCtxt</span></a></span><span>
</span><span id="line-539"></span><span id="typeOrKindCtxt"><span class="annot"><span class="annottext">typeOrKindCtxt :: UserTypeCtxt -&gt; TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var hs-var">typeOrKindCtxt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FunSigCtxt"><span class="hs-identifier hs-type">FunSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-540"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InfSigCtxt"><span class="hs-identifier hs-type">InfSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-541"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExprSigCtxt"><span class="hs-identifier hs-type">ExprSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-542"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TypeAppCtxt"><span class="hs-identifier hs-type">TypeAppCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-543"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#PatSynCtxt"><span class="hs-identifier hs-type">PatSynCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-544"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#PatSigCtxt"><span class="hs-identifier hs-type">PatSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-545"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#RuleSigCtxt"><span class="hs-identifier hs-type">RuleSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-546"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ForSigCtxt"><span class="hs-identifier hs-type">ForSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-547"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#DefaultDeclCtxt"><span class="hs-identifier hs-type">DefaultDeclCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-548"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InstDeclCtxt"><span class="hs-identifier hs-type">InstDeclCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-549"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SpecInstCtxt"><span class="hs-identifier hs-type">SpecInstCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-550"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GenSigCtxt"><span class="hs-identifier hs-type">GenSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-551"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ClassSCCtxt"><span class="hs-identifier hs-type">ClassSCCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-552"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SigmaCtxt"><span class="hs-identifier hs-type">SigmaCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-553"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#DataTyCtxt"><span class="hs-identifier hs-type">DataTyCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-554"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#DerivClauseCtxt"><span class="hs-identifier hs-type">DerivClauseCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-555"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ConArgCtxt"><span class="hs-identifier hs-type">ConArgCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-comment">-- Although data constructors can be promoted with DataKinds, we always</span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-comment">-- validity-check them as though they are the types of terms. We may need</span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-comment">-- to revisit this decision if we ever allow visible dependent quantification</span><span>
</span><span id="line-559"></span><span>  </span><span class="hs-comment">-- in the types of data constructors.</span><span>
</span><span id="line-560"></span><span>
</span><span id="line-561"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#KindSigCtxt"><span class="hs-identifier hs-type">KindSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span><span>
</span><span id="line-562"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#StandaloneKindSigCtxt"><span class="hs-identifier hs-type">StandaloneKindSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span><span>
</span><span id="line-563"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TyVarBndrKindCtxt"><span class="hs-identifier hs-type">TyVarBndrKindCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span><span>
</span><span id="line-564"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#DataKindCtxt"><span class="hs-identifier hs-type">DataKindCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span><span>
</span><span id="line-565"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TySynKindCtxt"><span class="hs-identifier hs-type">TySynKindCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span><span>
</span><span id="line-566"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TyFamResKindCtxt"><span class="hs-identifier hs-type">TyFamResKindCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span class="hs-comment">-- These cases are also described in Note [No constraints in kinds], so any</span><span>
</span><span id="line-569"></span><span class="hs-comment">-- change here should be reflected in that note.</span><span>
</span><span id="line-570"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TySynCtxt"><span class="hs-identifier hs-type">TySynCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#BothTypeAndKindCtxt"><span class="hs-identifier hs-var">BothTypeAndKindCtxt</span></a></span><span>
</span><span id="line-571"></span><span>  </span><span class="hs-comment">-- Type synonyms can have types and kinds on their RHSs</span><span>
</span><span id="line-572"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GhciCtxt"><span class="hs-identifier hs-type">GhciCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#BothTypeAndKindCtxt"><span class="hs-identifier hs-var">BothTypeAndKindCtxt</span></a></span><span>
</span><span id="line-573"></span><span>  </span><span class="hs-comment">-- GHCi's :kind command accepts both types and kinds</span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span class="hs-comment">-- | Returns 'True' if the supplied 'UserTypeCtxt' is unambiguously not the</span><span>
</span><span id="line-576"></span><span class="hs-comment">-- context for a kind of a type.</span><span>
</span><span id="line-577"></span><span class="hs-comment">-- If the 'UserTypeCtxt' can refer to both types and kinds, this function</span><span>
</span><span id="line-578"></span><span class="hs-comment">-- conservatively returns 'True'.</span><span>
</span><span id="line-579"></span><span class="hs-comment">--</span><span>
</span><span id="line-580"></span><span class="hs-comment">-- An example of something that is unambiguously the kind of a type is the</span><span>
</span><span id="line-581"></span><span class="hs-comment">-- @Show a =&gt; a -&gt; a@ in @type Foo :: Show a =&gt; a -&gt; a@. On the other hand, the</span><span>
</span><span id="line-582"></span><span class="hs-comment">-- same type in @foo :: Show a =&gt; a -&gt; a@ is unambiguously the type of a term,</span><span>
</span><span id="line-583"></span><span class="hs-comment">-- not the kind of a type, so it is permitted.</span><span>
</span><span id="line-584"></span><span class="annot"><a href="GHC.Tc.Validity.html#typeLevelUserTypeCtxt"><span class="hs-identifier hs-type">typeLevelUserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-585"></span><span id="typeLevelUserTypeCtxt"><span class="annot"><span class="annottext">typeLevelUserTypeCtxt :: UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#typeLevelUserTypeCtxt"><span class="hs-identifier hs-var hs-var">typeLevelUserTypeCtxt</span></a></span></span><span> </span><span id="local-6989586621683048647"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048647"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048647"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-586"></span><span>  </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-587"></span><span>  </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-588"></span><span>  </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#BothTypeAndKindCtxt"><span class="hs-identifier hs-var">BothTypeAndKindCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="hs-comment">-- | Returns 'True' if the supplied 'UserTypeCtxt' is unambiguously not the</span><span>
</span><span id="line-591"></span><span class="hs-comment">-- context for a kind of a type, where the arbitrary use of constraints is</span><span>
</span><span id="line-592"></span><span class="hs-comment">-- currently disallowed.</span><span>
</span><span id="line-593"></span><span class="annot"><a href="GHC.Tc.Validity.html#allConstraintsAllowed"><span class="hs-identifier hs-type">allConstraintsAllowed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-594"></span><span id="allConstraintsAllowed"><span class="annot"><span class="annottext">allConstraintsAllowed :: UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#allConstraintsAllowed"><span class="hs-identifier hs-var hs-var">allConstraintsAllowed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#typeLevelUserTypeCtxt"><span class="hs-identifier hs-var">typeLevelUserTypeCtxt</span></a></span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span class="hs-comment">-- | Returns 'True' if the supplied 'UserTypeCtxt' is unambiguously not the</span><span>
</span><span id="line-597"></span><span class="hs-comment">-- context for a kind of a type, where all function arrows currently</span><span>
</span><span id="line-598"></span><span class="hs-comment">-- must be unrestricted.</span><span>
</span><span id="line-599"></span><span class="annot"><a href="GHC.Tc.Validity.html#linearityAllowed"><span class="hs-identifier hs-type">linearityAllowed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-600"></span><span id="linearityAllowed"><span class="annot"><span class="annottext">linearityAllowed :: UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#linearityAllowed"><span class="hs-identifier hs-var hs-var">linearityAllowed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#typeLevelUserTypeCtxt"><span class="hs-identifier hs-var">typeLevelUserTypeCtxt</span></a></span><span>
</span><span id="line-601"></span><span>
</span><span id="line-602"></span><span class="hs-comment">-- | Returns 'True' if the supplied 'UserTypeCtxt' is unambiguously not the</span><span>
</span><span id="line-603"></span><span class="hs-comment">-- context for the type of a term, where visible, dependent quantification is</span><span>
</span><span id="line-604"></span><span class="hs-comment">-- currently disallowed. If the 'UserTypeCtxt' can refer to both types and</span><span>
</span><span id="line-605"></span><span class="hs-comment">-- kinds, this function conservatively returns 'True'.</span><span>
</span><span id="line-606"></span><span class="hs-comment">--</span><span>
</span><span id="line-607"></span><span class="hs-comment">-- An example of something that is unambiguously the type of a term is the</span><span>
</span><span id="line-608"></span><span class="hs-comment">-- @forall a -&gt; a -&gt; a@ in @foo :: forall a -&gt; a -&gt; a@. On the other hand, the</span><span>
</span><span id="line-609"></span><span class="hs-comment">-- same type in @type family Foo :: forall a -&gt; a -&gt; a@ is unambiguously the</span><span>
</span><span id="line-610"></span><span class="hs-comment">-- kind of a type, not the type of a term, so it is permitted.</span><span>
</span><span id="line-611"></span><span class="hs-comment">--</span><span>
</span><span id="line-612"></span><span class="hs-comment">-- For more examples, see</span><span>
</span><span id="line-613"></span><span class="hs-comment">-- @testsuite/tests/dependent/should_compile/T16326_Compile*.hs@ (for places</span><span>
</span><span id="line-614"></span><span class="hs-comment">-- where VDQ is permitted) and</span><span>
</span><span id="line-615"></span><span class="hs-comment">-- @testsuite/tests/dependent/should_fail/T16326_Fail*.hs@ (for places where</span><span>
</span><span id="line-616"></span><span class="hs-comment">-- VDQ is disallowed).</span><span>
</span><span id="line-617"></span><span class="annot"><a href="GHC.Tc.Validity.html#vdqAllowed"><span class="hs-identifier hs-type">vdqAllowed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-618"></span><span id="vdqAllowed"><span class="annot"><span class="annottext">vdqAllowed :: UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#vdqAllowed"><span class="hs-identifier hs-var hs-var">vdqAllowed</span></a></span></span><span> </span><span id="local-6989586621683048651"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048651"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#typeOrKindCtxt"><span class="hs-identifier hs-var">typeOrKindCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048651"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-619"></span><span>  </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyTypeCtxt"><span class="hs-identifier hs-var">OnlyTypeCtxt</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-620"></span><span>  </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#OnlyKindCtxt"><span class="hs-identifier hs-var">OnlyKindCtxt</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-621"></span><span>  </span><span class="annot"><span class="annottext">TypeOrKindCtxt
</span><a href="GHC.Tc.Validity.html#BothTypeAndKindCtxt"><span class="hs-identifier hs-var">BothTypeAndKindCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-622"></span><span>
</span><span id="line-623"></span><span class="hs-comment">{-
Note [Correctness and performance of type synonym validity checking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the type A arg1 arg2, where A is a type synonym. How should we check
this type for validity? We have three distinct choices, corresponding to the
three constructors of ExpandMode:

1. Expand the application of A, and check the resulting type (`Expand`).
2. Don't expand the application of A. Only check the arguments (`NoExpand`).
3. Check the arguments *and* check the expanded type (`Both`).

It's tempting to think that we could always just pick choice (3), but this
results in serious performance issues when checking a type like in the
signature for `f` below:

  type S = ...
  f :: S (S (S (S (S (S ....(S Int)...))))

When checking the type of `f`, we'll check the outer `S` application with and
without expansion, and in *each* of those checks, we'll check the next `S`
application with and without expansion... the result is exponential blowup! So
clearly we don't want to use `Both` 100% of the time.

On the other hand, neither is it correct to use exclusively `Expand` or
exclusively `NoExpand` 100% of the time:

* If one always expands, then one can miss erroneous programs like the one in
  the `tcfail129` test case:

    type Foo a = String -&gt; Maybe a
    type Bar m = m Int
    blah = undefined :: Bar Foo

  If we expand `Bar Foo` immediately, we'll miss the fact that the `Foo` type
  synonyms is unsaturated.
* If one never expands and only checks the arguments, then one can miss
  erroneous programs like the one in #16059:

    type Foo b = Eq b =&gt; b
    f :: forall b (a :: Foo b). Int

  The kind of `a` contains a constraint, which is illegal, but this will only
  be caught if `Foo b` is expanded.

Therefore, it's impossible to have these validity checks be simultaneously
correct and performant if one sticks exclusively to a single `ExpandMode`. In
that case, the solution is to vary the `ExpandMode`s! In more detail:

1. When we start validity checking, we start with `Expand` if
   LiberalTypeSynonyms is enabled (see Note [Liberal type synonyms] for why we
   do this), and we start with `Both` otherwise. The `initialExpandMode`
   function is responsible for this.
2. When expanding an application of a type synonym (in `check_syn_tc_app`), we
   determine which things to check based on the current `ExpandMode` argument.
   Importantly, if the current mode is `Both`, then we check the arguments in
   `NoExpand` mode and check the expanded type in `Both` mode.

   Switching to `NoExpand` when checking the arguments is vital to avoid
   exponential blowup. One consequence of this choice is that if you have
   the following type synonym in one module (with RankNTypes enabled):

     {-# LANGUAGE RankNTypes #-}
     module A where
     type A = forall a. a

   And you define the following in a separate module *without* RankNTypes
   enabled:

     module B where

     import A

     type Const a b = a
     f :: Const Int A -&gt; Int

   Then `f` will be accepted, even though `A` (which is technically a rank-n
   type) appears in its type. We view this as an acceptable compromise, since
   `A` never appears in the type of `f` post-expansion. If `A` _did_ appear in
   a type post-expansion, such as in the following variant:

     g :: Const A A -&gt; Int

   Then that would be rejected unless RankNTypes were enabled.
-}</span><span>
</span><span id="line-707"></span><span>
</span><span id="line-708"></span><span class="hs-comment">-- | When validity-checking an application of a type synonym, should we</span><span>
</span><span id="line-709"></span><span class="hs-comment">-- check the arguments, check the expanded type, or both?</span><span>
</span><span id="line-710"></span><span class="hs-comment">-- See Note [Correctness and performance of type synonym validity checking]</span><span>
</span><span id="line-711"></span><span class="hs-keyword">data</span><span> </span><span id="ExpandMode"><span class="annot"><a href="GHC.Tc.Validity.html#ExpandMode"><span class="hs-identifier hs-var">ExpandMode</span></a></span></span><span>
</span><span id="line-712"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Expand"><span class="annot"><a href="GHC.Tc.Validity.html#Expand"><span class="hs-identifier hs-var">Expand</span></a></span></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Only check the expanded type.</span></span><span>
</span><span id="line-713"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NoExpand"><span class="annot"><a href="GHC.Tc.Validity.html#NoExpand"><span class="hs-identifier hs-var">NoExpand</span></a></span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Only check the arguments.</span></span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Both"><span class="annot"><a href="GHC.Tc.Validity.html#Both"><span class="hs-identifier hs-var">Both</span></a></span></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Check both the arguments and the expanded type.</span></span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ExpandMode"><span class="hs-identifier hs-type">ExpandMode</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-717"></span><span>  </span><span id="local-6989586621683048658"><span class="annot"><span class="annottext">ppr :: ExpandMode -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span id="local-6989586621683048659"><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048659"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SDoc) -&gt; String -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048659"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-718"></span><span>                   </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="GHC.Tc.Validity.html#Expand"><span class="hs-identifier hs-var">Expand</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Expand&quot;</span></span><span>
</span><span id="line-719"></span><span>                   </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="GHC.Tc.Validity.html#NoExpand"><span class="hs-identifier hs-var">NoExpand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;NoExpand&quot;</span></span><span>
</span><span id="line-720"></span><span>                   </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="GHC.Tc.Validity.html#Both"><span class="hs-identifier hs-var">Both</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Both&quot;</span></span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span class="hs-comment">-- | If @LiberalTypeSynonyms@ is enabled, we start in 'Expand' mode for the</span><span>
</span><span id="line-723"></span><span class="hs-comment">-- reasons explained in @Note [Liberal type synonyms]@. Otherwise, we start</span><span>
</span><span id="line-724"></span><span class="hs-comment">-- in 'Both' mode.</span><span>
</span><span id="line-725"></span><span class="annot"><a href="GHC.Tc.Validity.html#initialExpandMode"><span class="hs-identifier hs-type">initialExpandMode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ExpandMode"><span class="hs-identifier hs-type">ExpandMode</span></a></span><span>
</span><span id="line-726"></span><span id="initialExpandMode"><span class="annot"><span class="annottext">initialExpandMode :: TcM ExpandMode
</span><a href="GHC.Tc.Validity.html#initialExpandMode"><span class="hs-identifier hs-var hs-var">initialExpandMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>  </span><span id="local-6989586621683048660"><span class="annot"><a href="#local-6989586621683048660"><span class="hs-identifier hs-var">liberal_flag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.LiberalTypeSynonyms</span></span><span>
</span><span id="line-728"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683048660"><span class="hs-identifier hs-type">liberal_flag</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#Expand"><span class="hs-identifier hs-type">Expand</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#Both"><span class="hs-identifier hs-type">Both</span></a></span><span>
</span><span id="line-729"></span><span>
</span><span id="line-730"></span><span class="annot"><span class="hs-comment">-- | Information about a type being validity-checked.</span></span><span>
</span><span id="line-731"></span><span class="hs-keyword">data</span><span> </span><span id="ValidityEnv"><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-var">ValidityEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ValidityEnv"><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-var">ValidityEnv</span></a></span></span><span>
</span><span id="line-732"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ve_tidy_env"><span class="annot"><span class="annottext">ValidityEnv -&gt; TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var hs-var">ve_tidy_env</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span>
</span><span id="line-733"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ve_ctxt"><span class="annot"><span class="annottext">ValidityEnv -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var hs-var">ve_ctxt</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-734"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ve_rank"><span class="annot"><span class="annottext">ValidityEnv -&gt; Rank
</span><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var hs-var">ve_rank</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Rank.html#Rank"><span class="hs-identifier hs-type">Rank</span></a></span><span>
</span><span id="line-735"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ve_expand"><span class="annot"><span class="annottext">ValidityEnv -&gt; ExpandMode
</span><a href="GHC.Tc.Validity.html#ve_expand"><span class="hs-identifier hs-var hs-var">ve_expand</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ExpandMode"><span class="hs-identifier hs-type">ExpandMode</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-736"></span><span>
</span><span id="line-737"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-738"></span><span>  </span><span id="local-6989586621683048681"><span class="annot"><span class="annottext">ppr :: ValidityEnv -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ve_tidy_env :: ValidityEnv -&gt; TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048682"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048682"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_ctxt :: ValidityEnv -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048683"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048683"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span>
</span><span id="line-739"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_rank :: ValidityEnv -&gt; Rank
</span><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048684"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048684"><span class="hs-identifier hs-var">rank</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_expand :: ValidityEnv -&gt; ExpandMode
</span><a href="GHC.Tc.Validity.html#ve_expand"><span class="hs-identifier hs-var">ve_expand</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048685"><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048685"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-740"></span><span>    </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ValidityEnv&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>       </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ve_tidy_env&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048682"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-742"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ve_ctxt&quot;</span></span><span>     </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; SDoc
</span><a href="GHC.Tc.Types.Origin.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048683"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-743"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ve_rank&quot;</span></span><span>     </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Rank -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048684"><span class="hs-identifier hs-var">rank</span></a></span><span>
</span><span id="line-744"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ve_expand&quot;</span></span><span>   </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048685"><span class="hs-identifier hs-var">expand</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-747"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-type">check_type</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span class="hs-comment">-- The args say what the *type context* requires, independent</span><span>
</span><span id="line-749"></span><span class="hs-comment">-- of *flag* settings.  You test the flag settings at usage sites.</span><span>
</span><span id="line-750"></span><span class="hs-comment">--</span><span>
</span><span id="line-751"></span><span class="hs-comment">-- Rank is allowed rank for function args</span><span>
</span><span id="line-752"></span><span class="hs-comment">-- Rank 0 means no for-alls anywhere</span><span>
</span><span id="line-753"></span><span>
</span><span id="line-754"></span><span id="check_type"><span class="annot"><span class="annottext">check_type :: ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var hs-var">check_type</span></a></span></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-756"></span><span>
</span><span id="line-757"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span id="local-6989586621683048688"><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048688"><span class="hs-identifier hs-var">ve</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621683048690"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048690"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621683048691"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048691"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-758"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048688"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048690"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-759"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_arg_type"><span class="hs-identifier hs-var">check_arg_type</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048688"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048691"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span id="local-6989586621683048693"><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048693"><span class="hs-identifier hs-var">ve</span></a></span></span><span> </span><span id="local-6989586621683048694"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683048694"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683048696"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048696"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683048697"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048697"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeSynonymTyCon"><span class="hs-identifier hs-var">isTypeSynonymTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048696"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048696"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-763"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TyCon -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_syn_tc_app"><span class="hs-identifier hs-var">check_syn_tc_app</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048693"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048694"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048696"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048697"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-764"></span><span>
</span><span id="line-765"></span><span>  </span><span class="hs-comment">-- Check for unboxed tuples and unboxed sums: these</span><span>
</span><span id="line-766"></span><span>  </span><span class="hs-comment">-- require the corresponding extension to be enabled.</span><span>
</span><span id="line-767"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isUnboxedTupleTyCon"><span class="hs-identifier hs-var">isUnboxedTupleTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048696"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-768"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnboxedTupleOrSum -&gt; ValidityEnv -&gt; Type -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_ubx_tuple_or_sum"><span class="hs-identifier hs-var">check_ubx_tuple_or_sum</span></a></span><span> </span><span class="annot"><span class="annottext">UnboxedTupleOrSum
</span><a href="GHC.Types.Basic.html#UnboxedTupleType"><span class="hs-identifier hs-var">UnboxedTupleType</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048693"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048694"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048697"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-769"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isUnboxedSumTyCon"><span class="hs-identifier hs-var">isUnboxedSumTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048696"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-770"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnboxedTupleOrSum -&gt; ValidityEnv -&gt; Type -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_ubx_tuple_or_sum"><span class="hs-identifier hs-var">check_ubx_tuple_or_sum</span></a></span><span> </span><span class="annot"><span class="annottext">UnboxedTupleOrSum
</span><a href="GHC.Types.Basic.html#UnboxedSumType"><span class="hs-identifier hs-var">UnboxedSumType</span></a></span><span>   </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048693"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048694"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048697"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-773"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- We require DataKinds to use a type constructor in a kind, unless it</span><span>
</span><span id="line-774"></span><span>         </span><span class="hs-comment">-- is exempted (e.g., Type, TYPE, etc., which is checked by</span><span>
</span><span id="line-775"></span><span>         </span><span class="hs-comment">-- isKindTyCon) or a `type data` type constructor.</span><span>
</span><span id="line-776"></span><span>         </span><span class="hs-comment">-- See Note [Checking for DataKinds].</span><span>
</span><span id="line-777"></span><span>         </span><span class="annot"><span class="annottext">Bool -&gt; TcM () -&gt; TcM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isKindTyCon"><span class="hs-identifier hs-var">isKindTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048696"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeDataTyCon"><span class="hs-identifier hs-var">isTypeDataTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048696"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-778"></span><span>         </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkDataKinds"><span class="hs-identifier hs-var">checkDataKinds</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048693"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048694"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-779"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; TcM ()) -&gt; [Type] -&gt; TcM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_arg_type"><span class="hs-identifier hs-var">check_arg_type</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048693"><span class="hs-identifier hs-var">ve</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048697"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span id="local-6989586621683048711"><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048711"><span class="hs-identifier hs-var">ve</span></a></span></span><span> </span><span id="local-6989586621683048712"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683048712"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-782"></span><span>  </span><span class="hs-comment">-- Type-level literals are forbidden from appearing in kinds unless DataKinds</span><span>
</span><span id="line-783"></span><span>  </span><span class="hs-comment">-- is enabled. See Note [Checking for DataKinds].</span><span>
</span><span id="line-784"></span><span>  </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkDataKinds"><span class="hs-identifier hs-var">checkDataKinds</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048711"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048712"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span id="local-6989586621683048714"><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048714"><span class="hs-identifier hs-var">ve</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683048716"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048716"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="annot"><span class="annottext">KindCoercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048714"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048716"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-787"></span><span>
</span><span id="line-788"></span><span class="hs-comment">-- Check for rank-n types, such as (forall x. x -&gt; x) or (Show x =&gt; x).</span><span>
</span><span id="line-789"></span><span class="hs-comment">--</span><span>
</span><span id="line-790"></span><span class="hs-comment">-- Critically, this case must come *after* the case for TyConApp.</span><span>
</span><span id="line-791"></span><span class="hs-comment">-- See Note [Liberal type synonyms].</span><span>
</span><span id="line-792"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span id="local-6989586621683048717"><span class="annot"><span class="annottext">ve :: ValidityEnv
</span><a href="#local-6989586621683048717"><span class="hs-identifier hs-var">ve</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ve_tidy_env :: ValidityEnv -&gt; TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048718"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048718"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-793"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_rank :: ValidityEnv -&gt; Rank
</span><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048719"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048719"><span class="hs-identifier hs-var">rank</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_expand :: ValidityEnv -&gt; ExpandMode
</span><a href="GHC.Tc.Validity.html#ve_expand"><span class="hs-identifier hs-var">ve_expand</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048720"><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048720"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683048721"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048721"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVarBinder] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683048724"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048726"><span class="hs-identifier hs-var">theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-795"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;check_type&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048721"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Rank -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048719"><span class="hs-identifier hs-var">rank</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-796"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (TidyEnv, TcRnMessage) -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rank -&gt; Bool
</span><a href="GHC.Tc.Validity.html#forAllAllowed"><span class="hs-identifier hs-var">forAllAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048719"><span class="hs-identifier hs-var">rank</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TidyEnv, TcRnMessage) -&gt; TcM ())
-&gt; (TidyEnv, TcRnMessage) -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-797"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683048729"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048729"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683048730"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048730"><span class="hs-identifier hs-var">tidy_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; (TidyEnv, Type)
</span><a href="GHC.Core.TyCo.Tidy.html#tidyOpenTypeX"><span class="hs-identifier hs-var">tidyOpenTypeX</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048718"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048721"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-798"></span><span>          </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048729"><span class="hs-identifier hs-var">env1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rank -&gt; Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnForAllRankErr"><span class="hs-identifier hs-var">TcRnForAllRankErr</span></a></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048719"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048730"><span class="hs-identifier hs-var">tidy_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-799"></span><span>                </span><span class="hs-comment">-- Reject e.g. (Maybe (?x::Int =&gt; Int)),</span><span>
</span><span id="line-800"></span><span>                </span><span class="hs-comment">-- with a decent error message</span><span>
</span><span id="line-801"></span><span>
</span><span id="line-802"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; [Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkConstraintsOK"><span class="hs-identifier hs-var">checkConstraintsOK</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048717"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048726"><span class="hs-identifier hs-var">theta</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048721"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-803"></span><span>                </span><span class="hs-comment">-- Reject forall (a :: Eq b =&gt; b). blah</span><span>
</span><span id="line-804"></span><span>                </span><span class="hs-comment">-- In a kind signature we don't allow constraints</span><span>
</span><span id="line-805"></span><span>
</span><span id="line-806"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; [TyVarBinder] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkVdqOK"><span class="hs-identifier hs-var">checkVdqOK</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048717"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683048724"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048721"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-807"></span><span>                </span><span class="hs-comment">-- Reject visible, dependent quantification in the type of a</span><span>
</span><span id="line-808"></span><span>                </span><span class="hs-comment">-- term (e.g., `f :: forall a -&gt; a -&gt; Maybe a`)</span><span>
</span><span id="line-809"></span><span>
</span><span id="line-810"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; UserTypeCtxt -&gt; ExpandMode -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_valid_theta"><span class="hs-identifier hs-var">check_valid_theta</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048735"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048720"><span class="hs-identifier hs-var">expand</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048726"><span class="hs-identifier hs-var">theta</span></a></span><span>
</span><span id="line-811"></span><span>                </span><span class="hs-comment">-- Allow     type T = ?x::Int =&gt; Int -&gt; Int</span><span>
</span><span id="line-812"></span><span>                </span><span class="hs-comment">-- but not   type T = ?x::Int</span><span>
</span><span id="line-813"></span><span>
</span><span id="line-814"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048717"><span class="hs-identifier hs-var">ve</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683048735"><span class="hs-identifier hs-type">env'</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048736"><span class="hs-identifier hs-var">tau</span></a></span><span>
</span><span id="line-815"></span><span>                </span><span class="hs-comment">-- Allow foralls to right of arrow</span><span>
</span><span id="line-816"></span><span>
</span><span id="line-817"></span><span>        </span><span class="hs-comment">-- Note: skolem-escape in types (e.g. forall r (a::r). a) is handled</span><span>
</span><span id="line-818"></span><span>        </span><span class="hs-comment">--       by tcHsSigType and the constraint solver, so no need to</span><span>
</span><span id="line-819"></span><span>        </span><span class="hs-comment">--       check it here; c.f. #20929</span><span>
</span><span id="line-820"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-821"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-822"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683048724"><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683048724"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683048737"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048737"><span class="hs-identifier hs-var">phi</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([TyVarBinder], Type)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitForAllTyVarBinders"><span class="hs-identifier hs-var">tcSplitForAllTyVarBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048721"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-823"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683048726"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048726"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683048736"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048736"><span class="hs-identifier hs-var">tau</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([Type], Type)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitPhiTy"><span class="hs-identifier hs-var">tcSplitPhiTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048737"><span class="hs-identifier hs-var">phi</span></a></span><span>
</span><span id="line-824"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683048735"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048735"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; [TyVarBinder] -&gt; (TidyEnv, [TyVarBinder])
forall vis.
TidyEnv -&gt; [VarBndr Var vis] -&gt; (TidyEnv, [VarBndr Var vis])
</span><a href="GHC.Core.TyCo.Tidy.html#tidyForAllTyBinders"><span class="hs-identifier hs-var">tidyForAllTyBinders</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048718"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683048724"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683048741"><span class="annot"><span class="annottext">ve :: ValidityEnv
</span><a href="#local-6989586621683048741"><span class="hs-identifier hs-var">ve</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ve_tidy_env :: ValidityEnv -&gt; TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048742"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048742"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_ctxt :: ValidityEnv -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048743"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048743"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span>
</span><span id="line-827"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_rank :: ValidityEnv -&gt; Rank
</span><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048744"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048744"><span class="hs-identifier hs-var">rank</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-828"></span><span>           </span><span id="local-6989586621683048745"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683048745"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683048747"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048747"><span class="hs-identifier hs-var">mult</span></a></span></span><span> </span><span id="local-6989586621683048748"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048748"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span> </span><span id="local-6989586621683048749"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048749"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-829"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (TidyEnv, TcRnMessage) -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#failIfTcM"><span class="hs-identifier hs-var">failIfTcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#linearityAllowed"><span class="hs-identifier hs-var">linearityAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048743"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isManyTy"><span class="hs-identifier hs-var">isManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048747"><span class="hs-identifier hs-var">mult</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-830"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048742"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnLinearFuncInKind"><span class="hs-identifier hs-var">TcRnLinearFuncInKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048742"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048745"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-831"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048741"><span class="hs-identifier hs-var">ve</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683048753"><span class="hs-identifier hs-type">arg_rank</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048748"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-832"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048741"><span class="hs-identifier hs-var">ve</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683048754"><span class="hs-identifier hs-type">res_rank</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048749"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-833"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-834"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683048753"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048753"><span class="hs-identifier hs-var">arg_rank</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683048754"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048754"><span class="hs-identifier hs-var">res_rank</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank -&gt; (Rank, Rank)
</span><a href="GHC.Tc.Validity.html#funArgResRank"><span class="hs-identifier hs-var">funArgResRank</span></a></span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048744"><span class="hs-identifier hs-var">rank</span></a></span><span>
</span><span id="line-835"></span><span>
</span><span id="line-836"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683048755"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683048755"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;check_type&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048755"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-837"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683048758"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683048758"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;check_type&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048758"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-840"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_syn_tc_app"><span class="hs-identifier hs-type">check_syn_tc_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span>
</span><span id="line-841"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span class="hs-comment">-- Used for type synonyms and type synonym families,</span><span>
</span><span id="line-843"></span><span class="hs-comment">-- which must be saturated,</span><span>
</span><span id="line-844"></span><span class="hs-comment">-- but not data families, which need not be saturated</span><span>
</span><span id="line-845"></span><span id="check_syn_tc_app"><span class="annot"><span class="annottext">check_syn_tc_app :: ValidityEnv -&gt; Type -&gt; TyCon -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_syn_tc_app"><span class="hs-identifier hs-var hs-var">check_syn_tc_app</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683048761"><span class="annot"><span class="annottext">ve :: ValidityEnv
</span><a href="#local-6989586621683048761"><span class="hs-identifier hs-var">ve</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ve_ctxt :: ValidityEnv -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048762"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048762"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_expand :: ValidityEnv -&gt; ExpandMode
</span><a href="GHC.Tc.Validity.html#ve_expand"><span class="hs-identifier hs-var">ve_expand</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048763"><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048763"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-846"></span><span>                 </span><span id="local-6989586621683048764"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048764"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621683048765"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048765"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683048766"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048766"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-847"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048766"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthAtLeast"><span class="hs-operator hs-var">`lengthAtLeast`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683048768"><span class="hs-identifier hs-var">tc_arity</span></a></span><span>   </span><span class="hs-comment">-- Saturated</span><span>
</span><span id="line-848"></span><span>       </span><span class="hs-comment">-- Check that the synonym has enough args</span><span>
</span><span id="line-849"></span><span>       </span><span class="hs-comment">-- This applies equally to open and closed synonyms</span><span>
</span><span id="line-850"></span><span>       </span><span class="hs-comment">-- It's OK to have an *over-applied* type synonym</span><span>
</span><span id="line-851"></span><span>       </span><span class="hs-comment">--      data Tree a b = ...</span><span>
</span><span id="line-852"></span><span>       </span><span class="hs-comment">--      type Foo a = Tree [a]</span><span>
</span><span id="line-853"></span><span>       </span><span class="hs-comment">--      f :: Foo a b -&gt; ...</span><span>
</span><span id="line-854"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048763"><span class="hs-identifier hs-var">expand</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-855"></span><span>      </span><span class="annot"><span class="annottext">ExpandMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048765"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-856"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExpandMode -&gt; TcM ()
</span><a href="#local-6989586621683048769"><span class="hs-identifier hs-var">check_args_only</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048763"><span class="hs-identifier hs-var">expand</span></a></span><span>
</span><span id="line-857"></span><span>      </span><span class="hs-comment">-- See Note [Correctness and performance of type synonym validity</span><span>
</span><span id="line-858"></span><span>      </span><span class="hs-comment">--           checking]</span><span>
</span><span id="line-859"></span><span>      </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="GHC.Tc.Validity.html#Expand"><span class="hs-identifier hs-var">Expand</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExpandMode -&gt; TcM ()
</span><a href="#local-6989586621683048770"><span class="hs-identifier hs-var">check_expansion_only</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048763"><span class="hs-identifier hs-var">expand</span></a></span><span>
</span><span id="line-860"></span><span>      </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="GHC.Tc.Validity.html#NoExpand"><span class="hs-identifier hs-var">NoExpand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExpandMode -&gt; TcM ()
</span><a href="#local-6989586621683048769"><span class="hs-identifier hs-var">check_args_only</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048763"><span class="hs-identifier hs-var">expand</span></a></span><span>
</span><span id="line-861"></span><span>      </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="GHC.Tc.Validity.html#Both"><span class="hs-identifier hs-var">Both</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExpandMode -&gt; TcM ()
</span><a href="#local-6989586621683048769"><span class="hs-identifier hs-var">check_args_only</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="GHC.Tc.Validity.html#NoExpand"><span class="hs-identifier hs-var">NoExpand</span></a></span><span> </span><span class="annot"><span class="annottext">TcM () -&gt; TcM () -&gt; TcM ()
forall a b.
IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">ExpandMode -&gt; TcM ()
</span><a href="#local-6989586621683048770"><span class="hs-identifier hs-var">check_expansion_only</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="GHC.Tc.Validity.html#Both"><span class="hs-identifier hs-var">Both</span></a></span><span>
</span><span id="line-862"></span><span>
</span><span id="line-863"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GhciCtxt"><span class="hs-identifier hs-type">GhciCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048762"><span class="hs-identifier hs-var">ctxt</span></a></span><span>  </span><span class="hs-comment">-- Accept outermost under-saturated type synonym or</span><span>
</span><span id="line-864"></span><span>                           </span><span class="hs-comment">-- type family constructors in GHCi :kind commands.</span><span>
</span><span id="line-865"></span><span>                           </span><span class="hs-comment">-- See Note [Unsaturated type synonyms in GHCi]</span><span>
</span><span id="line-866"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpandMode -&gt; TcM ()
</span><a href="#local-6989586621683048769"><span class="hs-identifier hs-var">check_args_only</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048763"><span class="hs-identifier hs-var">expand</span></a></span><span>
</span><span id="line-867"></span><span>
</span><span id="line-868"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-869"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; TcRnMessage
</span><a href="GHC.Tc.Validity.html#tyConArityErr"><span class="hs-identifier hs-var">tyConArityErr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048765"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048766"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-871"></span><span>    </span><span id="local-6989586621683048768"><span class="annot"><span class="annottext">tc_arity :: Int
</span><a href="#local-6989586621683048768"><span class="hs-identifier hs-var hs-var">tc_arity</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Int
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048765"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-872"></span><span>
</span><span id="line-873"></span><span>    </span><span class="annot"><a href="#local-6989586621683048773"><span class="hs-identifier hs-type">check_arg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ExpandMode"><span class="hs-identifier hs-type">ExpandMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-874"></span><span>    </span><span id="local-6989586621683048773"><span class="annot"><span class="annottext">check_arg :: ExpandMode -&gt; Type -&gt; TcM ()
</span><a href="#local-6989586621683048773"><span class="hs-identifier hs-var hs-var">check_arg</span></a></span></span><span> </span><span id="local-6989586621683048774"><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048774"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-875"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_arg_type"><span class="hs-identifier hs-var">check_arg_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeSynonymTyCon"><span class="hs-identifier hs-var">isTypeSynonymTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048765"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048761"><span class="hs-identifier hs-var">ve</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Validity.html#ve_expand"><span class="hs-identifier hs-var">ve_expand</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683048774"><span class="hs-identifier hs-type">expand</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-876"></span><span>
</span><span id="line-877"></span><span>    </span><span class="annot"><a href="#local-6989586621683048769"><span class="hs-identifier hs-type">check_args_only</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621683048770"><span class="hs-identifier hs-type">check_expansion_only</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ExpandMode"><span class="hs-identifier hs-type">ExpandMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-878"></span><span>    </span><span id="local-6989586621683048769"><span class="annot"><span class="annottext">check_args_only :: ExpandMode -&gt; TcM ()
</span><a href="#local-6989586621683048769"><span class="hs-identifier hs-var hs-var">check_args_only</span></a></span></span><span> </span><span id="local-6989586621683048775"><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048775"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; TcM ()) -&gt; [Type] -&gt; TcM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpandMode -&gt; Type -&gt; TcM ()
</span><a href="#local-6989586621683048773"><span class="hs-identifier hs-var">check_arg</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048775"><span class="hs-identifier hs-var">expand</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048766"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-879"></span><span>
</span><span id="line-880"></span><span>    </span><span id="local-6989586621683048770"><span class="annot"><span class="annottext">check_expansion_only :: ExpandMode -&gt; TcM ()
</span><a href="#local-6989586621683048770"><span class="hs-identifier hs-var hs-var">check_expansion_only</span></a></span></span><span> </span><span id="local-6989586621683048776"><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048776"><span class="hs-identifier hs-var">expand</span></a></span></span><span>
</span><span id="line-881"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; TcM () -&gt; TcM ()
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeSynonymTyCon"><span class="hs-identifier hs-var">isTypeSynonymTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048765"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048765"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-882"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048764"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-883"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683048779"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048779"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683048780"><span class="annot"><span class="annottext">err_ctxt :: SDoc
</span><a href="#local-6989586621683048780"><span class="hs-identifier hs-var hs-var">err_ctxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the expansion of type synonym&quot;</span></span><span>
</span><span id="line-884"></span><span>                                    </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048765"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-885"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; TcM () -&gt; TcM ()
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621683048780"><span class="hs-identifier hs-var">err_ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-886"></span><span>                        </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048761"><span class="hs-identifier hs-var">ve</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Validity.html#ve_expand"><span class="hs-identifier hs-var">ve_expand</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683048776"><span class="hs-identifier hs-type">expand</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048779"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-887"></span><span>         </span><span class="annot"><span class="annottext">Maybe Type
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;check_syn_tc_app&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048764"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-888"></span><span>
</span><span id="line-889"></span><span class="hs-comment">{-
Note [Unsaturated type synonyms in GHCi]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Generally speaking, GHC disallows unsaturated uses of type synonyms or type
families. For instance, if one defines `type Const a b = a`, then GHC will not
permit using `Const` unless it is applied to (at least) two arguments. There is
an exception to this rule, however: GHCi's :kind command. For instance, it
is quite common to look up the kind of a type constructor like so:

  &#955;&gt; :kind Const
  Const :: j -&gt; k -&gt; j
  &#955;&gt; :kind Const Int
  Const Int :: k -&gt; Type

Strictly speaking, the two uses of `Const` above are unsaturated, but this
is an extremely benign (and useful) example of unsaturation, so we allow it
here as a special case.

That being said, we do not allow unsaturation carte blanche in GHCi. Otherwise,
this GHCi interaction would be possible:

  &#955;&gt; newtype Fix f = MkFix (f (Fix f))
  &#955;&gt; type Id a = a
  &#955;&gt; :kind Fix Id
  Fix Id :: Type

This is rather dodgy, so we move to disallow this. We only permit unsaturated
synonyms in GHCi if they are *top-level*&#8212;that is, if the synonym is the
outermost type being applied. This allows `Const` and `Const Int` in the
first example, but not `Fix Id` in the second example, as `Id` is not the
outermost type being applied (`Fix` is).

We track this outermost property in the GhciCtxt constructor of UserTypeCtxt.
A field of True in GhciCtxt indicates that we're in an outermost position. Any
time we invoke `check_arg` to check the validity of an argument, we switch the
field to False.
-}</span><span>
</span><span id="line-926"></span><span>
</span><span id="line-927"></span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-928"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_ubx_tuple_or_sum"><span class="hs-identifier hs-type">check_ubx_tuple_or_sum</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnboxedTupleOrSum"><span class="hs-identifier hs-type">UnboxedTupleOrSum</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-929"></span><span id="check_ubx_tuple_or_sum"><span class="annot"><span class="annottext">check_ubx_tuple_or_sum :: UnboxedTupleOrSum -&gt; ValidityEnv -&gt; Type -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_ubx_tuple_or_sum"><span class="hs-identifier hs-var hs-var">check_ubx_tuple_or_sum</span></a></span></span><span> </span><span id="local-6989586621683048781"><span class="annot"><span class="annottext">UnboxedTupleOrSum
</span><a href="#local-6989586621683048781"><span class="hs-identifier hs-var">tup_or_sum</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683048782"><span class="annot"><span class="annottext">ve :: ValidityEnv
</span><a href="#local-6989586621683048782"><span class="hs-identifier hs-var">ve</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ve_tidy_env :: ValidityEnv -&gt; TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048783"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048783"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683048784"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048784"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621683048785"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048785"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-930"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048786"><span class="annot"><a href="#local-6989586621683048786"><span class="hs-identifier hs-var">ub_thing_allowed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">(Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool)
-&gt; Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnboxedTupleOrSum -&gt; Extension
</span><a href="GHC.Types.Basic.html#unboxedTupleOrSumExtension"><span class="hs-identifier hs-var">unboxedTupleOrSumExtension</span></a></span><span> </span><span class="annot"><span class="annottext">UnboxedTupleOrSum
</span><a href="#local-6989586621683048781"><span class="hs-identifier hs-var">tup_or_sum</span></a></span><span>
</span><span id="line-931"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#checkTcM"><span class="hs-identifier hs-type">checkTcM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048786"><span class="hs-identifier hs-type">ub_thing_allowed</span></a></span><span>
</span><span id="line-932"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048783"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnUnboxedTupleOrSumTypeFuncArg"><span class="hs-identifier hs-type">TcRnUnboxedTupleOrSumTypeFuncArg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048781"><span class="hs-identifier hs-type">tup_or_sum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-type">tidyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048783"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048784"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-933"></span><span>
</span><span id="line-934"></span><span>          </span><span class="hs-comment">-- Unboxed tuples and sums are forbidden from appearing in kinds</span><span>
</span><span id="line-935"></span><span>          </span><span class="hs-comment">-- unless DataKinds is enabled. See Note [Checking for DataKinds].</span><span>
</span><span id="line-936"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkDataKinds"><span class="hs-identifier hs-type">checkDataKinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048782"><span class="hs-identifier hs-type">ve</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048784"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-937"></span><span>
</span><span id="line-938"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048788"><span class="annot"><a href="#local-6989586621683048788"><span class="hs-identifier hs-var">impred</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-type">xoptM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LangExt.ImpredicativeTypes</span></span><span>
</span><span id="line-939"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683048789"><span class="annot"><a href="#local-6989586621683048789"><span class="hs-identifier hs-var hs-var">rank'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048788"><span class="hs-identifier hs-var">impred</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MonoTypeTyConArg"><span class="hs-identifier hs-var">MonoTypeTyConArg</span></a></span><span>
</span><span id="line-940"></span><span>                </span><span class="hs-comment">-- c.f. check_arg_type</span><span>
</span><span id="line-941"></span><span>                </span><span class="hs-comment">-- However, args are allowed to be unlifted, or</span><span>
</span><span id="line-942"></span><span>                </span><span class="hs-comment">-- more unboxed tuples or sums, so can't use check_arg_ty</span><span>
</span><span id="line-943"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-type">check_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048782"><span class="hs-identifier hs-type">ve</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683048789"><span class="hs-identifier hs-type">rank'</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683048785"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-944"></span><span>
</span><span id="line-945"></span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-946"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_arg_type"><span class="hs-identifier hs-type">check_arg_type</span></a></span><span>
</span><span id="line-947"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Is this the argument to a type synonym?</span></span><span>
</span><span id="line-948"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-949"></span><span class="hs-comment">-- The sort of type that can instantiate a type variable,</span><span>
</span><span id="line-950"></span><span class="hs-comment">-- or be the argument of a type constructor.</span><span>
</span><span id="line-951"></span><span class="hs-comment">-- Not an unboxed tuple, but now *can* be a forall (since impredicativity)</span><span>
</span><span id="line-952"></span><span class="hs-comment">-- Other unboxed types are very occasionally allowed as type</span><span>
</span><span id="line-953"></span><span class="hs-comment">-- arguments depending on the kind of the type constructor</span><span>
</span><span id="line-954"></span><span class="hs-comment">--</span><span>
</span><span id="line-955"></span><span class="hs-comment">-- For example, we want to reject things like:</span><span>
</span><span id="line-956"></span><span class="hs-comment">--</span><span>
</span><span id="line-957"></span><span class="hs-comment">--      instance Ord a =&gt; Ord (forall s. T s a)</span><span>
</span><span id="line-958"></span><span class="hs-comment">-- and</span><span>
</span><span id="line-959"></span><span class="hs-comment">--      g :: T s (forall b.b)</span><span>
</span><span id="line-960"></span><span class="hs-comment">--</span><span>
</span><span id="line-961"></span><span class="hs-comment">-- NB: unboxed tuples can have polymorphic or unboxed args.</span><span>
</span><span id="line-962"></span><span class="hs-comment">--     This happens in the workers for functions returning</span><span>
</span><span id="line-963"></span><span class="hs-comment">--     product types with polymorphic components.</span><span>
</span><span id="line-964"></span><span class="hs-comment">--     But not in user code.</span><span>
</span><span id="line-965"></span><span class="hs-comment">-- Anyway, they are dealt with by a special case in check_tau_type</span><span>
</span><span id="line-966"></span><span>
</span><span id="line-967"></span><span id="check_arg_type"><span class="annot"><span class="annottext">check_arg_type :: Bool -&gt; ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_arg_type"><span class="hs-identifier hs-var hs-var">check_arg_type</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-968"></span><span>
</span><span id="line-969"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_arg_type"><span class="hs-identifier hs-var">check_arg_type</span></a></span><span> </span><span id="local-6989586621683048790"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048790"><span class="hs-identifier hs-var">type_syn</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683048791"><span class="annot"><span class="annottext">ve :: ValidityEnv
</span><a href="#local-6989586621683048791"><span class="hs-identifier hs-var">ve</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ve_ctxt :: ValidityEnv -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048792"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048792"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_rank :: ValidityEnv -&gt; Rank
</span><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048793"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048793"><span class="hs-identifier hs-var">rank</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683048794"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048794"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-970"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048795"><span class="annot"><a href="#local-6989586621683048795"><span class="hs-identifier hs-var">impred</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.ImpredicativeTypes</span></span><span>
</span><span id="line-971"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683048796"><span class="annot"><a href="#local-6989586621683048796"><span class="hs-identifier hs-var hs-var">rank'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048793"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="hs-keyword">of</span><span>          </span><span class="hs-comment">-- Predictive =&gt; must be monotype</span><span>
</span><span id="line-972"></span><span>                        </span><span class="hs-comment">-- Rank-n arguments to type synonyms are OK, provided</span><span>
</span><span id="line-973"></span><span>                        </span><span class="hs-comment">-- that LiberalTypeSynonyms is enabled.</span><span>
</span><span id="line-974"></span><span>                        </span><span class="annot"><span class="annottext">Rank
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048790"><span class="hs-identifier hs-var">type_syn</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MonoTypeSynArg"><span class="hs-identifier hs-var">MonoTypeSynArg</span></a></span><span>
</span><span id="line-975"></span><span>                        </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MustBeMonoType"><span class="hs-identifier hs-var">MustBeMonoType</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MustBeMonoType"><span class="hs-identifier hs-var">MustBeMonoType</span></a></span><span>  </span><span class="hs-comment">-- Monotype, regardless</span><span>
</span><span id="line-976"></span><span>                        </span><span id="local-6989586621683048798"><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048798"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048795"><span class="hs-identifier hs-var">impred</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a></span><span>
</span><span id="line-977"></span><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MonoTypeTyConArg"><span class="hs-identifier hs-var">MonoTypeTyConArg</span></a></span><span>
</span><span id="line-978"></span><span>                        </span><span class="hs-comment">-- Make sure that MustBeMonoType is propagated,</span><span>
</span><span id="line-979"></span><span>                        </span><span class="hs-comment">-- so that we don't suggest -XImpredicativeTypes in</span><span>
</span><span id="line-980"></span><span>                        </span><span class="hs-comment">--    (Ord (forall a.a)) =&gt; a -&gt; a</span><span>
</span><span id="line-981"></span><span>                        </span><span class="hs-comment">-- and so that if it Must be a monotype, we check that it is!</span><span>
</span><span id="line-982"></span><span>              </span><span class="annot"><a href="#local-6989586621683048799"><span class="hs-identifier hs-type">ctxt'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-983"></span><span>              </span><span id="local-6989586621683048799"><span class="annot"><a href="#local-6989586621683048799"><span class="hs-identifier hs-var hs-var">ctxt'</span></a></span></span><span>
</span><span id="line-984"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GhciCtxt"><span class="hs-identifier hs-type">GhciCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048792"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#GhciCtxt"><span class="hs-identifier hs-var">GhciCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-985"></span><span>                    </span><span class="hs-comment">-- When checking an argument, set the field of GhciCtxt to</span><span>
</span><span id="line-986"></span><span>                    </span><span class="hs-comment">-- False to indicate that we are no longer in an outermost</span><span>
</span><span id="line-987"></span><span>                    </span><span class="hs-comment">-- position (and thus unsaturated synonyms are no longer</span><span>
</span><span id="line-988"></span><span>                    </span><span class="hs-comment">-- allowed).</span><span>
</span><span id="line-989"></span><span>                    </span><span class="hs-comment">-- See Note [Unsaturated type synonyms in GHCi]</span><span>
</span><span id="line-990"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048792"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-991"></span><span>
</span><span id="line-992"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-type">check_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048791"><span class="hs-identifier hs-type">ve</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683048799"><span class="hs-identifier hs-type">ctxt'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621683048796"><span class="hs-identifier hs-type">rank'</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683048794"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-993"></span><span>
</span><span id="line-994"></span><span class="hs-comment">----------------------------------------</span><span>
</span><span id="line-995"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkConstraintsOK"><span class="hs-identifier hs-type">checkConstraintsOK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-996"></span><span id="checkConstraintsOK"><span class="annot"><span class="annottext">checkConstraintsOK :: ValidityEnv -&gt; [Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkConstraintsOK"><span class="hs-identifier hs-var hs-var">checkConstraintsOK</span></a></span></span><span> </span><span id="local-6989586621683048801"><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048801"><span class="hs-identifier hs-var">ve</span></a></span></span><span> </span><span id="local-6989586621683048802"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048802"><span class="hs-identifier hs-var">theta</span></a></span></span><span> </span><span id="local-6989586621683048803"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048803"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-997"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048802"><span class="hs-identifier hs-var">theta</span></a></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-998"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#allConstraintsAllowed"><span class="hs-identifier hs-var">allConstraintsAllowed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidityEnv -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048801"><span class="hs-identifier hs-var">ve</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-999"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-comment">-- We are unambiguously in a kind; see</span><span>
</span><span id="line-1000"></span><span>              </span><span class="hs-comment">-- Note [No constraints in kinds]</span><span>
</span><span id="line-1001"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TidyEnv, TcRnMessage) -&gt; TcM ()
forall a. (TidyEnv, TcRnMessage) -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTcM"><span class="hs-identifier hs-var">failWithTcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048804"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnConstraintInKind"><span class="hs-identifier hs-var">TcRnConstraintInKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048804"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048803"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621683048804"><span class="annot"><span class="annottext">env :: TidyEnv
</span><a href="#local-6989586621683048804"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048801"><span class="hs-identifier hs-var">ve</span></a></span><span>
</span><span id="line-1003"></span><span>
</span><span id="line-1004"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkVdqOK"><span class="hs-identifier hs-type">checkVdqOK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVarBinder"><span class="hs-identifier hs-type">TyVarBinder</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1005"></span><span id="checkVdqOK"><span class="annot"><span class="annottext">checkVdqOK :: ValidityEnv -&gt; [TyVarBinder] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkVdqOK"><span class="hs-identifier hs-var hs-var">checkVdqOK</span></a></span></span><span> </span><span id="local-6989586621683048806"><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048806"><span class="hs-identifier hs-var">ve</span></a></span></span><span> </span><span id="local-6989586621683048807"><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683048807"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621683048808"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048808"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1006"></span><span>  </span><span id="local-6989586621683048809"><span class="annot"><a href="#local-6989586621683048809"><span class="hs-identifier hs-var">required_type_arguments</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.RequiredTypeArguments</span></span><span>
</span><span id="line-1007"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#checkTcM"><span class="hs-identifier hs-type">checkTcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048809"><span class="hs-identifier hs-type">required_type_arguments</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#vdqAllowed"><span class="hs-identifier hs-type">vdqAllowed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048811"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="#local-6989586621683048812"><span class="hs-identifier hs-type">no_vdq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1008"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048813"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnVDQInTermType"><span class="hs-identifier hs-type">TcRnVDQInTermType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-type">tidyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048813"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048808"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1009"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1010"></span><span>    </span><span id="local-6989586621683048812"><span class="annot"><span class="annottext">no_vdq :: Bool
</span><a href="#local-6989586621683048812"><span class="hs-identifier hs-var hs-var">no_vdq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TyVarBinder -&gt; Bool) -&gt; [TyVarBinder] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; Bool
</span><a href="Language.Haskell.Syntax.Specificity.html#isInvisibleForAllTyFlag"><span class="hs-identifier hs-var">isInvisibleForAllTyFlag</span></a></span><span> </span><span class="annot"><span class="annottext">(ForAllTyFlag -&gt; Bool)
-&gt; (TyVarBinder -&gt; ForAllTyFlag) -&gt; TyVarBinder -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TyVarBinder -&gt; ForAllTyFlag
forall tv argf. VarBndr tv argf -&gt; argf
</span><a href="GHC.Types.Var.html#binderFlag"><span class="hs-identifier hs-var">binderFlag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621683048807"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-1011"></span><span>    </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ve_tidy_env :: ValidityEnv -&gt; TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048813"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048813"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_ctxt :: ValidityEnv -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048811"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048811"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048806"><span class="hs-identifier hs-var">ve</span></a></span><span>
</span><span id="line-1012"></span><span>
</span><span id="line-1013"></span><span class="hs-comment">-- | Check for a DataKinds violation in a kind context.</span><span>
</span><span id="line-1014"></span><span class="hs-comment">-- See @Note [Checking for DataKinds]@.</span><span>
</span><span id="line-1015"></span><span class="hs-comment">--</span><span>
</span><span id="line-1016"></span><span class="hs-comment">-- Note that emitting DataKinds errors from the typechecker is a fairly recent</span><span>
</span><span id="line-1017"></span><span class="hs-comment">-- addition to GHC (introduced in GHC 9.10), and in order to prevent these new</span><span>
</span><span id="line-1018"></span><span class="hs-comment">-- errors from breaking users' code, we temporarily downgrade these errors to</span><span>
</span><span id="line-1019"></span><span class="hs-comment">-- warnings. (This is why we use 'diagnosticTcM' below.) See</span><span>
</span><span id="line-1020"></span><span class="hs-comment">-- @Note [Checking for DataKinds] (Wrinkle: Migration story for DataKinds</span><span>
</span><span id="line-1021"></span><span class="hs-comment">-- typechecker errors)@.</span><span>
</span><span id="line-1022"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkDataKinds"><span class="hs-identifier hs-type">checkDataKinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1023"></span><span id="checkDataKinds"><span class="annot"><span class="annottext">checkDataKinds :: ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkDataKinds"><span class="hs-identifier hs-var hs-var">checkDataKinds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ve_ctxt :: ValidityEnv -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048820"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048820"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_tidy_env :: ValidityEnv -&gt; TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048821"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048821"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621683048822"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048822"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1024"></span><span>  </span><span id="local-6989586621683048823"><span class="annot"><a href="#local-6989586621683048823"><span class="hs-identifier hs-var">data_kinds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.DataKinds</span></span><span>
</span><span id="line-1025"></span><span>  </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#diagnosticTcM"><span class="hs-identifier hs-type">diagnosticTcM</span></a></span><span>
</span><span id="line-1026"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048823"><span class="hs-identifier hs-type">data_kinds</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">||</span></span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#typeLevelUserTypeCtxt"><span class="hs-identifier hs-type">typeLevelUserTypeCtxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048820"><span class="hs-identifier hs-type">ctxt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-1027"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048821"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnDataKindsError"><span class="hs-identifier hs-type">TcRnDataKindsError</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#KindLevel"><span class="hs-identifier hs-type">KindLevel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-type">tidyType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048821"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048822"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1028"></span><span>
</span><span id="line-1029"></span><span class="hs-comment">{- Note [No constraints in kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
GHC does not allow constraints in kinds. Equality constraints
in kinds were allowed from GHC 8.0, but this &quot;feature&quot; was removed
as part of Proposal #547 (https://github.com/ghc-proposals/ghc-proposals/pull/547),
which contains further context and motivation for the removal.

The lack of constraints in kinds is enforced by checkConstraintsOK, which
uses the UserTypeCtxt to determine if we are unambiguously checking a kind.
There are two ambiguous contexts (constructor BothTypeAndKindCtxt of TypeOrKindCtxt)
as written in typeOfKindCtxt:
  - TySynCtxt: this is the RHS of a type synonym. We check the expansion of type
    synonyms for constraints, so this is handled at the usage site of the synonym.
  - GhciCtxt: This is the type in a :kind command. A constraint here does not cause
    any trouble, because the type cannot be used to classify a type.

Beyond these two cases, we also promote data constructors. We check for constraints
in data constructor types in GHC.Tc.Gen.HsType.tcTyVar.

Note [Liberal type synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If -XLiberalTypeSynonyms is on, expand closed type synonyms *before*
doing validity checking.  This allows us to instantiate a synonym defn
with a for-all type, or with a partially-applied type synonym.
        e.g.   type T a b = a
               type S m   = m ()
               f :: S (T Int)
Here, T is partially applied, so it's illegal in H98.  But if you
expand S first, then T we get just
               f :: Int
which is fine.

IMPORTANT: suppose T is a type synonym.  Then we must do validity
checking on an application (T ty1 ty2)

        *either* before expansion (i.e. check ty1, ty2)
        *or* after expansion (i.e. expand T ty1 ty2, and then check)
        BUT NOT BOTH

If we do both, we get exponential behaviour!!

  data TIACons1 i r c = c i ::: r c
  type TIACons2 t x = TIACons1 t (TIACons1 t x)
  type TIACons3 t x = TIACons2 t (TIACons1 t x)
  type TIACons4 t x = TIACons2 t (TIACons2 t x)
  type TIACons7 t x = TIACons4 t (TIACons3 t x)

The order in which you do validity checking is also somewhat delicate. Consider
the `check_type` function, which drives the validity checking for unsaturated
uses of type synonyms. There is a special case for rank-n types, such as
(forall x. x -&gt; x) or (Show x =&gt; x), since those require at least one language
extension to use. It used to be the case that this case came before every other
case, but this can lead to bugs. Imagine you have this scenario (from #15954):

  type A a = Int
  type B (a :: Type -&gt; Type) = forall x. x -&gt; x
  type C = B A

If the rank-n case came first, then in the process of checking for `forall`s
or contexts, we would expand away `B A` to `forall x. x -&gt; x`. This is because
the functions that split apart `forall`s/contexts
(tcSplitForAllTyVarBinders/tcSplitPhiTy) expand type synonyms! If `B A` is expanded
away to `forall x. x -&gt; x` before the actually validity checks occur, we will
have completely obfuscated the fact that we had an unsaturated application of
the `A` type synonym.

We have since learned from our mistakes and now put this rank-n case /after/
the case for TyConApp, which ensures that an unsaturated `A` TyConApp will be
caught properly. But be careful! We can't make the rank-n case /last/ either,
as the FunTy case must came after the rank-n case. Otherwise, something like
(Eq a =&gt; Int) would be treated as a function type (FunTy), which just
wouldn't do.

Note [Checking for DataKinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Checking whether a piece of code requires -XDataKinds or not is surprisingly
complicated, so here is a specification (adapted from #22141) for what
-XDataKinds does and does not allow. First, some definitions:

* A user-written type (i.e. part of the source text of a program) is in a
  /kind context/ if it follows a `::` in:
  * A standalone kind signature, e.g.,
      type T :: Nat -&gt; Type
  * A kind signature in a type, e.g.:
    - forall (a :: Nat -&gt; Type). blah
    - type F = G :: Nat -&gt; Type
    - etc.
  * A result kind signature in a type declaration, e.g.:
    - data T a :: Nat -&gt; Type where ...
    - type family Fam :: Nat -&gt; Type
    - etc.

* All other contexts where types can appear are referred to as /type contexts/.

* The /kind type constructors/ are (see GHC.Core.TyCon.isKindTyCon):
  * TYPE and Type
  * CONSTRAINT and Constraint
  * LiftedRep
  * RuntimeRep, Levity, and their data constructors
  * Multiplicity and its data construtors
  * VecCount, VecElem, and their data constructors

* A `type data` type constructor is defined using the -XTypeData extension, such
  as the T in `type data T = A | B`.

* The following are rejected in type contexts unless -XDataKinds is enabled:
  * Promoted data constructors (e.g., 'Just), except for those data constructors
    listed under /kind type constructors/
  * Promoted list or tuple syntax (e.g., '[Int, Bool] or '(Int, Bool))
  * Type-level literals (e.g., 42, &quot;hello&quot;, or 'a' at the type level)

* The following are rejected in kind contexts unless -XDataKinds is enabled:
  * Everything that is rejected in a type context.
  * Any type constructor that is not a kind type constructor or a `type data`
    type constructor (e.g., Maybe, [], Char, Nat, Symbol, etc.)

    Note that this includes rejecting occurrences of non-kind type construtors
    in type synomym (or type family) applications, even it the expansion would
    be legal. For example:

      type T a = Type
      f :: forall (x :: T Int). blah

    Here the `Int` in `T Int` is rejected even though the expansion is just
    `Type`. This is consistent with, for example, rejecting `T (forall a. a-&gt;a)`
    without -XImpredicativeTypes.

    This check only occurs in kind contexts. It is always permissible to mention
    type synonyms in a type context without enabling -XDataKinds, even if the
    type synonym expands to something that would otherwise require -XDataKinds.

Because checking for DataKinds in a kind context requires looking beneath type
synonyms, it is natural to implement these checks in checkValidType, which has
the necessary machinery to check for language extensions in the presence of
type synonyms. For the exact same reason, checkValidType is *not* a good place
to check for DataKinds in a type context, since we deliberately do not want to
look beneath type synonyms there. As a result, we check for DataKinds in two
different places in the code:

* We check for DataKinds violations in kind contexts in the typechecker. See
  checkDataKinds in this module.
* We check for DataKinds violations in type contexts in the renamer. See
  checkDataKinds in GHC.Rename.HsType and check_data_kinds in GHC.Rename.Pat.

  Note that the renamer can also catch &quot;obvious&quot; kind-level violations such as
  `data Dat :: Proxy 42 -&gt; Type` (where 42 is not hidden beneath a type
  synonym), so we also catch a subset of kind-level violations in the renamer
  to allow for earlier reporting of these errors.

-----
-- Wrinkle: Migration story for DataKinds typechecker errors
-----

As mentioned above, DataKinds is checked in two different places: the renamer
and the typechecker. The checks in the renamer have been around since DataKinds
was introduced. The checks in the typechecker, on the other hand, are a fairly
recent addition, having been introduced in GHC 9.10. As such, it is possible
that there are some programs in the wild that (1) do not enable DataKinds, and
(2) were accepted by a previous GHC version, but would now be rejected by the
new DataKinds checks in the typechecker.

To prevent the new DataKinds checks in the typechecker from breaking users'
code, we temporarily allow programs to compile if they violate a DataKinds
check in the typechecker, but GHC will emit a warning if such a violation
occurs. Users can then silence the warning by enabling DataKinds in the module
where the affected code lives. It is fairly straightforward to distinguish
between DataKinds violations arising from the renamer versus the typechecker,
as TcRnDataKindsError (the error message type classifying all DataKinds errors)
stores an Either field that is Left when the error comes from the renamer and
Right when the error comes from the typechecker.

************************************************************************
*                                                                      *
\subsection{Checking a theta or source type}
*                                                                      *
************************************************************************

Note [Implicit parameters in instance decls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Implicit parameters _only_ allowed in type signatures; not in instance
decls, superclasses etc. The reason for not allowing implicit params in
instances is a bit subtle.  If we allowed
  instance (?x::Int, Eq a) =&gt; Foo [a] where ...
then when we saw
     (e :: (?x::Int) =&gt; t)
it would be unclear how to discharge all the potential uses of the ?x
in e.  For example, a constraint Foo [Int] might come out of e, and
applying the instance decl would show up two uses of ?x.  #8912.
-}</span><span>
</span><span id="line-1218"></span><span>
</span><span id="line-1219"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidTheta"><span class="hs-identifier hs-type">checkValidTheta</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1220"></span><span class="hs-comment">-- Assumes argument is fully zonked</span><span>
</span><span id="line-1221"></span><span id="checkValidTheta"><span class="annot"><span class="annottext">checkValidTheta :: UserTypeCtxt -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidTheta"><span class="hs-identifier hs-var hs-var">checkValidTheta</span></a></span></span><span> </span><span id="local-6989586621683048827"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048827"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048828"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048828"><span class="hs-identifier hs-var">theta</span></a></span></span><span>
</span><span id="line-1222"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TidyEnv -&gt; ZonkM (TidyEnv, SDoc)) -&gt; TcM () -&gt; TcM ()
forall a. (TidyEnv -&gt; ZonkM (TidyEnv, SDoc)) -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; [Type] -&gt; TidyEnv -&gt; ZonkM (TidyEnv, SDoc)
</span><a href="GHC.Tc.Validity.html#checkThetaCtxt"><span class="hs-identifier hs-var">checkThetaCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048827"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048828"><span class="hs-identifier hs-var">theta</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1223"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048831"><span class="annot"><a href="#local-6989586621683048831"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM TidyEnv -&gt; TcM TidyEnv
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM TidyEnv -&gt; TcM TidyEnv) -&gt; ZonkM TidyEnv -&gt; TcM TidyEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; ZonkM TidyEnv
</span><a href="GHC.Tc.Zonk.TcType.html#tcInitOpenTidyEnv"><span class="hs-identifier hs-var">tcInitOpenTidyEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; [Var]
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypesList"><span class="hs-identifier hs-var">tyCoVarsOfTypesList</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048828"><span class="hs-identifier hs-var">theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1224"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048833"><span class="annot"><a href="#local-6989586621683048833"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#initialExpandMode"><span class="hs-identifier hs-type">initialExpandMode</span></a></span><span>
</span><span id="line-1225"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#check_valid_theta"><span class="hs-identifier hs-type">check_valid_theta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048831"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048827"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048833"><span class="hs-identifier hs-type">expand</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048828"><span class="hs-identifier hs-type">theta</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1226"></span><span>
</span><span id="line-1227"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-1228"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_valid_theta"><span class="hs-identifier hs-type">check_valid_theta</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ExpandMode"><span class="hs-identifier hs-type">ExpandMode</span></a></span><span>
</span><span id="line-1229"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1230"></span><span id="check_valid_theta"><span class="annot"><span class="annottext">check_valid_theta :: TidyEnv -&gt; UserTypeCtxt -&gt; ExpandMode -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_valid_theta"><span class="hs-identifier hs-var hs-var">check_valid_theta</span></a></span></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1231"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1232"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_valid_theta"><span class="hs-identifier hs-var">check_valid_theta</span></a></span><span> </span><span id="local-6989586621683048835"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048835"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621683048836"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048836"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048837"><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048837"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span id="local-6989586621683048838"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048838"><span class="hs-identifier hs-var">theta</span></a></span></span><span>
</span><span id="line-1233"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048839"><span class="annot"><a href="#local-6989586621683048839"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-1234"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;check_valid_theta&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048838"><span class="hs-identifier hs-type">theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1235"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Validity.html#check_pred_ty"><span class="hs-identifier hs-type">check_pred_ty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048835"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048839"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048836"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048837"><span class="hs-identifier hs-type">expand</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683048838"><span class="hs-identifier hs-type">theta</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1236"></span><span>
</span><span id="line-1237"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-1238"></span><span class="hs-comment">{- Note [Validity checking for constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We look through constraint synonyms so that we can see the underlying
constraint(s).  For example
   type Foo = ?x::Int
   instance Foo =&gt; C T
We should reject the instance because it has an implicit parameter in
the context.

But we record, in 'under_syn', whether we have looked under a synonym
to avoid requiring language extensions at the use site.  Main example
(#9838):

   {-# LANGUAGE ConstraintKinds #-}
   module A where
      type EqShow a = (Eq a, Show a)

   module B where
      import A
      foo :: EqShow a =&gt; a -&gt; String

We don't want to require ConstraintKinds in module B.
-}</span><span>
</span><span id="line-1261"></span><span>
</span><span id="line-1262"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_pred_ty"><span class="hs-identifier hs-type">check_pred_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ExpandMode"><span class="hs-identifier hs-type">ExpandMode</span></a></span><span>
</span><span id="line-1263"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1264"></span><span class="hs-comment">-- Check the validity of a predicate in a signature</span><span>
</span><span id="line-1265"></span><span class="hs-comment">-- See Note [Validity checking for constraints]</span><span>
</span><span id="line-1266"></span><span id="check_pred_ty"><span class="annot"><span class="annottext">check_pred_ty :: TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; ExpandMode -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_pred_ty"><span class="hs-identifier hs-var hs-var">check_pred_ty</span></a></span></span><span> </span><span id="local-6989586621683048840"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048840"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621683048841"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048841"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683048842"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048842"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048843"><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048843"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span id="local-6989586621683048844"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048844"><span class="hs-identifier hs-var">pred</span></a></span></span><span>
</span><span id="line-1267"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ValidityEnv -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityEnv
</span><a href="#local-6989586621683048845"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048844"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-1268"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_pred_help"><span class="hs-identifier hs-var">check_pred_help</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048840"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048841"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048842"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048844"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1269"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1270"></span><span>    </span><span id="local-6989586621683048847"><span class="annot"><span class="annottext">rank :: Rank
</span><a href="#local-6989586621683048847"><span class="hs-identifier hs-var hs-var">rank</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.QuantifiedConstraints</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048841"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1271"></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a></span><span>
</span><span id="line-1272"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1273"></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="GHC.Tc.Types.Rank.html#MonoTypeConstraint"><span class="hs-identifier hs-var">MonoTypeConstraint</span></a></span><span>
</span><span id="line-1274"></span><span>
</span><span id="line-1275"></span><span>    </span><span class="annot"><a href="#local-6989586621683048845"><span class="hs-identifier hs-type">ve</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span>
</span><span id="line-1276"></span><span>    </span><span id="local-6989586621683048845"><span class="annot"><span class="annottext">ve :: ValidityEnv
</span><a href="#local-6989586621683048845"><span class="hs-identifier hs-var hs-var">ve</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#ValidityEnv"><span class="hs-identifier hs-type">ValidityEnv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ve_tidy_env :: TidyEnv
</span><a href="GHC.Tc.Validity.html#ve_tidy_env"><span class="hs-identifier hs-var">ve_tidy_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048840"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1277"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_ctxt :: UserTypeCtxt
</span><a href="GHC.Tc.Validity.html#ve_ctxt"><span class="hs-identifier hs-var">ve_ctxt</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a></span><span>
</span><span id="line-1278"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_rank :: Rank
</span><a href="GHC.Tc.Validity.html#ve_rank"><span class="hs-identifier hs-var">ve_rank</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rank
</span><a href="#local-6989586621683048847"><span class="hs-identifier hs-var">rank</span></a></span><span>
</span><span id="line-1279"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ve_expand :: ExpandMode
</span><a href="GHC.Tc.Validity.html#ve_expand"><span class="hs-identifier hs-var">ve_expand</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpandMode
</span><a href="#local-6989586621683048843"><span class="hs-identifier hs-var">expand</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1280"></span><span>
</span><span id="line-1281"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_pred_help"><span class="hs-identifier hs-type">check_pred_help</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>    </span><span class="hs-comment">-- True &lt;=&gt; under a type synonym</span><span>
</span><span id="line-1282"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span>
</span><span id="line-1283"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-1284"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1285"></span><span id="check_pred_help"><span class="annot"><span class="annottext">check_pred_help :: Bool -&gt; TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_pred_help"><span class="hs-identifier hs-var hs-var">check_pred_help</span></a></span></span><span> </span><span id="local-6989586621683048851"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048851"><span class="hs-identifier hs-var">under_syn</span></a></span></span><span> </span><span id="local-6989586621683048852"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048852"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621683048853"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048853"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683048854"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048854"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048855"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048855"><span class="hs-identifier hs-var">pred</span></a></span></span><span>
</span><span id="line-1286"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683048856"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048856"><span class="hs-identifier hs-var">pred'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048855"><span class="hs-identifier hs-var">pred</span></a></span><span>  </span><span class="hs-comment">-- Switch on under_syn when going under a</span><span>
</span><span id="line-1287"></span><span>                                 </span><span class="hs-comment">-- synonym (#9838, yuk)</span><span>
</span><span id="line-1288"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_pred_help"><span class="hs-identifier hs-var">check_pred_help</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048852"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048853"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048854"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048856"><span class="hs-identifier hs-var">pred'</span></a></span><span>
</span><span id="line-1289"></span><span>
</span><span id="line-1290"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- A bit like classifyPredType, but not the same</span><span>
</span><span id="line-1291"></span><span>               </span><span class="hs-comment">-- E.g. we treat (~) like (~#); and we look inside tuples</span><span>
</span><span id="line-1292"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048855"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1293"></span><span>      </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621683048859"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048859"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683048860"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048860"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1294"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isCTupleClass"><span class="hs-identifier hs-var">isCTupleClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048859"><span class="hs-identifier hs-var">cls</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_tuple_pred"><span class="hs-identifier hs-var">check_tuple_pred</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048851"><span class="hs-identifier hs-var">under_syn</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048852"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048853"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048854"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048855"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048860"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1295"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TidyEnv
-&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_class_pred"><span class="hs-identifier hs-var">check_class_pred</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048852"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048853"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048854"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048855"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048859"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048860"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1296"></span><span>
</span><span id="line-1297"></span><span>      </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;check_pred_help&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048855"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1298"></span><span>              </span><span class="hs-comment">-- EqPreds, such as (t1 ~# t2) or (t1 ~R# t2), don't even have kind Constraint</span><span>
</span><span id="line-1299"></span><span>              </span><span class="hs-comment">-- and should never appear before the '=&gt;' of a type.  Thus</span><span>
</span><span id="line-1300"></span><span>              </span><span class="hs-comment">--     f :: (a ~# b) =&gt; blah</span><span>
</span><span id="line-1301"></span><span>              </span><span class="hs-comment">-- is wrong.  For user written signatures, it'll be rejected by kind-checking</span><span>
</span><span id="line-1302"></span><span>              </span><span class="hs-comment">-- well before we get to validity checking.  For inferred types we are careful</span><span>
</span><span id="line-1303"></span><span>              </span><span class="hs-comment">-- to box such constraints in GHC.Tc.Utils.TcType.pickQuantifiablePreds, as described</span><span>
</span><span id="line-1304"></span><span>              </span><span class="hs-comment">-- in Note [Lift equality constraints when quantifying] in GHC.Tc.Solver</span><span>
</span><span id="line-1305"></span><span>
</span><span id="line-1306"></span><span>      </span><span class="annot"><a href="GHC.Core.Predicate.html#ForAllPred"><span class="hs-identifier hs-type">ForAllPred</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683048866"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048866"><span class="hs-identifier hs-var">theta</span></a></span></span><span> </span><span id="local-6989586621683048867"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048867"><span class="hs-identifier hs-var">head</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TidyEnv
-&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; [Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_quant_pred"><span class="hs-identifier hs-var">check_quant_pred</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048852"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048853"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048854"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048855"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048866"><span class="hs-identifier hs-var">theta</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048867"><span class="hs-identifier hs-var">head</span></a></span><span>
</span><span id="line-1307"></span><span>      </span><span class="annot"><span class="annottext">Pred
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1308"></span><span>
</span><span id="line-1309"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_quant_pred"><span class="hs-identifier hs-type">check_quant_pred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-1310"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1311"></span><span id="check_quant_pred"><span class="annot"><span class="annottext">check_quant_pred :: TidyEnv
-&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; [Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_quant_pred"><span class="hs-identifier hs-var hs-var">check_quant_pred</span></a></span></span><span> </span><span id="local-6989586621683048869"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048869"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621683048870"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048870"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683048871"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048871"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048872"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048872"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span id="local-6989586621683048873"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048873"><span class="hs-identifier hs-var">theta</span></a></span></span><span> </span><span id="local-6989586621683048874"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048874"><span class="hs-identifier hs-var">head_pred</span></a></span></span><span>
</span><span id="line-1312"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; TcM () -&gt; TcM ()
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the quantified constraint&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048872"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1313"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Check the instance head</span><span>
</span><span id="line-1314"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048874"><span class="hs-identifier hs-var">head_pred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1315"></span><span>                                 </span><span class="hs-comment">-- SigmaCtxt tells checkValidInstHead that</span><span>
</span><span id="line-1316"></span><span>                                 </span><span class="hs-comment">-- this is the head of a quantified constraint</span><span>
</span><span id="line-1317"></span><span>            </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621683048875"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048875"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683048876"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048876"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidInstHead"><span class="hs-identifier hs-var">checkValidInstHead</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048875"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048876"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1318"></span><span>                                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_pred_help"><span class="hs-identifier hs-var">check_pred_help</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048869"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048870"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048871"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048874"><span class="hs-identifier hs-var">head_pred</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1319"></span><span>                               </span><span class="hs-comment">-- need check_pred_help to do extra pred-only validity</span><span>
</span><span id="line-1320"></span><span>                               </span><span class="hs-comment">-- checks, such as for (~). Otherwise, we get #17563</span><span>
</span><span id="line-1321"></span><span>                               </span><span class="hs-comment">-- NB: checks for the context are covered by the check_type</span><span>
</span><span id="line-1322"></span><span>                               </span><span class="hs-comment">-- in check_pred_ty</span><span>
</span><span id="line-1323"></span><span>            </span><span class="annot"><a href="GHC.Core.Predicate.html#IrredPred"><span class="hs-identifier hs-type">IrredPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#hasTyVarHead"><span class="hs-identifier hs-var">hasTyVarHead</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048874"><span class="hs-identifier hs-var">head_pred</span></a></span><span>
</span><span id="line-1324"></span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1325"></span><span>            </span><span class="annot"><span class="annottext">Pred
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TidyEnv, TcRnMessage) -&gt; TcM ()
forall a. (TidyEnv, TcRnMessage) -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTcM"><span class="hs-identifier hs-var">failWithTcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048869"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnBadQuantPredHead"><span class="hs-identifier hs-var">TcRnBadQuantPredHead</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048869"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048872"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1326"></span><span>
</span><span id="line-1327"></span><span>         </span><span class="hs-comment">-- Check for termination</span><span>
</span><span id="line-1328"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcM () -&gt; TcM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.UndecidableInstances</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048870"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1329"></span><span>         </span><span class="annot"><span class="annottext">[Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkInstTermination"><span class="hs-identifier hs-var">checkInstTermination</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048873"><span class="hs-identifier hs-var">theta</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048874"><span class="hs-identifier hs-var">head_pred</span></a></span><span>
</span><span id="line-1330"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1331"></span><span>
</span><span id="line-1332"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_tuple_pred"><span class="hs-identifier hs-type">check_tuple_pred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1333"></span><span id="check_tuple_pred"><span class="annot"><span class="annottext">check_tuple_pred :: Bool
-&gt; TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_tuple_pred"><span class="hs-identifier hs-var hs-var">check_tuple_pred</span></a></span></span><span> </span><span id="local-6989586621683048882"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048882"><span class="hs-identifier hs-var">under_syn</span></a></span></span><span> </span><span id="local-6989586621683048883"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048883"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621683048884"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048884"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683048885"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048885"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048886"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048886"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span id="local-6989586621683048887"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048887"><span class="hs-identifier hs-var">ts</span></a></span></span><span>
</span><span id="line-1334"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- See Note [ConstraintKinds in predicates]</span><span>
</span><span id="line-1335"></span><span>         </span><span class="annot"><span class="annottext">Bool -&gt; (TidyEnv, TcRnMessage) -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048882"><span class="hs-identifier hs-var">under_syn</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.ConstraintKinds</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048884"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1336"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048883"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalTupleConstraint"><span class="hs-identifier hs-var">TcRnIllegalTupleConstraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048883"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048886"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1337"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; TcM ()) -&gt; [Type] -&gt; TcM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_pred_help"><span class="hs-identifier hs-var">check_pred_help</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048882"><span class="hs-identifier hs-var">under_syn</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048883"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048884"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048885"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048887"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1338"></span><span>    </span><span class="hs-comment">-- This case will not normally be executed because without</span><span>
</span><span id="line-1339"></span><span>    </span><span class="hs-comment">-- -XConstraintKinds tuple types are only kind-checked as *</span><span>
</span><span id="line-1340"></span><span>
</span><span id="line-1341"></span><span class="hs-comment">{- Note [ConstraintKinds in predicates]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Don't check for -XConstraintKinds under a type synonym, because that
was done at the type synonym definition site; see #9838
e.g.   module A where
          type C a = (Eq a, Ix a)   -- Needs -XConstraintKinds
       module B where
          import A
          f :: C a =&gt; a -&gt; a        -- Does *not* need -XConstraintKinds
-}</span><span>
</span><span id="line-1351"></span><span>
</span><span id="line-1352"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-1353"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_class_pred"><span class="hs-identifier hs-type">check_class_pred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-1354"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1355"></span><span id="check_class_pred"><span class="annot"><span class="annottext">check_class_pred :: TidyEnv
-&gt; DynFlags -&gt; UserTypeCtxt -&gt; Type -&gt; Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_class_pred"><span class="hs-identifier hs-var hs-var">check_class_pred</span></a></span></span><span> </span><span id="local-6989586621683048889"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048889"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621683048890"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048890"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683048891"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048891"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048892"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048892"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span id="local-6989586621683048893"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048893"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683048894"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048894"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1356"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isEqualityClass"><span class="hs-identifier hs-var">isEqualityClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048893"><span class="hs-identifier hs-var">cls</span></a></span><span>  </span><span class="hs-comment">-- (~) and (~~) and Coercible are classified as classes,</span><span>
</span><span id="line-1357"></span><span>                         </span><span class="hs-comment">-- but here we want to treat them as equalities</span><span>
</span><span id="line-1358"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Equational constraints are valid in all contexts, and</span><span>
</span><span id="line-1359"></span><span>    </span><span class="hs-comment">-- we do not need to check e.g. for FlexibleContexts here, so just do nothing</span><span>
</span><span id="line-1360"></span><span>    </span><span class="hs-comment">-- We used to require TypeFamilies/GADTs for equality constraints,</span><span>
</span><span id="line-1361"></span><span>    </span><span class="hs-comment">-- but not anymore (GHC Proposal #371)</span><span>
</span><span id="line-1362"></span><span>   </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1363"></span><span>
</span><span id="line-1364"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isIPClass"><span class="hs-identifier hs-var">isIPClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048893"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-1365"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">TcM ()
</span><a href="#local-6989586621683048897"><span class="hs-identifier hs-var">check_arity</span></a></span><span>
</span><span id="line-1366"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (TidyEnv, TcRnMessage) -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048891"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048889"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalImplicitParam"><span class="hs-identifier hs-var">TcRnIllegalImplicitParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048889"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048892"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1367"></span><span>
</span><span id="line-1368"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-comment">-- Includes Coercible</span><span>
</span><span id="line-1369"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">TcM ()
</span><a href="#local-6989586621683048897"><span class="hs-identifier hs-var">check_arity</span></a></span><span>
</span><span id="line-1370"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkSimplifiableClassConstraint"><span class="hs-identifier hs-var">checkSimplifiableClassConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048889"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048890"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048891"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048893"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048894"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1371"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (TidyEnv, TcRnMessage) -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048901"><span class="hs-identifier hs-var">arg_tys_ok</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048889"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnNonTypeVarArgInConstraint"><span class="hs-identifier hs-var">TcRnNonTypeVarArgInConstraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048889"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048892"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1372"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1373"></span><span>    </span><span id="local-6989586621683048897"><span class="annot"><span class="annottext">check_arity :: TcM ()
</span><a href="#local-6989586621683048897"><span class="hs-identifier hs-var hs-var">check_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048894"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthIs"><span class="hs-operator hs-var">`lengthIs`</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Int
</span><a href="GHC.Core.Class.html#classArity"><span class="hs-identifier hs-var">classArity</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048893"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1374"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; TcRnMessage
</span><a href="GHC.Tc.Validity.html#tyConArityErr"><span class="hs-identifier hs-var">tyConArityErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; TyCon
</span><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048893"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048894"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1375"></span><span>
</span><span id="line-1376"></span><span>    </span><span class="hs-comment">-- Check the arguments of a class constraint</span><span>
</span><span id="line-1377"></span><span>    </span><span id="local-6989586621683048907"><span class="annot"><span class="annottext">flexible_contexts :: Bool
</span><a href="#local-6989586621683048907"><span class="hs-identifier hs-var hs-var">flexible_contexts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.FlexibleContexts</span></span><span>     </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048890"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1378"></span><span>    </span><span id="local-6989586621683048901"><span class="annot"><span class="annottext">arg_tys_ok :: Bool
</span><a href="#local-6989586621683048901"><span class="hs-identifier hs-var hs-var">arg_tys_ok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048891"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1379"></span><span>        </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SpecInstCtxt"><span class="hs-identifier hs-var">SpecInstCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>    </span><span class="hs-comment">-- {-# SPECIALISE instance Eq (T Int) #-} is fine</span><span>
</span><span id="line-1380"></span><span>        </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InstDeclCtxt"><span class="hs-identifier hs-type">InstDeclCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Class -&gt; [Type] -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#checkValidClsArgs"><span class="hs-identifier hs-var">checkValidClsArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048907"><span class="hs-identifier hs-var">flexible_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048893"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048894"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1381"></span><span>                                </span><span class="hs-comment">-- Further checks on head and theta</span><span>
</span><span id="line-1382"></span><span>                                </span><span class="hs-comment">-- in checkInstTermination</span><span>
</span><span id="line-1383"></span><span>        </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Class -&gt; [Type] -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#checkValidClsArgs"><span class="hs-identifier hs-var">checkValidClsArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048907"><span class="hs-identifier hs-var">flexible_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048893"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048894"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1384"></span><span>
</span><span id="line-1385"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkSimplifiableClassConstraint"><span class="hs-identifier hs-type">checkSimplifiableClassConstraint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-1386"></span><span>                                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1387"></span><span class="hs-comment">-- See Note [Simplifiable given constraints]</span><span>
</span><span id="line-1388"></span><span id="checkSimplifiableClassConstraint"><span class="annot"><span class="annottext">checkSimplifiableClassConstraint :: TidyEnv -&gt; DynFlags -&gt; UserTypeCtxt -&gt; Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkSimplifiableClassConstraint"><span class="hs-identifier hs-var hs-var">checkSimplifiableClassConstraint</span></a></span></span><span> </span><span id="local-6989586621683048910"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048910"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621683048911"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048911"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683048912"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048912"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048913"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048913"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683048914"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048914"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1389"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WarningFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#wopt"><span class="hs-identifier hs-var">wopt</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag
</span><a href="GHC.Driver.Flags.html#Opt_WarnSimplifiableClassConstraints"><span class="hs-identifier hs-var">Opt_WarnSimplifiableClassConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048911"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1390"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1391"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.MonoLocalBinds</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048911"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1392"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1393"></span><span>
</span><span id="line-1394"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#DataTyCtxt"><span class="hs-identifier hs-type">DataTyCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048912"><span class="hs-identifier hs-var">ctxt</span></a></span><span>   </span><span class="hs-comment">-- Don't do this check for the &quot;stupid theta&quot;</span><span>
</span><span id="line-1395"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>               </span><span class="hs-comment">-- of a data type declaration</span><span>
</span><span id="line-1396"></span><span>
</span><span id="line-1397"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048913"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#coercibleTyConKey"><span class="hs-identifier hs-var">coercibleTyConKey</span></a></span><span>
</span><span id="line-1398"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Oddly, we treat (Coercible t1 t2) as unconditionally OK</span><span>
</span><span id="line-1399"></span><span>                </span><span class="hs-comment">-- matchGlobalInst will reply &quot;yes&quot; because we can reduce</span><span>
</span><span id="line-1400"></span><span>                </span><span class="hs-comment">-- (Coercible a b) to (a ~R# b)</span><span>
</span><span id="line-1401"></span><span>
</span><span id="line-1402"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1403"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048920"><span class="annot"><a href="#local-6989586621683048920"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Bool -&gt; Class -&gt; [Type] -&gt; TcM ClsInstResult
</span><a href="GHC.Tc.Instance.Class.html#matchGlobalInst"><span class="hs-identifier hs-var">matchGlobalInst</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048911"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048913"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048914"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1404"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621683048920"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1405"></span><span>           </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cir_what :: ClsInstResult -&gt; InstanceWhat
</span><a href="GHC.Tc.Instance.Class.html#cir_what"><span class="hs-identifier hs-var">cir_what</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683048923"><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621683048923"><span class="hs-identifier hs-var">what</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1406"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#addDiagnosticTc"><span class="hs-identifier hs-var">addDiagnosticTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; InstanceWhat -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnSimplifiableConstraint"><span class="hs-identifier hs-var">TcRnSimplifiableConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683048926"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621683048923"><span class="hs-identifier hs-var">what</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1407"></span><span>           </span><span class="annot"><span class="annottext">ClsInstResult
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1408"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1409"></span><span>    </span><span id="local-6989586621683048926"><span class="annot"><span class="annottext">pred :: Type
</span><a href="#local-6989586621683048926"><span class="hs-identifier hs-var hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048910"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048913"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048914"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1410"></span><span>
</span><span id="line-1411"></span><span class="hs-comment">{- Note [Simplifiable given constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A type signature like
   f :: Eq [(a,b)] =&gt; a -&gt; b
is very fragile, for reasons described at length in GHC.Tc.Solver.Dict
Note [Instance and Given overlap].  As that Note discusses, for the
most part the clever stuff in GHC.Tc.Solver.Dict means that we don't use a
top-level instance if a local Given might fire, so there is no
fragility. But if we /infer/ the type of a local let-binding, things
can go wrong (#11948 is an example, discussed in the Note).

So this warning is switched on only if we have NoMonoLocalBinds; in
that case the warning discourages users from writing simplifiable
class constraints.

The warning only fires if the constraint in the signature
matches the top-level instances in only one way, and with no
unifiers -- that is, under the same circumstances that
GHC.Tc.Instance.Class.matchInstEnv fires an interaction with the top
level instances.  For example (#13526), consider

  instance {-# OVERLAPPABLE #-} Eq (T a) where ...
  instance                   Eq (T Char) where ..
  f :: Eq (T a) =&gt; ...

We don't want to complain about this, even though the context
(Eq (T a)) matches an instance, because the user may be
deliberately deferring the choice so that the Eq (T Char)
has a chance to fire when 'f' is called.  And the fragility
only matters when there's a risk that the instance might
fire instead of the local 'given'; and there is no such
risk in this case.  Just use the same rules as for instance
firing!
-}</span><span>
</span><span id="line-1445"></span><span>
</span><span id="line-1446"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-1447"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-type">okIPCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1448"></span><span>  </span><span class="hs-comment">-- See Note [Implicit parameters in instance decls]</span><span>
</span><span id="line-1449"></span><span id="okIPCtxt"><span class="annot"><span class="annottext">okIPCtxt :: UserTypeCtxt -&gt; Bool
</span><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var hs-var">okIPCtxt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FunSigCtxt"><span class="hs-identifier hs-type">FunSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1450"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InfSigCtxt"><span class="hs-identifier hs-type">InfSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1451"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ExprSigCtxt"><span class="hs-identifier hs-type">ExprSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1452"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#TypeAppCtxt"><span class="hs-identifier hs-var">TypeAppCtxt</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1453"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#PatSigCtxt"><span class="hs-identifier hs-var">PatSigCtxt</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1454"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1455"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ConArgCtxt"><span class="hs-identifier hs-type">ConArgCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1456"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ForSigCtxt"><span class="hs-identifier hs-type">ForSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-comment">-- ??</span><span>
</span><span id="line-1457"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GhciCtxt"><span class="hs-identifier hs-type">GhciCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1458"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1459"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#DataTyCtxt"><span class="hs-identifier hs-type">DataTyCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1460"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#PatSynCtxt"><span class="hs-identifier hs-type">PatSynCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1461"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TySynCtxt"><span class="hs-identifier hs-type">TySynCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- e.g.   type Blah = ?x::Int</span><span>
</span><span id="line-1462"></span><span>                                         </span><span class="hs-comment">-- #11466</span><span>
</span><span id="line-1463"></span><span>
</span><span id="line-1464"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#KindSigCtxt"><span class="hs-identifier hs-type">KindSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1465"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#StandaloneKindSigCtxt"><span class="hs-identifier hs-type">StandaloneKindSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1466"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ClassSCCtxt"><span class="hs-identifier hs-type">ClassSCCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1467"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InstDeclCtxt"><span class="hs-identifier hs-type">InstDeclCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1468"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#SpecInstCtxt"><span class="hs-identifier hs-type">SpecInstCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1469"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#RuleSigCtxt"><span class="hs-identifier hs-type">RuleSigCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1470"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#DefaultDeclCtxt"><span class="hs-identifier hs-var">DefaultDeclCtxt</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1471"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#DerivClauseCtxt"><span class="hs-identifier hs-var">DerivClauseCtxt</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1472"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TyVarBndrKindCtxt"><span class="hs-identifier hs-type">TyVarBndrKindCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1473"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#DataKindCtxt"><span class="hs-identifier hs-type">DataKindCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1474"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TySynKindCtxt"><span class="hs-identifier hs-type">TySynKindCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1475"></span><span class="annot"><a href="GHC.Tc.Validity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#TyFamResKindCtxt"><span class="hs-identifier hs-type">TyFamResKindCtxt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1476"></span><span>
</span><span id="line-1477"></span><span class="hs-comment">{-
Note [Kind polymorphic type classes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
MultiParam check:

    class C f where...   -- C :: forall k. k -&gt; Constraint
    instance C Maybe where...

  The dictionary gets type [C * Maybe] even if it's not a MultiParam
  type class.

Flexibility check:

    class C f where...   -- C :: forall k. k -&gt; Constraint
    data D a = D a
    instance C D where

  The dictionary gets type [C * (D *)]. IA0_TODO it should be
  generalized actually.
-}</span><span>
</span><span id="line-1497"></span><span>
</span><span id="line-1498"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkThetaCtxt"><span class="hs-identifier hs-type">checkThetaCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Zonk.Monad.html#ZonkM"><span class="hs-identifier hs-type">ZonkM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1499"></span><span id="checkThetaCtxt"><span class="annot"><span class="annottext">checkThetaCtxt :: UserTypeCtxt -&gt; [Type] -&gt; TidyEnv -&gt; ZonkM (TidyEnv, SDoc)
</span><a href="GHC.Tc.Validity.html#checkThetaCtxt"><span class="hs-identifier hs-var hs-var">checkThetaCtxt</span></a></span></span><span> </span><span id="local-6989586621683048928"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048928"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048929"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048929"><span class="hs-identifier hs-var">theta</span></a></span></span><span> </span><span id="local-6989586621683048930"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048930"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-1500"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TidyEnv, SDoc) -&gt; ZonkM (TidyEnv, SDoc)
forall a. a -&gt; ZonkM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048930"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1501"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In the context:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; SDoc
</span><a href="GHC.Core.TyCo.Ppr.html#pprTheta"><span class="hs-identifier hs-var">pprTheta</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TidyEnv -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Tidy.html#tidyTypes"><span class="hs-identifier hs-var">tidyTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683048930"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048929"><span class="hs-identifier hs-var">theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1502"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;While checking&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; SDoc
</span><a href="GHC.Tc.Types.Origin.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048928"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1503"></span><span>
</span><span id="line-1504"></span><span class="annot"><a href="GHC.Tc.Validity.html#tyConArityErr"><span class="hs-identifier hs-type">tyConArityErr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnMessage"><span class="hs-identifier hs-type">TcRnMessage</span></a></span><span>
</span><span id="line-1505"></span><span class="hs-comment">-- For type-constructor arity errors, be careful to report</span><span>
</span><span id="line-1506"></span><span class="hs-comment">-- the number of /visible/ arguments required and supplied,</span><span>
</span><span id="line-1507"></span><span class="hs-comment">-- ignoring the /invisible/ arguments, which the user does not see.</span><span>
</span><span id="line-1508"></span><span class="hs-comment">-- (e.g. #10516)</span><span>
</span><span id="line-1509"></span><span id="tyConArityErr"><span class="annot"><span class="annottext">tyConArityErr :: TyCon -&gt; [Type] -&gt; TcRnMessage
</span><a href="GHC.Tc.Validity.html#tyConArityErr"><span class="hs-identifier hs-var hs-var">tyConArityErr</span></a></span></span><span> </span><span id="local-6989586621683048933"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048933"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683048934"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048934"><span class="hs-identifier hs-var">tks</span></a></span></span><span>
</span><span id="line-1510"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyThing -&gt; Int -&gt; Int -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnArityMismatch"><span class="hs-identifier hs-var">TcRnArityMismatch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; TyThing
</span><a href="GHC.Types.TyThing.html#ATyCon"><span class="hs-identifier hs-var">ATyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048933"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683048937"><span class="hs-identifier hs-var">tc_type_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683048938"><span class="hs-identifier hs-var">tc_type_args</span></a></span><span>
</span><span id="line-1511"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1512"></span><span>    </span><span id="local-6989586621683048939"><span class="annot"><span class="annottext">vis_tks :: [Type]
</span><a href="#local-6989586621683048939"><span class="hs-identifier hs-var hs-var">vis_tks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048933"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048934"><span class="hs-identifier hs-var">tks</span></a></span><span>
</span><span id="line-1513"></span><span>
</span><span id="line-1514"></span><span>    </span><span class="hs-comment">-- tc_type_arity = number of *type* args expected</span><span>
</span><span id="line-1515"></span><span>    </span><span class="hs-comment">-- tc_type_args  = number of *type* args encountered</span><span>
</span><span id="line-1516"></span><span>    </span><span id="local-6989586621683048937"><span class="annot"><span class="annottext">tc_type_arity :: Int
</span><a href="#local-6989586621683048937"><span class="hs-identifier hs-var hs-var">tc_type_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarBndr Var TyConBndrVis -&gt; Bool)
-&gt; [VarBndr Var TyConBndrVis] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">VarBndr Var TyConBndrVis -&gt; Bool
forall tv. VarBndr tv TyConBndrVis -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isVisibleTyConBinder"><span class="hs-identifier hs-var">isVisibleTyConBinder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [VarBndr Var TyConBndrVis]
</span><a href="GHC.Core.TyCon.html#tyConBinders"><span class="hs-identifier hs-var">tyConBinders</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683048933"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1517"></span><span>    </span><span id="local-6989586621683048938"><span class="annot"><span class="annottext">tc_type_args :: Int
</span><a href="#local-6989586621683048938"><span class="hs-identifier hs-var hs-var">tc_type_args</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048939"><span class="hs-identifier hs-var">vis_tks</span></a></span><span>
</span><span id="line-1518"></span><span>
</span><span id="line-1519"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Checking for a decent instance head type}
*                                                                      *
************************************************************************

@checkValidInstHead@ checks the type {\em and} its syntactic constraints:
it must normally look like: @instance Foo (Tycon a b c ...) ...@

The exceptions to this syntactic checking: (1)~if the @GlasgowExts@
flag is on, or (2)~the instance is imported (they must have been
compiled elsewhere). In these cases, we let them go through anyway.

We can also have instances for functions: @instance Foo (a -&gt; b) ...@.
-}</span><span>
</span><span id="line-1535"></span><span>
</span><span id="line-1536"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidInstHead"><span class="hs-identifier hs-type">checkValidInstHead</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1537"></span><span id="checkValidInstHead"><span class="annot"><span class="annottext">checkValidInstHead :: UserTypeCtxt -&gt; Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidInstHead"><span class="hs-identifier hs-var hs-var">checkValidInstHead</span></a></span></span><span> </span><span id="local-6989586621683048945"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048945"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048946"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048946"><span class="hs-identifier hs-var">clas</span></a></span></span><span> </span><span id="local-6989586621683048947"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048947"><span class="hs-identifier hs-var">cls_args</span></a></span></span><span>
</span><span id="line-1538"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683048948"><span class="annot"><a href="#local-6989586621683048948"><span class="hs-identifier hs-var">dflags</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-1539"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683048949"><span class="annot"><a href="#local-6989586621683048949"><span class="hs-identifier hs-var">hsc_src</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#tcHscSource"><span class="hs-identifier hs-type">tcHscSource</span></a></span><span>
</span><span id="line-1540"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#check_special_inst_head"><span class="hs-identifier hs-type">check_special_inst_head</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048948"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048949"><span class="hs-identifier hs-type">hsc_src</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048945"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048946"><span class="hs-identifier hs-type">clas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048947"><span class="hs-identifier hs-type">cls_args</span></a></span><span>
</span><span id="line-1541"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidTypePats"><span class="hs-identifier hs-type">checkValidTypePats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048946"><span class="hs-identifier hs-type">clas</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621683048947"><span class="hs-identifier hs-type">cls_args</span></a></span><span>
</span><span id="line-1542"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1543"></span><span>
</span><span id="line-1544"></span><span class="hs-comment">{-

Note [Instances of built-in classes in signature files]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

User defined instances for KnownNat, KnownSymbol, KnownChar,
and Typeable are disallowed
  -- they are generated when needed by GHC itself, on-the-fly.

However, if they occur in a Backpack signature file, they have an
entirely different meaning. To illustrate, suppose in M.hsig we see

  signature M where
    data T :: Nat
    instance KnownNat T

That says that any module satisfying M.hsig must provide a KnownNat
instance for T.  We absolutely need that instance when compiling a
module that imports M.hsig: see #15379 and
Note [Fabricating Evidence for Literals in Backpack] in GHC.Tc.Instance.Class.

Hence, checkValidInstHead accepts a user-written instance declaration
in hsig files, where `is_sig` is True.

-}</span><span>
</span><span id="line-1569"></span><span>
</span><span id="line-1570"></span><span class="annot"><a href="GHC.Tc.Validity.html#check_special_inst_head"><span class="hs-identifier hs-type">check_special_inst_head</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SourceFile.html#HscSource"><span class="hs-identifier hs-type">HscSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span>
</span><span id="line-1571"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1572"></span><span class="hs-comment">-- Wow!  There are a surprising number of ad-hoc special cases here.</span><span>
</span><span id="line-1573"></span><span class="hs-comment">-- TODO: common up the logic for special typeclasses (see GHC ticket #20441).</span><span>
</span><span id="line-1574"></span><span id="check_special_inst_head"><span class="annot"><span class="annottext">check_special_inst_head :: DynFlags -&gt; HscSource -&gt; UserTypeCtxt -&gt; Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#check_special_inst_head"><span class="hs-identifier hs-var hs-var">check_special_inst_head</span></a></span></span><span> </span><span id="local-6989586621683048953"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048953"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621683048954"><span class="annot"><span class="annottext">HscSource
</span><a href="#local-6989586621683048954"><span class="hs-identifier hs-var">hs_src</span></a></span></span><span> </span><span id="local-6989586621683048955"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048955"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683048956"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span></span><span> </span><span id="local-6989586621683048957"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048957"><span class="hs-identifier hs-var">cls_args</span></a></span></span><span>
</span><span id="line-1575"></span><span>
</span><span id="line-1576"></span><span>  </span><span class="hs-comment">-- Abstract classes cannot have instances, except in hs-boot or signature files.</span><span>
</span><span id="line-1577"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Core.Class.html#isAbstractClass"><span class="hs-identifier hs-var">isAbstractClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span>
</span><span id="line-1578"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HscSource
</span><a href="#local-6989586621683048954"><span class="hs-identifier hs-var">hs_src</span></a></span><span> </span><span class="annot"><span class="annottext">HscSource -&gt; HscSource -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">HscSource
</span><a href="GHC.Types.SourceFile.html#HsSrcFile"><span class="hs-identifier hs-var">HsSrcFile</span></a></span><span>
</span><span id="line-1579"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason -&gt; TcM ()
</span><a href="#local-6989586621683048960"><span class="hs-identifier hs-var">fail_with_inst_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; TcM ())
-&gt; IllegalClassInstanceReason -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalInstanceHead"><span class="hs-identifier hs-var">IllegalInstanceHead</span></a></span><span>
</span><span id="line-1580"></span><span>                       </span><span class="annot"><span class="annottext">(IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason)
-&gt; IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Class -&gt; IllegalInstanceHeadReason
</span><a href="GHC.Tc.Errors.Types.html#InstHeadAbstractClass"><span class="hs-identifier hs-var">InstHeadAbstractClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span>
</span><span id="line-1581"></span><span>
</span><span id="line-1582"></span><span>  </span><span class="hs-comment">-- Complain about hand-written instances of built-in classes</span><span>
</span><span id="line-1583"></span><span>  </span><span class="hs-comment">-- Typeable, KnownNat, KnownSymbol, Coercible, HasField.</span><span>
</span><span id="line-1584"></span><span>
</span><span id="line-1585"></span><span>  </span><span class="hs-comment">-- Disallow hand-written Typeable instances, except that we</span><span>
</span><span id="line-1586"></span><span>  </span><span class="hs-comment">-- allow a standalone deriving declaration: they are no-ops,</span><span>
</span><span id="line-1587"></span><span>  </span><span class="hs-comment">-- and we warn about them in GHC.Tc.Deriv.deriveStandalone.</span><span>
</span><span id="line-1588"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683048963"><span class="hs-identifier hs-var">clas_nm</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#typeableClassName"><span class="hs-identifier hs-var">typeableClassName</span></a></span><span>
</span><span id="line-1589"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscSource
</span><a href="#local-6989586621683048954"><span class="hs-identifier hs-var">hs_src</span></a></span><span> </span><span class="annot"><span class="annottext">HscSource -&gt; HscSource -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">HscSource
</span><a href="GHC.Types.SourceFile.html#HsigFile"><span class="hs-identifier hs-var">HsigFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1590"></span><span>    </span><span class="hs-comment">-- Note [Instances of built-in classes in signature files]</span><span>
</span><span id="line-1591"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048966"><span class="hs-identifier hs-var">hand_written_bindings</span></a></span><span>
</span><span id="line-1592"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason -&gt; TcM ()
</span><a href="#local-6989586621683048960"><span class="hs-identifier hs-var">fail_with_inst_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; TcM ())
-&gt; IllegalClassInstanceReason -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalSpecialClassInstance"><span class="hs-identifier hs-var">IllegalSpecialClassInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1593"></span><span>
</span><span id="line-1594"></span><span>  </span><span class="hs-comment">-- Handwritten instances of KnownNat/KnownChar/KnownSymbol</span><span>
</span><span id="line-1595"></span><span>  </span><span class="hs-comment">-- are forbidden outside of signature files (#12837).</span><span>
</span><span id="line-1596"></span><span>  </span><span class="hs-comment">-- Derived instances are forbidden completely (#21087).</span><span>
</span><span id="line-1597"></span><span>     </span><span class="hs-comment">-- FIXME: DataToTag instances in signature files don't actually work yet</span><span>
</span><span id="line-1598"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683048963"><span class="hs-identifier hs-var">clas_nm</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Name] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#knownNatClassName"><span class="hs-identifier hs-var">knownNatClassName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#knownSymbolClassName"><span class="hs-identifier hs-var">knownSymbolClassName</span></a></span><span>
</span><span id="line-1599"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#knownCharClassName"><span class="hs-identifier hs-var">knownCharClassName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#dataToTagClassName"><span class="hs-identifier hs-var">dataToTagClassName</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1600"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscSource
</span><a href="#local-6989586621683048954"><span class="hs-identifier hs-var">hs_src</span></a></span><span> </span><span class="annot"><span class="annottext">HscSource -&gt; HscSource -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">HscSource
</span><a href="GHC.Types.SourceFile.html#HsigFile"><span class="hs-identifier hs-var">HsigFile</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048966"><span class="hs-identifier hs-var">hand_written_bindings</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048973"><span class="hs-identifier hs-var">derived_instance</span></a></span><span>
</span><span id="line-1601"></span><span>    </span><span class="hs-comment">-- Note [Instances of built-in classes in signature files]</span><span>
</span><span id="line-1602"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason -&gt; TcM ()
</span><a href="#local-6989586621683048960"><span class="hs-identifier hs-var">fail_with_inst_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; TcM ())
-&gt; IllegalClassInstanceReason -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalSpecialClassInstance"><span class="hs-identifier hs-var">IllegalSpecialClassInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1603"></span><span>
</span><span id="line-1604"></span><span>  </span><span class="hs-comment">-- For the most part we don't allow</span><span>
</span><span id="line-1605"></span><span>  </span><span class="hs-comment">-- instances for (~), (~~), or Coercible;</span><span>
</span><span id="line-1606"></span><span>  </span><span class="hs-comment">-- but we DO want to allow them in quantified constraints:</span><span>
</span><span id="line-1607"></span><span>  </span><span class="hs-comment">--   f :: (forall a b. Coercible a b =&gt; Coercible (m a) (m b)) =&gt; ...m...</span><span>
</span><span id="line-1608"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683048963"><span class="hs-identifier hs-var">clas_nm</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Name] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span>
</span><span id="line-1609"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Types.html#heqTyConName"><span class="hs-identifier hs-var">heqTyConName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Types.html#eqTyConName"><span class="hs-identifier hs-var">eqTyConName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Types.html#coercibleTyConName"><span class="hs-identifier hs-var">coercibleTyConName</span></a></span><span>
</span><span id="line-1610"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#withDictClassName"><span class="hs-identifier hs-var">withDictClassName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#unsatisfiableClassName"><span class="hs-identifier hs-var">unsatisfiableClassName</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1611"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048979"><span class="hs-identifier hs-var">quantified_constraint</span></a></span><span>
</span><span id="line-1612"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason -&gt; TcM ()
</span><a href="#local-6989586621683048960"><span class="hs-identifier hs-var">fail_with_inst_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; TcM ())
-&gt; IllegalClassInstanceReason -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalSpecialClassInstance"><span class="hs-identifier hs-var">IllegalSpecialClassInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1613"></span><span>
</span><span id="line-1614"></span><span>  </span><span class="hs-comment">-- Check for hand-written Generic instances (disallowed in Safe Haskell)</span><span>
</span><span id="line-1615"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683048963"><span class="hs-identifier hs-var">clas_nm</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Name] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="GHC.Builtin.Names.html#genericClassNames"><span class="hs-identifier hs-var">genericClassNames</span></a></span><span>
</span><span id="line-1616"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048966"><span class="hs-identifier hs-var">hand_written_bindings</span></a></span><span>
</span><span id="line-1617"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcM () -&gt; TcM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#safeLanguageOn"><span class="hs-identifier hs-var">safeLanguageOn</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048953"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1618"></span><span>           </span><span class="annot"><span class="annottext">IllegalClassInstanceReason -&gt; TcM ()
</span><a href="#local-6989586621683048960"><span class="hs-identifier hs-var">fail_with_inst_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; TcM ())
-&gt; IllegalClassInstanceReason -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalSpecialClassInstance"><span class="hs-identifier hs-var">IllegalSpecialClassInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1619"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcM () -&gt; TcM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#safeInferOn"><span class="hs-identifier hs-var">safeInferOn</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048953"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Messages TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#recordUnsafeInfer"><span class="hs-identifier hs-var">recordUnsafeInfer</span></a></span><span> </span><span class="annot"><span class="annottext">Messages TcRnMessage
forall e. Messages e
</span><a href="GHC.Types.Error.html#emptyMessages"><span class="hs-identifier hs-var">emptyMessages</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1620"></span><span>
</span><span id="line-1621"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683048963"><span class="hs-identifier hs-var">clas_nm</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#hasFieldClassName"><span class="hs-identifier hs-var">hasFieldClassName</span></a></span><span>
</span><span id="line-1622"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048979"><span class="hs-identifier hs-var">quantified_constraint</span></a></span><span>
</span><span id="line-1623"></span><span>  </span><span class="hs-comment">-- Don't do any validity checking for HasField contexts</span><span>
</span><span id="line-1624"></span><span>  </span><span class="hs-comment">-- inside quantified constraints (#20989): the validity checks</span><span>
</span><span id="line-1625"></span><span>  </span><span class="hs-comment">-- only apply to user-written instances.</span><span>
</span><span id="line-1626"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkHasFieldInst"><span class="hs-identifier hs-var">checkHasFieldInst</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048957"><span class="hs-identifier hs-var">cls_args</span></a></span><span>
</span><span id="line-1627"></span><span>
</span><span id="line-1628"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isCTupleClass"><span class="hs-identifier hs-var">isCTupleClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span>
</span><span id="line-1629"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1630"></span><span>    </span><span class="hs-comment">-- Since we're now declaring instances for constraint tuples in</span><span>
</span><span id="line-1631"></span><span>    </span><span class="hs-comment">-- GHC.Classes, this check must exclude that file.</span><span>
</span><span id="line-1632"></span><span>    </span><span id="local-6989586621683048987"><span class="annot"><a href="#local-6989586621683048987"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; Module)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) TcGblEnv
-&gt; IOEnv (Env TcGblEnv TcLclEnv) Module
forall a b.
(a -&gt; b)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) a
-&gt; IOEnv (Env TcGblEnv TcLclEnv) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; Module
</span><a href="GHC.Tc.Types.html#tcg_mod"><span class="hs-identifier hs-var">tcg_mod</span></a></span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) TcGblEnv
forall gbl lcl. TcRnIf gbl lcl gbl
</span><a href="GHC.Tc.Utils.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-1633"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621683048987"><span class="hs-identifier hs-type">this_mod</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">/=</span></span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#gHC_CLASSES"><span class="hs-identifier hs-type">gHC_CLASSES</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-type">failWithTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnTupleConstraintInst"><span class="hs-identifier hs-type">TcRnTupleConstraintInst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683048956"><span class="hs-identifier hs-type">clas</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1634"></span><span>
</span><span id="line-1635"></span><span>  </span><span class="hs-comment">-- Check language restrictions on the args to the class</span><span>
</span><span id="line-1636"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683048993"><span class="hs-identifier hs-var">check_h98_arg_shape</span></a></span><span>
</span><span id="line-1637"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683048994"><span class="annot"><span class="annottext">IllegalInstanceHeadReason
</span><a href="#local-6989586621683048994"><span class="hs-identifier hs-var">illegal_head</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe IllegalInstanceHeadReason
</span><a href="#local-6989586621683048995"><span class="hs-identifier hs-var">mb_ty_args_type</span></a></span><span>
</span><span id="line-1638"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason -&gt; TcM ()
</span><a href="#local-6989586621683048960"><span class="hs-identifier hs-var">fail_with_inst_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; TcM ())
-&gt; IllegalClassInstanceReason -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalInstanceHead"><span class="hs-identifier hs-var">IllegalInstanceHead</span></a></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason
</span><a href="#local-6989586621683048994"><span class="hs-identifier hs-var">illegal_head</span></a></span><span>
</span><span id="line-1639"></span><span>
</span><span id="line-1640"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1641"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1642"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1643"></span><span>
</span><span id="line-1644"></span><span>    </span><span id="local-6989586621683048960"><span class="annot"><span class="annottext">fail_with_inst_err :: IllegalClassInstanceReason -&gt; TcM ()
</span><a href="#local-6989586621683048960"><span class="hs-identifier hs-var hs-var">fail_with_inst_err</span></a></span></span><span> </span><span id="local-6989586621683048996"><span class="annot"><span class="annottext">IllegalClassInstanceReason
</span><a href="#local-6989586621683048996"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1645"></span><span>      </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceReason -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalInstance"><span class="hs-identifier hs-var">TcRnIllegalInstance</span></a></span><span>
</span><span id="line-1646"></span><span>                 </span><span class="annot"><span class="annottext">(IllegalInstanceReason -&gt; TcRnMessage)
-&gt; IllegalInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypedThing -&gt; IllegalClassInstanceReason -&gt; IllegalInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalClassInstance"><span class="hs-identifier hs-var">IllegalClassInstance</span></a></span><span>
</span><span id="line-1647"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; TypedThing
</span><a href="GHC.Tc.Types.Origin.html#TypeThing"><span class="hs-identifier hs-var">TypeThing</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; TypedThing) -&gt; Type -&gt; TypedThing
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Class -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048957"><span class="hs-identifier hs-var">cls_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1648"></span><span>                 </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; IllegalInstanceReason)
-&gt; IllegalClassInstanceReason -&gt; IllegalInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason
</span><a href="#local-6989586621683048996"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1649"></span><span>
</span><span id="line-1650"></span><span>    </span><span id="local-6989586621683048963"><span class="annot"><span class="annottext">clas_nm :: Name
</span><a href="#local-6989586621683048963"><span class="hs-identifier hs-var hs-var">clas_nm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span>
</span><span id="line-1651"></span><span>    </span><span id="local-6989586621683049001"><span class="annot"><span class="annottext">ty_args :: [Type]
</span><a href="#local-6989586621683049001"><span class="hs-identifier hs-var hs-var">ty_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; TyCon
</span><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683048956"><span class="hs-identifier hs-var">clas</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683048957"><span class="hs-identifier hs-var">cls_args</span></a></span><span>
</span><span id="line-1652"></span><span>
</span><span id="line-1653"></span><span>    </span><span id="local-6989586621683048966"><span class="annot"><span class="annottext">hand_written_bindings :: Bool
</span><a href="#local-6989586621683048966"><span class="hs-identifier hs-var hs-var">hand_written_bindings</span></a></span></span><span>
</span><span id="line-1654"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048955"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1655"></span><span>          </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InstDeclCtxt"><span class="hs-identifier hs-type">InstDeclCtxt</span></a></span><span> </span><span id="local-6989586621683049002"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049002"><span class="hs-identifier hs-var">standalone</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049002"><span class="hs-identifier hs-var">standalone</span></a></span><span>
</span><span id="line-1656"></span><span>          </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SpecInstCtxt"><span class="hs-identifier hs-var">SpecInstCtxt</span></a></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1657"></span><span>          </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#DerivClauseCtxt"><span class="hs-identifier hs-var">DerivClauseCtxt</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1658"></span><span>          </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1659"></span><span>          </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1660"></span><span>
</span><span id="line-1661"></span><span>    </span><span id="local-6989586621683048973"><span class="annot"><span class="annottext">derived_instance :: Bool
</span><a href="#local-6989586621683048973"><span class="hs-identifier hs-var hs-var">derived_instance</span></a></span></span><span>
</span><span id="line-1662"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048955"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1663"></span><span>            </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#InstDeclCtxt"><span class="hs-identifier hs-type">InstDeclCtxt</span></a></span><span> </span><span id="local-6989586621683049003"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049003"><span class="hs-identifier hs-var">standalone</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049003"><span class="hs-identifier hs-var">standalone</span></a></span><span>
</span><span id="line-1664"></span><span>            </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#DerivClauseCtxt"><span class="hs-identifier hs-var">DerivClauseCtxt</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1665"></span><span>            </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1666"></span><span>
</span><span id="line-1667"></span><span>    </span><span id="local-6989586621683048993"><span class="annot"><span class="annottext">check_h98_arg_shape :: Bool
</span><a href="#local-6989586621683048993"><span class="hs-identifier hs-var hs-var">check_h98_arg_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048955"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1668"></span><span>                            </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SpecInstCtxt"><span class="hs-identifier hs-var">SpecInstCtxt</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1669"></span><span>                            </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#DerivClauseCtxt"><span class="hs-identifier hs-var">DerivClauseCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1670"></span><span>                            </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1671"></span><span>                            </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1672"></span><span>        </span><span class="hs-comment">-- SigmaCtxt: once we are in quantified-constraint land, we</span><span>
</span><span id="line-1673"></span><span>        </span><span class="hs-comment">-- aren't so picky about enforcing H98-language restrictions</span><span>
</span><span id="line-1674"></span><span>        </span><span class="hs-comment">-- E.g. we want to allow a head like Coercible (m a) (m b)</span><span>
</span><span id="line-1675"></span><span>
</span><span id="line-1676"></span><span>
</span><span id="line-1677"></span><span>    </span><span class="hs-comment">-- When we are looking at the head of a quantified constraint,</span><span>
</span><span id="line-1678"></span><span>    </span><span class="hs-comment">-- check_quant_pred sets ctxt to SigmaCtxt</span><span>
</span><span id="line-1679"></span><span>    </span><span id="local-6989586621683048979"><span class="annot"><span class="annottext">quantified_constraint :: Bool
</span><a href="#local-6989586621683048979"><span class="hs-identifier hs-var hs-var">quantified_constraint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683048955"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1680"></span><span>                              </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="GHC.Tc.Types.Origin.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1681"></span><span>                              </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1682"></span><span>
</span><span id="line-1683"></span><span>    </span><span id="local-6989586621683048995"><span class="annot"><span class="annottext">mb_ty_args_type :: Maybe IllegalInstanceHeadReason
</span><a href="#local-6989586621683048995"><span class="hs-identifier hs-var hs-var">mb_ty_args_type</span></a></span></span><span>
</span><span id="line-1684"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.TypeSynonymInstances</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048953"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1685"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; [Type] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Tc.Validity.html#tcInstHeadTyNotSynonym"><span class="hs-identifier hs-var">tcInstHeadTyNotSynonym</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049001"><span class="hs-identifier hs-var">ty_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1686"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason -&gt; Maybe IllegalInstanceHeadReason
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason
</span><a href="GHC.Tc.Errors.Types.html#InstHeadTySynArgs"><span class="hs-identifier hs-var">InstHeadTySynArgs</span></a></span><span>
</span><span id="line-1687"></span><span>
</span><span id="line-1688"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.FlexibleInstances</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048953"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1689"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; [Type] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Tc.Validity.html#tcInstHeadTyAppAllTyVars"><span class="hs-identifier hs-var">tcInstHeadTyAppAllTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049001"><span class="hs-identifier hs-var">ty_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1690"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason -&gt; Maybe IllegalInstanceHeadReason
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason
</span><a href="GHC.Tc.Errors.Types.html#InstHeadNonTyVarArgs"><span class="hs-identifier hs-var">InstHeadNonTyVarArgs</span></a></span><span>
</span><span id="line-1691"></span><span>
</span><span id="line-1692"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049001"><span class="hs-identifier hs-var">ty_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1693"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.MultiParamTypeClasses</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048953"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1694"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.NullaryTypeClasses</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621683048953"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049001"><span class="hs-identifier hs-var">ty_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1695"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason -&gt; Maybe IllegalInstanceHeadReason
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason
</span><a href="GHC.Tc.Errors.Types.html#InstHeadMultiParam"><span class="hs-identifier hs-var">InstHeadMultiParam</span></a></span><span>
</span><span id="line-1696"></span><span>
</span><span id="line-1697"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1698"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe IllegalInstanceHeadReason
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1699"></span><span>
</span><span id="line-1700"></span><span class="annot"><a href="GHC.Tc.Validity.html#tcInstHeadTyNotSynonym"><span class="hs-identifier hs-type">tcInstHeadTyNotSynonym</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1701"></span><span class="hs-comment">-- Used in Haskell-98 mode, for the argument types of an instance head</span><span>
</span><span id="line-1702"></span><span class="hs-comment">-- These must not be type synonyms, but everywhere else type synonyms</span><span>
</span><span id="line-1703"></span><span class="hs-comment">-- are transparent, so we need a special function here</span><span>
</span><span id="line-1704"></span><span id="tcInstHeadTyNotSynonym"><span class="annot"><span class="annottext">tcInstHeadTyNotSynonym :: Type -&gt; Bool
</span><a href="GHC.Tc.Validity.html#tcInstHeadTyNotSynonym"><span class="hs-identifier hs-var hs-var">tcInstHeadTyNotSynonym</span></a></span></span><span> </span><span id="local-6989586621683049013"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049013"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1705"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049013"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Do not use splitTyConApp,</span><span>
</span><span id="line-1706"></span><span>                </span><span class="hs-comment">-- because that expands synonyms!</span><span>
</span><span id="line-1707"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683049014"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049014"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeSynonymTyCon"><span class="hs-identifier hs-var">isTypeSynonymTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049014"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049014"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="GHC.Builtin.Types.html#unrestrictedFunTyCon"><span class="hs-identifier hs-var">unrestrictedFunTyCon</span></a></span><span>
</span><span id="line-1708"></span><span>                </span><span class="hs-comment">-- Allow (-&gt;), e.g. instance Category (-&gt;),</span><span>
</span><span id="line-1709"></span><span>                </span><span class="hs-comment">-- even though it's a type synonym for FUN 'Many</span><span>
</span><span id="line-1710"></span><span>        </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1711"></span><span>
</span><span id="line-1712"></span><span class="annot"><a href="GHC.Tc.Validity.html#tcInstHeadTyAppAllTyVars"><span class="hs-identifier hs-type">tcInstHeadTyAppAllTyVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1713"></span><span class="hs-comment">-- Used in Haskell-98 mode, for the argument types of an instance head</span><span>
</span><span id="line-1714"></span><span class="hs-comment">-- These must be a constructor applied to type variable arguments</span><span>
</span><span id="line-1715"></span><span class="hs-comment">-- or a type-level literal.</span><span>
</span><span id="line-1716"></span><span class="hs-comment">-- But we allow</span><span>
</span><span id="line-1717"></span><span class="hs-comment">-- 1) kind instantiations</span><span>
</span><span id="line-1718"></span><span class="hs-comment">-- 2) the type (-&gt;) = FUN 'Many, even though it's not in this form.</span><span>
</span><span id="line-1719"></span><span id="tcInstHeadTyAppAllTyVars"><span class="annot"><span class="annottext">tcInstHeadTyAppAllTyVars :: Type -&gt; Bool
</span><a href="GHC.Tc.Validity.html#tcInstHeadTyAppAllTyVars"><span class="hs-identifier hs-var hs-var">tcInstHeadTyAppAllTyVars</span></a></span></span><span> </span><span id="local-6989586621683049016"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049016"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1720"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683049017"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049017"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049018"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049018"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049016"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1721"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683049021"><span class="annot"><span class="annottext">tys' :: [Type]
</span><a href="#local-6989586621683049021"><span class="hs-identifier hs-var hs-var">tys'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049017"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049018"><span class="hs-identifier hs-var">tys</span></a></span><span>  </span><span class="hs-comment">-- avoid kinds</span><span>
</span><span id="line-1722"></span><span>        </span><span id="local-6989586621683049022"><span class="annot"><span class="annottext">tys'' :: [Type]
</span><a href="#local-6989586621683049022"><span class="hs-identifier hs-var hs-var">tys''</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049017"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#fUNTyConKey"><span class="hs-identifier hs-var">fUNTyConKey</span></a></span><span>
</span><span id="line-1723"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621683049025"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049025"><span class="hs-identifier hs-var">tys_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049021"><span class="hs-identifier hs-var">tys'</span></a></span><span>
</span><span id="line-1724"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049025"><span class="hs-identifier hs-var">tys_t</span></a></span><span>
</span><span id="line-1725"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049021"><span class="hs-identifier hs-var">tys'</span></a></span><span>
</span><span id="line-1726"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Bool
</span><a href="#local-6989586621683049026"><span class="hs-identifier hs-var">ok</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049022"><span class="hs-identifier hs-var">tys''</span></a></span><span>
</span><span id="line-1727"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyLit
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049016"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-comment">-- accept type literals (#13833)</span><span>
</span><span id="line-1728"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1729"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1730"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1731"></span><span>        </span><span class="hs-comment">-- Check that all the types are type variables,</span><span>
</span><span id="line-1732"></span><span>        </span><span class="hs-comment">-- and that each is distinct</span><span>
</span><span id="line-1733"></span><span>    </span><span id="local-6989586621683049026"><span class="annot"><span class="annottext">ok :: [Type] -&gt; Bool
</span><a href="#local-6989586621683049026"><span class="hs-identifier hs-var hs-var">ok</span></a></span></span><span> </span><span id="local-6989586621683049028"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049028"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; [Type] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049030"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049028"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; Bool
</span><a href="GHC.Data.List.SetOps.html#hasNoDups"><span class="hs-identifier hs-var">hasNoDups</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049030"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-1734"></span><span>           </span><span class="hs-keyword">where</span><span>
</span><span id="line-1735"></span><span>             </span><span id="local-6989586621683049030"><span class="annot"><span class="annottext">tvs :: [Var]
</span><a href="#local-6989586621683049030"><span class="hs-identifier hs-var hs-var">tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Maybe Var) -&gt; [Type] -&gt; [Var]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Var
</span><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049028"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1736"></span><span>
</span><span id="line-1737"></span><span class="annot"><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-type">dropCasts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-1738"></span><span class="hs-comment">-- See Note [Casts during validity checking]</span><span>
</span><span id="line-1739"></span><span class="hs-comment">-- This function can turn a well-kinded type into an ill-kinded</span><span>
</span><span id="line-1740"></span><span class="hs-comment">-- one, so I've kept it local to this module</span><span>
</span><span id="line-1741"></span><span class="hs-comment">-- To consider: drop only HoleCo casts</span><span>
</span><span id="line-1742"></span><span id="dropCasts"><span class="annot"><span class="annottext">dropCasts :: Type -&gt; Type
</span><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var hs-var">dropCasts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621683049034"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049034"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="annot"><span class="annottext">KindCoercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049034"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1743"></span><span class="annot"><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621683049035"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049035"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621683049036"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049036"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
</span><a href="GHC.Core.Type.html#mkAppTy"><span class="hs-identifier hs-var">mkAppTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049035"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049036"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1744"></span><span class="annot"><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span id="local-6989586621683049038"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621683049038"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683049039"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049039"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621683049040"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049040"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621683049041"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049041"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049038"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-type">dropCasts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049039"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-type">dropCasts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049040"><span class="hs-identifier hs-type">t1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-type">dropCasts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049041"><span class="hs-identifier hs-type">t2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1745"></span><span class="annot"><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683049045"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049045"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683049046"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049046"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049045"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049046"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1746"></span><span class="annot"><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span id="local-6989586621683049048"><span class="annot"><span class="annottext">TyVarBinder
</span><a href="#local-6989586621683049048"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621683049049"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049049"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVarBinder -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVarBinder -&gt; TyVarBinder
</span><a href="GHC.Tc.Validity.html#dropCastsB"><span class="hs-identifier hs-var">dropCastsB</span></a></span><span> </span><span class="annot"><span class="annottext">TyVarBinder
</span><a href="#local-6989586621683049048"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049049"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1747"></span><span class="annot"><a href="GHC.Tc.Validity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a></span><span> </span><span id="local-6989586621683049051"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049051"><span class="hs-identifier hs-var">ty</span></a></span></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049051"><span class="hs-identifier hs-var">ty</span></a></span><span>  </span><span class="hs-comment">-- LitTy, TyVarTy, CoercionTy</span><span>
</span><span id="line-1748"></span><span>
</span><span id="line-1749"></span><span class="annot"><a href="GHC.Tc.Validity.html#dropCastsB"><span class="hs-identifier hs-type">dropCastsB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVarBinder"><span class="hs-identifier hs-type">TyVarBinder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVarBinder"><span class="hs-identifier hs-type">TyVarBinder</span></a></span><span>
</span><span id="line-1750"></span><span id="dropCastsB"><span class="annot"><span class="annottext">dropCastsB :: TyVarBinder -&gt; TyVarBinder
</span><a href="GHC.Tc.Validity.html#dropCastsB"><span class="hs-identifier hs-var hs-var">dropCastsB</span></a></span></span><span> </span><span id="local-6989586621683049052"><span class="annot"><span class="annottext">TyVarBinder
</span><a href="#local-6989586621683049052"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVarBinder
</span><a href="#local-6989586621683049052"><span class="hs-identifier hs-var">b</span></a></span><span>   </span><span class="hs-comment">-- Don't bother in the kind of a forall</span><span>
</span><span id="line-1751"></span><span>
</span><span id="line-1752"></span><span class="annot"><span class="hs-comment">-- | See Note [Validity checking of HasField instances]</span></span><span>
</span><span id="line-1753"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkHasFieldInst"><span class="hs-identifier hs-type">checkHasFieldInst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1754"></span><span id="checkHasFieldInst"><span class="annot"><span class="annottext">checkHasFieldInst :: Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkHasFieldInst"><span class="hs-identifier hs-var hs-var">checkHasFieldInst</span></a></span></span><span> </span><span id="local-6989586621683049053"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049053"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683049054"><span class="annot"><span class="annottext">tys :: [Type]
</span><a href="#local-6989586621683049054"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span id="local-6989586621683049055"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049055"><span class="hs-identifier hs-var">_k_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049056"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049056"><span class="hs-identifier hs-var">_r_rep</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049057"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049057"><span class="hs-identifier hs-var">_a_rep</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049058"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049058"><span class="hs-identifier hs-var">lbl_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049059"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049059"><span class="hs-identifier hs-var">r_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049060"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049060"><span class="hs-identifier hs-var">_a_ty</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1755"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049059"><span class="hs-identifier hs-var">r_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1756"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IllegalHasFieldInstance -&gt; TcM ()
</span><a href="#local-6989586621683049062"><span class="hs-identifier hs-var">add_err</span></a></span><span> </span><span class="annot"><span class="annottext">IllegalHasFieldInstance
</span><a href="GHC.Tc.Errors.Types.html#IllegalHasFieldInstanceNotATyCon"><span class="hs-identifier hs-var">IllegalHasFieldInstanceNotATyCon</span></a></span><span>
</span><span id="line-1757"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683049064"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049064"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1758"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isFamilyTyCon"><span class="hs-identifier hs-var">isFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049064"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1759"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IllegalHasFieldInstance -&gt; TcM ()
</span><a href="#local-6989586621683049062"><span class="hs-identifier hs-var">add_err</span></a></span><span> </span><span class="annot"><span class="annottext">IllegalHasFieldInstance
</span><a href="GHC.Tc.Errors.Types.html#IllegalHasFieldInstanceFamilyTyCon"><span class="hs-identifier hs-var">IllegalHasFieldInstanceFamilyTyCon</span></a></span><span>
</span><span id="line-1760"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe FastString
</span><a href="GHC.Core.Type.html#isStrLitTy"><span class="hs-identifier hs-var">isStrLitTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049058"><span class="hs-identifier hs-var">lbl_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1761"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683049068"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683049068"><span class="hs-identifier hs-var">lbl</span></a></span></span><span>
</span><span id="line-1762"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683049069"><span class="annot"><span class="annottext">lbl_str :: FieldLabelString
</span><a href="#local-6989586621683049069"><span class="hs-identifier hs-var hs-var">lbl_str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; FieldLabelString
</span><a href="Language.Haskell.Syntax.Basic.html#FieldLabelString"><span class="hs-identifier hs-var">FieldLabelString</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621683049068"><span class="hs-identifier hs-var">lbl</span></a></span><span>
</span><span id="line-1763"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe FieldLabel -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FieldLabelString -&gt; TyCon -&gt; Maybe FieldLabel
</span><a href="GHC.Core.TyCon.html#lookupTyConFieldLabel"><span class="hs-identifier hs-var">lookupTyConFieldLabel</span></a></span><span> </span><span class="annot"><span class="annottext">FieldLabelString
</span><a href="#local-6989586621683049069"><span class="hs-identifier hs-var">lbl_str</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049064"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1764"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IllegalHasFieldInstance -&gt; TcM ()
</span><a href="#local-6989586621683049062"><span class="hs-identifier hs-var">add_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalHasFieldInstance -&gt; TcM ())
-&gt; IllegalHasFieldInstance -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; FieldLabelString -&gt; IllegalHasFieldInstance
</span><a href="GHC.Tc.Errors.Types.html#IllegalHasFieldInstanceTyConHasField"><span class="hs-identifier hs-var">IllegalHasFieldInstanceTyConHasField</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049064"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">FieldLabelString
</span><a href="#local-6989586621683049069"><span class="hs-identifier hs-var">lbl_str</span></a></span><span>
</span><span id="line-1765"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1766"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1767"></span><span>       </span><span class="annot"><span class="annottext">Maybe FastString
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1768"></span><span>         </span><span class="hs-comment">-- If the label is not a literal, we need to ensure it can't unify</span><span>
</span><span id="line-1769"></span><span>         </span><span class="hs-comment">-- with any of the field labels of the TyCon.</span><span>
</span><span id="line-1770"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[FieldLabel] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [FieldLabel]
</span><a href="GHC.Core.TyCon.html#tyConFieldLabels"><span class="hs-identifier hs-var">tyConFieldLabels</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049064"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1771"></span><span>           </span><span class="hs-comment">-- No field labels at all: nothing to check.</span><span>
</span><span id="line-1772"></span><span>         </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.Unify.html#typesAreApart"><span class="hs-identifier hs-var">typesAreApart</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049058"><span class="hs-identifier hs-var">lbl_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#typeSymbolKind"><span class="hs-identifier hs-var">typeSymbolKind</span></a></span><span>
</span><span id="line-1773"></span><span>           </span><span class="hs-comment">-- If the label has a type whose kind can't unify with Symbol,</span><span>
</span><span id="line-1774"></span><span>           </span><span class="hs-comment">-- then it definitely can't unify with any of the field labels.</span><span>
</span><span id="line-1775"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1776"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1777"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IllegalHasFieldInstance -&gt; TcM ()
</span><a href="#local-6989586621683049062"><span class="hs-identifier hs-var">add_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalHasFieldInstance -&gt; TcM ())
-&gt; IllegalHasFieldInstance -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Type -&gt; IllegalHasFieldInstance
</span><a href="GHC.Tc.Errors.Types.html#IllegalHasFieldInstanceTyConHasFields"><span class="hs-identifier hs-var">IllegalHasFieldInstanceTyConHasFields</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049064"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049058"><span class="hs-identifier hs-var">lbl_ty</span></a></span><span>
</span><span id="line-1778"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1779"></span><span>    </span><span id="local-6989586621683049062"><span class="annot"><span class="annottext">add_err :: IllegalHasFieldInstance -&gt; TcM ()
</span><a href="#local-6989586621683049062"><span class="hs-identifier hs-var hs-var">add_err</span></a></span></span><span> </span><span id="local-6989586621683049077"><span class="annot"><span class="annottext">IllegalHasFieldInstance
</span><a href="#local-6989586621683049077"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceReason -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalInstance"><span class="hs-identifier hs-var">TcRnIllegalInstance</span></a></span><span>
</span><span id="line-1780"></span><span>                           </span><span class="annot"><span class="annottext">(IllegalInstanceReason -&gt; TcRnMessage)
-&gt; IllegalInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypedThing -&gt; IllegalClassInstanceReason -&gt; IllegalInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalClassInstance"><span class="hs-identifier hs-var">IllegalClassInstance</span></a></span><span>
</span><span id="line-1781"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; TypedThing
</span><a href="GHC.Tc.Types.Origin.html#TypeThing"><span class="hs-identifier hs-var">TypeThing</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; TypedThing) -&gt; Type -&gt; TypedThing
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Class -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049053"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049054"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1782"></span><span>                           </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; IllegalInstanceReason)
-&gt; IllegalClassInstanceReason -&gt; IllegalInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalHasFieldInstance -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalHasFieldInstance"><span class="hs-identifier hs-var">IllegalHasFieldInstance</span></a></span><span> </span><span class="annot"><span class="annottext">IllegalHasFieldInstance
</span><a href="#local-6989586621683049077"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-1783"></span><span>
</span><span id="line-1784"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkHasFieldInst"><span class="hs-identifier hs-var">checkHasFieldInst</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683049080"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049080"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkHasFieldInst&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049080"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1785"></span><span>
</span><span id="line-1786"></span><span class="hs-comment">{- Note [Casts during validity checking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the (bogus)
     instance Eq Char#
We elaborate to  'Eq (Char# |&gt; UnivCo(hole))'  where the hole is an
insoluble equality constraint for Type ~ TYPE WordRep.  We'll report the insoluble
constraint separately, but we don't want to *also* complain that Eq is
not applied to a type constructor.  So we look gaily look through
CastTys here.

Another example:  Eq (Either a).  Then we actually get a cast in
the middle:
   Eq ((Either |&gt; g) a)


Note [Validity checking of HasField instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The HasField class has magic constraint solving behaviour (see Note
[HasField instances] in GHC.Tc.Instance.Class).  However, we permit users to
declare their own instances, provided they do not clash with the
built-in behaviour.  In particular, we forbid:

  1. `HasField _ r _` where r is a variable

  2. `HasField _ (T ...) _` if T is a data family
     (because it might have fields introduced later)

  3. `HasField x (T ...) _` where x is a variable,
      if T has any fields at all

  4. `HasField &quot;foo&quot; (T ...) _` if T has a &quot;foo&quot; field

The usual functional dependency checks also apply.


Note [Valid 'deriving' predicate]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a 'derived' instance declaration, we *infer* the context. It's a bit unclear
what rules we should apply for this; the Haskell report is silent. Obviously,
constraints like `Eq a` are fine, but what about

  data T f a = MkT (f a) deriving Eq

where we'd get an `Eq (f a)` constraint. That's probably fine too.

On the other hand, we don't want to allow *every* inferred constraint, as there
are some particularly complex constraints that are tricky to handle. If GHC
encounters a constraint that is too complex, it will reject it, and you will
have to use StandaloneDeriving to manually specify the instance context that
you want.

There are two criteria for a constraint inferred by a `deriving` clause to be
considered valid, which are described below as (VD1) and (VD2). (Here, &quot;VD&quot;
stands for &quot;valid deriving&quot;.) `validDerivPred` implements these checks. While
`validDerivPred` is similar to other things defined in GHC.Tc.Deriv.Infer, we
define it here in GHC.Tc.Validity because it is quite similar to
`checkInstTermination`.

-----------------------------------
-- (VD1) The Paterson conditions --
-----------------------------------

Constraints must satisfy the Paterson conditions (see Note [Paterson
conditions]) to be valid. Not only does this check for termination (of course),
but it also deals with a nasty corner case:

  instance C a b =&gt; D (T a) where ...

Note that `b` isn't a parameter of T.  This gives rise to all sorts of
problems; in particular, it's hard to compare solutions for equality when
finding the fixpoint, and that means the
GHC.Tc.Deriv.Infer.simplifyInstanceContexts loop does not converge.
See #5287 and #21302.

Another common situation in which a derived instance's context fails to meet
the Paterson conditions is when a constraint mentions a type variable more
often than the instance head, e.g.,

  data Fix f = In (f (Fix f)) deriving Eq

This would result in the following derived `Eq` instance:

  instance Eq (f (Fix f)) =&gt; Eq (Fix f)

Because `f` is mentioned more often in the `Eq (f (Fix f))` constraint than in
the instance head `Eq (Fix f)`, GHC rejects this instance.

This is a somewhat contentious restriction, and some have suggested that
instances like this one should be accepted if UndecidableInstances is enabled
(see #15868 for one such discussion). If we *do* lift this restriction in the
future, we should make sure to still meet the termination conditions. If not,
the deriving mechanism generates larger and larger constraints. Example:

  data Succ a = S a
  data Seq a = Cons a (Seq (Succ a)) | Nil deriving Show

Note the lack of a Show instance for Succ.  First we'll generate:

  instance (Show (Succ a), Show a) =&gt; Show (Seq a)

and then:

  instance (Show (Succ (Succ a)), Show (Succ a), Show a) =&gt; Show (Seq a)

and so on. Instead we want to complain of no instance for (Show (Succ a)).

---------------------------------
-- (VD2) No exotic constraints --
---------------------------------

A constraint must satisfy one of the following properties in order to be valid:

* It is a `ClassPred` of the form `C a_1 ... a_n`, where C is a type class
  constructor and a_1, ..., a_n are either raw type variables or applications
  of type variables (e.g., `f a`).
* It is an `IrredPred` of the form `c a_1 ... a_n`, where `c` is a raw type
  variable and a_1, ..., a_n are either raw type variables or applications of
  type variables (e.g., `f a`).

If a constraint does not meet either of these properties, it is considered
*exotic*. A constraint will be exotic if it contains:

* Other type constructors (besides the class in a `ClassPred`),
* Foralls, or
* Equalities

A common form of exotic constraint is one that mentions another type
constructor. For example, given the following:

  data NotAShowInstance
  data Foo = MkFoo Int NotAShowInstance deriving Show

GHC would attempt to generate the following derived `Show` instance:

  instance (Show Int, Show NotAShowInstance) =&gt; Show Foo

Note that because there is a top-level `Show Int` instance, GHC is able to
simplify away the inferred `Show Int` constraint. However, it cannot do the
same for the `Show NotAShowInstance` constraint. One possibility would be to
generate this instance:

  instance Show NotAShowInstance =&gt; Show Foo

But this is almost surely not what we want most of the time. For this reason,
we reject the constraint above as being exotic.

Here are some other interesting examples:

* Derived instances whose instance context would mention TypeError, such as the
  code from the deriving/should_fail/T14339 test case, are exotic. For example:

    newtype Foo = Foo Int

    class Bar a where
      bar :: a

    instance (TypeError (Text &quot;Boo&quot;)) =&gt; Bar Foo where
      bar = undefined

    newtype Baz = Baz Foo
      deriving Bar

  The `deriving Bar` clause would generate this instance:

    instance TypeError (Text &quot;Boo&quot;) =&gt; Bar Baz

  The instance context is exotic, as `TypeError` is not a type constructor, and
  `Text &quot;Boo&quot;` is not an application of type variables. As such, GHC rejects
  it. This has the desirable side effect of causing the TypeError to fire in
  the resulting error message.

* The following `IrredPred`s are not exotic:

    instance c =&gt; C (T c a)
    instance c a =&gt; C (T c a)

  This `IrredPred`, however, *is* exotic:

    instance c NotAShowInstance =&gt; C (T c)

  This is rejected for the same reasons that we do not permit a `ClassPred`
  with a type constructor argument, such as the `Show NotAShowInstance` example
  above.

As part of implementing this check, GHC calls `tyConsOfType` on the arguments
of the constraint, ensuring that there are no other type constructors.
Wrinkle: for `ClassPred`s, we look only at the /visible/ arguments of the class
type constructor. Including the non-visible arguments can cause the following,
perfectly valid instance to be rejected:

  class Category (cat :: k -&gt; k -&gt; Type) where ...
  newtype T (c :: Type -&gt; Type -&gt; Type) a b = MkT (c a b)
  instance Category c =&gt; Category (T c) where ...

since the first argument to `Category` is a non-visible `Type`, which has a type
constructor! See #11833.

Note [Equality class instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We can't have users writing instances for the equality classes. But we
still need to be able to write instances for them ourselves. So we allow
instances only in the defining module.
-}</span><span>
</span><span id="line-1989"></span><span>
</span><span id="line-1990"></span><span class="annot"><a href="GHC.Tc.Validity.html#validDerivPred"><span class="hs-identifier hs-type">validDerivPred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#PatersonSize"><span class="hs-identifier hs-type">PatersonSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1991"></span><span class="hs-comment">-- See Note [Valid 'deriving' predicate]</span><span>
</span><span id="line-1992"></span><span id="validDerivPred"><span class="annot"><span class="annottext">validDerivPred :: PatersonSize -&gt; Type -&gt; Bool
</span><a href="GHC.Tc.Validity.html#validDerivPred"><span class="hs-identifier hs-var hs-var">validDerivPred</span></a></span></span><span> </span><span id="local-6989586621683049081"><span class="annot"><span class="annottext">PatersonSize
</span><a href="#local-6989586621683049081"><span class="hs-identifier hs-var">head_size</span></a></span></span><span> </span><span id="local-6989586621683049082"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049082"><span class="hs-identifier hs-var">pred</span></a></span></span><span>
</span><span id="line-1993"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049082"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1994"></span><span>            </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- Reject equality constraints (VD2)</span><span>
</span><span id="line-1995"></span><span>            </span><span class="annot"><a href="GHC.Core.Predicate.html#ForAllPred"><span class="hs-identifier hs-type">ForAllPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- Rejects quantified predicates (VD2)</span><span>
</span><span id="line-1996"></span><span>
</span><span id="line-1997"></span><span>            </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621683049083"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049083"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683049084"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049084"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatersonSize -&gt; Bool
</span><a href="#local-6989586621683049085"><span class="hs-identifier hs-var">check_size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [Type] -&gt; PatersonSize
</span><a href="GHC.Tc.Utils.TcType.html#pSizeClassPred"><span class="hs-identifier hs-var">pSizeClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049083"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049084"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- (VD1)</span><span>
</span><span id="line-1998"></span><span>                              </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">UniqSet TyCon -&gt; Bool
forall a. UniqSet a -&gt; Bool
</span><a href="GHC.Types.Unique.Set.html#isEmptyUniqSet"><span class="hs-identifier hs-var">isEmptyUniqSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; UniqSet TyCon
</span><a href="GHC.Core.TyCo.FVs.html#tyConsOfTypes"><span class="hs-identifier hs-var">tyConsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049088"><span class="hs-identifier hs-var">visible_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- (VD2)</span><span>
</span><span id="line-1999"></span><span>                </span><span class="hs-keyword">where</span><span>
</span><span id="line-2000"></span><span>                  </span><span class="hs-comment">-- See the wrinkle about visible arguments in (VD2)</span><span>
</span><span id="line-2001"></span><span>                  </span><span id="local-6989586621683049088"><span class="annot"><span class="annottext">visible_tys :: [Type]
</span><a href="#local-6989586621683049088"><span class="hs-identifier hs-var hs-var">visible_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; TyCon
</span><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049083"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049084"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2002"></span><span>
</span><span id="line-2003"></span><span>            </span><span class="annot"><a href="GHC.Core.Predicate.html#IrredPred"><span class="hs-identifier hs-type">IrredPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatersonSize -&gt; Bool
</span><a href="#local-6989586621683049085"><span class="hs-identifier hs-var">check_size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; PatersonSize
</span><a href="GHC.Tc.Utils.TcType.html#pSizeType"><span class="hs-identifier hs-var">pSizeType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049082"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- (VD1)</span><span>
</span><span id="line-2004"></span><span>                         </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">UniqSet TyCon -&gt; Bool
forall a. UniqSet a -&gt; Bool
</span><a href="GHC.Types.Unique.Set.html#isEmptyUniqSet"><span class="hs-identifier hs-var">isEmptyUniqSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; UniqSet TyCon
</span><a href="GHC.Core.TyCo.FVs.html#tyConsOfType"><span class="hs-identifier hs-var">tyConsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049082"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- (VD2)</span><span>
</span><span id="line-2005"></span><span>
</span><span id="line-2006"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2007"></span><span>    </span><span id="local-6989586621683049085"><span class="annot"><span class="annottext">check_size :: PatersonSize -&gt; Bool
</span><a href="#local-6989586621683049085"><span class="hs-identifier hs-var hs-var">check_size</span></a></span></span><span> </span><span id="local-6989586621683049091"><span class="annot"><span class="annottext">PatersonSize
</span><a href="#local-6989586621683049091"><span class="hs-identifier hs-var">pred_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe PatersonCondFailure -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatersonSize
</span><a href="#local-6989586621683049091"><span class="hs-identifier hs-var">pred_size</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonSize -&gt; PatersonSize -&gt; Maybe PatersonCondFailure
</span><a href="GHC.Tc.Utils.TcType.html#ltPatersonSize"><span class="hs-operator hs-var">`ltPatersonSize`</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonSize
</span><a href="#local-6989586621683049081"><span class="hs-identifier hs-var">head_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2008"></span><span>        </span><span class="hs-comment">-- Check (VD1)</span><span>
</span><span id="line-2009"></span><span>
</span><span id="line-2010"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Checking instance for termination}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-2017"></span><span>
</span><span id="line-2018"></span><span class="hs-comment">{- Note [Paterson conditions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The Paterson Conditions ensure termination of instance resolution.
Given an instance declaration
   instance (..., C t1.. tn, ...) =&gt; D s1 .. sm

we check that each constraint in the context of the instance is
&quot;Paterson-smaller&quot; than the instance head.  The underlying idea of
Paterson-smaller is that

    For any ground substitution S, for each constraint P in the
    context, S(P) has fewer type constructors, counting repetitions,
    than the head S(H)

We implement this check by checking the following syntactic conditions:

(PC1) No type variable has more (shallow) occurrences in P than in H.

      (If not, a substitution that replaces that variable with a big type
      would make P have many more type constructors than H. Side note: we
      could in principle skip this test for a variable of kind Bool,
      since there are no big ground types we can substitute for it.)

(PC2) The constraint P has fewer constructors and variables (taken
      together and counting repetitions) than the head H.  This size
      metric is computed by sizeType.

      (A substitution that replaces each variable with Int demonstrates
      the need.)

(PC3) The constraint P mentions no type functions.

      (A type function application can in principle expand to a type of
      arbitrary size, and so are rejected out of hand.  See #15172.)

(See Section 5 of &quot;Understanding functional dependencies via Constraint
Handling Rules&quot;, JFP Jan 2007; and the user manual section &quot;Instance
termination rules&quot;.)

We measure &quot;size&quot; with the data type PatersonSize, in GHC.Tc.Utils.TcType.
  data PatersonSize
    = PS_TyFam TyCon
    | PS_Vanilla { ps_tvs :: [TyVar]  -- Free tyvars, including repetitions;
                 , ps_size :: Int}    -- Number of type constructors and variables

* ps_tvs deals with (PC1)
* ps_size deals with (PC2)
* PS_TyFam deals with (PC3)

Note [Tuples in checkInstTermination]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider these two ways of giving the same instance decl (#8359):

   instance (Eq a, Num a) =&gt; C (T a)

   type X a = (Eq a, Num a)
   instance X a =&gt; C (T a)

In the former, `checkInstTermination` will check the size of two predicates:
(Eq a) and (Num a). In the latter, it will see only one: (X a). But we want
to treat the latter like the former.

So the `check` function in `checkInstTermination`, we simply recurse
if we find a constraint tuple.
-}</span><span>
</span><span id="line-2083"></span><span>
</span><span id="line-2084"></span><span>
</span><span id="line-2085"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidInstance"><span class="hs-identifier hs-type">checkValidInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Type.html#LHsSigType"><span class="hs-identifier hs-type">LHsSigType</span></a></span><span> </span><span class="annot"><a href="GHC.Hs.Extension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2086"></span><span id="checkValidInstance"><span class="annot"><span class="annottext">checkValidInstance :: UserTypeCtxt -&gt; LHsSigType GhcRn -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidInstance"><span class="hs-identifier hs-var hs-var">checkValidInstance</span></a></span></span><span> </span><span id="local-6989586621683049094"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683049094"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span id="local-6989586621683049095"><span class="annot"><span class="annottext">LHsSigType GhcRn
</span><a href="#local-6989586621683049095"><span class="hs-identifier hs-var">hs_type</span></a></span></span><span> </span><span id="local-6989586621683049096"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049096"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049097"><span class="hs-identifier hs-var">tau</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2087"></span><span>  </span><span class="hs-comment">-- See Note [Instances and constraint synonyms]</span><span>
</span><span id="line-2088"></span><span>  </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621683049098"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049098"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683049099"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049099"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span>
</span><span id="line-2089"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683049100"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049100"><span class="hs-identifier hs-var">clas</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe Class
</span><a href="GHC.Core.TyCon.html#tyConClass_maybe"><span class="hs-identifier hs-var">tyConClass_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049098"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-2090"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2091"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">EpAnn AnnListItem -&gt; TcM () -&gt; TcM ()
forall ann a. EpAnn ann -&gt; TcRn a -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#setSrcSpanA"><span class="hs-identifier hs-var">setSrcSpanA</span></a></span><span> </span><span class="annot"><span class="annottext">EpAnn AnnListItem
</span><a href="#local-6989586621683049103"><span class="hs-identifier hs-var">head_loc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2092"></span><span>          </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; Class -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidInstHead"><span class="hs-identifier hs-var">checkValidInstHead</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621683049094"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049100"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049099"><span class="hs-identifier hs-var">inst_tys</span></a></span><span>
</span><span id="line-2093"></span><span>
</span><span id="line-2094"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkValidInstance {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049096"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2095"></span><span>
</span><span id="line-2096"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683049104"><span class="annot"><a href="#local-6989586621683049104"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ZonkM TidyEnv -&gt; TcM TidyEnv
forall a. ZonkM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#liftZonkM"><span class="hs-identifier hs-var">liftZonkM</span></a></span><span> </span><span class="annot"><span class="annottext">(ZonkM TidyEnv -&gt; TcM TidyEnv) -&gt; ZonkM TidyEnv -&gt; TcM TidyEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ZonkM TidyEnv
</span><a href="GHC.Tc.Zonk.TcType.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a></span><span>
</span><span id="line-2097"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683049105"><span class="annot"><a href="#local-6989586621683049105"><span class="hs-identifier hs-var">expand</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#initialExpandMode"><span class="hs-identifier hs-type">initialExpandMode</span></a></span><span>
</span><span id="line-2098"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#check_valid_theta"><span class="hs-identifier hs-type">check_valid_theta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049104"><span class="hs-identifier hs-type">env0</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049094"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049105"><span class="hs-identifier hs-type">expand</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049106"><span class="hs-identifier hs-type">theta</span></a></span><span>
</span><span id="line-2099"></span><span>
</span><span id="line-2100"></span><span>        </span><span class="hs-comment">-- The Termination and Coverage Conditions</span><span>
</span><span id="line-2101"></span><span>        </span><span class="hs-comment">-- Check that instance inference will terminate (if we care)</span><span>
</span><span id="line-2102"></span><span>        </span><span class="hs-comment">-- For Haskell 98 this will already have been done by checkValidTheta,</span><span>
</span><span id="line-2103"></span><span>        </span><span class="hs-comment">-- but as we may be using other extensions we need to check.</span><span>
</span><span id="line-2104"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-2105"></span><span>        </span><span class="hs-comment">-- Note that the Termination Condition is *more conservative* than</span><span>
</span><span id="line-2106"></span><span>        </span><span class="hs-comment">-- the checkAmbiguity test we do on other type signatures</span><span>
</span><span id="line-2107"></span><span>        </span><span class="hs-comment">--   e.g.  Bar a =&gt; Bar Int is ambiguous, but it also fails</span><span>
</span><span id="line-2108"></span><span>        </span><span class="hs-comment">--   the termination condition, because 'a' appears more often</span><span>
</span><span id="line-2109"></span><span>        </span><span class="hs-comment">--   in the constraint than in the head</span><span>
</span><span id="line-2110"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683049107"><span class="annot"><a href="#local-6989586621683049107"><span class="hs-identifier hs-var">undecidable_ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-type">xoptM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LangExt.UndecidableInstances</span></span><span>
</span><span id="line-2111"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621683049107"><span class="hs-identifier hs-type">undecidable_ok</span></a></span><span>
</span><span id="line-2112"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkAmbiguity"><span class="hs-identifier hs-type">checkAmbiguity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049094"><span class="hs-identifier hs-type">ctxt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049096"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-2113"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#checkInstTermination"><span class="hs-identifier hs-type">checkInstTermination</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049106"><span class="hs-identifier hs-type">theta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049097"><span class="hs-identifier hs-type">tau</span></a></span><span>
</span><span id="line-2114"></span><span>
</span><span id="line-2115"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;cvi 2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049096"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2116"></span><span>
</span><span id="line-2117"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#checkInstCoverage"><span class="hs-identifier hs-type">checkInstCoverage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049107"><span class="hs-identifier hs-type">undecidable_ok</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049100"><span class="hs-identifier hs-type">clas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049106"><span class="hs-identifier hs-type">theta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049099"><span class="hs-identifier hs-type">inst_tys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2118"></span><span>            </span><span class="annot"><span class="annottext">Validity' CoverageProblem
</span><a href="GHC.Utils.Error.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a></span><span>
</span><span id="line-2119"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Check succeeded</span><span>
</span><span id="line-2120"></span><span>            </span><span class="annot"><a href="GHC.Utils.Error.html#NotValid"><span class="hs-identifier hs-type">NotValid</span></a></span><span> </span><span id="local-6989586621683049111"><span class="annot"><span class="annottext">CoverageProblem
</span><a href="#local-6989586621683049111"><span class="hs-identifier hs-var">coverageInstErr</span></a></span></span><span>
</span><span id="line-2121"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason -&gt; TcRnMessage
</span><a href="#local-6989586621683049112"><span class="hs-identifier hs-var">mk_err</span></a></span><span>
</span><span id="line-2122"></span><span>                          </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; TcRnMessage)
-&gt; IllegalClassInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Class -&gt; CoverageProblem -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalInstanceFailsCoverageCondition"><span class="hs-identifier hs-var">IllegalInstanceFailsCoverageCondition</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049100"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">CoverageProblem
</span><a href="#local-6989586621683049111"><span class="hs-identifier hs-var">coverageInstErr</span></a></span><span>
</span><span id="line-2123"></span><span>
</span><span id="line-2124"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;End checkValidInstance }&quot;</span></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2125"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2126"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason -&gt; TcRnMessage
</span><a href="#local-6989586621683049112"><span class="hs-identifier hs-var">mk_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; TcRnMessage)
-&gt; IllegalClassInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalInstanceHead"><span class="hs-identifier hs-var">IllegalInstanceHead</span></a></span><span>
</span><span id="line-2127"></span><span>                           </span><span class="annot"><span class="annottext">(IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason)
-&gt; IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe TyCon -&gt; IllegalInstanceHeadReason
</span><a href="GHC.Tc.Errors.Types.html#InstHeadNonClass"><span class="hs-identifier hs-var">InstHeadNonClass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Maybe TyCon
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049098"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2128"></span><span>  </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason -&gt; TcRnMessage
</span><a href="#local-6989586621683049112"><span class="hs-identifier hs-var">mk_err</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalClassInstanceReason -&gt; TcRnMessage)
-&gt; IllegalClassInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalInstanceHead"><span class="hs-identifier hs-var">IllegalInstanceHead</span></a></span><span>
</span><span id="line-2129"></span><span>                           </span><span class="annot"><span class="annottext">(IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason)
-&gt; IllegalInstanceHeadReason -&gt; IllegalClassInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe TyCon -&gt; IllegalInstanceHeadReason
</span><a href="GHC.Tc.Errors.Types.html#InstHeadNonClass"><span class="hs-identifier hs-var">InstHeadNonClass</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TyCon
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2130"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2131"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683049106"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049106"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049097"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049097"><span class="hs-identifier hs-var">tau</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([Type], Type)
</span><a href="GHC.Tc.Validity.html#splitInstTyForValidity"><span class="hs-identifier hs-var">splitInstTyForValidity</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049096"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2132"></span><span>
</span><span id="line-2133"></span><span>    </span><span id="local-6989586621683049112"><span class="annot"><span class="annottext">mk_err :: IllegalClassInstanceReason -&gt; TcRnMessage
</span><a href="#local-6989586621683049112"><span class="hs-identifier hs-var hs-var">mk_err</span></a></span></span><span> </span><span id="local-6989586621683049117"><span class="annot"><span class="annottext">IllegalClassInstanceReason
</span><a href="#local-6989586621683049117"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IllegalInstanceReason -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalInstance"><span class="hs-identifier hs-var">TcRnIllegalInstance</span></a></span><span>
</span><span id="line-2134"></span><span>               </span><span class="annot"><span class="annottext">(IllegalInstanceReason -&gt; TcRnMessage)
-&gt; IllegalInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypedThing -&gt; IllegalClassInstanceReason -&gt; IllegalInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalClassInstance"><span class="hs-identifier hs-var">IllegalClassInstance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; TypedThing
</span><a href="GHC.Tc.Types.Origin.html#TypeThing"><span class="hs-identifier hs-var">TypeThing</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049097"><span class="hs-identifier hs-var">tau</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IllegalClassInstanceReason
</span><a href="#local-6989586621683049117"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-2135"></span><span>
</span><span id="line-2136"></span><span>        </span><span class="hs-comment">-- The location of the &quot;head&quot; of the instance</span><span>
</span><span id="line-2137"></span><span>    </span><span id="local-6989586621683049103"><span class="annot"><span class="annottext">head_loc :: EpAnn AnnListItem
</span><a href="#local-6989586621683049103"><span class="hs-identifier hs-var hs-var">head_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenLocated (EpAnn AnnListItem) (HsType GhcRn) -&gt; EpAnn AnnListItem
forall l e. GenLocated l e -&gt; l
</span><a href="GHC.Types.SrcLoc.html#getLoc"><span class="hs-identifier hs-var">getLoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LHsSigType GhcRn -&gt; LHsType GhcRn
forall (p :: Pass). LHsSigType (GhcPass p) -&gt; LHsType (GhcPass p)
</span><a href="GHC.Hs.Type.html#getLHsInstDeclHead"><span class="hs-identifier hs-var">getLHsInstDeclHead</span></a></span><span> </span><span class="annot"><span class="annottext">LHsSigType GhcRn
</span><a href="#local-6989586621683049095"><span class="hs-identifier hs-var">hs_type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2138"></span><span>
</span><span id="line-2139"></span><span class="hs-comment">-- | Split an instance type of the form @forall tvbs. inst_ctxt =&gt; inst_head@</span><span>
</span><span id="line-2140"></span><span class="hs-comment">-- and return @(inst_ctxt, inst_head)@. This function makes no attempt to look</span><span>
</span><span id="line-2141"></span><span class="hs-comment">-- through type synonyms. See @Note [Instances and constraint synonyms]@.</span><span>
</span><span id="line-2142"></span><span class="annot"><a href="GHC.Tc.Validity.html#splitInstTyForValidity"><span class="hs-identifier hs-type">splitInstTyForValidity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2143"></span><span id="splitInstTyForValidity"><span class="annot"><span class="annottext">splitInstTyForValidity :: Type -&gt; ([Type], Type)
</span><a href="GHC.Tc.Validity.html#splitInstTyForValidity"><span class="hs-identifier hs-var hs-var">splitInstTyForValidity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Type -&gt; ([Type], Type)
</span><a href="#local-6989586621683049120"><span class="hs-identifier hs-var">split_context</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ([Type], Type))
-&gt; (Type -&gt; Type) -&gt; Type -&gt; ([Type], Type)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621683049121"><span class="hs-identifier hs-var">drop_foralls</span></a></span><span>
</span><span id="line-2144"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2145"></span><span>    </span><span class="hs-comment">-- This is like 'dropForAlls', except that it does not look through type</span><span>
</span><span id="line-2146"></span><span>    </span><span class="hs-comment">-- synonyms.</span><span>
</span><span id="line-2147"></span><span>    </span><span class="annot"><a href="#local-6989586621683049121"><span class="hs-identifier hs-type">drop_foralls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-2148"></span><span>    </span><span id="local-6989586621683049121"><span class="annot"><span class="annottext">drop_foralls :: Type -&gt; Type
</span><a href="#local-6989586621683049121"><span class="hs-identifier hs-var hs-var">drop_foralls</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621683049123"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049123"><span class="hs-identifier hs-var">_tv</span></a></span></span><span> </span><span id="local-6989586621683049124"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683049124"><span class="hs-identifier hs-var">argf</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683049125"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049125"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2149"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; Bool
</span><a href="Language.Haskell.Syntax.Specificity.html#isInvisibleForAllTyFlag"><span class="hs-identifier hs-var">isInvisibleForAllTyFlag</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683049124"><span class="hs-identifier hs-var">argf</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621683049121"><span class="hs-identifier hs-var">drop_foralls</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049125"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2150"></span><span>    </span><span class="annot"><a href="#local-6989586621683049121"><span class="hs-identifier hs-var">drop_foralls</span></a></span><span> </span><span id="local-6989586621683049126"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049126"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049126"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2151"></span><span>
</span><span id="line-2152"></span><span>    </span><span class="hs-comment">-- This is like 'tcSplitPhiTy', except that it does not look through type</span><span>
</span><span id="line-2153"></span><span>    </span><span class="hs-comment">-- synonyms.</span><span>
</span><span id="line-2154"></span><span>    </span><span class="annot"><a href="#local-6989586621683049120"><span class="hs-identifier hs-type">split_context</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2155"></span><span>    </span><span id="local-6989586621683049120"><span class="annot"><span class="annottext">split_context :: [Type] -&gt; Type -&gt; ([Type], Type)
</span><a href="#local-6989586621683049120"><span class="hs-identifier hs-var hs-var">split_context</span></a></span></span><span> </span><span id="local-6989586621683049127"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049127"><span class="hs-identifier hs-var">preds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: Type -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049129"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683049129"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049130"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049130"><span class="hs-identifier hs-var">pred</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049131"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049131"><span class="hs-identifier hs-var">tau</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2156"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isInvisibleFunArg"><span class="hs-identifier hs-var">isInvisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621683049129"><span class="hs-identifier hs-var">af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Type -&gt; ([Type], Type)
</span><a href="#local-6989586621683049120"><span class="hs-identifier hs-var">split_context</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049130"><span class="hs-identifier hs-var">pred</span></a></span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; [Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049127"><span class="hs-identifier hs-var">preds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049131"><span class="hs-identifier hs-var">tau</span></a></span><span>
</span><span id="line-2157"></span><span>    </span><span class="annot"><a href="#local-6989586621683049120"><span class="hs-identifier hs-var">split_context</span></a></span><span> </span><span id="local-6989586621683049132"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049132"><span class="hs-identifier hs-var">preds</span></a></span></span><span> </span><span id="local-6989586621683049133"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049133"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; [Type]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049132"><span class="hs-identifier hs-var">preds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049133"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2158"></span><span>
</span><span id="line-2159"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkInstTermination"><span class="hs-identifier hs-type">checkInstTermination</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2160"></span><span class="hs-comment">-- See Note [Paterson conditions]</span><span>
</span><span id="line-2161"></span><span id="checkInstTermination"><span class="annot"><span class="annottext">checkInstTermination :: [Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkInstTermination"><span class="hs-identifier hs-var hs-var">checkInstTermination</span></a></span></span><span> </span><span id="local-6989586621683049136"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049136"><span class="hs-identifier hs-var">theta</span></a></span></span><span> </span><span id="local-6989586621683049137"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049137"><span class="hs-identifier hs-var">head_pred</span></a></span></span><span>
</span><span id="line-2162"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Type] -&gt; TcM ()
</span><a href="#local-6989586621683049138"><span class="hs-identifier hs-var">check_preds</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049136"><span class="hs-identifier hs-var">theta</span></a></span><span>
</span><span id="line-2163"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2164"></span><span>   </span><span id="local-6989586621683049140"><span class="annot"><span class="annottext">head_size :: PatersonSize
</span><a href="#local-6989586621683049140"><span class="hs-identifier hs-var hs-var">head_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; PatersonSize
</span><a href="GHC.Tc.Utils.TcType.html#pSizeType"><span class="hs-identifier hs-var">pSizeType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049137"><span class="hs-identifier hs-var">head_pred</span></a></span><span>
</span><span id="line-2165"></span><span>   </span><span class="hs-comment">-- This is inconsistent and probably wrong.  pSizeType does not filter out</span><span>
</span><span id="line-2166"></span><span>   </span><span class="hs-comment">-- invisible type args (making the instance head look big), whereas the use of</span><span>
</span><span id="line-2167"></span><span>   </span><span class="hs-comment">-- pSizeClassPredX below /does/ filter them out (making the tested constraints</span><span>
</span><span id="line-2168"></span><span>   </span><span class="hs-comment">-- look smaller). I'm sure there is non termination lurking here, but see #15177</span><span>
</span><span id="line-2169"></span><span>   </span><span class="hs-comment">-- for why I didn't change it. See Note [Invisible arguments and termination]</span><span>
</span><span id="line-2170"></span><span>   </span><span class="hs-comment">-- in GHC.Tc.Utils.TcType</span><span>
</span><span id="line-2171"></span><span>
</span><span id="line-2172"></span><span>   </span><span class="annot"><a href="#local-6989586621683049138"><span class="hs-identifier hs-type">check_preds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2173"></span><span>   </span><span id="local-6989586621683049138"><span class="annot"><span class="annottext">check_preds :: VarSet -&gt; [Type] -&gt; TcM ()
</span><a href="#local-6989586621683049138"><span class="hs-identifier hs-var hs-var">check_preds</span></a></span></span><span> </span><span id="local-6989586621683049141"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049141"><span class="hs-identifier hs-var">foralld_tvs</span></a></span></span><span> </span><span id="local-6989586621683049142"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049142"><span class="hs-identifier hs-var">preds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; TcM ()) -&gt; [Type] -&gt; TcM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; Type -&gt; TcM ()
</span><a href="#local-6989586621683049143"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049141"><span class="hs-identifier hs-var">foralld_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049142"><span class="hs-identifier hs-var">preds</span></a></span><span>
</span><span id="line-2174"></span><span>
</span><span id="line-2175"></span><span>   </span><span class="annot"><a href="#local-6989586621683049143"><span class="hs-identifier hs-type">check</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2176"></span><span>   </span><span id="local-6989586621683049143"><span class="annot"><span class="annottext">check :: VarSet -&gt; Type -&gt; TcM ()
</span><a href="#local-6989586621683049143"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span id="local-6989586621683049144"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049144"><span class="hs-identifier hs-var">foralld_tvs</span></a></span></span><span> </span><span id="local-6989586621683049145"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049145"><span class="hs-identifier hs-var">pred</span></a></span></span><span>
</span><span id="line-2177"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049145"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2178"></span><span>         </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See #4200.</span><span>
</span><span id="line-2179"></span><span>         </span><span class="annot"><a href="GHC.Core.Predicate.html#IrredPred"><span class="hs-identifier hs-type">IrredPred</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatersonSize -&gt; TcM ()
</span><a href="#local-6989586621683049146"><span class="hs-identifier hs-var">check2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; Type -&gt; PatersonSize
</span><a href="GHC.Tc.Utils.TcType.html#pSizeTypeX"><span class="hs-identifier hs-var">pSizeTypeX</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049144"><span class="hs-identifier hs-var">foralld_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049145"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2180"></span><span>
</span><span id="line-2181"></span><span>         </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621683049148"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049148"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621683049149"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049149"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-2182"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isCTupleClass"><span class="hs-identifier hs-var">isCTupleClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049148"><span class="hs-identifier hs-var">cls</span></a></span><span>  </span><span class="hs-comment">-- See Note [Tuples in checkInstTermination]</span><span>
</span><span id="line-2183"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Type] -&gt; TcM ()
</span><a href="#local-6989586621683049138"><span class="hs-identifier hs-var">check_preds</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049144"><span class="hs-identifier hs-var">foralld_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049149"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2184"></span><span>
</span><span id="line-2185"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-comment">-- Other ClassPreds</span><span>
</span><span id="line-2186"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatersonSize -&gt; TcM ()
</span><a href="#local-6989586621683049146"><span class="hs-identifier hs-var">check2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; Class -&gt; [Type] -&gt; PatersonSize
</span><a href="GHC.Tc.Utils.TcType.html#pSizeClassPredX"><span class="hs-identifier hs-var">pSizeClassPredX</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049144"><span class="hs-identifier hs-var">foralld_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049148"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049149"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2187"></span><span>
</span><span id="line-2188"></span><span>         </span><span class="annot"><a href="GHC.Core.Predicate.html#ForAllPred"><span class="hs-identifier hs-type">ForAllPred</span></a></span><span> </span><span id="local-6989586621683049151"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049151"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621683049152"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049152"><span class="hs-identifier hs-var">head_pred'</span></a></span></span><span>
</span><span id="line-2189"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; Type -&gt; TcM ()
</span><a href="#local-6989586621683049143"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049144"><span class="hs-identifier hs-var">foralld_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Var] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSetList"><span class="hs-operator hs-var">`extendVarSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049151"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049152"><span class="hs-identifier hs-var">head_pred'</span></a></span><span>
</span><span id="line-2190"></span><span>              </span><span class="hs-comment">-- Termination of the quantified predicate itself is checked</span><span>
</span><span id="line-2191"></span><span>              </span><span class="hs-comment">-- when the predicates are individually checked for validity</span><span>
</span><span id="line-2192"></span><span>
</span><span id="line-2193"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2194"></span><span>        </span><span id="local-6989586621683049146"><span class="annot"><span class="annottext">check2 :: PatersonSize -&gt; TcM ()
</span><a href="#local-6989586621683049146"><span class="hs-identifier hs-var hs-var">check2</span></a></span></span><span> </span><span id="local-6989586621683049154"><span class="annot"><span class="annottext">PatersonSize
</span><a href="#local-6989586621683049154"><span class="hs-identifier hs-var">pred_size</span></a></span></span><span>
</span><span id="line-2195"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PatersonSize
</span><a href="#local-6989586621683049154"><span class="hs-identifier hs-var">pred_size</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonSize -&gt; PatersonSize -&gt; Maybe PatersonCondFailure
</span><a href="GHC.Tc.Utils.TcType.html#ltPatersonSize"><span class="hs-operator hs-var">`ltPatersonSize`</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonSize
</span><a href="#local-6989586621683049140"><span class="hs-identifier hs-var">head_size</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2196"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683049155"><span class="annot"><span class="annottext">PatersonCondFailure
</span><a href="#local-6989586621683049155"><span class="hs-identifier hs-var">pc_failure</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatersonCondFailure
-&gt; PatersonCondFailureContext -&gt; Type -&gt; Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnPatersonCondFailure"><span class="hs-identifier hs-var">TcRnPatersonCondFailure</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonCondFailure
</span><a href="#local-6989586621683049155"><span class="hs-identifier hs-var">pc_failure</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonCondFailureContext
</span><a href="GHC.Tc.Utils.TcType.html#InInstanceDecl"><span class="hs-identifier hs-var">InInstanceDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049145"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049137"><span class="hs-identifier hs-var">head_pred</span></a></span><span>
</span><span id="line-2197"></span><span>              </span><span class="annot"><span class="annottext">Maybe PatersonCondFailure
</span><span class="hs-identifier hs-var">Nothing</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2198"></span><span>
</span><span id="line-2199"></span><span class="hs-comment">{- Note [Instances and constraint synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Currently, we don't allow instances for constraint synonyms at all.
Consider these (#13267):
  type C1 a = Show (a -&gt; Bool)
  instance C1 Int where    -- I1
    show _ = &quot;ur&quot;

This elicits &quot;show is not a (visible) method of class C1&quot;, which isn't
a great message. But it comes from the renamer, so it's hard to improve.

This needs a bit more care:
  type C2 a = (Show a, Show Int)
  instance C2 Int           -- I2

If we use (splitTyConApp_maybe tau) in checkValidInstance to decompose
the instance head, we'll expand the synonym on fly, and it'll look like
  instance (%,%) (Show Int, Show Int)
and we /really/ don't want that.  So we carefully do /not/ expand
synonyms, by matching on TyConApp directly.

For similar reasons, we do not use tcSplitSigmaTy when decomposing the instance
context, as the looks through type synonyms. If we looked through type
synonyms, then it could be possible to write an instance for a type synonym
involving a quantified constraint (see #22570). Instead, we define
splitInstTyForValidity, a specialized version of tcSplitSigmaTy (local to
GHC.Tc.Validity) that does not expand type synonyms.
-}</span><span>
</span><span id="line-2227"></span><span>
</span><span id="line-2228"></span><span>
</span><span id="line-2229"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Checking type instance well-formedness and termination
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-2236"></span><span>
</span><span id="line-2237"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidCoAxiom"><span class="hs-identifier hs-type">checkValidCoAxiom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#Branched"><span class="hs-identifier hs-type">Branched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2238"></span><span id="checkValidCoAxiom"><span class="annot"><span class="annottext">checkValidCoAxiom :: CoAxiom Branched -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidCoAxiom"><span class="hs-identifier hs-var hs-var">checkValidCoAxiom</span></a></span></span><span> </span><span id="local-6989586621683049158"><span class="annot"><span class="annottext">ax :: CoAxiom Branched
</span><a href="#local-6989586621683049158"><span class="hs-identifier hs-var">ax</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">co_ax_tc :: forall (br :: BranchFlag). CoAxiom br -&gt; TyCon
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_tc"><span class="hs-identifier hs-var">co_ax_tc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049161"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049161"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">co_ax_branches :: forall (br :: BranchFlag). CoAxiom br -&gt; Branches br
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_branches"><span class="hs-identifier hs-var">co_ax_branches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049163"><span class="annot"><span class="annottext">Branches Branched
</span><a href="#local-6989586621683049163"><span class="hs-identifier hs-var">branches</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2239"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">(CoAxBranch -&gt; TcM ()) -&gt; [CoAxBranch] -&gt; TcM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; CoAxBranch -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidCoAxBranch"><span class="hs-identifier hs-var">checkValidCoAxBranch</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049161"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049164"><span class="hs-identifier hs-var">branch_list</span></a></span><span>
</span><span id="line-2240"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">([CoAxBranch]
 -&gt; CoAxBranch -&gt; IOEnv (Env TcGblEnv TcLclEnv) [CoAxBranch])
-&gt; [CoAxBranch] -&gt; [CoAxBranch] -&gt; TcM ()
forall (m :: * -&gt; *) (t :: * -&gt; *) a b.
(Monad m, Foldable t) =&gt;
(a -&gt; b -&gt; m a) -&gt; a -&gt; t b -&gt; m ()
</span><a href="GHC.Utils.Monad.html#foldlM_"><span class="hs-identifier hs-var">foldlM_</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
-&gt; CoAxBranch -&gt; IOEnv (Env TcGblEnv TcLclEnv) [CoAxBranch]
</span><a href="#local-6989586621683049166"><span class="hs-identifier hs-var">check_branch_compat</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049164"><span class="hs-identifier hs-var">branch_list</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2241"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2242"></span><span>    </span><span id="local-6989586621683049164"><span class="annot"><span class="annottext">branch_list :: [CoAxBranch]
</span><a href="#local-6989586621683049164"><span class="hs-identifier hs-var hs-var">branch_list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Branches Branched -&gt; [CoAxBranch]
forall (br :: BranchFlag). Branches br -&gt; [CoAxBranch]
</span><a href="GHC.Core.Coercion.Axiom.html#fromBranches"><span class="hs-identifier hs-var">fromBranches</span></a></span><span> </span><span class="annot"><span class="annottext">Branches Branched
</span><a href="#local-6989586621683049163"><span class="hs-identifier hs-var">branches</span></a></span><span>
</span><span id="line-2243"></span><span>    </span><span id="local-6989586621683049168"><span class="annot"><span class="annottext">injectivity :: Injectivity
</span><a href="#local-6989586621683049168"><span class="hs-identifier hs-var hs-var">injectivity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Injectivity
</span><a href="GHC.Core.TyCon.html#tyConInjectivityInfo"><span class="hs-identifier hs-var">tyConInjectivityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049161"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2244"></span><span>
</span><span id="line-2245"></span><span>    </span><span class="annot"><a href="#local-6989586621683049166"><span class="hs-identifier hs-type">check_branch_compat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- previous branches in reverse order</span><span>
</span><span id="line-2246"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span>      </span><span class="hs-comment">-- current branch</span><span>
</span><span id="line-2247"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span class="hs-comment">-- current branch : previous branches</span><span>
</span><span id="line-2248"></span><span>    </span><span class="hs-comment">-- Check for</span><span>
</span><span id="line-2249"></span><span>    </span><span class="hs-comment">--   (a) this branch is dominated by previous ones</span><span>
</span><span id="line-2250"></span><span>    </span><span class="hs-comment">--   (b) failure of injectivity</span><span>
</span><span id="line-2251"></span><span>    </span><span id="local-6989586621683049166"><span class="annot"><span class="annottext">check_branch_compat :: [CoAxBranch]
-&gt; CoAxBranch -&gt; IOEnv (Env TcGblEnv TcLclEnv) [CoAxBranch]
</span><a href="#local-6989586621683049166"><span class="hs-identifier hs-var hs-var">check_branch_compat</span></a></span></span><span> </span><span id="local-6989586621683049170"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049170"><span class="hs-identifier hs-var">prev_branches</span></a></span></span><span> </span><span id="local-6989586621683049171"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049171"><span class="hs-identifier hs-var">cur_branch</span></a></span></span><span>
</span><span id="line-2252"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049171"><span class="hs-identifier hs-var">cur_branch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [CoAxBranch] -&gt; Bool
</span><a href="GHC.Core.FamInstEnv.html#isDominatedBy"><span class="hs-operator hs-var">`isDominatedBy`</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049170"><span class="hs-identifier hs-var">prev_branches</span></a></span><span>
</span><span id="line-2253"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683049172"><span class="annot"><span class="annottext">dia :: TcRnMessage
</span><a href="#local-6989586621683049172"><span class="hs-identifier hs-var hs-var hs-var">dia</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; CoAxBranch -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnInaccessibleCoAxBranch"><span class="hs-identifier hs-var">TcRnInaccessibleCoAxBranch</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049161"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049171"><span class="hs-identifier hs-var">cur_branch</span></a></span><span>
</span><span id="line-2254"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SrcSpan -&gt; TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#addDiagnosticAt"><span class="hs-identifier hs-var">addDiagnosticAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxBranch -&gt; SrcSpan
</span><a href="GHC.Core.Coercion.Axiom.html#coAxBranchSpan"><span class="hs-identifier hs-var">coAxBranchSpan</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049171"><span class="hs-identifier hs-var">cur_branch</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcRnMessage
</span><a href="#local-6989586621683049172"><span class="hs-identifier hs-var">dia</span></a></span><span>
</span><span id="line-2255"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [CoAxBranch]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049170"><span class="hs-identifier hs-var">prev_branches</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2256"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2257"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch] -&gt; CoAxBranch -&gt; TcM ()
</span><a href="#local-6989586621683049176"><span class="hs-identifier hs-var">check_injectivity</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049170"><span class="hs-identifier hs-var">prev_branches</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049171"><span class="hs-identifier hs-var">cur_branch</span></a></span><span>
</span><span id="line-2258"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [CoAxBranch]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049171"><span class="hs-identifier hs-var">cur_branch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [CoAxBranch] -&gt; [CoAxBranch]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049170"><span class="hs-identifier hs-var">prev_branches</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2259"></span><span>
</span><span id="line-2260"></span><span>     </span><span class="hs-comment">-- Injectivity check: check whether a new (CoAxBranch) can extend</span><span>
</span><span id="line-2261"></span><span>     </span><span class="hs-comment">-- already checked equations without violating injectivity</span><span>
</span><span id="line-2262"></span><span>     </span><span class="hs-comment">-- annotation supplied by the user.</span><span>
</span><span id="line-2263"></span><span>     </span><span class="hs-comment">-- See Note [Verifying injectivity annotation] in GHC.Core.FamInstEnv</span><span>
</span><span id="line-2264"></span><span>    </span><span id="local-6989586621683049176"><span class="annot"><span class="annottext">check_injectivity :: [CoAxBranch] -&gt; CoAxBranch -&gt; TcM ()
</span><a href="#local-6989586621683049176"><span class="hs-identifier hs-var hs-var">check_injectivity</span></a></span></span><span> </span><span id="local-6989586621683049177"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049177"><span class="hs-identifier hs-var">prev_branches</span></a></span></span><span> </span><span id="local-6989586621683049178"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049178"><span class="hs-identifier hs-var">cur_branch</span></a></span></span><span>
</span><span id="line-2265"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#Injective"><span class="hs-identifier hs-type">Injective</span></a></span><span> </span><span id="local-6989586621683049180"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683049180"><span class="hs-identifier hs-var">inj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Injectivity
</span><a href="#local-6989586621683049168"><span class="hs-identifier hs-var">injectivity</span></a></span><span>
</span><span id="line-2266"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683049181"><span class="annot"><a href="#local-6989586621683049181"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-2267"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683049182"><span class="annot"><a href="#local-6989586621683049182"><span class="hs-identifier hs-var hs-var">conflicts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2268"></span><span>                     </span><span class="annot"><span class="annottext">([CoAxBranch], Int) -&gt; [CoAxBranch]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(([CoAxBranch], Int) -&gt; [CoAxBranch])
-&gt; ([CoAxBranch], Int) -&gt; [CoAxBranch]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(([CoAxBranch], Int) -&gt; CoAxBranch -&gt; ([CoAxBranch], Int))
-&gt; ([CoAxBranch], Int) -&gt; [CoAxBranch] -&gt; ([CoAxBranch], Int)
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool]
-&gt; [CoAxBranch]
-&gt; CoAxBranch
-&gt; ([CoAxBranch], Int)
-&gt; CoAxBranch
-&gt; ([CoAxBranch], Int)
</span><a href="#local-6989586621683049185"><span class="hs-identifier hs-var">gather_conflicts</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683049180"><span class="hs-identifier hs-var">inj</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049177"><span class="hs-identifier hs-var">prev_branches</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049178"><span class="hs-identifier hs-var">cur_branch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2269"></span><span>                                 </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049177"><span class="hs-identifier hs-var">prev_branches</span></a></span><span>
</span><span id="line-2270"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Family.html#reportConflictingInjectivityErrs"><span class="hs-identifier hs-type">reportConflictingInjectivityErrs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049161"><span class="hs-identifier hs-type">fam_tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049182"><span class="hs-identifier hs-type">conflicts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049178"><span class="hs-identifier hs-type">cur_branch</span></a></span><span>
</span><span id="line-2271"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Family.html#reportInjectivityErrors"><span class="hs-identifier hs-type">reportInjectivityErrors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049181"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049158"><span class="hs-identifier hs-type">ax</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049178"><span class="hs-identifier hs-type">cur_branch</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049180"><span class="hs-identifier hs-type">inj</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2272"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2273"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2274"></span><span>
</span><span id="line-2275"></span><span>    </span><span id="local-6989586621683049185"><span class="annot"><span class="annottext">gather_conflicts :: [Bool]
-&gt; [CoAxBranch]
-&gt; CoAxBranch
-&gt; ([CoAxBranch], Int)
-&gt; CoAxBranch
-&gt; ([CoAxBranch], Int)
</span><a href="#local-6989586621683049185"><span class="hs-identifier hs-var hs-var">gather_conflicts</span></a></span></span><span> </span><span id="local-6989586621683049194"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683049194"><span class="hs-identifier hs-var">inj</span></a></span></span><span> </span><span id="local-6989586621683049195"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049195"><span class="hs-identifier hs-var">prev_branches</span></a></span></span><span> </span><span id="local-6989586621683049196"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049196"><span class="hs-identifier hs-var">cur_branch</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683049197"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049197"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049198"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683049198"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683049199"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049199"><span class="hs-identifier hs-var">branch</span></a></span></span><span>
</span><span id="line-2276"></span><span>               </span><span class="hs-comment">-- n is 0-based index of branch in prev_branches</span><span>
</span><span id="line-2277"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; CoAxBranch -&gt; CoAxBranch -&gt; InjectivityCheckResult
</span><a href="GHC.Core.FamInstEnv.html#injectiveBranches"><span class="hs-identifier hs-var">injectiveBranches</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621683049194"><span class="hs-identifier hs-var">inj</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049196"><span class="hs-identifier hs-var">cur_branch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049199"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2278"></span><span>           </span><span class="hs-comment">-- Case 1B2 in Note [Verifying injectivity annotation] in GHC.Core.FamInstEnv</span><span>
</span><span id="line-2279"></span><span>          </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#InjectivityUnified"><span class="hs-identifier hs-type">InjectivityUnified</span></a></span><span> </span><span id="local-6989586621683049201"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049201"><span class="hs-identifier hs-var">ax1</span></a></span></span><span> </span><span id="local-6989586621683049202"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049202"><span class="hs-identifier hs-var">ax2</span></a></span></span><span>
</span><span id="line-2280"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049201"><span class="hs-identifier hs-var">ax1</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [CoAxBranch] -&gt; Bool
</span><a href="GHC.Core.FamInstEnv.html#isDominatedBy"><span class="hs-operator hs-var">`isDominatedBy`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoAxBranch] -&gt; Int -&gt; CoAxBranch -&gt; [CoAxBranch]
</span><a href="#local-6989586621683049203"><span class="hs-identifier hs-var">replace_br</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049195"><span class="hs-identifier hs-var">prev_branches</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683049198"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049202"><span class="hs-identifier hs-var">ax2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2281"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049197"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683049198"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-2282"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2283"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049199"><span class="hs-identifier hs-var">branch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [CoAxBranch] -&gt; [CoAxBranch]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049197"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683049198"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-2284"></span><span>          </span><span class="annot"><span class="annottext">InjectivityCheckResult
</span><a href="GHC.Core.FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier hs-var">InjectivityAccepted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049197"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683049198"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-2285"></span><span>
</span><span id="line-2286"></span><span>    </span><span class="hs-comment">-- Replace n-th element in the list. Assumes 0-based indexing.</span><span>
</span><span id="line-2287"></span><span>    </span><span class="annot"><a href="#local-6989586621683049203"><span class="hs-identifier hs-type">replace_br</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2288"></span><span>    </span><span id="local-6989586621683049203"><span class="annot"><span class="annottext">replace_br :: [CoAxBranch] -&gt; Int -&gt; CoAxBranch -&gt; [CoAxBranch]
</span><a href="#local-6989586621683049203"><span class="hs-identifier hs-var hs-var">replace_br</span></a></span></span><span> </span><span id="local-6989586621683049206"><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049206"><span class="hs-identifier hs-var">brs</span></a></span></span><span> </span><span id="local-6989586621683049207"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683049207"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621683049208"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049208"><span class="hs-identifier hs-var">br</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [CoAxBranch] -&gt; [CoAxBranch]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683049207"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049206"><span class="hs-identifier hs-var">brs</span></a></span><span> </span><span class="annot"><span class="annottext">[CoAxBranch] -&gt; [CoAxBranch] -&gt; [CoAxBranch]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049208"><span class="hs-identifier hs-var">br</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch] -&gt; [CoAxBranch] -&gt; [CoAxBranch]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [CoAxBranch] -&gt; [CoAxBranch]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621683049207"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoAxBranch]
</span><a href="#local-6989586621683049206"><span class="hs-identifier hs-var">brs</span></a></span><span>
</span><span id="line-2289"></span><span>
</span><span id="line-2290"></span><span>
</span><span id="line-2291"></span><span class="hs-comment">-- Check that a &quot;type instance&quot; is well-formed (which includes decidability</span><span>
</span><span id="line-2292"></span><span class="hs-comment">-- unless -XUndecidableInstances is given).</span><span>
</span><span id="line-2293"></span><span class="hs-comment">--</span><span>
</span><span id="line-2294"></span><span class="hs-comment">-- See also the separate 'checkFamPatBinders' which performs scoping checks</span><span>
</span><span id="line-2295"></span><span class="hs-comment">-- on a type family equation.</span><span>
</span><span id="line-2296"></span><span class="hs-comment">-- (It's separate because it expects 'TyFamEqnValidityInfo', which comes from a</span><span>
</span><span id="line-2297"></span><span class="hs-comment">-- separate place e.g. for associated type defaults.)</span><span>
</span><span id="line-2298"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidCoAxBranch"><span class="hs-identifier hs-type">checkValidCoAxBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2299"></span><span id="checkValidCoAxBranch"><span class="annot"><span class="annottext">checkValidCoAxBranch :: TyCon -&gt; CoAxBranch -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidCoAxBranch"><span class="hs-identifier hs-var hs-var">checkValidCoAxBranch</span></a></span></span><span> </span><span id="local-6989586621683049211"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049211"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span>
</span><span id="line-2300"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cab_lhs :: CoAxBranch -&gt; [Type]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049214"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049214"><span class="hs-identifier hs-var">typats</span></a></span></span><span>
</span><span id="line-2301"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_rhs :: CoAxBranch -&gt; Type
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049216"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049216"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cab_loc :: CoAxBranch -&gt; SrcSpan
</span><a href="GHC.Core.Coercion.Axiom.html#cab_loc"><span class="hs-identifier hs-var">cab_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049218"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683049218"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2302"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpan -&gt; TcM () -&gt; TcM ()
forall a. SrcSpan -&gt; TcRn a -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683049218"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2303"></span><span>    </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidTyFamEqn"><span class="hs-identifier hs-var">checkValidTyFamEqn</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049211"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049214"><span class="hs-identifier hs-var">typats</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049216"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2304"></span><span>
</span><span id="line-2305"></span><span class="hs-comment">-- | Do validity checks on a type family equation, including consistency</span><span>
</span><span id="line-2306"></span><span class="hs-comment">-- with any enclosing class instance head, termination, and lack of</span><span>
</span><span id="line-2307"></span><span class="hs-comment">-- polytypes.</span><span>
</span><span id="line-2308"></span><span class="hs-comment">--</span><span>
</span><span id="line-2309"></span><span class="hs-comment">-- See also the separate 'checkFamPatBinders' which performs scoping checks</span><span>
</span><span id="line-2310"></span><span class="hs-comment">-- on a type family equation.</span><span>
</span><span id="line-2311"></span><span class="hs-comment">-- (It's separate because it expects 'TyFamEqnValidityInfo', which comes from a</span><span>
</span><span id="line-2312"></span><span class="hs-comment">-- separate place e.g. for associated type defaults.)</span><span>
</span><span id="line-2313"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidTyFamEqn"><span class="hs-identifier hs-type">checkValidTyFamEqn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ of the type family</span></span><span>
</span><span id="line-2314"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Type patterns</span></span><span>
</span><span id="line-2315"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Rhs</span></span><span>
</span><span id="line-2316"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2317"></span><span id="checkValidTyFamEqn"><span class="annot"><span class="annottext">checkValidTyFamEqn :: TyCon -&gt; [Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidTyFamEqn"><span class="hs-identifier hs-var hs-var">checkValidTyFamEqn</span></a></span></span><span> </span><span id="local-6989586621683049220"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049220"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683049221"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049221"><span class="hs-identifier hs-var">typats</span></a></span></span><span> </span><span id="local-6989586621683049222"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049222"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2318"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidTypePats"><span class="hs-identifier hs-var">checkValidTypePats</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049220"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049221"><span class="hs-identifier hs-var">typats</span></a></span><span>
</span><span id="line-2319"></span><span>
</span><span id="line-2320"></span><span>         </span><span class="hs-comment">-- Check for oversaturated visible kind arguments in a type family</span><span>
</span><span id="line-2321"></span><span>         </span><span class="hs-comment">-- equation.</span><span>
</span><span id="line-2322"></span><span>         </span><span class="hs-comment">-- See Note [Oversaturated type family equations]</span><span>
</span><span id="line-2323"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcM () -&gt; TcM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049220"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2324"></span><span>           </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Int
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049220"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049221"><span class="hs-identifier hs-var">typats</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2325"></span><span>             </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2326"></span><span>             </span><span id="local-6989586621683049223"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049223"><span class="hs-identifier hs-var">spec_arg</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2327"></span><span>               </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnOversaturatedVisibleKindArg"><span class="hs-identifier hs-var">TcRnOversaturatedVisibleKindArg</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049223"><span class="hs-identifier hs-var">spec_arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2328"></span><span>
</span><span id="line-2329"></span><span>         </span><span class="hs-comment">-- The argument patterns, and RHS, are all boxed tau types</span><span>
</span><span id="line-2330"></span><span>         </span><span class="hs-comment">-- E.g  Reject type family F (a :: k1) :: k2</span><span>
</span><span id="line-2331"></span><span>         </span><span class="hs-comment">--             type instance F (forall a. a-&gt;a) = ...</span><span>
</span><span id="line-2332"></span><span>         </span><span class="hs-comment">--             type instance F Int#             = ...</span><span>
</span><span id="line-2333"></span><span>         </span><span class="hs-comment">--             type instance F Int              = forall a. a-&gt;a</span><span>
</span><span id="line-2334"></span><span>         </span><span class="hs-comment">--             type instance F Int              = Int#</span><span>
</span><span id="line-2335"></span><span>         </span><span class="hs-comment">-- See #9357</span><span>
</span><span id="line-2336"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidMonoType"><span class="hs-identifier hs-var">checkValidMonoType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049222"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2337"></span><span>
</span><span id="line-2338"></span><span>         </span><span class="hs-comment">-- We have a decidable instance unless otherwise permitted</span><span>
</span><span id="line-2339"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621683049226"><span class="annot"><a href="#local-6989586621683049226"><span class="hs-identifier hs-var">undecidable_ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; TcRnIf TcGblEnv TcLclEnv Bool
forall gbl lcl. Extension -&gt; TcRnIf gbl lcl Bool
</span><a href="GHC.Tc.Utils.Monad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.UndecidableInstances</span></span><span>
</span><span id="line-2340"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-type">traceTc</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;checkVTFE&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049220"><span class="hs-identifier hs-type">fam_tc</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049222"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcTyFamInsts"><span class="hs-identifier hs-type">tcTyFamInsts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049222"><span class="hs-identifier hs-type">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2341"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unless</span></span><span> </span><span class="annot"><a href="#local-6989586621683049226"><span class="hs-identifier hs-type">undecidable_ok</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2342"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html#addErrTc"><span class="hs-identifier hs-type">addErrTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Validity.html#checkFamInstRhs"><span class="hs-identifier hs-type">checkFamInstRhs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049220"><span class="hs-identifier hs-type">fam_tc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049221"><span class="hs-identifier hs-type">typats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#tcTyFamInsts"><span class="hs-identifier hs-type">tcTyFamInsts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049222"><span class="hs-identifier hs-type">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2343"></span><span>
</span><span id="line-2344"></span><span class="hs-comment">-- | Checks that an associated type family default:</span><span>
</span><span id="line-2345"></span><span class="hs-comment">--</span><span>
</span><span id="line-2346"></span><span class="hs-comment">-- 1. Only consists of arguments that are bare type variables, and</span><span>
</span><span id="line-2347"></span><span class="hs-comment">--</span><span>
</span><span id="line-2348"></span><span class="hs-comment">-- 2. Has a distinct type variable in each argument.</span><span>
</span><span id="line-2349"></span><span class="hs-comment">--</span><span>
</span><span id="line-2350"></span><span class="hs-comment">-- See @Note [Type-checking default assoc decls]@ in &quot;GHC.Tc.TyCl&quot;.</span><span>
</span><span id="line-2351"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidAssocTyFamDeflt"><span class="hs-identifier hs-type">checkValidAssocTyFamDeflt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ of the type family</span></span><span>
</span><span id="line-2352"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ Type patterns</span></span><span>
</span><span id="line-2353"></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2354"></span><span id="checkValidAssocTyFamDeflt"><span class="annot"><span class="annottext">checkValidAssocTyFamDeflt :: TyCon -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidAssocTyFamDeflt"><span class="hs-identifier hs-var hs-var">checkValidAssocTyFamDeflt</span></a></span></span><span> </span><span id="local-6989586621683049229"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049229"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683049230"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049230"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2355"></span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621683049231"><span class="annot"><a href="#local-6989586621683049231"><span class="hs-identifier hs-var">cpt_tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ForAllTyFlag -&gt; IOEnv (Env TcGblEnv TcLclEnv) Var)
-&gt; [Type] -&gt; [ForAllTyFlag] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [Var]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; ForAllTyFlag -&gt; IOEnv (Env TcGblEnv TcLclEnv) Var
</span><a href="#local-6989586621683049233"><span class="hs-identifier hs-var">extract_tv</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049230"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">[ForAllTyFlag]
</span><a href="#local-6989586621683049234"><span class="hs-identifier hs-var">pats_vis</span></a></span><span>
</span><span id="line-2356"></span><span>     </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621683049235"><span class="hs-identifier hs-type">check_all_distinct_tvs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">zip</span></span><span> </span><span class="annot"><a href="#local-6989586621683049231"><span class="hs-identifier hs-type">cpt_tvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621683049234"><span class="hs-identifier hs-type">pats_vis</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2357"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2358"></span><span>    </span><span class="annot"><a href="#local-6989586621683049234"><span class="hs-identifier hs-type">pats_vis</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">ForAllTyFlag</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2359"></span><span>    </span><span id="local-6989586621683049234"><span class="annot"><span class="annottext">pats_vis :: [ForAllTyFlag]
</span><a href="#local-6989586621683049234"><span class="hs-identifier hs-var hs-var">pats_vis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [ForAllTyFlag]
</span><a href="GHC.Core.Type.html#tyConForAllTyFlags"><span class="hs-identifier hs-var">tyConForAllTyFlags</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049229"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049230"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2360"></span><span>
</span><span id="line-2361"></span><span>    </span><span class="hs-comment">-- Checks that a pattern on the LHS of a default is a type</span><span>
</span><span id="line-2362"></span><span>    </span><span class="hs-comment">-- variable. If so, return the underlying type variable, and if</span><span>
</span><span id="line-2363"></span><span>    </span><span class="hs-comment">-- not, throw an error.</span><span>
</span><span id="line-2364"></span><span>    </span><span class="hs-comment">-- See Note [Type-checking default assoc decls]</span><span>
</span><span id="line-2365"></span><span>    </span><span class="annot"><a href="#local-6989586621683049233"><span class="hs-identifier hs-type">extract_tv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>          </span><span class="hs-comment">-- The particular type pattern from which to</span><span>
</span><span id="line-2366"></span><span>                                </span><span class="hs-comment">-- extrace its underlying type variable</span><span>
</span><span id="line-2367"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">ForAllTyFlag</span></a></span><span>  </span><span class="hs-comment">-- The visibility of the type pattern</span><span>
</span><span id="line-2368"></span><span>                                </span><span class="hs-comment">-- (only used for error message purposes)</span><span>
</span><span id="line-2369"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span>
</span><span id="line-2370"></span><span>    </span><span id="local-6989586621683049233"><span class="annot"><span class="annottext">extract_tv :: Type -&gt; ForAllTyFlag -&gt; IOEnv (Env TcGblEnv TcLclEnv) Var
</span><a href="#local-6989586621683049233"><span class="hs-identifier hs-var hs-var">extract_tv</span></a></span></span><span> </span><span id="local-6989586621683049238"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049238"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621683049239"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683049239"><span class="hs-identifier hs-var">pat_vis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2371"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Var
</span><a href="GHC.Core.Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049238"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2372"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683049240"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049240"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Var -&gt; IOEnv (Env TcGblEnv TcLclEnv) Var
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049240"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-2373"></span><span>        </span><span class="annot"><span class="annottext">Maybe Var
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; IOEnv (Env TcGblEnv TcLclEnv) Var
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; IOEnv (Env TcGblEnv TcLclEnv) Var)
-&gt; TcRnMessage -&gt; IOEnv (Env TcGblEnv TcLclEnv) Var
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceReason -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalInstance"><span class="hs-identifier hs-var">TcRnIllegalInstance</span></a></span><span>
</span><span id="line-2374"></span><span>                              </span><span class="annot"><span class="annottext">(IllegalInstanceReason -&gt; TcRnMessage)
-&gt; IllegalInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalFamilyInstance"><span class="hs-identifier hs-var">IllegalFamilyInstance</span></a></span><span>
</span><span id="line-2375"></span><span>                              </span><span class="annot"><span class="annottext">(IllegalFamilyInstanceReason -&gt; IllegalInstanceReason)
-&gt; IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InvalidAssoc -&gt; IllegalFamilyInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#InvalidAssoc"><span class="hs-identifier hs-var">InvalidAssoc</span></a></span><span> </span><span class="annot"><span class="annottext">(InvalidAssoc -&gt; IllegalFamilyInstanceReason)
-&gt; InvalidAssoc -&gt; IllegalFamilyInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InvalidAssocDefault -&gt; InvalidAssoc
</span><a href="GHC.Tc.Errors.Types.html#InvalidAssocDefault"><span class="hs-identifier hs-var">InvalidAssocDefault</span></a></span><span>
</span><span id="line-2376"></span><span>                              </span><span class="annot"><span class="annottext">(InvalidAssocDefault -&gt; InvalidAssoc)
-&gt; InvalidAssocDefault -&gt; InvalidAssoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; AssocDefaultBadArgs -&gt; InvalidAssocDefault
</span><a href="GHC.Tc.Errors.Types.html#AssocDefaultBadArgs"><span class="hs-identifier hs-var">AssocDefaultBadArgs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049229"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049230"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2377"></span><span>                              </span><span class="annot"><span class="annottext">(AssocDefaultBadArgs -&gt; InvalidAssocDefault)
-&gt; AssocDefaultBadArgs -&gt; InvalidAssocDefault
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Type, ForAllTyFlag) -&gt; AssocDefaultBadArgs
</span><a href="GHC.Tc.Errors.Types.html#AssocDefaultNonTyVarArg"><span class="hs-identifier hs-var">AssocDefaultNonTyVarArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049238"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683049239"><span class="hs-identifier hs-var">pat_vis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2378"></span><span>
</span><span id="line-2379"></span><span>    </span><span class="hs-comment">-- Checks that no type variables in an associated default declaration are</span><span>
</span><span id="line-2380"></span><span>    </span><span class="hs-comment">-- duplicated. If that is the case, throw an error.</span><span>
</span><span id="line-2381"></span><span>    </span><span class="hs-comment">-- See Note [Type-checking default assoc decls]</span><span>
</span><span id="line-2382"></span><span>    </span><span class="annot"><a href="#local-6989586621683049235"><span class="hs-identifier hs-type">check_all_distinct_tvs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-2383"></span><span>         </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">ForAllTyFlag</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The type variable arguments in the associated</span><span>
</span><span id="line-2384"></span><span>                            </span><span class="hs-comment">-- default declaration, along with their respective</span><span>
</span><span id="line-2385"></span><span>                            </span><span class="hs-comment">-- visibilities (the latter are only used for error</span><span>
</span><span id="line-2386"></span><span>                            </span><span class="hs-comment">-- message purposes)</span><span>
</span><span id="line-2387"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2388"></span><span>    </span><span id="local-6989586621683049235"><span class="annot"><span class="annottext">check_all_distinct_tvs :: [(Var, ForAllTyFlag)] -&gt; TcM ()
</span><a href="#local-6989586621683049235"><span class="hs-identifier hs-var hs-var">check_all_distinct_tvs</span></a></span></span><span> </span><span id="local-6989586621683049246"><span class="annot"><span class="annottext">[(Var, ForAllTyFlag)]
</span><a href="#local-6989586621683049246"><span class="hs-identifier hs-var">cpt_tvs_vis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2389"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683049247"><span class="annot"><span class="annottext">dups :: [NonEmpty (Var, ForAllTyFlag)]
</span><a href="#local-6989586621683049247"><span class="hs-identifier hs-var hs-var">dups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Var, ForAllTyFlag) -&gt; (Var, ForAllTyFlag) -&gt; Bool)
-&gt; [(Var, ForAllTyFlag)] -&gt; [NonEmpty (Var, ForAllTyFlag)]
forall a. (a -&gt; a -&gt; Bool) -&gt; [a] -&gt; [NonEmpty a]
</span><a href="GHC.Data.List.SetOps.html#findDupsEq"><span class="hs-identifier hs-var">findDupsEq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Var -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(==)</span></span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Var -&gt; Bool)
-&gt; ((Var, ForAllTyFlag) -&gt; Var)
-&gt; (Var, ForAllTyFlag)
-&gt; (Var, ForAllTyFlag)
-&gt; Bool
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">(Var, ForAllTyFlag) -&gt; Var
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Var, ForAllTyFlag)]
</span><a href="#local-6989586621683049246"><span class="hs-identifier hs-var">cpt_tvs_vis</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-2390"></span><span>      </span><span class="annot"><span class="annottext">(NonEmpty (Var, ForAllTyFlag)
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) (ZonkAny 0))
-&gt; [NonEmpty (Var, ForAllTyFlag)] -&gt; TcM ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span>
</span><span id="line-2391"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621683049251"><span class="annot"><span class="annottext">NonEmpty (Var, ForAllTyFlag)
</span><a href="#local-6989586621683049251"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; IOEnv (Env TcGblEnv TcLclEnv) (ZonkAny 0)
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; IOEnv (Env TcGblEnv TcLclEnv) (ZonkAny 0))
-&gt; TcRnMessage -&gt; IOEnv (Env TcGblEnv TcLclEnv) (ZonkAny 0)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceReason -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalInstance"><span class="hs-identifier hs-var">TcRnIllegalInstance</span></a></span><span>
</span><span id="line-2392"></span><span>                          </span><span class="annot"><span class="annottext">(IllegalInstanceReason -&gt; TcRnMessage)
-&gt; IllegalInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalFamilyInstance"><span class="hs-identifier hs-var">IllegalFamilyInstance</span></a></span><span>
</span><span id="line-2393"></span><span>                          </span><span class="annot"><span class="annottext">(IllegalFamilyInstanceReason -&gt; IllegalInstanceReason)
-&gt; IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InvalidAssoc -&gt; IllegalFamilyInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#InvalidAssoc"><span class="hs-identifier hs-var">InvalidAssoc</span></a></span><span> </span><span class="annot"><span class="annottext">(InvalidAssoc -&gt; IllegalFamilyInstanceReason)
-&gt; InvalidAssoc -&gt; IllegalFamilyInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InvalidAssocDefault -&gt; InvalidAssoc
</span><a href="GHC.Tc.Errors.Types.html#InvalidAssocDefault"><span class="hs-identifier hs-var">InvalidAssocDefault</span></a></span><span>
</span><span id="line-2394"></span><span>                          </span><span class="annot"><span class="annottext">(InvalidAssocDefault -&gt; InvalidAssoc)
-&gt; InvalidAssocDefault -&gt; InvalidAssoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; AssocDefaultBadArgs -&gt; InvalidAssocDefault
</span><a href="GHC.Tc.Errors.Types.html#AssocDefaultBadArgs"><span class="hs-identifier hs-var">AssocDefaultBadArgs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049229"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049230"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2395"></span><span>                          </span><span class="annot"><span class="annottext">(AssocDefaultBadArgs -&gt; InvalidAssocDefault)
-&gt; AssocDefaultBadArgs -&gt; InvalidAssocDefault
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Var, ForAllTyFlag) -&gt; AssocDefaultBadArgs
</span><a href="GHC.Tc.Errors.Types.html#AssocDefaultDuplicateTyVars"><span class="hs-identifier hs-var">AssocDefaultDuplicateTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Var, ForAllTyFlag)
</span><a href="#local-6989586621683049251"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2396"></span><span>        </span><span class="annot"><span class="annottext">[NonEmpty (Var, ForAllTyFlag)]
</span><a href="#local-6989586621683049247"><span class="hs-identifier hs-var">dups</span></a></span><span>
</span><span id="line-2397"></span><span>
</span><span id="line-2398"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkFamInstRhs"><span class="hs-identifier hs-type">checkFamInstRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- LHS</span><span>
</span><span id="line-2399"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- type family calls in RHS</span><span>
</span><span id="line-2400"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Errors.Types.html#TcRnMessage"><span class="hs-identifier hs-type">TcRnMessage</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2401"></span><span class="hs-comment">-- Ensure that the type family instance terminates. Specifically:</span><span>
</span><span id="line-2402"></span><span class="hs-comment">-- ensure that each type family application in the RHS is</span><span>
</span><span id="line-2403"></span><span class="hs-comment">--    (TF1) a call to a stuck family like (TypeError ...) or Any</span><span>
</span><span id="line-2404"></span><span class="hs-comment">--          See Note [Stuck type families] in GHC.Tc.Utils.TcType</span><span>
</span><span id="line-2405"></span><span class="hs-comment">-- or (TF2) obeys the Paterson conditions, namely:</span><span>
</span><span id="line-2406"></span><span class="hs-comment">--          - strictly smaller than the lhs,</span><span>
</span><span id="line-2407"></span><span class="hs-comment">--          - mentions no type variable more often than the lhs, and</span><span>
</span><span id="line-2408"></span><span class="hs-comment">--          - does not contain any further type family applications</span><span>
</span><span id="line-2409"></span><span id="checkFamInstRhs"><span class="annot"><span class="annottext">checkFamInstRhs :: TyCon -&gt; [Type] -&gt; [(TyCon, [Type])] -&gt; [TcRnMessage]
</span><a href="GHC.Tc.Validity.html#checkFamInstRhs"><span class="hs-identifier hs-var hs-var">checkFamInstRhs</span></a></span></span><span> </span><span id="local-6989586621683049253"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049253"><span class="hs-identifier hs-var">lhs_tc</span></a></span></span><span> </span><span id="local-6989586621683049254"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049254"><span class="hs-identifier hs-var">lhs_tys</span></a></span></span><span> </span><span id="local-6989586621683049255"><span class="annot"><span class="annottext">[(TyCon, [Type])]
</span><a href="#local-6989586621683049255"><span class="hs-identifier hs-var">famInsts</span></a></span></span><span>
</span><span id="line-2410"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TyCon, [Type]) -&gt; Maybe TcRnMessage)
-&gt; [(TyCon, [Type])] -&gt; [TcRnMessage]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">(TyCon, [Type]) -&gt; Maybe TcRnMessage
</span><a href="#local-6989586621683049256"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">[(TyCon, [Type])]
</span><a href="#local-6989586621683049255"><span class="hs-identifier hs-var">famInsts</span></a></span><span>
</span><span id="line-2411"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2412"></span><span>   </span><span id="local-6989586621683049257"><span class="annot"><span class="annottext">lhs_size :: PatersonSize
</span><a href="#local-6989586621683049257"><span class="hs-identifier hs-var hs-var">lhs_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; PatersonSize
</span><a href="GHC.Tc.Utils.TcType.html#pSizeTypes"><span class="hs-identifier hs-var">pSizeTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049254"><span class="hs-identifier hs-var">lhs_tys</span></a></span><span>
</span><span id="line-2413"></span><span>   </span><span id="local-6989586621683049256"><span class="annot"><span class="annottext">check :: (TyCon, [Type]) -&gt; Maybe TcRnMessage
</span><a href="#local-6989586621683049256"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683049259"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049259"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049260"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049260"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2414"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isStuckTypeFamily"><span class="hs-identifier hs-var">isStuckTypeFamily</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049259"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>                                   </span><span class="hs-comment">-- (TF1)</span><span>
</span><span id="line-2415"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683049262"><span class="annot"><span class="annottext">PatersonCondFailure
</span><a href="#local-6989586621683049262"><span class="hs-identifier hs-var">pc_failure</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; PatersonSize
</span><a href="GHC.Tc.Utils.TcType.html#pSizeTypes"><span class="hs-identifier hs-var">pSizeTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049260"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonSize -&gt; PatersonSize -&gt; Maybe PatersonCondFailure
</span><a href="GHC.Tc.Utils.TcType.html#ltPatersonSize"><span class="hs-operator hs-var">`ltPatersonSize`</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonSize
</span><a href="#local-6989586621683049257"><span class="hs-identifier hs-var">lhs_size</span></a></span><span>  </span><span class="hs-comment">-- (TF2)</span><span>
</span><span id="line-2416"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; Maybe TcRnMessage
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; Maybe TcRnMessage)
-&gt; TcRnMessage -&gt; Maybe TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatersonCondFailure
-&gt; PatersonCondFailureContext -&gt; Type -&gt; Type -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnPatersonCondFailure"><span class="hs-identifier hs-var">TcRnPatersonCondFailure</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonCondFailure
</span><a href="#local-6989586621683049262"><span class="hs-identifier hs-var">pc_failure</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonCondFailureContext
</span><a href="GHC.Tc.Utils.TcType.html#InTyFamEquation"><span class="hs-identifier hs-var">InTyFamEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049253"><span class="hs-identifier hs-var">lhs_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049254"><span class="hs-identifier hs-var">lhs_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049259"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049260"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2417"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2418"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TcRnMessage
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2419"></span><span>
</span><span id="line-2420"></span><span class="hs-comment">-----------------</span><span>
</span><span id="line-2421"></span><span>
</span><span id="line-2422"></span><span class="hs-comment">-- | Perform scoping check on a type family equation.</span><span>
</span><span id="line-2423"></span><span class="hs-comment">--</span><span>
</span><span id="line-2424"></span><span class="hs-comment">-- See 'TyFamEqnValidityInfo'.</span><span>
</span><span id="line-2425"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkTyFamEqnValidityInfo"><span class="hs-identifier hs-type">checkTyFamEqnValidityInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#TyFamEqnValidityInfo"><span class="hs-identifier hs-type">TyFamEqnValidityInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2426"></span><span id="checkTyFamEqnValidityInfo"><span class="annot"><span class="annottext">checkTyFamEqnValidityInfo :: TyCon -&gt; TyFamEqnValidityInfo -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkTyFamEqnValidityInfo"><span class="hs-identifier hs-var hs-var">checkTyFamEqnValidityInfo</span></a></span></span><span> </span><span id="local-6989586621683049264"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049264"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-glyph">case</span><span>
</span><span id="line-2427"></span><span>  </span><span class="annot"><span class="annottext">TyFamEqnValidityInfo
</span><a href="GHC.Core.Class.html#NoVI"><span class="hs-identifier hs-var">NoVI</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2428"></span><span>  </span><span class="annot"><a href="GHC.Core.Class.html#VI"><span class="hs-identifier hs-type">VI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">vi_loc :: TyFamEqnValidityInfo -&gt; SrcSpan
</span><a href="GHC.Core.Class.html#vi_loc"><span class="hs-identifier hs-var">vi_loc</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049268"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683049268"><span class="hs-identifier hs-var">loc</span></a></span></span><span>
</span><span id="line-2429"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">vi_qtvs :: TyFamEqnValidityInfo -&gt; [Var]
</span><a href="GHC.Core.Class.html#vi_qtvs"><span class="hs-identifier hs-var">vi_qtvs</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049270"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049270"><span class="hs-identifier hs-var">qtvs</span></a></span></span><span>
</span><span id="line-2430"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">vi_non_user_tvs :: TyFamEqnValidityInfo -&gt; VarSet
</span><a href="GHC.Core.Class.html#vi_non_user_tvs"><span class="hs-identifier hs-var">vi_non_user_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049272"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049272"><span class="hs-identifier hs-var">non_user_tvs</span></a></span></span><span>
</span><span id="line-2431"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">vi_pats :: TyFamEqnValidityInfo -&gt; [Type]
</span><a href="GHC.Core.Class.html#vi_pats"><span class="hs-identifier hs-var">vi_pats</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049274"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049274"><span class="hs-identifier hs-var">pats</span></a></span></span><span>
</span><span id="line-2432"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">vi_rhs :: TyFamEqnValidityInfo -&gt; Type
</span><a href="GHC.Core.Class.html#vi_rhs"><span class="hs-identifier hs-var">vi_rhs</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049276"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049276"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2433"></span><span>    </span><span class="annot"><span class="annottext">SrcSpan -&gt; TcM () -&gt; TcM ()
forall a. SrcSpan -&gt; TcRn a -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621683049268"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcM ()) -&gt; TcM () -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2434"></span><span>    </span><span class="annot"><span class="annottext">TyCon -&gt; [Var] -&gt; VarSet -&gt; [Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkFamPatBinders"><span class="hs-identifier hs-var">checkFamPatBinders</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049264"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049270"><span class="hs-identifier hs-var">qtvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049272"><span class="hs-identifier hs-var">non_user_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049274"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049276"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2435"></span><span>
</span><span id="line-2436"></span><span class="hs-comment">-- | Check binders for a type or data family declaration.</span><span>
</span><span id="line-2437"></span><span class="hs-comment">--</span><span>
</span><span id="line-2438"></span><span class="hs-comment">-- Specifically, this function checks for:</span><span>
</span><span id="line-2439"></span><span class="hs-comment">--</span><span>
</span><span id="line-2440"></span><span class="hs-comment">--  - type variables used on the RHS but not bound (explicitly or implicitly)</span><span>
</span><span id="line-2441"></span><span class="hs-comment">--    in the LHS,</span><span>
</span><span id="line-2442"></span><span class="hs-comment">--  - variables bound by a forall in the LHS but not used in the RHS.</span><span>
</span><span id="line-2443"></span><span class="hs-comment">--</span><span>
</span><span id="line-2444"></span><span class="hs-comment">-- See Note [Check type family instance binders].</span><span>
</span><span id="line-2445"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkFamPatBinders"><span class="hs-identifier hs-type">checkFamPatBinders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>
</span><span id="line-2446"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span class="hs-special">]</span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Bound on LHS of family instance</span></span><span>
</span><span id="line-2447"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ non-user-written tyvars</span></span><span>
</span><span id="line-2448"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span>    </span><span class="annot"><span class="hs-comment">-- ^ LHS patterns</span></span><span>
</span><span id="line-2449"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ RHS</span></span><span>
</span><span id="line-2450"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2451"></span><span id="checkFamPatBinders"><span class="annot"><span class="annottext">checkFamPatBinders :: TyCon -&gt; [Var] -&gt; VarSet -&gt; [Type] -&gt; Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkFamPatBinders"><span class="hs-identifier hs-var hs-var">checkFamPatBinders</span></a></span></span><span> </span><span id="local-6989586621683049279"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049279"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683049280"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049280"><span class="hs-identifier hs-var">qtvs</span></a></span></span><span> </span><span id="local-6989586621683049281"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049281"><span class="hs-identifier hs-var">non_user_tvs</span></a></span></span><span> </span><span id="local-6989586621683049282"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049282"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621683049283"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049283"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2452"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkFamPatBinders&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcM ()) -&gt; SDoc -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2453"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
</span><a href="GHC.Core.TyCo.Ppr.html#debugPprType"><span class="hs-identifier hs-var">debugPprType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049279"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049282"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2454"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049279"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049282"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2455"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rhs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049283"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2456"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;qtvs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049280"><span class="hs-identifier hs-var">qtvs</span></a></span><span>
</span><span id="line-2457"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rhs_fvs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FV -&gt; VarSet
</span><a href="GHC.Utils.FV.html#fvVarSet"><span class="hs-identifier hs-var">fvVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">FV
</span><a href="#local-6989586621683049286"><span class="hs-identifier hs-var">rhs_fvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2458"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cpt_tvs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049287"><span class="hs-identifier hs-var">cpt_tvs</span></a></span><span>
</span><span id="line-2459"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inj_cpt_tvs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049288"><span class="hs-identifier hs-var">inj_cpt_tvs</span></a></span><span>
</span><span id="line-2460"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bad_rhs_tvs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049289"><span class="hs-identifier hs-var">bad_rhs_tvs</span></a></span><span>
</span><span id="line-2461"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bad_qtvs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(InvalidFamInstQTv -&gt; Var) -&gt; [InvalidFamInstQTv] -&gt; [Var]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">InvalidFamInstQTv -&gt; Var
</span><a href="GHC.Tc.Errors.Types.html#ifiqtv"><span class="hs-identifier hs-var">ifiqtv</span></a></span><span> </span><span class="annot"><span class="annottext">[InvalidFamInstQTv]
</span><a href="#local-6989586621683049291"><span class="hs-identifier hs-var">bad_qtvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2462"></span><span>
</span><span id="line-2463"></span><span>         </span><span class="hs-comment">-- Check for implicitly-bound tyvars, mentioned on the</span><span>
</span><span id="line-2464"></span><span>         </span><span class="hs-comment">-- RHS but not bound on the LHS</span><span>
</span><span id="line-2465"></span><span>         </span><span class="hs-comment">--    data T            = MkT (forall (a::k). blah)</span><span>
</span><span id="line-2466"></span><span>         </span><span class="hs-comment">--    data family D Int = MkD (forall (a::k). blah)</span><span>
</span><span id="line-2467"></span><span>         </span><span class="hs-comment">-- In both cases, 'k' is not bound on the LHS, but is used on the RHS</span><span>
</span><span id="line-2468"></span><span>         </span><span class="hs-comment">-- We catch the former in kcDeclHeader, and the latter right here</span><span>
</span><span id="line-2469"></span><span>         </span><span class="hs-comment">-- See Note [Check type family instance binders]</span><span>
</span><span id="line-2470"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(NonEmpty Name -&gt; IllegalFamilyInstanceReason) -&gt; [Name] -&gt; TcM ()
forall {a}.
NamedThing a =&gt;
(NonEmpty a -&gt; IllegalFamilyInstanceReason) -&gt; [a] -&gt; TcM ()
</span><a href="#local-6989586621683049292"><span class="hs-identifier hs-var">check_tvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (TyCon, [Type], VarSet)
-&gt; NonEmpty Name -&gt; IllegalFamilyInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#FamInstRHSOutOfScopeTyVars"><span class="hs-identifier hs-var">FamInstRHSOutOfScopeTyVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TyCon, [Type], VarSet) -&gt; Maybe (TyCon, [Type], VarSet)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049279"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049282"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049294"><span class="hs-identifier hs-var">dodgy_tvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2471"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Var -&gt; Name) -&gt; [Var] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Name
</span><a href="GHC.Types.Var.html#tyVarName"><span class="hs-identifier hs-var">tyVarName</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049289"><span class="hs-identifier hs-var">bad_rhs_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2472"></span><span>
</span><span id="line-2473"></span><span>         </span><span class="hs-comment">-- Check for explicitly forall'd variable that is not bound on LHS</span><span>
</span><span id="line-2474"></span><span>         </span><span class="hs-comment">--    data instance forall a.  T Int = MkT Int</span><span>
</span><span id="line-2475"></span><span>         </span><span class="hs-comment">-- See Note [Unused explicitly bound variables in a family pattern]</span><span>
</span><span id="line-2476"></span><span>         </span><span class="hs-comment">-- See Note [Check type family instance binders]</span><span>
</span><span id="line-2477"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(NonEmpty InvalidFamInstQTv -&gt; IllegalFamilyInstanceReason)
-&gt; [InvalidFamInstQTv] -&gt; TcM ()
forall {a}.
NamedThing a =&gt;
(NonEmpty a -&gt; IllegalFamilyInstanceReason) -&gt; [a] -&gt; TcM ()
</span><a href="#local-6989586621683049292"><span class="hs-identifier hs-var">check_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty InvalidFamInstQTv -&gt; IllegalFamilyInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#FamInstLHSUnusedBoundTyVars"><span class="hs-identifier hs-var">FamInstLHSUnusedBoundTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">[InvalidFamInstQTv]
</span><a href="#local-6989586621683049291"><span class="hs-identifier hs-var">bad_qtvs</span></a></span><span>
</span><span id="line-2478"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2479"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2480"></span><span>    </span><span id="local-6989586621683049286"><span class="annot"><span class="annottext">rhs_fvs :: FV
</span><a href="#local-6989586621683049286"><span class="hs-identifier hs-var hs-var">rhs_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; FV
</span><a href="GHC.Core.TyCo.FVs.html#tyCoFVsOfType"><span class="hs-identifier hs-var">tyCoFVsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049283"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2481"></span><span>
</span><span id="line-2482"></span><span>    </span><span id="local-6989586621683049287"><span class="annot"><span class="annottext">cpt_tvs :: VarSet
</span><a href="#local-6989586621683049287"><span class="hs-identifier hs-var hs-var">cpt_tvs</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049282"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2483"></span><span>    </span><span id="local-6989586621683049288"><span class="annot"><span class="annottext">inj_cpt_tvs :: VarSet
</span><a href="#local-6989586621683049288"><span class="hs-identifier hs-var hs-var">inj_cpt_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FV -&gt; VarSet
</span><a href="GHC.Utils.FV.html#fvVarSet"><span class="hs-identifier hs-var">fvVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(FV -&gt; VarSet) -&gt; FV -&gt; VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Type] -&gt; FV
</span><a href="GHC.Core.TyCo.FVs.html#injectiveVarsOfTypes"><span class="hs-identifier hs-var">injectiveVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049282"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2484"></span><span>      </span><span class="hs-comment">-- The type variables that are in injective positions.</span><span>
</span><span id="line-2485"></span><span>      </span><span class="hs-comment">-- See Note [Dodgy binding sites in type family instances]</span><span>
</span><span id="line-2486"></span><span>      </span><span class="hs-comment">-- NB: The False above is irrelevant, as we never have type families in</span><span>
</span><span id="line-2487"></span><span>      </span><span class="hs-comment">-- patterns.</span><span>
</span><span id="line-2488"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-2489"></span><span>      </span><span class="hs-comment">-- NB: It's OK to use the nondeterministic `fvVarSet` function here,</span><span>
</span><span id="line-2490"></span><span>      </span><span class="hs-comment">-- since the order of `inj_cpt_tvs` is never revealed in an error</span><span>
</span><span id="line-2491"></span><span>      </span><span class="hs-comment">-- message.</span><span>
</span><span id="line-2492"></span><span>
</span><span id="line-2493"></span><span>    </span><span class="hs-comment">-- Bound but not used at all</span><span>
</span><span id="line-2494"></span><span>    </span><span id="local-6989586621683049291"><span class="annot"><span class="annottext">bad_qtvs :: [InvalidFamInstQTv]
</span><a href="#local-6989586621683049291"><span class="hs-identifier hs-var hs-var">bad_qtvs</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Maybe InvalidFamInstQTv) -&gt; [Var] -&gt; [InvalidFamInstQTv]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Maybe InvalidFamInstQTv
</span><a href="#local-6989586621683049299"><span class="hs-identifier hs-var">bad_qtv_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049280"><span class="hs-identifier hs-var">qtvs</span></a></span><span>
</span><span id="line-2495"></span><span>
</span><span id="line-2496"></span><span>    </span><span id="local-6989586621683049299"><span class="annot"><span class="annottext">bad_qtv_maybe :: Var -&gt; Maybe InvalidFamInstQTv
</span><a href="#local-6989586621683049299"><span class="hs-identifier hs-var hs-var">bad_qtv_maybe</span></a></span></span><span> </span><span id="local-6989586621683049300"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049300"><span class="hs-identifier hs-var">qtv</span></a></span></span><span>
</span><span id="line-2497"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049301"><span class="hs-identifier hs-var">not_bound_in_pats</span></a></span><span>
</span><span id="line-2498"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621683049302"><span class="annot"><span class="annottext">reason :: InvalidFamInstQTvReason
</span><a href="#local-6989586621683049302"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span>
</span><span id="line-2499"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049303"><span class="hs-identifier hs-var">dodgy</span></a></span><span>
</span><span id="line-2500"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InvalidFamInstQTvReason
</span><a href="GHC.Tc.Errors.Types.html#InvalidFamInstQTvDodgy"><span class="hs-identifier hs-var">InvalidFamInstQTvDodgy</span></a></span><span>
</span><span id="line-2501"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049305"><span class="hs-identifier hs-var">used_in_rhs</span></a></span><span>
</span><span id="line-2502"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InvalidFamInstQTvReason
</span><a href="GHC.Tc.Errors.Types.html#InvalidFamInstQTvNotBoundInPats"><span class="hs-identifier hs-var">InvalidFamInstQTvNotBoundInPats</span></a></span><span>
</span><span id="line-2503"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2504"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InvalidFamInstQTvReason
</span><a href="GHC.Tc.Errors.Types.html#InvalidFamInstQTvNotUsedInRHS"><span class="hs-identifier hs-var">InvalidFamInstQTvNotUsedInRHS</span></a></span><span>
</span><span id="line-2505"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">InvalidFamInstQTv -&gt; Maybe InvalidFamInstQTv
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(InvalidFamInstQTv -&gt; Maybe InvalidFamInstQTv)
-&gt; InvalidFamInstQTv -&gt; Maybe InvalidFamInstQTv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html#InvalidFamInstQTv"><span class="hs-identifier hs-type">InvalidFamInstQTv</span></a></span><span>
</span><span id="line-2506"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ifiqtv :: Var
</span><a href="GHC.Tc.Errors.Types.html#ifiqtv"><span class="hs-identifier hs-var">ifiqtv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049300"><span class="hs-identifier hs-var">qtv</span></a></span><span>
</span><span id="line-2507"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ifiqtv_user_written :: Bool
</span><a href="GHC.Tc.Errors.Types.html#ifiqtv_user_written"><span class="hs-identifier hs-var">ifiqtv_user_written</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049300"><span class="hs-identifier hs-var">qtv</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049281"><span class="hs-identifier hs-var">non_user_tvs</span></a></span><span>
</span><span id="line-2508"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ifiqtv_reason :: InvalidFamInstQTvReason
</span><a href="GHC.Tc.Errors.Types.html#ifiqtv_reason"><span class="hs-identifier hs-var">ifiqtv_reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InvalidFamInstQTvReason
</span><a href="#local-6989586621683049302"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-2509"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-2510"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2511"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe InvalidFamInstQTv
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2512"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-2513"></span><span>          </span><span id="local-6989586621683049301"><span class="annot"><span class="annottext">not_bound_in_pats :: Bool
</span><a href="#local-6989586621683049301"><span class="hs-identifier hs-var hs-var">not_bound_in_pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049300"><span class="hs-identifier hs-var">qtv</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049288"><span class="hs-identifier hs-var">inj_cpt_tvs</span></a></span><span>
</span><span id="line-2514"></span><span>          </span><span id="local-6989586621683049303"><span class="annot"><span class="annottext">dodgy :: Bool
</span><a href="#local-6989586621683049303"><span class="hs-identifier hs-var hs-var">dodgy</span></a></span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049301"><span class="hs-identifier hs-var">not_bound_in_pats</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049300"><span class="hs-identifier hs-var">qtv</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049287"><span class="hs-identifier hs-var">cpt_tvs</span></a></span><span>
</span><span id="line-2515"></span><span>          </span><span id="local-6989586621683049305"><span class="annot"><span class="annottext">used_in_rhs :: Bool
</span><a href="#local-6989586621683049305"><span class="hs-identifier hs-var hs-var">used_in_rhs</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049300"><span class="hs-identifier hs-var">qtv</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">FV -&gt; VarSet
</span><a href="GHC.Utils.FV.html#fvVarSet"><span class="hs-identifier hs-var">fvVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">FV
</span><a href="#local-6989586621683049286"><span class="hs-identifier hs-var">rhs_fvs</span></a></span><span>
</span><span id="line-2516"></span><span>
</span><span id="line-2517"></span><span>    </span><span class="hs-comment">-- Used on RHS but not bound on LHS</span><span>
</span><span id="line-2518"></span><span>    </span><span id="local-6989586621683049289"><span class="annot"><span class="annottext">bad_rhs_tvs :: [Var]
</span><a href="#local-6989586621683049289"><span class="hs-identifier hs-var hs-var">bad_rhs_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Bool) -&gt; [Var] -&gt; [Var]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049288"><span class="hs-identifier hs-var">inj_cpt_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Bool) -&gt; (Var -&gt; Bool) -&gt; Var -&gt; Bool
forall (f :: * -&gt; *). Applicative f =&gt; f Bool -&gt; f Bool -&gt; f Bool
</span><a href="GHC.Utils.Misc.html#%3C%7C%7C%3E"><span class="hs-operator hs-var">&lt;||&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; [Var] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049280"><span class="hs-identifier hs-var">qtvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FV -&gt; [Var]
</span><a href="GHC.Utils.FV.html#fvVarList"><span class="hs-identifier hs-var">fvVarList</span></a></span><span> </span><span class="annot"><span class="annottext">FV
</span><a href="#local-6989586621683049286"><span class="hs-identifier hs-var">rhs_fvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2519"></span><span>
</span><span id="line-2520"></span><span>    </span><span id="local-6989586621683049294"><span class="annot"><span class="annottext">dodgy_tvs :: VarSet
</span><a href="#local-6989586621683049294"><span class="hs-identifier hs-var hs-var">dodgy_tvs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049287"><span class="hs-identifier hs-var">cpt_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#minusVarSet"><span class="hs-operator hs-var">`minusVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049288"><span class="hs-identifier hs-var">inj_cpt_tvs</span></a></span><span>
</span><span id="line-2521"></span><span>
</span><span id="line-2522"></span><span>    </span><span id="local-6989586621683049292"><span class="annot"><span class="annottext">check_tvs :: (NonEmpty a -&gt; IllegalFamilyInstanceReason) -&gt; [a] -&gt; TcM ()
</span><a href="#local-6989586621683049292"><span class="hs-identifier hs-var hs-var">check_tvs</span></a></span></span><span> </span><span id="local-6989586621683049321"><span class="annot"><span class="annottext">NonEmpty a -&gt; IllegalFamilyInstanceReason
</span><a href="#local-6989586621683049321"><span class="hs-identifier hs-var">mk_err</span></a></span></span><span> </span><span id="local-6989586621683049322"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621683049322"><span class="hs-identifier hs-var">tvs</span></a></span></span><span>
</span><span id="line-2523"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty a) -&gt; (NonEmpty a -&gt; TcM ()) -&gt; TcM ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; Maybe (NonEmpty a)
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="../../base-4.21.0.0-ae91/src/Data.List.NonEmpty.html#nonEmpty"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621683049322"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((NonEmpty a -&gt; TcM ()) -&gt; TcM ())
-&gt; (NonEmpty a -&gt; TcM ()) -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621683049325"><span class="annot"><span class="annottext">ne_tvs :: NonEmpty a
</span><a href="#local-6989586621683049325"><span class="hs-identifier hs-var">ne_tvs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621683049326"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683049326"><span class="hs-identifier hs-var">tv0</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2524"></span><span>        </span><span class="annot"><span class="annottext">SrcSpan -&gt; TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; SrcSpan
forall a. NamedThing a =&gt; a -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621683049326"><span class="hs-identifier hs-var">tv0</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2525"></span><span>        </span><span class="annot"><span class="annottext">IllegalInstanceReason -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalInstance"><span class="hs-identifier hs-var">TcRnIllegalInstance</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalInstanceReason -&gt; TcRnMessage)
-&gt; IllegalInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalFamilyInstance"><span class="hs-identifier hs-var">IllegalFamilyInstance</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalFamilyInstanceReason -&gt; IllegalInstanceReason)
-&gt; IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2526"></span><span>        </span><span class="annot"><span class="annottext">NonEmpty a -&gt; IllegalFamilyInstanceReason
</span><a href="#local-6989586621683049321"><span class="hs-identifier hs-var">mk_err</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty a
</span><a href="#local-6989586621683049325"><span class="hs-identifier hs-var">ne_tvs</span></a></span><span>
</span><span id="line-2527"></span><span>
</span><span id="line-2528"></span><span class="hs-comment">-- | Checks that a list of type patterns is valid in a matching (LHS)</span><span>
</span><span id="line-2529"></span><span class="hs-comment">-- position of a class instances or type/data family instance.</span><span>
</span><span id="line-2530"></span><span class="hs-comment">--</span><span>
</span><span id="line-2531"></span><span class="hs-comment">-- Specifically:</span><span>
</span><span id="line-2532"></span><span class="hs-comment">--    * All monotypes</span><span>
</span><span id="line-2533"></span><span class="hs-comment">--    * No type-family applications</span><span>
</span><span id="line-2534"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkValidTypePats"><span class="hs-identifier hs-type">checkValidTypePats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2535"></span><span id="checkValidTypePats"><span class="annot"><span class="annottext">checkValidTypePats :: TyCon -&gt; [Type] -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidTypePats"><span class="hs-identifier hs-var hs-var">checkValidTypePats</span></a></span></span><span> </span><span id="local-6989586621683049330"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049330"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621683049331"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049331"><span class="hs-identifier hs-var">pat_ty_args</span></a></span></span><span>
</span><span id="line-2536"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Check that each of pat_ty_args is a monotype.</span><span>
</span><span id="line-2537"></span><span>         </span><span class="hs-comment">-- One could imagine generalising to allow</span><span>
</span><span id="line-2538"></span><span>         </span><span class="hs-comment">--      instance C (forall a. a-&gt;a)</span><span>
</span><span id="line-2539"></span><span>         </span><span class="hs-comment">-- but we don't know what all the consequences might be.</span><span>
</span><span id="line-2540"></span><span>         </span><span class="annot"><span class="annottext">(Type -&gt; TcM ()) -&gt; [Type] -&gt; TcM ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkValidMonoType"><span class="hs-identifier hs-var">checkValidMonoType</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049331"><span class="hs-identifier hs-var">pat_ty_args</span></a></span><span>
</span><span id="line-2541"></span><span>
</span><span id="line-2542"></span><span>       </span><span class="hs-comment">-- Ensure that no type family applications occur a type pattern</span><span>
</span><span id="line-2543"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [(Bool, TyCon, [Type])]
</span><a href="GHC.Tc.Utils.TcType.html#tcTyConAppTyFamInstsAndVis"><span class="hs-identifier hs-var">tcTyConAppTyFamInstsAndVis</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049330"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049331"><span class="hs-identifier hs-var">pat_ty_args</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2544"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2545"></span><span>            </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621683049333"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049333"><span class="hs-identifier hs-var">tf_is_invis_arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049334"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049334"><span class="hs-identifier hs-var">tf_tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049335"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049335"><span class="hs-identifier hs-var">tf_args</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[(Bool, TyCon, [Type])]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2546"></span><span>              </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
forall a. TcRnMessage -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceReason -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalInstance"><span class="hs-identifier hs-var">TcRnIllegalInstance</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalInstanceReason -&gt; TcRnMessage)
-&gt; IllegalInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2547"></span><span>                </span><span class="annot"><span class="annottext">Type -&gt; Bool -&gt; TyCon -&gt; [Type] -&gt; IllegalInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalFamilyApplicationInInstance"><span class="hs-identifier hs-var">IllegalFamilyApplicationInInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049337"><span class="hs-identifier hs-var">inst_ty</span></a></span><span>
</span><span id="line-2548"></span><span>                  </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049333"><span class="hs-identifier hs-var">tf_is_invis_arg</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049334"><span class="hs-identifier hs-var">tf_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049335"><span class="hs-identifier hs-var">tf_args</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2549"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2550"></span><span>    </span><span id="local-6989586621683049337"><span class="annot"><span class="annottext">inst_ty :: Type
</span><a href="#local-6989586621683049337"><span class="hs-identifier hs-var hs-var">inst_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049330"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049331"><span class="hs-identifier hs-var">pat_ty_args</span></a></span><span>
</span><span id="line-2551"></span><span>
</span><span id="line-2552"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-2553"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkConsistentFamInst"><span class="hs-identifier hs-type">checkConsistentFamInst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#AssocInstInfo"><span class="hs-identifier hs-type">AssocInstInfo</span></a></span><span>
</span><span id="line-2554"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Family tycon</span></span><span>
</span><span id="line-2555"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span>
</span><span id="line-2556"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2557"></span><span class="hs-comment">-- See Note [Checking consistent instantiation]</span><span>
</span><span id="line-2558"></span><span>
</span><span id="line-2559"></span><span id="checkConsistentFamInst"><span class="annot"><span class="annottext">checkConsistentFamInst :: AssocInstInfo -&gt; TyCon -&gt; CoAxBranch -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkConsistentFamInst"><span class="hs-identifier hs-var hs-var">checkConsistentFamInst</span></a></span></span><span> </span><span class="annot"><span class="annottext">AssocInstInfo
</span><a href="GHC.Tc.Instance.Class.html#NotAssociated"><span class="hs-identifier hs-var">NotAssociated</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-2560"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2561"></span><span>
</span><span id="line-2562"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkConsistentFamInst"><span class="hs-identifier hs-var">checkConsistentFamInst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Instance.Class.html#InClsInst"><span class="hs-identifier hs-type">InClsInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ai_class :: AssocInstInfo -&gt; Class
</span><a href="GHC.Tc.Instance.Class.html#ai_class"><span class="hs-identifier hs-var">ai_class</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049341"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049341"><span class="hs-identifier hs-var">clas</span></a></span></span><span>
</span><span id="line-2563"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_tyvars :: AssocInstInfo -&gt; [Var]
</span><a href="GHC.Tc.Instance.Class.html#ai_tyvars"><span class="hs-identifier hs-var">ai_tyvars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049343"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049343"><span class="hs-identifier hs-var">inst_tvs</span></a></span></span><span>
</span><span id="line-2564"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ai_inst_env :: AssocInstInfo -&gt; VarEnv Type
</span><a href="GHC.Tc.Instance.Class.html#ai_inst_env"><span class="hs-identifier hs-var">ai_inst_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621683049345"><span class="annot"><span class="annottext">VarEnv Type
</span><a href="#local-6989586621683049345"><span class="hs-identifier hs-var">mini_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2565"></span><span>                       </span><span id="local-6989586621683049346"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049346"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621683049347"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049347"><span class="hs-identifier hs-var">branch</span></a></span></span><span>
</span><span id="line-2566"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkConsistentFamInst&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049343"><span class="hs-identifier hs-var">inst_tvs</span></a></span><span>
</span><span id="line-2567"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)]
</span><a href="#local-6989586621683049348"><span class="hs-identifier hs-var">arg_triples</span></a></span><span>
</span><span id="line-2568"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarEnv Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Type
</span><a href="#local-6989586621683049345"><span class="hs-identifier hs-var">mini_env</span></a></span><span>
</span><span id="line-2569"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049349"><span class="hs-identifier hs-var">ax_tvs</span></a></span><span>
</span><span id="line-2570"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049350"><span class="hs-identifier hs-var">ax_arg_tys</span></a></span><span>
</span><span id="line-2571"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)]
</span><a href="#local-6989586621683049348"><span class="hs-identifier hs-var">arg_triples</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2572"></span><span>       </span><span class="hs-comment">-- Check that the associated type indeed comes from this class</span><span>
</span><span id="line-2573"></span><span>       </span><span class="hs-comment">-- See [Mismatched class methods and associated type families]</span><span>
</span><span id="line-2574"></span><span>       </span><span class="hs-comment">-- in TcInstDecls.</span><span>
</span><span id="line-2575"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Maybe TyCon
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; TyCon
</span><a href="GHC.Core.Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049341"><span class="hs-identifier hs-var">clas</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe TyCon -&gt; Maybe TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe TyCon
</span><a href="GHC.Core.TyCon.html#tyConAssoc_maybe"><span class="hs-identifier hs-var">tyConAssoc_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049346"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2576"></span><span>          </span><span class="annot"><span class="annottext">IllegalInstanceReason -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalInstance"><span class="hs-identifier hs-var">TcRnIllegalInstance</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalInstanceReason -&gt; TcRnMessage)
-&gt; IllegalInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalFamilyInstance"><span class="hs-identifier hs-var">IllegalFamilyInstance</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalFamilyInstanceReason -&gt; IllegalInstanceReason)
-&gt; IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2577"></span><span>            </span><span class="annot"><span class="annottext">InvalidAssoc -&gt; IllegalFamilyInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#InvalidAssoc"><span class="hs-identifier hs-var">InvalidAssoc</span></a></span><span> </span><span class="annot"><span class="annottext">(InvalidAssoc -&gt; IllegalFamilyInstanceReason)
-&gt; InvalidAssoc -&gt; IllegalFamilyInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InvalidAssocInstance -&gt; InvalidAssoc
</span><a href="GHC.Tc.Errors.Types.html#InvalidAssocInstance"><span class="hs-identifier hs-var">InvalidAssocInstance</span></a></span><span> </span><span class="annot"><span class="annottext">(InvalidAssocInstance -&gt; InvalidAssoc)
-&gt; InvalidAssocInstance -&gt; InvalidAssoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2578"></span><span>            </span><span class="annot"><span class="annottext">Class -&gt; TyCon -&gt; InvalidAssocInstance
</span><a href="GHC.Tc.Errors.Types.html#AssocNotInThisClass"><span class="hs-identifier hs-var">AssocNotInThisClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621683049341"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049346"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2579"></span><span>
</span><span id="line-2580"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)] -&gt; TcM ()
</span><a href="#local-6989586621683049354"><span class="hs-identifier hs-var">check_match</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)]
</span><a href="#local-6989586621683049348"><span class="hs-identifier hs-var">arg_triples</span></a></span><span>
</span><span id="line-2581"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2582"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2583"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683049349"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049349"><span class="hs-identifier hs-var">ax_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049350"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049350"><span class="hs-identifier hs-var">ax_arg_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; ([Var], [Type], Type)
</span><a href="GHC.Core.Coercion.html#etaExpandCoAxBranch"><span class="hs-identifier hs-var">etaExpandCoAxBranch</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621683049347"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-2584"></span><span>
</span><span id="line-2585"></span><span>    </span><span class="annot"><a href="#local-6989586621683049348"><span class="hs-identifier hs-type">arg_triples</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">ForAllTyFlag</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2586"></span><span>    </span><span id="local-6989586621683049348"><span class="annot"><span class="annottext">arg_triples :: [(Type, Type, ForAllTyFlag)]
</span><a href="#local-6989586621683049348"><span class="hs-identifier hs-var hs-var">arg_triples</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049356"><span class="hs-identifier hs-var">cls_arg_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049357"><span class="hs-identifier hs-var">at_arg_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683049358"><span class="hs-identifier hs-var">vis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2587"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621683049359"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049359"><span class="hs-identifier hs-var">fam_tc_tv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049358"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683049358"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049357"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049357"><span class="hs-identifier hs-var">at_arg_ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2588"></span><span>                       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; [ForAllTyFlag] -&gt; [Type] -&gt; [(Var, ForAllTyFlag, Type)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Var]
</span><a href="GHC.Core.TyCon.html#tyConTyVars"><span class="hs-identifier hs-var">tyConTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049346"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2589"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; [ForAllTyFlag]
</span><a href="GHC.Core.Type.html#tyConForAllTyFlags"><span class="hs-identifier hs-var">tyConForAllTyFlags</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049346"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049350"><span class="hs-identifier hs-var">ax_arg_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2590"></span><span>                               </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049350"><span class="hs-identifier hs-var">ax_arg_tys</span></a></span><span>
</span><span id="line-2591"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683049356"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049356"><span class="hs-identifier hs-var">cls_arg_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VarEnv Type -&gt; Var -&gt; Maybe Type
forall a. VarEnv a -&gt; Var -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Type
</span><a href="#local-6989586621683049345"><span class="hs-identifier hs-var">mini_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049359"><span class="hs-identifier hs-var">fam_tc_tv</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2592"></span><span>
</span><span id="line-2593"></span><span>    </span><span class="hs-comment">-- Fiddling around to arrange that wildcards unconditionally print as &quot;_&quot;</span><span>
</span><span id="line-2594"></span><span>    </span><span class="hs-comment">-- We only need to print the LHS, not the RHS at all</span><span>
</span><span id="line-2595"></span><span>    </span><span class="hs-comment">-- See Note [Printing conflicts with class header]</span><span>
</span><span id="line-2596"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683049363"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683049363"><span class="hs-identifier hs-var">tidy_env1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; [Var] -&gt; (TidyEnv, [Var])
</span><a href="GHC.Core.TyCo.Tidy.html#tidyVarBndrs"><span class="hs-identifier hs-var">tidyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="GHC.Types.Var.Env.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049343"><span class="hs-identifier hs-var">inst_tvs</span></a></span><span>
</span><span id="line-2597"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621683049365"><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683049365"><span class="hs-identifier hs-var">tidy_env2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; [Var] -&gt; (TidyEnv, [Var])
</span><a href="GHC.Core.Coercion.html#tidyCoAxBndrsForUser"><span class="hs-identifier hs-var">tidyCoAxBndrsForUser</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683049363"><span class="hs-identifier hs-var">tidy_env1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049349"><span class="hs-identifier hs-var">ax_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; [Var] -&gt; [Var]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">\\</span></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049343"><span class="hs-identifier hs-var">inst_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2598"></span><span>
</span><span id="line-2599"></span><span>    </span><span id="local-6989586621683049367"><span class="annot"><span class="annottext">mk_wildcard :: Var -&gt; Type
</span><a href="#local-6989586621683049367"><span class="hs-identifier hs-var hs-var">mk_wildcard</span></a></span></span><span> </span><span id="local-6989586621683049368"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049368"><span class="hs-identifier hs-var">at_tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Var
</span><a href="GHC.Types.Var.html#mkTyVar"><span class="hs-identifier hs-var">mkTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621683049370"><span class="hs-identifier hs-var">tv_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Type
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049368"><span class="hs-identifier hs-var">at_tv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2600"></span><span>    </span><span id="local-6989586621683049370"><span class="annot"><span class="annottext">tv_name :: Name
</span><a href="#local-6989586621683049370"><span class="hs-identifier hs-var hs-var">tv_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; OccName -&gt; SrcSpan -&gt; Name
</span><a href="GHC.Types.Name.html#mkInternalName"><span class="hs-identifier hs-var">mkInternalName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Unique
</span><a href="GHC.Builtin.Uniques.html#mkAlphaTyVarUnique"><span class="hs-identifier hs-var">mkAlphaTyVarUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkTyVarOccFS"><span class="hs-identifier hs-var">mkTyVarOccFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="GHC.Types.SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a></span><span>
</span><span id="line-2601"></span><span>
</span><span id="line-2602"></span><span>    </span><span class="hs-comment">-- For check_match, bind_me, see</span><span>
</span><span id="line-2603"></span><span>    </span><span class="hs-comment">-- Note [Matching in the consistent-instantiation check]</span><span>
</span><span id="line-2604"></span><span>    </span><span class="annot"><a href="#local-6989586621683049354"><span class="hs-identifier hs-type">check_match</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="Language.Haskell.Syntax.Specificity.html#ForAllTyFlag"><span class="hs-identifier hs-type">ForAllTyFlag</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2605"></span><span>    </span><span id="local-6989586621683049354"><span class="annot"><span class="annottext">check_match :: [(Type, Type, ForAllTyFlag)] -&gt; TcM ()
</span><a href="#local-6989586621683049354"><span class="hs-identifier hs-var hs-var">check_match</span></a></span></span><span> </span><span id="local-6989586621683049376"><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)]
</span><a href="#local-6989586621683049376"><span class="hs-identifier hs-var">triples</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Subst -&gt; [(Type, Type, ForAllTyFlag)] -&gt; TcM ()
</span><a href="#local-6989586621683049377"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="GHC.Core.TyCo.Subst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="GHC.Core.TyCo.Subst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)]
</span><a href="#local-6989586621683049376"><span class="hs-identifier hs-var">triples</span></a></span><span>
</span><span id="line-2606"></span><span>
</span><span id="line-2607"></span><span>    </span><span id="local-6989586621683049377"><span class="annot"><span class="annottext">go :: Subst -&gt; Subst -&gt; [(Type, Type, ForAllTyFlag)] -&gt; TcM ()
</span><a href="#local-6989586621683049377"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Subst
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Subst
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2608"></span><span>    </span><span class="annot"><a href="#local-6989586621683049377"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621683049379"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683049379"><span class="hs-identifier hs-var">lr_subst</span></a></span></span><span> </span><span id="local-6989586621683049380"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683049380"><span class="hs-identifier hs-var">rl_subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621683049381"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049381"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683049382"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049382"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621683049383"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683049383"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621683049384"><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)]
</span><a href="#local-6989586621683049384"><span class="hs-identifier hs-var">triples</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2609"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683049385"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683049385"><span class="hs-identifier hs-var">lr_subst1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Subst -&gt; Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTyX_BM"><span class="hs-identifier hs-var">tcMatchTyX_BM</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621683049386"><span class="hs-identifier hs-var">bind_me</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683049379"><span class="hs-identifier hs-var">lr_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049381"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049382"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2610"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683049387"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683049387"><span class="hs-identifier hs-var">rl_subst1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Subst -&gt; Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTyX_BM"><span class="hs-identifier hs-var">tcMatchTyX_BM</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621683049386"><span class="hs-identifier hs-var">bind_me</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683049380"><span class="hs-identifier hs-var">rl_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049382"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049381"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-2611"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Subst -&gt; [(Type, Type, ForAllTyFlag)] -&gt; TcM ()
</span><a href="#local-6989586621683049377"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683049385"><span class="hs-identifier hs-var">lr_subst1</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621683049387"><span class="hs-identifier hs-var">rl_subst1</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, Type, ForAllTyFlag)]
</span><a href="#local-6989586621683049384"><span class="hs-identifier hs-var">triples</span></a></span><span>
</span><span id="line-2612"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2613"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalInstanceReason -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnIllegalInstance"><span class="hs-identifier hs-var">TcRnIllegalInstance</span></a></span><span> </span><span class="annot"><span class="annottext">(IllegalInstanceReason -&gt; TcRnMessage)
-&gt; IllegalInstanceReason -&gt; TcRnMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#IllegalFamilyInstance"><span class="hs-identifier hs-var">IllegalFamilyInstance</span></a></span><span>
</span><span id="line-2614"></span><span>                 </span><span class="annot"><span class="annottext">(IllegalFamilyInstanceReason -&gt; IllegalInstanceReason)
-&gt; IllegalFamilyInstanceReason -&gt; IllegalInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InvalidAssoc -&gt; IllegalFamilyInstanceReason
</span><a href="GHC.Tc.Errors.Types.html#InvalidAssoc"><span class="hs-identifier hs-var">InvalidAssoc</span></a></span><span> </span><span class="annot"><span class="annottext">(InvalidAssoc -&gt; IllegalFamilyInstanceReason)
-&gt; InvalidAssoc -&gt; IllegalFamilyInstanceReason
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InvalidAssocInstance -&gt; InvalidAssoc
</span><a href="GHC.Tc.Errors.Types.html#InvalidAssocInstance"><span class="hs-identifier hs-var">InvalidAssocInstance</span></a></span><span>
</span><span id="line-2615"></span><span>                 </span><span class="annot"><span class="annottext">(InvalidAssocInstance -&gt; InvalidAssoc)
-&gt; InvalidAssocInstance -&gt; InvalidAssoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag -&gt; TyCon -&gt; [Type] -&gt; [Type] -&gt; InvalidAssocInstance
</span><a href="GHC.Tc.Errors.Types.html#AssocTyVarsDontMatch"><span class="hs-identifier hs-var">AssocTyVarsDontMatch</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621683049383"><span class="hs-identifier hs-var">vis</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049346"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049389"><span class="hs-identifier hs-var">exp_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049390"><span class="hs-identifier hs-var">act_tys</span></a></span><span>
</span><span id="line-2616"></span><span>
</span><span id="line-2617"></span><span>    </span><span class="hs-comment">-- Expected/actual family argument types (for error messages)</span><span>
</span><span id="line-2618"></span><span>    </span><span id="local-6989586621683049389"><span class="annot"><span class="annottext">exp_tys :: [Type]
</span><a href="#local-6989586621683049389"><span class="hs-identifier hs-var hs-var">exp_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2619"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarEnv Type -&gt; Var -&gt; Maybe Type
forall a. VarEnv a -&gt; Var -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Type
</span><a href="#local-6989586621683049345"><span class="hs-identifier hs-var">mini_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049391"><span class="hs-identifier hs-var">at_tv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2620"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621683049392"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049392"><span class="hs-identifier hs-var">cls_arg_ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Tidy.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683049365"><span class="hs-identifier hs-var">tidy_env2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049392"><span class="hs-identifier hs-var">cls_arg_ty</span></a></span><span>
</span><span id="line-2621"></span><span>          </span><span class="annot"><span class="annottext">Maybe Type
</span><span class="hs-identifier hs-var">Nothing</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Type
</span><a href="#local-6989586621683049367"><span class="hs-identifier hs-var">mk_wildcard</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049391"><span class="hs-identifier hs-var">at_tv</span></a></span><span>
</span><span id="line-2622"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621683049391"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049391"><span class="hs-identifier hs-var">at_tv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Var]
</span><a href="GHC.Core.TyCon.html#tyConTyVars"><span class="hs-identifier hs-var">tyConTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049346"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2623"></span><span>    </span><span id="local-6989586621683049390"><span class="annot"><span class="annottext">act_tys :: [Type]
</span><a href="#local-6989586621683049390"><span class="hs-identifier hs-var hs-var">act_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TidyEnv -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Tidy.html#tidyTypes"><span class="hs-identifier hs-var">tidyTypes</span></a></span><span> </span><span class="annot"><span class="annottext">TidyEnv
</span><a href="#local-6989586621683049365"><span class="hs-identifier hs-var">tidy_env2</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621683049350"><span class="hs-identifier hs-var">ax_arg_tys</span></a></span><span>
</span><span id="line-2624"></span><span>
</span><span id="line-2625"></span><span>    </span><span class="hs-comment">-- The /scoped/ type variables from the class-instance header</span><span>
</span><span id="line-2626"></span><span>    </span><span class="hs-comment">-- should not be alpha-renamed.  Inferred ones can be.</span><span>
</span><span id="line-2627"></span><span>    </span><span id="local-6989586621683049393"><span class="annot"><span class="annottext">no_bind_set :: VarSet
</span><a href="#local-6989586621683049393"><span class="hs-identifier hs-var hs-var">no_bind_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621683049343"><span class="hs-identifier hs-var">inst_tvs</span></a></span><span>
</span><span id="line-2628"></span><span>    </span><span id="local-6989586621683049386"><span class="annot"><span class="annottext">bind_me :: BindFun
</span><a href="#local-6989586621683049386"><span class="hs-identifier hs-var hs-var">bind_me</span></a></span></span><span> </span><span id="local-6989586621683049395"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049395"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621683049396"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621683049396"><span class="hs-identifier hs-var">_ty</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049395"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049393"><span class="hs-identifier hs-var">no_bind_set</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#Apart"><span class="hs-identifier hs-var">Apart</span></a></span><span>
</span><span id="line-2629"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a></span><span>
</span><span id="line-2630"></span><span>
</span><span id="line-2631"></span><span>
</span><span id="line-2632"></span><span class="hs-comment">{- Note [Check type family instance binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a type family instance, we require (of course), type variables
used on the RHS are matched on the LHS. This is checked by
checkFamPatBinders.  Here is an interesting example:

    type family   T :: k
    type instance T = (Nothing :: Maybe a)

Upon a cursory glance, it may appear that the kind variable `a` is unbound
since there are no (visible) LHS patterns in `T`. However, there is an
*invisible* pattern due to the return kind, so inside of GHC, the instance
looks closer to this:

    type family T @k :: k
    type instance T @(Maybe a) = (Nothing :: Maybe a)

Here, we can see that `a` really is bound by a LHS type pattern, so `a` is in
fact not unbound. Contrast that with this example (#13985)

    type instance T = Proxy (Nothing :: Maybe a)

This would looks like this inside of GHC:

    type instance T @(*) = Proxy (Nothing :: Maybe a)

So this time, `a` is neither bound by a visible nor invisible type pattern on
the LHS, so `a` would be reported as not in scope.

Finally, here's one more brain-teaser (from #9574). In the example below:

    class Funct f where
      type Codomain f :: *
    instance Funct ('KProxy :: KProxy o) where
      type Codomain 'KProxy = NatTr (Proxy :: o -&gt; *)

As it turns out, `o` is in scope in this example. That is because `o` is
bound by the kind signature of the LHS type pattern 'KProxy. To make this more
obvious, one can also write the instance like so:

    instance Funct ('KProxy :: KProxy o) where
      type Codomain ('KProxy :: KProxy o) = NatTr (Proxy :: o -&gt; *)

Note [Dodgy binding sites in type family instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following example (from #7536):

  type T a = Int
  type instance F (T a) = a

This `F` instance is extremely fishy, since the RHS, `a`, purports to be
&quot;bound&quot; by the LHS pattern `T a`. &quot;Bound&quot; has scare quotes around it because
`T a` expands to `Int`, which doesn't mention at all, so it's as if one had
actually written:

  type instance F Int = a

That is clearly bogus, so to reject this, we check that every type variable
that is mentioned on the RHS is /actually/ bound on the LHS. In other words,
we need to do something slightly more sophisticated that just compute the free
variables of the LHS patterns.

It's tempting to just expand all type synonyms on the LHS and then compute
their free variables, but even that isn't sophisticated enough. After all,
an impish user could write the following (#17008):

  type family ConstType (a :: Type) :: Type where
    ConstType _ = Type

  type family F (x :: ConstType a) :: Type where
    F (x :: ConstType a) = a

Just like in the previous example, the `a` on the RHS isn't actually bound
on the LHS, but this time a type family is responsible for the deception, not
a type synonym.

We avoid both issues by requiring that all RHS type variables are mentioned
in injective positions on the left-hand side (by way of
`injectiveVarsOfTypes`). For instance, the `a` in `T a` is not in an injective
position, as `T` is not an injective type constructor, so we do not count that.
Similarly for the `a` in `ConstType a`.

Note [Matching in the consistent-instantiation check]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Matching the class-instance header to family-instance tyvars is
tricker than it sounds.  Consider (#13972)
    class C (a :: k) where
      type T k :: Type
    instance C Left where
      type T (a -&gt; Either a b) = Int

Here there are no lexically-scoped variables from (C Left).
Yet the real class-instance header is   C @(p -&gt; Either @p @q)) (Left @p @q)
while the type-family instance is       T (a -&gt; Either @a @b)
So we allow alpha-renaming of variables that don't come
from the class-instance header.

We track the lexically-scoped type variables from the
class-instance header in ai_tyvars.

Here's another example (#14045a)
    class C (a :: k) where
      data S (a :: k)
    instance C (z :: Bool) where
      data S :: Bool -&gt; Type where

Again, there is no lexical connection, but we will get
   class-instance header:   C @Bool (z::Bool)
   family instance          S @Bool (a::Bool)

When looking for mis-matches, we check left-to-right,
kinds first.  If we look at types first, we'll fail to
suggest -fprint-explicit-kinds for a mis-match with
      T @k    vs    T @Type
somewhere deep inside the type

Note [Checking consistent instantiation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See #11450 for background discussion on this check.

  class C a b where
    type T a x b

With this class decl, if we have an instance decl
  instance C ty1 ty2 where ...
then the type instance must look like
     type T ty1 v ty2 = ...
with exactly 'ty1' for 'a', 'ty2' for 'b', and some type 'v' for 'x'.
For example:

  instance C [p] Int
    type T [p] y Int = (p,y,y)

Note that

* We used to allow completely different bound variables in the
  associated type instance; e.g.
    instance C [p] Int
      type T [q] y Int = ...
  But from GHC 8.2 onwards, we don't.  It's much simpler this way.
  See #11450.

* When the class variable isn't used on the RHS of the type instance,
  it's tempting to allow wildcards, thus
    instance C [p] Int
      type T [_] y Int = (y,y)
  But it's awkward to do the test, and it doesn't work if the
  variable is repeated:
    instance C (p,p) Int
      type T (_,_) y Int = (y,y)
  Even though 'p' is not used on the RHS, we still need to use 'p'
  on the LHS to establish the repeated pattern.  So to keep it simple
  we just require equality.

* For variables in associated type families that are not bound by the class
  itself, we do _not_ check if they are over-specific. In other words,
  it's perfectly acceptable to have an instance like this:

    instance C [p] Int where
      type T [p] (Maybe x) Int = x

  While the first and third arguments to T are required to be exactly [p] and
  Int, respectively, since they are bound by C, the second argument is allowed
  to be more specific than just a type variable. Furthermore, it is permissible
  to define multiple equations for T that differ only in the non-class-bound
  argument:

    instance C [p] Int where
      type T [p] (Maybe x)    Int = x
      type T [p] (Either x y) Int = x -&gt; y

  We once considered requiring that non-class-bound variables in associated
  type family instances be instantiated with distinct type variables. However,
  that requirement proved too restrictive in practice, as there were examples
  of extremely simple associated type family instances that this check would
  reject, and fixing them required tiresome boilerplate in the form of
  auxiliary type families. For instance, you would have to define the above
  example as:

    instance C [p] Int where
      type T [p] x Int = CAux x

    type family CAux x where
      CAux (Maybe x)    = x
      CAux (Either x y) = x -&gt; y

  We decided that this restriction wasn't buying us much, so we opted not
  to pursue that design (see also GHC #13398).

Implementation
  * Form the mini-envt from the class type variables a,b
    to the instance decl types [p],Int:   [a-&gt;[p], b-&gt;Int]

  * Look at the tyvars a,x,b of the type family constructor T
    (it shares tyvars with the class C)

  * Apply the mini-evnt to them, and check that the result is
    consistent with the instance types [p] y Int. (where y can be any type, as
    it is not scoped over the class type variables.

We make all the instance type variables scope over the
type instances, of course, which picks up non-obvious kinds.  Eg
   class Foo (a :: k) where
      type F a
   instance Foo (b :: k -&gt; k) where
      type F b = Int
Here the instance is kind-indexed and really looks like
      type F (k-&gt;k) (b::k-&gt;k) = Int
But if the 'b' didn't scope, we would make F's instance too
poly-kinded.

Note [Printing conflicts with class header]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's remarkably painful to give a decent error message for conflicts
with the class header.  Consider
   class C b where
     type F a b c
   instance C [b] where
     type F x Int _ _ = ...

Here we want to report a conflict between
    Expected: F _ [b] _
    Actual:   F x Int _ _

But if the type instance shadows the class variable like this
(rename/should_fail/T15828):
   instance C [b] where
     type forall b. F x (Tree b) _ _ = ...

then we must use a fresh variable name
    Expected: F _ [b] _
    Actual:   F x [b1] _ _

Notice that:
  - We want to print an underscore in the &quot;Expected&quot; type in
    positions where the class header has no influence over the
    parameter.  Hence the fancy footwork in pp_expected_ty

  - Although the binders in the axiom are already tidy, we must
    re-tidy them to get a fresh variable name when we shadow

  - The (ax_tvs \\ inst_tvs) is to avoid tidying one of the
    class-instance variables a second time, from 'a' to 'a1' say.
    Remember, the ax_tvs of the axiom share identity with the
    class-instance variables, inst_tvs..

  - We use tidyCoAxBndrsForUser to get underscores rather than
    _1, _2, etc in the axiom tyvars; see the definition of
    tidyCoAxBndrsForUser

This all seems absurdly complicated.

Note [Unused explicitly bound variables in a family pattern]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Why is 'unusedExplicitForAllErr' not just a warning?

Consider the following examples:

  type instance F a = Maybe b
  type instance forall b. F a = Bool
  type instance forall b. F a = Maybe b

In every case, b is a type variable not determined by the LHS pattern. The
first is caught by the renamer, but we catch the last two here. Perhaps one
could argue that the second should be accepted, albeit with a warning, but
consider the fact that in a type family instance, there is no way to interact
with such a variable. At least with @x :: forall a. Int@ we can use visible
type application, like @x \@Bool 1@. (Of course it does nothing, but it is
permissible.) In the type family case, the only sensible explanation is that
the user has made a mistake -- thus we throw an error.

Note [Oversaturated type family equations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Type family tycons have very rigid arities. We want to reject something like
this:

  type family Foo :: Type -&gt; Type where
    Foo x = ...

Because Foo has arity zero (i.e., it doesn't bind anything to the left of the
double colon), we want to disallow any equation for Foo that has more than zero
arguments, such as `Foo x = ...`. The algorithm here is pretty simple: if an
equation has more arguments than the arity of the type family, reject.

Things get trickier when visible kind application enters the picture. Consider
the following example:

  type family Bar (x :: j) :: forall k. Either j k where
    Bar 5 @Symbol = ...

The arity of Bar is two, since it binds two variables, `j` and `x`. But even
though Bar's equation has two arguments, it's still invalid. Imagine the same
equation in Core:

    Bar Nat 5 Symbol = ...

Here, it becomes apparent that Bar is actually taking /three/ arguments! So
we can't just rely on a simple counting argument to reject
`Bar 5 @Symbol = ...`, since it only has two user-written arguments.
Moreover, there's one explicit argument (5) and one visible kind argument
(@Symbol), which matches up perfectly with the fact that Bar has one required
binder (x) and one specified binder (j), so that's not a valid way to detect
oversaturation either.

To solve this problem in a robust way, we do the following:

1. When kind-checking, we count the number of user-written *required*
   arguments and check if there is an equal number of required tycon binders.
   If not, reject. (See `wrongNumberOfParmsErr` in GHC.Tc.TyCl.)

   We perform this step during kind-checking, not during validity checking,
   since we can give better error messages if we catch it early.
2. When validity checking, take all of the (Core) type patterns from on
   equation, drop the first n of them (where n is the arity of the type family
   tycon), and check if there are any types leftover. If so, reject.

   Why does this work? We know that after dropping the first n type patterns,
   none of the leftover types can be required arguments, since step (1) would
   have already caught that. Moreover, the only places where visible kind
   applications should be allowed are in the first n types, since those are the
   only arguments that can correspond to binding forms. Therefore, the
   remaining arguments must correspond to oversaturated uses of visible kind
   applications, which are precisely what we want to reject.

Note that we only perform this check for type families, and not for data
families. This is because it is perfectly acceptable to oversaturate data
family instance equations: see Note [Arity of data families] in GHC.Core.FamInstEnv.

************************************************************************
*                                                                      *
   Telescope checking
*                                                                      *
************************************************************************

Note [Bad TyCon telescopes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Now that we can mix type and kind variables, there are an awful lot of
ways to shoot yourself in the foot. Here are some.

  data SameKind :: k -&gt; k -&gt; *   -- just to force unification

1.  data T1 a k (b :: k) (x :: SameKind a b)

The problem here is that we discover that a and b should have the same
kind. But this kind mentions k, which is bound *after* a.
(Testcase: dependent/should_fail/BadTelescope)

2.  data T2 a (c :: Proxy b) (d :: Proxy a) (x :: SameKind b d)

Note that b is not bound. Yet its kind mentions a. Because we have
a nice rule that all implicitly bound variables come before others,
this is bogus.

To catch these errors, we call checkTyConTelescope during kind-checking
datatype declarations.  This checks for

* Ill-scoped binders. From (1) and (2) above we can get putative
  kinds like
       T1 :: forall (a:k) (k:*) (b:k). SameKind a b -&gt; *
  where 'k' is mentioned a's kind before k is bound

  This is easy to check for: just look for
  out-of-scope variables in the kind

* We should arguably also check for ambiguous binders
  but we don't.  See Note [Ambiguous kind vars].

See also
  * Note [Required, Specified, and Inferred for types] in GHC.Tc.TyCl.
  * Note [Checking telescopes] in GHC.Tc.Types.Constraint discusses how
    this check works for `forall x y z.` written in a type.

Note [Ambiguous kind vars]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to be concerned about ambiguous binders. Suppose we have the kind
     S1 :: forall k -&gt; * -&gt; *
     S2 :: forall k. * -&gt; *
Here S1 is OK, because k is Required, and at a use of S1 we will
see (S1 *) or (S1 (*-&gt;*)) or whatever.

But S2 is /not/ OK because 'k' is Specfied (and hence invisible) and
we have no way (ever) to figure out how 'k' should be instantiated.
For example if we see (S2 Int), that tells us nothing about k's
instantiation.  (In this case we'll instantiate it to Any, but that
seems wrong.)  This is really the same test as we make for ambiguous
type in term type signatures.

Now, it's impossible for a Specified variable not to occur
at all in the kind -- after all, it is Specified so it must have
occurred.  (It /used/ to be possible; see tests T13983 and T7873.  But
with the advent of the forall-or-nothing rule for kind variables,
those strange cases went away. See Note [forall-or-nothing rule] in
GHC.Hs.Type.)

But one might worry about
    type v k = *
    S3 :: forall k. V k -&gt; *
which appears to mention 'k' but doesn't really.  Or
    S4 :: forall k. F k -&gt; *
where F is a type function.  But we simply don't check for
those cases of ambiguity, yet anyway.  The worst that can happen
is ambiguity at the call sites.

Historical note: this test used to be called reportFloatingKvs.
-}</span><span>
</span><span id="line-3038"></span><span>
</span><span id="line-3039"></span><span class="hs-comment">-- | Check a list of binders to see if they make a valid telescope.</span><span>
</span><span id="line-3040"></span><span class="hs-comment">-- See Note [Bad TyCon telescopes]</span><span>
</span><span id="line-3041"></span><span class="hs-keyword">type</span><span> </span><span id="TelescopeAcc"><span class="annot"><a href="GHC.Tc.Validity.html#TelescopeAcc"><span class="hs-identifier hs-var">TelescopeAcc</span></a></span></span><span>
</span><span id="line-3042"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a></span><span>   </span><span class="hs-comment">-- Bound earlier in the telescope</span><span>
</span><span id="line-3043"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>       </span><span class="hs-comment">-- At least one binder occurred (in a kind) before</span><span>
</span><span id="line-3044"></span><span>                     </span><span class="hs-comment">-- it was bound in the telescope.  E.g.</span><span>
</span><span id="line-3045"></span><span>        </span><span class="hs-special">)</span><span>            </span><span class="hs-comment">--    T :: forall (a::k) k. blah</span><span>
</span><span id="line-3046"></span><span>
</span><span id="line-3047"></span><span class="annot"><a href="GHC.Tc.Validity.html#checkTyConTelescope"><span class="hs-identifier hs-type">checkTyConTelescope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-3048"></span><span id="checkTyConTelescope"><span class="annot"><span class="annottext">checkTyConTelescope :: TyCon -&gt; TcM ()
</span><a href="GHC.Tc.Validity.html#checkTyConTelescope"><span class="hs-identifier hs-var hs-var">checkTyConTelescope</span></a></span></span><span> </span><span id="local-6989586621683049400"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049400"><span class="hs-identifier hs-var">tc</span></a></span></span><span>
</span><span id="line-3049"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049401"><span class="hs-identifier hs-var">bad_scope</span></a></span><span>
</span><span id="line-3050"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See &quot;Ill-scoped binders&quot; in Note [Bad TyCon telescopes]</span><span>
</span><span id="line-3051"></span><span>    </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcM ()
</span><a href="GHC.Tc.Utils.Monad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcM ()) -&gt; TcRnMessage -&gt; TcM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnBadTyConTelescope"><span class="hs-identifier hs-var">TcRnBadTyConTelescope</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049400"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-3052"></span><span>
</span><span id="line-3053"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-3054"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcM ()
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-3055"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3056"></span><span>    </span><span id="local-6989586621683049403"><span class="annot"><span class="annottext">tcbs :: [VarBndr Var TyConBndrVis]
</span><a href="#local-6989586621683049403"><span class="hs-identifier hs-var hs-var">tcbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [VarBndr Var TyConBndrVis]
</span><a href="GHC.Core.TyCon.html#tyConBinders"><span class="hs-identifier hs-var">tyConBinders</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621683049400"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-3057"></span><span>
</span><span id="line-3058"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049401"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049401"><span class="hs-identifier hs-var">bad_scope</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VarSet, Bool) -&gt; VarBndr Var TyConBndrVis -&gt; (VarSet, Bool))
-&gt; (VarSet, Bool) -&gt; [VarBndr Var TyConBndrVis] -&gt; (VarSet, Bool)
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">(VarSet, Bool) -&gt; VarBndr Var TyConBndrVis -&gt; (VarSet, Bool)
</span><a href="#local-6989586621683049405"><span class="hs-identifier hs-var">add_one</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VarBndr Var TyConBndrVis]
</span><a href="#local-6989586621683049403"><span class="hs-identifier hs-var">tcbs</span></a></span><span>
</span><span id="line-3059"></span><span>
</span><span id="line-3060"></span><span>    </span><span class="annot"><a href="#local-6989586621683049405"><span class="hs-identifier hs-type">add_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#TelescopeAcc"><span class="hs-identifier hs-type">TelescopeAcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html#TelescopeAcc"><span class="hs-identifier hs-type">TelescopeAcc</span></a></span><span>
</span><span id="line-3061"></span><span>    </span><span id="local-6989586621683049405"><span class="annot"><span class="annottext">add_one :: (VarSet, Bool) -&gt; VarBndr Var TyConBndrVis -&gt; (VarSet, Bool)
</span><a href="#local-6989586621683049405"><span class="hs-identifier hs-var hs-var">add_one</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621683049407"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049407"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621683049408"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049408"><span class="hs-identifier hs-var">bad_scope</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621683049409"><span class="annot"><span class="annottext">VarBndr Var TyConBndrVis
</span><a href="#local-6989586621683049409"><span class="hs-identifier hs-var">tcb</span></a></span></span><span>
</span><span id="line-3062"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049407"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; Var -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSet"><span class="hs-operator hs-var">`extendVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049411"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-3063"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621683049408"><span class="hs-identifier hs-var">bad_scope</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049413"><span class="hs-identifier hs-var">fkvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#minusVarSet"><span class="hs-operator hs-var">`minusVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621683049407"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-3064"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3065"></span><span>        </span><span id="local-6989586621683049411"><span class="annot"><span class="annottext">tv :: Var
</span><a href="#local-6989586621683049411"><span class="hs-identifier hs-var hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarBndr Var TyConBndrVis -&gt; Var
forall tv argf. VarBndr tv argf -&gt; tv
</span><a href="GHC.Types.Var.html#binderVar"><span class="hs-identifier hs-var">binderVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarBndr Var TyConBndrVis
</span><a href="#local-6989586621683049409"><span class="hs-identifier hs-var">tcb</span></a></span><span>
</span><span id="line-3066"></span><span>        </span><span id="local-6989586621683049413"><span class="annot"><span class="annottext">fkvs :: VarSet
</span><a href="#local-6989586621683049413"><span class="hs-identifier hs-var hs-var">fkvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Type
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621683049411"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3067"></span></pre></body></html>