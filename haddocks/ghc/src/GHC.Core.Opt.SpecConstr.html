<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, LambdaCase #-}</span><span class="hs-cpp">
#if __GLASGOW_HASKELL__ &lt; 905
</span><span class="hs-pragma">{-# LANGUAGE PatternSynonyms #-}</span><span class="hs-cpp">
#endif
</span><span class="hs-comment">{-
ToDo [Oct 2013]
~~~~~~~~~~~~~~~
1. Nuke ForceSpecConstr for good (it is subsumed by GHC.Types.SPEC in ghc-prim)
2. Nuke NoSpecConstr


(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[SpecConstr]{Specialise over constructors}
-}</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html"><span class="hs-identifier">GHC.Core.Opt.SpecConstr</span></a></span><span class="hs-special">(</span><span>
</span><span id="line-22"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specConstrProgram"><span class="hs-identifier">specConstrProgram</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>        </span><span class="annot"><span class="hs-identifier">SpecConstrAnnotation</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier">SpecFailWarning</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html"><span class="hs-identifier">GHC.Driver.DynFlags</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier">DynFlags</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#GeneralFlag"><span class="hs-identifier">GeneralFlag</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#Opt_SpecConstrKeen"><span class="hs-identifier">Opt_SpecConstrKeen</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier">gopt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#hasPprDebug"><span class="hs-identifier">hasPprDebug</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html"><span class="hs-identifier">GHC.Core.Unfold</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Inline.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Inline</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#exprsFreeVarsList"><span class="hs-identifier">exprsFreeVarsList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier">exprFreeVars</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html"><span class="hs-identifier">GHC.Core.Opt.Monad</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html"><span class="hs-identifier">GHC.Core.Opt.WorkWrap.Utils</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html"><span class="hs-identifier">GHC.Core.Opt.OccurAnal</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#BinderSwapDecision"><span class="hs-identifier">BinderSwapDecision</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier">scrutOkForBinderSwap</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Class.html"><span class="hs-identifier">GHC.Core.Class</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#classTyVars"><span class="hs-identifier">classTyVars</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier">substCo</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html"><span class="hs-identifier">GHC.Core.Rules</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#typeDeterminesValue"><span class="hs-identifier">typeDeterminesValue</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>     </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier">substTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#tyConName"><span class="hs-identifier">tyConName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html"><span class="hs-identifier">GHC.Core.Ppr</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html#pprParendExpr"><span class="hs-identifier">pprParendExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Make.html#mkImpossibleExpr"><span class="hs-identifier">mkImpossibleExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html"><span class="hs-identifier">GHC.Unit.Module.ModGuts</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Error.html"><span class="hs-identifier">GHC.Types.Error</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Error.html#MessageClass"><span class="hs-identifier">MessageClass</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Error.html#Severity"><span class="hs-identifier">Severity</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Error.html#DiagnosticReason"><span class="hs-identifier">DiagnosticReason</span></a></span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Error.html#WarningWithoutFlag"><span class="hs-identifier">WarningWithoutFlag</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Error.html#ResolvedDiagnosticReason"><span class="hs-identifier">ResolvedDiagnosticReason</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html"><span class="hs-identifier">GHC.Types.Literal</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html#litIsLifted"><span class="hs-identifier">litIsLifted</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#IdDetails"><span class="hs-identifier">IdDetails</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html"><span class="hs-identifier">GHC.Types.Id.Make</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#voidArgId"><span class="hs-identifier">voidArgId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#voidPrimId"><span class="hs-identifier">voidPrimId</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html"><span class="hs-identifier">GHC.Types.Cpr</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html"><span class="hs-identifier">GHC.Types.Unique.Supply</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html"><span class="hs-identifier">GHC.Types.Unique.FM</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#hasKey"><span class="hs-identifier">hasKey</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html#orElse"><span class="hs-identifier">orElse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isNothing</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Constants.html"><span class="hs-identifier">GHC.Utils.Constants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier">debugIsOn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#specTyConKey"><span class="hs-identifier">specTyConKey</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/GHC.Exts.html"><span class="hs-identifier">GHC.Exts</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">SpecConstrAnnotation</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html"><span class="hs-identifier">GHC.Serialized</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#deserializeWithData"><span class="hs-identifier">deserializeWithData</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">sortBy</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">partition</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">dropWhileEnd</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapAccumL</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Ord.html"><span class="hs-identifier">Data.Ord</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">comparing</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.21.0.0-ae91/src/Data.Tuple.html"><span class="hs-identifier">Data.Tuple</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">{-
-----------------------------------------------------
                        Game plan
-----------------------------------------------------

Consider
        drop n []     = []
        drop 0 xs     = []
        drop n (x:xs) = drop (n-1) xs

After the first time round, we could pass n unboxed.  This happens in
numerical code too.  Here's what it looks like in Core:

        drop n xs = case xs of
                      []     -&gt; []
                      (y:ys) -&gt; case n of
                                  I# n# -&gt; case n# of
                                             0 -&gt; []
                                             _ -&gt; drop (I# (n# -# 1#)) xs

Notice that the recursive call has an explicit constructor as argument.
Noticing this, we can make a specialised version of drop

        RULE: drop (I# n#) xs ==&gt; drop' n# xs

        drop' n# xs = let n = I# n# in ...orig RHS...

Now the simplifier will apply the specialisation in the rhs of drop', giving

        drop' n# xs = case xs of
                      []     -&gt; []
                      (y:ys) -&gt; case n# of
                                  0 -&gt; []
                                  _ -&gt; drop' (n# -# 1#) xs

Much better!

We'd also like to catch cases where a parameter is carried along unchanged,
but evaluated each time round the loop:

        f i n = if i&gt;0 || i&gt;n then i else f (i*2) n

Here f isn't strict in n, but we'd like to avoid evaluating it each iteration.
In Core, by the time we've w/wd (f is strict in i) we get

        f i# n = case i# &gt;# 0 of
                   False -&gt; I# i#
                   True  -&gt; case n of { I# n# -&gt;
                            case i# &gt;# n# of
                                False -&gt; I# i#
                                True  -&gt; f (i# *# 2#) n

At the call to f, we see that the argument, n is known to be (I# n#),
and n is evaluated elsewhere in the body of f, so we can play the same
trick as above.


Note [Reboxing]
~~~~~~~~~~~~~~~
We must be careful not to allocate the same constructor twice.  Consider
        f p = (...(case p of (a,b) -&gt; e)...p...,
               ...let t = (r,s) in ...t...(f t)...)
At the recursive call to f, we can see that t is a pair.  But we do NOT want
to make a specialised copy:
        f' a b = let p = (a,b) in (..., ...)
because now t is allocated by the caller, then r and s are passed to the
recursive call, which allocates the (r,s) pair again.

This happens if
  (a) the argument p is used in other than a case-scrutinisation way.
  (b) the argument to the call is not a 'fresh' tuple; you have to
        look into its unfolding to see that it's a tuple

Hence the &quot;OR&quot; part of Note [Good arguments] below.

ALTERNATIVE 2: pass both boxed and unboxed versions.  This no longer saves
allocation, but does perhaps save evals. In the RULE we'd have
something like

  f (I# x#) = f' (I# x#) x#

If at the call site the (I# x) was an unfolding, then we'd have to
rely on CSE to eliminate the duplicate allocation.... This alternative
doesn't look attractive enough to pursue.

ALTERNATIVE 3: ignore the reboxing problem.  The trouble is that
the conservative reboxing story prevents many useful functions from being
specialised.  Example:
        foo :: Maybe Int -&gt; Int -&gt; Int
        foo   (Just m) 0 = 0
        foo x@(Just m) n = foo x (n-m)
Here the use of 'x' will clearly not require boxing in the specialised function.

The strictness analyser has the same problem, in fact.  Example:
        f p@(a,b) = ...
If we pass just 'a' and 'b' to the worker, it might need to rebox the
pair to create (a,b).  A more sophisticated analysis might figure out
precisely the cases in which this could happen, but the strictness
analyser does no such analysis; it just passes 'a' and 'b', and hopes
for the best.

So my current choice is to make SpecConstr similarly aggressive, and
ignore the bad potential of reboxing.


Note [Good arguments]
~~~~~~~~~~~~~~~~~~~~~
So we look for

* A self-recursive function.  Ignore mutual recursion for now,
  because it's less common, and the code is simpler for self-recursion.

* EITHER

   a) At a recursive call, one or more parameters is an explicit
      constructor application
        AND
      That same parameter is scrutinised by a case somewhere in
      the RHS of the function

  OR

    b) At a recursive call, one or more parameters has an unfolding
       that is an explicit constructor application
        AND
      That same parameter is scrutinised by a case somewhere in
      the RHS of the function
        AND
      Those are the only uses of the parameter (see Note [Reboxing])


What to abstract over
~~~~~~~~~~~~~~~~~~~~~
There's a bit of a complication with type arguments.  If the call
site looks like

        f p = ...f ((:) [a] x xs)...

then our specialised function look like

        f_spec x xs = let p = (:) [a] x xs in ....as before....

This only makes sense if either
  a) the type variable 'a' is in scope at the top of f, or
  b) the type variable 'a' is an argument to f (and hence fs)

Actually, (a) may hold for value arguments too, in which case
we may not want to pass them.  Suppose 'x' is in scope at f's
defn, but xs is not.  Then we'd like

        f_spec xs = let p = (:) [a] x xs in ....as before....

Similarly (b) may hold too.  If x is already an argument at the
call, no need to pass it again.

Finally, if 'a' is not in scope at the call site, we could abstract
it as we do the term variables:

        f_spec a x xs = let p = (:) [a] x xs in ...as before...

So the grand plan is:

        * abstract the call site to a constructor-only pattern
          e.g.  C x (D (f p) (g q))  ==&gt;  C s1 (D s2 s3)

        * Find the free variables of the abstracted pattern

        * Pass these variables, less any that are in scope at
          the fn defn.  But see Note [Shadowing in SpecConstr] below.


NOTICE that we only abstract over variables that are not in scope,
so we're in no danger of shadowing variables used in &quot;higher up&quot;
in f_spec's RHS.


Note [Shadowing in SpecConstr]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In this pass we gather up usage information that may mention variables
that are bound between the usage site and the definition site; or (more
seriously) may be bound to something different at the definition site.
For example:

        f x = letrec g y v = let x = ...
                             in ...(g (a,b) x)...

Since 'x' is in scope at the call site, we may make a rewrite rule that
looks like
        RULE forall a,b. g (a,b) x = ...
But this rule will never match, because it's really a different 'x' at
the call site -- and that difference will be manifest by the time the
simplifier gets to it.  [A worry: the simplifier doesn't *guarantee*
no-shadowing, so perhaps it may not be distinct?]

Anyway, the rule isn't actually wrong, it's just not useful.  One possibility
is to run deShadowBinds before running SpecConstr, but instead we run the
simplifier.  That gives the simplest possible program for SpecConstr to
chew on; and it virtually guarantees no shadowing.

Note [Specialising for constant parameters]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This one is about specialising on a *constant* (but not necessarily
constructor) argument

    foo :: Int -&gt; (Int -&gt; Int) -&gt; Int
    foo 0 f = 0
    foo m f = foo (f m) (+1)

It produces

    lvl_rmV :: GHC.Base.Int -&gt; GHC.Base.Int
    lvl_rmV =
      \ (ds_dlk :: GHC.Base.Int) -&gt;
        case ds_dlk of wild_alH { GHC.Base.I# x_alG -&gt;
        GHC.Base.I# (GHC.Prim.+# x_alG 1)

    T.$wfoo :: GHC.Prim.Int# -&gt; (GHC.Base.Int -&gt; GHC.Base.Int) -&gt;
    GHC.Prim.Int#
    T.$wfoo =
      \ (ww_sme :: GHC.Prim.Int#) (w_smg :: GHC.Base.Int -&gt; GHC.Base.Int) -&gt;
        case ww_sme of ds_Xlw {
          __DEFAULT -&gt;
        case w_smg (GHC.Base.I# ds_Xlw) of w1_Xmo { GHC.Base.I# ww1_Xmz -&gt;
        T.$wfoo ww1_Xmz lvl_rmV
        };
          0 -&gt; 0
        }

The recursive call has lvl_rmV as its argument, so we could create a specialised copy
with that argument baked in; that is, not passed at all.   Now it can perhaps be inlined.

When is this worth it?  Call the constant 'lvl'
- If 'lvl' has an unfolding that is a constructor, see if the corresponding
  parameter is scrutinised anywhere in the body.

- If 'lvl' has an unfolding that is a inlinable function, see if the corresponding
  parameter is applied (...to enough arguments...?)

  Also do this is if the function has RULES?

Also

Note [Specialising for lambda parameters]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    foo :: Int -&gt; (Int -&gt; Int) -&gt; Int
    foo 0 f = 0
    foo m f = foo (f m) (\n -&gt; n-m)

This is subtly different from the previous one in that we get an
explicit lambda as the argument:

    T.$wfoo :: GHC.Prim.Int# -&gt; (GHC.Base.Int -&gt; GHC.Base.Int) -&gt;
    GHC.Prim.Int#
    T.$wfoo =
      \ (ww_sm8 :: GHC.Prim.Int#) (w_sma :: GHC.Base.Int -&gt; GHC.Base.Int) -&gt;
        case ww_sm8 of ds_Xlr {
          __DEFAULT -&gt;
        case w_sma (GHC.Base.I# ds_Xlr) of w1_Xmf { GHC.Base.I# ww1_Xmq -&gt;
        T.$wfoo
          ww1_Xmq
          (\ (n_ad3 :: GHC.Base.Int) -&gt;
             case n_ad3 of wild_alB { GHC.Base.I# x_alA -&gt;
             GHC.Base.I# (GHC.Prim.-# x_alA ds_Xlr)
             })
        };
          0 -&gt; 0
        }

I wonder if SpecConstr couldn't be extended to handle this? After all,
lambda is a sort of constructor for functions and perhaps it already
has most of the necessary machinery?

Furthermore, there's an immediate win, because you don't need to allocate the lambda
at the call site; and if perchance it's called in the recursive call, then you
may avoid allocating it altogether.  Just like for constructors.

Looks cool, but probably rare...but it might be easy to implement.


Note [SpecConstr for casts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    data family T a :: *
    data instance T Int = T Int

    foo n = ...
       where
         go (T 0) = 0
         go (T n) = go (T (n-1))

The recursive call ends up looking like
        go (T (I# ...) `cast` g)
So we want to spot the constructor application inside the cast.
That's why we have the Cast case in argToPat

Note [Seeding recursive groups]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For a recursive group that is either
  * nested, or
  * top-level, but with no exported Ids
we can see all the calls to the function, so we seed the specialisation
loop from the calls in the body, and /not/ from the calls in the RHS.
Consider:

  bar m n = foo n (n,n) (n,n) (n,n) (n,n)
   where
     foo n p q r s
       | n == 0    = m
       | n &gt; 3000  = case p of { (p1,p2) -&gt; foo (n-1) (p2,p1) q r s }
       | n &gt; 2000  = case q of { (q1,q2) -&gt; foo (n-1) p (q2,q1) r s }
       | n &gt; 1000  = case r of { (r1,r2) -&gt; foo (n-1) p q (r2,r1) s }
       | otherwise = case s of { (s1,s2) -&gt; foo (n-1) p q r (s2,s1) }

If we start with the RHSs of 'foo', we get lots and lots of specialisations,
most of which are not needed.  But if we start with the (single) call
in the rhs of 'bar' we get exactly one fully-specialised copy, and all
the recursive calls go to this fully-specialised copy. Indeed, the original
function is later collected as dead code.  This is very important in
specialising the loops arising from stream fusion, for example in NDP where
we were getting literally hundreds of (mostly unused) specialisations of
a local function.

In a case like the above we end up never calling the original un-specialised
function.  (Although we still leave its code around just in case.)

Wrinkles

* Boring calls. If we find any boring calls in the body, including
  *unsaturated* ones, such as
      letrec foo x y = ....foo...
      in map foo xs
  then we will end up calling the un-specialised function, so then we
  *should* use the calls in the un-specialised RHS as seeds.  We call
  these &quot;boring call patterns&quot;, and callsToNewPats reports if it finds
  any of these.  Then 'specialise' unleashes the usage info from the
  un-specialised RHS.

* Exported Ids. `specialise` /also/ unleashes `si_mb_unspec`
  for exported Ids.  That way we are sure to generate usage info from
  the /un-specialised/ RHS of an exported function.

More precisely:

* Always start from the calls in the body of the let or (for top level)
  calls in the rest of the module.  See the body_calls in the call to
  `specialise` in `specNonRec`, and to `go` in `specRec`.

* si_mb_unspec holds the usage from the unspecialised RHS.
  See `initSpecInfo`.

* `specialise` will unleash si_mb_unspec, if
  - `callsToNewPats` reports &quot;boring calls found&quot;, or
  - this is a top-level exported Id.

Historical note.  At an earlier point, if a top-level Id was exported,
we used only seeds from the RHS, and /not/from the body. But Dimitrios
had an example where using call patterns from the body (the other defns
in the module) was crucial.  And doing so improved nofib allocation results:
    multiplier: 4%   better
    minimax:    2.8% better
In any case, it is easier to do!

Note [Do not specialise diverging functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Specialising a function that just diverges is a waste of code.
Furthermore, it broke GHC (simpl014) thus:
   {-# STR Sb #-}
   f = \x. case x of (a,b) -&gt; f x
If we specialise f we get
   f = \x. case x of (a,b) -&gt; fspec a b
But fspec doesn't have decent strictness info.  As it happened,
(f x) :: IO t, so the state hack applied and we eta expanded fspec,
and hence f.  But now f's strictness is less than its arity, which
breaks an invariant.


Note [Forcing specialisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
With stream fusion and in other similar cases, we want to fully
specialise some (but not necessarily all!) loops regardless of their
size and the number of specialisations.

We allow a library to do this, in one of two ways (one which is
deprecated):

  1) Add a parameter of type GHC.Types.SPEC (from ghc-prim) to the loop body.

  2) (Deprecated) Annotate a type with ForceSpecConstr from GHC.Exts,
     and then add *that* type as a parameter to the loop body

The reason #2 is deprecated is because it requires GHCi, which isn't
available for things like a cross compiler using stage1.

Here's a (simplified) example from the `vector` package. You may bring
the special 'force specialization' type into scope by saying:

  import GHC.Types (SPEC(..))

or by defining your own type (again, deprecated):

  data SPEC = SPEC | SPEC2
  {-# ANN type SPEC ForceSpecConstr #-}

(Note this is the exact same definition of GHC.Types.SPEC, just
without the annotation.)

After that, you say:

  foldl :: (a -&gt; b -&gt; a) -&gt; a -&gt; Stream b -&gt; a
  {-# INLINE foldl #-}
  foldl f z (Stream step s _) = foldl_loop SPEC z s
    where
      foldl_loop !sPEC z s = case step s of
                              Yield x s' -&gt; foldl_loop sPEC (f z x) s'
                              Skip       -&gt; foldl_loop sPEC z s'
                              Done       -&gt; z

SpecConstr will spot the SPEC parameter and always fully specialise
foldl_loop. Note that

  * We have to prevent the SPEC argument from being removed by
    w/w which is why (a) SPEC is a sum type, and (b) we have to seq on
    the SPEC argument.

  * And lastly, the SPEC argument is ultimately eliminated by
    SpecConstr itself so there is no runtime overhead.

This is all quite ugly; we ought to come up with a better design.

ForceSpecConstr arguments are spotted in scExpr' and scTopBinds which then set
sc_force to True when calling specLoop. This flag does four things:

(FS1) Ignore specConstrThreshold, to specialise functions of arbitrary size
        (see scTopBind)
(FS2) Ignore specConstrCount, to make arbitrary numbers of specialisations
        (see specialise)
(FS3) Specialise even for arguments that are not scrutinised in the loop
        (see argToPat; #4448)
(FS4) Only specialise on recursive types a finite number of times
        (see sc_recursive; #5550; Note [Limit recursive specialisation])
(FS5) Use a different restriction on the maximum number of arguments which
        the optimisation will specialise. We tried removing the limit on worker
        args for forced specs (#14003) but this caused issues when specializing
        code for large data structures (#25197).
        This is handled by `too_many_worker_args` in `callsToNewPats`

The flag holds only for specialising a single binding group, and NOT
for nested bindings.  (So really it should be passed around explicitly
and not stored in ScEnv.)  #14379 turned out to be caused by
   f SPEC x = let g1 x = ...
              in ...
We force-specialise f (because of the SPEC), but that generates a specialised
copy of g1 (as well as the original).  Alas g1 has a nested binding g2; and
in each copy of g1 we get an unspecialised and specialised copy of g2; and so
on. Result, exponential.  So the force-spec flag now only applies to one
level of bindings at a time.

Mechanism for this one-level-only thing:

 - Switch it on at the call to specRec, in scExpr and scTopBinds
 - Switch it off when doing the RHSs;
   this can be done very conveniently in decreaseSpecCount

What alternatives did I consider?

* Annotating the loop itself doesn't work because (a) it is local and
  (b) it will be w/w'ed and having w/w propagating annotations somehow
  doesn't seem like a good idea. The types of the loop arguments
  really seem to be the most persistent thing.

* Annotating the types that make up the loop state doesn't work,
  either, because (a) it would prevent us from using types like Either
  or tuples here, (b) we don't want to restrict the set of types that
  can be used in Stream states and (c) some types are fixed by the
  user (e.g., the accumulator here) but we still want to specialise as
  much as possible.

Alternatives to ForceSpecConstr
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Instead of giving the loop an extra argument of type SPEC, we
also considered *wrapping* arguments in SPEC, thus
  data SPEC a = SPEC a | SPEC2

  loop = \arg -&gt; case arg of
                     SPEC state -&gt;
                        case state of (x,y) -&gt; ... loop (SPEC (x',y')) ...
                        S2 -&gt; error ...
The idea is that a SPEC argument says &quot;specialise this argument
regardless of whether the function case-analyses it&quot;.  But this
doesn't work well:
  * SPEC must still be a sum type, else the strictness analyser
    eliminates it
  * But that means that 'loop' won't be strict in its real payload
This loss of strictness in turn screws up specialisation, because
we may end up with calls like
   loop (SPEC (case z of (p,q) -&gt; (q,p)))
Without the SPEC, if 'loop' were strict, the case would move out
and we'd see loop applied to a pair. But if 'loop' isn't strict
this doesn't look like a specialisable call.

Note [Limit recursive specialisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It is possible for ForceSpecConstr to cause an infinite loop of specialisation.
Because there is no limit on the number of specialisations, a recursive call with
a recursive constructor as an argument (for example, list cons) will generate
a specialisation for that constructor. If the resulting specialisation also
contains a recursive call with the constructor, this could proceed indefinitely.

For example, if ForceSpecConstr is on:
  loop :: [Int] -&gt; [Int] -&gt; [Int]
  loop z []         = z
  loop z (x:xs)     = loop (x:z) xs
this example will create a specialisation for the pattern
  loop (a:b) c      = loop' a b c

  loop' a b []      = (a:b)
  loop' a b (x:xs)  = loop (x:(a:b)) xs
and a new pattern is found:
  loop (a:(b:c)) d  = loop'' a b c d
which can continue indefinitely.

Roman's suggestion to fix this was to stop after a couple of times on recursive types,
but still specialising on non-recursive types as much as possible.

To implement this, we count the number of times we have gone round the
&quot;specialise recursively&quot; loop ('go' in 'specRec').  Once have gone round
more than N times (controlled by -fspec-constr-recursive=N) we check

  - If sc_force is off, and sc_count is (Just max) then we don't
    need to do anything: trim_pats will limit the number of specs

  - Otherwise check if any function has now got more than (sc_count env)
    specialisations.  If sc_count is &quot;no limit&quot; then we arbitrarily
    choose 10 as the limit (ugh).

See #5550.   Also #13623, where this test had become over-aggressive,
and we lost a wonderful specialisation that we really wanted!

Note [NoSpecConstr]
~~~~~~~~~~~~~~~~~~~
The ignoreDataCon stuff allows you to say
    {-# ANN type T NoSpecConstr #-}
to mean &quot;don't specialise on arguments of this type&quot;.  It was added
before we had ForceSpecConstr.  Lacking ForceSpecConstr we specialised
regardless of size; and then we needed a way to turn that *off*.  Now
that we have ForceSpecConstr, this NoSpecConstr is probably redundant.
(Used only for PArray, TODO: remove?)

Note [SpecConstr and strict fields]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We treat strict fields in SpecConstr the same way we do in W/W.
That is we make the specialized function strict in arguments
representing strict fields. See Note [Call-by-value for worker args]
for why we do this.

(SCF1) The arg_id might be an /imported/ Id like M.foo_acf (see #24944).
  We don't want to make
     case M.foo_acf of M.foo_acf { DEFAULT -&gt; blah }
  because the binder of a case-expression should never be imported.  Rather,
  we must localise it thus:
     case M.foo_acf of foo_acf { DEFAULT -&gt; blah }
  We keep the same unique, so in the next round of simplification we'll replace
  any M.foo_acf's in `blah` by `foo_acf`.

  c.f. Note [Localise pattern binders] in GHC.HsToCore.Utils.

Note [Specialising on dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In #21386, SpecConstr saw this call:

   $wgo 100# @.. ($fMonadStateT @.. @.. $fMonadIdentity)

where $wgo :: Int# -&gt; forall m. Monad m =&gt; blah

You might think that the type-class Specialiser would have specialised
this, but there are good reasons why not: the Specialiser ran too early.
But regardless, SpecConstr can and should!  It's easy:

* isValue: treat ($fblah d1 .. dn)
  like a constructor application.

* scApp: treat (op_sel d), a class method selection,
  like a case expression

* Float that dictionary application to top level, thus
    lvl = $fMonadStateT @.. @.. $fMonadIdentity
  so the call looks like
    ($wgo 100# @.. lvl)

  Why? This way dictionaries will appear as top level binders which we
  can trivially match in rules.  (CSE runs before SpecConstr, so we
  may hope to common-up duplicate top-level dictionaries.)
  For the floating part, see the &quot;Arguments&quot; case of Note
  [Floating to the top] in GHC.Core.Opt.SetLevels.

  We could be more clever, perhaps, and generate a RULE like
     $wgo _  @.. ($fMonadStateT @.. @.. $fMonadIdentity) = $s$wgo ...
  but that would mean making argToPat able to spot dfun applications as
  well as constructor applications.

Wrinkles:

* This should all work perfectly fine for newtype classes.  Mind you,
  currently newtype classes are inlined fairly agressively, but we
  may change that. And it would take extra code to exclude them, as
  well as being unnecessary.

* In isValue, we (mis-) use LambdaVal for this ($fblah d1 .. dn)
  because ConVal requires us to list the data constructor and
  fields, and that is (a) inconvenient and (b) unnecessary for
  class methods.

-----------------------------------------------------
                Stuff not yet handled
-----------------------------------------------------

Here are notes arising from Roman's work that I don't want to lose.

Example 1
~~~~~~~~~
    data T a = T !a

    foo :: Int -&gt; T Int -&gt; Int
    foo 0 t = 0
    foo x t | even x    = case t of { T n -&gt; foo (x-n) t }
            | otherwise = foo (x-1) t

SpecConstr does no specialisation, because the second recursive call
looks like a boxed use of the argument.  A pity.

    $wfoo_sFw :: GHC.Prim.Int# -&gt; T.T GHC.Base.Int -&gt; GHC.Prim.Int#
    $wfoo_sFw =
      \ (ww_sFo [Just L] :: GHC.Prim.Int#) (w_sFq [Just L] :: T.T GHC.Base.Int) -&gt;
         case ww_sFo of ds_Xw6 [Just L] {
           __DEFAULT -&gt;
                case GHC.Prim.remInt# ds_Xw6 2 of wild1_aEF [Dead Just A] {
                  __DEFAULT -&gt; $wfoo_sFw (GHC.Prim.-# ds_Xw6 1) w_sFq;
                  0 -&gt;
                    case w_sFq of wild_Xy [Just L] { T.T n_ad5 [Just U(L)] -&gt;
                    case n_ad5 of wild1_aET [Just A] { GHC.Base.I# y_aES [Just L] -&gt;
                    $wfoo_sFw (GHC.Prim.-# ds_Xw6 y_aES) wild_Xy
                    } } };
           0 -&gt; 0

Example 2
~~~~~~~~~
    data a :*: b = !a :*: !b
    data T a = T !a

    foo :: (Int :*: T Int) -&gt; Int
    foo (0 :*: t) = 0
    foo (x :*: t) | even x    = case t of { T n -&gt; foo ((x-n) :*: t) }
                  | otherwise = foo ((x-1) :*: t)

Very similar to the previous one, except that the parameters are now in
a strict tuple. Before SpecConstr, we have

    $wfoo_sG3 :: GHC.Prim.Int# -&gt; T.T GHC.Base.Int -&gt; GHC.Prim.Int#
    $wfoo_sG3 =
      \ (ww_sFU [Just L] :: GHC.Prim.Int#) (ww_sFW [Just L] :: T.T
    GHC.Base.Int) -&gt;
        case ww_sFU of ds_Xws [Just L] {
          __DEFAULT -&gt;
        case GHC.Prim.remInt# ds_Xws 2 of wild1_aEZ [Dead Just A] {
          __DEFAULT -&gt;
            case ww_sFW of tpl_B2 [Just L] { T.T a_sFo [Just A] -&gt;
            $wfoo_sG3 (GHC.Prim.-# ds_Xws 1) tpl_B2             -- $wfoo1
            };
          0 -&gt;
            case ww_sFW of wild_XB [Just A] { T.T n_ad7 [Just S(L)] -&gt;
            case n_ad7 of wild1_aFd [Just L] { GHC.Base.I# y_aFc [Just L] -&gt;
            $wfoo_sG3 (GHC.Prim.-# ds_Xws y_aFc) wild_XB        -- $wfoo2
            } } };
          0 -&gt; 0 }

We get two specialisations:
&quot;SC:$wfoo1&quot; [0] __forall {a_sFB :: GHC.Base.Int sc_sGC :: GHC.Prim.Int#}
                  Foo.$wfoo sc_sGC (Foo.T @ GHC.Base.Int a_sFB)
                  = Foo.$s$wfoo1 a_sFB sc_sGC ;
&quot;SC:$wfoo2&quot; [0] __forall {y_aFp :: GHC.Prim.Int# sc_sGC :: GHC.Prim.Int#}
                  Foo.$wfoo sc_sGC (Foo.T @ GHC.Base.Int (GHC.Base.I# y_aFp))
                  = Foo.$s$wfoo y_aFp sc_sGC ;

But perhaps the first one isn't good.  After all, we know that tpl_B2 is
a T (I# x) really, because T is strict and Int has one constructor.  (We can't
unbox the strict fields, because T is polymorphic!)

************************************************************************
*                                                                      *
\subsection{Top level wrapper stuff}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-784"></span><span>
</span><span id="line-785"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specConstrProgram"><span class="hs-identifier hs-type">specConstrProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span>
</span><span id="line-786"></span><span id="specConstrProgram"><span class="annot"><span class="annottext">specConstrProgram :: ModGuts -&gt; CoreM ModGuts
</span><a href="GHC.Core.Opt.SpecConstr.html#specConstrProgram"><span class="hs-identifier hs-var hs-var">specConstrProgram</span></a></span></span><span> </span><span id="local-6989586621682941337"><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682941337"><span class="hs-identifier hs-var">guts</span></a></span></span><span>
</span><span id="line-787"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682941338"><span class="annot"><a href="#local-6989586621682941338"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModGuts -&gt; CoreM ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#initScEnv"><span class="hs-identifier hs-var">initScEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682941337"><span class="hs-identifier hs-var">guts</span></a></span><span>
</span><span id="line-788"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682941340"><span class="annot"><a href="#local-6989586621682941340"><span class="hs-identifier hs-var">us</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#getUniqueSupplyM"><span class="hs-identifier hs-type">getUniqueSupplyM</span></a></span><span>
</span><span id="line-789"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941342"><span class="annot"><a href="#local-6989586621682941342"><span class="hs-identifier hs-var">_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941343"><span class="annot"><a href="#local-6989586621682941343"><span class="hs-identifier hs-var">binds'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941344"><span class="annot"><a href="#local-6989586621682941344"><span class="hs-identifier hs-var">warnings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#initUs_"><span class="hs-identifier hs-type">initUs_</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941340"><span class="hs-identifier hs-type">us</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-790"></span><span>                              </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scTopBinds"><span class="hs-identifier hs-type">scTopBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941338"><span class="hs-identifier hs-type">env0</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941337"><span class="hs-identifier hs-type">guts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-791"></span><span>
</span><span id="line-792"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621682941344"><span class="hs-identifier hs-type">warnings</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#msg"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941352"><span class="hs-identifier hs-type">specConstr_warn_class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941353"><span class="hs-identifier hs-type">warn_msg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941344"><span class="hs-identifier hs-type">warnings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941337"><span class="hs-identifier hs-type">guts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941343"><span class="hs-identifier hs-type">binds'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-795"></span><span>
</span><span id="line-796"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-797"></span><span>    </span><span id="local-6989586621682941352"><span class="annot"><span class="annottext">specConstr_warn_class :: MessageClass
</span><a href="#local-6989586621682941352"><span class="hs-identifier hs-var hs-var">specConstr_warn_class</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Severity
-&gt; ResolvedDiagnosticReason -&gt; Maybe DiagnosticCode -&gt; MessageClass
</span><a href="GHC.Types.Error.html#MCDiagnostic"><span class="hs-identifier hs-var">MCDiagnostic</span></a></span><span> </span><span class="annot"><span class="annottext">Severity
</span><a href="GHC.Types.Error.html#SevWarning"><span class="hs-identifier hs-var">SevWarning</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiagnosticReason -&gt; ResolvedDiagnosticReason
</span><a href="GHC.Types.Error.html#ResolvedDiagnosticReason"><span class="hs-identifier hs-var">ResolvedDiagnosticReason</span></a></span><span> </span><span class="annot"><span class="annottext">DiagnosticReason
</span><a href="GHC.Types.Error.html#WarningWithoutFlag"><span class="hs-identifier hs-var">WarningWithoutFlag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe DiagnosticCode
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-798"></span><span>    </span><span class="annot"><a href="#local-6989586621682941353"><span class="hs-identifier hs-type">warn_msg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-799"></span><span>    </span><span id="local-6989586621682941353"><span class="annot"><span class="annottext">warn_msg :: [SpecFailWarning] -&gt; SDoc
</span><a href="#local-6989586621682941353"><span class="hs-identifier hs-var hs-var">warn_msg</span></a></span></span><span> </span><span id="local-6989586621682941358"><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941358"><span class="hs-identifier hs-var">warnings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SpecConstr encountered one or more function(s) with a SPEC argument that resulted in too many arguments,&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-800"></span><span>                        </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;which resulted in no specialization being generated for these functions:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-801"></span><span>                        </span><span class="annot"><span class="annottext">Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SpecFailWarning -&gt; SDoc) -&gt; [SpecFailWarning] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SpecFailWarning -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941358"><span class="hs-identifier hs-var">warnings</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-802"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;If this is expected you might want to increase -fmax-forced-spec-args to force specialization anyway.&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scTopBinds"><span class="hs-identifier hs-type">scTopBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InBind"><span class="hs-identifier hs-type">InBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBind"><span class="hs-identifier hs-type">OutBind</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier hs-type">SpecFailWarning</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-804"></span><span id="scTopBinds"><span class="annot"><span class="annottext">scTopBinds :: ScEnv
-&gt; [OutBind] -&gt; UniqSM (ScUsage, [OutBind], [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scTopBinds"><span class="hs-identifier hs-var hs-var">scTopBinds</span></a></span></span><span> </span><span id="local-6989586621682941365"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941365"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScUsage, [OutBind], [SpecFailWarning])
-&gt; UniqSM (ScUsage, [OutBind], [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var">nullUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scTopBinds"><span class="hs-identifier hs-var">scTopBinds</span></a></span><span> </span><span id="local-6989586621682941367"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941367"><span class="hs-identifier hs-var">env</span></a></span></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621682941368"><span class="annot"><span class="annottext">OutBind
</span><a href="#local-6989586621682941368"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682941369"><span class="annot"><span class="annottext">[OutBind]
</span><a href="#local-6989586621682941369"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941370"><span class="annot"><a href="#local-6989586621682941370"><span class="hs-identifier hs-var">usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941371"><span class="annot"><a href="#local-6989586621682941371"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941372"><span class="annot"><a href="#local-6989586621682941372"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941373"><span class="annot"><a href="#local-6989586621682941373"><span class="hs-identifier hs-var">warnings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; ScEnv
-&gt; OutBind
-&gt; (ScEnv -&gt; UniqSM (ScUsage, [OutBind], [SpecFailWarning]))
-&gt; UniqSM (ScUsage, [OutBind], [OutBind], [SpecFailWarning])
forall a.
TopLevelFlag
-&gt; ScEnv
-&gt; OutBind
-&gt; (ScEnv -&gt; UniqSM (ScUsage, a, [SpecFailWarning]))
-&gt; UniqSM (ScUsage, [OutBind], a, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scBind"><span class="hs-identifier hs-var">scBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941367"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutBind
</span><a href="#local-6989586621682941368"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">((ScEnv -&gt; UniqSM (ScUsage, [OutBind], [SpecFailWarning]))
 -&gt; UniqSM (ScUsage, [OutBind], [OutBind], [SpecFailWarning]))
-&gt; (ScEnv -&gt; UniqSM (ScUsage, [OutBind], [SpecFailWarning]))
-&gt; UniqSM (ScUsage, [OutBind], [OutBind], [SpecFailWarning])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-806"></span><span>                                                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682941376"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941376"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScEnv
-&gt; [OutBind] -&gt; UniqSM (ScUsage, [OutBind], [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scTopBinds"><span class="hs-identifier hs-var">scTopBinds</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941376"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[OutBind]
</span><a href="#local-6989586621682941369"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-807"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941370"><span class="hs-identifier hs-type">usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941371"><span class="hs-identifier hs-type">b'</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682941372"><span class="hs-identifier hs-type">bs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941373"><span class="hs-identifier hs-type">warnings</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Environment: goes downwards}
*                                                                      *
************************************************************************

Note [ConVal work-free-ness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The sc_vals field keeps track of in-scope value bindings, and is used in
two ways:

(1) To do case-of-known-constructor in a case expression.  E.g. if sc_vals
    includes [x :-&gt; ConVal Just e], then we can simplify
      case x of Just y -&gt; ...
    with the case-of-known-constructor transformation. (Yes this is
    done by the Simplifier, but SpecConstr creates new opportunities when
    it makes a specialised RHS for a function.)

    For (1) it is crucial that the arguments are /work-free/; see (CV1)
    below.

(2) To figure out call pattresns. E.g. if sc_vals includes
    [x :-&gt; ConVal Just e], and we have call (f x), then we might want
    to specialise `f (Just _)`

    For (2) it is /not/ important that the constructor arguments are work-free;
    indeed, it would be bad to insist on that. For example
       let x = Just &lt;expensive&gt;
       in ....(f x)...
    Here we want to specialise for `f (Just _)`, and we won't do so if we
    don't allow [x :-&gt; ConVal Just e] into the environment.  Does this ever happen?
    Yes: see #24282.

    (Yes, the Simplifier will ANF that let-binding, but SpecConstr can
    make more: see (CV1) for an example.)

Wrinkle:

(CV1) Why is work-free-ness important for (1)?  In the example in (1) above, of `e` is
      expensive, we do /not/ want to simplify
         case x of { Just y -&gt; ... }  ==&gt;   let y = e in ...
      because the x-binding still exists and we've now duplicated `e`.

      This seldom happens because let-bound constructor applications are ANF-ised, but
      it can happen as a result of on-the-fly transformations in SpecConstr itself.
      Here is #7865:

              let { a'_shr =
                      case xs_af8 of _ {
                        [] -&gt; acc_af6;
                        : ds_dgt [Dmd=&lt;L,A&gt;] ds_dgu [Dmd=&lt;L,A&gt;] -&gt;
                          (expensive x_af7, x_af7
                      } } in
              let { ds_sht =
                      case a'_shr of _ { (p'_afd, q'_afe) -&gt;
                      TSpecConstr_DoubleInline.recursive
                        (GHC.Types.: @ GHC.Types.Int x_af7 wild_X6) (q'_afe, p'_afd)
                      } } in

      When processed knowing that xs_af8 was bound to a cons, we simplify to
         a'_shr = (expensive x_af7, x_af7)
      and we do NOT want to inline that at the occurrence of a'_shr in ds_sht.
      (There are other occurrences of a'_shr.)  No no no.

      It would be possible to do some on-the-fly ANF-ising, so that a'_shr turned
      into a work-free value again, thus
         a1 = expensive x_af7
         a'_shr = (a1, x_af7)
      but that's more work, so until its shown to be important I'm going to
      leave it for now.

Note [Making SpecConstr keener]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this, in (perf/should_run/T9339)
   last (filter odd [1..1000])

After optimisation, including SpecConstr, we get:
   f :: Int# -&gt; Int -&gt; Int
   f x y = case remInt# x 2# of
             __DEFAULT -&gt; case x of
                            __DEFAULT -&gt; f (+# wild_Xp 1#) (I# x)
                            1000000# -&gt; ...
             0# -&gt; case x of
                     __DEFAULT -&gt; f (+# wild_Xp 1#) y
                    1000000#   -&gt; y

Not good!  We build an (I# x) box every time around the loop.
SpecConstr (as described in the paper) does not specialise f, despite
the call (f ... (I# x)) because 'y' is not scrutinised in the body.
But it is much better to specialise f for the case where the argument
is of form (I# x); then we build the box only when returning y, which
is on the cold path.

Another example:

   f x = ...(g x)....

Here 'x' is not scrutinised in f's body; but if we did specialise 'f'
then the call (g x) might allow 'g' to be specialised in turn.

So sc_keen controls whether or not we take account of whether argument is
scrutinised in the body.  True &lt;=&gt; ignore that, and specialise whenever
the function is applied to a data constructor.
-}</span><span>
</span><span id="line-914"></span><span>
</span><span id="line-915"></span><span class="annot"><span class="hs-comment">-- | Options for Specializing over constructors in Core.</span></span><span>
</span><span id="line-916"></span><span class="hs-keyword">data</span><span> </span><span id="SpecConstrOpts"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecConstrOpts"><span class="hs-identifier hs-var">SpecConstrOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SpecConstrOpts"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecConstrOpts"><span class="hs-identifier hs-var">SpecConstrOpts</span></a></span></span><span>
</span><span id="line-917"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="sc_max_args"><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_max_args"><span class="hs-identifier hs-var hs-var">sc_max_args</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-918"></span><span>  </span><span class="hs-comment">-- ^ The threshold at which a worker-wrapper transformation used as part of</span><span>
</span><span id="line-919"></span><span>  </span><span class="hs-comment">-- this pass will no longer happen, measured in the number of arguments.</span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sc_max_forced_args"><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_max_forced_args"><span class="hs-identifier hs-var hs-var">sc_max_forced_args</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-922"></span><span>  </span><span class="hs-comment">-- ^ The threshold at which a worker-wrapper transformation used as part of</span><span>
</span><span id="line-923"></span><span>  </span><span class="hs-comment">-- this pass will no longer happen even if a SPEC arg was used to force</span><span>
</span><span id="line-924"></span><span>  </span><span class="hs-comment">-- specialization. Measured in the number of arguments.</span><span>
</span><span id="line-925"></span><span>  </span><span class="hs-comment">-- See Note [Forcing specialisation]</span><span>
</span><span id="line-926"></span><span>
</span><span id="line-927"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sc_debug"><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_debug"><span class="hs-identifier hs-var hs-var">sc_debug</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-928"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Whether to print debug information</span></span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sc_uf_opts"><span class="annot"><span class="annottext">SpecConstrOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_uf_opts"><span class="hs-identifier hs-var hs-var">sc_uf_opts</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-931"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Unfolding options</span></span><span>
</span><span id="line-932"></span><span>
</span><span id="line-933"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sc_module"><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Module
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_module"><span class="hs-identifier hs-var hs-var">sc_module</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span>
</span><span id="line-934"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The name of the module being processed</span></span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sc_size"><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Maybe Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_size"><span class="hs-identifier hs-var hs-var">sc_size</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Size threshold: Nothing =&gt; no limit</span></span><span>
</span><span id="line-938"></span><span>
</span><span id="line-939"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sc_count"><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Maybe Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_count"><span class="hs-identifier hs-var hs-var">sc_count</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-940"></span><span>  </span><span class="hs-comment">-- ^ Max # of specialisations for any one function. Nothing =&gt; no limit.</span><span>
</span><span id="line-941"></span><span>  </span><span class="hs-comment">-- See Note [Avoiding exponential blowup] and decreaseSpecCount</span><span>
</span><span id="line-942"></span><span>
</span><span id="line-943"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sc_recursive"><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_recursive"><span class="hs-identifier hs-var hs-var">sc_recursive</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-944"></span><span>  </span><span class="hs-comment">-- ^ Max # of specialisations over recursive type. Stops</span><span>
</span><span id="line-945"></span><span>  </span><span class="hs-comment">-- ForceSpecConstr from diverging.</span><span>
</span><span id="line-946"></span><span>
</span><span id="line-947"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sc_keen"><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_keen"><span class="hs-identifier hs-var hs-var">sc_keen</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-948"></span><span>  </span><span class="hs-comment">-- ^ Specialise on arguments that are known constructors, even if they are</span><span>
</span><span id="line-949"></span><span>  </span><span class="hs-comment">-- not scrutinised in the body. See Note [Making SpecConstr keener].</span><span>
</span><span id="line-950"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-951"></span><span>
</span><span id="line-952"></span><span class="hs-keyword">data</span><span> </span><span id="ScEnv"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-var">ScEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SCE"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCE"><span class="hs-identifier hs-var">SCE</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="sc_opts"><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var hs-var">sc_opts</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecConstrOpts"><span class="hs-identifier hs-type">SpecConstrOpts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-953"></span><span>                   </span><span id="sc_force"><span class="annot"><span class="annottext">ScEnv -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_force"><span class="hs-identifier hs-var hs-var">sc_force</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- Force specialisation?</span><span>
</span><span id="line-954"></span><span>                                                </span><span class="hs-comment">-- See Note [Forcing specialisation]</span><span>
</span><span id="line-955"></span><span>
</span><span id="line-956"></span><span>                   </span><span id="sc_subst"><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var hs-var">sc_subst</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span>       </span><span class="hs-comment">-- Current substitution</span><span>
</span><span id="line-957"></span><span>                                                </span><span class="hs-comment">-- Maps InIds to OutExprs</span><span>
</span><span id="line-958"></span><span>
</span><span id="line-959"></span><span>                   </span><span id="sc_how_bound"><span class="annot"><span class="annottext">ScEnv -&gt; HowBoundEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_how_bound"><span class="hs-identifier hs-var hs-var">sc_how_bound</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#HowBoundEnv"><span class="hs-identifier hs-type">HowBoundEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-960"></span><span>                        </span><span class="hs-comment">-- Binds interesting non-top-level variables</span><span>
</span><span id="line-961"></span><span>                        </span><span class="hs-comment">-- Domain is OutVars (*after* applying the substitution)</span><span>
</span><span id="line-962"></span><span>
</span><span id="line-963"></span><span>                   </span><span id="sc_vals"><span class="annot"><span class="annottext">ScEnv -&gt; ValueEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_vals"><span class="hs-identifier hs-var hs-var">sc_vals</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ValueEnv"><span class="hs-identifier hs-type">ValueEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-964"></span><span>                        </span><span class="hs-comment">-- Domain is OutIds (*after* applying the substitution)</span><span>
</span><span id="line-965"></span><span>                        </span><span class="hs-comment">-- Used even for top-level bindings (but not imported ones)</span><span>
</span><span id="line-966"></span><span>
</span><span id="line-967"></span><span>                   </span><span id="sc_annotations"><span class="annot"><span class="annottext">ScEnv -&gt; UniqFM Name SpecConstrAnnotation
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_annotations"><span class="hs-identifier hs-var hs-var">sc_annotations</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SpecConstrAnnotation</span></span><span>
</span><span id="line-968"></span><span>             </span><span class="hs-special">}</span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-971"></span><span class="hs-keyword">type</span><span> </span><span id="HowBoundEnv"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#HowBoundEnv"><span class="hs-identifier hs-var">HowBoundEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#HowBound"><span class="hs-identifier hs-type">HowBound</span></a></span><span>      </span><span class="hs-comment">-- Domain is OutVars</span><span>
</span><span id="line-972"></span><span>
</span><span id="line-973"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-974"></span><span class="hs-keyword">type</span><span> </span><span id="ValueEnv"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ValueEnv"><span class="hs-identifier hs-var">ValueEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span>            </span><span class="hs-comment">-- Domain is OutIds</span><span>
</span><span id="line-975"></span><span>
</span><span id="line-976"></span><span class="hs-keyword">data</span><span> </span><span id="Value"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Value"><span class="hs-identifier hs-var">Value</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ConVal"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ConVal"><span class="hs-identifier hs-var">ConVal</span></a></span></span><span>            </span><span class="hs-comment">-- Constructor application</span><span>
</span><span id="line-977"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>             </span><span class="hs-comment">-- True &lt;=&gt; all args are work-free</span><span>
</span><span id="line-978"></span><span>                                   </span><span class="hs-comment">--      See Note [ConVal work-free-ness]</span><span>
</span><span id="line-979"></span><span>                  </span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span>           </span><span class="hs-comment">-- Never DEFAULT</span><span>
</span><span id="line-980"></span><span>                  </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Saturates the constructor</span><span>
</span><span id="line-981"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span id="LambdaVal"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#LambdaVal"><span class="hs-identifier hs-var">LambdaVal</span></a></span></span><span>         </span><span class="hs-comment">-- Inlinable lambdas or PAPs</span><span>
</span><span id="line-982"></span><span>
</span><span id="line-983"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-984"></span><span>   </span><span id="local-6989586621682941412"><span class="annot"><span class="annottext">ppr :: Value -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="GHC.Core.Opt.SpecConstr.html#LambdaVal"><span class="hs-identifier hs-var">LambdaVal</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&lt;Lambda&gt;&quot;</span></span><span>
</span><span id="line-985"></span><span>   </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ConVal"><span class="hs-identifier hs-type">ConVal</span></a></span><span> </span><span id="local-6989586621682941413"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682941413"><span class="hs-identifier hs-var">wf</span></a></span></span><span> </span><span id="local-6989586621682941414"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941414"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682941415"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941415"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-986"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941415"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941414"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-987"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941414"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682941419"><span class="hs-identifier hs-var">pp_wf</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; SDoc
forall a. Outputable a =&gt; [a] -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#interpp%27SP"><span class="hs-identifier hs-var">interpp'SP</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941415"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-988"></span><span>     </span><span class="hs-keyword">where</span><span>
</span><span id="line-989"></span><span>       </span><span id="local-6989586621682941419"><span class="annot"><span class="annottext">pp_wf :: SDoc
</span><a href="#local-6989586621682941419"><span class="hs-identifier hs-var hs-var">pp_wf</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682941413"><span class="hs-identifier hs-var">wf</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;wf&quot;</span></span><span>
</span><span id="line-990"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;not-wf&quot;</span></span><span>
</span><span id="line-991"></span><span>
</span><span id="line-992"></span><span>
</span><span id="line-993"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-994"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#initScOpts"><span class="hs-identifier hs-type">initScOpts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecConstrOpts"><span class="hs-identifier hs-type">SpecConstrOpts</span></a></span><span>
</span><span id="line-995"></span><span id="initScOpts"><span class="annot"><span class="annottext">initScOpts :: DynFlags -&gt; Module -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#initScOpts"><span class="hs-identifier hs-var hs-var">initScOpts</span></a></span></span><span> </span><span id="local-6989586621682941423"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682941423"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621682941424"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682941424"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecConstrOpts"><span class="hs-identifier hs-type">SpecConstrOpts</span></a></span><span>
</span><span id="line-996"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sc_max_args :: Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_max_args"><span class="hs-identifier hs-var">sc_max_args</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Int
</span><a href="GHC.Driver.DynFlags.html#maxWorkerArgs"><span class="hs-identifier hs-var">maxWorkerArgs</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682941423"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-997"></span><span>          </span><span class="annot"><span class="annottext">sc_max_forced_args :: Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_max_forced_args"><span class="hs-identifier hs-var">sc_max_forced_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Int
</span><a href="GHC.Driver.DynFlags.html#maxForcedSpecArgs"><span class="hs-identifier hs-var">maxForcedSpecArgs</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682941423"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-998"></span><span>          </span><span class="annot"><span class="annottext">sc_debug :: Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_debug"><span class="hs-identifier hs-var">sc_debug</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#hasPprDebug"><span class="hs-identifier hs-var">hasPprDebug</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682941423"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-999"></span><span>          </span><span class="annot"><span class="annottext">sc_uf_opts :: UnfoldingOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_uf_opts"><span class="hs-identifier hs-var">sc_uf_opts</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; UnfoldingOpts
</span><a href="GHC.Driver.DynFlags.html#unfoldingOpts"><span class="hs-identifier hs-var">unfoldingOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682941423"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1000"></span><span>          </span><span class="annot"><span class="annottext">sc_module :: Module
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_module"><span class="hs-identifier hs-var">sc_module</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682941424"><span class="hs-identifier hs-var">this_mod</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1001"></span><span>          </span><span class="annot"><span class="annottext">sc_size :: Maybe Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_size"><span class="hs-identifier hs-var">sc_size</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Maybe Int
</span><a href="GHC.Driver.DynFlags.html#specConstrThreshold"><span class="hs-identifier hs-var">specConstrThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682941423"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1002"></span><span>          </span><span class="annot"><span class="annottext">sc_count :: Maybe Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_count"><span class="hs-identifier hs-var">sc_count</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Maybe Int
</span><a href="GHC.Driver.DynFlags.html#specConstrCount"><span class="hs-identifier hs-var">specConstrCount</span></a></span><span>     </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682941423"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1003"></span><span>          </span><span class="annot"><span class="annottext">sc_recursive :: Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_recursive"><span class="hs-identifier hs-var">sc_recursive</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Int
</span><a href="GHC.Driver.DynFlags.html#specConstrRecursive"><span class="hs-identifier hs-var">specConstrRecursive</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682941423"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1004"></span><span>          </span><span class="annot"><span class="annottext">sc_keen :: Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_keen"><span class="hs-identifier hs-var">sc_keen</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_SpecConstrKeen"><span class="hs-identifier hs-var">Opt_SpecConstrKeen</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682941423"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1005"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1006"></span><span>
</span><span id="line-1007"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#initScEnv"><span class="hs-identifier hs-type">initScEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1008"></span><span id="initScEnv"><span class="annot"><span class="annottext">initScEnv :: ModGuts -&gt; CoreM ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#initScEnv"><span class="hs-identifier hs-var hs-var">initScEnv</span></a></span></span><span> </span><span id="local-6989586621682941431"><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682941431"><span class="hs-identifier hs-var">guts</span></a></span></span><span>
</span><span id="line-1009"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682941432"><span class="annot"><a href="#local-6989586621682941432"><span class="hs-identifier hs-var">dflags</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreM DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-1010"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941434"><span class="annot"><a href="#local-6989586621682941434"><span class="hs-identifier hs-var">anns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#getFirstAnnotations"><span class="hs-identifier hs-type">getFirstAnnotations</span></a></span><span> </span><span class="annot"><a href="../../ghc-boot-9.12.2-1a37/src/GHC.Serialized.html#deserializeWithData"><span class="hs-identifier hs-type">deserializeWithData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941431"><span class="hs-identifier hs-type">guts</span></a></span><span>
</span><span id="line-1011"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682941436"><span class="annot"><a href="#local-6989586621682941436"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html#getModule"><span class="hs-identifier hs-type">getModule</span></a></span><span>
</span><span id="line-1012"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCE"><span class="hs-identifier hs-type">SCE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#initScOpts"><span class="hs-identifier hs-type">initScOpts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941432"><span class="hs-identifier hs-type">dflags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941436"><span class="hs-identifier hs-type">this_mod</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1013"></span><span>                       </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_force"><span class="hs-identifier hs-var">sc_force</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-special">,</span><span>
</span><span id="line-1014"></span><span>                       </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941438"><span class="hs-identifier hs-type">init_subst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1015"></span><span>                       </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_how_bound"><span class="hs-identifier hs-var">sc_how_bound</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-type">emptyVarEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1016"></span><span>                       </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_vals"><span class="hs-identifier hs-var">sc_vals</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-type">emptyVarEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1017"></span><span>                       </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_annotations"><span class="hs-identifier hs-var">sc_annotations</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941434"><span class="hs-identifier hs-type">anns</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1018"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1019"></span><span>    </span><span id="local-6989586621682941438"><span class="annot"><span class="annottext">init_subst :: Subst
</span><a href="#local-6989586621682941438"><span class="hs-identifier hs-var hs-var">init_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">(InScopeSet -&gt; Subst) -&gt; InScopeSet -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[OutBind] -&gt; InScopeSet
</span><a href="GHC.Core.Utils.html#mkInScopeSetBndrs"><span class="hs-identifier hs-var">mkInScopeSetBndrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModGuts -&gt; [OutBind]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682941431"><span class="hs-identifier hs-var">guts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1020"></span><span>        </span><span class="hs-comment">-- Acccount for top-level bindings that are not in dependency order;</span><span>
</span><span id="line-1021"></span><span>        </span><span class="hs-comment">-- see Note [Glomming] in GHC.Core.Opt.OccurAnal</span><span>
</span><span id="line-1022"></span><span>        </span><span class="hs-comment">-- Easiest thing is to bring all the top level binders into scope at once,</span><span>
</span><span id="line-1023"></span><span>        </span><span class="hs-comment">-- as if  at once, as if all the top-level decls were mutually recursive.</span><span>
</span><span id="line-1024"></span><span>
</span><span id="line-1025"></span><span class="hs-keyword">data</span><span> </span><span id="HowBound"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#HowBound"><span class="hs-identifier hs-var">HowBound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RecFun"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RecFun"><span class="hs-identifier hs-var">RecFun</span></a></span></span><span>  </span><span class="hs-comment">-- These are the recursive functions for which</span><span>
</span><span id="line-1026"></span><span>                        </span><span class="hs-comment">-- we seek interesting call patterns</span><span>
</span><span id="line-1027"></span><span>
</span><span id="line-1028"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span id="RecArg"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RecArg"><span class="hs-identifier hs-var">RecArg</span></a></span></span><span>  </span><span class="hs-comment">-- These are those functions' arguments, or their sub-components;</span><span>
</span><span id="line-1029"></span><span>                        </span><span class="hs-comment">-- we gather occurrence information for these</span><span>
</span><span id="line-1030"></span><span>
</span><span id="line-1031"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#HowBound"><span class="hs-identifier hs-type">HowBound</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1032"></span><span>  </span><span id="local-6989586621682941448"><span class="annot"><span class="annottext">ppr :: HowBound -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecFun"><span class="hs-identifier hs-var">RecFun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RecFun&quot;</span></span><span>
</span><span id="line-1033"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecArg"><span class="hs-identifier hs-var">RecArg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RecArg&quot;</span></span><span>
</span><span id="line-1034"></span><span>
</span><span id="line-1035"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scForce"><span class="hs-identifier hs-type">scForce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1036"></span><span id="scForce"><span class="annot"><span class="annottext">scForce :: ScEnv -&gt; Bool -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scForce"><span class="hs-identifier hs-var hs-var">scForce</span></a></span></span><span> </span><span id="local-6989586621682941450"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941450"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941451"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682941451"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941450"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_force"><span class="hs-identifier hs-var">sc_force</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941451"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1037"></span><span>
</span><span id="line-1038"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#lookupHowBound"><span class="hs-identifier hs-type">lookupHowBound</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#HowBound"><span class="hs-identifier hs-type">HowBound</span></a></span><span>
</span><span id="line-1039"></span><span id="lookupHowBound"><span class="annot"><span class="annottext">lookupHowBound :: ScEnv -&gt; Id -&gt; Maybe HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#lookupHowBound"><span class="hs-identifier hs-var hs-var">lookupHowBound</span></a></span></span><span> </span><span id="local-6989586621682941454"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941454"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941455"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941455"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HowBoundEnv -&gt; Id -&gt; Maybe HowBound
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; HowBoundEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_how_bound"><span class="hs-identifier hs-var">sc_how_bound</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941454"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941455"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-1040"></span><span>
</span><span id="line-1041"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scSubstId"><span class="hs-identifier hs-type">scSubstId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1042"></span><span id="scSubstId"><span class="annot"><span class="annottext">scSubstId :: ScEnv -&gt; Id -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#scSubstId"><span class="hs-identifier hs-var hs-var">scSubstId</span></a></span></span><span> </span><span id="local-6989586621682941460"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941460"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941461"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941461"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Id -&gt; Expr Id
Subst -&gt; Id -&gt; Expr Id
</span><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941460"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941461"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1043"></span><span>
</span><span id="line-1044"></span><span>
</span><span id="line-1045"></span><span class="hs-comment">-- Solo is only defined in base starting from ghc-9.2</span><span class="hs-cpp">
#if !(MIN_VERSION_base(4, 16, 0))
</span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Solo</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Solo</span><span> </span><span class="hs-identifier">a</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-1050"></span><span class="hs-comment">-- The Solo constructor was renamed to MkSolo in ghc 9.5</span><span class="hs-cpp">
#if __GLASGOW_HASKELL__ &lt; 905
</span><span class="hs-identifier">pattern</span><span> </span><span class="hs-identifier">MkSolo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Solo</span><span> </span><span class="hs-identifier">a</span><span>
</span><span id="line-1053"></span><span class="hs-identifier">pattern</span><span> </span><span class="hs-identifier">MkSolo</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Solo</span><span> </span><span class="hs-identifier">a</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-1056"></span><span class="hs-comment">-- The !subst ensures that we force the selection `(sc_subst env)`, which avoids</span><span>
</span><span id="line-1057"></span><span class="hs-comment">-- retaining all of `env` when we only need `subst`.  The `Solo` means that the</span><span>
</span><span id="line-1058"></span><span class="hs-comment">-- substitution itself is lazy, because that type is often discarded.</span><span>
</span><span id="line-1059"></span><span class="hs-comment">-- The callers of `scSubstTy` always force the result (to unpack the `Solo`)</span><span>
</span><span id="line-1060"></span><span class="hs-comment">-- so we get the desired effect: we leave a thunk, but retain only the subst,</span><span>
</span><span id="line-1061"></span><span class="hs-comment">-- not the whole env.</span><span>
</span><span id="line-1062"></span><span class="hs-comment">--</span><span>
</span><span id="line-1063"></span><span class="hs-comment">-- Fully forcing the result of `scSubstTy` regresses performance (#22102)</span><span>
</span><span id="line-1064"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scSubstTy"><span class="hs-identifier hs-type">scSubstTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InType"><span class="hs-identifier hs-type">InType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Solo</span></span><span> </span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span>
</span><span id="line-1065"></span><span id="scSubstTy"><span class="annot"><span class="annottext">scSubstTy :: ScEnv -&gt; InType -&gt; Solo InType
</span><a href="GHC.Core.Opt.SpecConstr.html#scSubstTy"><span class="hs-identifier hs-var hs-var">scSubstTy</span></a></span></span><span> </span><span id="local-6989586621682941465"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941465"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941466"><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941466"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1066"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682941467"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621682941467"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941465"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1067"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">InType -&gt; Solo InType
forall a. a -&gt; Solo a
</span><span class="hs-identifier hs-var">MkSolo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; InType -&gt; InType
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682941467"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941466"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1068"></span><span>
</span><span id="line-1069"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scSubstCo"><span class="hs-identifier hs-type">scSubstCo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1070"></span><span id="scSubstCo"><span class="annot"><span class="annottext">scSubstCo :: ScEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Opt.SpecConstr.html#scSubstCo"><span class="hs-identifier hs-var hs-var">scSubstCo</span></a></span></span><span> </span><span id="local-6989586621682941470"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941470"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941471"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682941471"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941470"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682941471"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1071"></span><span>
</span><span id="line-1072"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#zapScSubst"><span class="hs-identifier hs-type">zapScSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1073"></span><span id="zapScSubst"><span class="annot"><span class="annottext">zapScSubst :: ScEnv -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#zapScSubst"><span class="hs-identifier hs-var hs-var">zapScSubst</span></a></span></span><span> </span><span id="local-6989586621682941473"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941473"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941473"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#zapSubst"><span class="hs-identifier hs-type">zapSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941473"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1074"></span><span>
</span><span id="line-1075"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendScInScope"><span class="hs-identifier hs-type">extendScInScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1076"></span><span>        </span><span class="hs-comment">-- Bring the quantified variables into scope</span><span>
</span><span id="line-1077"></span><span id="extendScInScope"><span class="annot"><span class="annottext">extendScInScope :: ScEnv -&gt; [Id] -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendScInScope"><span class="hs-identifier hs-var hs-var">extendScInScope</span></a></span></span><span> </span><span id="local-6989586621682941477"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941477"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941478"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941478"><span class="hs-identifier hs-var">qvars</span></a></span></span><span>
</span><span id="line-1078"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941477"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendSubstInScopeList"><span class="hs-identifier hs-type">extendSubstInScopeList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941477"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941478"><span class="hs-identifier hs-type">qvars</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1079"></span><span>
</span><span id="line-1080"></span><span>        </span><span class="hs-comment">-- Extend the substitution</span><span>
</span><span id="line-1081"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendScSubst"><span class="hs-identifier hs-type">extendScSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1082"></span><span id="extendScSubst"><span class="annot"><span class="annottext">extendScSubst :: ScEnv -&gt; Id -&gt; Expr Id -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendScSubst"><span class="hs-identifier hs-var hs-var">extendScSubst</span></a></span></span><span> </span><span id="local-6989586621682941481"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941481"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941482"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941482"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621682941483"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941483"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941481"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier hs-type">extendSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941481"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941482"><span class="hs-identifier hs-type">var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941483"><span class="hs-identifier hs-type">expr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1083"></span><span>
</span><span id="line-1084"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendScSubstList"><span class="hs-identifier hs-type">extendScSubstList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1085"></span><span id="extendScSubstList"><span class="annot"><span class="annottext">extendScSubstList :: ScEnv -&gt; [(Id, Expr Id)] -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendScSubstList"><span class="hs-identifier hs-var hs-var">extendScSubstList</span></a></span></span><span> </span><span id="local-6989586621682941486"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941486"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941487"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621682941487"><span class="hs-identifier hs-var">prs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941486"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#extendSubstList"><span class="hs-identifier hs-type">extendSubstList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941486"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941487"><span class="hs-identifier hs-type">prs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1086"></span><span>
</span><span id="line-1087"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendHowBound"><span class="hs-identifier hs-type">extendHowBound</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#HowBound"><span class="hs-identifier hs-type">HowBound</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1088"></span><span id="extendHowBound"><span class="annot"><span class="annottext">extendHowBound :: ScEnv -&gt; [Id] -&gt; HowBound -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendHowBound"><span class="hs-identifier hs-var hs-var">extendHowBound</span></a></span></span><span> </span><span id="local-6989586621682941490"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941490"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941491"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941491"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621682941492"><span class="annot"><span class="annottext">HowBound
</span><a href="#local-6989586621682941492"><span class="hs-identifier hs-var">how_bound</span></a></span></span><span>
</span><span id="line-1089"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941490"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_how_bound"><span class="hs-identifier hs-var">sc_how_bound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnvList"><span class="hs-identifier hs-type">extendVarEnvList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_how_bound"><span class="hs-identifier hs-var">sc_how_bound</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941490"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1090"></span><span>                            </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941494"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682941492"><span class="hs-identifier hs-type">how_bound</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682941494"><span class="annot"><a href="#local-6989586621682941494"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682941491"><span class="hs-identifier hs-type">bndrs</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1091"></span><span>
</span><span id="line-1092"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendBndrsWith"><span class="hs-identifier hs-type">extendBndrsWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#HowBound"><span class="hs-identifier hs-type">HowBound</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1093"></span><span id="extendBndrsWith"><span class="annot"><span class="annottext">extendBndrsWith :: HowBound -&gt; ScEnv -&gt; [Id] -&gt; (ScEnv, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndrsWith"><span class="hs-identifier hs-var hs-var">extendBndrsWith</span></a></span></span><span> </span><span id="local-6989586621682941496"><span class="annot"><span class="annottext">HowBound
</span><a href="#local-6989586621682941496"><span class="hs-identifier hs-var">how_bound</span></a></span></span><span> </span><span id="local-6989586621682941497"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941497"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941498"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941498"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>
</span><span id="line-1094"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941497"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941499"><span class="hs-identifier hs-type">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_how_bound"><span class="hs-identifier hs-var">sc_how_bound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941500"><span class="hs-identifier hs-type">hb_env'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941501"><span class="hs-identifier hs-var">bndrs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1095"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1096"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682941499"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682941499"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941501"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941501"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; (Subst, [Id])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941497"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941498"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1097"></span><span>    </span><span id="local-6989586621682941500"><span class="annot"><span class="annottext">hb_env' :: HowBoundEnv
</span><a href="#local-6989586621682941500"><span class="hs-identifier hs-var hs-var">hb_env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; HowBoundEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_how_bound"><span class="hs-identifier hs-var">sc_how_bound</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941497"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">HowBoundEnv -&gt; [(Id, HowBound)] -&gt; HowBoundEnv
forall a. VarEnv a -&gt; [(Id, a)] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnvList"><span class="hs-operator hs-var">`extendVarEnvList`</span></a></span><span>
</span><span id="line-1098"></span><span>                    </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941503"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">HowBound
</span><a href="#local-6989586621682941496"><span class="hs-identifier hs-var">how_bound</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682941503"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941503"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941501"><span class="hs-identifier hs-var">bndrs'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1099"></span><span>
</span><span id="line-1100"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendBndrWith"><span class="hs-identifier hs-type">extendBndrWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#HowBound"><span class="hs-identifier hs-type">HowBound</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1101"></span><span id="extendBndrWith"><span class="annot"><span class="annottext">extendBndrWith :: HowBound -&gt; ScEnv -&gt; Id -&gt; (ScEnv, Id)
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndrWith"><span class="hs-identifier hs-var hs-var">extendBndrWith</span></a></span></span><span> </span><span id="local-6989586621682941505"><span class="annot"><span class="annottext">HowBound
</span><a href="#local-6989586621682941505"><span class="hs-identifier hs-var">how_bound</span></a></span></span><span> </span><span id="local-6989586621682941506"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941506"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941507"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941507"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-1102"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941506"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941508"><span class="hs-identifier hs-type">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_how_bound"><span class="hs-identifier hs-var">sc_how_bound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941509"><span class="hs-identifier hs-type">hb_env'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941510"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1103"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1104"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682941508"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682941508"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941510"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941510"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941506"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941507"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1105"></span><span>    </span><span id="local-6989586621682941509"><span class="annot"><span class="annottext">hb_env' :: HowBoundEnv
</span><a href="#local-6989586621682941509"><span class="hs-identifier hs-var hs-var">hb_env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HowBoundEnv -&gt; Id -&gt; HowBound -&gt; HowBoundEnv
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; HowBoundEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_how_bound"><span class="hs-identifier hs-var">sc_how_bound</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941506"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941510"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="#local-6989586621682941505"><span class="hs-identifier hs-var">how_bound</span></a></span><span>
</span><span id="line-1106"></span><span>
</span><span id="line-1107"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendRecBndrs"><span class="hs-identifier hs-type">extendRecBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1108"></span><span id="extendRecBndrs"><span class="annot"><span class="annottext">extendRecBndrs :: ScEnv -&gt; [Id] -&gt; (ScEnv, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#extendRecBndrs"><span class="hs-identifier hs-var hs-var">extendRecBndrs</span></a></span></span><span> </span><span id="local-6989586621682941514"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941514"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941515"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941515"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941514"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941516"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941517"><span class="hs-identifier hs-var">bndrs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1109"></span><span>                      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1110"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621682941516"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682941516"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941517"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941517"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; (Subst, [Id])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941514"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941515"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1111"></span><span>
</span><span id="line-1112"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendBndrs"><span class="hs-identifier hs-type">extendBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1113"></span><span id="extendBndrs"><span class="annot"><span class="annottext">extendBndrs :: ScEnv -&gt; [Id] -&gt; (ScEnv, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndrs"><span class="hs-identifier hs-var hs-var">extendBndrs</span></a></span></span><span> </span><span id="local-6989586621682941520"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941520"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941521"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941521"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScEnv -&gt; Id -&gt; (ScEnv, Id)) -&gt; ScEnv -&gt; [Id] -&gt; (ScEnv, [Id])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; (ScEnv, Id)
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndr"><span class="hs-identifier hs-var">extendBndr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941520"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941521"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1114"></span><span>
</span><span id="line-1115"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendBndr"><span class="hs-identifier hs-type">extendBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1116"></span><span id="extendBndr"><span class="annot"><span class="annottext">extendBndr :: ScEnv -&gt; Id -&gt; (ScEnv, Id)
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndr"><span class="hs-identifier hs-var hs-var">extendBndr</span></a></span></span><span> </span><span id="local-6989586621682941523"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941523"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941524"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941524"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941523"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941525"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941526"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1117"></span><span>                     </span><span class="hs-keyword">where</span><span>
</span><span id="line-1118"></span><span>                       </span><span class="hs-special">(</span><span id="local-6989586621682941525"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682941525"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941526"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941526"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941523"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941524"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1119"></span><span>
</span><span id="line-1120"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendValEnv"><span class="hs-identifier hs-type">extendValEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1121"></span><span id="extendValEnv"><span class="annot"><span class="annottext">extendValEnv :: ScEnv -&gt; Id -&gt; Maybe Value -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendValEnv"><span class="hs-identifier hs-var hs-var">extendValEnv</span></a></span></span><span> </span><span id="local-6989586621682941528"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941528"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941529"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941529"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621682941530"><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621682941530"><span class="hs-identifier hs-var">mb_val</span></a></span></span><span>
</span><span id="line-1122"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621682941530"><span class="hs-identifier hs-var">mb_val</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1123"></span><span>      </span><span class="annot"><span class="annottext">Maybe Value
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941528"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1124"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682941531"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621682941531"><span class="hs-identifier hs-var">cv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941528"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_vals"><span class="hs-identifier hs-var">sc_vals</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-type">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_vals"><span class="hs-identifier hs-var">sc_vals</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941528"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941529"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941531"><span class="hs-identifier hs-type">cv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1125"></span><span>
</span><span id="line-1126"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendCaseBndrs"><span class="hs-identifier hs-type">extendCaseBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1127"></span><span class="hs-comment">-- When we encounter</span><span>
</span><span id="line-1128"></span><span class="hs-comment">--      case scrut of b</span><span>
</span><span id="line-1129"></span><span class="hs-comment">--          C x y -&gt; ...</span><span>
</span><span id="line-1130"></span><span class="hs-comment">-- we want to bind b, to (C x y)</span><span>
</span><span id="line-1131"></span><span class="hs-comment">-- NB1: Extends only the sc_vals part of the envt</span><span>
</span><span id="line-1132"></span><span class="hs-comment">-- NB2: Kill the dead-ness info on the pattern binders x,y, since</span><span>
</span><span id="line-1133"></span><span class="hs-comment">--      they are potentially made alive by the [b -&gt; C x y] binding</span><span>
</span><span id="line-1134"></span><span id="extendCaseBndrs"><span class="annot"><span class="annottext">extendCaseBndrs :: ScEnv -&gt; Expr Id -&gt; Id -&gt; AltCon -&gt; [Id] -&gt; (ScEnv, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#extendCaseBndrs"><span class="hs-identifier hs-var hs-var">extendCaseBndrs</span></a></span></span><span> </span><span id="local-6989586621682941533"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941533"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941534"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941534"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682941535"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941535"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621682941536"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941536"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682941537"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941537"><span class="hs-identifier hs-var">alt_bndrs</span></a></span></span><span>
</span><span id="line-1135"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941538"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941539"><span class="hs-identifier hs-var">alt_bndrs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1136"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1137"></span><span>   </span><span id="local-6989586621682941540"><span class="annot"><span class="annottext">live_case_bndr :: Bool
</span><a href="#local-6989586621682941540"><span class="hs-identifier hs-var hs-var">live_case_bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941535"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1138"></span><span>   </span><span id="local-6989586621682941542"><span class="annot"><span class="annottext">env1 :: ScEnv
</span><a href="#local-6989586621682941542"><span class="hs-identifier hs-var hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#DoBinderSwap"><span class="hs-identifier hs-type">DoBinderSwap</span></a></span><span> </span><span id="local-6989586621682941544"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941544"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621682941545"><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682941545"><span class="hs-identifier hs-var">mco</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; BinderSwapDecision
</span><a href="GHC.Core.Opt.OccurAnal.html#scrutOkForBinderSwap"><span class="hs-identifier hs-var">scrutOkForBinderSwap</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941534"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-1139"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflMCo"><span class="hs-identifier hs-var">isReflMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="#local-6989586621682941545"><span class="hs-identifier hs-var">mco</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; Maybe Value -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendValEnv"><span class="hs-identifier hs-var">extendValEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941533"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941544"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621682941547"><span class="hs-identifier hs-var">cval</span></a></span><span>
</span><span id="line-1140"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941533"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">-- See Note [Add scrutinee to ValueEnv too]</span><span>
</span><span id="line-1141"></span><span>   </span><span id="local-6989586621682941538"><span class="annot"><span class="annottext">env2 :: ScEnv
</span><a href="#local-6989586621682941538"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682941540"><span class="hs-identifier hs-var">live_case_bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; Maybe Value -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendValEnv"><span class="hs-identifier hs-var">extendValEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941542"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941535"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621682941547"><span class="hs-identifier hs-var">cval</span></a></span><span>
</span><span id="line-1142"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941542"><span class="hs-identifier hs-var">env1</span></a></span><span>
</span><span id="line-1143"></span><span>
</span><span id="line-1144"></span><span>   </span><span id="local-6989586621682941539"><span class="annot"><span class="annottext">alt_bndrs' :: [Id]
</span><a href="#local-6989586621682941539"><span class="hs-identifier hs-var hs-var">alt_bndrs'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941534"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682941540"><span class="hs-identifier hs-var">live_case_bndr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1145"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="#local-6989586621682941549"><span class="hs-identifier hs-var">zap</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941537"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span>
</span><span id="line-1146"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1147"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941537"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span>
</span><span id="line-1148"></span><span>
</span><span id="line-1149"></span><span>   </span><span id="local-6989586621682941547"><span class="annot"><span class="annottext">cval :: Maybe Value
</span><a href="#local-6989586621682941547"><span class="hs-identifier hs-var hs-var">cval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941536"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1150"></span><span>                </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1151"></span><span>                </span><span class="annot"><a href="GHC.Core.html#LitAlt"><span class="hs-identifier hs-type">LitAlt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; AltCon -&gt; [Expr Id] -&gt; Value
</span><a href="GHC.Core.Opt.SpecConstr.html#ConVal"><span class="hs-identifier hs-var">ConVal</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941536"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1152"></span><span>                </span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; AltCon -&gt; [Expr Id] -&gt; Value
</span><a href="GHC.Core.Opt.SpecConstr.html#ConVal"><span class="hs-identifier hs-var">ConVal</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941536"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941553"><span class="hs-identifier hs-var">vanilla_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1153"></span><span>                      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1154"></span><span>                        </span><span id="local-6989586621682941553"><span class="annot"><span class="annottext">vanilla_args :: [Expr Id]
</span><a href="#local-6989586621682941553"><span class="hs-identifier hs-var hs-var">vanilla_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InType -&gt; Expr Id) -&gt; [InType] -&gt; [Expr Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">InType -&gt; Expr Id
forall b. InType -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InType -&gt; [InType]
InType -&gt; [InType]
</span><a href="GHC.Core.Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; InType
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941535"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; [Expr Id] -&gt; [Expr Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-1155"></span><span>                                       </span><span class="annot"><span class="annottext">[Id] -&gt; [Expr Id]
forall b. [Id] -&gt; [Expr b]
</span><a href="GHC.Core.html#varsToCoreExprs"><span class="hs-identifier hs-var">varsToCoreExprs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941537"><span class="hs-identifier hs-var">alt_bndrs</span></a></span><span>
</span><span id="line-1156"></span><span>
</span><span id="line-1157"></span><span>   </span><span id="local-6989586621682941549"><span class="annot"><span class="annottext">zap :: Id -&gt; Id
</span><a href="#local-6989586621682941549"><span class="hs-identifier hs-var hs-var">zap</span></a></span></span><span> </span><span id="local-6989586621682941558"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941558"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941558"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941558"><span class="hs-identifier hs-var">v</span></a></span><span>                </span><span class="hs-comment">-- See NB2 above</span><span>
</span><span id="line-1158"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Types.Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941558"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1159"></span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#decreaseSpecCount"><span class="hs-identifier hs-type">decreaseSpecCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1162"></span><span class="hs-comment">-- See Note [Avoiding exponential blowup]</span><span>
</span><span id="line-1163"></span><span id="decreaseSpecCount"><span class="annot"><span class="annottext">decreaseSpecCount :: ScEnv -&gt; Int -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#decreaseSpecCount"><span class="hs-identifier hs-var hs-var">decreaseSpecCount</span></a></span></span><span> </span><span id="local-6989586621682941562"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941562"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941563"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682941563"><span class="hs-identifier hs-var">_n_specs</span></a></span></span><span>
</span><span id="line-1164"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941562"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_force"><span class="hs-identifier hs-var">sc_force</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>   </span><span class="hs-comment">-- See Note [Forcing specialisation]</span><span>
</span><span id="line-1165"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682941564"><span class="hs-identifier hs-type">opts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_count"><span class="hs-identifier hs-var">sc_count</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_count"><span class="hs-identifier hs-var">sc_count</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941564"><span class="hs-identifier hs-type">opts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1166"></span><span>                             </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1167"></span><span>                             </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682941565"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682941565"><span class="hs-identifier hs-var">n</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall {a}. Integral a =&gt; a -&gt; a
</span><a href="#local-6989586621682941567"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682941565"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1168"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-1169"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1170"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1171"></span><span>    </span><span id="local-6989586621682941564"><span class="annot"><span class="annottext">opts :: SpecConstrOpts
</span><a href="#local-6989586621682941564"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941562"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1172"></span><span>    </span><span id="local-6989586621682941567"><span class="annot"><span class="annottext">dec :: a -&gt; a
</span><a href="#local-6989586621682941567"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621682941586"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682941586"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682941586"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">2</span></span><span>  </span><span class="hs-comment">-- See Note [Avoiding exponential blowup]</span><span>
</span><span id="line-1173"></span><span>
</span><span id="line-1174"></span><span>    </span><span class="hs-comment">-- Or:   n `div` (n_specs + 1)</span><span>
</span><span id="line-1175"></span><span>    </span><span class="hs-comment">-- See the historical note part of Note [Avoiding exponential blowup]</span><span>
</span><span id="line-1176"></span><span>    </span><span class="hs-comment">-- The &quot;+1&quot; takes account of the original function;</span><span>
</span><span id="line-1177"></span><span>
</span><span id="line-1178"></span><span class="hs-comment">---------------------------------------------------</span><span>
</span><span id="line-1179"></span><span class="hs-comment">-- See Note [Forcing specialisation]</span><span>
</span><span id="line-1180"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ignoreType"><span class="hs-identifier hs-type">ignoreType</span></a></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1181"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ignoreDataCon"><span class="hs-identifier hs-type">ignoreDataCon</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1182"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#forceSpecBndr"><span class="hs-identifier hs-type">forceSpecBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1183"></span><span>
</span><span id="line-1184"></span><span id="ignoreDataCon"><span class="annot"><span class="annottext">ignoreDataCon :: ScEnv -&gt; DataCon -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#ignoreDataCon"><span class="hs-identifier hs-var hs-var">ignoreDataCon</span></a></span></span><span> </span><span id="local-6989586621682941592"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941592"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941593"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682941593"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; TyCon -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#ignoreTyCon"><span class="hs-identifier hs-var">ignoreTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941592"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; TyCon
</span><a href="GHC.Core.DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682941593"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1185"></span><span>
</span><span id="line-1186"></span><span id="ignoreType"><span class="annot"><span class="annottext">ignoreType :: ScEnv -&gt; InType -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#ignoreType"><span class="hs-identifier hs-var hs-var">ignoreType</span></a></span></span><span> </span><span id="local-6989586621682941596"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941596"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941597"><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941597"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1187"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InType -&gt; Maybe TyCon
</span><a href="GHC.Core.Type.html#tyConAppTyCon_maybe"><span class="hs-identifier hs-var">tyConAppTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941597"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1188"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682941599"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682941599"><span class="hs-identifier hs-var">tycon</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; TyCon -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#ignoreTyCon"><span class="hs-identifier hs-var">ignoreTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941596"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682941599"><span class="hs-identifier hs-var">tycon</span></a></span><span>
</span><span id="line-1189"></span><span>      </span><span class="annot"><span class="annottext">Maybe TyCon
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1190"></span><span>
</span><span id="line-1191"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ignoreTyCon"><span class="hs-identifier hs-type">ignoreTyCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1192"></span><span id="ignoreTyCon"><span class="annot"><span class="annottext">ignoreTyCon :: ScEnv -&gt; TyCon -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#ignoreTyCon"><span class="hs-identifier hs-var hs-var">ignoreTyCon</span></a></span></span><span> </span><span id="local-6989586621682941600"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941600"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941601"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682941601"><span class="hs-identifier hs-var">tycon</span></a></span></span><span>
</span><span id="line-1193"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqFM Name SpecConstrAnnotation
-&gt; Name -&gt; Maybe SpecConstrAnnotation
forall key elt. Uniquable key =&gt; UniqFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.FM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; UniqFM Name SpecConstrAnnotation
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_annotations"><span class="hs-identifier hs-var">sc_annotations</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941600"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
</span><a href="GHC.Core.TyCon.html#tyConName"><span class="hs-identifier hs-var">tyConName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682941601"><span class="hs-identifier hs-var">tycon</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe SpecConstrAnnotation -&gt; Maybe SpecConstrAnnotation -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SpecConstrAnnotation -&gt; Maybe SpecConstrAnnotation
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SpecConstrAnnotation
</span><span class="hs-identifier hs-var">NoSpecConstr</span></span><span>
</span><span id="line-1194"></span><span>
</span><span id="line-1195"></span><span id="forceSpecBndr"><span class="annot"><span class="annottext">forceSpecBndr :: ScEnv -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#forceSpecBndr"><span class="hs-identifier hs-var hs-var">forceSpecBndr</span></a></span></span><span> </span><span id="local-6989586621682941604"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941604"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941605"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941605"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; InType -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#forceSpecFunTy"><span class="hs-identifier hs-var">forceSpecFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941604"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(InType -&gt; Bool) -&gt; (Id -&gt; InType) -&gt; Id -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([Id], InType) -&gt; InType
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(([Id], InType) -&gt; InType)
-&gt; (Id -&gt; ([Id], InType)) -&gt; Id -&gt; InType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InType -&gt; ([Id], InType)
</span><a href="GHC.Core.Type.html#splitForAllTyCoVars"><span class="hs-identifier hs-var">splitForAllTyCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">(InType -&gt; ([Id], InType))
-&gt; (Id -&gt; InType) -&gt; Id -&gt; ([Id], InType)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; InType
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; Id -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941605"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-1196"></span><span>
</span><span id="line-1197"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#forceSpecFunTy"><span class="hs-identifier hs-type">forceSpecFunTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1198"></span><span id="forceSpecFunTy"><span class="annot"><span class="annottext">forceSpecFunTy :: ScEnv -&gt; InType -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#forceSpecFunTy"><span class="hs-identifier hs-var hs-var">forceSpecFunTy</span></a></span></span><span> </span><span id="local-6989586621682941611"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941611"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InType -&gt; Bool) -&gt; [InType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; InType -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#forceSpecArgTy"><span class="hs-identifier hs-var">forceSpecArgTy</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941611"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([InType] -&gt; Bool) -&gt; (InType -&gt; [InType]) -&gt; InType -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Scaled InType -&gt; InType) -&gt; [Scaled InType] -&gt; [InType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Scaled InType -&gt; InType
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span> </span><span class="annot"><span class="annottext">([Scaled InType] -&gt; [InType])
-&gt; (InType -&gt; [Scaled InType]) -&gt; InType -&gt; [InType]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([Scaled InType], InType) -&gt; [Scaled InType]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(([Scaled InType], InType) -&gt; [Scaled InType])
-&gt; (InType -&gt; ([Scaled InType], InType))
-&gt; InType
-&gt; [Scaled InType]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InType -&gt; ([Scaled InType], InType)
</span><a href="GHC.Core.Type.html#splitFunTys"><span class="hs-identifier hs-var">splitFunTys</span></a></span><span>
</span><span id="line-1199"></span><span>
</span><span id="line-1200"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#forceSpecArgTy"><span class="hs-identifier hs-type">forceSpecArgTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1201"></span><span id="forceSpecArgTy"><span class="annot"><span class="annottext">forceSpecArgTy :: ScEnv -&gt; InType -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#forceSpecArgTy"><span class="hs-identifier hs-var hs-var">forceSpecArgTy</span></a></span></span><span> </span><span id="local-6989586621682941617"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941617"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941618"><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941618"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1202"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InType -&gt; Bool
</span><a href="GHC.Core.Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941618"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1203"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1204"></span><span>
</span><span id="line-1205"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941620"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682941620"><span class="hs-identifier hs-var">tycon</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941621"><span class="annot"><span class="annottext">[InType]
</span><a href="#local-6989586621682941621"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; InType -&gt; Maybe (TyCon, [InType])
InType -&gt; Maybe (TyCon, [InType])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941618"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1206"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682941620"><span class="hs-identifier hs-var">tycon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#specTyConKey"><span class="hs-identifier hs-var">specTyConKey</span></a></span><span>
</span><span id="line-1207"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">UniqFM Name SpecConstrAnnotation
-&gt; Name -&gt; Maybe SpecConstrAnnotation
forall key elt. Uniquable key =&gt; UniqFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.FM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; UniqFM Name SpecConstrAnnotation
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_annotations"><span class="hs-identifier hs-var">sc_annotations</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941617"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Name
</span><a href="GHC.Core.TyCon.html#tyConName"><span class="hs-identifier hs-var">tyConName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682941620"><span class="hs-identifier hs-var">tycon</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe SpecConstrAnnotation -&gt; Maybe SpecConstrAnnotation -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SpecConstrAnnotation -&gt; Maybe SpecConstrAnnotation
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SpecConstrAnnotation
</span><span class="hs-identifier hs-var">ForceSpecConstr</span></span><span>
</span><span id="line-1208"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">(InType -&gt; Bool) -&gt; [InType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; InType -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#forceSpecArgTy"><span class="hs-identifier hs-var">forceSpecArgTy</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941617"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[InType]
</span><a href="#local-6989586621682941621"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1209"></span><span>
</span><span id="line-1210"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#forceSpecArgTy"><span class="hs-identifier hs-var">forceSpecArgTy</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">InType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1211"></span><span>
</span><span id="line-1212"></span><span class="hs-comment">{-
Note [Add scrutinee to ValueEnv too]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this:
   case x of y
     (a,b) -&gt; case b of c
                I# v -&gt; ...(f y)...
By the time we get to the call (f y), the ValueEnv
will have a binding for y, and for c
    y -&gt; (a,b)
    c -&gt; I# v
BUT that's not enough!  Looking at the call (f y) we
see that y is pair (a,b), but we also need to know what 'b' is.
So in extendCaseBndrs we must *also* add the binding
   b -&gt; I# v
else we lose a useful specialisation for f.  This is necessary even
though the simplifier has systematically replaced uses of 'x' with 'y'
and 'b' with 'c' in the code.  The use of 'b' in the ValueEnv came
from outside the case.  See #4908 for the live example.

It's very like the binder-swap story, so we use scrutOkForBinderSwap
to identify suitable scrutinees -- but only if there is no cast
(isReflMCo) because that's all that the ValueEnv allows.

Note [Avoiding exponential blowup]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The sc_count field of the ScEnv says how many times we are prepared to
duplicate a single function.  But we must take care with recursive
specialisations.  Consider

        let $j1 = let $j2 = let $j3 = ...
                            in
                            ...$j3...
                  in
                  ...$j2...
        in
        ...$j1...

If we specialise $j1 then in each specialisation (as well as the original)
we can specialise $j2, and similarly $j3.  Even if we make just *one*
specialisation of each, because we also have the original we'll get 2^n
copies of $j3, which is not good.

So when recursively specialising we divide the sc_count (the maximum
number of specialisations, in the ScEnv) by two.  You might think that
gives us n*(n/2)*(n/4)... copies of the innnermost thing, which is
still exponential the depth.  But we use integer division, rounding
down, so if the starting sc_count is 3, we'll get 3 -&gt; 1 -&gt; 0, and
stop.  In fact, simply subtracting 1 would be good enough, for the same
reason.

Historical note: in the past we divided by (n_specs+1), where n_specs
is the number of specialisations at this level; but that gets us down
to zero jolly quickly, which I found led to some regressions.  (An
example is nofib/spectral/fibheaps, the getMin' function inside the
outer function $sfibToList, which has several interesting call
patterns.)

************************************************************************
*                                                                      *
\subsection{Usage information: flows upwards}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1276"></span><span>
</span><span id="line-1277"></span><span class="hs-keyword">data</span><span> </span><span id="ScUsage"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-var">ScUsage</span></a></span></span><span>
</span><span id="line-1278"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="SCU"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCU"><span class="hs-identifier hs-var">SCU</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1279"></span><span>        </span><span id="scu_calls"><span class="annot"><span class="annottext">ScUsage -&gt; CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var hs-var">scu_calls</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallEnv"><span class="hs-identifier hs-type">CallEnv</span></a></span><span class="hs-special">,</span><span>           </span><span class="hs-comment">-- Calls</span><span>
</span><span id="line-1280"></span><span>                                        </span><span class="hs-comment">-- The functions are a subset of the</span><span>
</span><span id="line-1281"></span><span>                                        </span><span class="hs-comment">--      RecFuns in the ScEnv</span><span>
</span><span id="line-1282"></span><span>
</span><span id="line-1283"></span><span>        </span><span id="scu_occs"><span class="annot"><span class="annottext">ScUsage -&gt; IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var hs-var">scu_occs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Information on argument occurrences</span><span>
</span><span id="line-1284"></span><span>     </span><span class="hs-special">}</span><span>                                  </span><span class="hs-comment">-- The domain is OutIds</span><span>
</span><span id="line-1285"></span><span>
</span><span id="line-1286"></span><span class="hs-keyword">type</span><span> </span><span id="CallEnv"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallEnv"><span class="hs-identifier hs-var">CallEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Domain is OutIds</span><span>
</span><span id="line-1287"></span><span class="hs-keyword">data</span><span> </span><span id="Call"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Call"><span class="hs-identifier hs-var">Call</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="Call"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Call"><span class="hs-identifier hs-var">Call</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ValueEnv"><span class="hs-identifier hs-type">ValueEnv</span></a></span><span>
</span><span id="line-1288"></span><span>        </span><span class="hs-comment">-- The arguments of the call, together with the</span><span>
</span><span id="line-1289"></span><span>        </span><span class="hs-comment">-- env giving the constructor bindings at the call site</span><span>
</span><span id="line-1290"></span><span>        </span><span class="hs-comment">-- We keep the function mainly for debug output</span><span>
</span><span id="line-1291"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1292"></span><span>        </span><span class="hs-comment">-- The call is not necessarily saturated; we just put</span><span>
</span><span id="line-1293"></span><span>        </span><span class="hs-comment">-- in however many args are visible at the call site</span><span>
</span><span id="line-1294"></span><span>
</span><span id="line-1295"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1296"></span><span>  </span><span id="local-6989586621682941645"><span class="annot"><span class="annottext">ppr :: ScUsage -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCU"><span class="hs-identifier hs-type">SCU</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scu_calls :: ScUsage -&gt; CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682941646"><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682941646"><span class="hs-identifier hs-var">calls</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">scu_occs :: ScUsage -&gt; IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682941647"><span class="annot"><span class="annottext">IdEnv ArgOcc
</span><a href="#local-6989586621682941647"><span class="hs-identifier hs-var">occs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1297"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SCU&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;calls =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CallEnv -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682941646"><span class="hs-identifier hs-var">calls</span></a></span><span>
</span><span id="line-1298"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;occs =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArgOcc -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArgOcc
</span><a href="#local-6989586621682941647"><span class="hs-identifier hs-var">occs</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1299"></span><span>
</span><span id="line-1300"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1301"></span><span>  </span><span id="local-6989586621682941654"><span class="annot"><span class="annottext">ppr :: Call -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span id="local-6989586621682941655"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941655"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682941656"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941656"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941655"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#fsep"><span class="hs-identifier hs-var">fsep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr Id -&gt; SDoc) -&gt; [Expr Id] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; SDoc
forall b. OutputableBndr b =&gt; Expr b -&gt; SDoc
</span><a href="GHC.Core.Ppr.html#pprParendExpr"><span class="hs-identifier hs-var">pprParendExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941656"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1302"></span><span>
</span><span id="line-1303"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-type">nullUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span>
</span><span id="line-1304"></span><span id="nullUsage"><span class="annot"><span class="annottext">nullUsage :: ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var hs-var">nullUsage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCU"><span class="hs-identifier hs-type">SCU</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scu_calls :: CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallEnv
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">scu_occs :: IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdEnv ArgOcc
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1305"></span><span>
</span><span id="line-1306"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineCalls"><span class="hs-identifier hs-type">combineCalls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallEnv"><span class="hs-identifier hs-type">CallEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallEnv"><span class="hs-identifier hs-type">CallEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallEnv"><span class="hs-identifier hs-type">CallEnv</span></a></span><span>
</span><span id="line-1307"></span><span id="combineCalls"><span class="annot"><span class="annottext">combineCalls :: CallEnv -&gt; CallEnv -&gt; CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#combineCalls"><span class="hs-identifier hs-var hs-var">combineCalls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Call] -&gt; [Call] -&gt; [Call]) -&gt; CallEnv -&gt; CallEnv -&gt; CallEnv
forall a. (a -&gt; a -&gt; a) -&gt; VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv_C"><span class="hs-identifier hs-var">plusVarEnv_C</span></a></span><span> </span><span class="annot"><span class="annottext">[Call] -&gt; [Call] -&gt; [Call]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span>
</span><span id="line-1308"></span><span>
</span><span id="line-1309"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#delCallsFor"><span class="hs-identifier hs-type">delCallsFor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span>
</span><span id="line-1310"></span><span id="delCallsFor"><span class="annot"><span class="annottext">delCallsFor :: ScUsage -&gt; [Id] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#delCallsFor"><span class="hs-identifier hs-var hs-var">delCallsFor</span></a></span></span><span> </span><span id="local-6989586621682941661"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941661"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941662"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941662"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941661"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941661"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-operator hs-type">`delVarEnvList`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941662"><span class="hs-identifier hs-type">bndrs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1311"></span><span>
</span><span id="line-1312"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-identifier hs-type">combineUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span>
</span><span id="line-1313"></span><span id="combineUsage"><span class="annot"><span class="annottext">combineUsage :: ScUsage -&gt; ScUsage -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-identifier hs-var hs-var">combineUsage</span></a></span></span><span> </span><span id="local-6989586621682941665"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941665"><span class="hs-identifier hs-var">u1</span></a></span></span><span> </span><span id="local-6989586621682941666"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941666"><span class="hs-identifier hs-var">u2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCU"><span class="hs-identifier hs-type">SCU</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scu_calls :: CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallEnv -&gt; CallEnv -&gt; CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#combineCalls"><span class="hs-identifier hs-var">combineCalls</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage -&gt; CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941665"><span class="hs-identifier hs-var">u1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage -&gt; CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941666"><span class="hs-identifier hs-var">u2</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1314"></span><span>                           </span><span class="annot"><span class="annottext">scu_occs :: IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ArgOcc -&gt; ArgOcc -&gt; ArgOcc)
-&gt; IdEnv ArgOcc -&gt; IdEnv ArgOcc -&gt; IdEnv ArgOcc
forall a. (a -&gt; a -&gt; a) -&gt; VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv_C"><span class="hs-identifier hs-var">plusVarEnv_C</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc -&gt; ArgOcc -&gt; ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-var">combineOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage -&gt; IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941665"><span class="hs-identifier hs-var">u1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage -&gt; IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941666"><span class="hs-identifier hs-var">u2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1315"></span><span>
</span><span id="line-1316"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineUsages"><span class="hs-identifier hs-type">combineUsages</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span>
</span><span id="line-1317"></span><span id="combineUsages"><span class="annot"><span class="annottext">combineUsages :: [ScUsage] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsages"><span class="hs-identifier hs-var hs-var">combineUsages</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var">nullUsage</span></a></span><span>
</span><span id="line-1318"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineUsages"><span class="hs-identifier hs-var">combineUsages</span></a></span><span> </span><span id="local-6989586621682941669"><span class="annot"><span class="annottext">[ScUsage]
</span><a href="#local-6989586621682941669"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScUsage -&gt; ScUsage -&gt; ScUsage) -&gt; [ScUsage] -&gt; ScUsage
forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldr1</span></span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; ScUsage -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-identifier hs-var">combineUsage</span></a></span><span> </span><span class="annot"><span class="annottext">[ScUsage]
</span><a href="#local-6989586621682941669"><span class="hs-identifier hs-var">us</span></a></span><span>
</span><span id="line-1319"></span><span>
</span><span id="line-1320"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#lookupOccs"><span class="hs-identifier hs-type">lookupOccs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1321"></span><span id="lookupOccs"><span class="annot"><span class="annottext">lookupOccs :: ScUsage -&gt; [Id] -&gt; (ScUsage, [ArgOcc])
</span><a href="GHC.Core.Opt.SpecConstr.html#lookupOccs"><span class="hs-identifier hs-var hs-var">lookupOccs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCU"><span class="hs-identifier hs-type">SCU</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scu_calls :: ScUsage -&gt; CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682941673"><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682941673"><span class="hs-identifier hs-var">sc_calls</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">scu_occs :: ScUsage -&gt; IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682941674"><span class="annot"><span class="annottext">IdEnv ArgOcc
</span><a href="#local-6989586621682941674"><span class="hs-identifier hs-var">sc_occs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682941675"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941675"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>
</span><span id="line-1322"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCU"><span class="hs-identifier hs-type">SCU</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">scu_calls :: CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682941673"><span class="hs-identifier hs-var">sc_calls</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">scu_occs :: IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdEnv ArgOcc -&gt; [Id] -&gt; IdEnv ArgOcc
forall a. VarEnv a -&gt; [Id] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArgOcc
</span><a href="#local-6989586621682941674"><span class="hs-identifier hs-var">sc_occs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941675"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-1323"></span><span>     </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IdEnv ArgOcc -&gt; Id -&gt; Maybe ArgOcc
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArgOcc
</span><a href="#local-6989586621682941674"><span class="hs-identifier hs-var">sc_occs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941676"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ArgOcc -&gt; ArgOcc -&gt; ArgOcc
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#NoOcc"><span class="hs-identifier hs-var">NoOcc</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682941676"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941676"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941675"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1324"></span><span>
</span><span id="line-1325"></span><span class="hs-keyword">data</span><span> </span><span id="ArgOcc"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-var">ArgOcc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NoOcc"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#NoOcc"><span class="hs-identifier hs-var">NoOcc</span></a></span></span><span>     </span><span class="hs-comment">-- Doesn't occur at all; or a type argument</span><span>
</span><span id="line-1326"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span id="UnkOcc"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span></span><span>    </span><span class="hs-comment">-- Used in some unknown way</span><span>
</span><span id="line-1327"></span><span>
</span><span id="line-1328"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span id="ScrutOcc"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-var">ScrutOcc</span></a></span></span><span>  </span><span class="hs-comment">-- See Note [ScrutOcc]</span><span>
</span><span id="line-1329"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.DataCon.html#DataConEnv"><span class="hs-identifier hs-type">DataConEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1330"></span><span>                     </span><span class="hs-comment">-- [ArgOcc]: how the sub-components are used</span><span>
</span><span id="line-1331"></span><span>
</span><span id="line-1332"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#deadArgOcc"><span class="hs-identifier hs-type">deadArgOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1333"></span><span id="deadArgOcc"><span class="annot"><span class="annottext">deadArgOcc :: ArgOcc -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#deadArgOcc"><span class="hs-identifier hs-var hs-var">deadArgOcc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-type">ScrutOcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1334"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#deadArgOcc"><span class="hs-identifier hs-var">deadArgOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1335"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#deadArgOcc"><span class="hs-identifier hs-var">deadArgOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#NoOcc"><span class="hs-identifier hs-var">NoOcc</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1336"></span><span>
</span><span id="line-1337"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specialisableArgOcc"><span class="hs-identifier hs-type">specialisableArgOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1338"></span><span class="annot"><span class="hs-comment">-- | Does this occurrence represent one worth specializing for.</span></span><span>
</span><span id="line-1339"></span><span id="specialisableArgOcc"><span class="annot"><span class="annottext">specialisableArgOcc :: ArgOcc -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#specialisableArgOcc"><span class="hs-identifier hs-var hs-var">specialisableArgOcc</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1340"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specialisableArgOcc"><span class="hs-identifier hs-var">specialisableArgOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#NoOcc"><span class="hs-identifier hs-var">NoOcc</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1341"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specialisableArgOcc"><span class="hs-identifier hs-var">specialisableArgOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-type">ScrutOcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1342"></span><span>
</span><span id="line-1343"></span><span>
</span><span id="line-1344"></span><span class="hs-comment">{- Note [ScrutOcc]
~~~~~~~~~~~~~~~~~~
An occurrence of ScrutOcc indicates that the thing, or a `cast` version of the thing,
is *only* taken apart or applied.

  Functions, literal: ScrutOcc emptyUFM
  Data constructors:  ScrutOcc subs,

where (subs :: UniqFM [ArgOcc]) gives usage of the *pattern-bound* components,
The domain of the UniqFM is the Unique of the data constructor

The [ArgOcc] is the occurrences of the *pattern-bound* components
of the data structure.  E.g.
        data T a = forall b. MkT a b (b-&gt;a)
A pattern binds b, x::a, y::b, z::b-&gt;a, but not 'a'!

-}</span><span>
</span><span id="line-1361"></span><span>
</span><span id="line-1362"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1363"></span><span>  </span><span id="local-6989586621682941690"><span class="annot"><span class="annottext">ppr :: ArgOcc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-type">ScrutOcc</span></a></span><span> </span><span id="local-6989586621682941691"><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941691"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scrut-occ&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941691"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1364"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unk-occ&quot;</span></span><span>
</span><span id="line-1365"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#NoOcc"><span class="hs-identifier hs-var">NoOcc</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no-occ&quot;</span></span><span>
</span><span id="line-1366"></span><span>
</span><span id="line-1367"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#evalScrutOcc"><span class="hs-identifier hs-type">evalScrutOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span>
</span><span id="line-1368"></span><span class="hs-comment">-- We use evalScrutOcc for</span><span>
</span><span id="line-1369"></span><span class="hs-comment">--   - mkVarUsage: applied functions</span><span>
</span><span id="line-1370"></span><span class="hs-comment">--   - scApp: dicts that are the argument of a classop</span><span>
</span><span id="line-1371"></span><span id="evalScrutOcc"><span class="annot"><span class="annottext">evalScrutOcc :: ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#evalScrutOcc"><span class="hs-identifier hs-var hs-var">evalScrutOcc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc] -&gt; ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-var">ScrutOcc</span></a></span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
forall {k} (key :: k) elt. UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#emptyUFM"><span class="hs-identifier hs-var">emptyUFM</span></a></span><span>
</span><span id="line-1372"></span><span>
</span><span id="line-1373"></span><span class="hs-comment">-- Experimentally, this version of combineOcc makes ScrutOcc &quot;win&quot;, so</span><span>
</span><span id="line-1374"></span><span class="hs-comment">-- that if the thing is scrutinised anywhere then we get to see that</span><span>
</span><span id="line-1375"></span><span class="hs-comment">-- in the overall result, even if it's also used in a boxed way</span><span>
</span><span id="line-1376"></span><span class="hs-comment">-- This might be too aggressive; see Note [Reboxing] Alternative 3</span><span>
</span><span id="line-1377"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-type">combineOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span>
</span><span id="line-1378"></span><span id="combineOcc"><span class="annot"><span class="annottext">combineOcc :: ArgOcc -&gt; ArgOcc -&gt; ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-var hs-var">combineOcc</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#NoOcc"><span class="hs-identifier hs-var">NoOcc</span></a></span><span>         </span><span id="local-6989586621682941694"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941694"><span class="hs-identifier hs-var">occ</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941694"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-1379"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-var">combineOcc</span></a></span><span> </span><span id="local-6989586621682941695"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941695"><span class="hs-identifier hs-var">occ</span></a></span></span><span>           </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#NoOcc"><span class="hs-identifier hs-var">NoOcc</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941695"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-1380"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-var">combineOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-type">ScrutOcc</span></a></span><span> </span><span id="local-6989586621682941696"><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941696"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-type">ScrutOcc</span></a></span><span> </span><span id="local-6989586621682941697"><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941697"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc] -&gt; ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-var">ScrutOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([ArgOcc] -&gt; [ArgOcc] -&gt; [ArgOcc])
-&gt; DataConEnv [ArgOcc]
-&gt; DataConEnv [ArgOcc]
-&gt; DataConEnv [ArgOcc]
forall {k} elt (key :: k).
(elt -&gt; elt -&gt; elt)
-&gt; UniqFM key elt -&gt; UniqFM key elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#plusUFM_C"><span class="hs-identifier hs-var">plusUFM_C</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc] -&gt; [ArgOcc] -&gt; [ArgOcc]
</span><a href="GHC.Core.Opt.SpecConstr.html#combineOccs"><span class="hs-identifier hs-var">combineOccs</span></a></span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941696"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941697"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1381"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-var">combineOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-type">ScrutOcc</span></a></span><span> </span><span id="local-6989586621682941700"><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941700"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc] -&gt; ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-var">ScrutOcc</span></a></span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941700"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-1382"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-var">combineOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-type">ScrutOcc</span></a></span><span> </span><span id="local-6989586621682941701"><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941701"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc] -&gt; ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-var">ScrutOcc</span></a></span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682941701"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1383"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-var">combineOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>        </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>
</span><span id="line-1384"></span><span>
</span><span id="line-1385"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineOccs"><span class="hs-identifier hs-type">combineOccs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1386"></span><span id="combineOccs"><span class="annot"><span class="annottext">combineOccs :: [ArgOcc] -&gt; [ArgOcc] -&gt; [ArgOcc]
</span><a href="GHC.Core.Opt.SpecConstr.html#combineOccs"><span class="hs-identifier hs-var hs-var">combineOccs</span></a></span></span><span> </span><span id="local-6989586621682941702"><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682941702"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621682941703"><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682941703"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; (ArgOcc -&gt; ArgOcc -&gt; ArgOcc) -&gt; [ArgOcc] -&gt; [ArgOcc] -&gt; [ArgOcc]
forall a b c.
HasDebugCallStack =&gt;
String -&gt; (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="GHC.Utils.Misc.html#zipWithEqual"><span class="hs-identifier hs-var">zipWithEqual</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;combineOccs&quot;</span></span><span> </span><span class="annot"><span class="annottext">ArgOcc -&gt; ArgOcc -&gt; ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-var">combineOcc</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682941702"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682941703"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-1387"></span><span>
</span><span id="line-1388"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#setScrutOcc"><span class="hs-identifier hs-type">setScrutOcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span>
</span><span id="line-1389"></span><span class="hs-comment">-- _Overwrite_ the occurrence info for the scrutinee, if the scrutinee</span><span>
</span><span id="line-1390"></span><span class="hs-comment">-- is a variable, and an interesting variable</span><span>
</span><span id="line-1391"></span><span id="setScrutOcc"><span class="annot"><span class="annottext">setScrutOcc :: ScEnv -&gt; ScUsage -&gt; Expr Id -&gt; ArgOcc -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#setScrutOcc"><span class="hs-identifier hs-var hs-var">setScrutOcc</span></a></span></span><span> </span><span id="local-6989586621682941706"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941706"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941707"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941707"><span class="hs-identifier hs-var">usg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682941709"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941709"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682941710"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941710"><span class="hs-identifier hs-var">occ</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; ScUsage -&gt; Expr Id -&gt; ArgOcc -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#setScrutOcc"><span class="hs-identifier hs-var">setScrutOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941706"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941707"><span class="hs-identifier hs-var">usg</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941709"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941710"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-1392"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#setScrutOcc"><span class="hs-identifier hs-var">setScrutOcc</span></a></span><span> </span><span id="local-6989586621682941711"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941711"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941712"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941712"><span class="hs-identifier hs-var">usg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682941714"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941714"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682941715"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941715"><span class="hs-identifier hs-var">occ</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; ScUsage -&gt; Expr Id -&gt; ArgOcc -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#setScrutOcc"><span class="hs-identifier hs-var">setScrutOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941711"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941712"><span class="hs-identifier hs-var">usg</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941714"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941715"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-1393"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#setScrutOcc"><span class="hs-identifier hs-var">setScrutOcc</span></a></span><span> </span><span id="local-6989586621682941716"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941716"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941717"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941717"><span class="hs-identifier hs-var">usg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682941718"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941718"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>    </span><span id="local-6989586621682941719"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941719"><span class="hs-identifier hs-var">occ</span></a></span></span><span>
</span><span id="line-1394"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecArg"><span class="hs-identifier hs-var">RecArg</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; Maybe HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#lookupHowBound"><span class="hs-identifier hs-var">lookupHowBound</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941716"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941718"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941717"><span class="hs-identifier hs-var">usg</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-type">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941717"><span class="hs-identifier hs-type">usg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941718"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941719"><span class="hs-identifier hs-type">occ</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1395"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941717"><span class="hs-identifier hs-var">usg</span></a></span><span>
</span><span id="line-1396"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#setScrutOcc"><span class="hs-identifier hs-var">setScrutOcc</span></a></span><span> </span><span id="local-6989586621682941720"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941720"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621682941721"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941721"><span class="hs-identifier hs-var">usg</span></a></span></span><span> </span><span id="local-6989586621682941722"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941722"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span id="local-6989586621682941723"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941723"><span class="hs-identifier hs-var">_occ</span></a></span></span><span>        </span><span class="hs-comment">-- Catch-all</span><span>
</span><span id="line-1397"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941721"><span class="hs-identifier hs-var">usg</span></a></span><span>
</span><span id="line-1398"></span><span>
</span><span id="line-1399"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The main recursive function}
*                                                                      *
************************************************************************

The main recursive function gathers up usage information, and
creates specialised versions of functions.
-}</span><span>
</span><span id="line-1409"></span><span>
</span><span id="line-1410"></span><span id="local-6989586621682940798"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scBind"><span class="hs-identifier hs-type">scBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InBind"><span class="hs-identifier hs-type">InBind</span></a></span><span>
</span><span id="line-1411"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682940798"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier hs-type">SpecFailWarning</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Specialise the scope of the binding</span><span>
</span><span id="line-1412"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBind"><span class="hs-identifier hs-type">OutBind</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682940798"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier hs-type">SpecFailWarning</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-1413"></span><span id="scBind"><span class="annot"><span class="annottext">scBind :: forall a.
TopLevelFlag
-&gt; ScEnv
-&gt; OutBind
-&gt; (ScEnv -&gt; UniqSM (ScUsage, a, [SpecFailWarning]))
-&gt; UniqSM (ScUsage, [OutBind], a, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scBind"><span class="hs-identifier hs-var hs-var">scBind</span></a></span></span><span> </span><span id="local-6989586621682941750"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682941750"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682941751"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941751"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682941753"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941753"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682941754"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941754"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682941755"><span class="annot"><span class="annottext">ScEnv -&gt; UniqSM (ScUsage, a, [SpecFailWarning])
</span><a href="#local-6989586621682941755"><span class="hs-identifier hs-var">do_body</span></a></span></span><span>
</span><span id="line-1414"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941753"><span class="hs-identifier hs-var">bndr</span></a></span><span>         </span><span class="hs-comment">-- Type-lets may be created by doBeta</span><span>
</span><span id="line-1415"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941756"><span class="annot"><a href="#local-6989586621682941756"><span class="hs-identifier hs-var">final_usage</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941757"><span class="annot"><a href="#local-6989586621682941757"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941758"><span class="annot"><a href="#local-6989586621682941758"><span class="hs-identifier hs-var">warnings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; UniqSM (ScUsage, a, [SpecFailWarning])
</span><a href="#local-6989586621682941755"><span class="hs-identifier hs-var">do_body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; Expr Id -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendScSubst"><span class="hs-identifier hs-var">extendScSubst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941751"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941753"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941754"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1416"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941756"><span class="hs-identifier hs-type">final_usage</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941757"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941758"><span class="hs-identifier hs-type">warnings</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1417"></span><span>
</span><span id="line-1418"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682941750"><span class="hs-identifier hs-var">top_lvl</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Nested non-recursive value binding</span><span>
</span><span id="line-1419"></span><span>    </span><span class="hs-comment">-- See Note [Specialising local let bindings]</span><span>
</span><span id="line-1420"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941760"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941760"><span class="hs-identifier hs-var hs-var">body_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941761"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941761"><span class="hs-identifier hs-var hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; (ScEnv, Id)
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndr"><span class="hs-identifier hs-var">extendBndr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941751"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941753"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1421"></span><span>              </span><span class="hs-comment">-- Not necessary at top level; but here we are nested</span><span>
</span><span id="line-1422"></span><span>
</span><span id="line-1423"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941762"><span class="annot"><a href="#local-6989586621682941762"><span class="hs-identifier hs-var">rhs_info</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941763"><span class="annot"><a href="#local-6989586621682941763"><span class="hs-identifier hs-var">rhs_ws</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; (Id, Expr Id) -&gt; UniqSM (RhsInfo, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scRecRhs"><span class="hs-identifier hs-var">scRecRhs</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941751"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941761"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941754"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1424"></span><span>
</span><span id="line-1425"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682941765"><span class="annot"><a href="#local-6989586621682941765"><span class="hs-identifier hs-var hs-var">body_env2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; [Id] -&gt; HowBound -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendHowBound"><span class="hs-identifier hs-var">extendHowBound</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941760"><span class="hs-identifier hs-var">body_env</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941761"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecFun"><span class="hs-identifier hs-var">RecFun</span></a></span><span>
</span><span id="line-1426"></span><span>              </span><span id="local-6989586621682941766"><span class="annot"><a href="#local-6989586621682941766"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RhsInfo -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_new_rhs"><span class="hs-identifier hs-var">ri_new_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">RhsInfo
</span><a href="#local-6989586621682941762"><span class="hs-identifier hs-var">rhs_info</span></a></span><span>
</span><span id="line-1427"></span><span>              </span><span id="local-6989586621682941768"><span class="annot"><a href="#local-6989586621682941768"><span class="hs-identifier hs-var hs-var">body_env3</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; Maybe Value -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendValEnv"><span class="hs-identifier hs-var">extendValEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941765"><span class="hs-identifier hs-var">body_env2</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941761"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueEnv -&gt; Expr Id -&gt; Maybe Value
</span><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; ValueEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_vals"><span class="hs-identifier hs-var">sc_vals</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941751"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941766"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1428"></span><span>
</span><span id="line-1429"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941770"><span class="annot"><a href="#local-6989586621682941770"><span class="hs-identifier hs-var">body_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941771"><span class="annot"><a href="#local-6989586621682941771"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941772"><span class="annot"><a href="#local-6989586621682941772"><span class="hs-identifier hs-var">warnings_body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682941755"><span class="hs-identifier hs-type">do_body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941768"><span class="hs-identifier hs-type">body_env3</span></a></span><span>
</span><span id="line-1430"></span><span>
</span><span id="line-1431"></span><span>          </span><span class="hs-comment">-- Now make specialised copies of the binding,</span><span>
</span><span id="line-1432"></span><span>          </span><span class="hs-comment">-- based on calls in body_usg</span><span>
</span><span id="line-1433"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941773"><span class="annot"><a href="#local-6989586621682941773"><span class="hs-identifier hs-var">spec_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941774"><span class="annot"><a href="#local-6989586621682941774"><span class="hs-identifier hs-var">specs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941775"><span class="annot"><a href="#local-6989586621682941775"><span class="hs-identifier hs-var">warnings_bnd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specNonRec"><span class="hs-identifier hs-type">specNonRec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941751"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941770"><span class="hs-identifier hs-type">body_usg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941762"><span class="hs-identifier hs-type">rhs_info</span></a></span><span>
</span><span id="line-1434"></span><span>          </span><span class="hs-comment">-- NB: For non-recursive bindings we inherit sc_force flag from</span><span>
</span><span id="line-1435"></span><span>          </span><span class="hs-comment">-- the parent function (see Note [Forcing specialisation])</span><span>
</span><span id="line-1436"></span><span>
</span><span id="line-1437"></span><span>        </span><span class="hs-comment">-- Specialized + original binding</span><span>
</span><span id="line-1438"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682941777"><span class="annot"><a href="#local-6989586621682941777"><span class="hs-identifier hs-var hs-var">spec_bnds</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; Expr Id -&gt; OutBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941778"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941779"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941778"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941778"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682941779"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941779"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RhsInfo -&gt; SpecInfo -&gt; [(Id, Expr Id)]
</span><a href="GHC.Core.Opt.SpecConstr.html#ruleInfoBinds"><span class="hs-identifier hs-var">ruleInfoBinds</span></a></span><span> </span><span class="annot"><span class="annottext">RhsInfo
</span><a href="#local-6989586621682941762"><span class="hs-identifier hs-var">rhs_info</span></a></span><span> </span><span class="annot"><span class="annottext">SpecInfo
</span><a href="#local-6989586621682941774"><span class="hs-identifier hs-var">specs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1439"></span><span>              </span><span id="local-6989586621682941781"><span class="annot"><a href="#local-6989586621682941781"><span class="hs-identifier hs-var hs-var">bind_usage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941770"><span class="hs-identifier hs-var">body_usg</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; [Id] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#delCallsFor"><span class="hs-operator hs-var">`delCallsFor`</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941761"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1440"></span><span>                           </span><span class="annot"><span class="annottext">ScUsage -&gt; ScUsage -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-operator hs-var">`combineUsage`</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941773"><span class="hs-identifier hs-var">spec_usg</span></a></span><span> </span><span class="hs-comment">-- Note [spec_usg includes rhs_usg]</span><span>
</span><span id="line-1441"></span><span>
</span><span id="line-1442"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941781"><span class="hs-identifier hs-type">bind_usage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941777"><span class="hs-identifier hs-type">spec_bnds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941771"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mconcat</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682941775"><span class="hs-identifier hs-type">warnings_bnd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941772"><span class="hs-identifier hs-type">warnings_body</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941763"><span class="hs-identifier hs-type">rhs_ws</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1443"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1444"></span><span>
</span><span id="line-1445"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- Top-level, non-recursive value binding</span><span>
</span><span id="line-1446"></span><span>    </span><span class="hs-comment">-- At top level we do not specialise non-recursive bindings; that</span><span>
</span><span id="line-1447"></span><span>    </span><span class="hs-comment">-- is, we do not call specNonRec, passing the calls from the body.</span><span>
</span><span id="line-1448"></span><span>    </span><span class="hs-comment">-- The original paper only specialised /recursive/ bindings, but</span><span>
</span><span id="line-1449"></span><span>    </span><span class="hs-comment">-- we later started specialising nested non-recursive bindings:</span><span>
</span><span id="line-1450"></span><span>    </span><span class="hs-comment">-- see Note [Specialising local let bindings]</span><span>
</span><span id="line-1451"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1452"></span><span>    </span><span class="hs-comment">-- I tried always specialising non-recursive top-level bindings too,</span><span>
</span><span id="line-1453"></span><span>    </span><span class="hs-comment">-- but found some regressions (see !8135).  So I backed off.</span><span>
</span><span id="line-1454"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941782"><span class="annot"><a href="#local-6989586621682941782"><span class="hs-identifier hs-var">rhs_usage</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941783"><span class="annot"><a href="#local-6989586621682941783"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941784"><span class="annot"><a href="#local-6989586621682941784"><span class="hs-identifier hs-var">ws_rhs</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941751"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941754"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1455"></span><span>
</span><span id="line-1456"></span><span>       </span><span class="hs-comment">-- At top level, we've already put all binders into scope; see initScEnv</span><span>
</span><span id="line-1457"></span><span>       </span><span class="hs-comment">-- Hence no need to call `extendBndr`. But we still want to</span><span>
</span><span id="line-1458"></span><span>       </span><span class="hs-comment">-- extend the `ValueEnv` to record the value of this binder.</span><span>
</span><span id="line-1459"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682941786"><span class="annot"><a href="#local-6989586621682941786"><span class="hs-identifier hs-var hs-var">body_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; Maybe Value -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendValEnv"><span class="hs-identifier hs-var">extendValEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941751"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941753"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueEnv -&gt; Expr Id -&gt; Maybe Value
</span><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; ValueEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_vals"><span class="hs-identifier hs-var">sc_vals</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941751"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941783"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1460"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941787"><span class="annot"><a href="#local-6989586621682941787"><span class="hs-identifier hs-var">body_usage</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941788"><span class="annot"><a href="#local-6989586621682941788"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941789"><span class="annot"><a href="#local-6989586621682941789"><span class="hs-identifier hs-var">body_warnings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682941755"><span class="hs-identifier hs-type">do_body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941786"><span class="hs-identifier hs-type">body_env</span></a></span><span>
</span><span id="line-1461"></span><span>
</span><span id="line-1462"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941782"><span class="hs-identifier hs-type">rhs_usage</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-operator hs-type">`combineUsage`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941787"><span class="hs-identifier hs-type">body_usage</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941753"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941783"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941788"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941789"><span class="hs-identifier hs-type">body_warnings</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682941784"><span class="hs-identifier hs-type">ws_rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1463"></span><span>
</span><span id="line-1464"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scBind"><span class="hs-identifier hs-var">scBind</span></a></span><span> </span><span id="local-6989586621682941790"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682941790"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621682941791"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941791"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682941793"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621682941793"><span class="hs-identifier hs-var">prs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682941794"><span class="annot"><span class="annottext">ScEnv -&gt; UniqSM (ScUsage, a, [SpecFailWarning])
</span><a href="#local-6989586621682941794"><span class="hs-identifier hs-var">do_body</span></a></span></span><span>
</span><span id="line-1465"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682941790"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-1466"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682941795"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682941795"><span class="hs-identifier hs-var">threshold</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Maybe Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_size"><span class="hs-identifier hs-var">sc_size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941791"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1467"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682941796"><span class="hs-identifier hs-var">force_spec</span></a></span><span> </span><span class="hs-comment">-- See Note [Forcing specialisation], point (FS1)</span><span>
</span><span id="line-1468"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr Id -&gt; Bool) -&gt; [Expr Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Int -&gt; Expr Id -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Inline.html#couldBeSmallEnoughToInline"><span class="hs-identifier hs-var">couldBeSmallEnoughToInline</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_uf_opts"><span class="hs-identifier hs-var">sc_uf_opts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941791"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682941795"><span class="hs-identifier hs-var">threshold</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941799"><span class="hs-identifier hs-var">rhss</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1469"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Do no specialisation if the RHSs are too big</span><span>
</span><span id="line-1470"></span><span>    </span><span class="hs-comment">-- ToDo: I'm honestly not sure of the rationale of this size-testing, nor</span><span>
</span><span id="line-1471"></span><span>    </span><span class="hs-comment">--       why it only applies at top level. But that's the way it has been</span><span>
</span><span id="line-1472"></span><span>    </span><span class="hs-comment">--       for a while. See #21456.</span><span>
</span><span id="line-1473"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941800"><span class="annot"><a href="#local-6989586621682941800"><span class="hs-identifier hs-var">body_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941801"><span class="annot"><a href="#local-6989586621682941801"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941802"><span class="annot"><a href="#local-6989586621682941802"><span class="hs-identifier hs-var">warnings_body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; UniqSM (ScUsage, a, [SpecFailWarning])
</span><a href="#local-6989586621682941794"><span class="hs-identifier hs-var">do_body</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941803"><span class="hs-identifier hs-var">rhs_env2</span></a></span><span>
</span><span id="line-1474"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941804"><span class="annot"><a href="#local-6989586621682941804"><span class="hs-identifier hs-var">rhs_usgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941805"><span class="annot"><a href="#local-6989586621682941805"><span class="hs-identifier hs-var">rhss'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941806"><span class="annot"><a href="#local-6989586621682941806"><span class="hs-identifier hs-var">rhs_ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapAndUnzip3M"><span class="hs-identifier hs-type">mapAndUnzip3M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-type">scExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941791"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941799"><span class="hs-identifier hs-type">rhss</span></a></span><span>
</span><span id="line-1475"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682941808"><span class="annot"><a href="#local-6989586621682941808"><span class="hs-identifier hs-var hs-var">all_usg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ScUsage] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsages"><span class="hs-identifier hs-var">combineUsages</span></a></span><span> </span><span class="annot"><span class="annottext">[ScUsage]
</span><a href="#local-6989586621682941804"><span class="hs-identifier hs-var">rhs_usgs</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; ScUsage -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-operator hs-var">`combineUsage`</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941800"><span class="hs-identifier hs-var">body_usg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1476"></span><span>                        </span><span class="annot"><span class="annottext">ScUsage -&gt; [Id] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#delCallsFor"><span class="hs-operator hs-var">`delCallsFor`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941809"><span class="hs-identifier hs-var">bndrs'</span></a></span><span>
</span><span id="line-1477"></span><span>              </span><span id="local-6989586621682941810"><span class="annot"><a href="#local-6989586621682941810"><span class="hs-identifier hs-var hs-var">bind'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)] -&gt; OutBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941809"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Expr Id] -&gt; [(Id, Expr Id)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941805"><span class="hs-identifier hs-var">rhss'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1478"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941808"><span class="hs-identifier hs-type">all_usg</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682941810"><span class="hs-identifier hs-type">bind'</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941801"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941802"><span class="hs-identifier hs-type">warnings_body</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">concat</span></span><span> </span><span class="annot"><a href="#local-6989586621682941806"><span class="hs-identifier hs-type">rhs_ws</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1479"></span><span>
</span><span id="line-1480"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1481"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941812"><span class="annot"><a href="#local-6989586621682941812"><span class="hs-identifier hs-var">rhs_infos</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941813"><span class="annot"><a href="#local-6989586621682941813"><span class="hs-identifier hs-var">rhs_wss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Id, Expr Id) -&gt; UniqSM (RhsInfo, [SpecFailWarning]))
-&gt; [(Id, Expr Id)] -&gt; UniqSM ([RhsInfo], [[SpecFailWarning]])
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; (Id, Expr Id) -&gt; UniqSM (RhsInfo, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scRecRhs"><span class="hs-identifier hs-var">scRecRhs</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941803"><span class="hs-identifier hs-var">rhs_env2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941809"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Expr Id] -&gt; [(Id, Expr Id)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941799"><span class="hs-identifier hs-var">rhss</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1482"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682941815"><span class="annot"><a href="#local-6989586621682941815"><span class="hs-identifier hs-var hs-var">rhs_ws</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[SpecFailWarning]] -&gt; [SpecFailWarning]
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[[SpecFailWarning]]
</span><a href="#local-6989586621682941813"><span class="hs-identifier hs-var">rhs_wss</span></a></span><span>
</span><span id="line-1483"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941816"><span class="annot"><a href="#local-6989586621682941816"><span class="hs-identifier hs-var">body_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941817"><span class="annot"><a href="#local-6989586621682941817"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941818"><span class="annot"><a href="#local-6989586621682941818"><span class="hs-identifier hs-var">warnings_body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621682941794"><span class="hs-identifier hs-type">do_body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941803"><span class="hs-identifier hs-type">rhs_env2</span></a></span><span>
</span><span id="line-1484"></span><span>
</span><span id="line-1485"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941819"><span class="annot"><a href="#local-6989586621682941819"><span class="hs-identifier hs-var">spec_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941820"><span class="annot"><a href="#local-6989586621682941820"><span class="hs-identifier hs-var">specs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941821"><span class="annot"><a href="#local-6989586621682941821"><span class="hs-identifier hs-var">spec_ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specRec"><span class="hs-identifier hs-type">specRec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scForce"><span class="hs-identifier hs-type">scForce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941803"><span class="hs-identifier hs-type">rhs_env2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941796"><span class="hs-identifier hs-type">force_spec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1486"></span><span>                                          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941816"><span class="hs-identifier hs-type">body_usg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941812"><span class="hs-identifier hs-type">rhs_infos</span></a></span><span>
</span><span id="line-1487"></span><span>                </span><span class="hs-comment">-- Do not unconditionally generate specialisations from rhs_usgs</span><span>
</span><span id="line-1488"></span><span>                </span><span class="hs-comment">-- Instead use them only if we find an unspecialised call</span><span>
</span><span id="line-1489"></span><span>                </span><span class="hs-comment">-- See Note [Seeding recursive groups]</span><span>
</span><span id="line-1490"></span><span>
</span><span id="line-1491"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682941823"><span class="annot"><a href="#local-6989586621682941823"><span class="hs-identifier hs-var hs-var">all_usg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941819"><span class="hs-identifier hs-var">spec_usg</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; ScUsage -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-operator hs-var">`combineUsage`</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941816"><span class="hs-identifier hs-var">body_usg</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Note [spec_usg includes rhs_usg]</span><span>
</span><span id="line-1492"></span><span>                        </span><span class="annot"><span class="annottext">ScUsage -&gt; [Id] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#delCallsFor"><span class="hs-operator hs-var">`delCallsFor`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941809"><span class="hs-identifier hs-var">bndrs'</span></a></span><span>
</span><span id="line-1493"></span><span>              </span><span id="local-6989586621682941824"><span class="annot"><a href="#local-6989586621682941824"><span class="hs-identifier hs-var hs-var">bind'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)] -&gt; OutBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[(Id, Expr Id)]] -&gt; [(Id, Expr Id)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
-&gt; (RhsInfo -&gt; SpecInfo -&gt; [(Id, Expr Id)])
-&gt; [RhsInfo]
-&gt; [SpecInfo]
-&gt; [[(Id, Expr Id)]]
forall a b c.
HasDebugCallStack =&gt;
String -&gt; (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="GHC.Utils.Misc.html#zipWithEqual"><span class="hs-identifier hs-var">zipWithEqual</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scExpr'&quot;</span></span><span> </span><span class="annot"><span class="annottext">RhsInfo -&gt; SpecInfo -&gt; [(Id, Expr Id)]
</span><a href="GHC.Core.Opt.SpecConstr.html#ruleInfoBinds"><span class="hs-identifier hs-var">ruleInfoBinds</span></a></span><span> </span><span class="annot"><span class="annottext">[RhsInfo]
</span><a href="#local-6989586621682941812"><span class="hs-identifier hs-var">rhs_infos</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecInfo]
</span><a href="#local-6989586621682941820"><span class="hs-identifier hs-var">specs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1494"></span><span>                        </span><span class="hs-comment">-- zipWithEqual: length of returned [SpecInfo]</span><span>
</span><span id="line-1495"></span><span>                        </span><span class="hs-comment">-- should be the same as incoming [RhsInfo]</span><span>
</span><span id="line-1496"></span><span>
</span><span id="line-1497"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941823"><span class="hs-identifier hs-type">all_usg</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682941824"><span class="hs-identifier hs-type">bind'</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941817"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">mconcat</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682941818"><span class="hs-identifier hs-type">warnings_body</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682941815"><span class="hs-identifier hs-type">rhs_ws</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682941821"><span class="hs-identifier hs-type">spec_ws</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1498"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1499"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682941825"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941825"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682941799"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941799"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)] -&gt; ([Id], [Expr Id])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621682941793"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-1500"></span><span>    </span><span id="local-6989586621682941796"><span class="annot"><span class="annottext">force_spec :: Bool
</span><a href="#local-6989586621682941796"><span class="hs-identifier hs-var hs-var">force_spec</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#forceSpecBndr"><span class="hs-identifier hs-var">forceSpecBndr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941791"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941825"><span class="hs-identifier hs-var">bndrs</span></a></span><span>    </span><span class="hs-comment">-- Note [Forcing specialisation]</span><span>
</span><span id="line-1501"></span><span>
</span><span id="line-1502"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682941827"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941827"><span class="hs-identifier hs-var">rhs_env1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682941809"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941809"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621682941790"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941791"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941825"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1503"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; [Id] -&gt; (ScEnv, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#extendRecBndrs"><span class="hs-identifier hs-var">extendRecBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941791"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941825"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1504"></span><span>       </span><span class="hs-comment">-- At top level, we've already put all binders into scope; see initScEnv</span><span>
</span><span id="line-1505"></span><span>
</span><span id="line-1506"></span><span>    </span><span id="local-6989586621682941803"><span class="annot"><span class="annottext">rhs_env2 :: ScEnv
</span><a href="#local-6989586621682941803"><span class="hs-identifier hs-var hs-var">rhs_env2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; [Id] -&gt; HowBound -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendHowBound"><span class="hs-identifier hs-var">extendHowBound</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941827"><span class="hs-identifier hs-var">rhs_env1</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941809"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecFun"><span class="hs-identifier hs-var">RecFun</span></a></span><span>
</span><span id="line-1507"></span><span>
</span><span id="line-1508"></span><span class="hs-comment">{- Note [Specialising local let bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It is not uncommon to find this

   let $j = \x. &lt;blah&gt; in ...$j True...$j True...

Here $j is an arbitrary let-bound function, but it often comes up for
join points.  We might like to specialise $j for its call patterns.
Notice the difference from a letrec, where we look for call patterns
in the *RHS* of the function.  Here we look for call patterns in the
*body* of the let.

At one point I predicated this on the RHS mentioning the outer
recursive function, but that's not essential and might even be
harmful.  I'm not sure.
-}</span><span>
</span><span id="line-1524"></span><span>
</span><span id="line-1525"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#withWarnings"><span class="hs-identifier hs-type">withWarnings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1526"></span><span id="withWarnings"><span class="annot"><span class="annottext">withWarnings :: [SpecFailWarning]
-&gt; (ScUsage, Expr Id, [SpecFailWarning])
-&gt; (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#withWarnings"><span class="hs-identifier hs-var hs-var">withWarnings</span></a></span></span><span> </span><span id="local-6989586621682941830"><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941830"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941831"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941831"><span class="hs-identifier hs-var">use</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682941832"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941832"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682941833"><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941833"><span class="hs-identifier hs-var">ws2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941831"><span class="hs-identifier hs-var">use</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941832"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941830"><span class="hs-identifier hs-var">ws</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning] -&gt; [SpecFailWarning] -&gt; [SpecFailWarning]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941833"><span class="hs-identifier hs-var">ws2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1527"></span><span>
</span><span id="line-1528"></span><span class="hs-comment">------------------------</span><span>
</span><span id="line-1529"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-type">scExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-type">scExpr'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1530"></span><span>        </span><span class="hs-comment">-- The unique supply is needed when we invent</span><span>
</span><span id="line-1531"></span><span>        </span><span class="hs-comment">-- a new name for the specialised function and its args</span><span>
</span><span id="line-1532"></span><span>
</span><span id="line-1533"></span><span id="scExpr"><span class="annot"><span class="annottext">scExpr :: ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var hs-var">scExpr</span></a></span></span><span> </span><span id="local-6989586621682941835"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941835"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941836"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941836"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941835"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941836"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1534"></span><span>
</span><span id="line-1535"></span><span id="scExpr%27"><span class="annot"><span class="annottext">scExpr' :: ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var hs-var">scExpr'</span></a></span></span><span> </span><span id="local-6989586621682941837"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941837"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682941838"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941838"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#scSubstId"><span class="hs-identifier hs-var">scSubstId</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941837"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941838"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1536"></span><span>                            </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682941839"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941839"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ScUsage, Expr Id, [SpecFailWarning])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; [Expr Id] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#mkVarUsage"><span class="hs-identifier hs-var">mkVarUsage</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941837"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941839"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Expr Id
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941839"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1537"></span><span>                            </span><span id="local-6989586621682941841"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941841"><span class="hs-identifier hs-var">e'</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#zapScSubst"><span class="hs-identifier hs-var">zapScSubst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941837"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941841"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-1538"></span><span>
</span><span id="line-1539"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span id="local-6989586621682941842"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941842"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621682941843"><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941843"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span>
</span><span id="line-1540"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MkSolo</span></span><span> </span><span id="local-6989586621682941844"><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941844"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; InType -&gt; Solo InType
</span><a href="GHC.Core.Opt.SpecConstr.html#scSubstTy"><span class="hs-identifier hs-var">scSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941842"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941843"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1541"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(ScUsage, Expr Id, [SpecFailWarning])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var">nullUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InType -&gt; Expr Id
forall b. InType -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941844"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1542"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span id="local-6989586621682941845"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941845"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621682941847"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682941847"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScUsage, Expr Id, [SpecFailWarning])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var">nullUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Expr Id
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Opt.SpecConstr.html#scSubstCo"><span class="hs-identifier hs-var">scSubstCo</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941845"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682941847"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1543"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span id="local-6989586621682941848"><span class="annot"><span class="annottext">e :: Expr Id
</span><a href="#local-6989586621682941848"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScUsage, Expr Id, [SpecFailWarning])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var">nullUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941848"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1544"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span id="local-6989586621682941850"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941850"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682941851"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682941851"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682941852"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941852"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941853"><span class="annot"><a href="#local-6989586621682941853"><span class="hs-identifier hs-var">usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941854"><span class="annot"><a href="#local-6989586621682941854"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941855"><span class="annot"><a href="#local-6989586621682941855"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941850"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941852"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1545"></span><span>                              </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941853"><span class="hs-identifier hs-type">usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scTickish"><span class="hs-identifier hs-type">scTickish</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941850"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941851"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941854"><span class="hs-identifier hs-type">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941855"><span class="hs-identifier hs-type">ws</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1546"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span id="local-6989586621682941857"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941857"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682941858"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941858"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621682941859"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682941859"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941860"><span class="annot"><a href="#local-6989586621682941860"><span class="hs-identifier hs-var">usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941861"><span class="annot"><a href="#local-6989586621682941861"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941862"><span class="annot"><a href="#local-6989586621682941862"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941857"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941858"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1547"></span><span>                              </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941860"><span class="hs-identifier hs-type">usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-type">mkCast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941861"><span class="hs-identifier hs-type">e'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scSubstCo"><span class="hs-identifier hs-type">scSubstCo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941857"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941859"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941862"><span class="hs-identifier hs-type">ws</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1548"></span><span>                              </span><span class="hs-comment">-- Important to use mkCast here</span><span>
</span><span id="line-1549"></span><span>                              </span><span class="hs-comment">-- See Note [SpecConstr call patterns]</span><span>
</span><span id="line-1550"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span id="local-6989586621682941864"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941864"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941865"><span class="annot"><span class="annottext">e :: Expr Id
</span><a href="#local-6989586621682941865"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
-&gt; (Expr Id, [Expr Id])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scApp"><span class="hs-identifier hs-var">scApp</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941864"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Id -&gt; (Expr Id, [Expr Id])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941865"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1551"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span id="local-6989586621682941869"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941869"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682941871"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941871"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682941872"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941872"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941873"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941873"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941874"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941874"><span class="hs-identifier hs-var hs-var">b'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; (ScEnv, Id)
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndr"><span class="hs-identifier hs-var">extendBndr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941869"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941871"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1552"></span><span>                              </span><span class="hs-special">(</span><span id="local-6989586621682941875"><span class="annot"><a href="#local-6989586621682941875"><span class="hs-identifier hs-var">usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941876"><span class="annot"><a href="#local-6989586621682941876"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941877"><span class="annot"><a href="#local-6989586621682941877"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941873"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941872"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1553"></span><span>                              </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941875"><span class="hs-identifier hs-type">usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941874"><span class="hs-identifier hs-type">b'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941876"><span class="hs-identifier hs-type">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941877"><span class="hs-identifier hs-type">ws</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1554"></span><span>
</span><span id="line-1555"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span id="local-6989586621682941878"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941878"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621682941880"><span class="annot"><span class="annottext">OutBind
</span><a href="#local-6989586621682941880"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621682941881"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941881"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1556"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941882"><span class="annot"><a href="#local-6989586621682941882"><span class="hs-identifier hs-var">final_usage</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941883"><span class="annot"><a href="#local-6989586621682941883"><span class="hs-identifier hs-var">binds'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941884"><span class="annot"><a href="#local-6989586621682941884"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941885"><span class="annot"><a href="#local-6989586621682941885"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; ScEnv
-&gt; OutBind
-&gt; (ScEnv -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning]))
-&gt; UniqSM (ScUsage, [OutBind], Expr Id, [SpecFailWarning])
forall a.
TopLevelFlag
-&gt; ScEnv
-&gt; OutBind
-&gt; (ScEnv -&gt; UniqSM (ScUsage, a, [SpecFailWarning]))
-&gt; UniqSM (ScUsage, [OutBind], a, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scBind"><span class="hs-identifier hs-var">scBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941878"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutBind
</span><a href="#local-6989586621682941880"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">((ScEnv -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning]))
 -&gt; UniqSM (ScUsage, [OutBind], Expr Id, [SpecFailWarning]))
-&gt; (ScEnv -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning]))
-&gt; UniqSM (ScUsage, [OutBind], Expr Id, [SpecFailWarning])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1557"></span><span>                                         </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682941887"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941887"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941887"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941881"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1558"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941882"><span class="hs-identifier hs-type">final_usage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#mkLets"><span class="hs-identifier hs-type">mkLets</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941883"><span class="hs-identifier hs-type">binds'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941884"><span class="hs-identifier hs-type">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941885"><span class="hs-identifier hs-type">ws</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1559"></span><span>
</span><span id="line-1560"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr%27"><span class="hs-identifier hs-var">scExpr'</span></a></span><span> </span><span id="local-6989586621682941889"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941889"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621682941891"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941891"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621682941892"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941892"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682941893"><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941893"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682941894"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682941894"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1561"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941895"><span class="annot"><a href="#local-6989586621682941895"><span class="hs-identifier hs-var">scrut_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941896"><span class="annot"><a href="#local-6989586621682941896"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941897"><span class="annot"><a href="#local-6989586621682941897"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941889"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941891"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-1562"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-type">isValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#sc_vals"><span class="hs-identifier hs-var">sc_vals</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941889"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941896"><span class="hs-identifier hs-type">scrut'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1563"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ConVal"><span class="hs-identifier hs-type">ConVal</span></a></span><span> </span><span id="local-6989586621682941898"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682941898"><span class="hs-identifier hs-var">args_are_work_free</span></a></span></span><span> </span><span id="local-6989586621682941899"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941899"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682941900"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941900"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1564"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682941898"><span class="hs-identifier hs-var">args_are_work_free</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AltCon
-&gt; [Expr Id]
-&gt; Expr Id
-&gt; [SpecFailWarning]
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="#local-6989586621682941901"><span class="hs-identifier hs-var">sc_con_app</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941899"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941900"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941896"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941897"><span class="hs-identifier hs-var">ws</span></a></span><span>
</span><span id="line-1565"></span><span>                     </span><span class="hs-comment">-- Don't duplicate work!!  #7865</span><span>
</span><span id="line-1566"></span><span>                     </span><span class="hs-comment">-- See Note [ConVal work-free-ness] (1)</span><span>
</span><span id="line-1567"></span><span>                </span><span id="local-6989586621682941902"><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621682941902"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScUsage
-&gt; Expr Id
-&gt; [SpecFailWarning]
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="#local-6989586621682941903"><span class="hs-identifier hs-var">sc_vanilla</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941895"><span class="hs-identifier hs-var">scrut_usg</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941896"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941897"><span class="hs-identifier hs-var">ws</span></a></span><span>
</span><span id="line-1568"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1569"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1570"></span><span>    </span><span id="local-6989586621682941901"><span class="annot"><span class="annottext">sc_con_app :: AltCon
-&gt; [Expr Id]
-&gt; Expr Id
-&gt; [SpecFailWarning]
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="#local-6989586621682941901"><span class="hs-identifier hs-var hs-var">sc_con_app</span></a></span></span><span> </span><span id="local-6989586621682941904"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941904"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682941905"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941905"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682941906"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941906"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span> </span><span id="local-6989586621682941907"><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941907"><span class="hs-identifier hs-var">ws</span></a></span></span><span>  </span><span class="hs-comment">-- Known constructor; simplify</span><span>
</span><span id="line-1571"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682941909"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941909"><span class="hs-identifier hs-var hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682941910"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941910"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Alt Id] -&gt; Maybe (Alt Id)
forall b. AltCon -&gt; [Alt b] -&gt; Maybe (Alt b)
</span><a href="GHC.Core.Utils.html#findAlt"><span class="hs-identifier hs-var">findAlt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941904"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682941894"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1572"></span><span>                                  </span><span class="annot"><span class="annottext">Maybe (Alt Id) -&gt; Alt Id -&gt; Alt Id
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; Expr Id -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InType -&gt; String -&gt; Expr Id
</span><a href="GHC.Core.Make.html#mkImpossibleExpr"><span class="hs-identifier hs-var">mkImpossibleExpr</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682941893"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SpecConstr&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1573"></span><span>                </span><span id="local-6989586621682941912"><span class="annot"><span class="annottext">alt_env' :: ScEnv
</span><a href="#local-6989586621682941912"><span class="hs-identifier hs-var hs-var hs-var">alt_env'</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; [(Id, Expr Id)] -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendScSubstList"><span class="hs-identifier hs-var">extendScSubstList</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941889"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941892"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941906"><span class="hs-identifier hs-var">scrut'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Id, Expr Id) -&gt; [(Id, Expr Id)] -&gt; [(Id, Expr Id)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941909"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Expr Id] -&gt; [(Id, Expr Id)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Expr Id] -&gt; [Expr Id]
</span><a href="GHC.Core.Utils.html#trimConArgs"><span class="hs-identifier hs-var">trimConArgs</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941904"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941905"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1574"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941914"><span class="annot"><a href="#local-6989586621682941914"><span class="hs-identifier hs-var">use'</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682941915"><span class="annot"><a href="#local-6989586621682941915"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682941916"><span class="annot"><a href="#local-6989586621682941916"><span class="hs-identifier hs-var">ws_new</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941912"><span class="hs-identifier hs-var">alt_env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941910"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1575"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941914"><span class="hs-identifier hs-type">use'</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682941915"><span class="hs-identifier hs-type">expr'</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682941907"><span class="hs-identifier hs-type">ws</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682941916"><span class="hs-identifier hs-type">ws_new</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1576"></span><span>
</span><span id="line-1577"></span><span>    </span><span id="local-6989586621682941903"><span class="annot"><span class="annottext">sc_vanilla :: ScUsage
-&gt; Expr Id
-&gt; [SpecFailWarning]
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="#local-6989586621682941903"><span class="hs-identifier hs-var hs-var">sc_vanilla</span></a></span></span><span> </span><span id="local-6989586621682941917"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941917"><span class="hs-identifier hs-var">scrut_usg</span></a></span></span><span> </span><span id="local-6989586621682941918"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941918"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span> </span><span id="local-6989586621682941919"><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941919"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span class="hs-comment">-- Normal case</span><span>
</span><span id="line-1578"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941920"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941920"><span class="hs-identifier hs-var hs-var">alt_env</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682941921"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941921"><span class="hs-identifier hs-var hs-var">b'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HowBound -&gt; ScEnv -&gt; Id -&gt; (ScEnv, Id)
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndrWith"><span class="hs-identifier hs-var">extendBndrWith</span></a></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecArg"><span class="hs-identifier hs-var">RecArg</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941889"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941892"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1579"></span><span>                        </span><span class="hs-comment">-- Record RecArg for the components</span><span>
</span><span id="line-1580"></span><span>
</span><span id="line-1581"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941922"><span class="annot"><a href="#local-6989586621682941922"><span class="hs-identifier hs-var">alt_usgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941923"><span class="annot"><a href="#local-6989586621682941923"><span class="hs-identifier hs-var">alt_occs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941924"><span class="annot"><a href="#local-6989586621682941924"><span class="hs-identifier hs-var">alts'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941925"><span class="annot"><a href="#local-6989586621682941925"><span class="hs-identifier hs-var">ws_alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Alt Id -&gt; UniqSM (ScUsage, ArgOcc, Alt Id, [SpecFailWarning]))
-&gt; [Alt Id]
-&gt; UniqSM ([ScUsage], [ArgOcc], [Alt Id], [[SpecFailWarning]])
forall (m :: * -&gt; *) a b c d e.
Monad m =&gt;
(a -&gt; m (b, c, d, e)) -&gt; [a] -&gt; m ([b], [c], [d], [e])
</span><a href="GHC.Utils.Monad.html#mapAndUnzip4M"><span class="hs-identifier hs-var">mapAndUnzip4M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
-&gt; Expr Id
-&gt; Id
-&gt; Alt Id
-&gt; UniqSM (ScUsage, ArgOcc, Alt Id, [SpecFailWarning])
</span><a href="#local-6989586621682941927"><span class="hs-identifier hs-var">sc_alt</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941920"><span class="hs-identifier hs-var">alt_env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941918"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941921"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682941894"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1582"></span><span>
</span><span id="line-1583"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682941928"><span class="annot"><a href="#local-6989586621682941928"><span class="hs-identifier hs-var hs-var">scrut_occ</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ArgOcc -&gt; ArgOcc -&gt; ArgOcc) -&gt; ArgOcc -&gt; [ArgOcc] -&gt; ArgOcc
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">ArgOcc -&gt; ArgOcc -&gt; ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-identifier hs-var">combineOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#NoOcc"><span class="hs-identifier hs-var">NoOcc</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682941923"><span class="hs-identifier hs-var">alt_occs</span></a></span><span>
</span><span id="line-1584"></span><span>                </span><span id="local-6989586621682941930"><span class="annot"><a href="#local-6989586621682941930"><span class="hs-identifier hs-var hs-var">scrut_usg'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; ScUsage -&gt; Expr Id -&gt; ArgOcc -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#setScrutOcc"><span class="hs-identifier hs-var">setScrutOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941889"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941917"><span class="hs-identifier hs-var">scrut_usg</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941918"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682941928"><span class="hs-identifier hs-var">scrut_occ</span></a></span><span>
</span><span id="line-1585"></span><span>                </span><span class="hs-comment">-- The combined usage of the scrutinee is given</span><span>
</span><span id="line-1586"></span><span>                </span><span class="hs-comment">-- by scrut_occ, which is passed to setScrutOcc, which</span><span>
</span><span id="line-1587"></span><span>                </span><span class="hs-comment">-- in turn treats a bare-variable scrutinee specially</span><span>
</span><span id="line-1588"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MkSolo</span></span><span> </span><span id="local-6989586621682941931"><span class="annot"><a href="#local-6989586621682941931"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scSubstTy"><span class="hs-identifier hs-type">scSubstTy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941889"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941893"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-1589"></span><span>
</span><span id="line-1590"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">foldr</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-identifier hs-type">combineUsage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941930"><span class="hs-identifier hs-type">scrut_usg'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941922"><span class="hs-identifier hs-type">alt_usgs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1591"></span><span>                    </span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941918"><span class="hs-identifier hs-type">scrut'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941921"><span class="hs-identifier hs-type">b'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941931"><span class="hs-identifier hs-type">ty'</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621682941924"><span class="hs-identifier hs-type">alts'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941919"><span class="hs-identifier hs-type">ws</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">concat</span></span><span> </span><span class="annot"><a href="#local-6989586621682941925"><span class="hs-identifier hs-type">ws_alts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1592"></span><span>
</span><span id="line-1593"></span><span>    </span><span id="local-6989586621682941932"><span class="annot"><span class="annottext">single_alt :: Bool
</span><a href="#local-6989586621682941932"><span class="hs-identifier hs-var hs-var">single_alt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt Id] -&gt; Bool
forall a. [a] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#isSingleton"><span class="hs-identifier hs-var">isSingleton</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621682941894"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1594"></span><span>
</span><span id="line-1595"></span><span>    </span><span id="local-6989586621682941927"><span class="annot"><span class="annottext">sc_alt :: ScEnv
-&gt; Expr Id
-&gt; Id
-&gt; Alt Id
-&gt; UniqSM (ScUsage, ArgOcc, Alt Id, [SpecFailWarning])
</span><a href="#local-6989586621682941927"><span class="hs-identifier hs-var hs-var">sc_alt</span></a></span></span><span> </span><span id="local-6989586621682941934"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941934"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941935"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941935"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span> </span><span id="local-6989586621682941936"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941936"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621682941937"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941937"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621682941938"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941938"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621682941939"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941939"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1596"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941940"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941940"><span class="hs-identifier hs-var hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941941"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941941"><span class="hs-identifier hs-var hs-var">bs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HowBound -&gt; ScEnv -&gt; [Id] -&gt; (ScEnv, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndrsWith"><span class="hs-identifier hs-var">extendBndrsWith</span></a></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecArg"><span class="hs-identifier hs-var">RecArg</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941934"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941938"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-1597"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621682941942"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941942"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941943"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941943"><span class="hs-identifier hs-var hs-var">bs2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; Id -&gt; AltCon -&gt; [Id] -&gt; (ScEnv, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#extendCaseBndrs"><span class="hs-identifier hs-var">extendCaseBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941940"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941935"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941936"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941937"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682941941"><span class="hs-identifier hs-var">bs1</span></a></span><span>
</span><span id="line-1598"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941944"><span class="annot"><a href="#local-6989586621682941944"><span class="hs-identifier hs-var">usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941945"><span class="annot"><a href="#local-6989586621682941945"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941946"><span class="annot"><a href="#local-6989586621682941946"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941942"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941939"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1599"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941947"><span class="annot"><a href="#local-6989586621682941947"><span class="hs-identifier hs-var">usg'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941948"><span class="annot"><a href="#local-6989586621682941948"><span class="hs-identifier hs-var">b_occ</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682941949"><span class="annot"><a href="#local-6989586621682941949"><span class="hs-identifier hs-var">arg_occs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#lookupOccs"><span class="hs-identifier hs-type">lookupOccs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941944"><span class="hs-identifier hs-type">usg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941936"><span class="hs-identifier hs-type">b'</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621682941943"><span class="hs-identifier hs-type">bs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1600"></span><span>                </span><span id="local-6989586621682941950"><span class="annot"><a href="#local-6989586621682941950"><span class="hs-identifier hs-var hs-var">scrut_occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621682941937"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1601"></span><span>                               </span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621682941951"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682941951"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-comment">-- See Note [Do not specialise evals]</span><span>
</span><span id="line-1602"></span><span>                                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682941932"><span class="hs-identifier hs-var">single_alt</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(ArgOcc -&gt; Bool) -&gt; [ArgOcc] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">ArgOcc -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#deadArgOcc"><span class="hs-identifier hs-var">deadArgOcc</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682941949"><span class="hs-identifier hs-var">arg_occs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1603"></span><span>                                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc] -&gt; ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-var">ScrutOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [ArgOcc] -&gt; DataConEnv [ArgOcc]
forall key elt. Uniquable key =&gt; key -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#unitUFM"><span class="hs-identifier hs-var">unitUFM</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682941951"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682941949"><span class="hs-identifier hs-var">arg_occs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1604"></span><span>                               </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>
</span><span id="line-1605"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682941947"><span class="hs-identifier hs-type">usg'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941948"><span class="hs-identifier hs-type">b_occ</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineOcc"><span class="hs-operator hs-type">`combineOcc`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941950"><span class="hs-identifier hs-type">scrut_occ</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941937"><span class="hs-identifier hs-type">con</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941943"><span class="hs-identifier hs-type">bs2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941945"><span class="hs-identifier hs-type">rhs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682941946"><span class="hs-identifier hs-type">ws</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1606"></span><span>
</span><span id="line-1607"></span><span>
</span><span id="line-1608"></span><span class="hs-comment">-- | Substitute the free variables captured by a breakpoint.</span><span>
</span><span id="line-1609"></span><span class="hs-comment">-- Variables are dropped if they have a non-variable substitution, like in</span><span>
</span><span id="line-1610"></span><span class="hs-comment">-- 'GHC.Opt.Specialise.specTickish'.</span><span>
</span><span id="line-1611"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scTickish"><span class="hs-identifier hs-type">scTickish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span>
</span><span id="line-1612"></span><span id="scTickish"><span class="annot"><span class="annottext">scTickish :: ScEnv -&gt; CoreTickish -&gt; CoreTickish
</span><a href="GHC.Core.Opt.SpecConstr.html#scTickish"><span class="hs-identifier hs-var hs-var">scTickish</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCE"><span class="hs-identifier hs-type">SCE</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">sc_subst :: ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682941954"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682941954"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; CoreTickish -&gt; CoreTickish
</span><a href="GHC.Core.Subst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682941954"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1613"></span><span>
</span><span id="line-1614"></span><span class="hs-comment">{- Note [Do not specialise evals]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f x y = case x of I# _ -&gt;
           if y&gt;1 then f x (y-1) else x

Here `x` is scrutinised by a case, but only in an eval-like way; the
/component/ of the I# is unused.  We don't want to specialise this
function, even if we find a call (f (I# z)), because nothing is gained
  * No case branches are discarded
  * No allocation in removed
The specialised version would take an unboxed Int#, pass it along,
and rebox it at the end.

In fact this can cause significant regression.  In #21763 we had:
like
  f = ... case x of x' { I# n -&gt;
          join j y = rhs
          in ...jump j x'...

Now if we specialise `j` for the argument `I# n`, we'll end up reboxing
it in `j`, without even removing an allocation from the call site.

Reboxing is always a worry.  But here we can ameliorate the problem as
follows.

* In scExpr (Case ...), for a /single-alternative/ case expression, in
  which the pattern binders are all unused, we build a UnkOcc for
  the scrutinee, not one that maps the data constructor; we don't treat
  this occurrence as a reason for specialisation.

* Conveniently, SpecConstr is doing its own occurrence analysis, so
  the &quot;unused&quot; bit is just looking for NoOcc

* Note that if we have
    f x = case x of { True -&gt; e1; False -&gt; e2 }
  then even though the pattern binders are unused (there are none), it is
  still worth specialising on x. Hence the /single-alternative/ guard.
-}</span><span>
</span><span id="line-1653"></span><span>
</span><span id="line-1654"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scApp"><span class="hs-identifier hs-type">scApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1655"></span><span>
</span><span id="line-1656"></span><span id="scApp"><span class="annot"><span class="annottext">scApp :: ScEnv
-&gt; (Expr Id, [Expr Id])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scApp"><span class="hs-identifier hs-var hs-var">scApp</span></a></span></span><span> </span><span id="local-6989586621682941957"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941957"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682941958"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941958"><span class="hs-identifier hs-var">fn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941959"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941959"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Function is a variable</span><span>
</span><span id="line-1657"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Expr Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941959"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (ScUsage, Expr Id, [SpecFailWarning])
 -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning]))
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1658"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682941961"><span class="annot"><a href="#local-6989586621682941961"><span class="hs-identifier hs-var">args_w_usgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning]))
-&gt; [Expr Id] -&gt; UniqSM [(ScUsage, Expr Id, [SpecFailWarning])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941957"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941959"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1659"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941963"><span class="annot"><a href="#local-6989586621682941963"><span class="hs-identifier hs-var">arg_usgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941964"><span class="annot"><a href="#local-6989586621682941964"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941965"><span class="annot"><a href="#local-6989586621682941965"><span class="hs-identifier hs-var">arg_ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unzip3</span></span><span> </span><span class="annot"><a href="#local-6989586621682941961"><span class="hs-identifier hs-type">args_w_usgs</span></a></span><span>
</span><span id="line-1660"></span><span>              </span><span id="local-6989586621682941967"><span class="annot"><a href="#local-6989586621682941967"><span class="hs-identifier hs-var hs-var">arg_usg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ScUsage] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsages"><span class="hs-identifier hs-var">combineUsages</span></a></span><span> </span><span class="annot"><span class="annottext">[ScUsage]
</span><a href="#local-6989586621682941963"><span class="hs-identifier hs-var">arg_usgs</span></a></span><span>
</span><span id="line-1661"></span><span>              </span><span id="local-6989586621682941968"><span class="annot"><a href="#local-6989586621682941968"><span class="hs-identifier hs-var hs-var">arg_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[SpecFailWarning]] -&gt; [SpecFailWarning]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[SpecFailWarning]]
</span><a href="#local-6989586621682941965"><span class="hs-identifier hs-var">arg_ws</span></a></span><span>
</span><span id="line-1662"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scSubstId"><span class="hs-identifier hs-type">scSubstId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941957"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941958"><span class="hs-identifier hs-type">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1663"></span><span>            </span><span id="local-6989586621682941969"><span class="annot"><span class="annottext">fn' :: Expr Id
</span><a href="#local-6989586621682941969"><span class="hs-identifier hs-var">fn'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
-&gt; (ScUsage, Expr Id, [SpecFailWarning])
-&gt; (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#withWarnings"><span class="hs-identifier hs-var">withWarnings</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941968"><span class="hs-identifier hs-var">arg_w</span></a></span><span> </span><span class="annot"><span class="annottext">((ScUsage, Expr Id, [SpecFailWarning])
 -&gt; (ScUsage, Expr Id, [SpecFailWarning]))
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#zapScSubst"><span class="hs-identifier hs-var">zapScSubst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941957"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Id -&gt; [Expr Id] -&gt; Expr Id
</span><a href="#local-6989586621682941971"><span class="hs-identifier hs-var">doBeta</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941969"><span class="hs-identifier hs-var">fn'</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941964"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1664"></span><span>                        </span><span class="hs-comment">-- Do beta-reduction and try again</span><span>
</span><span id="line-1665"></span><span>
</span><span id="line-1666"></span><span>            </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682941972"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941972"><span class="hs-identifier hs-var">fn'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ScUsage, Expr Id, [SpecFailWarning])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941973"><span class="hs-identifier hs-var">arg_usg'</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; ScUsage -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-operator hs-var">`combineUsage`</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; [Expr Id] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#mkVarUsage"><span class="hs-identifier hs-var">mkVarUsage</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941957"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941972"><span class="hs-identifier hs-var">fn'</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941964"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1667"></span><span>                               </span><span class="annot"><span class="annottext">Expr Id -&gt; [Expr Id] -&gt; Expr Id
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Expr Id
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941972"><span class="hs-identifier hs-var">fn'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941964"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941968"><span class="hs-identifier hs-var">arg_w</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1668"></span><span>               </span><span class="hs-keyword">where</span><span>
</span><span id="line-1669"></span><span>                 </span><span class="hs-comment">-- arg_usg': see Note [Specialising on dictionaries]</span><span>
</span><span id="line-1670"></span><span>                 </span><span id="local-6989586621682941973"><span class="annot"><span class="annottext">arg_usg' :: ScUsage
</span><a href="#local-6989586621682941973"><span class="hs-identifier hs-var hs-var">arg_usg'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682941975"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682941975"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe Class
</span><a href="GHC.Types.Id.html#isClassOpId_maybe"><span class="hs-identifier hs-var">isClassOpId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941972"><span class="hs-identifier hs-var">fn'</span></a></span><span>
</span><span id="line-1671"></span><span>                          </span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941977"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941977"><span class="hs-identifier hs-var">dict_arg</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Expr Id] -&gt; [Expr Id]
forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#dropList"><span class="hs-identifier hs-var">dropList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [Id]
</span><a href="GHC.Core.Class.html#classTyVars"><span class="hs-identifier hs-var">classTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682941975"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941964"><span class="hs-identifier hs-var">args'</span></a></span><span>
</span><span id="line-1672"></span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; ScUsage -&gt; Expr Id -&gt; ArgOcc -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#setScrutOcc"><span class="hs-identifier hs-var">setScrutOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941957"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941967"><span class="hs-identifier hs-var">arg_usg</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941977"><span class="hs-identifier hs-var">dict_arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#evalScrutOcc"><span class="hs-identifier hs-var">evalScrutOcc</span></a></span><span>
</span><span id="line-1673"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1674"></span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941967"><span class="hs-identifier hs-var">arg_usg</span></a></span><span>
</span><span id="line-1675"></span><span>
</span><span id="line-1676"></span><span>            </span><span id="local-6989586621682941979"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941979"><span class="hs-identifier hs-var">other_fn'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ScUsage, Expr Id, [SpecFailWarning])
-&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682941967"><span class="hs-identifier hs-var">arg_usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; [Expr Id] -&gt; Expr Id
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941979"><span class="hs-identifier hs-var">other_fn'</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941964"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682941968"><span class="hs-identifier hs-var">arg_w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1677"></span><span>                </span><span class="hs-comment">-- NB: doing this ignores any usage info from the substituted</span><span>
</span><span id="line-1678"></span><span>                </span><span class="hs-comment">--     function, but I don't think that matters.  If it does</span><span>
</span><span id="line-1679"></span><span>                </span><span class="hs-comment">--     we can fix it.</span><span>
</span><span id="line-1680"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1681"></span><span>    </span><span class="annot"><a href="#local-6989586621682941971"><span class="hs-identifier hs-type">doBeta</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-1682"></span><span>    </span><span id="local-6989586621682941971"><span class="annot"><span class="annottext">doBeta :: Expr Id -&gt; [Expr Id] -&gt; Expr Id
</span><a href="#local-6989586621682941971"><span class="hs-identifier hs-var hs-var">doBeta</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682941980"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941980"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682941981"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941981"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941982"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941982"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682941983"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941983"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutBind -&gt; Expr Id -&gt; Expr Id
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Expr Id -&gt; OutBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941980"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941982"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Id -&gt; [Expr Id] -&gt; Expr Id
</span><a href="#local-6989586621682941971"><span class="hs-identifier hs-var">doBeta</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941981"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941983"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1683"></span><span>    </span><span class="annot"><a href="#local-6989586621682941971"><span class="hs-identifier hs-var">doBeta</span></a></span><span> </span><span id="local-6989586621682941984"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941984"><span class="hs-identifier hs-var">fn</span></a></span></span><span>              </span><span id="local-6989586621682941985"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941985"><span class="hs-identifier hs-var">args</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; [Expr Id] -&gt; Expr Id
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941984"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941985"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1684"></span><span>
</span><span id="line-1685"></span><span class="hs-comment">-- The function is almost always a variable, but not always.</span><span>
</span><span id="line-1686"></span><span class="hs-comment">-- In particular, if this pass follows float-in,</span><span>
</span><span id="line-1687"></span><span class="hs-comment">-- which it may, we can get</span><span>
</span><span id="line-1688"></span><span class="hs-comment">--      (let f = ...f... in f) arg1 arg2</span><span>
</span><span id="line-1689"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scApp"><span class="hs-identifier hs-var">scApp</span></a></span><span> </span><span id="local-6989586621682941986"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941986"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941987"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941987"><span class="hs-identifier hs-var">other_fn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941988"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941988"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1690"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941989"><span class="annot"><a href="#local-6989586621682941989"><span class="hs-identifier hs-var">fn_usg</span></a></span></span><span class="hs-special">,</span><span>   </span><span id="local-6989586621682941990"><span class="annot"><a href="#local-6989586621682941990"><span class="hs-identifier hs-var">fn'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941991"><span class="annot"><a href="#local-6989586621682941991"><span class="hs-identifier hs-var">fn_ws</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941986"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682941987"><span class="hs-identifier hs-var">other_fn</span></a></span><span>
</span><span id="line-1691"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682941992"><span class="annot"><a href="#local-6989586621682941992"><span class="hs-identifier hs-var">arg_usgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941993"><span class="annot"><a href="#local-6989586621682941993"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682941994"><span class="annot"><a href="#local-6989586621682941994"><span class="hs-identifier hs-var">arg_ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapAndUnzip3M"><span class="hs-identifier hs-type">mapAndUnzip3M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-type">scExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941986"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682941988"><span class="hs-identifier hs-type">args</span></a></span><span>
</span><span id="line-1692"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineUsages"><span class="hs-identifier hs-type">combineUsages</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941992"><span class="hs-identifier hs-type">arg_usgs</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-operator hs-type">`combineUsage`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941989"><span class="hs-identifier hs-type">fn_usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-type">mkApps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941990"><span class="hs-identifier hs-type">fn'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941993"><span class="hs-identifier hs-type">args'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineSpecWarning"><span class="hs-identifier hs-type">combineSpecWarning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682941991"><span class="hs-identifier hs-type">fn_ws</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">concat</span></span><span> </span><span class="annot"><a href="#local-6989586621682941994"><span class="hs-identifier hs-type">arg_ws</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1693"></span><span>
</span><span id="line-1694"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1695"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#mkVarUsage"><span class="hs-identifier hs-type">mkVarUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span>
</span><span id="line-1696"></span><span id="mkVarUsage"><span class="annot"><span class="annottext">mkVarUsage :: ScEnv -&gt; Id -&gt; [Expr Id] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#mkVarUsage"><span class="hs-identifier hs-var hs-var">mkVarUsage</span></a></span></span><span> </span><span id="local-6989586621682941996"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941996"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682941997"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941997"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682941998"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941998"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-1697"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Id -&gt; Maybe HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#lookupHowBound"><span class="hs-identifier hs-var">lookupHowBound</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941996"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941997"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1698"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecFun"><span class="hs-identifier hs-var">RecFun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCU"><span class="hs-identifier hs-type">SCU</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scu_calls :: CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Call] -&gt; CallEnv
forall a. Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#unitVarEnv"><span class="hs-identifier hs-var">unitVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941997"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; [Expr Id] -&gt; ValueEnv -&gt; Call
</span><a href="GHC.Core.Opt.SpecConstr.html#Call"><span class="hs-identifier hs-var">Call</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941997"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941998"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; ValueEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_vals"><span class="hs-identifier hs-var">sc_vals</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682941996"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1699"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">scu_occs :: IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdEnv ArgOcc
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1700"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecArg"><span class="hs-identifier hs-var">RecArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SCU"><span class="hs-identifier hs-type">SCU</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scu_calls :: CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallEnv
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-1701"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">scu_occs :: IdEnv ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_occs"><span class="hs-identifier hs-var">scu_occs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; ArgOcc -&gt; IdEnv ArgOcc
forall a. Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#unitVarEnv"><span class="hs-identifier hs-var">unitVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682941997"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942000"><span class="hs-identifier hs-var">arg_occ</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1702"></span><span>        </span><span class="annot"><span class="annottext">Maybe HowBound
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var">nullUsage</span></a></span><span>
</span><span id="line-1703"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1704"></span><span>    </span><span id="local-6989586621682942000"><span class="annot"><span class="annottext">arg_occ :: ArgOcc
</span><a href="#local-6989586621682942000"><span class="hs-identifier hs-var hs-var">arg_occ</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682941998"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span>
</span><span id="line-1705"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#evalScrutOcc"><span class="hs-identifier hs-var">evalScrutOcc</span></a></span><span>
</span><span id="line-1706"></span><span>
</span><span id="line-1707"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1708"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scRecRhs"><span class="hs-identifier hs-type">scRecRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RhsInfo"><span class="hs-identifier hs-type">RhsInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1709"></span><span id="scRecRhs"><span class="annot"><span class="annottext">scRecRhs :: ScEnv -&gt; (Id, Expr Id) -&gt; UniqSM (RhsInfo, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scRecRhs"><span class="hs-identifier hs-var hs-var">scRecRhs</span></a></span></span><span> </span><span id="local-6989586621682942001"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942001"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942002"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942002"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682942003"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942003"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1710"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942004"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942004"><span class="hs-identifier hs-var hs-var">arg_bndrs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682942005"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942005"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; ([Id], Expr Id)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942003"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1711"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682942007"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942007"><span class="hs-identifier hs-var hs-var">body_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942008"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942008"><span class="hs-identifier hs-var hs-var">arg_bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HowBound -&gt; ScEnv -&gt; [Id] -&gt; (ScEnv, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#extendBndrsWith"><span class="hs-identifier hs-var">extendBndrsWith</span></a></span><span> </span><span class="annot"><span class="annottext">HowBound
</span><a href="GHC.Core.Opt.SpecConstr.html#RecArg"><span class="hs-identifier hs-var">RecArg</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942001"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942004"><span class="hs-identifier hs-var">arg_bndrs</span></a></span><span>
</span><span id="line-1712"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942009"><span class="annot"><a href="#local-6989586621682942009"><span class="hs-identifier hs-var">body_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942010"><span class="annot"><a href="#local-6989586621682942010"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942011"><span class="annot"><a href="#local-6989586621682942011"><span class="hs-identifier hs-var">body_ws</span></a></span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Expr Id -&gt; UniqSM (ScUsage, Expr Id, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-var">scExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942007"><span class="hs-identifier hs-var">body_env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942005"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1713"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942012"><span class="annot"><a href="#local-6989586621682942012"><span class="hs-identifier hs-var">rhs_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942013"><span class="annot"><a href="#local-6989586621682942013"><span class="hs-identifier hs-var">arg_occs</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#lookupOccs"><span class="hs-identifier hs-type">lookupOccs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942009"><span class="hs-identifier hs-type">body_usg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942008"><span class="hs-identifier hs-type">arg_bndrs'</span></a></span><span>
</span><span id="line-1714"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RI"><span class="hs-identifier hs-type">RI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ri_rhs_usg"><span class="hs-identifier hs-var">ri_rhs_usg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942012"><span class="hs-identifier hs-type">rhs_usg</span></a></span><span>
</span><span id="line-1715"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ri_fn"><span class="hs-identifier hs-var">ri_fn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942002"><span class="hs-identifier hs-type">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ri_new_rhs"><span class="hs-identifier hs-var">ri_new_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-type">mkLams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942008"><span class="hs-identifier hs-type">arg_bndrs'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942010"><span class="hs-identifier hs-type">body'</span></a></span><span>
</span><span id="line-1716"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ri_lam_bndrs"><span class="hs-identifier hs-var">ri_lam_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942004"><span class="hs-identifier hs-type">arg_bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ri_lam_body"><span class="hs-identifier hs-var">ri_lam_body</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942005"><span class="hs-identifier hs-type">body</span></a></span><span>
</span><span id="line-1717"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ri_arg_occs"><span class="hs-identifier hs-var">ri_arg_occs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942013"><span class="hs-identifier hs-type">arg_occs</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682942011"><span class="hs-identifier hs-type">body_ws</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1718"></span><span>                </span><span class="hs-comment">-- The arg_occs says how the visible,</span><span>
</span><span id="line-1719"></span><span>                </span><span class="hs-comment">-- lambda-bound binders of the RHS are used</span><span>
</span><span id="line-1720"></span><span>                </span><span class="hs-comment">-- (including the TyVar binders)</span><span>
</span><span id="line-1721"></span><span>                </span><span class="hs-comment">-- Two pats are the same if they match both ways</span><span>
</span><span id="line-1722"></span><span>
</span><span id="line-1723"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1724"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ruleInfoBinds"><span class="hs-identifier hs-type">ruleInfoBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RhsInfo"><span class="hs-identifier hs-type">RhsInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1725"></span><span id="ruleInfoBinds"><span class="annot"><span class="annottext">ruleInfoBinds :: RhsInfo -&gt; SpecInfo -&gt; [(Id, Expr Id)]
</span><a href="GHC.Core.Opt.SpecConstr.html#ruleInfoBinds"><span class="hs-identifier hs-var hs-var">ruleInfoBinds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RI"><span class="hs-identifier hs-type">RI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ri_fn :: RhsInfo -&gt; Id
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_fn"><span class="hs-identifier hs-var">ri_fn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942021"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942021"><span class="hs-identifier hs-var">fn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ri_new_rhs :: RhsInfo -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_new_rhs"><span class="hs-identifier hs-var">ri_new_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942022"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942022"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1726"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SI"><span class="hs-identifier hs-type">SI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">si_specs :: SpecInfo -&gt; [OneSpec]
</span><a href="GHC.Core.Opt.SpecConstr.html#si_specs"><span class="hs-identifier hs-var">si_specs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942025"><span class="annot"><span class="annottext">[OneSpec]
</span><a href="#local-6989586621682942025"><span class="hs-identifier hs-var">specs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1727"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942026"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942027"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#OS"><span class="hs-identifier hs-type">OS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">os_id :: OneSpec -&gt; Id
</span><a href="GHC.Core.Opt.SpecConstr.html#os_id"><span class="hs-identifier hs-var">os_id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942026"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942026"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">os_rhs :: OneSpec -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#os_rhs"><span class="hs-identifier hs-var">os_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942027"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942027"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[OneSpec]
</span><a href="#local-6989586621682942025"><span class="hs-identifier hs-var">specs</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)] -&gt; [(Id, Expr Id)] -&gt; [(Id, Expr Id)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-1728"></span><span>              </span><span class="hs-comment">-- First the specialised bindings</span><span>
</span><span id="line-1729"></span><span>
</span><span id="line-1730"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942021"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [CoreRule] -&gt; Id
</span><a href="GHC.Core.Rules.html#addIdSpecialisations"><span class="hs-operator hs-var">`addIdSpecialisations`</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621682942032"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942022"><span class="hs-identifier hs-var">new_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1731"></span><span>              </span><span class="hs-comment">-- And now the original binding</span><span>
</span><span id="line-1732"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1733"></span><span>    </span><span id="local-6989586621682942032"><span class="annot"><span class="annottext">rules :: [CoreRule]
</span><a href="#local-6989586621682942032"><span class="hs-identifier hs-var hs-var">rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682942033"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#OS"><span class="hs-identifier hs-type">OS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">os_rule :: OneSpec -&gt; CoreRule
</span><a href="GHC.Core.Opt.SpecConstr.html#os_rule"><span class="hs-identifier hs-var">os_rule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942033"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621682942033"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[OneSpec]
</span><a href="#local-6989586621682942025"><span class="hs-identifier hs-var">specs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1734"></span><span>
</span><span id="line-1735"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                The specialiser itself
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1742"></span><span>
</span><span id="line-1743"></span><span class="hs-keyword">data</span><span> </span><span id="RhsInfo"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RhsInfo"><span class="hs-identifier hs-var">RhsInfo</span></a></span></span><span>
</span><span id="line-1744"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="RI"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RI"><span class="hs-identifier hs-var">RI</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="ri_fn"><span class="annot"><span class="annottext">RhsInfo -&gt; Id
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_fn"><span class="hs-identifier hs-var hs-var">ri_fn</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>                 </span><span class="hs-comment">-- The binder</span><span>
</span><span id="line-1745"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="ri_new_rhs"><span class="annot"><span class="annottext">RhsInfo -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_new_rhs"><span class="hs-identifier hs-var hs-var">ri_new_rhs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>          </span><span class="hs-comment">-- The specialised RHS (in current envt)</span><span>
</span><span id="line-1746"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="ri_rhs_usg"><span class="annot"><span class="annottext">RhsInfo -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_rhs_usg"><span class="hs-identifier hs-var hs-var">ri_rhs_usg</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span>          </span><span class="hs-comment">-- Usage info from specialising RHS</span><span>
</span><span id="line-1747"></span><span>
</span><span id="line-1748"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="ri_lam_bndrs"><span class="annot"><span class="annottext">RhsInfo -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_lam_bndrs"><span class="hs-identifier hs-var hs-var">ri_lam_bndrs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- The *original* RHS (\xs.body)</span><span>
</span><span id="line-1749"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="ri_lam_body"><span class="annot"><span class="annottext">RhsInfo -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_lam_body"><span class="hs-identifier hs-var hs-var">ri_lam_body</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>        </span><span class="hs-comment">--   Note [Specialise original body]</span><span>
</span><span id="line-1750"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="ri_arg_occs"><span class="annot"><span class="annottext">RhsInfo -&gt; [ArgOcc]
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_arg_occs"><span class="hs-identifier hs-var hs-var">ri_arg_occs</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Info on how the xs occur in body</span><span>
</span><span id="line-1751"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1752"></span><span>
</span><span id="line-1753"></span><span class="hs-keyword">data</span><span> </span><span id="SpecInfo"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-var">SpecInfo</span></a></span></span><span>       </span><span class="hs-comment">-- Info about specialisations for a particular Id</span><span>
</span><span id="line-1754"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SI"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SI"><span class="hs-identifier hs-var">SI</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="si_specs"><span class="annot"><span class="annottext">SpecInfo -&gt; [OneSpec]
</span><a href="GHC.Core.Opt.SpecConstr.html#si_specs"><span class="hs-identifier hs-var hs-var">si_specs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#OneSpec"><span class="hs-identifier hs-type">OneSpec</span></a></span><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- The specialisations we have</span><span>
</span><span id="line-1755"></span><span>                                        </span><span class="hs-comment">-- generated for this function</span><span>
</span><span id="line-1756"></span><span>
</span><span id="line-1757"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="si_n_specs"><span class="annot"><span class="annottext">SpecInfo -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#si_n_specs"><span class="hs-identifier hs-var hs-var">si_n_specs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>              </span><span class="hs-comment">-- Length of si_specs; used for numbering them</span><span>
</span><span id="line-1758"></span><span>
</span><span id="line-1759"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="si_mb_unspec"><span class="annot"><span class="annottext">SpecInfo -&gt; Maybe ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#si_mb_unspec"><span class="hs-identifier hs-var hs-var">si_mb_unspec</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span>  </span><span class="hs-comment">-- Just cs  =&gt; we have not yet used calls in the</span><span>
</span><span id="line-1760"></span><span>       </span><span class="hs-special">}</span><span>                                </span><span class="hs-comment">--             from calls in the *original* RHS as</span><span>
</span><span id="line-1761"></span><span>                                        </span><span class="hs-comment">--             seeds for new specialisations;</span><span>
</span><span id="line-1762"></span><span>                                        </span><span class="hs-comment">--             if you decide to do so, here is the</span><span>
</span><span id="line-1763"></span><span>                                        </span><span class="hs-comment">--             RHS usage (which has not yet been</span><span>
</span><span id="line-1764"></span><span>                                        </span><span class="hs-comment">--             unleashed)</span><span>
</span><span id="line-1765"></span><span>                                        </span><span class="hs-comment">-- Nothing =&gt; we have</span><span>
</span><span id="line-1766"></span><span>                                        </span><span class="hs-comment">-- See Note [Seeding recursive groups]</span><span>
</span><span id="line-1767"></span><span>                                        </span><span class="hs-comment">-- See Note [spec_usg includes rhs_usg]</span><span>
</span><span id="line-1768"></span><span>
</span><span id="line-1769"></span><span>        </span><span class="hs-comment">-- One specialisation: Rule plus definition</span><span>
</span><span id="line-1770"></span><span class="hs-keyword">data</span><span> </span><span id="OneSpec"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#OneSpec"><span class="hs-identifier hs-var">OneSpec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1771"></span><span>  </span><span id="OS"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#OS"><span class="hs-identifier hs-var">OS</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="os_pat"><span class="annot"><span class="annottext">OneSpec -&gt; CallPat
</span><a href="GHC.Core.Opt.SpecConstr.html#os_pat"><span class="hs-identifier hs-var hs-var">os_pat</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span>    </span><span class="hs-comment">-- Call pattern that generated this specialisation</span><span>
</span><span id="line-1772"></span><span>     </span><span class="hs-special">,</span><span> </span><span id="os_rule"><span class="annot"><span class="annottext">OneSpec -&gt; CoreRule
</span><a href="GHC.Core.Opt.SpecConstr.html#os_rule"><span class="hs-identifier hs-var hs-var">os_rule</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span>   </span><span class="hs-comment">-- Rule connecting original id with the specialisation</span><span>
</span><span id="line-1773"></span><span>     </span><span class="hs-special">,</span><span> </span><span id="os_id"><span class="annot"><span class="annottext">OneSpec -&gt; Id
</span><a href="GHC.Core.Opt.SpecConstr.html#os_id"><span class="hs-identifier hs-var hs-var">os_id</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>      </span><span class="hs-comment">-- Spec id</span><span>
</span><span id="line-1774"></span><span>     </span><span class="hs-special">,</span><span> </span><span id="os_rhs"><span class="annot"><span class="annottext">OneSpec -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#os_rhs"><span class="hs-identifier hs-var hs-var">os_rhs</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- Spec rhs</span><span>
</span><span id="line-1775"></span><span>
</span><span id="line-1776"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#initSpecInfo"><span class="hs-identifier hs-type">initSpecInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RhsInfo"><span class="hs-identifier hs-type">RhsInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span>
</span><span id="line-1777"></span><span id="initSpecInfo"><span class="annot"><span class="annottext">initSpecInfo :: RhsInfo -&gt; SpecInfo
</span><a href="GHC.Core.Opt.SpecConstr.html#initSpecInfo"><span class="hs-identifier hs-var hs-var">initSpecInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RI"><span class="hs-identifier hs-type">RI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ri_rhs_usg :: RhsInfo -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_rhs_usg"><span class="hs-identifier hs-var">ri_rhs_usg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942040"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942040"><span class="hs-identifier hs-var">rhs_usg</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1778"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SI"><span class="hs-identifier hs-type">SI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">si_specs :: [OneSpec]
</span><a href="GHC.Core.Opt.SpecConstr.html#si_specs"><span class="hs-identifier hs-var">si_specs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">si_n_specs :: Int
</span><a href="GHC.Core.Opt.SpecConstr.html#si_n_specs"><span class="hs-identifier hs-var">si_n_specs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">si_mb_unspec :: Maybe ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#si_mb_unspec"><span class="hs-identifier hs-var">si_mb_unspec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; Maybe ScUsage
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942040"><span class="hs-identifier hs-var">rhs_usg</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1779"></span><span>    </span><span class="hs-comment">-- si_mb_unspec: add in rhs_usg if there are any boring calls,</span><span>
</span><span id="line-1780"></span><span>    </span><span class="hs-comment">--               or if the bndr is exported</span><span>
</span><span id="line-1781"></span><span>
</span><span id="line-1782"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1783"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specNonRec"><span class="hs-identifier hs-type">specNonRec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1784"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallEnv"><span class="hs-identifier hs-type">CallEnv</span></a></span><span>         </span><span class="hs-comment">-- Calls in body</span><span>
</span><span id="line-1785"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RhsInfo"><span class="hs-identifier hs-type">RhsInfo</span></a></span><span>         </span><span class="hs-comment">-- Structure info usage info for un-specialised RHS</span><span>
</span><span id="line-1786"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier hs-type">SpecFailWarning</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Usage from RHSs (specialised and not)</span><span>
</span><span id="line-1787"></span><span>                                               </span><span class="hs-comment">--     plus details of specialisations</span><span>
</span><span id="line-1788"></span><span>
</span><span id="line-1789"></span><span id="specNonRec"><span class="annot"><span class="annottext">specNonRec :: ScEnv
-&gt; CallEnv
-&gt; RhsInfo
-&gt; UniqSM (ScUsage, SpecInfo, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#specNonRec"><span class="hs-identifier hs-var hs-var">specNonRec</span></a></span></span><span> </span><span id="local-6989586621682942041"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942041"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942042"><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942042"><span class="hs-identifier hs-var">body_calls</span></a></span></span><span> </span><span id="local-6989586621682942043"><span class="annot"><span class="annottext">RhsInfo
</span><a href="#local-6989586621682942043"><span class="hs-identifier hs-var">rhs_info</span></a></span></span><span>
</span><span id="line-1790"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
-&gt; CallEnv
-&gt; RhsInfo
-&gt; SpecInfo
-&gt; UniqSM (ScUsage, SpecInfo, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#specialise"><span class="hs-identifier hs-var">specialise</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942041"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942042"><span class="hs-identifier hs-var">body_calls</span></a></span><span> </span><span class="annot"><span class="annottext">RhsInfo
</span><a href="#local-6989586621682942043"><span class="hs-identifier hs-var">rhs_info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RhsInfo -&gt; SpecInfo
</span><a href="GHC.Core.Opt.SpecConstr.html#initSpecInfo"><span class="hs-identifier hs-var">initSpecInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RhsInfo
</span><a href="#local-6989586621682942043"><span class="hs-identifier hs-var">rhs_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1791"></span><span>
</span><span id="line-1792"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1793"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specRec"><span class="hs-identifier hs-type">specRec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1794"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallEnv"><span class="hs-identifier hs-type">CallEnv</span></a></span><span>                         </span><span class="hs-comment">-- Calls in body</span><span>
</span><span id="line-1795"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RhsInfo"><span class="hs-identifier hs-type">RhsInfo</span></a></span><span class="hs-special">]</span><span>                       </span><span class="hs-comment">-- Structure info and usage info for un-specialised RHSs</span><span>
</span><span id="line-1796"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1797"></span><span>                                           </span><span class="hs-comment">-- Usage from all RHSs (specialised and not)</span><span>
</span><span id="line-1798"></span><span>                                           </span><span class="hs-comment">--     plus details of specialisations</span><span>
</span><span id="line-1799"></span><span>
</span><span id="line-1800"></span><span id="specRec"><span class="annot"><span class="annottext">specRec :: ScEnv
-&gt; CallEnv
-&gt; [RhsInfo]
-&gt; UniqSM (ScUsage, [SpecInfo], [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#specRec"><span class="hs-identifier hs-var hs-var">specRec</span></a></span></span><span> </span><span id="local-6989586621682942045"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942045"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942046"><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942046"><span class="hs-identifier hs-var">body_calls</span></a></span></span><span> </span><span id="local-6989586621682942047"><span class="annot"><span class="annottext">[RhsInfo]
</span><a href="#local-6989586621682942047"><span class="hs-identifier hs-var">rhs_infos</span></a></span></span><span>
</span><span id="line-1801"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; CallEnv
-&gt; ScUsage
-&gt; [SpecInfo]
-&gt; [SpecFailWarning]
-&gt; UniqSM (ScUsage, [SpecInfo], [SpecFailWarning])
</span><a href="#local-6989586621682942048"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942046"><span class="hs-identifier hs-var">body_calls</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var">nullUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RhsInfo -&gt; SpecInfo) -&gt; [RhsInfo] -&gt; [SpecInfo]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">RhsInfo -&gt; SpecInfo
</span><a href="GHC.Core.Opt.SpecConstr.html#initSpecInfo"><span class="hs-identifier hs-var">initSpecInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[RhsInfo]
</span><a href="#local-6989586621682942047"><span class="hs-identifier hs-var">rhs_infos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1802"></span><span>    </span><span class="hs-comment">-- body_calls: see Note [Seeding recursive groups]</span><span>
</span><span id="line-1803"></span><span>    </span><span class="hs-comment">-- NB: 'go' always calls 'specialise' once, which in turn unleashes</span><span>
</span><span id="line-1804"></span><span>    </span><span class="hs-comment">--     si_mb_unspec if there are any boring calls in body_calls,</span><span>
</span><span id="line-1805"></span><span>    </span><span class="hs-comment">--     or if any of the Id(s) are exported</span><span>
</span><span id="line-1806"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1807"></span><span>    </span><span id="local-6989586621682942049"><span class="annot"><span class="annottext">opts :: SpecConstrOpts
</span><a href="#local-6989586621682942049"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942045"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1808"></span><span>
</span><span id="line-1809"></span><span>    </span><span class="hs-comment">-- Loop, specialising, until you get no new specialisations</span><span>
</span><span id="line-1810"></span><span>    </span><span class="annot"><a href="#local-6989586621682942048"><span class="hs-identifier hs-type">go</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682942050"><span class="hs-identifier hs-type">go_again</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>   </span><span class="hs-comment">-- Which iteration of the &quot;until no new specialisations&quot;</span><span>
</span><span id="line-1811"></span><span>                          </span><span class="hs-comment">-- loop we are on; first iteration is 1</span><span>
</span><span id="line-1812"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallEnv"><span class="hs-identifier hs-type">CallEnv</span></a></span><span>   </span><span class="hs-comment">-- Seed calls</span><span>
</span><span id="line-1813"></span><span>                              </span><span class="hs-comment">-- Two accumulating parameters:</span><span>
</span><span id="line-1814"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span>      </span><span class="hs-comment">-- Usage from earlier specialisations</span><span>
</span><span id="line-1815"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Details of specialisations so far</span><span>
</span><span id="line-1816"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span> </span><span class="hs-comment">-- Warnings so far</span><span>
</span><span id="line-1817"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1818"></span><span>    </span><span id="local-6989586621682942048"><span class="annot"><span class="annottext">go :: Int
-&gt; CallEnv
-&gt; ScUsage
-&gt; [SpecInfo]
-&gt; [SpecFailWarning]
-&gt; UniqSM (ScUsage, [SpecInfo], [SpecFailWarning])
</span><a href="#local-6989586621682942048"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682942051"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942051"><span class="hs-identifier hs-var">n_iter</span></a></span></span><span> </span><span id="local-6989586621682942052"><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942052"><span class="hs-identifier hs-var">seed_calls</span></a></span></span><span> </span><span id="local-6989586621682942053"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942053"><span class="hs-identifier hs-var">usg_so_far</span></a></span></span><span> </span><span id="local-6989586621682942054"><span class="annot"><span class="annottext">[SpecInfo]
</span><a href="#local-6989586621682942054"><span class="hs-identifier hs-var">spec_infos</span></a></span></span><span> </span><span id="local-6989586621682942055"><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942055"><span class="hs-identifier hs-var">ws_so_far</span></a></span></span><span>
</span><span id="line-1819"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;specRec3&quot; (vcat [ text &quot;bndrs&quot; &lt;+&gt; ppr (map ri_fn rhs_infos)</span><span>
</span><span id="line-1820"></span><span>        </span><span class="hs-comment">--                           , text &quot;iteration&quot; &lt;+&gt; int n_iter</span><span>
</span><span id="line-1821"></span><span>        </span><span class="hs-comment">--                          , text &quot;spec_infos&quot; &lt;+&gt; ppr (map (map os_pat . si_specs) spec_infos)</span><span>
</span><span id="line-1822"></span><span>        </span><span class="hs-comment">--                    ]) $</span><span>
</span><span id="line-1823"></span><span>        </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682942056"><span class="annot"><a href="#local-6989586621682942056"><span class="hs-identifier hs-var">specs_w_usg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(RhsInfo
 -&gt; SpecInfo -&gt; UniqSM (ScUsage, SpecInfo, [SpecFailWarning]))
-&gt; [RhsInfo]
-&gt; [SpecInfo]
-&gt; UniqSM [(ScUsage, SpecInfo, [SpecFailWarning])]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
-&gt; CallEnv
-&gt; RhsInfo
-&gt; SpecInfo
-&gt; UniqSM (ScUsage, SpecInfo, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#specialise"><span class="hs-identifier hs-var">specialise</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942045"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942052"><span class="hs-identifier hs-var">seed_calls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RhsInfo]
</span><a href="#local-6989586621682942047"><span class="hs-identifier hs-var">rhs_infos</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecInfo]
</span><a href="#local-6989586621682942054"><span class="hs-identifier hs-var">spec_infos</span></a></span><span>
</span><span id="line-1824"></span><span>
</span><span id="line-1825"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942058"><span class="annot"><a href="#local-6989586621682942058"><span class="hs-identifier hs-var">extra_usg_s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942059"><span class="annot"><a href="#local-6989586621682942059"><span class="hs-identifier hs-var">all_spec_infos</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942060"><span class="annot"><a href="#local-6989586621682942060"><span class="hs-identifier hs-var">extra_ws</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unzip3</span></span><span> </span><span class="annot"><a href="#local-6989586621682942056"><span class="hs-identifier hs-type">specs_w_usg</span></a></span><span>
</span><span id="line-1826"></span><span>                  </span><span id="local-6989586621682942061"><span class="annot"><a href="#local-6989586621682942061"><span class="hs-identifier hs-var hs-var">extra_usg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ScUsage] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsages"><span class="hs-identifier hs-var">combineUsages</span></a></span><span> </span><span class="annot"><span class="annottext">[ScUsage]
</span><a href="#local-6989586621682942058"><span class="hs-identifier hs-var">extra_usg_s</span></a></span><span>
</span><span id="line-1827"></span><span>                  </span><span id="local-6989586621682942062"><span class="annot"><a href="#local-6989586621682942062"><span class="hs-identifier hs-var hs-var">all_usg</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942053"><span class="hs-identifier hs-var">usg_so_far</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; ScUsage -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-operator hs-var">`combineUsage`</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942061"><span class="hs-identifier hs-var">extra_usg</span></a></span><span>
</span><span id="line-1828"></span><span>                  </span><span id="local-6989586621682942063"><span class="annot"><a href="#local-6989586621682942063"><span class="hs-identifier hs-var hs-var">new_calls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; CallEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#scu_calls"><span class="hs-identifier hs-var">scu_calls</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942061"><span class="hs-identifier hs-var">extra_usg</span></a></span><span>
</span><span id="line-1829"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621682942050"><span class="hs-identifier hs-type">go_again</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942051"><span class="hs-identifier hs-type">n_iter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942063"><span class="hs-identifier hs-type">new_calls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942062"><span class="hs-identifier hs-type">all_usg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942059"><span class="hs-identifier hs-type">all_spec_infos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682942055"><span class="hs-identifier hs-type">ws_so_far</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">concat</span></span><span> </span><span class="annot"><a href="#local-6989586621682942060"><span class="hs-identifier hs-type">extra_ws</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1830"></span><span>
</span><span id="line-1831"></span><span>    </span><span class="hs-comment">-- go_again deals with termination</span><span>
</span><span id="line-1832"></span><span>    </span><span id="local-6989586621682942050"><span class="annot"><span class="annottext">go_again :: Int
-&gt; CallEnv
-&gt; ScUsage
-&gt; [SpecInfo]
-&gt; [SpecFailWarning]
-&gt; UniqSM (ScUsage, [SpecInfo], [SpecFailWarning])
</span><a href="#local-6989586621682942050"><span class="hs-identifier hs-var hs-var">go_again</span></a></span></span><span> </span><span id="local-6989586621682942064"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942064"><span class="hs-identifier hs-var">n_iter</span></a></span></span><span> </span><span id="local-6989586621682942065"><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942065"><span class="hs-identifier hs-var">seed_calls</span></a></span></span><span> </span><span id="local-6989586621682942066"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942066"><span class="hs-identifier hs-var">usg_so_far</span></a></span></span><span> </span><span id="local-6989586621682942067"><span class="annot"><span class="annottext">[SpecInfo]
</span><a href="#local-6989586621682942067"><span class="hs-identifier hs-var">spec_infos</span></a></span></span><span> </span><span id="local-6989586621682942068"><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942068"><span class="hs-identifier hs-var">ws_so_far</span></a></span></span><span>
</span><span id="line-1833"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CallEnv -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942065"><span class="hs-identifier hs-var">seed_calls</span></a></span><span>
</span><span id="line-1834"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScUsage, [SpecInfo], [SpecFailWarning])
-&gt; UniqSM (ScUsage, [SpecInfo], [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942066"><span class="hs-identifier hs-var">usg_so_far</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SpecInfo]
</span><a href="#local-6989586621682942067"><span class="hs-identifier hs-var">spec_infos</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942068"><span class="hs-identifier hs-var">ws_so_far</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1835"></span><span>
</span><span id="line-1836"></span><span>      </span><span class="hs-comment">-- Limit recursive specialisation</span><span>
</span><span id="line-1837"></span><span>      </span><span class="hs-comment">-- See Note [Limit recursive specialisation]</span><span>
</span><span id="line-1838"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942064"><span class="hs-identifier hs-var">n_iter</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_recursive"><span class="hs-identifier hs-var">sc_recursive</span></a></span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts
</span><a href="#local-6989586621682942049"><span class="hs-identifier hs-var">opts</span></a></span><span>  </span><span class="hs-comment">-- Too many iterations of the 'go' loop</span><span>
</span><span id="line-1839"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_force"><span class="hs-identifier hs-var">sc_force</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942045"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Maybe Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_count"><span class="hs-identifier hs-var">sc_count</span></a></span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts
</span><a href="#local-6989586621682942049"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1840"></span><span>           </span><span class="hs-comment">-- If both of these are false, the sc_count</span><span>
</span><span id="line-1841"></span><span>           </span><span class="hs-comment">-- threshold will prevent non-termination</span><span>
</span><span id="line-1842"></span><span>           </span><span class="hs-comment">-- See Note [Forcing specialisation], point (FS4) and (FS2)</span><span>
</span><span id="line-1843"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(SpecInfo -&gt; Bool) -&gt; [SpecInfo] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942071"><span class="hs-identifier hs-var">the_limit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; (SpecInfo -&gt; Int) -&gt; SpecInfo -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SpecInfo -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#si_n_specs"><span class="hs-identifier hs-var">si_n_specs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SpecInfo]
</span><a href="#local-6989586621682942067"><span class="hs-identifier hs-var">spec_infos</span></a></span><span>
</span><span id="line-1844"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Give up on specialisation, but don't forget to include the rhs_usg</span><span>
</span><span id="line-1845"></span><span>        </span><span class="hs-comment">-- for the unspecialised function, since it may now be called</span><span>
</span><span id="line-1846"></span><span>        </span><span class="hs-comment">-- pprTrace &quot;specRec2&quot; (ppr (map (map os_pat . si_specs) spec_infos)) $</span><span>
</span><span id="line-1847"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942072"><span class="annot"><span class="annottext">rhs_usgs :: ScUsage
</span><a href="#local-6989586621682942072"><span class="hs-identifier hs-var hs-var">rhs_usgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ScUsage] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsages"><span class="hs-identifier hs-var">combineUsages</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SpecInfo -&gt; Maybe ScUsage) -&gt; [SpecInfo] -&gt; [ScUsage]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">SpecInfo -&gt; Maybe ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#si_mb_unspec"><span class="hs-identifier hs-var">si_mb_unspec</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecInfo]
</span><a href="#local-6989586621682942067"><span class="hs-identifier hs-var">spec_infos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1848"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(ScUsage, [SpecInfo], [SpecFailWarning])
-&gt; UniqSM (ScUsage, [SpecInfo], [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942066"><span class="hs-identifier hs-var">usg_so_far</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; ScUsage -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-operator hs-var">`combineUsage`</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942072"><span class="hs-identifier hs-var">rhs_usgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SpecInfo]
</span><a href="#local-6989586621682942067"><span class="hs-identifier hs-var">spec_infos</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942068"><span class="hs-identifier hs-var">ws_so_far</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1849"></span><span>
</span><span id="line-1850"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-1851"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; CallEnv
-&gt; ScUsage
-&gt; [SpecInfo]
-&gt; [SpecFailWarning]
-&gt; UniqSM (ScUsage, [SpecInfo], [SpecFailWarning])
</span><a href="#local-6989586621682942048"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942064"><span class="hs-identifier hs-var">n_iter</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942065"><span class="hs-identifier hs-var">seed_calls</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942066"><span class="hs-identifier hs-var">usg_so_far</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecInfo]
</span><a href="#local-6989586621682942067"><span class="hs-identifier hs-var">spec_infos</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942068"><span class="hs-identifier hs-var">ws_so_far</span></a></span><span>
</span><span id="line-1852"></span><span>
</span><span id="line-1853"></span><span>    </span><span class="hs-comment">-- See Note [Limit recursive specialisation]</span><span>
</span><span id="line-1854"></span><span>    </span><span id="local-6989586621682942071"><span class="annot"><span class="annottext">the_limit :: Int
</span><a href="#local-6989586621682942071"><span class="hs-identifier hs-var hs-var">the_limit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Maybe Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_count"><span class="hs-identifier hs-var">sc_count</span></a></span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts
</span><a href="#local-6989586621682942049"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1855"></span><span>                  </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>    </span><span class="hs-comment">-- Ugh!</span><span>
</span><span id="line-1856"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682942074"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942074"><span class="hs-identifier hs-var">max</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942074"><span class="hs-identifier hs-var">max</span></a></span><span>
</span><span id="line-1857"></span><span>
</span><span id="line-1858"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1859"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#specialise"><span class="hs-identifier hs-type">specialise</span></a></span><span>
</span><span id="line-1860"></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1861"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallEnv"><span class="hs-identifier hs-type">CallEnv</span></a></span><span>                     </span><span class="hs-comment">-- Info on newly-discovered calls to this function</span><span>
</span><span id="line-1862"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RhsInfo"><span class="hs-identifier hs-type">RhsInfo</span></a></span><span>
</span><span id="line-1863"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span>                    </span><span class="hs-comment">-- Original RHS plus patterns dealt with</span><span>
</span><span id="line-1864"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier hs-type">SpecFailWarning</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- New specialised versions and their usage</span><span>
</span><span id="line-1865"></span><span>
</span><span id="line-1866"></span><span class="hs-comment">-- See Note [spec_usg includes rhs_usg]</span><span>
</span><span id="line-1867"></span><span>
</span><span id="line-1868"></span><span class="hs-comment">-- Note: this only generates *specialised* bindings</span><span>
</span><span id="line-1869"></span><span class="hs-comment">-- The original binding is added by ruleInfoBinds</span><span>
</span><span id="line-1870"></span><span class="hs-comment">--</span><span>
</span><span id="line-1871"></span><span class="hs-comment">-- Note: the rhs here is the optimised version of the original rhs</span><span>
</span><span id="line-1872"></span><span class="hs-comment">-- So when we make a specialised copy of the RHS, we're starting</span><span>
</span><span id="line-1873"></span><span class="hs-comment">-- from an RHS whose nested functions have been optimised already.</span><span>
</span><span id="line-1874"></span><span>
</span><span id="line-1875"></span><span id="specialise"><span class="annot"><span class="annottext">specialise :: ScEnv
-&gt; CallEnv
-&gt; RhsInfo
-&gt; SpecInfo
-&gt; UniqSM (ScUsage, SpecInfo, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#specialise"><span class="hs-identifier hs-var hs-var">specialise</span></a></span></span><span> </span><span id="local-6989586621682942075"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942075"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942076"><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942076"><span class="hs-identifier hs-var">bind_calls</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#RI"><span class="hs-identifier hs-type">RI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ri_fn :: RhsInfo -&gt; Id
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_fn"><span class="hs-identifier hs-var">ri_fn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942077"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942077"><span class="hs-identifier hs-var">fn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ri_lam_bndrs :: RhsInfo -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_lam_bndrs"><span class="hs-identifier hs-var">ri_lam_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942078"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942078"><span class="hs-identifier hs-var">arg_bndrs</span></a></span></span><span>
</span><span id="line-1876"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ri_lam_body :: RhsInfo -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_lam_body"><span class="hs-identifier hs-var">ri_lam_body</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942079"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942079"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ri_arg_occs :: RhsInfo -&gt; [ArgOcc]
</span><a href="GHC.Core.Opt.SpecConstr.html#ri_arg_occs"><span class="hs-identifier hs-var">ri_arg_occs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942080"><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942080"><span class="hs-identifier hs-var">arg_occs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1877"></span><span>               </span><span id="local-6989586621682942081"><span class="annot"><span class="annottext">spec_info :: SpecInfo
</span><a href="#local-6989586621682942081"><span class="hs-identifier hs-var">spec_info</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SI"><span class="hs-identifier hs-type">SI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">si_specs :: SpecInfo -&gt; [OneSpec]
</span><a href="GHC.Core.Opt.SpecConstr.html#si_specs"><span class="hs-identifier hs-var">si_specs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942082"><span class="annot"><span class="annottext">[OneSpec]
</span><a href="#local-6989586621682942082"><span class="hs-identifier hs-var">specs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">si_n_specs :: SpecInfo -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#si_n_specs"><span class="hs-identifier hs-var">si_n_specs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942083"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942083"><span class="hs-identifier hs-var">spec_count</span></a></span></span><span>
</span><span id="line-1878"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">si_mb_unspec :: SpecInfo -&gt; Maybe ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#si_mb_unspec"><span class="hs-identifier hs-var">si_mb_unspec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942084"><span class="annot"><span class="annottext">Maybe ScUsage
</span><a href="#local-6989586621682942084"><span class="hs-identifier hs-var">mb_unspec</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1879"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadEndId"><span class="hs-identifier hs-var">isDeadEndId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942077"><span class="hs-identifier hs-var">fn</span></a></span><span>  </span><span class="hs-comment">-- Note [Do not specialise diverging functions]</span><span>
</span><span id="line-1880"></span><span>                    </span><span class="hs-comment">-- /and/ do not generate specialisation seeds from its RHS</span><span>
</span><span id="line-1881"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;specialise bot&quot; (ppr fn) $</span><span>
</span><span id="line-1882"></span><span>    </span><span class="annot"><span class="annottext">(ScUsage, SpecInfo, [SpecFailWarning])
-&gt; UniqSM (ScUsage, SpecInfo, [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var">nullUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpecInfo
</span><a href="#local-6989586621682942081"><span class="hs-identifier hs-var">spec_info</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1883"></span><span>
</span><span id="line-1884"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isNeverActive"><span class="hs-identifier hs-var">isNeverActive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942077"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1885"></span><span>      </span><span class="hs-comment">-- See Note [Transfer activation]</span><span>
</span><span id="line-1886"></span><span>      </span><span class="hs-comment">-- Don't specialise OPAQUE things, see Note [OPAQUE pragma].</span><span>
</span><span id="line-1887"></span><span>      </span><span class="hs-comment">-- Since OPAQUE things are always never-active (see</span><span>
</span><span id="line-1888"></span><span>      </span><span class="hs-comment">-- GHC.Parser.PostProcess.mkOpaquePragma) this guard never fires for</span><span>
</span><span id="line-1889"></span><span>      </span><span class="hs-comment">-- OPAQUE things.</span><span>
</span><span id="line-1890"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942078"><span class="hs-identifier hs-var">arg_bndrs</span></a></span><span class="hs-special">)</span><span>                         </span><span class="hs-comment">-- Only specialise functions</span><span>
</span><span id="line-1891"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682942088"><span class="annot"><span class="annottext">[Call]
</span><a href="#local-6989586621682942088"><span class="hs-identifier hs-var">all_calls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallEnv -&gt; Id -&gt; Maybe [Call]
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CallEnv
</span><a href="#local-6989586621682942076"><span class="hs-identifier hs-var">bind_calls</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942077"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-comment">-- Some calls to it</span><span>
</span><span id="line-1892"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;specialise entry {&quot; (ppr fn &lt;+&gt; ppr all_calls) $</span><span>
</span><span id="line-1893"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942089"><span class="annot"><a href="#local-6989586621682942089"><span class="hs-identifier hs-var">boring_call</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942090"><span class="annot"><a href="#local-6989586621682942090"><span class="hs-identifier hs-var">pats_discarded</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942091"><span class="annot"><a href="#local-6989586621682942091"><span class="hs-identifier hs-var">new_pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942092"><span class="annot"><a href="#local-6989586621682942092"><span class="hs-identifier hs-var">warnings</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1894"></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv
-&gt; Id
-&gt; SpecInfo
-&gt; [ArgOcc]
-&gt; [Call]
-&gt; UniqSM (Bool, Bool, [CallPat], [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#callsToNewPats"><span class="hs-identifier hs-var">callsToNewPats</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942075"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942077"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">SpecInfo
</span><a href="#local-6989586621682942081"><span class="hs-identifier hs-var">spec_info</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942080"><span class="hs-identifier hs-var">arg_occs</span></a></span><span> </span><span class="annot"><span class="annottext">[Call]
</span><a href="#local-6989586621682942088"><span class="hs-identifier hs-var">all_calls</span></a></span><span>
</span><span id="line-1895"></span><span>
</span><span id="line-1896"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942094"><span class="annot"><a href="#local-6989586621682942094"><span class="hs-identifier hs-var hs-var">n_pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CallPat] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942091"><span class="hs-identifier hs-var">new_pats</span></a></span><span>
</span><span id="line-1897"></span><span class="hs-comment">--        ; when (not (null new_pats) || isJust mb_unspec) $</span><span>
</span><span id="line-1898"></span><span class="hs-comment">--          pprTraceM &quot;specialise&quot; (vcat [ ppr fn &lt;+&gt; text &quot;with&quot; &lt;+&gt; int n_pats &lt;+&gt; text &quot;good patterns&quot;</span><span>
</span><span id="line-1899"></span><span class="hs-comment">--                                       , text &quot;boring_call:&quot; &lt;+&gt; ppr boring_call</span><span>
</span><span id="line-1900"></span><span class="hs-comment">--                                       , text &quot;pats_discarded:&quot; &lt;+&gt; ppr pats_discarded</span><span>
</span><span id="line-1901"></span><span class="hs-comment">--                                       , text &quot;old spec_count&quot; &lt;+&gt; ppr spec_count</span><span>
</span><span id="line-1902"></span><span class="hs-comment">--                                       , text &quot;spec count limit&quot; &lt;+&gt; ppr (sc_count (sc_opts env))</span><span>
</span><span id="line-1903"></span><span class="hs-comment">--                                       , text &quot;mb_unspec&quot; &lt;+&gt; ppr (isJust mb_unspec)</span><span>
</span><span id="line-1904"></span><span class="hs-comment">--                                       , text &quot;arg_occs&quot; &lt;+&gt; ppr arg_occs</span><span>
</span><span id="line-1905"></span><span class="hs-comment">--                                       , text &quot;new_pats&quot; &lt;+&gt; ppr new_pats])</span><span>
</span><span id="line-1906"></span><span>
</span><span id="line-1907"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942096"><span class="annot"><a href="#local-6989586621682942096"><span class="hs-identifier hs-var hs-var">spec_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Int -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#decreaseSpecCount"><span class="hs-identifier hs-var">decreaseSpecCount</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942075"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942094"><span class="hs-identifier hs-var">n_pats</span></a></span><span>
</span><span id="line-1908"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942097"><span class="annot"><a href="#local-6989586621682942097"><span class="hs-identifier hs-var">spec_usgs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942098"><span class="annot"><a href="#local-6989586621682942098"><span class="hs-identifier hs-var">new_specs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942099"><span class="annot"><a href="#local-6989586621682942099"><span class="hs-identifier hs-var">new_wss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapAndUnzip3M"><span class="hs-identifier hs-type">mapAndUnzip3M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#spec_one"><span class="hs-identifier hs-type">spec_one</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942096"><span class="hs-identifier hs-type">spec_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942077"><span class="hs-identifier hs-type">fn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942078"><span class="hs-identifier hs-type">arg_bndrs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942079"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1909"></span><span>                                                 </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682942091"><span class="hs-identifier hs-type">new_pats</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">`zip`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682942083"><span class="hs-identifier hs-type">spec_count</span></a></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1910"></span><span>                </span><span class="hs-comment">-- See Note [Specialise original body]</span><span>
</span><span id="line-1911"></span><span>
</span><span id="line-1912"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942101"><span class="annot"><a href="#local-6989586621682942101"><span class="hs-identifier hs-var hs-var">spec_usg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ScUsage] -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsages"><span class="hs-identifier hs-var">combineUsages</span></a></span><span> </span><span class="annot"><span class="annottext">[ScUsage]
</span><a href="#local-6989586621682942097"><span class="hs-identifier hs-var">spec_usgs</span></a></span><span>
</span><span id="line-1913"></span><span>
</span><span id="line-1914"></span><span>              </span><span id="local-6989586621682942102"><span class="annot"><a href="#local-6989586621682942102"><span class="hs-identifier hs-var hs-var">unspec_rhs_needed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682942090"><span class="hs-identifier hs-var">pats_discarded</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682942089"><span class="hs-identifier hs-var">boring_call</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942077"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1915"></span><span>
</span><span id="line-1916"></span><span>              </span><span class="hs-comment">-- If there were any boring calls among the seeds (= all_calls), then those</span><span>
</span><span id="line-1917"></span><span>              </span><span class="hs-comment">-- calls will call the un-specialised function.  So we should use the seeds</span><span>
</span><span id="line-1918"></span><span>              </span><span class="hs-comment">-- from the _unspecialised_ function's RHS, which are in mb_unspec, by returning</span><span>
</span><span id="line-1919"></span><span>              </span><span class="hs-comment">-- then in new_usg.</span><span>
</span><span id="line-1920"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682942104"><span class="annot"><a href="#local-6989586621682942104"><span class="hs-identifier hs-var">new_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942105"><span class="annot"><a href="#local-6989586621682942105"><span class="hs-identifier hs-var">mb_unspec'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682942084"><span class="hs-identifier hs-type">mb_unspec</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1921"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682942106"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942106"><span class="hs-identifier hs-var">rhs_usg</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682942102"><span class="hs-identifier hs-var">unspec_rhs_needed</span></a></span><span>
</span><span id="line-1922"></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942101"><span class="hs-identifier hs-var">spec_usg</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage -&gt; ScUsage -&gt; ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#combineUsage"><span class="hs-operator hs-var">`combineUsage`</span></a></span><span> </span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942106"><span class="hs-identifier hs-var">rhs_usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ScUsage
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1923"></span><span>                  </span><span class="annot"><span class="annottext">Maybe ScUsage
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942101"><span class="hs-identifier hs-var">spec_usg</span></a></span><span class="hs-special">,</span><span>                      </span><span class="annot"><span class="annottext">Maybe ScUsage
</span><a href="#local-6989586621682942084"><span class="hs-identifier hs-var">mb_unspec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1924"></span><span>
</span><span id="line-1925"></span><span class="hs-comment">--        ; pprTraceM &quot;specialise return }&quot; $</span><span>
</span><span id="line-1926"></span><span class="hs-comment">--          vcat [ ppr fn</span><span>
</span><span id="line-1927"></span><span class="hs-comment">--               , text &quot;unspec_rhs_needed:&quot; &lt;+&gt; ppr unspec_rhs_needed</span><span>
</span><span id="line-1928"></span><span class="hs-comment">--               , text &quot;new calls:&quot; &lt;+&gt; ppr (scu_calls new_usg)]</span><span>
</span><span id="line-1929"></span><span>
</span><span id="line-1930"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682942104"><span class="hs-identifier hs-type">new_usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SI"><span class="hs-identifier hs-type">SI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#si_specs"><span class="hs-identifier hs-var">si_specs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942098"><span class="hs-identifier hs-type">new_specs</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682942082"><span class="hs-identifier hs-type">specs</span></a></span><span>
</span><span id="line-1931"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#si_n_specs"><span class="hs-identifier hs-var">si_n_specs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942083"><span class="hs-identifier hs-type">spec_count</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">+</span></span><span> </span><span class="annot"><a href="#local-6989586621682942094"><span class="hs-identifier hs-type">n_pats</span></a></span><span>
</span><span id="line-1932"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#si_mb_unspec"><span class="hs-identifier hs-var">si_mb_unspec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942105"><span class="hs-identifier hs-type">mb_unspec'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1933"></span><span>                 </span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682942092"><span class="hs-identifier hs-type">warnings</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">concat</span></span><span> </span><span class="annot"><a href="#local-6989586621682942099"><span class="hs-identifier hs-type">new_wss</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1934"></span><span>
</span><span id="line-1935"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-comment">-- No calls, inactive, or not a function</span><span>
</span><span id="line-1936"></span><span>               </span><span class="hs-comment">-- Behave as if there was a single, boring call</span><span>
</span><span id="line-1937"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;specialise inactive&quot; (ppr fn $$ ppr mb_unspec) $</span><span>
</span><span id="line-1938"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ScUsage
</span><a href="#local-6989586621682942084"><span class="hs-identifier hs-var">mb_unspec</span></a></span><span> </span><span class="hs-keyword">of</span><span>    </span><span class="hs-comment">-- Behave as if there was a single, boring call</span><span>
</span><span id="line-1939"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682942107"><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942107"><span class="hs-identifier hs-var">rhs_usg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ScUsage, SpecInfo, [SpecFailWarning])
-&gt; UniqSM (ScUsage, SpecInfo, [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="#local-6989586621682942107"><span class="hs-identifier hs-var">rhs_usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpecInfo
</span><a href="#local-6989586621682942081"><span class="hs-identifier hs-var">spec_info</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#si_mb_unspec"><span class="hs-identifier hs-var">si_mb_unspec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1940"></span><span>                         </span><span class="hs-comment">-- See Note [spec_usg includes rhs_usg]</span><span>
</span><span id="line-1941"></span><span>      </span><span class="annot"><span class="annottext">Maybe ScUsage
</span><span class="hs-identifier hs-var">Nothing</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ScUsage, SpecInfo, [SpecFailWarning])
-&gt; UniqSM (ScUsage, SpecInfo, [SpecFailWarning])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScUsage
</span><a href="GHC.Core.Opt.SpecConstr.html#nullUsage"><span class="hs-identifier hs-var">nullUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpecInfo
</span><a href="#local-6989586621682942081"><span class="hs-identifier hs-var">spec_info</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1942"></span><span>
</span><span id="line-1943"></span><span>
</span><span id="line-1944"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-1945"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#spec_one"><span class="hs-identifier hs-type">spec_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-1946"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>       </span><span class="hs-comment">-- Function</span><span>
</span><span id="line-1947"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Lambda-binders of RHS; should match patterns</span><span>
</span><span id="line-1948"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>      </span><span class="hs-comment">-- Body of the original function</span><span>
</span><span id="line-1949"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-1950"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScUsage"><span class="hs-identifier hs-type">ScUsage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#OneSpec"><span class="hs-identifier hs-type">OneSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Rule and binding, warnings if any</span><span>
</span><span id="line-1951"></span><span>
</span><span id="line-1952"></span><span class="hs-comment">-- spec_one creates a specialised copy of the function, together</span><span>
</span><span id="line-1953"></span><span class="hs-comment">-- with a rule for using it.  I'm very proud of how short this</span><span>
</span><span id="line-1954"></span><span class="hs-comment">-- function is, considering what it does :-).</span><span>
</span><span id="line-1955"></span><span>
</span><span id="line-1956"></span><span class="hs-comment">{-
  Example

     In-scope: a, x::a
     f = /\b \y::[(a,b)] -&gt; ....f (b,c) ((:) (a,(b,c)) (x,v) (h w))...
          [c::*, v::(b,c) are presumably bound by the (...) part]
  ==&gt;
     f_spec = /\ b c \ v::(b,c) hw::[(a,(b,c))] -&gt;
                  (...entire body of f...) [b -&gt; (b,c),
                                            y -&gt; ((:) (a,(b,c)) (x,v) hw)]

     RULE:  forall b::* c::*,           -- Note, *not* forall a, x
                   v::(b,c),
                   hw::[(a,(b,c))] .

            f (b,c) ((:) (a,(b,c)) (x,v) hw) = f_spec b c v hw
-}</span><span>
</span><span id="line-1973"></span><span>
</span><span id="line-1974"></span><span id="spec_one"><span class="annot"><span class="annottext">spec_one :: ScEnv
-&gt; Id
-&gt; [Id]
-&gt; Expr Id
-&gt; (CallPat, Int)
-&gt; UniqSM (ScUsage, OneSpec, [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#spec_one"><span class="hs-identifier hs-var hs-var">spec_one</span></a></span></span><span> </span><span id="local-6989586621682942108"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942108"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942109"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942109"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682942110"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942110"><span class="hs-identifier hs-var">arg_bndrs</span></a></span></span><span> </span><span id="local-6989586621682942111"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942111"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942112"><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942112"><span class="hs-identifier hs-var">call_pat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942113"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942113"><span class="hs-identifier hs-var">rule_number</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1975"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CP"><span class="hs-identifier hs-type">CP</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cp_qvars :: CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_qvars"><span class="hs-identifier hs-var">cp_qvars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942116"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942116"><span class="hs-identifier hs-var">qvars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_args :: CallPat -&gt; [Expr Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_args"><span class="hs-identifier hs-var">cp_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942118"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942118"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_strict_args :: CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_strict_args"><span class="hs-identifier hs-var">cp_strict_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942120"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942120"><span class="hs-identifier hs-var">cbv_args</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942112"><span class="hs-identifier hs-var">call_pat</span></a></span><span>
</span><span id="line-1976"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- pprTraceM &quot;spec_one {&quot; (ppr fn &lt;+&gt; ppr pats)</span><span>
</span><span id="line-1977"></span><span>
</span><span id="line-1978"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682942121"><span class="annot"><a href="#local-6989586621682942121"><span class="hs-identifier hs-var">spec_uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-1979"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942123"><span class="annot"><a href="#local-6989586621682942123"><span class="hs-identifier hs-var hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; [(Id, Expr Id)] -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendScSubstList"><span class="hs-identifier hs-var">extendScSubstList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; [Id] -&gt; ScEnv
</span><a href="GHC.Core.Opt.SpecConstr.html#extendScInScope"><span class="hs-identifier hs-var">extendScInScope</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942108"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942116"><span class="hs-identifier hs-var">qvars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1980"></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942110"><span class="hs-identifier hs-var">arg_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Expr Id] -&gt; [(Id, Expr Id)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942118"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1981"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682942124"><span class="annot"><a href="#local-6989586621682942124"><span class="hs-identifier hs-var">body_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942125"><span class="annot"><a href="#local-6989586621682942125"><span class="hs-identifier hs-var">extra_bndrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#extendBndrs"><span class="hs-identifier hs-type">extendBndrs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942123"><span class="hs-identifier hs-type">env1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Misc.html#dropList"><span class="hs-identifier hs-type">dropList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942118"><span class="hs-identifier hs-type">pats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942110"><span class="hs-identifier hs-type">arg_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1982"></span><span>              </span><span class="hs-comment">-- Remember, there may be fewer pats than arg_bndrs</span><span>
</span><span id="line-1983"></span><span>              </span><span class="hs-comment">-- See Note [SpecConstr call patterns]</span><span>
</span><span id="line-1984"></span><span>              </span><span class="hs-comment">-- extra_bndrs will then be arguments in the specialized version</span><span>
</span><span id="line-1985"></span><span>              </span><span class="hs-comment">-- which are *not* applied to arguments immediately at the call sites.</span><span>
</span><span id="line-1986"></span><span>              </span><span class="hs-comment">-- e.g. let f x y = ... in map (f True) xs</span><span>
</span><span id="line-1987"></span><span>              </span><span class="hs-comment">-- will result in y becoming an extra_bndr</span><span>
</span><span id="line-1988"></span><span>
</span><span id="line-1989"></span><span>              </span><span id="local-6989586621682942126"><span class="annot"><a href="#local-6989586621682942126"><span class="hs-identifier hs-var hs-var">fn_name</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942109"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1990"></span><span>              </span><span id="local-6989586621682942128"><span class="annot"><a href="#local-6989586621682942128"><span class="hs-identifier hs-var hs-var">fn_loc</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#nameSrcSpan"><span class="hs-identifier hs-var">nameSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682942126"><span class="hs-identifier hs-var">fn_name</span></a></span><span>
</span><span id="line-1991"></span><span>              </span><span id="local-6989586621682942130"><span class="annot"><a href="#local-6989586621682942130"><span class="hs-identifier hs-var hs-var">fn_occ</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OccName
</span><a href="GHC.Types.Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682942126"><span class="hs-identifier hs-var">fn_name</span></a></span><span>
</span><span id="line-1992"></span><span>              </span><span id="local-6989586621682942132"><span class="annot"><a href="#local-6989586621682942132"><span class="hs-identifier hs-var hs-var">spec_occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkSpecOcc"><span class="hs-identifier hs-var">mkSpecOcc</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621682942130"><span class="hs-identifier hs-var">fn_occ</span></a></span><span>
</span><span id="line-1993"></span><span>              </span><span class="hs-comment">-- We use fn_occ rather than fn in the rule_name string</span><span>
</span><span id="line-1994"></span><span>              </span><span class="hs-comment">-- as we don't want the uniq to end up in the rule, and</span><span>
</span><span id="line-1995"></span><span>              </span><span class="hs-comment">-- hence in the ABI, as that can cause spurious ABI</span><span>
</span><span id="line-1996"></span><span>              </span><span class="hs-comment">-- changes (#4012).</span><span>
</span><span id="line-1997"></span><span>              </span><span id="local-6989586621682942134"><span class="annot"><a href="#local-6989586621682942134"><span class="hs-identifier hs-var hs-var">rule_name</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SC:&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">OccName -&gt; String
</span><a href="GHC.Types.Name.Occurrence.html#occNameString"><span class="hs-identifier hs-var">occNameString</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621682942130"><span class="hs-identifier hs-var">fn_occ</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942113"><span class="hs-identifier hs-var">rule_number</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1998"></span><span>              </span><span id="local-6989586621682942138"><span class="annot"><a href="#local-6989586621682942138"><span class="hs-identifier hs-var hs-var">spec_name</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; OccName -&gt; SrcSpan -&gt; Name
</span><a href="GHC.Types.Name.html#mkInternalName"><span class="hs-identifier hs-var">mkInternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621682942121"><span class="hs-identifier hs-var">spec_uniq</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621682942132"><span class="hs-identifier hs-var">spec_occ</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682942128"><span class="hs-identifier hs-var">fn_loc</span></a></span><span>
</span><span id="line-1999"></span><span>
</span><span id="line-2000"></span><span>        </span><span class="hs-comment">-- Specialise the body</span><span>
</span><span id="line-2001"></span><span>        </span><span class="hs-comment">-- ; pprTraceM &quot;body_subst_for&quot; $ ppr (spec_occ) $$ ppr (sc_subst body_env)</span><span>
</span><span id="line-2002"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942140"><span class="annot"><a href="#local-6989586621682942140"><span class="hs-identifier hs-var">spec_usg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942141"><span class="annot"><a href="#local-6989586621682942141"><span class="hs-identifier hs-var">spec_body</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942142"><span class="annot"><a href="#local-6989586621682942142"><span class="hs-identifier hs-var">body_warnings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#scExpr"><span class="hs-identifier hs-type">scExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942124"><span class="hs-identifier hs-type">body_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942111"><span class="hs-identifier hs-type">body</span></a></span><span>
</span><span id="line-2003"></span><span>
</span><span id="line-2004"></span><span>                </span><span class="hs-comment">-- And build the results</span><span>
</span><span id="line-2005"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942143"><span class="annot"><a href="#local-6989586621682942143"><span class="hs-identifier hs-var">qvars'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942144"><span class="annot"><a href="#local-6989586621682942144"><span class="hs-identifier hs-var">pats'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#generaliseDictPats"><span class="hs-identifier hs-type">generaliseDictPats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942116"><span class="hs-identifier hs-type">qvars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942118"><span class="hs-identifier hs-type">pats</span></a></span><span>
</span><span id="line-2006"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942146"><span class="annot"><a href="#local-6989586621682942146"><span class="hs-identifier hs-var hs-var">spec_body_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Expr Id -&gt; InType
Expr Id -&gt; InType
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942141"><span class="hs-identifier hs-var">spec_body</span></a></span><span>
</span><span id="line-2007"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682942148"><span class="annot"><a href="#local-6989586621682942148"><span class="hs-identifier hs-var">spec_lam_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942149"><span class="annot"><a href="#local-6989586621682942149"><span class="hs-identifier hs-var">spec_call_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942150"><span class="annot"><a href="#local-6989586621682942150"><span class="hs-identifier hs-var">spec_sig</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2008"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#calcSpecInfo"><span class="hs-identifier hs-type">calcSpecInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942109"><span class="hs-identifier hs-type">fn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942110"><span class="hs-identifier hs-type">arg_bndrs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942112"><span class="hs-identifier hs-type">call_pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942125"><span class="hs-identifier hs-type">extra_bndrs</span></a></span><span>
</span><span id="line-2009"></span><span>
</span><span id="line-2010"></span><span>              </span><span id="local-6989586621682942152"><span class="annot"><a href="#local-6989586621682942152"><span class="hs-identifier hs-var hs-var">spec_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942148"><span class="hs-identifier hs-var">spec_lam_args</span></a></span><span>
</span><span id="line-2011"></span><span>              </span><span id="local-6989586621682942155"><span class="annot"><a href="#local-6989586621682942155"><span class="hs-identifier hs-var hs-var">spec_join_arity</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942109"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; JoinPointHood
</span><a href="GHC.Utils.Outputable.html#JoinPoint"><span class="hs-identifier hs-var">JoinPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942149"><span class="hs-identifier hs-var">spec_call_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2012"></span><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="GHC.Utils.Outputable.html#NotJoinPoint"><span class="hs-identifier hs-var">NotJoinPoint</span></a></span><span>
</span><span id="line-2013"></span><span>              </span><span id="local-6989586621682942159"><span class="annot"><a href="#local-6989586621682942159"><span class="hs-identifier hs-var hs-var">spec_id</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Types.Id.html#asWorkerLikeId"><span class="hs-identifier hs-var">asWorkerLikeId</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; Id -&gt; Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2014"></span><span>                           </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; InType -&gt; InType -&gt; Id
Name -&gt; InType -&gt; InType -&gt; Id
</span><a href="GHC.Types.Id.html#mkLocalId"><span class="hs-identifier hs-var">mkLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682942138"><span class="hs-identifier hs-var">spec_name</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span>
</span><span id="line-2015"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; InType -&gt; InType
</span><a href="GHC.Core.Utils.html#mkLamTypes"><span class="hs-identifier hs-var">mkLamTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942148"><span class="hs-identifier hs-var">spec_lam_args</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682942146"><span class="hs-identifier hs-var">spec_body_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2016"></span><span>                             </span><span class="hs-comment">-- See Note [Transfer strictness]</span><span>
</span><span id="line-2017"></span><span>                             </span><span class="annot"><span class="annottext">Id -&gt; DmdSig -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDmdSig"><span class="hs-operator hs-var">`setIdDmdSig`</span></a></span><span>    </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621682942150"><span class="hs-identifier hs-var">spec_sig</span></a></span><span>
</span><span id="line-2018"></span><span>                             </span><span class="annot"><span class="annottext">Id -&gt; CprSig -&gt; Id
</span><a href="GHC.Types.Id.html#setIdCprSig"><span class="hs-operator hs-var">`setIdCprSig`</span></a></span><span>    </span><span class="annot"><span class="annottext">CprSig
</span><a href="GHC.Types.Cpr.html#topCprSig"><span class="hs-identifier hs-var">topCprSig</span></a></span><span>
</span><span id="line-2019"></span><span>                             </span><span class="annot"><span class="annottext">Id -&gt; Int -&gt; Id
</span><a href="GHC.Types.Id.html#setIdArity"><span class="hs-operator hs-var">`setIdArity`</span></a></span><span>     </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942152"><span class="hs-identifier hs-var">spec_arity</span></a></span><span>
</span><span id="line-2020"></span><span>                             </span><span class="annot"><span class="annottext">Id -&gt; JoinPointHood -&gt; Id
</span><a href="GHC.Types.Id.html#asJoinId_maybe"><span class="hs-operator hs-var">`asJoinId_maybe`</span></a></span><span> </span><span class="annot"><span class="annottext">JoinPointHood
</span><a href="#local-6989586621682942155"><span class="hs-identifier hs-var">spec_join_arity</span></a></span><span>
</span><span id="line-2021"></span><span>
</span><span id="line-2022"></span><span>        </span><span class="hs-comment">-- Conditionally use result of new worker-wrapper transform</span><span>
</span><span id="line-2023"></span><span>        </span><span class="hs-comment">-- mkSeqs: see Note [SpecConstr and strict fields]</span><span>
</span><span id="line-2024"></span><span>              </span><span id="local-6989586621682942169"><span class="annot"><a href="#local-6989586621682942169"><span class="hs-identifier hs-var hs-var">spec_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Expr Id -&gt; Expr Id
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942148"><span class="hs-identifier hs-var">spec_lam_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; InType -&gt; Expr Id -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#mkSeqs"><span class="hs-identifier hs-var">mkSeqs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942120"><span class="hs-identifier hs-var">cbv_args</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682942146"><span class="hs-identifier hs-var">spec_body_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942141"><span class="hs-identifier hs-var">spec_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2025"></span><span>              </span><span id="local-6989586621682942171"><span class="annot"><a href="#local-6989586621682942171"><span class="hs-identifier hs-var hs-var">rule_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; [Id] -&gt; Expr Id
forall b. Expr b -&gt; [Id] -&gt; Expr b
</span><a href="GHC.Core.html#mkVarApps"><span class="hs-identifier hs-var">mkVarApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Expr Id
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942159"><span class="hs-identifier hs-var">spec_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942149"><span class="hs-identifier hs-var">spec_call_args</span></a></span><span>
</span><span id="line-2026"></span><span>              </span><span id="local-6989586621682942173"><span class="annot"><a href="#local-6989586621682942173"><span class="hs-identifier hs-var hs-var">inline_act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942109"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-2027"></span><span>              </span><span id="local-6989586621682942174"><span class="annot"><a href="#local-6989586621682942174"><span class="hs-identifier hs-var hs-var">this_mod</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Module
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_module"><span class="hs-identifier hs-var">sc_module</span></a></span><span> </span><span class="annot"><span class="annottext">(SpecConstrOpts -&gt; Module) -&gt; SpecConstrOpts -&gt; Module
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942108"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2028"></span><span>              </span><span id="local-6989586621682942175"><span class="annot"><a href="#local-6989586621682942175"><span class="hs-identifier hs-var hs-var">rule</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
-&gt; Bool
-&gt; Bool
-&gt; FastString
-&gt; Activation
-&gt; Name
-&gt; [Id]
-&gt; [Expr Id]
-&gt; Expr Id
-&gt; CoreRule
</span><a href="GHC.Core.Rules.html#mkRule"><span class="hs-identifier hs-var">mkRule</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682942174"><span class="hs-identifier hs-var">this_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">{- Auto -}</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">{- Local -}</span><span>
</span><span id="line-2029"></span><span>                                  </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682942134"><span class="hs-identifier hs-var">rule_name</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621682942173"><span class="hs-identifier hs-var">inline_act</span></a></span><span>
</span><span id="line-2030"></span><span>                                  </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682942126"><span class="hs-identifier hs-var">fn_name</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942143"><span class="hs-identifier hs-var">qvars'</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942144"><span class="hs-identifier hs-var">pats'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942171"><span class="hs-identifier hs-var">rule_rhs</span></a></span><span>
</span><span id="line-2031"></span><span>                           </span><span class="hs-comment">-- See Note [Transfer activation]</span><span>
</span><span id="line-2032"></span><span>
</span><span id="line-2033"></span><span class="hs-comment">--        ; pprTraceM &quot;spec_one end }&quot; $</span><span>
</span><span id="line-2034"></span><span class="hs-comment">--          vcat [ text &quot;function:&quot; &lt;+&gt; ppr fn &lt;+&gt; braces (ppr (idUnique fn))</span><span>
</span><span id="line-2035"></span><span class="hs-comment">--               , text &quot;pats:&quot; &lt;+&gt; ppr pats</span><span>
</span><span id="line-2036"></span><span class="hs-comment">--               , text &quot;call_pat:&quot; &lt;+&gt; ppr call_pat</span><span>
</span><span id="line-2037"></span><span class="hs-comment">--               , text &quot;--&gt;&quot; &lt;+&gt; ppr spec_name</span><span>
</span><span id="line-2038"></span><span class="hs-comment">--               , text &quot;bndrs&quot; &lt;+&gt; ppr arg_bndrs</span><span>
</span><span id="line-2039"></span><span class="hs-comment">--               , text &quot;extra_bndrs&quot; &lt;+&gt; ppr extra_bndrs</span><span>
</span><span id="line-2040"></span><span class="hs-comment">--               , text &quot;cbv_args&quot; &lt;+&gt; ppr cbv_args</span><span>
</span><span id="line-2041"></span><span class="hs-comment">--               , text &quot;spec_lam_args&quot; &lt;+&gt; ppr spec_lam_args</span><span>
</span><span id="line-2042"></span><span class="hs-comment">--               , text &quot;spec_call_args&quot; &lt;+&gt; ppr spec_call_args</span><span>
</span><span id="line-2043"></span><span class="hs-comment">--               , text &quot;rule_rhs&quot; &lt;+&gt; ppr rule_rhs</span><span>
</span><span id="line-2044"></span><span class="hs-comment">--               , text &quot;adds_void_worker_arg&quot; &lt;+&gt; ppr add_void_arg</span><span>
</span><span id="line-2045"></span><span class="hs-comment">----               , text &quot;body&quot; &lt;+&gt; ppr body</span><span>
</span><span id="line-2046"></span><span class="hs-comment">----               , text &quot;spec_rhs&quot; &lt;+&gt; ppr spec_rhs</span><span>
</span><span id="line-2047"></span><span class="hs-comment">----               , text &quot;how_bound&quot; &lt;+&gt; ppr (sc_how_bound env) ]</span><span>
</span><span id="line-2048"></span><span class="hs-comment">--               ]</span><span>
</span><span id="line-2049"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682942140"><span class="hs-identifier hs-type">spec_usg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#OS"><span class="hs-identifier hs-type">OS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#os_pat"><span class="hs-identifier hs-var">os_pat</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942112"><span class="hs-identifier hs-type">call_pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#os_rule"><span class="hs-identifier hs-var">os_rule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942175"><span class="hs-identifier hs-type">rule</span></a></span><span>
</span><span id="line-2050"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#os_id"><span class="hs-identifier hs-var">os_id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942159"><span class="hs-identifier hs-type">spec_id</span></a></span><span>
</span><span id="line-2051"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#os_rhs"><span class="hs-identifier hs-var">os_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942169"><span class="hs-identifier hs-type">spec_rhs</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682942142"><span class="hs-identifier hs-type">body_warnings</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2052"></span><span>
</span><span id="line-2053"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#generaliseDictPats"><span class="hs-identifier hs-type">generaliseDictPats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Quantified vars and pats</span><span>
</span><span id="line-2054"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- New quantified vars and pats</span><span>
</span><span id="line-2055"></span><span class="hs-comment">-- See Note [generaliseDictPats]</span><span>
</span><span id="line-2056"></span><span id="generaliseDictPats"><span class="annot"><span class="annottext">generaliseDictPats :: [Id] -&gt; [Expr Id] -&gt; UniqSM ([Id], [Expr Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#generaliseDictPats"><span class="hs-identifier hs-var hs-var">generaliseDictPats</span></a></span></span><span> </span><span id="local-6989586621682942177"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942177"><span class="hs-identifier hs-var">qvars</span></a></span></span><span> </span><span id="local-6989586621682942178"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942178"><span class="hs-identifier hs-var">pats</span></a></span></span><span>
</span><span id="line-2057"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942179"><span class="annot"><a href="#local-6989586621682942179"><span class="hs-identifier hs-var">extra_qvars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942180"><span class="annot"><a href="#local-6989586621682942180"><span class="hs-identifier hs-var">pats'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; Expr Id -&gt; UniqSM ([Id], Expr Id))
-&gt; [Id] -&gt; [Expr Id] -&gt; UniqSM ([Id], [Expr Id])
forall (m :: * -&gt; *) (t :: * -&gt; *) acc x y.
(Monad m, Traversable t) =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; t x -&gt; m (acc, t y)
</span><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Expr Id -&gt; UniqSM ([Id], Expr Id)
</span><a href="#local-6989586621682942182"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942178"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2058"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621682942179"><span class="hs-identifier hs-type">extra_qvars</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2059"></span><span>             </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">([Id], [Expr Id]) -&gt; UniqSM ([Id], [Expr Id])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942177"><span class="hs-identifier hs-var">qvars</span></a></span><span class="hs-special">,</span><span>                </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942178"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2060"></span><span>             </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">([Id], [Expr Id]) -&gt; UniqSM ([Id], [Expr Id])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942177"><span class="hs-identifier hs-var">qvars</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942179"><span class="hs-identifier hs-var">extra_qvars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942180"><span class="hs-identifier hs-var">pats'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2061"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2062"></span><span>    </span><span id="local-6989586621682942183"><span class="annot"><span class="annottext">qvar_set :: VarSet
</span><a href="#local-6989586621682942183"><span class="hs-identifier hs-var hs-var">qvar_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942177"><span class="hs-identifier hs-var">qvars</span></a></span><span>
</span><span id="line-2063"></span><span>    </span><span class="annot"><a href="#local-6989586621682942182"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2064"></span><span>    </span><span id="local-6989586621682942182"><span class="annot"><span class="annottext">go :: [Id] -&gt; Expr Id -&gt; UniqSM ([Id], Expr Id)
</span><a href="#local-6989586621682942182"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682942185"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942185"><span class="hs-identifier hs-var">extra_qvs</span></a></span></span><span> </span><span id="local-6989586621682942186"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942186"><span class="hs-identifier hs-var">pat</span></a></span></span><span>
</span><span id="line-2065"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Id -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTyCoArg"><span class="hs-identifier hs-var">isTyCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942186"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2066"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942188"><span class="annot"><span class="annottext">pat_ty :: InType
</span><a href="#local-6989586621682942188"><span class="hs-identifier hs-var hs-var">pat_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Expr Id -&gt; InType
Expr Id -&gt; InType
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942186"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-2067"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InType -&gt; Bool
</span><a href="GHC.Core.Predicate.html#typeDeterminesValue"><span class="hs-identifier hs-var">typeDeterminesValue</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682942188"><span class="hs-identifier hs-var">pat_ty</span></a></span><span>
</span><span id="line-2068"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942186"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#disjointVarSet"><span class="hs-operator hs-var">`disjointVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682942183"><span class="hs-identifier hs-var">qvar_set</span></a></span><span>
</span><span id="line-2069"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682942190"><span class="annot"><a href="#local-6989586621682942190"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; InType -&gt; InType -&gt; UniqSM Id
forall (m :: * -&gt; *).
MonadUnique m =&gt;
FastString -&gt; InType -&gt; InType -&gt; m Id
</span><a href="GHC.Types.Id.html#mkSysLocalOrCoVarM"><span class="hs-identifier hs-var">mkSysLocalOrCoVarM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dict&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682942188"><span class="hs-identifier hs-var">pat_ty</span></a></span><span>
</span><span id="line-2070"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682942190"><span class="hs-identifier hs-type">id</span></a></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><a href="#local-6989586621682942185"><span class="hs-identifier hs-type">extra_qvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942190"><span class="hs-identifier hs-type">id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2071"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2072"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Id], Expr Id) -&gt; UniqSM ([Id], Expr Id)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942185"><span class="hs-identifier hs-var">extra_qvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942186"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2073"></span><span>
</span><span id="line-2074"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#mkSeqs"><span class="hs-identifier hs-type">mkSeqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2075"></span><span class="hs-comment">-- See Note [SpecConstr and strict fields]</span><span>
</span><span id="line-2076"></span><span id="mkSeqs"><span class="annot"><span class="annottext">mkSeqs :: [Id] -&gt; InType -&gt; Expr Id -&gt; Expr Id
</span><a href="GHC.Core.Opt.SpecConstr.html#mkSeqs"><span class="hs-identifier hs-var hs-var">mkSeqs</span></a></span></span><span> </span><span id="local-6989586621682942193"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942193"><span class="hs-identifier hs-var">seqees</span></a></span></span><span> </span><span id="local-6989586621682942194"><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682942194"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span> </span><span id="local-6989586621682942195"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942195"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2077"></span><span>  </span><span class="annot"><span class="annottext">(Id -&gt; Expr Id -&gt; Expr Id) -&gt; Expr Id -&gt; [Id] -&gt; Expr Id
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Expr Id -&gt; Expr Id
</span><a href="#local-6989586621682942196"><span class="hs-identifier hs-var">addEval</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942195"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942193"><span class="hs-identifier hs-var">seqees</span></a></span><span>
</span><span id="line-2078"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-2079"></span><span>      </span><span class="annot"><a href="#local-6989586621682942196"><span class="hs-identifier hs-type">addEval</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2080"></span><span>      </span><span id="local-6989586621682942196"><span class="annot"><span class="annottext">addEval :: Id -&gt; Expr Id -&gt; Expr Id
</span><a href="#local-6989586621682942196"><span class="hs-identifier hs-var hs-var">addEval</span></a></span></span><span> </span><span id="local-6989586621682942197"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942197"><span class="hs-identifier hs-var">arg_id</span></a></span></span><span> </span><span id="local-6989586621682942198"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942198"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2081"></span><span>        </span><span class="hs-comment">-- Argument representing strict field and it's worth passing via cbv</span><span>
</span><span id="line-2082"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Utils.html#shouldStrictifyIdForCbv"><span class="hs-identifier hs-var">shouldStrictifyIdForCbv</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942197"><span class="hs-identifier hs-var">arg_id</span></a></span><span>
</span><span id="line-2083"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Id -&gt; InType -&gt; [Alt Id] -&gt; Expr Id
forall b. Expr b -&gt; b -&gt; InType -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Expr Id
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942197"><span class="hs-identifier hs-var">arg_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2084"></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Types.Id.html#localiseId"><span class="hs-identifier hs-var">localiseId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942197"><span class="hs-identifier hs-var">arg_id</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See (SCF1) in Note [SpecConstr and strict fields]</span><span>
</span><span id="line-2085"></span><span>               </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682942194"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-2086"></span><span>               </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; Expr Id -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942198"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2087"></span><span>
</span><span id="line-2088"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2089"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942198"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2090"></span><span>
</span><span id="line-2091"></span><span>
</span><span id="line-2092"></span><span class="hs-comment">{- Note [SpecConstr void argument insertion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider a function
    f :: Bool -&gt; forall t. blah
    f start @t = e
We want to specialize for a partially applied call `f True`.
See also Note [SpecConstr call patterns], second Wrinkle.
Naively we would expect to get
    $sf :: forall t. blah
    $sf @t = $se
    RULE: f True = $sf
The specialized function only takes a single type argument so we add a
void argument to prevent it from turning into a thunk. See Note
[Protecting the last value argument] for details why. Normally we
would add the void argument after the type argument giving us:

    $sf :: forall t. Void# -&gt; bla
    $sf @t void = $se
    RULE: f True = $sf void# (wrong)

But if you look closely this wouldn't typecheck!  If we substitute `f
True` with `$sf void#` we expect the type argument to be applied first
but we apply void# first.  The easiest fix seems to be just to add the
void argument to the front of the arguments.  Now we get:

    $sf :: Void# -&gt; forall t. bla
    $sf void @t = $se
    RULE: f True = $sf void#

And now we can substitute `f True` with `$sf void#` with everything working out nicely!

More precisely, in `calcSpecInfo`
(i)  we need the void arg to /precede/ the `extra_bndrs`, but
(ii) it must still /follow/ `qvar_bndrs`.

Example to illustrate (ii):
  f :: forall r (a :: TYPE r). Bool -&gt; a
  f = /\r. /\(a::TYPE r). \b. body

  {- Specialise for f _ _ True -}

  $sf :: forall r (a :: TYPE r). Void# -&gt; a
  $sf = /\r. /\(a::TYPE r). \v. body[True/b]
  RULE: forall r (a :: TYPE r). f @r @a True = $sf @r @a void#

The void argument must follow the foralls, lest the forall be
ill-kinded.  See Note [Worker/wrapper needs to add void arg last] in
GHC.Core.Opt.WorkWrap.Utils.

Note [generaliseDictPats]
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider these two rules (#21831, item 2):
  RULE &quot;SPEC:foo&quot;  forall d1 d2. foo @Int @Integer d1 d2 = $sfoo1
  RULE &quot;SC:foo&quot;    forall a. foo @Int @a $fNumInteger = $sfoo2 @a
The former comes from the type class specialiser, the latter from SpecConstr.
Note that $fNumInteger is a top-level binding for Num Integer.

The trouble is that neither is more general than the other.  In a call
   (foo @Int @Integer $fNumInteger d)
it isn't clear which rule to fire.

The trouble is that the SpecConstr rule fires on a /specific/ dict, $fNumInteger,
but actually /could/ fire regardless.  That is, it could be
  RULE &quot;SC:foo&quot;    forall a d. foo @Int @a d = $sfoo2 @a

Now, it is clear that SPEC:foo is more specific.  But GHC can't tell
that, because SpecConstr doesn't know that dictionary arguments are
singleton types!  So generaliseDictPats teaches it this fact.  It
spots such patterns (using typeDeterminesValue), and quantifies over
the dictionary.  Now we get

  RULE &quot;SC:foo&quot;    forall a d. foo @Int @a d = $sfoo2 @a

And /now/ &quot;SPEC:foo&quot; is clearly more specific: we can instantiate the new
&quot;SC:foo&quot; to match the (prefix of) &quot;SPEC:foo&quot;.
-}</span><span>
</span><span id="line-2168"></span><span>
</span><span id="line-2169"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#calcSpecInfo"><span class="hs-identifier hs-type">calcSpecInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>           </span><span class="hs-comment">-- The original function</span><span>
</span><span id="line-2170"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Lambda binders of original RHS</span><span>
</span><span id="line-2171"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span>      </span><span class="hs-comment">-- Call pattern</span><span>
</span><span id="line-2172"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Extra bndrs</span><span>
</span><span id="line-2173"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Demand-decorated lambda binders</span><span>
</span><span id="line-2174"></span><span>                                  </span><span class="hs-comment">--   for RHS of specialised function</span><span>
</span><span id="line-2175"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Args for call site</span><span>
</span><span id="line-2176"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span> </span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Strictness of specialised thing</span><span>
</span><span id="line-2177"></span><span class="hs-comment">-- Calculate bits of IdInfo for the specialised function</span><span>
</span><span id="line-2178"></span><span class="hs-comment">-- See Note [Transfer strictness]</span><span>
</span><span id="line-2179"></span><span class="hs-comment">-- See Note [Strictness information in worker binders]</span><span>
</span><span id="line-2180"></span><span id="calcSpecInfo"><span class="annot"><span class="annottext">calcSpecInfo :: Id -&gt; [Id] -&gt; CallPat -&gt; [Id] -&gt; ([Id], [Id], DmdSig)
</span><a href="GHC.Core.Opt.SpecConstr.html#calcSpecInfo"><span class="hs-identifier hs-var hs-var">calcSpecInfo</span></a></span></span><span> </span><span id="local-6989586621682942201"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942201"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682942202"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942202"><span class="hs-identifier hs-var">arg_bndrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CP"><span class="hs-identifier hs-type">CP</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cp_qvars :: CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_qvars"><span class="hs-identifier hs-var">cp_qvars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942203"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942203"><span class="hs-identifier hs-var">qvars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_args :: CallPat -&gt; [Expr Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_args"><span class="hs-identifier hs-var">cp_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942204"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942204"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942205"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942205"><span class="hs-identifier hs-var">extra_bndrs</span></a></span></span><span>
</span><span id="line-2181"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942206"><span class="hs-identifier hs-var">spec_lam_bndrs_w_dmds</span></a></span><span>
</span><span id="line-2182"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942207"><span class="hs-identifier hs-var">spec_call_args</span></a></span><span>
</span><span id="line-2183"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; DmdSig
</span><a href="GHC.Types.Demand.html#zapDmdEnvSig"><span class="hs-identifier hs-var">zapDmdEnvSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdType -&gt; DmdSig
</span><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-var">DmdSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621682942210"><span class="hs-identifier hs-var">dt</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Types.Demand.html#dt_args"><span class="hs-identifier hs-var">dt_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942212"><span class="hs-identifier hs-type">spec_fn_dmds</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-2184"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2185"></span><span>    </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span> </span><span id="local-6989586621682942210"><span class="annot"><span class="annottext">dt :: DmdType
</span><a href="#local-6989586621682942210"><span class="hs-identifier hs-var">dt</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">dt_args :: DmdType -&gt; [Demand]
</span><a href="GHC.Types.Demand.html#dt_args"><span class="hs-identifier hs-var">dt_args</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621682942214"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942214"><span class="hs-identifier hs-var">fn_dmds</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942201"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-2186"></span><span>    </span><span id="local-6989586621682942212"><span class="annot"><span class="annottext">spec_fn_dmds :: [Demand]
</span><a href="#local-6989586621682942212"><span class="hs-identifier hs-var hs-var">spec_fn_dmds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942217"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682942217"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942217"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942206"><span class="hs-identifier hs-var">spec_lam_bndrs_w_dmds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942217"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2187"></span><span>
</span><span id="line-2188"></span><span>    </span><span id="local-6989586621682942218"><span class="annot"><span class="annottext">val_pats :: [Expr Id]
</span><a href="#local-6989586621682942218"><span class="hs-identifier hs-var hs-var">val_pats</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Expr Id -&gt; Bool) -&gt; [Expr Id] -&gt; [Expr Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942204"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2189"></span><span>                 </span><span class="hs-comment">-- Value args at call sites, used to determine how many demands to drop</span><span>
</span><span id="line-2190"></span><span>                 </span><span class="hs-comment">-- from the original functions demand and for setting up arg_dmd_env.</span><span>
</span><span id="line-2191"></span><span>    </span><span id="local-6989586621682942221"><span class="annot"><span class="annottext">arg_dmd_env :: VarEnv Demand
</span><a href="#local-6989586621682942221"><span class="hs-identifier hs-var hs-var">arg_dmd_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv Demand -&gt; [Demand] -&gt; [Expr Id] -&gt; VarEnv Demand
</span><a href="#local-6989586621682942222"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Demand
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942214"><span class="hs-identifier hs-var">fn_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942218"><span class="hs-identifier hs-var">val_pats</span></a></span><span>
</span><span id="line-2192"></span><span>    </span><span id="local-6989586621682942223"><span class="annot"><span class="annottext">qvar_dmds :: [Demand]
</span><a href="#local-6989586621682942223"><span class="hs-identifier hs-var hs-var">qvar_dmds</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VarEnv Demand -&gt; Id -&gt; Maybe Demand
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942221"><span class="hs-identifier hs-var">arg_dmd_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942224"><span class="hs-identifier hs-var">qv</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Demand -&gt; Demand -&gt; Demand
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682942224"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942224"><span class="hs-identifier hs-var">qv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942203"><span class="hs-identifier hs-var">qvars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942224"><span class="hs-identifier hs-var">qv</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2193"></span><span>    </span><span id="local-6989586621682942226"><span class="annot"><span class="annottext">extra_dmds :: [Demand]
</span><a href="#local-6989586621682942226"><span class="hs-identifier hs-var hs-var">extra_dmds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; [Demand] -&gt; [Demand]
forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#dropList"><span class="hs-identifier hs-var">dropList</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942218"><span class="hs-identifier hs-var">val_pats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942214"><span class="hs-identifier hs-var">fn_dmds</span></a></span><span>
</span><span id="line-2194"></span><span>
</span><span id="line-2195"></span><span>    </span><span class="hs-comment">-- Annotate the variables with the strictness information from</span><span>
</span><span id="line-2196"></span><span>    </span><span class="hs-comment">-- the function (see Note [Strictness information in worker binders])</span><span>
</span><span id="line-2197"></span><span>    </span><span id="local-6989586621682942227"><span class="annot"><span class="annottext">qvars_w_dmds :: [Id]
</span><a href="#local-6989586621682942227"><span class="hs-identifier hs-var hs-var">qvars_w_dmds</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Demand] -&gt; [Id]
</span><a href="#local-6989586621682942228"><span class="hs-identifier hs-var">set_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942203"><span class="hs-identifier hs-var">qvars</span></a></span><span>       </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942223"><span class="hs-identifier hs-var">qvar_dmds</span></a></span><span>
</span><span id="line-2198"></span><span>    </span><span id="local-6989586621682942229"><span class="annot"><span class="annottext">extras_w_dmds :: [Id]
</span><a href="#local-6989586621682942229"><span class="hs-identifier hs-var hs-var">extras_w_dmds</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Demand] -&gt; [Id]
</span><a href="#local-6989586621682942228"><span class="hs-identifier hs-var">set_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942205"><span class="hs-identifier hs-var">extra_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942226"><span class="hs-identifier hs-var">extra_dmds</span></a></span><span>
</span><span id="line-2199"></span><span>    </span><span id="local-6989586621682942206"><span class="annot"><span class="annottext">spec_lam_bndrs_w_dmds :: [Id]
</span><a href="#local-6989586621682942206"><span class="hs-identifier hs-var hs-var">spec_lam_bndrs_w_dmds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942230"><span class="hs-identifier hs-var">final_qvars_w_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942229"><span class="hs-identifier hs-var">extras_w_dmds</span></a></span><span>
</span><span id="line-2200"></span><span>
</span><span id="line-2201"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682942230"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942230"><span class="hs-identifier hs-var">final_qvars_w_dmds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942207"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942207"><span class="hs-identifier hs-var">spec_call_args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2202"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id] -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#needsVoidWorkerArg"><span class="hs-identifier hs-var">needsVoidWorkerArg</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942201"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942202"><span class="hs-identifier hs-var">arg_bndrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942203"><span class="hs-identifier hs-var">qvars</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942205"><span class="hs-identifier hs-var">extra_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2203"></span><span>         </span><span class="hs-comment">-- Usual w/w hack to avoid generating</span><span>
</span><span id="line-2204"></span><span>         </span><span class="hs-comment">-- a spec_rhs of unlifted or ill-kinded type and no args.</span><span>
</span><span id="line-2205"></span><span>         </span><span class="hs-comment">-- See Note [SpecConstr void argument insertion]</span><span>
</span><span id="line-2206"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942227"><span class="hs-identifier hs-var">qvars_w_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Types.Id.Make.html#voidArgId"><span class="hs-identifier hs-var">voidArgId</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942203"><span class="hs-identifier hs-var">qvars</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Types.Id.Make.html#voidPrimId"><span class="hs-identifier hs-var">voidPrimId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-2207"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2208"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942227"><span class="hs-identifier hs-var">qvars_w_dmds</span></a></span><span class="hs-special">,</span><span>                </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942203"><span class="hs-identifier hs-var">qvars</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-2209"></span><span>
</span><span id="line-2210"></span><span>    </span><span class="annot"><a href="#local-6989586621682942228"><span class="hs-identifier hs-type">set_dmds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2211"></span><span>    </span><span id="local-6989586621682942228"><span class="annot"><span class="annottext">set_dmds :: [Id] -&gt; [Demand] -&gt; [Id]
</span><a href="#local-6989586621682942228"><span class="hs-identifier hs-var hs-var">set_dmds</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2212"></span><span>    </span><span class="annot"><a href="#local-6989586621682942228"><span class="hs-identifier hs-var">set_dmds</span></a></span><span> </span><span id="local-6989586621682942232"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942232"><span class="hs-identifier hs-var">vs</span></a></span></span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942232"><span class="hs-identifier hs-var">vs</span></a></span><span>  </span><span class="hs-comment">-- Run out of demands</span><span>
</span><span id="line-2213"></span><span>    </span><span class="annot"><a href="#local-6989586621682942228"><span class="hs-identifier hs-var">set_dmds</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942233"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942233"><span class="hs-identifier hs-var">v</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682942234"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942234"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942235"><span class="annot"><span class="annottext">ds :: [Demand]
</span><a href="#local-6989586621682942235"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621682942236"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682942236"><span class="hs-identifier hs-var">d</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682942237"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942237"><span class="hs-identifier hs-var">ds'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942233"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942233"><span class="hs-identifier hs-var">v</span></a></span><span>                   </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Demand] -&gt; [Id]
</span><a href="#local-6989586621682942228"><span class="hs-identifier hs-var">set_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942234"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942235"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-2214"></span><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-identifier hs-var">setIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942233"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682942236"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Demand] -&gt; [Id]
</span><a href="#local-6989586621682942228"><span class="hs-identifier hs-var">set_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942234"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942237"><span class="hs-identifier hs-var">ds'</span></a></span><span>
</span><span id="line-2215"></span><span>
</span><span id="line-2216"></span><span>    </span><span class="annot"><a href="#local-6989586621682942222"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-2217"></span><span>    </span><span class="hs-comment">-- We've filtered out all the type patterns already</span><span>
</span><span id="line-2218"></span><span>    </span><span id="local-6989586621682942222"><span class="annot"><span class="annottext">go :: VarEnv Demand -&gt; [Demand] -&gt; [Expr Id] -&gt; VarEnv Demand
</span><a href="#local-6989586621682942222"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621682942239"><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942239"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942240"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682942240"><span class="hs-identifier hs-var">d</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682942241"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942241"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942242"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942242"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682942243"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942243"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv Demand -&gt; [Demand] -&gt; [Expr Id] -&gt; VarEnv Demand
</span><a href="#local-6989586621682942222"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarEnv Demand -&gt; Demand -&gt; Expr Id -&gt; VarEnv Demand
</span><a href="#local-6989586621682942244"><span class="hs-identifier hs-var">go_one</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942239"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682942240"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942242"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942241"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942243"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2219"></span><span>    </span><span class="annot"><a href="#local-6989586621682942222"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621682942245"><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942245"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><span class="hs-identifier">_</span></span><span>      </span><span class="annot"><span class="annottext">[Expr Id]
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942245"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2220"></span><span>
</span><span id="line-2221"></span><span>    </span><span class="annot"><a href="#local-6989586621682942244"><span class="hs-identifier hs-type">go_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-2222"></span><span>    </span><span id="local-6989586621682942244"><span class="annot"><span class="annottext">go_one :: VarEnv Demand -&gt; Demand -&gt; Expr Id -&gt; VarEnv Demand
</span><a href="#local-6989586621682942244"><span class="hs-identifier hs-var hs-var">go_one</span></a></span></span><span> </span><span id="local-6989586621682942246"><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942246"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942247"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682942247"><span class="hs-identifier hs-var">d</span></a></span></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682942248"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942248"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Demand -&gt; Demand -&gt; Demand)
-&gt; VarEnv Demand -&gt; Id -&gt; Demand -&gt; VarEnv Demand
forall a. (a -&gt; a -&gt; a) -&gt; VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv_C"><span class="hs-identifier hs-var">extendVarEnv_C</span></a></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#plusDmd"><span class="hs-identifier hs-var">plusDmd</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942246"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942248"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621682942247"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-2223"></span><span>    </span><span class="annot"><a href="#local-6989586621682942244"><span class="hs-identifier hs-var">go_one</span></a></span><span> </span><span id="local-6989586621682942251"><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942251"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942252"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621682942252"><span class="hs-identifier hs-var">_n</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span id="local-6989586621682942254"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682942254"><span class="hs-identifier hs-var">cd</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942255"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942255"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-comment">-- NB: _n does not have to be strict</span><span>
</span><span id="line-2224"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942256"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942256"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; (Expr Id, [Expr Id])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942255"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2225"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942257"><span class="annot"><span class="annottext">Boxity
</span><a href="#local-6989586621682942257"><span class="hs-identifier hs-var">_b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942258"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942258"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SubDemand -&gt; Maybe (Boxity, [Demand])
</span><a href="GHC.Types.Demand.html#viewProd"><span class="hs-identifier hs-var">viewProd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Expr Id] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942256"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621682942254"><span class="hs-identifier hs-var">cd</span></a></span><span> </span><span class="hs-comment">-- TODO: We may want to look at boxity _b, though...</span><span>
</span><span id="line-2226"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv Demand -&gt; [Demand] -&gt; [Expr Id] -&gt; VarEnv Demand
</span><a href="#local-6989586621682942222"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942251"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621682942258"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942256"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2227"></span><span>    </span><span class="annot"><a href="#local-6989586621682942244"><span class="hs-identifier hs-var">go_one</span></a></span><span> </span><span id="local-6989586621682942260"><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942260"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">Demand
</span><span class="hs-identifier">_</span></span><span>  </span><span class="annot"><span class="annottext">Expr Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv Demand
</span><a href="#local-6989586621682942260"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2228"></span><span>
</span><span id="line-2229"></span><span class="hs-comment">{-
Note [spec_usg includes rhs_usg]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In calls to 'specialise', the returned ScUsage must include the rhs_usg in
the passed-in SpecInfo in si_mb_unspec, unless there are no calls at all to
the function.

The caller can, indeed must, assume this.  They should not combine in rhs_usg
themselves, or they'll get rhs_usg twice -- and that can lead to an exponential
blowup of duplicates in the CallEnv.  This is what gave rise to the massive
performance loss in #8852.

Note [Specialise original body]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The RhsInfo for a binding keeps the *original* body of the binding.  We
must specialise that, *not* the result of applying specExpr to the RHS
(which is also kept in RhsInfo). Otherwise we end up specialising a
specialised RHS, and that can lead directly to exponential behaviour.

Note [Transfer activation]
~~~~~~~~~~~~~~~~~~~~~~~~~~
  This note is for SpecConstr, but exactly the same thing
  happens in the overloading specialiser; see
  Note [Auto-specialisation and RULES] in GHC.Core.Opt.Specialise.

In which phase should the specialise-constructor rules be active?
Originally I made them always-active, but Manuel found that this
defeated some clever user-written rules.  Then I made them active only
in FinalPhase; after all, currently, the specConstr transformation is
only run after the simplifier has reached FinalPhase, but that meant
that specialisations didn't fire inside wrappers; see test
simplCore/should_compile/spec-inline.

So now I just use the inline-activation of the parent Id, as the
activation for the specialisation RULE, just like the main specialiser;

This in turn means there is no point in specialising NOINLINE things,
so we test for that.

Note [Transfer strictness]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We must transfer strictness information from the original function to
the specialised one.  Suppose, for example

  f has strictness     SSx
        and a RULE     f (a:as) b = f_spec a as b

Now we want f_spec to have strictness  LLSx, otherwise we'll use call-by-need
when calling f_spec instead of call-by-value.  And that can result in
unbounded worsening in space (cf the classic foldl vs foldl')

See #3437 for a good example.

The function calcSpecStrictness performs the calculation.

Note [Strictness information in worker binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
After having calculated the strictness annotation for the worker (see Note
[Transfer strictness] above), we also want to have this information attached to
the worker&#8217;s arguments, for the benefit of later passes. The function
handOutStrictnessInformation decomposes the strictness annotation calculated by
calcSpecStrictness and attaches them to the variables.


************************************************************************
*                                                                      *
\subsection{Argument analysis}
*                                                                      *
************************************************************************

This code deals with analysing call-site arguments to see whether
they are constructor applications.

Note [Free type variables of the qvar types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a call (f @a x True), that we want to specialise, what variables should
we quantify over.  Clearly over 'a' and 'x', but what about any type variables
free in x's type?  In fact we don't need to worry about them because (f @a)
can only be a well-typed application if its type is compatible with x, so any
variables free in x's type must be free in (f @a), and hence either be gathered
via 'a' itself, or be in scope at f's defn.  Hence we just take
  (exprsFreeVars pats).

BUT phantom type synonyms can mess this reasoning up,
  eg   x::T b   with  type T b = Int
So we apply expandTypeSynonyms to the bound Ids.
See # 5458.  Yuk.

Note [SpecConstr call patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A &quot;call patterns&quot; that we collect is going to become the LHS of a RULE.

Wrinkles:

* The list of argument patterns, cp_args, is no longer than the
  visible lambdas of the binding, ri_arg_occs.  This is done via
  the zipWithM in callToPat.

* The list of argument patterns can certainly be shorter than the
  lambdas in the function definition (under-saturated).  For example
      f x y = case x of { True -&gt; e1; False -&gt; e2 }
      ....map (f True) e...
  We want to specialise `f` for `f True`.

* In fact we deliberately shrink the list of argument patterns,
  cp_args, by trimming off all the boring ones at the end (see
  `dropWhileEnd is_boring` in callToPat).  Since the RULE only
  applies when it is saturated, this shrinking makes the RULE more
  applicable.  But it does mean that the argument patterns do not
  necessarily saturate the lambdas of the function.

* It's important that the pattern arguments do not look like
     e |&gt; Refl
  or
    e |&gt; g1 |&gt; g2
  because both of these will be optimised by Simplify.simplRule. In the
  former case such optimisation benign, because the rule will match more
  terms; but in the latter we may lose a binding of 'g1' or 'g2', and
  end up with a rule LHS that doesn't bind the template variables
  (#10602).

  The simplifier eliminates such things, but SpecConstr itself constructs
  new terms by substituting.  So the 'mkCast' in the Cast case of scExpr
  is very important!

Note [Choosing patterns]
~~~~~~~~~~~~~~~~~~~~~~~~
If we get lots of patterns we may not want to make a specialisation
for each of them (code bloat), so we choose as follows, implemented
by trim_pats.

* The flag -fspec-constr-count-N sets the sc_count field
  of the ScEnv to (Just n).  This limits the total number
  of specialisations for a given function to N.

* -fno-spec-constr-count sets the sc_count field to Nothing,
  which switches of the limit.

* The ghastly ForceSpecConstr trick also switches of the limit
  for a particular function

* Otherwise we sort the patterns to choose the most general
  ones first; more general =&gt; more widely applicable.

Note [SpecConstr and casts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (#14270) a call like

    let f = e
    in ... f (K @(a |&gt; cv)) ...

where 'cv' is a coercion variable not in scope at f's definition site.
If we aren't careful we'll get

    let $sf a cv = e (K @(a |&gt; cv))
        RULE &quot;SC:f&quot; forall a cv.  f (K @(a |&gt; cv)) = $sf a co
        f = e
    in ...

But alas, when we match the call we may fail to bind 'co', because the rule
matcher in GHC.Core.Rules cannot reliably bind coercion variables that appear
in casts (see Note [Casts in the template] in GHC.Core.Rules).

This seems intractable (see #23209). So:

* Key point: we /never/ quantify over coercion variables in a SpecConstr rule.
  If we would need to quantify over a coercion variable, we just discard the
  call pattern. See the test for `bad_covars` in callToPat.

* However (#14936) we /do/ still allow casts in call patterns. For example
     f ((e1,e2) |&gt; sym co)
  where, say,
     f  :: Foo -&gt; blah   -- Foo is a newtype
     f = f_rhs
     co :: Foo ~R (Int,Int)
  We want to specialise on that pair!

So for our function f, we might generate
  RULE forall x y.  f ((x,y) |&gt; co) = $sf x y
  $sf x y = f_rhs ((x,y) |&gt; co)

This works provided the free vars of `co` are either in-scope at the
definition of `f`, or quantified. For the latter, suppose `f` was polymorphic:

     f2  :: Foo2 a -&gt; blah   -- Foo is a newtype
     f2 = f2_rhs
     co2 :: Foo a ~R (a,a)

Then it's fine for `co2` to mention `a`.  We'll get
  RULE forall a (x::a) (y::a).  f2 @a ((x,y) |&gt; co2) = $sf2 a x y
  $sf2 @a x y = f2_rhs ((x,y) |&gt; co2)
-}</span><span>
</span><span id="line-2421"></span><span>
</span><span id="line-2422"></span><span class="hs-keyword">data</span><span> </span><span id="CallPat"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-var">CallPat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CP"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CP"><span class="hs-identifier hs-var">CP</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="cp_qvars"><span class="annot"><span class="annottext">CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_qvars"><span class="hs-identifier hs-var hs-var">cp_qvars</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Quantified variables</span><span>
</span><span id="line-2423"></span><span>                  </span><span class="hs-special">,</span><span> </span><span id="cp_args"><span class="annot"><span class="annottext">CallPat -&gt; [Expr Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_args"><span class="hs-identifier hs-var hs-var">cp_args</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Arguments</span><span>
</span><span id="line-2424"></span><span>                  </span><span class="hs-special">,</span><span> </span><span id="cp_strict_args"><span class="annot"><span class="annottext">CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_strict_args"><span class="hs-identifier hs-var hs-var">cp_strict_args</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>   </span><span class="hs-comment">-- Arguments we want to pass unlifted even if they are boxed</span><span>
</span><span id="line-2425"></span><span>                                                </span><span class="hs-comment">-- See Note [SpecConstr and strict fields]</span><span>
</span><span id="line-2426"></span><span>
</span><span id="line-2427"></span><span>     </span><span class="hs-comment">-- See Note [SpecConstr call patterns]</span><span>
</span><span id="line-2428"></span><span>
</span><span id="line-2429"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2430"></span><span>  </span><span id="local-6989586621682942277"><span class="annot"><span class="annottext">ppr :: CallPat -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CP"><span class="hs-identifier hs-type">CP</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cp_qvars :: CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_qvars"><span class="hs-identifier hs-var">cp_qvars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942278"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942278"><span class="hs-identifier hs-var">qvars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_args :: CallPat -&gt; [Expr Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_args"><span class="hs-identifier hs-var">cp_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942279"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942279"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_strict_args :: CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_strict_args"><span class="hs-identifier hs-var">cp_strict_args</span></a></span><span> </span><span class="hs-glyph">=</span><span>  </span><span id="local-6989586621682942280"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942280"><span class="hs-identifier hs-var">strict</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2431"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CP&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cp_qvars =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942278"><span class="hs-identifier hs-var">qvars</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span>
</span><span id="line-2432"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cp_args =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942279"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2433"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cp_strict_args = &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942280"><span class="hs-identifier hs-var">strict</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2434"></span><span>
</span><span id="line-2435"></span><span class="hs-keyword">newtype</span><span> </span><span id="SpecFailWarning"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier hs-var">SpecFailWarning</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SpecFailForcedArgCount"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailForcedArgCount"><span class="hs-identifier hs-var">SpecFailForcedArgCount</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="spec_failed_fun_name"><span class="annot"><span class="annottext">SpecFailWarning -&gt; Name
</span><a href="GHC.Core.Opt.SpecConstr.html#spec_failed_fun_name"><span class="hs-identifier hs-var hs-var">spec_failed_fun_name</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2436"></span><span>
</span><span id="line-2437"></span><span class="hs-keyword">type</span><span> </span><span id="SpecFailWarnings"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-var">SpecFailWarnings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier hs-type">SpecFailWarning</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2438"></span><span>
</span><span id="line-2439"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier hs-type">SpecFailWarning</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2440"></span><span>  </span><span id="local-6989586621682942288"><span class="annot"><span class="annottext">ppr :: SpecFailWarning -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailForcedArgCount"><span class="hs-identifier hs-type">SpecFailForcedArgCount</span></a></span><span> </span><span id="local-6989586621682942289"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682942289"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682942289"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; SDoc
</span><a href="GHC.Types.Name.html#pprDefinedAt"><span class="hs-identifier hs-var">pprDefinedAt</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682942289"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-2441"></span><span>
</span><span id="line-2442"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#combineSpecWarning"><span class="hs-identifier hs-type">combineSpecWarning</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarnings"><span class="hs-identifier hs-type">SpecFailWarnings</span></a></span><span>
</span><span id="line-2443"></span><span id="combineSpecWarning"><span class="annot"><span class="annottext">combineSpecWarning :: [SpecFailWarning] -&gt; [SpecFailWarning] -&gt; [SpecFailWarning]
</span><a href="GHC.Core.Opt.SpecConstr.html#combineSpecWarning"><span class="hs-identifier hs-var hs-var">combineSpecWarning</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning] -&gt; [SpecFailWarning] -&gt; [SpecFailWarning]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span>
</span><span id="line-2444"></span><span>
</span><span id="line-2445"></span><span class="hs-keyword">data</span><span> </span><span id="ArgCountResult"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgCountResult"><span class="hs-identifier hs-var">ArgCountResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="WorkerSmallEnough"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#WorkerSmallEnough"><span class="hs-identifier hs-var">WorkerSmallEnough</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="WorkerTooLarge"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#WorkerTooLarge"><span class="hs-identifier hs-var">WorkerTooLarge</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="WorkerTooLargeForced"><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#WorkerTooLargeForced"><span class="hs-identifier hs-var">WorkerTooLargeForced</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-2446"></span><span>
</span><span id="line-2447"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#callsToNewPats"><span class="hs-identifier hs-type">callsToNewPats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-2448"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span>
</span><span id="line-2449"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2450"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>        </span><span class="hs-comment">-- At least one boring call</span><span>
</span><span id="line-2451"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>        </span><span class="hs-comment">-- Patterns were discarded</span><span>
</span><span id="line-2452"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Patterns to specialise</span><span>
</span><span id="line-2453"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecFailWarning"><span class="hs-identifier hs-type">SpecFailWarning</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Things that didn't specialise we want to warn the user about)</span><span>
</span><span id="line-2454"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-2455"></span><span class="hs-comment">-- Result has no duplicate patterns,</span><span>
</span><span id="line-2456"></span><span class="hs-comment">-- nor ones mentioned in si_specs (hence &quot;new&quot; patterns)</span><span>
</span><span id="line-2457"></span><span class="hs-comment">-- Bool indicates that there was at least one boring pattern</span><span>
</span><span id="line-2458"></span><span class="hs-comment">-- The &quot;New&quot; in the name means &quot;patterns that are not already covered</span><span>
</span><span id="line-2459"></span><span class="hs-comment">-- by an existing specialisation&quot;</span><span>
</span><span id="line-2460"></span><span id="callsToNewPats"><span class="annot"><span class="annottext">callsToNewPats :: ScEnv
-&gt; Id
-&gt; SpecInfo
-&gt; [ArgOcc]
-&gt; [Call]
-&gt; UniqSM (Bool, Bool, [CallPat], [SpecFailWarning])
</span><a href="GHC.Core.Opt.SpecConstr.html#callsToNewPats"><span class="hs-identifier hs-var hs-var">callsToNewPats</span></a></span></span><span> </span><span id="local-6989586621682942294"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942294"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942295"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942295"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682942296"><span class="annot"><span class="annottext">spec_info :: SpecInfo
</span><a href="#local-6989586621682942296"><span class="hs-identifier hs-var">spec_info</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SI"><span class="hs-identifier hs-type">SI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">si_specs :: SpecInfo -&gt; [OneSpec]
</span><a href="GHC.Core.Opt.SpecConstr.html#si_specs"><span class="hs-identifier hs-var">si_specs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942297"><span class="annot"><span class="annottext">[OneSpec]
</span><a href="#local-6989586621682942297"><span class="hs-identifier hs-var">done_specs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942298"><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942298"><span class="hs-identifier hs-var">bndr_occs</span></a></span></span><span> </span><span id="local-6989586621682942299"><span class="annot"><span class="annottext">[Call]
</span><a href="#local-6989586621682942299"><span class="hs-identifier hs-var">calls</span></a></span></span><span>
</span><span id="line-2461"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682942300"><span class="annot"><a href="#local-6989586621682942300"><span class="hs-identifier hs-var">mb_pats</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Call -&gt; UniqSM (Maybe CallPat))
-&gt; [Call] -&gt; UniqSM [Maybe CallPat]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; [ArgOcc] -&gt; Call -&gt; UniqSM (Maybe CallPat)
</span><a href="GHC.Core.Opt.SpecConstr.html#callToPat"><span class="hs-identifier hs-var">callToPat</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942294"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942298"><span class="hs-identifier hs-var">bndr_occs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Call]
</span><a href="#local-6989586621682942299"><span class="hs-identifier hs-var">calls</span></a></span><span>
</span><span id="line-2462"></span><span>
</span><span id="line-2463"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942302"><span class="annot"><a href="#local-6989586621682942302"><span class="hs-identifier hs-var hs-var">have_boring_call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe CallPat -&gt; Bool) -&gt; [Maybe CallPat] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Maybe CallPat -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">[Maybe CallPat]
</span><a href="#local-6989586621682942300"><span class="hs-identifier hs-var">mb_pats</span></a></span><span>
</span><span id="line-2464"></span><span>
</span><span id="line-2465"></span><span>              </span><span class="annot"><a href="#local-6989586621682942303"><span class="hs-identifier hs-type">good_pats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2466"></span><span>              </span><span id="local-6989586621682942303"><span class="annot"><a href="#local-6989586621682942303"><span class="hs-identifier hs-var hs-var">good_pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe CallPat] -&gt; [CallPat]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe CallPat]
</span><a href="#local-6989586621682942300"><span class="hs-identifier hs-var">mb_pats</span></a></span><span>
</span><span id="line-2467"></span><span>
</span><span id="line-2468"></span><span>              </span><span id="local-6989586621682942304"><span class="annot"><a href="#local-6989586621682942304"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier hs-var">getSubstInScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942294"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2469"></span><span>
</span><span id="line-2470"></span><span>              </span><span class="hs-comment">-- Remove patterns we have already done</span><span>
</span><span id="line-2471"></span><span>              </span><span id="local-6989586621682942306"><span class="annot"><a href="#local-6989586621682942306"><span class="hs-identifier hs-var hs-var">new_pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CallPat -&gt; Bool) -&gt; [CallPat] -&gt; [CallPat]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat -&gt; Bool
</span><a href="#local-6989586621682942307"><span class="hs-identifier hs-var">is_done</span></a></span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942303"><span class="hs-identifier hs-var">good_pats</span></a></span><span>
</span><span id="line-2472"></span><span>              </span><span id="local-6989586621682942307"><span class="annot"><a href="#local-6989586621682942307"><span class="hs-identifier hs-var hs-var">is_done</span></a></span></span><span> </span><span id="local-6989586621682942308"><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942308"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OneSpec -&gt; Bool) -&gt; [OneSpec] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">OneSpec -&gt; Bool
</span><a href="#local-6989586621682942309"><span class="hs-identifier hs-var">is_better</span></a></span><span> </span><span class="annot"><span class="annottext">[OneSpec]
</span><a href="#local-6989586621682942297"><span class="hs-identifier hs-var">done_specs</span></a></span><span>
</span><span id="line-2473"></span><span>                 </span><span class="hs-keyword">where</span><span>
</span><span id="line-2474"></span><span>                   </span><span id="local-6989586621682942309"><span class="annot"><span class="annottext">is_better :: OneSpec -&gt; Bool
</span><a href="#local-6989586621682942309"><span class="hs-identifier hs-var hs-var">is_better</span></a></span></span><span> </span><span id="local-6989586621682942310"><span class="annot"><span class="annottext">OneSpec
</span><a href="#local-6989586621682942310"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; CallPat -&gt; CallPat -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#betterPat"><span class="hs-identifier hs-var">betterPat</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942304"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OneSpec -&gt; CallPat
</span><a href="GHC.Core.Opt.SpecConstr.html#os_pat"><span class="hs-identifier hs-var">os_pat</span></a></span><span> </span><span class="annot"><span class="annottext">OneSpec
</span><a href="#local-6989586621682942310"><span class="hs-identifier hs-var">done</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942308"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-2475"></span><span>
</span><span id="line-2476"></span><span>              </span><span class="hs-comment">-- Remove duplicates</span><span>
</span><span id="line-2477"></span><span>              </span><span id="local-6989586621682942312"><span class="annot"><a href="#local-6989586621682942312"><span class="hs-identifier hs-var hs-var">non_dups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [CallPat] -&gt; [CallPat]
</span><a href="GHC.Core.Opt.SpecConstr.html#subsumePats"><span class="hs-identifier hs-var">subsumePats</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942304"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942306"><span class="hs-identifier hs-var">new_pats</span></a></span><span>
</span><span id="line-2478"></span><span>
</span><span id="line-2479"></span><span>              </span><span class="hs-comment">-- Remove ones that have too many worker variables</span><span>
</span><span id="line-2480"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682942314"><span class="annot"><a href="#local-6989586621682942314"><span class="hs-identifier hs-var">small_pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942315"><span class="annot"><a href="#local-6989586621682942315"><span class="hs-identifier hs-var">arg_count_warnings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682942316"><span class="hs-identifier hs-type">partitionByWorkerSize</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942317"><span class="hs-identifier hs-type">too_many_worker_args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942312"><span class="hs-identifier hs-type">non_dups</span></a></span><span>
</span><span id="line-2481"></span><span>
</span><span id="line-2482"></span><span>              </span><span class="hs-comment">-- too_many_worker_args :: CallPat -&gt; Either SpecFailWarning Bool</span><span>
</span><span id="line-2483"></span><span>              </span><span id="local-6989586621682942317"><span class="annot"><a href="#local-6989586621682942317"><span class="hs-identifier hs-var hs-var">too_many_worker_args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CP"><span class="hs-identifier hs-type">CP</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cp_qvars :: CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_qvars"><span class="hs-identifier hs-var">cp_qvars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942318"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942318"><span class="hs-identifier hs-var">vars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_args :: CallPat -&gt; [Expr Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_args"><span class="hs-identifier hs-var">cp_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942319"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942319"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2484"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_force"><span class="hs-identifier hs-var">sc_force</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942294"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2485"></span><span>                </span><span class="hs-comment">-- See (FS5) of Note [Forcing specialisation]</span><span>
</span><span id="line-2486"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; [Id] -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#isWorkerSmallEnough"><span class="hs-identifier hs-var">isWorkerSmallEnough</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_max_forced_args"><span class="hs-identifier hs-var">sc_max_forced_args</span></a></span><span> </span><span class="annot"><span class="annottext">(SpecConstrOpts -&gt; Int) -&gt; SpecConstrOpts -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942294"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Expr Id] -&gt; Int
forall b. [Arg b] -&gt; Int
</span><a href="GHC.Core.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942319"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942318"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2487"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ArgCountResult
</span><a href="GHC.Core.Opt.SpecConstr.html#WorkerSmallEnough"><span class="hs-identifier hs-var">WorkerSmallEnough</span></a></span><span>
</span><span id="line-2488"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ArgCountResult
</span><a href="GHC.Core.Opt.SpecConstr.html#WorkerTooLargeForced"><span class="hs-identifier hs-var">WorkerTooLargeForced</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942295"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2489"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; [Id] -&gt; Bool
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#isWorkerSmallEnough"><span class="hs-identifier hs-var">isWorkerSmallEnough</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_max_args"><span class="hs-identifier hs-var">sc_max_args</span></a></span><span> </span><span class="annot"><span class="annottext">(SpecConstrOpts -&gt; Int) -&gt; SpecConstrOpts -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942294"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Expr Id] -&gt; Int
forall b. [Arg b] -&gt; Int
</span><a href="GHC.Core.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942319"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942318"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2490"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgCountResult
</span><a href="GHC.Core.Opt.SpecConstr.html#WorkerSmallEnough"><span class="hs-identifier hs-var">WorkerSmallEnough</span></a></span><span>
</span><span id="line-2491"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgCountResult
</span><a href="GHC.Core.Opt.SpecConstr.html#WorkerTooLarge"><span class="hs-identifier hs-var">WorkerTooLarge</span></a></span><span>
</span><span id="line-2492"></span><span>                  </span><span class="hs-comment">-- We are about to construct w/w pair in 'spec_one'.</span><span>
</span><span id="line-2493"></span><span>                  </span><span class="hs-comment">-- Omit specialisation leading to high arity workers.</span><span>
</span><span id="line-2494"></span><span>                  </span><span class="hs-comment">-- See Note [Limit w/w arity] in GHC.Core.Opt.WorkWrap.Utils</span><span>
</span><span id="line-2495"></span><span>
</span><span id="line-2496"></span><span>                </span><span class="hs-comment">-- Discard specialisations if there are too many of them</span><span>
</span><span id="line-2497"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682942322"><span class="annot"><a href="#local-6989586621682942322"><span class="hs-identifier hs-var">pats_were_discarded</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942323"><span class="annot"><a href="#local-6989586621682942323"><span class="hs-identifier hs-var">trimmed_pats</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#trim_pats"><span class="hs-identifier hs-type">trim_pats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942294"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942295"><span class="hs-identifier hs-type">fn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942296"><span class="hs-identifier hs-type">spec_info</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942314"><span class="hs-identifier hs-type">small_pats</span></a></span><span>
</span><span id="line-2498"></span><span>
</span><span id="line-2499"></span><span class="hs-comment">--        ; pprTraceM &quot;callsToPats&quot; (vcat [ text &quot;calls to&quot; &lt;+&gt; ppr fn &lt;&gt; colon &lt;+&gt; ppr calls</span><span>
</span><span id="line-2500"></span><span class="hs-comment">--                                        , text &quot;good_pats:&quot; &lt;+&gt; ppr good_pats</span><span>
</span><span id="line-2501"></span><span class="hs-comment">--                                        , text &quot;new_pats:&quot; &lt;+&gt; ppr new_pats</span><span>
</span><span id="line-2502"></span><span class="hs-comment">--                                        , text &quot;non_dups:&quot; &lt;+&gt; ppr non_dups</span><span>
</span><span id="line-2503"></span><span class="hs-comment">--                                        , text &quot;small_pats:&quot; &lt;+&gt; ppr small_pats</span><span>
</span><span id="line-2504"></span><span class="hs-comment">--                                        , text &quot;done_specs:&quot; &lt;+&gt; ppr (map os_pat done_specs)</span><span>
</span><span id="line-2505"></span><span class="hs-comment">--                                        , text &quot;trimmed_pats:&quot; &lt;+&gt; ppr trimmed_pats ])</span><span>
</span><span id="line-2506"></span><span>
</span><span id="line-2507"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682942302"><span class="hs-identifier hs-type">have_boring_call</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682942322"><span class="hs-identifier hs-type">pats_were_discarded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682942323"><span class="hs-identifier hs-type">trimmed_pats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682942315"><span class="hs-identifier hs-type">arg_count_warnings</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2508"></span><span>          </span><span class="hs-comment">-- If any of the calls does not give rise to a specialisation, either</span><span>
</span><span id="line-2509"></span><span>          </span><span class="hs-comment">-- because it is boring, or because there are too many specialisations,</span><span>
</span><span id="line-2510"></span><span>          </span><span class="hs-comment">-- return a flag to say so, so that we know to keep the original function.</span><span>
</span><span id="line-2511"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2512"></span><span>    </span><span id="local-6989586621682942316"><span class="annot"><span class="annottext">partitionByWorkerSize :: (a -&gt; ArgCountResult) -&gt; [a] -&gt; ([a], [SpecFailWarning])
</span><a href="#local-6989586621682942316"><span class="hs-identifier hs-var hs-var">partitionByWorkerSize</span></a></span></span><span> </span><span id="local-6989586621682942325"><span class="annot"><span class="annottext">a -&gt; ArgCountResult
</span><a href="#local-6989586621682942325"><span class="hs-identifier hs-var">worker_size</span></a></span></span><span> </span><span id="local-6989586621682942326"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942326"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [SpecFailWarning] -&gt; ([a], [SpecFailWarning])
</span><a href="#local-6989586621682942327"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942326"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2513"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2514"></span><span>        </span><span id="local-6989586621682942327"><span class="annot"><span class="annottext">go :: [a] -&gt; [a] -&gt; [SpecFailWarning] -&gt; ([a], [SpecFailWarning])
</span><a href="#local-6989586621682942327"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621682942328"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942328"><span class="hs-identifier hs-var">small</span></a></span></span><span> </span><span id="local-6989586621682942329"><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942329"><span class="hs-identifier hs-var">warnings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942328"><span class="hs-identifier hs-var">small</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942329"><span class="hs-identifier hs-var">warnings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2515"></span><span>        </span><span class="annot"><a href="#local-6989586621682942327"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942330"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682942330"><span class="hs-identifier hs-var">p</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682942331"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942331"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942332"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942332"><span class="hs-identifier hs-var">small</span></a></span></span><span> </span><span id="local-6989586621682942333"><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942333"><span class="hs-identifier hs-var">warnings</span></a></span></span><span>
</span><span id="line-2516"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArgCountResult
</span><a href="GHC.Core.Opt.SpecConstr.html#WorkerSmallEnough"><span class="hs-identifier hs-var">WorkerSmallEnough</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; ArgCountResult
</span><a href="#local-6989586621682942325"><span class="hs-identifier hs-var">worker_size</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682942330"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-2517"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [SpecFailWarning] -&gt; ([a], [SpecFailWarning])
</span><a href="#local-6989586621682942327"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942331"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682942330"><span class="hs-identifier hs-var">p</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942332"><span class="hs-identifier hs-var">small</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942333"><span class="hs-identifier hs-var">warnings</span></a></span><span>
</span><span id="line-2518"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArgCountResult
</span><a href="GHC.Core.Opt.SpecConstr.html#WorkerTooLarge"><span class="hs-identifier hs-var">WorkerTooLarge</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; ArgCountResult
</span><a href="#local-6989586621682942325"><span class="hs-identifier hs-var">worker_size</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682942330"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-2519"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [SpecFailWarning] -&gt; ([a], [SpecFailWarning])
</span><a href="#local-6989586621682942327"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942331"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942332"><span class="hs-identifier hs-var">small</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942333"><span class="hs-identifier hs-var">warnings</span></a></span><span>
</span><span id="line-2520"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#WorkerTooLargeForced"><span class="hs-identifier hs-type">WorkerTooLargeForced</span></a></span><span> </span><span id="local-6989586621682942334"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682942334"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; ArgCountResult
</span><a href="#local-6989586621682942325"><span class="hs-identifier hs-var">worker_size</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682942330"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-2521"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [SpecFailWarning] -&gt; ([a], [SpecFailWarning])
</span><a href="#local-6989586621682942327"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942331"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682942332"><span class="hs-identifier hs-var">small</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SpecFailWarning
</span><a href="GHC.Core.Opt.SpecConstr.html#SpecFailForcedArgCount"><span class="hs-identifier hs-var">SpecFailForcedArgCount</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682942334"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SpecFailWarning -&gt; [SpecFailWarning] -&gt; [SpecFailWarning]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[SpecFailWarning]
</span><a href="#local-6989586621682942333"><span class="hs-identifier hs-var">warnings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2522"></span><span>
</span><span id="line-2523"></span><span>
</span><span id="line-2524"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#trim_pats"><span class="hs-identifier hs-type">trim_pats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2525"></span><span class="hs-comment">-- True &lt;=&gt; some patterns were discarded</span><span>
</span><span id="line-2526"></span><span class="hs-comment">-- See Note [Choosing patterns]</span><span>
</span><span id="line-2527"></span><span id="trim_pats"><span class="annot"><span class="annottext">trim_pats :: ScEnv -&gt; Id -&gt; SpecInfo -&gt; [CallPat] -&gt; (Bool, [CallPat])
</span><a href="GHC.Core.Opt.SpecConstr.html#trim_pats"><span class="hs-identifier hs-var hs-var">trim_pats</span></a></span></span><span> </span><span id="local-6989586621682942335"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942335"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942336"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942336"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#SI"><span class="hs-identifier hs-type">SI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">si_n_specs :: SpecInfo -&gt; Int
</span><a href="GHC.Core.Opt.SpecConstr.html#si_n_specs"><span class="hs-identifier hs-var">si_n_specs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942337"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942337"><span class="hs-identifier hs-var">done_spec_count</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942338"><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942338"><span class="hs-identifier hs-var">pats</span></a></span></span><span>
</span><span id="line-2528"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_force"><span class="hs-identifier hs-var">sc_force</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942335"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2529"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621682942339"><span class="hs-identifier hs-var">mb_scc</span></a></span><span>
</span><span id="line-2530"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942340"><span class="hs-identifier hs-var">n_remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942341"><span class="hs-identifier hs-var">n_pats</span></a></span><span>
</span><span id="line-2531"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;trim_pats: no-trim&quot; (ppr (sc_force env) $$ ppr mb_scc $$ ppr n_remaining $$ ppr n_pats)</span><span>
</span><span id="line-2532"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942338"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- No need to trim</span><span>
</span><span id="line-2533"></span><span>
</span><span id="line-2534"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2535"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, [CallPat]) -&gt; (Bool, [CallPat])
</span><a href="#local-6989586621682942342"><span class="hs-identifier hs-var">emit_trace</span></a></span><span> </span><span class="annot"><span class="annottext">((Bool, [CallPat]) -&gt; (Bool, [CallPat]))
-&gt; (Bool, [CallPat]) -&gt; (Bool, [CallPat])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="hs-comment">-- Need to trim, so keep the best ones</span><span>
</span><span id="line-2536"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [CallPat] -&gt; [CallPat]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942340"><span class="hs-identifier hs-var">n_remaining</span></a></span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942344"><span class="hs-identifier hs-var">sorted_pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2537"></span><span>
</span><span id="line-2538"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2539"></span><span>    </span><span id="local-6989586621682942341"><span class="annot"><span class="annottext">n_pats :: Int
</span><a href="#local-6989586621682942341"><span class="hs-identifier hs-var hs-var">n_pats</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CallPat] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942338"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2540"></span><span>    </span><span id="local-6989586621682942345"><span class="annot"><span class="annottext">spec_count' :: Int
</span><a href="#local-6989586621682942345"><span class="hs-identifier hs-var hs-var">spec_count'</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942341"><span class="hs-identifier hs-var">n_pats</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942337"><span class="hs-identifier hs-var">done_spec_count</span></a></span><span>
</span><span id="line-2541"></span><span>    </span><span id="local-6989586621682942340"><span class="annot"><span class="annottext">n_remaining :: Int
</span><a href="#local-6989586621682942340"><span class="hs-identifier hs-var hs-var">n_remaining</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942346"><span class="hs-identifier hs-var">max_specs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942337"><span class="hs-identifier hs-var">done_spec_count</span></a></span><span>
</span><span id="line-2542"></span><span>    </span><span id="local-6989586621682942339"><span class="annot"><span class="annottext">mb_scc :: Maybe Int
</span><a href="#local-6989586621682942339"><span class="hs-identifier hs-var hs-var">mb_scc</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Maybe Int
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_count"><span class="hs-identifier hs-var">sc_count</span></a></span><span> </span><span class="annot"><span class="annottext">(SpecConstrOpts -&gt; Maybe Int) -&gt; SpecConstrOpts -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942335"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2543"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682942346"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942346"><span class="hs-identifier hs-var">max_specs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621682942339"><span class="hs-identifier hs-var">mb_scc</span></a></span><span>
</span><span id="line-2544"></span><span>
</span><span id="line-2545"></span><span>    </span><span id="local-6989586621682942344"><span class="annot"><span class="annottext">sorted_pats :: [CallPat]
</span><a href="#local-6989586621682942344"><span class="hs-identifier hs-var hs-var">sorted_pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CallPat, Int) -&gt; CallPat) -&gt; [(CallPat, Int)] -&gt; [CallPat]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(CallPat, Int) -&gt; CallPat
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(CallPat, Int)] -&gt; [CallPat]) -&gt; [(CallPat, Int)] -&gt; [CallPat]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2546"></span><span>                  </span><span class="annot"><span class="annottext">((CallPat, Int) -&gt; (CallPat, Int) -&gt; Ordering)
-&gt; [(CallPat, Int)] -&gt; [(CallPat, Int)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CallPat, Int) -&gt; Int)
-&gt; (CallPat, Int) -&gt; (CallPat, Int) -&gt; Ordering
forall a b. Ord a =&gt; (b -&gt; a) -&gt; b -&gt; b -&gt; Ordering
</span><span class="hs-identifier hs-var">comparing</span></span><span> </span><span class="annot"><span class="annottext">(CallPat, Int) -&gt; Int
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(CallPat, Int)] -&gt; [(CallPat, Int)])
-&gt; [(CallPat, Int)] -&gt; [(CallPat, Int)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2547"></span><span>                  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942347"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CallPat -&gt; Int
</span><a href="#local-6989586621682942348"><span class="hs-identifier hs-var">pat_cons</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942347"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682942347"><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942347"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942338"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2548"></span><span>     </span><span class="hs-comment">-- Sort in order of increasing number of constructors</span><span>
</span><span id="line-2549"></span><span>     </span><span class="hs-comment">-- (i.e. decreasing generality) and pick the initial</span><span>
</span><span id="line-2550"></span><span>     </span><span class="hs-comment">-- segment of this list</span><span>
</span><span id="line-2551"></span><span>
</span><span id="line-2552"></span><span>    </span><span class="annot"><a href="#local-6989586621682942348"><span class="hs-identifier hs-type">pat_cons</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-2553"></span><span>    </span><span class="hs-comment">-- How many data constructors of literals are in</span><span>
</span><span id="line-2554"></span><span>    </span><span class="hs-comment">-- the pattern.  More data-cons =&gt; less general</span><span>
</span><span id="line-2555"></span><span>    </span><span id="local-6989586621682942348"><span class="annot"><span class="annottext">pat_cons :: CallPat -&gt; Int
</span><a href="#local-6989586621682942348"><span class="hs-identifier hs-var hs-var">pat_cons</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CP"><span class="hs-identifier hs-type">CP</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cp_qvars :: CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_qvars"><span class="hs-identifier hs-var">cp_qvars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942349"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942349"><span class="hs-identifier hs-var">qs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_args :: CallPat -&gt; [Expr Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_args"><span class="hs-identifier hs-var">cp_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942350"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942350"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2556"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Expr Id -&gt; Int -&gt; Int) -&gt; Int -&gt; [Expr Id] -&gt; Int
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(+)</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; (Expr Id -&gt; Int) -&gt; Expr Id -&gt; Int -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Int
</span><a href="#local-6989586621682942351"><span class="hs-identifier hs-var">n_cons</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942350"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-2557"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-2558"></span><span>          </span><span id="local-6989586621682942352"><span class="annot"><span class="annottext">q_set :: VarSet
</span><a href="#local-6989586621682942352"><span class="hs-identifier hs-var hs-var">q_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942349"><span class="hs-identifier hs-var">qs</span></a></span><span>
</span><span id="line-2559"></span><span>          </span><span id="local-6989586621682942351"><span class="annot"><span class="annottext">n_cons :: Expr Id -&gt; Int
</span><a href="#local-6989586621682942351"><span class="hs-identifier hs-var hs-var">n_cons</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682942353"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942353"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942353"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682942352"><span class="hs-identifier hs-var">q_set</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2560"></span><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2561"></span><span>          </span><span class="annot"><a href="#local-6989586621682942351"><span class="hs-identifier hs-var">n_cons</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682942355"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942355"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Int
</span><a href="#local-6989586621682942351"><span class="hs-identifier hs-var">n_cons</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942355"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2562"></span><span>          </span><span class="annot"><a href="#local-6989586621682942351"><span class="hs-identifier hs-var">n_cons</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621682942356"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942356"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621682942357"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942357"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Int
</span><a href="#local-6989586621682942351"><span class="hs-identifier hs-var">n_cons</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942356"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Int
</span><a href="#local-6989586621682942351"><span class="hs-identifier hs-var">n_cons</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942357"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-2563"></span><span>          </span><span class="annot"><a href="#local-6989586621682942351"><span class="hs-identifier hs-var">n_cons</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2564"></span><span>          </span><span class="annot"><a href="#local-6989586621682942351"><span class="hs-identifier hs-var">n_cons</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2565"></span><span>
</span><span id="line-2566"></span><span>    </span><span id="local-6989586621682942342"><span class="annot"><span class="annottext">emit_trace :: (Bool, [CallPat]) -&gt; (Bool, [CallPat])
</span><a href="#local-6989586621682942342"><span class="hs-identifier hs-var hs-var">emit_trace</span></a></span></span><span> </span><span id="local-6989586621682942358"><span class="annot"><span class="annottext">(Bool, [CallPat])
</span><a href="#local-6989586621682942358"><span class="hs-identifier hs-var">result</span></a></span></span><span>
</span><span id="line-2567"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_debug"><span class="hs-identifier hs-var">sc_debug</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942335"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2568"></span><span>         </span><span class="hs-comment">-- Suppress this scary message for ordinary users!  #5125</span><span>
</span><span id="line-2569"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; (Bool, [CallPat]) -&gt; (Bool, [CallPat])
forall a. String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SpecConstr&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682942360"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool, [CallPat])
</span><a href="#local-6989586621682942358"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-2570"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2571"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, [CallPat])
</span><a href="#local-6989586621682942358"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-2572"></span><span>    </span><span id="local-6989586621682942360"><span class="annot"><span class="annottext">msg :: SDoc
</span><a href="#local-6989586621682942360"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Function&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942336"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2573"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;has&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>
</span><span id="line-2574"></span><span>                               </span><span class="annot"><span class="annottext">Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#speakNOf"><span class="hs-identifier hs-var">speakNOf</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942345"><span class="hs-identifier hs-var">spec_count'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;call pattern&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>
</span><span id="line-2575"></span><span>                               </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;but the limit is&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942346"><span class="hs-identifier hs-var">max_specs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2576"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Use -fspec-constr-count=n to set the bound&quot;</span></span><span>
</span><span id="line-2577"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;done_spec_count =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942337"><span class="hs-identifier hs-var">done_spec_count</span></a></span><span>
</span><span id="line-2578"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Keeping &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942340"><span class="hs-identifier hs-var">n_remaining</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, out of&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942341"><span class="hs-identifier hs-var">n_pats</span></a></span><span>
</span><span id="line-2579"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Discarding:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[CallPat] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [CallPat] -&gt; [CallPat]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682942340"><span class="hs-identifier hs-var">n_remaining</span></a></span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942344"><span class="hs-identifier hs-var">sorted_pats</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2580"></span><span>
</span><span id="line-2581"></span><span>
</span><span id="line-2582"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#callToPat"><span class="hs-identifier hs-type">callToPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2583"></span><span>        </span><span class="hs-comment">-- The [Var] is the variables to quantify over in the rule</span><span>
</span><span id="line-2584"></span><span>        </span><span class="hs-comment">--      Type variables come first, since they may scope</span><span>
</span><span id="line-2585"></span><span>        </span><span class="hs-comment">--      over the following term variables</span><span>
</span><span id="line-2586"></span><span>        </span><span class="hs-comment">-- The [CoreExpr] are the argument patterns for the rule</span><span>
</span><span id="line-2587"></span><span id="callToPat"><span class="annot"><span class="annottext">callToPat :: ScEnv -&gt; [ArgOcc] -&gt; Call -&gt; UniqSM (Maybe CallPat)
</span><a href="GHC.Core.Opt.SpecConstr.html#callToPat"><span class="hs-identifier hs-var hs-var">callToPat</span></a></span></span><span> </span><span id="local-6989586621682942365"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942365"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942366"><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942366"><span class="hs-identifier hs-var">bndr_occs</span></a></span></span><span> </span><span id="local-6989586621682942367"><span class="annot"><span class="annottext">call :: Call
</span><a href="#local-6989586621682942367"><span class="hs-identifier hs-var">call</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span id="local-6989586621682942368"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942368"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621682942369"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942369"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621682942370"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942370"><span class="hs-identifier hs-var">con_env</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2588"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942371"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621682942371"><span class="hs-identifier hs-var hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier hs-var">getSubstInScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; Subst
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_subst"><span class="hs-identifier hs-var">sc_subst</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942365"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2589"></span><span>
</span><span id="line-2590"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682942372"><span class="annot"><a href="#local-6989586621682942372"><span class="hs-identifier hs-var">arg_triples</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Id
 -&gt; ArgOcc -&gt; StrictnessMark -&gt; UniqSM (Bool, Expr Id, [Id]))
-&gt; [Expr Id]
-&gt; [ArgOcc]
-&gt; [StrictnessMark]
-&gt; UniqSM [(Bool, Expr Id, [Id])]
forall (m :: * -&gt; *) a b c d.
Monad m =&gt;
(a -&gt; b -&gt; c -&gt; m d) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; m [d]
</span><a href="GHC.Utils.Monad.html#zipWith3M"><span class="hs-identifier hs-var">zipWith3M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
-&gt; InScopeSet
-&gt; ValueEnv
-&gt; Expr Id
-&gt; ArgOcc
-&gt; StrictnessMark
-&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#argToPat"><span class="hs-identifier hs-var">argToPat</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942365"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942371"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942370"><span class="hs-identifier hs-var">con_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942369"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942366"><span class="hs-identifier hs-var">bndr_occs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr Id -&gt; StrictnessMark) -&gt; [Expr Id] -&gt; [StrictnessMark]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictnessMark -&gt; Expr Id -&gt; StrictnessMark
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942369"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2591"></span><span>                   </span><span class="hs-comment">-- This zip trims the args to be no longer than</span><span>
</span><span id="line-2592"></span><span>                   </span><span class="hs-comment">-- the lambdas in the function definition (bndr_occs)</span><span>
</span><span id="line-2593"></span><span>
</span><span id="line-2594"></span><span>          </span><span class="hs-comment">-- Drop boring patterns from the end</span><span>
</span><span id="line-2595"></span><span>          </span><span class="hs-comment">-- See Note [SpecConstr call patterns]</span><span>
</span><span id="line-2596"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942377"><span class="annot"><a href="#local-6989586621682942377"><span class="hs-identifier hs-var hs-var">arg_triples'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942368"><span class="hs-identifier hs-var">fn</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Bool, Expr Id, [Id])]
</span><a href="#local-6989586621682942372"><span class="hs-identifier hs-var">arg_triples</span></a></span><span>
</span><span id="line-2597"></span><span>                           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Bool, Expr Id, [Id]) -&gt; Bool)
-&gt; [(Bool, Expr Id, [Id])] -&gt; [(Bool, Expr Id, [Id])]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">dropWhileEnd</span></span><span> </span><span class="annot"><span class="annottext">(Bool, Expr Id, [Id]) -&gt; Bool
forall {b} {c}. (Bool, b, c) -&gt; Bool
</span><a href="#local-6989586621682942378"><span class="hs-identifier hs-var">is_boring</span></a></span><span> </span><span class="annot"><span class="annottext">[(Bool, Expr Id, [Id])]
</span><a href="#local-6989586621682942372"><span class="hs-identifier hs-var">arg_triples</span></a></span><span>
</span><span id="line-2598"></span><span>              </span><span id="local-6989586621682942378"><span class="annot"><a href="#local-6989586621682942378"><span class="hs-identifier hs-var hs-var">is_boring</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942379"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682942379"><span class="hs-identifier hs-var">interesting</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682942379"><span class="hs-identifier hs-var">interesting</span></a></span><span>
</span><span id="line-2599"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682942380"><span class="annot"><a href="#local-6989586621682942380"><span class="hs-identifier hs-var">interesting_s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942381"><span class="annot"><a href="#local-6989586621682942381"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942382"><span class="annot"><a href="#local-6989586621682942382"><span class="hs-identifier hs-var">cbv_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">unzip3</span></span><span> </span><span class="annot"><a href="#local-6989586621682942377"><span class="hs-identifier hs-type">arg_triples'</span></a></span><span>
</span><span id="line-2600"></span><span>              </span><span id="local-6989586621682942383"><span class="annot"><a href="#local-6989586621682942383"><span class="hs-identifier hs-var hs-var">interesting</span></a></span></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">or</span></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621682942380"><span class="hs-identifier hs-var">interesting_s</span></a></span><span>
</span><span id="line-2601"></span><span>
</span><span id="line-2602"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942385"><span class="annot"><a href="#local-6989586621682942385"><span class="hs-identifier hs-var hs-var">pat_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; [Id]
</span><a href="GHC.Core.FVs.html#exprsFreeVarsList"><span class="hs-identifier hs-var">exprsFreeVarsList</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942381"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2603"></span><span>                </span><span class="hs-comment">-- To get determinism we need the list of free variables in</span><span>
</span><span id="line-2604"></span><span>                </span><span class="hs-comment">-- deterministic order. Otherwise we end up creating</span><span>
</span><span id="line-2605"></span><span>                </span><span class="hs-comment">-- lambdas with different argument orders. See</span><span>
</span><span id="line-2606"></span><span>                </span><span class="hs-comment">-- determinism/simplCore/should_compile/spec-inline-determ.hs</span><span>
</span><span id="line-2607"></span><span>                </span><span class="hs-comment">-- for an example. For explanation of determinism</span><span>
</span><span id="line-2608"></span><span>                </span><span class="hs-comment">-- considerations See Note [Unique Determinism] in GHC.Types.Unique.</span><span>
</span><span id="line-2609"></span><span>
</span><span id="line-2610"></span><span>              </span><span id="local-6989586621682942386"><span class="annot"><a href="#local-6989586621682942386"><span class="hs-identifier hs-var hs-var">in_scope_vars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; VarSet
</span><a href="GHC.Types.Var.Env.html#getInScopeVars"><span class="hs-identifier hs-var">getInScopeVars</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942371"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-2611"></span><span>              </span><span id="local-6989586621682942388"><span class="annot"><a href="#local-6989586621682942388"><span class="hs-identifier hs-var hs-var">is_in_scope</span></a></span></span><span> </span><span id="local-6989586621682942389"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942389"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942389"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621682942386"><span class="hs-identifier hs-var">in_scope_vars</span></a></span><span>
</span><span id="line-2612"></span><span>              </span><span id="local-6989586621682942390"><span class="annot"><a href="#local-6989586621682942390"><span class="hs-identifier hs-var hs-var">qvars</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621682942388"><span class="hs-identifier hs-var">is_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942385"><span class="hs-identifier hs-var">pat_fvs</span></a></span><span>
</span><span id="line-2613"></span><span>                </span><span class="hs-comment">-- Quantify over variables that are not in scope</span><span>
</span><span id="line-2614"></span><span>                </span><span class="hs-comment">-- at the call site</span><span>
</span><span id="line-2615"></span><span>                </span><span class="hs-comment">-- See Note [Free type variables of the qvar types]</span><span>
</span><span id="line-2616"></span><span>                </span><span class="hs-comment">-- See Note [Shadowing in SpecConstr] at the top</span><span>
</span><span id="line-2617"></span><span>
</span><span id="line-2618"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621682942391"><span class="annot"><a href="#local-6989586621682942391"><span class="hs-identifier hs-var">qktvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942392"><span class="annot"><a href="#local-6989586621682942392"><span class="hs-identifier hs-var">qids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">partition</span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-type">isTyVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942390"><span class="hs-identifier hs-type">qvars</span></a></span><span>
</span><span id="line-2619"></span><span>              </span><span id="local-6989586621682942393"><span class="annot"><a href="#local-6989586621682942393"><span class="hs-identifier hs-var hs-var">qvars'</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id]
</span><a href="GHC.Core.TyCo.FVs.html#scopedSort"><span class="hs-identifier hs-var">scopedSort</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942391"><span class="hs-identifier hs-var">qktvs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="#local-6989586621682942395"><span class="hs-identifier hs-var">sanitise</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942392"><span class="hs-identifier hs-var">qids</span></a></span><span>
</span><span id="line-2620"></span><span>                </span><span class="hs-comment">-- Order into kind variables, type variables, term variables</span><span>
</span><span id="line-2621"></span><span>                </span><span class="hs-comment">-- The kind of a type variable may mention a kind variable</span><span>
</span><span id="line-2622"></span><span>                </span><span class="hs-comment">-- and the type of a term variable may mention a type variable</span><span>
</span><span id="line-2623"></span><span>
</span><span id="line-2624"></span><span>              </span><span id="local-6989586621682942395"><span class="annot"><a href="#local-6989586621682942395"><span class="hs-identifier hs-var hs-var">sanitise</span></a></span></span><span> </span><span id="local-6989586621682942396"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942396"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InType -&gt; InType) -&gt; Id -&gt; Id
</span><a href="GHC.Types.Var.html#updateIdTypeAndMult"><span class="hs-identifier hs-var">updateIdTypeAndMult</span></a></span><span> </span><span class="annot"><span class="annottext">InType -&gt; InType
</span><a href="GHC.Core.Type.html#expandTypeSynonyms"><span class="hs-identifier hs-var">expandTypeSynonyms</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942396"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2625"></span><span>                </span><span class="hs-comment">-- See Note [Free type variables of the qvar types]</span><span>
</span><span id="line-2626"></span><span>
</span><span id="line-2627"></span><span>        </span><span class="hs-comment">-- Check for bad coercion variables: see Note [SpecConstr and casts]</span><span>
</span><span id="line-2628"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942399"><span class="annot"><a href="#local-6989586621682942399"><span class="hs-identifier hs-var hs-var">bad_covars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942392"><span class="hs-identifier hs-var">qids</span></a></span><span>
</span><span id="line-2629"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-type">warnPprTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621682942399"><span class="hs-identifier hs-type">bad_covars</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2630"></span><span>              </span><span class="annot"><span class="hs-string">&quot;SpecConstr: bad covars&quot;</span></span><span>
</span><span id="line-2631"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942399"><span class="hs-identifier hs-type">bad_covars</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942367"><span class="hs-identifier hs-type">call</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-2632"></span><span>
</span><span id="line-2633"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621682942383"><span class="hs-identifier hs-type">interesting</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">null</span></span><span> </span><span class="annot"><a href="#local-6989586621682942399"><span class="hs-identifier hs-type">bad_covars</span></a></span><span>
</span><span id="line-2634"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942402"><span class="annot"><a href="#local-6989586621682942402"><span class="hs-identifier hs-var hs-var">cp_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CP"><span class="hs-identifier hs-type">CP</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cp_qvars :: [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_qvars"><span class="hs-identifier hs-var">cp_qvars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942393"><span class="hs-identifier hs-var">qvars'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_args :: [Expr Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_args"><span class="hs-identifier hs-var">cp_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942381"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2635"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_strict_args :: [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_strict_args"><span class="hs-identifier hs-var">cp_strict_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[Id]] -&gt; [Id]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[Id]]
</span><a href="#local-6989586621682942382"><span class="hs-identifier hs-var">cbv_ids</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2636"></span><span class="hs-comment">--                  ; pprTraceM &quot;callToPatOut&quot; $</span><span>
</span><span id="line-2637"></span><span class="hs-comment">--                    vcat [ text &quot;fn:&quot; &lt;+&gt; ppr fn</span><span>
</span><span id="line-2638"></span><span class="hs-comment">--                         , text &quot;args:&quot; &lt;+&gt; ppr args</span><span>
</span><span id="line-2639"></span><span class="hs-comment">--                         , text &quot;bndr_occs:&quot; &lt;+&gt; ppr bndr_occs</span><span>
</span><span id="line-2640"></span><span class="hs-comment">--                         , text &quot;pat_fvs:&quot; &lt;+&gt; ppr pat_fvs</span><span>
</span><span id="line-2641"></span><span class="hs-comment">--                         , text &quot;cp_res:&quot; &lt;+&gt; ppr cp_res ]</span><span>
</span><span id="line-2642"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621682942402"><span class="hs-identifier hs-type">cp_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2643"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2644"></span><span>
</span><span id="line-2645"></span><span>    </span><span class="hs-comment">-- argToPat takes an actual argument, and returns an abstracted</span><span>
</span><span id="line-2646"></span><span>    </span><span class="hs-comment">-- version, consisting of just the &quot;constructor skeleton&quot; of the</span><span>
</span><span id="line-2647"></span><span>    </span><span class="hs-comment">-- argument, with non-constructor sub-expression replaced by new</span><span>
</span><span id="line-2648"></span><span>    </span><span class="hs-comment">-- placeholder variables.  For example:</span><span>
</span><span id="line-2649"></span><span>    </span><span class="hs-comment">--    C a (D (f x) (g y))  ==&gt;  C p1 (D p2 p3)</span><span>
</span><span id="line-2650"></span><span>
</span><span id="line-2651"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#argToPat"><span class="hs-identifier hs-type">argToPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-2652"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span>                  </span><span class="hs-comment">-- What's in scope at the fn defn site</span><span>
</span><span id="line-2653"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ValueEnv"><span class="hs-identifier hs-type">ValueEnv</span></a></span><span>                    </span><span class="hs-comment">-- ValueEnv at the call site</span><span>
</span><span id="line-2654"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span>                     </span><span class="hs-comment">-- A call arg (or component thereof)</span><span>
</span><span id="line-2655"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span>
</span><span id="line-2656"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span>              </span><span class="hs-comment">-- Tells us if this argument is a strict field of a data constructor</span><span>
</span><span id="line-2657"></span><span>                                        </span><span class="hs-comment">-- See Note [SpecConstr and strict fields]</span><span>
</span><span id="line-2658"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2659"></span><span>
</span><span id="line-2660"></span><span class="hs-comment">-- Returns (interesting, pat),</span><span>
</span><span id="line-2661"></span><span class="hs-comment">-- where pat is the pattern derived from the argument</span><span>
</span><span id="line-2662"></span><span class="hs-comment">--            interesting=True if the pattern is non-trivial (not a variable or type)</span><span>
</span><span id="line-2663"></span><span class="hs-comment">-- E.g.         x:xs         --&gt; (True, x:xs)</span><span>
</span><span id="line-2664"></span><span class="hs-comment">--              f xs         --&gt; (False, w)        where w is a fresh wildcard</span><span>
</span><span id="line-2665"></span><span class="hs-comment">--              (f xs, 'c')  --&gt; (True, (w, 'c'))  where w is a fresh wildcard</span><span>
</span><span id="line-2666"></span><span class="hs-comment">--              \x. x+y      --&gt; (True, \x. x+y)</span><span>
</span><span id="line-2667"></span><span class="hs-comment">--              lvl7         --&gt; (True, lvl7)      if lvl7 is bound</span><span>
</span><span id="line-2668"></span><span class="hs-comment">--                                                 somewhere further out</span><span>
</span><span id="line-2669"></span><span>
</span><span id="line-2670"></span><span id="argToPat"><span class="annot"><span class="annottext">argToPat :: ScEnv
-&gt; InScopeSet
-&gt; ValueEnv
-&gt; Expr Id
-&gt; ArgOcc
-&gt; StrictnessMark
-&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#argToPat"><span class="hs-identifier hs-var hs-var">argToPat</span></a></span></span><span> </span><span id="local-6989586621682942403"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942403"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942404"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942404"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682942405"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942405"><span class="hs-identifier hs-var">val_env</span></a></span></span><span> </span><span id="local-6989586621682942406"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942406"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621682942407"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942407"><span class="hs-identifier hs-var">arg_occ</span></a></span></span><span> </span><span id="local-6989586621682942408"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942408"><span class="hs-identifier hs-var">arg_str</span></a></span></span><span>
</span><span id="line-2671"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2672"></span><span>    </span><span class="hs-comment">-- pprTraceM &quot;argToPatIn&quot; (ppr arg)</span><span>
</span><span id="line-2673"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682942409"><span class="annot"><a href="#local-6989586621682942409"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv
-&gt; InScopeSet
-&gt; ValueEnv
-&gt; Expr Id
-&gt; ArgOcc
-&gt; StrictnessMark
-&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#argToPat1"><span class="hs-identifier hs-var">argToPat1</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942403"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942404"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942405"><span class="hs-identifier hs-var">val_env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942406"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942407"><span class="hs-identifier hs-var">arg_occ</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942408"><span class="hs-identifier hs-var">arg_str</span></a></span><span>
</span><span id="line-2674"></span><span>    </span><span class="hs-comment">-- pprTraceM &quot;argToPatOut&quot; (ppr res)</span><span>
</span><span id="line-2675"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682942409"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-2676"></span><span>
</span><span id="line-2677"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#argToPat1"><span class="hs-identifier hs-type">argToPat1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScEnv"><span class="hs-identifier hs-type">ScEnv</span></a></span><span>
</span><span id="line-2678"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span>
</span><span id="line-2679"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ValueEnv"><span class="hs-identifier hs-type">ValueEnv</span></a></span><span>
</span><span id="line-2680"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Expr"><span class="hs-identifier hs-type">Expr</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span>
</span><span id="line-2681"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ArgOcc"><span class="hs-identifier hs-type">ArgOcc</span></a></span><span>
</span><span id="line-2682"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span>
</span><span id="line-2683"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Expr"><span class="hs-identifier hs-type">Expr</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2684"></span><span id="argToPat1"><span class="annot"><span class="annottext">argToPat1 :: ScEnv
-&gt; InScopeSet
-&gt; ValueEnv
-&gt; Expr Id
-&gt; ArgOcc
-&gt; StrictnessMark
-&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#argToPat1"><span class="hs-identifier hs-var hs-var">argToPat1</span></a></span></span><span> </span><span id="local-6989586621682942412"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942412"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621682942413"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942413"><span class="hs-identifier hs-var">_in_scope</span></a></span></span><span> </span><span id="local-6989586621682942414"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942414"><span class="hs-identifier hs-var">_val_env</span></a></span></span><span> </span><span id="local-6989586621682942415"><span class="annot"><span class="annottext">arg :: Expr Id
</span><a href="#local-6989586621682942415"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942416"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942416"><span class="hs-identifier hs-var">_arg_occ</span></a></span></span><span> </span><span id="local-6989586621682942417"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942417"><span class="hs-identifier hs-var">_arg_str</span></a></span></span><span>
</span><span id="line-2685"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, Expr Id, [Id]) -&gt; UniqSM (Bool, Expr Id, [Id])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942415"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2686"></span><span>
</span><span id="line-2687"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#argToPat1"><span class="hs-identifier hs-var">argToPat1</span></a></span><span> </span><span id="local-6989586621682942418"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942418"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942419"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942419"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682942420"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942420"><span class="hs-identifier hs-var">val_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682942421"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942421"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942422"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942422"><span class="hs-identifier hs-var">arg_occ</span></a></span></span><span> </span><span id="local-6989586621682942423"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942423"><span class="hs-identifier hs-var">arg_str</span></a></span></span><span>
</span><span id="line-2688"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
-&gt; InScopeSet
-&gt; ValueEnv
-&gt; Expr Id
-&gt; ArgOcc
-&gt; StrictnessMark
-&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#argToPat"><span class="hs-identifier hs-var">argToPat</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942418"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942419"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942420"><span class="hs-identifier hs-var">val_env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942421"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942422"><span class="hs-identifier hs-var">arg_occ</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942423"><span class="hs-identifier hs-var">arg_str</span></a></span><span>
</span><span id="line-2689"></span><span>        </span><span class="hs-comment">-- Note [Tick annotations in call patterns]</span><span>
</span><span id="line-2690"></span><span>        </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-2691"></span><span>        </span><span class="hs-comment">-- Ignore Notes.  In particular, we want to ignore any InlineMe notes</span><span>
</span><span id="line-2692"></span><span>        </span><span class="hs-comment">-- Perhaps we should not ignore profiling notes, but I'm going to</span><span>
</span><span id="line-2693"></span><span>        </span><span class="hs-comment">-- ride roughshod over them all for now.</span><span>
</span><span id="line-2694"></span><span>        </span><span class="hs-comment">--- See Note [Tick annotations in RULE matching] in GHC.Core.Rules</span><span>
</span><span id="line-2695"></span><span>
</span><span id="line-2696"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#argToPat1"><span class="hs-identifier hs-var">argToPat1</span></a></span><span> </span><span id="local-6989586621682942424"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942424"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942425"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942425"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682942426"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942426"><span class="hs-identifier hs-var">val_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">OutBind
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682942427"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942427"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942428"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942428"><span class="hs-identifier hs-var">arg_occ</span></a></span></span><span> </span><span id="local-6989586621682942429"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942429"><span class="hs-identifier hs-var">arg_str</span></a></span></span><span>
</span><span id="line-2697"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScEnv
-&gt; InScopeSet
-&gt; ValueEnv
-&gt; Expr Id
-&gt; ArgOcc
-&gt; StrictnessMark
-&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#argToPat"><span class="hs-identifier hs-var">argToPat</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942424"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942425"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942426"><span class="hs-identifier hs-var">val_env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942427"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942428"><span class="hs-identifier hs-var">arg_occ</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942429"><span class="hs-identifier hs-var">arg_str</span></a></span><span>
</span><span id="line-2698"></span><span>        </span><span class="hs-comment">-- See Note [Matching lets] in &quot;GHC.Core.Rules&quot;</span><span>
</span><span id="line-2699"></span><span>        </span><span class="hs-comment">-- Look through let expressions</span><span>
</span><span id="line-2700"></span><span>        </span><span class="hs-comment">-- e.g.         f (let v = rhs in (v,w))</span><span>
</span><span id="line-2701"></span><span>        </span><span class="hs-comment">-- Here we can specialise for f (v,w)</span><span>
</span><span id="line-2702"></span><span>        </span><span class="hs-comment">-- because the rule-matcher will look through the let.</span><span>
</span><span id="line-2703"></span><span>
</span><span id="line-2704"></span><span>   </span><span class="hs-comment">-- Casts: see Note [SpecConstr and casts]</span><span>
</span><span id="line-2705"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#argToPat1"><span class="hs-identifier hs-var">argToPat1</span></a></span><span> </span><span id="local-6989586621682942430"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942430"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942431"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942431"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682942432"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942432"><span class="hs-identifier hs-var">val_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621682942433"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942433"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621682942434"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682942434"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942435"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942435"><span class="hs-identifier hs-var">arg_occ</span></a></span></span><span> </span><span id="local-6989586621682942436"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942436"><span class="hs-identifier hs-var">arg_str</span></a></span></span><span>
</span><span id="line-2706"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; InType -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#ignoreType"><span class="hs-identifier hs-var">ignoreType</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942430"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682942437"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2707"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942438"><span class="annot"><a href="#local-6989586621682942438"><span class="hs-identifier hs-var">interesting</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942439"><span class="annot"><a href="#local-6989586621682942439"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942440"><span class="annot"><a href="#local-6989586621682942440"><span class="hs-identifier hs-var">strict_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScEnv
-&gt; InScopeSet
-&gt; ValueEnv
-&gt; Expr Id
-&gt; ArgOcc
-&gt; StrictnessMark
-&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#argToPat"><span class="hs-identifier hs-var">argToPat</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942430"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942431"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942432"><span class="hs-identifier hs-var">val_env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942433"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942435"><span class="hs-identifier hs-var">arg_occ</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942436"><span class="hs-identifier hs-var">arg_str</span></a></span><span>
</span><span id="line-2708"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier hs-type">not</span></span><span> </span><span class="annot"><a href="#local-6989586621682942438"><span class="hs-identifier hs-type">interesting</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-2709"></span><span>                </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#wildCardPat"><span class="hs-identifier hs-type">wildCardPat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942437"><span class="hs-identifier hs-type">ty2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942436"><span class="hs-identifier hs-type">arg_str</span></a></span><span>
</span><span id="line-2710"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-2711"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682942438"><span class="hs-identifier hs-type">interesting</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942439"><span class="hs-identifier hs-type">arg'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942434"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682942440"><span class="hs-identifier hs-type">strict_args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2712"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2713"></span><span>    </span><span id="local-6989586621682942437"><span class="annot"><span class="annottext">ty2 :: InType
</span><a href="#local-6989586621682942437"><span class="hs-identifier hs-var hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Coercion -&gt; InType
Coercion -&gt; InType
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682942434"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2714"></span><span>
</span><span id="line-2715"></span><span>  </span><span class="hs-comment">-- Check for a constructor application</span><span>
</span><span id="line-2716"></span><span>  </span><span class="hs-comment">-- NB: this *precedes* the Var case, so that we catch nullary constrs</span><span>
</span><span id="line-2717"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#argToPat1"><span class="hs-identifier hs-var">argToPat1</span></a></span><span> </span><span id="local-6989586621682942443"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942443"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942444"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942444"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682942445"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942445"><span class="hs-identifier hs-var">val_env</span></a></span></span><span> </span><span id="local-6989586621682942446"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942446"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621682942447"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942447"><span class="hs-identifier hs-var">arg_occ</span></a></span></span><span> </span><span id="local-6989586621682942448"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942448"><span class="hs-identifier hs-var">_arg_str</span></a></span></span><span>
</span><span id="line-2718"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ConVal"><span class="hs-identifier hs-type">ConVal</span></a></span><span> </span><span id="local-6989586621682942449"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682942449"><span class="hs-identifier hs-var">_wf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621682942450"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942450"><span class="hs-identifier hs-var">dc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942451"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942451"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ValueEnv -&gt; Expr Id -&gt; Maybe Value
</span><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942445"><span class="hs-identifier hs-var">val_env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942446"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2719"></span><span>    </span><span class="hs-comment">-- Ignore `_wf` here; see Note [ConVal work-free-ness] (2)</span><span>
</span><span id="line-2720"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; DataCon -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#ignoreDataCon"><span class="hs-identifier hs-var">ignoreDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942443"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942450"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- See Note [NoSpecConstr]</span><span>
</span><span id="line-2721"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682942452"><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942452"><span class="hs-identifier hs-var">arg_occs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Maybe [ArgOcc]
</span><a href="#local-6989586621682942453"><span class="hs-identifier hs-var">mb_scrut</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942450"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2722"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942454"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942454"><span class="hs-identifier hs-var hs-var">ty_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942455"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942455"><span class="hs-identifier hs-var hs-var">rest_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Expr Id] -&gt; ([Expr Id], [Expr Id])
forall b a. [b] -&gt; [a] -&gt; ([a], [a])
</span><a href="GHC.Utils.Misc.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [Id]
</span><a href="GHC.Core.DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942450"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942451"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2723"></span><span>             </span><span class="annot"><a href="#local-6989586621682942458"><span class="hs-identifier hs-type">con_str</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682942459"><span class="hs-identifier hs-type">matched_str</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2724"></span><span>             </span><span class="hs-comment">-- con_str corresponds 1-1 with the /value/ arguments</span><span>
</span><span id="line-2725"></span><span>             </span><span class="hs-comment">-- matched_str corresponds 1-1 with /all/ arguments</span><span>
</span><span id="line-2726"></span><span>             </span><span id="local-6989586621682942458"><span class="annot"><span class="annottext">con_str :: [StrictnessMark]
</span><a href="#local-6989586621682942458"><span class="hs-identifier hs-var hs-var hs-var">con_str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [StrictnessMark]
</span><a href="GHC.Core.DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942450"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2727"></span><span>             </span><span id="local-6989586621682942459"><span class="annot"><span class="annottext">matched_str :: [StrictnessMark]
</span><a href="#local-6989586621682942459"><span class="hs-identifier hs-var hs-var hs-var">matched_str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[StrictnessMark] -&gt; [Expr Id] -&gt; [StrictnessMark]
</span><a href="#local-6989586621682942461"><span class="hs-identifier hs-var">match_vals</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682942458"><span class="hs-identifier hs-var">con_str</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942455"><span class="hs-identifier hs-var">rest_args</span></a></span><span>
</span><span id="line-2728"></span><span>      </span><span class="hs-comment">--  ; pprTraceM &quot;bangs&quot; (ppr (length rest_args == length con_str) $$</span><span>
</span><span id="line-2729"></span><span>      </span><span class="hs-comment">--       ppr dc $$</span><span>
</span><span id="line-2730"></span><span>      </span><span class="hs-comment">--       ppr con_str $$</span><span>
</span><span id="line-2731"></span><span>      </span><span class="hs-comment">--       ppr rest_args $$</span><span>
</span><span id="line-2732"></span><span>      </span><span class="hs-comment">--       ppr (map isTypeArg rest_args))</span><span>
</span><span id="line-2733"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682942462"><span class="annot"><a href="#local-6989586621682942462"><span class="hs-identifier hs-var">prs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Id
 -&gt; ArgOcc -&gt; StrictnessMark -&gt; UniqSM (Bool, Expr Id, [Id]))
-&gt; [Expr Id]
-&gt; [ArgOcc]
-&gt; [StrictnessMark]
-&gt; UniqSM [(Bool, Expr Id, [Id])]
forall (m :: * -&gt; *) a b c d.
Monad m =&gt;
(a -&gt; b -&gt; c -&gt; m d) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; m [d]
</span><a href="GHC.Utils.Monad.html#zipWith3M"><span class="hs-identifier hs-var">zipWith3M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv
-&gt; InScopeSet
-&gt; ValueEnv
-&gt; Expr Id
-&gt; ArgOcc
-&gt; StrictnessMark
-&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#argToPat"><span class="hs-identifier hs-var">argToPat</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942443"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942444"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942445"><span class="hs-identifier hs-var">val_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942455"><span class="hs-identifier hs-var">rest_args</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942452"><span class="hs-identifier hs-var">arg_occs</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682942459"><span class="hs-identifier hs-var">matched_str</span></a></span><span>
</span><span id="line-2734"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682942463"><span class="annot"><a href="#local-6989586621682942463"><span class="hs-identifier hs-var hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Bool, Expr Id, [Id]) -&gt; Expr Id)
-&gt; [(Bool, Expr Id, [Id])] -&gt; [Expr Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Bool, Expr Id, [Id]) -&gt; Expr Id
forall a b c. (a, b, c) -&gt; b
</span><a href="GHC.Utils.Misc.html#sndOf3"><span class="hs-identifier hs-var">sndOf3</span></a></span><span> </span><span class="annot"><span class="annottext">[(Bool, Expr Id, [Id])]
</span><a href="#local-6989586621682942462"><span class="hs-identifier hs-var">prs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2735"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-type">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="annot"><a href="#local-6989586621682942458"><span class="hs-identifier hs-type">con_str</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">filter</span></span><span> </span><span class="annot"><a href="GHC.Core.html#isRuntimeArg"><span class="hs-identifier hs-type">isRuntimeArg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942455"><span class="hs-identifier hs-type">rest_args</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2736"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942458"><span class="hs-identifier hs-type">con_str</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942455"><span class="hs-identifier hs-type">rest_args</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span>
</span><span id="line-2737"></span><span>              </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="annot"><a href="#local-6989586621682942458"><span class="hs-identifier hs-type">con_str</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-type">$$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-type">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">length</span></span><span> </span><span class="annot"><a href="#local-6989586621682942455"><span class="hs-identifier hs-type">rest_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2738"></span><span>            </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2739"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#mkConApp"><span class="hs-identifier hs-type">mkConApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942450"><span class="hs-identifier hs-type">dc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682942454"><span class="hs-identifier hs-type">ty_args</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">++</span></span><span> </span><span class="annot"><a href="#local-6989586621682942463"><span class="hs-identifier hs-type">args'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">concat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">map</span></span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#thdOf3"><span class="hs-identifier hs-type">thdOf3</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942462"><span class="hs-identifier hs-type">prs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2740"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2741"></span><span>    </span><span id="local-6989586621682942453"><span class="annot"><span class="annottext">mb_scrut :: DataCon -&gt; Maybe [ArgOcc]
</span><a href="#local-6989586621682942453"><span class="hs-identifier hs-var hs-var">mb_scrut</span></a></span></span><span> </span><span id="local-6989586621682942469"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942469"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942447"><span class="hs-identifier hs-var">arg_occ</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2742"></span><span>                </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ScrutOcc"><span class="hs-identifier hs-type">ScrutOcc</span></a></span><span> </span><span id="local-6989586621682942470"><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682942470"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682942471"><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942471"><span class="hs-identifier hs-var">occs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc] -&gt; DataCon -&gt; Maybe [ArgOcc]
forall key elt. Uniquable key =&gt; UniqFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.FM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a></span><span> </span><span class="annot"><span class="annottext">DataConEnv [ArgOcc]
</span><a href="#local-6989586621682942470"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942469"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2743"></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ArgOcc] -&gt; Maybe [ArgOcc]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ArgOcc]
</span><a href="#local-6989586621682942471"><span class="hs-identifier hs-var">occs</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [Reboxing]</span><span>
</span><span id="line-2744"></span><span>                </span><span id="local-6989586621682942472"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942472"><span class="hs-identifier hs-var">_other</span></a></span></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_force"><span class="hs-identifier hs-var">sc_force</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942443"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">SpecConstrOpts -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_keen"><span class="hs-identifier hs-var">sc_keen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; SpecConstrOpts
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_opts"><span class="hs-identifier hs-var">sc_opts</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942443"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2745"></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ArgOcc] -&gt; Maybe [ArgOcc]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgOcc -&gt; [ArgOcc]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="GHC.Core.Opt.SpecConstr.html#UnkOcc"><span class="hs-identifier hs-var">UnkOcc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2746"></span><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-2747"></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe [ArgOcc]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2748"></span><span>    </span><span id="local-6989586621682942461"><span class="annot"><span class="annottext">match_vals :: [StrictnessMark] -&gt; [Expr Id] -&gt; [StrictnessMark]
</span><a href="#local-6989586621682942461"><span class="hs-identifier hs-var hs-var">match_vals</span></a></span></span><span> </span><span id="local-6989586621682942474"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682942474"><span class="hs-identifier hs-var">bangs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942475"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942475"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682942476"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942476"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2749"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942475"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2750"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark -&gt; [StrictnessMark] -&gt; [StrictnessMark]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark] -&gt; [Expr Id] -&gt; [StrictnessMark]
</span><a href="#local-6989586621682942461"><span class="hs-identifier hs-var">match_vals</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682942474"><span class="hs-identifier hs-var">bangs</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942476"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2751"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942477"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942477"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682942478"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682942478"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682942474"><span class="hs-identifier hs-var">bangs</span></a></span><span>
</span><span id="line-2752"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942477"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark -&gt; [StrictnessMark] -&gt; [StrictnessMark]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark] -&gt; [Expr Id] -&gt; [StrictnessMark]
</span><a href="#local-6989586621682942461"><span class="hs-identifier hs-var">match_vals</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682942478"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942476"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2753"></span><span>    </span><span class="annot"><a href="#local-6989586621682942461"><span class="hs-identifier hs-var">match_vals</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2754"></span><span>    </span><span class="annot"><a href="#local-6989586621682942461"><span class="hs-identifier hs-var">match_vals</span></a></span><span> </span><span id="local-6989586621682942479"><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682942479"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621682942480"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942480"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2755"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [StrictnessMark]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;spec-constr:argToPat - Bangs don't match value arguments&quot;</span></span><span>
</span><span id="line-2756"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arg:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942446"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-2757"></span><span>             </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;remaining args:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621682942479"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-2758"></span><span>             </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;remaining bangs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942480"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2759"></span><span>
</span><span id="line-2760"></span><span>  </span><span class="hs-comment">-- Check if the argument is a variable that</span><span>
</span><span id="line-2761"></span><span>  </span><span class="hs-comment">--    (a) is used in an interesting way in the function body</span><span>
</span><span id="line-2762"></span><span>  </span><span class="hs-comment">---       i.e. ScrutOcc. UnkOcc and NoOcc are not interesting</span><span>
</span><span id="line-2763"></span><span>  </span><span class="hs-comment">--        (NoOcc means we could drop the argument, but that's the</span><span>
</span><span id="line-2764"></span><span>  </span><span class="hs-comment">--         business of absence analysis, not SpecConstr.)</span><span>
</span><span id="line-2765"></span><span>  </span><span class="hs-comment">--    (b) we know what its value is</span><span>
</span><span id="line-2766"></span><span>  </span><span class="hs-comment">-- In that case it counts as &quot;interesting&quot;</span><span>
</span><span id="line-2767"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#argToPat1"><span class="hs-identifier hs-var">argToPat1</span></a></span><span> </span><span id="local-6989586621682942482"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942482"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621682942483"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942483"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621682942484"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942484"><span class="hs-identifier hs-var">val_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682942485"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942485"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942486"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942486"><span class="hs-identifier hs-var">arg_occ</span></a></span></span><span> </span><span id="local-6989586621682942487"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942487"><span class="hs-identifier hs-var">arg_str</span></a></span></span><span>
</span><span id="line-2768"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ScEnv -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#sc_force"><span class="hs-identifier hs-var">sc_force</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942482"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">ArgOcc -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#specialisableArgOcc"><span class="hs-identifier hs-var">specialisableArgOcc</span></a></span><span> </span><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942486"><span class="hs-identifier hs-var">arg_occ</span></a></span><span>  </span><span class="hs-comment">-- (a)</span><span>
</span><span id="line-2769"></span><span>    </span><span class="hs-comment">-- See Note [Forcing specialisation], point (FS3)</span><span>
</span><span id="line-2770"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682942488"><span class="hs-identifier hs-var">is_value</span></a></span><span>                                     </span><span class="hs-comment">-- (b)</span><span>
</span><span id="line-2771"></span><span>       </span><span class="hs-comment">-- Ignoring sc_keen here to avoid gratuitously incurring Note [Reboxing]</span><span>
</span><span id="line-2772"></span><span>       </span><span class="hs-comment">-- So sc_keen focused just on f (I# x), where we have freshly-allocated</span><span>
</span><span id="line-2773"></span><span>       </span><span class="hs-comment">-- box that we can eliminate in the caller</span><span>
</span><span id="line-2774"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScEnv -&gt; InType -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#ignoreType"><span class="hs-identifier hs-var">ignoreType</span></a></span><span> </span><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942482"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; InType
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942485"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2775"></span><span>  </span><span class="hs-comment">-- See Note [SpecConstr and strict fields]</span><span>
</span><span id="line-2776"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, Expr Id, [Id]) -&gt; UniqSM (Bool, Expr Id, [Id])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Expr Id
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942485"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">StrictnessMark -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isMarkedStrict"><span class="hs-identifier hs-var">isMarkedStrict</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942487"><span class="hs-identifier hs-var">arg_str</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942485"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Id]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-2777"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2778"></span><span>    </span><span id="local-6989586621682942488"><span class="annot"><span class="annottext">is_value :: Bool
</span><a href="#local-6989586621682942488"><span class="hs-identifier hs-var hs-var">is_value</span></a></span></span><span>
</span><span id="line-2779"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942485"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942485"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; InScopeSet -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemInScopeSet"><span class="hs-operator hs-var">`elemInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942483"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-2780"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Value -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueEnv -&gt; Id -&gt; Maybe Value
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942484"><span class="hs-identifier hs-var">val_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942485"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2781"></span><span>                </span><span class="hs-comment">-- Local variables have values in val_env</span><span>
</span><span id="line-2782"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isValueUnfolding"><span class="hs-identifier hs-var">isValueUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942485"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2783"></span><span>                </span><span class="hs-comment">-- Imports have unfoldings</span><span>
</span><span id="line-2784"></span><span>
</span><span id="line-2785"></span><span class="hs-comment">--      I'm really not sure what this comment means</span><span>
</span><span id="line-2786"></span><span class="hs-comment">--      And by not wild-carding we tend to get forall'd</span><span>
</span><span id="line-2787"></span><span class="hs-comment">--      variables that are in scope, which in turn can</span><span>
</span><span id="line-2788"></span><span class="hs-comment">--      expose the weakness in let-matching</span><span>
</span><span id="line-2789"></span><span class="hs-comment">--      See Note [Matching lets] in GHC.Core.Rules</span><span>
</span><span id="line-2790"></span><span>
</span><span id="line-2791"></span><span>  </span><span class="hs-comment">-- Check for a variable bound inside the function.</span><span>
</span><span id="line-2792"></span><span>  </span><span class="hs-comment">-- Don't make a wild-card, because we may usefully share</span><span>
</span><span id="line-2793"></span><span>  </span><span class="hs-comment">--    e.g.  f a = let x = ... in f (x,x)</span><span>
</span><span id="line-2794"></span><span>  </span><span class="hs-comment">-- NB: this case follows the lambda and con-app cases!!</span><span>
</span><span id="line-2795"></span><span class="hs-comment">-- argToPat _in_scope _val_env (Var v) _arg_occ</span><span>
</span><span id="line-2796"></span><span class="hs-comment">--   = return (False, Var v)</span><span>
</span><span id="line-2797"></span><span>        </span><span class="hs-comment">-- SLPJ : disabling this to avoid proliferation of versions</span><span>
</span><span id="line-2798"></span><span>        </span><span class="hs-comment">-- also works badly when thinking about seeding the loop</span><span>
</span><span id="line-2799"></span><span>        </span><span class="hs-comment">-- from the body of the let</span><span>
</span><span id="line-2800"></span><span>        </span><span class="hs-comment">--       f x y = letrec g z = ... in g (x,y)</span><span>
</span><span id="line-2801"></span><span>        </span><span class="hs-comment">-- We don't want to specialise for that *particular* x,y</span><span>
</span><span id="line-2802"></span><span>
</span><span id="line-2803"></span><span>
</span><span id="line-2804"></span><span class="hs-comment">{- Disabled; see Note [Matching cases] in &quot;GHC.Core.Rules&quot;
argToPat env in_scope val_env (Case scrut _ _ [(_, _, rhs)]) arg_occ
  | exprOkForSpeculation scrut  -- See Note [Matching cases] in &quot;GHC.Core.Rules&quot;
  = argToPat env in_scope val_env rhs arg_occ
-}</span><span>
</span><span id="line-2809"></span><span>
</span><span id="line-2810"></span><span class="hs-comment">{-      Disabling lambda specialisation for now
        It's fragile, and the spec_loop can be infinite
argToPat in_scope val_env arg arg_occ
  | is_value_lam arg
  = return (True, arg)
  where
    is_value_lam (Lam v e)         -- Spot a value lambda, even if
        | isId v       = True      -- it is inside a type lambda
        | otherwise    = is_value_lam e
    is_value_lam other = False
-}</span><span>
</span><span id="line-2821"></span><span>
</span><span id="line-2822"></span><span>  </span><span class="hs-comment">-- The default case: make a wild-card</span><span>
</span><span id="line-2823"></span><span>  </span><span class="hs-comment">-- We use this for coercions too</span><span>
</span><span id="line-2824"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#argToPat1"><span class="hs-identifier hs-var">argToPat1</span></a></span><span> </span><span id="local-6989586621682942494"><span class="annot"><span class="annottext">ScEnv
</span><a href="#local-6989586621682942494"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621682942495"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942495"><span class="hs-identifier hs-var">_in_scope</span></a></span></span><span> </span><span id="local-6989586621682942496"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942496"><span class="hs-identifier hs-var">_val_env</span></a></span></span><span> </span><span id="local-6989586621682942497"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942497"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621682942498"><span class="annot"><span class="annottext">ArgOcc
</span><a href="#local-6989586621682942498"><span class="hs-identifier hs-var">_arg_occ</span></a></span></span><span> </span><span id="local-6989586621682942499"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942499"><span class="hs-identifier hs-var">arg_str</span></a></span></span><span>
</span><span id="line-2825"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InType -&gt; StrictnessMark -&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#wildCardPat"><span class="hs-identifier hs-var">wildCardPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Expr Id -&gt; InType
Expr Id -&gt; InType
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942497"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942499"><span class="hs-identifier hs-var">arg_str</span></a></span><span>
</span><span id="line-2826"></span><span>
</span><span id="line-2827"></span><span class="annot"><span class="hs-comment">-- | wildCardPats are always boring</span></span><span>
</span><span id="line-2828"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#wildCardPat"><span class="hs-identifier hs-type">wildCardPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2829"></span><span id="wildCardPat"><span class="annot"><span class="annottext">wildCardPat :: InType -&gt; StrictnessMark -&gt; UniqSM (Bool, Expr Id, [Id])
</span><a href="GHC.Core.Opt.SpecConstr.html#wildCardPat"><span class="hs-identifier hs-var hs-var">wildCardPat</span></a></span></span><span> </span><span id="local-6989586621682942500"><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682942500"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682942501"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621682942501"><span class="hs-identifier hs-var">str</span></a></span></span><span>
</span><span id="line-2830"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682942502"><span class="annot"><a href="#local-6989586621682942502"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; InType -&gt; InType -&gt; UniqSM Id
forall (m :: * -&gt; *).
MonadUnique m =&gt;
FastString -&gt; InType -&gt; InType -&gt; m Id
</span><a href="GHC.Types.Id.html#mkSysLocalOrCoVarM"><span class="hs-identifier hs-var">mkSysLocalOrCoVarM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sc&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">InType
</span><a href="#local-6989586621682942500"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2831"></span><span>       </span><span class="hs-comment">-- ; pprTraceM &quot;wildCardPat&quot; (ppr id' &lt;+&gt; ppr (idUnfolding id'))</span><span>
</span><span id="line-2832"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-type">varToCoreExpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942502"><span class="hs-identifier hs-type">id</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#isMarkedStrict"><span class="hs-identifier hs-type">isMarkedStrict</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682942501"><span class="hs-identifier hs-type">str</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682942502"><span class="hs-identifier hs-type">id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2833"></span><span>
</span><span id="line-2834"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-type">isValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#ValueEnv"><span class="hs-identifier hs-type">ValueEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-2835"></span><span id="isValue"><span class="annot"><span class="annottext">isValue :: ValueEnv -&gt; Expr Id -&gt; Maybe Value
</span><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var hs-var">isValue</span></a></span></span><span> </span><span id="local-6989586621682942504"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942504"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621682942505"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682942505"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2836"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Bool
</span><a href="GHC.Types.Literal.html#litIsLifted"><span class="hs-identifier hs-var">litIsLifted</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682942505"><span class="hs-identifier hs-var">lit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2837"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; AltCon -&gt; [Expr Id] -&gt; Value
</span><a href="GHC.Core.Opt.SpecConstr.html#ConVal"><span class="hs-identifier hs-var">ConVal</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; AltCon
</span><a href="GHC.Core.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621682942505"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2838"></span><span>
</span><span id="line-2839"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span id="local-6989586621682942506"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942506"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682942507"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942507"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2840"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621682942508"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621682942508"><span class="hs-identifier hs-var">cval</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ValueEnv -&gt; Id -&gt; Maybe Value
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942506"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942507"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-2841"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621682942508"><span class="hs-identifier hs-var">cval</span></a></span><span>  </span><span class="hs-comment">-- You might think we could look in the idUnfolding here</span><span>
</span><span id="line-2842"></span><span>               </span><span class="hs-comment">-- but that doesn't take account of which branch of a</span><span>
</span><span id="line-2843"></span><span>               </span><span class="hs-comment">-- case we are in, which is the whole point</span><span>
</span><span id="line-2844"></span><span>
</span><span id="line-2845"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942507"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isCheapUnfolding"><span class="hs-identifier hs-var">isCheapUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682942510"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-2846"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValueEnv -&gt; Expr Id -&gt; Maybe Value
</span><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942506"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding -&gt; Expr Id
</span><a href="GHC.Core.html#unfoldingTemplate"><span class="hs-identifier hs-var">unfoldingTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621682942510"><span class="hs-identifier hs-var">unf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2847"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2848"></span><span>    </span><span id="local-6989586621682942510"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621682942510"><span class="hs-identifier hs-var hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942507"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-2849"></span><span>        </span><span class="hs-comment">-- However we do want to consult the unfolding</span><span>
</span><span id="line-2850"></span><span>        </span><span class="hs-comment">-- as well, for let-bound constructors!</span><span>
</span><span id="line-2851"></span><span>
</span><span id="line-2852"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span id="local-6989586621682942512"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942512"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682942513"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942513"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682942514"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942514"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2853"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942513"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ValueEnv -&gt; Expr Id -&gt; Maybe Value
</span><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942512"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942514"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2854"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="GHC.Core.Opt.SpecConstr.html#LambdaVal"><span class="hs-identifier hs-var">LambdaVal</span></a></span><span>
</span><span id="line-2855"></span><span>                  </span><span class="annot"><span class="annottext">Maybe Value
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2856"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="GHC.Core.Opt.SpecConstr.html#LambdaVal"><span class="hs-identifier hs-var">LambdaVal</span></a></span><span>
</span><span id="line-2857"></span><span>
</span><span id="line-2858"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span id="local-6989586621682942515"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942515"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621682942516"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682942516"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621682942517"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942517"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2859"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621682942516"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2860"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValueEnv -&gt; Expr Id -&gt; Maybe Value
</span><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942515"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942517"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2861"></span><span>
</span><span id="line-2862"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span id="local-6989586621682942519"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942519"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621682942520"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942520"><span class="hs-identifier hs-var">expr</span></a></span></span><span>       </span><span class="hs-comment">-- Maybe it's a constructor application</span><span>
</span><span id="line-2863"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621682942521"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942521"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942522"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942522"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool)
-&gt; Expr Id -&gt; (Expr Id, [Expr Id], [CoreTickish])
forall b.
(CoreTickish -&gt; Bool)
-&gt; Expr b -&gt; (Expr b, [Expr b], [CoreTickish])
</span><a href="GHC.Core.html#collectArgsTicks"><span class="hs-identifier hs-var">collectArgsTicks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (CoreTickish -&gt; Bool) -&gt; CoreTickish -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942520"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-2864"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Id -&gt; IdDetails
</span><a href="GHC.Types.Var.html#idDetails"><span class="hs-identifier hs-var">idDetails</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942521"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2865"></span><span>        </span><span class="annot"><a href="GHC.Types.Id.Info.html#DataConWorkId"><span class="hs-identifier hs-type">DataConWorkId</span></a></span><span> </span><span id="local-6989586621682942526"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942526"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942522"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthAtLeast"><span class="hs-operator hs-var">`lengthAtLeast`</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Int
</span><a href="GHC.Core.DataCon.html#dataConRepArity"><span class="hs-identifier hs-var">dataConRepArity</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942526"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-2866"></span><span>                </span><span class="hs-comment">-- Check saturated; might be &gt; because the</span><span>
</span><span id="line-2867"></span><span>                </span><span class="hs-comment">--                  arity excludes type args</span><span>
</span><span id="line-2868"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; AltCon -&gt; [Expr Id] -&gt; Value
</span><a href="GHC.Core.Opt.SpecConstr.html#ConVal"><span class="hs-identifier hs-var">ConVal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr Id -&gt; Bool) -&gt; [Expr Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsWorkFree"><span class="hs-identifier hs-var">exprIsWorkFree</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942522"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682942526"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942522"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2869"></span><span>
</span><span id="line-2870"></span><span>        </span><span class="annot"><a href="GHC.Types.Id.Info.html#DFunId"><span class="hs-identifier hs-type">DFunId</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="GHC.Core.Opt.SpecConstr.html#LambdaVal"><span class="hs-identifier hs-var">LambdaVal</span></a></span><span>
</span><span id="line-2871"></span><span>        </span><span class="hs-comment">-- DFunId: see Note [Specialising on dictionaries]</span><span>
</span><span id="line-2872"></span><span>
</span><span id="line-2873"></span><span>        </span><span id="local-6989586621682942531"><span class="annot"><span class="annottext">IdDetails
</span><a href="#local-6989586621682942531"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; Int
forall b. [Arg b] -&gt; Int
</span><a href="GHC.Core.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942522"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621682942521"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-2874"></span><span>                </span><span class="hs-comment">-- Under-applied function</span><span>
</span><span id="line-2875"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="GHC.Core.Opt.SpecConstr.html#LambdaVal"><span class="hs-identifier hs-var">LambdaVal</span></a></span><span>        </span><span class="hs-comment">-- Partial application</span><span>
</span><span id="line-2876"></span><span>
</span><span id="line-2877"></span><span>        </span><span id="local-6989586621682942534"><span class="annot"><span class="annottext">IdDetails
</span><a href="#local-6989586621682942534"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2878"></span><span>
</span><span id="line-2879"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#isValue"><span class="hs-identifier hs-var">isValue</span></a></span><span> </span><span id="local-6989586621682942535"><span class="annot"><span class="annottext">ValueEnv
</span><a href="#local-6989586621682942535"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621682942536"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621682942536"><span class="hs-identifier hs-var">_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2880"></span><span>
</span><span id="line-2881"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#betterPat"><span class="hs-identifier hs-type">betterPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2882"></span><span class="hs-comment">-- pat1    f @a   (Just @a   (x::a))</span><span>
</span><span id="line-2883"></span><span class="hs-comment">--      is better than</span><span>
</span><span id="line-2884"></span><span class="hs-comment">-- pat2    f @Int (Just @Int (x::Int))</span><span>
</span><span id="line-2885"></span><span class="hs-comment">-- That is, we can instantiate pat1 to get pat2, using only type instantiate</span><span>
</span><span id="line-2886"></span><span class="hs-comment">-- See Note [Pattern duplicate elimination]</span><span>
</span><span id="line-2887"></span><span id="betterPat"><span class="annot"><span class="annottext">betterPat :: InScopeSet -&gt; CallPat -&gt; CallPat -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#betterPat"><span class="hs-identifier hs-var hs-var">betterPat</span></a></span></span><span> </span><span id="local-6989586621682942537"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942537"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CP"><span class="hs-identifier hs-type">CP</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cp_qvars :: CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_qvars"><span class="hs-identifier hs-var">cp_qvars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942538"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942538"><span class="hs-identifier hs-var">vs1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_args :: CallPat -&gt; [Expr Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_args"><span class="hs-identifier hs-var">cp_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942539"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942539"><span class="hs-identifier hs-var">as1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2888"></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CP"><span class="hs-identifier hs-type">CP</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cp_qvars :: CallPat -&gt; [Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_qvars"><span class="hs-identifier hs-var">cp_qvars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942540"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942540"><span class="hs-identifier hs-var">vs2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cp_args :: CallPat -&gt; [Expr Id]
</span><a href="GHC.Core.Opt.SpecConstr.html#cp_args"><span class="hs-identifier hs-var">cp_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682942541"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942541"><span class="hs-identifier hs-var">as2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2889"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Expr Id] -&gt; [Expr Id] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942539"><span class="hs-identifier hs-var">as1</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942541"><span class="hs-identifier hs-var">as2</span></a></span><span>
</span><span id="line-2890"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InScopeEnv
-&gt; [Id]
-&gt; [Expr Id]
-&gt; [Expr Id]
-&gt; Maybe (Expr Id -&gt; Expr Id, [Expr Id])
</span><a href="GHC.Core.Rules.html#matchExprs"><span class="hs-identifier hs-var">matchExprs</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621682942544"><span class="hs-identifier hs-var">ise</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942538"><span class="hs-identifier hs-var">vs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942539"><span class="hs-identifier hs-var">as1</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942541"><span class="hs-identifier hs-var">as2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2891"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Id -&gt; Expr Id
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682942545"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942545"><span class="hs-identifier hs-var">ms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Expr Id -&gt; Bool) -&gt; [Expr Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621682942545"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-2892"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Expr Id -&gt; Expr Id, [Expr Id])
</span><span class="hs-identifier hs-var">Nothing</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2893"></span><span>
</span><span id="line-2894"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-comment">-- We must handle patterns of unequal length separately (#24282)</span><span>
</span><span id="line-2895"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- For the pattern with more args, the last arg is &quot;interesting&quot;</span><span>
</span><span id="line-2896"></span><span>           </span><span class="hs-comment">-- but the corresponding one on the other is &quot;not interesting&quot;;</span><span>
</span><span id="line-2897"></span><span>           </span><span class="hs-comment">-- So we can't get from one to the other with only exprIsTrivial</span><span>
</span><span id="line-2898"></span><span>           </span><span class="hs-comment">-- instantiation.  Example nofib/spectral/ansi, function `loop`:</span><span>
</span><span id="line-2899"></span><span>           </span><span class="hs-comment">--    P1: loop (I# x) (a : b)</span><span>
</span><span id="line-2900"></span><span>           </span><span class="hs-comment">--    P2: loop (I# y)           -- Pattern eta-reduced</span><span>
</span><span id="line-2901"></span><span>           </span><span class="hs-comment">-- Neither is better than the other, in the sense of betterPat</span><span>
</span><span id="line-2902"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2903"></span><span>    </span><span id="local-6989586621682942544"><span class="annot"><span class="annottext">ise :: InScopeEnv
</span><a href="#local-6989586621682942544"><span class="hs-identifier hs-var hs-var">ise</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdUnfoldingFun -&gt; InScopeEnv
</span><a href="GHC.Core.html#ISE"><span class="hs-identifier hs-var">ISE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942537"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [Id] -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSetList"><span class="hs-operator hs-var">`extendInScopeSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621682942540"><span class="hs-identifier hs-var">vs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding -&gt; IdUnfoldingFun
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2904"></span><span>
</span><span id="line-2905"></span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#subsumePats"><span class="hs-identifier hs-type">subsumePats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2906"></span><span class="hs-comment">-- Remove any patterns subsumed by others</span><span>
</span><span id="line-2907"></span><span class="hs-comment">-- See Note [Pattern duplicate elimination]</span><span>
</span><span id="line-2908"></span><span class="hs-comment">-- Other than deleting subsumed patterns, this operation is a no-op;</span><span>
</span><span id="line-2909"></span><span class="hs-comment">-- in particular it does not reverse the input.  It should not matter</span><span>
</span><span id="line-2910"></span><span class="hs-comment">-- but in #24282 it did; doing it this way keeps the existing behaviour.</span><span>
</span><span id="line-2911"></span><span id="subsumePats"><span class="annot"><span class="annottext">subsumePats :: InScopeSet -&gt; [CallPat] -&gt; [CallPat]
</span><a href="GHC.Core.Opt.SpecConstr.html#subsumePats"><span class="hs-identifier hs-var hs-var">subsumePats</span></a></span></span><span> </span><span id="local-6989586621682942550"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942550"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621682942551"><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942551"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([CallPat] -&gt; CallPat -&gt; [CallPat])
-&gt; [CallPat] -&gt; [CallPat] -&gt; [CallPat]
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">[CallPat] -&gt; CallPat -&gt; [CallPat]
</span><a href="#local-6989586621682942553"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942551"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-2912"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2913"></span><span>    </span><span class="annot"><a href="#local-6989586621682942553"><span class="hs-identifier hs-type">add</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.SpecConstr.html#CallPat"><span class="hs-identifier hs-type">CallPat</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2914"></span><span>    </span><span id="local-6989586621682942553"><span class="annot"><span class="annottext">add :: [CallPat] -&gt; CallPat -&gt; [CallPat]
</span><a href="#local-6989586621682942553"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>        </span><span id="local-6989586621682942554"><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942554"><span class="hs-identifier hs-var">ci</span></a></span></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942554"><span class="hs-identifier hs-var">ci</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2915"></span><span>    </span><span class="annot"><a href="#local-6989586621682942553"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682942555"><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942555"><span class="hs-identifier hs-var">ci1</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682942556"><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942556"><span class="hs-identifier hs-var">cis</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682942557"><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942557"><span class="hs-identifier hs-var">ci2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; CallPat -&gt; CallPat -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#betterPat"><span class="hs-identifier hs-var">betterPat</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942550"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942555"><span class="hs-identifier hs-var">ci1</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942557"><span class="hs-identifier hs-var">ci2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942555"><span class="hs-identifier hs-var">ci1</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat -&gt; [CallPat] -&gt; [CallPat]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942556"><span class="hs-identifier hs-var">cis</span></a></span><span>
</span><span id="line-2916"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; CallPat -&gt; CallPat -&gt; Bool
</span><a href="GHC.Core.Opt.SpecConstr.html#betterPat"><span class="hs-identifier hs-var">betterPat</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621682942550"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942557"><span class="hs-identifier hs-var">ci2</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942555"><span class="hs-identifier hs-var">ci1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942557"><span class="hs-identifier hs-var">ci2</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat -&gt; [CallPat] -&gt; [CallPat]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942556"><span class="hs-identifier hs-var">cis</span></a></span><span>
</span><span id="line-2917"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942555"><span class="hs-identifier hs-var">ci1</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat -&gt; [CallPat] -&gt; [CallPat]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CallPat] -&gt; CallPat -&gt; [CallPat]
</span><a href="#local-6989586621682942553"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">[CallPat]
</span><a href="#local-6989586621682942556"><span class="hs-identifier hs-var">cis</span></a></span><span> </span><span class="annot"><span class="annottext">CallPat
</span><a href="#local-6989586621682942557"><span class="hs-identifier hs-var">ci2</span></a></span><span>
</span><span id="line-2918"></span><span>
</span><span id="line-2919"></span><span class="hs-comment">{-
Note [Pattern duplicate elimination]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider f :: (a,a) -&gt; blah, and two calls
   f @Int  (x,y)
   f @Bool (p,q)

The danger is that we'll generate two *essentially identical* specialisations,
both for pairs, but with different types instantiating `a` (see #24229).

But we'll only make a `CallPat` for an argument (a,b) if `foo` scrutinises
that argument.  So SpecConstr should never need to specialise f's polymorphic
type arguments.  Even with only one of these calls we should be able to
generalise to the `CallPat`

  cp_qvars = [a, r::a, s::a], cp_args = [@a (r,s)]

Doing so isn't trivial, though.

For now we content ourselves with a simpler plan: eliminate a call pattern
if another pattern subsumes it; this is done by `subsumePats`.
For example here are two patterns

  cp_qvars = [a, r::a, s::a],  cp_args = [@a (r,s)]
  cp_qvars = [x::Int, y::Int], cp_args = [@Int (x,y)]

The first can be instantiated to the second, /by instantiating types only/.
This subsumption relationship is checked by `betterPat`.  Note that if
we have

  cp_qvars = [a, r::a, s::a], cp_args = [@a (r,s)]
  cp_qvars = [],              cp_args = [@Bool (True,False)]

the first does *not* subsume the second; the second is more specific.

In our initial example with `f @Int` and `f @Bool` neither subsumes the other,
so we will get two essentially-identical specialisations. Boo.  We rely on our
crude throttling mechanisms to stop this getting out of control -- with
polymorphic recursion we can generate an infinite number of specialisations.
Example is Data.Sequence.adjustTree, I think.
-}</span><span>
</span><span id="line-2960"></span></pre></body></html>